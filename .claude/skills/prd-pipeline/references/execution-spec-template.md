# EXECUTION-SPEC Template

This template defines the format for EXECUTION-SPEC documents generated by the `lead-architect` skill.

## Format

EXECUTION-SPEC uses YAML frontmatter for machine-parseable workstream definitions, followed by human-readable markdown for context.

---

## Template

```markdown
---
# EXECUTION-SPEC Frontmatter
# Generated by lead-architect skill

prd: PRD-XXX
prd_title: "Service/Feature Name"
service: PrimaryServiceName
mvp_phase: 1  # 0=Horizontal, 1=Core, 2=Session, 3=Rewards

# Workstream Definitions
workstreams:
  WS1:
    name: Database Layer
    description: Migration, RLS policies, type generation
    agent: backend-service-builder
    depends_on: []
    outputs:
      - supabase/migrations/YYYYMMDDHHMMSS_description.sql
      - services/{domain}/dtos.ts
      - services/{domain}/schemas.ts
    gate: schema-validation
    estimated_complexity: low  # low, medium, high

  WS2:
    name: Service Layer
    description: Service factory, keys, HTTP fetchers
    agent: backend-service-builder
    depends_on: [WS1]
    outputs:
      - services/{domain}/index.ts
      - services/{domain}/keys.ts
      - services/{domain}/http.ts
      - services/{domain}/README.md
    gate: type-check
    estimated_complexity: medium

  WS3:
    name: Route Handlers
    description: API routes with withServerAction middleware
    agent: api-builder
    depends_on: [WS2]
    outputs:
      - app/api/v1/{domain}/route.ts
      - app/api/v1/{domain}/[id]/route.ts
    gate: lint
    estimated_complexity: medium

  WS4:
    name: React Query Hooks
    description: Query and mutation hooks for client consumption
    agent: backend-service-builder
    depends_on: [WS2, WS3]
    outputs:
      - hooks/{domain}/index.ts
      - hooks/{domain}/use-{domain}.ts
      - hooks/{domain}/use-{domain}-mutations.ts
    gate: type-check
    estimated_complexity: low

  WS5:
    name: Tests
    description: Unit and integration tests
    agent: backend-service-builder
    depends_on: [WS2, WS3, WS4]
    outputs:
      - services/{domain}/*.test.ts
      - services/{domain}/*.integration.test.ts
    gate: test-pass
    estimated_complexity: medium

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Foundation
    parallel: [WS1]
    gates: [schema-validation]

  - name: Phase 2 - Implementation
    parallel: [WS2, WS3]
    gates: [type-check, lint]

  - name: Phase 3 - Integration
    parallel: [WS4, WS5]
    gates: [type-check, test-pass]

# Validation Gates
gates:
  schema-validation:
    command: npm run db:types
    success_criteria: "Exit code 0, no type errors"

  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0"

  lint:
    command: npm run lint -- services/{domain}/ app/api/v1/{domain}/
    success_criteria: "Exit code 0, no errors (warnings OK)"

  test-pass:
    command: npm test services/{domain}/
    success_criteria: "All tests pass"

# Dependencies on other PRDs/Services
external_dependencies:
  - prd: PRD-000
    service: CasinoService
    required_for: "Temporal authority (gaming day computation)"

# Risks and Mitigations
risks:
  - risk: "Schema migration may conflict with existing data"
    mitigation: "Run against local DB first, validate with db:reset"

---

# EXECUTION-SPEC: {PRD-XXX} - {Service Name}

## Overview

Brief description of what this PRD delivers and why it matters.

## Scope

- **In Scope**: List of features/capabilities
- **Out of Scope**: Explicitly excluded items

## Architecture Context

Reference relevant SRM sections, ADRs, or architectural decisions.

## Workstream Details

### WS1: Database Layer

**Purpose**: Create database schema and policies for {service}.

**Deliverables**:
1. Migration file with tables and constraints
2. RLS policies for casino-scoped access
3. DTO type definitions derived from schema

**Acceptance Criteria**:
- [ ] `npm run db:types` succeeds
- [ ] RLS policies cover all CRUD operations
- [ ] DTOs follow Pattern B (Pick/Omit from Database types)

### WS2: Service Layer

**Purpose**: Implement service factory and supporting modules.

**Deliverables**:
1. Service factory with typed interface
2. React Query key factories
3. HTTP fetcher functions for route handlers

**Acceptance Criteria**:
- [ ] Service follows functional factory pattern
- [ ] No `ReturnType` inference
- [ ] Explicit interface exported

### WS3: Route Handlers

**Purpose**: Create API routes with middleware stack.

**Deliverables**:
1. CRUD routes using `withServerAction` middleware
2. Request/response validation with Zod schemas
3. Proper error mapping to HTTP status codes

**Acceptance Criteria**:
- [ ] All routes use `withServerAction` wrapper
- [ ] Casino context derived from auth (not headers)
- [ ] Response format matches `ServiceHttpResult<T>`

### WS4: React Query Hooks

**Purpose**: Provide client-side data fetching hooks.

**Deliverables**:
1. Query hooks for read operations
2. Mutation hooks for write operations
3. Proper cache invalidation

**Acceptance Criteria**:
- [ ] Hooks use key factories from keys.ts
- [ ] Mutations invalidate relevant queries
- [ ] Error handling follows pattern

### WS5: Tests

**Purpose**: Ensure implementation correctness.

**Deliverables**:
1. Unit tests for service logic
2. Integration tests with real Supabase
3. RLS policy validation tests

**Acceptance Criteria**:
- [ ] 90% coverage for service layer
- [ ] Integration tests cover happy path + error cases
- [ ] RLS tests verify access control

## Definition of Done

- [ ] All workstreams complete
- [ ] All gates pass
- [ ] MVP-ROADMAP.md updated
- [ ] MVPProgressContext records completion
```

---

## YAML Field Reference

### Top-Level Fields

| Field | Type | Description |
|-------|------|-------------|
| `prd` | string | PRD identifier (e.g., "PRD-003") |
| `prd_title` | string | Human-readable title |
| `service` | string | Primary service being implemented |
| `mvp_phase` | int | MVP phase number (0-3) |
| `workstreams` | object | Map of workstream definitions |
| `execution_phases` | array | Ordered list of execution phases |
| `gates` | object | Validation gate definitions |
| `external_dependencies` | array | Dependencies on other PRDs |
| `risks` | array | Identified risks and mitigations |

### Workstream Fields

| Field | Type | Description |
|-------|------|-------------|
| `name` | string | Workstream display name |
| `description` | string | Brief description |
| `agent` | string | Capability agent to delegate to |
| `depends_on` | array | Workstream IDs that must complete first |
| `outputs` | array | Expected file outputs (glob patterns OK) |
| `gate` | string | Validation gate to run after completion |
| `estimated_complexity` | string | low/medium/high |

### Execution Phase Fields

| Field | Type | Description |
|-------|------|-------------|
| `name` | string | Phase display name |
| `parallel` | array | Workstream IDs to run in parallel |
| `gates` | array | Gates to run after phase completion |

### Gate Fields

| Field | Type | Description |
|-------|------|-------------|
| `command` | string | Shell command to execute |
| `success_criteria` | string | Human-readable success definition |

---

## Example: PRD-003 (Player/Visit)

```yaml
---
prd: PRD-003
prd_title: "Player Intake & Visit Management"
service: PlayerService
mvp_phase: 1

workstreams:
  WS1:
    name: Database Layer
    agent: backend-service-builder
    depends_on: []
    outputs:
      - supabase/migrations/20251130_player_visit.sql
      - services/player/dtos.ts
      - services/visit/dtos.ts
    gate: schema-validation

  WS2:
    name: PlayerService
    agent: backend-service-builder
    depends_on: [WS1]
    outputs:
      - services/player/index.ts
      - services/player/keys.ts
    gate: type-check

  WS3:
    name: VisitService
    agent: backend-service-builder
    depends_on: [WS1]
    outputs:
      - services/visit/index.ts
      - services/visit/keys.ts
    gate: type-check

  WS4:
    name: Player Routes
    agent: api-builder
    depends_on: [WS2]
    outputs:
      - app/api/v1/players/route.ts
      - app/api/v1/players/[id]/route.ts
    gate: lint

  WS5:
    name: Visit Routes
    agent: api-builder
    depends_on: [WS3]
    outputs:
      - app/api/v1/visits/route.ts
      - app/api/v1/visits/[id]/route.ts
    gate: lint

  WS6:
    name: Tests
    agent: backend-service-builder
    depends_on: [WS2, WS3, WS4, WS5]
    outputs:
      - services/player/*.test.ts
      - services/visit/*.test.ts
    gate: test-pass

execution_phases:
  - name: Phase 1 - Schema
    parallel: [WS1]
    gates: [schema-validation]

  - name: Phase 2 - Services
    parallel: [WS2, WS3]
    gates: [type-check]

  - name: Phase 3 - Routes
    parallel: [WS4, WS5]
    gates: [lint]

  - name: Phase 4 - Tests
    parallel: [WS6]
    gates: [test-pass]
---
```
