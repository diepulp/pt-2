{
  "prd": "PRD-LOYALTY-PROMO",
  "prd_title": "LoyaltyService Extension â€” Promotional Instruments (Match Play)",
  "prd_source": "docs/00-vision/loyalty-service-extension/LOYALTY_PROMO_INSTRUMENTS_EXTENSION_v0.1_REDACTED.md",
  "current_phase": 5,
  "status": "complete",
  "pipeline_stage": "all_phases_complete",

  "spec_version": "v2.1",
  "spec_location": "docs/20-architecture/specs/PRD-LOYALTY-PROMO/EXECUTION-SPEC-LOYALTY-PROMO.md",
  "spec_updated_at": "2026-01-06T18:00:00Z",
  "spec_changes": [
    "Added WS6: Alert Thresholds Configuration (CasinoService-owned)",
    "Added WS7: Promo Exposure Rollup Queries (LoyaltyService-owned)",
    "Added WS8: Dashboard Promo Lens UI (Dashboard bounded context)",
    "Restructured phases: 5 phases (was 6)",
    "WS1+WS6 run parallel in Phase 1",
    "WS2+WS7 run parallel in Phase 2",
    "WS3+WS4 run parallel in Phase 3",
    "WS8 in dedicated Phase 4 (Dashboard Integration)",
    "WS5 remains in Phase 5 (Testing)"
  ],

  "stage1_scaffold": {
    "completed_at": "2026-01-06T00:00:00Z",
    "workstream_count": 8,
    "phase_count": 5,
    "expert_routing": {
      "WS1": "backend-service-builder",
      "WS2": "backend-service-builder",
      "WS3": "api-builder",
      "WS4": "frontend-design-pt-2",
      "WS5": "backend-service-builder",
      "WS6": "backend-service-builder",
      "WS7": "backend-service-builder",
      "WS8": "frontend-design-pt-2"
    },
    "rls_consultation_required": ["WS1"],
    "qa_consultation_recommended": ["WS5"]
  },

  "stage2_consultations": {
    "backend-service-builder": {
      "workstreams": ["WS1", "WS2", "WS5", "WS6", "WS7"],
      "status": "completed",
      "refinements_received": true
    },
    "rls-expert": {
      "workstreams": ["WS1"],
      "status": "completed",
      "refinements_received": true,
      "note": "ADR-024 security requirements integrated"
    },
    "api-builder": {
      "workstreams": ["WS3"],
      "status": "completed",
      "refinements_received": true
    },
    "frontend-design-pt-2": {
      "workstreams": ["WS4", "WS8"],
      "status": "completed",
      "refinements_received": true
    },
    "qa-specialist": {
      "workstreams": ["WS5"],
      "status": "completed",
      "refinements_received": true
    }
  },

  "completed_workstreams": ["WS1", "WS6", "WS2", "WS7", "WS3", "WS4", "WS8", "WS5"],
  "in_progress_workstreams": [],
  "pending_workstreams": [],

  "workstream_summary": {
    "WS1": {"name": "Database Layer (Schema + RLS)", "executor": "backend-service-builder", "type": "database"},
    "WS2": {"name": "Service Layer Extension", "executor": "backend-service-builder", "type": "service-layer"},
    "WS3": {"name": "Route Handlers", "executor": "api-builder", "type": "route-handlers"},
    "WS4": {"name": "React Query Hooks", "executor": "frontend-design-pt-2", "type": "react-query-hooks"},
    "WS5": {"name": "Tests", "executor": "backend-service-builder", "type": "unit-tests"},
    "WS6": {"name": "Alert Thresholds Configuration", "executor": "backend-service-builder", "type": "database"},
    "WS7": {"name": "Promo Exposure Rollup Queries", "executor": "backend-service-builder", "type": "database"},
    "WS8": {"name": "Dashboard Promo Lens UI", "executor": "frontend-design-pt-2", "type": "react-components"}
  },

  "execution_phases": [
    {"name": "Phase 1 - Foundation", "parallel": ["WS1", "WS6"], "gates": ["schema-validation"], "status": "completed"},
    {"name": "Phase 2 - Service Layer + Rollups", "parallel": ["WS2", "WS7"], "gates": ["type-check", "schema-validation"], "status": "completed"},
    {"name": "Phase 3 - Transport", "parallel": ["WS3", "WS4"], "gates": ["lint", "type-check"], "status": "completed"},
    {"name": "Phase 4 - Dashboard Integration", "parallel": ["WS8"], "gates": ["type-check"], "status": "completed"},
    {"name": "Phase 5 - Testing", "parallel": ["WS5"], "gates": ["test-pass"], "status": "completed"}
  ],

  "gates_passed": [
    "schema-validation (Phase 1)",
    "type-check (Phase 2)",
    "lint (Phase 3)",
    "type-check (Phase 3)",
    "type-check (Phase 4)",
    "test-pass (Phase 5)"
  ],
  "gates_pending": [],

  "findings_baseline": {
    "high": [
      "security-definer-read: rpc_promo_coupon_inventory should be SECURITY INVOKER",
      "missing-audit-log: Mutations need audit logging with correlation IDs",
      "auto-generated-idempotency: validation_number must be REQUIRED input"
    ],
    "medium": [
      "casino-settings-gap: promo_require_exact_match, promo_allow_anonymous_issuance missing",
      "prd-derivation-gap: program status/start_at/end_at fields for 'is active' check",
      "file-layout-divergence: promo-dtos.ts should be dtos.ts",
      "coverage-target-low: 85% should be 90%",
      "test-naming-wrong: .integration.test.ts should be .int.test.ts",
      "lint-allows-warnings: should be max-warnings=0"
    ],
    "low": [
      "rbac-unmapped: roles not mapped to SEC-003"
    ]
  },

  "findings_comparison": {
    "baseline_count": 10,
    "fixed_count": 10,
    "remaining_count": 0,
    "high_fixed": 3,
    "medium_fixed": 6,
    "low_fixed": 1,
    "comparison_result": "ALL_FINDINGS_ADDRESSED"
  },

  "timestamp": "2026-01-09T00:00:00Z",
  "validation_passed": true,

  "phase_2_artifacts": {
    "WS2_service_layer": [
      "services/loyalty/promo/dtos.ts",
      "services/loyalty/promo/mappers.ts",
      "services/loyalty/promo/crud.ts",
      "services/loyalty/promo/index.ts",
      "services/loyalty/keys.ts (extended with promo keys)",
      "services/loyalty/index.ts (extended with promo exports)",
      "lib/errors/domain-errors.ts (added promo error codes)"
    ],
    "WS7_rollups": [
      "supabase/migrations/20260107001809_promo_exposure_rollups.sql",
      "services/loyalty/rollups.ts"
    ]
  },

  "phase_3_artifacts": {
    "WS3_route_handlers": [
      "services/loyalty/promo/schemas.ts",
      "app/api/v1/promo-programs/route.ts",
      "app/api/v1/promo-programs/[id]/route.ts",
      "app/api/v1/promo-coupons/route.ts",
      "app/api/v1/promo-coupons/[id]/route.ts",
      "app/api/v1/promo-coupons/[id]/void/route.ts",
      "app/api/v1/promo-coupons/[id]/replace/route.ts"
    ],
    "WS4_react_query_hooks": [
      "services/loyalty/promo/http.ts",
      "hooks/loyalty/promo-instruments/index.ts",
      "hooks/loyalty/promo-instruments/use-promo-programs.ts",
      "hooks/loyalty/promo-instruments/use-promo-coupons.ts",
      "hooks/loyalty/promo-instruments/use-promo-mutations.ts",
      "hooks/loyalty/promo-instruments/use-promo-exposure.ts",
      "hooks/loyalty/index.ts (extended with promo-instruments exports)"
    ]
  },

  "phase_4_artifacts": {
    "WS8_dashboard_ui": [
      "components/dashboard/promo-exposure-panel.tsx",
      "hooks/dashboard/use-promo-exposure.ts",
      "hooks/dashboard/keys.ts (extended with promoExposure key)",
      "hooks/dashboard/index.ts (extended with promo exports)",
      "components/dashboard/pit-dashboard-client.tsx (integrated PromoExposurePanel)"
    ]
  },

  "phase_5_artifacts": {
    "WS5_tests": [
      "__tests__/services/loyalty/promo-instruments.test.ts",
      "__tests__/services/loyalty/promo-instruments-mappers.test.ts",
      "__tests__/services/loyalty/promo-instruments.int.test.ts"
    ]
  },

  "ws3_api_endpoints": [
    "GET /api/v1/promo-programs - List promo programs",
    "POST /api/v1/promo-programs - Create promo program",
    "GET /api/v1/promo-programs/[id] - Get single program",
    "PATCH /api/v1/promo-programs/[id] - Update program",
    "GET /api/v1/promo-coupons - List promo coupons",
    "POST /api/v1/promo-coupons - Issue coupon",
    "GET /api/v1/promo-coupons/[id] - Get single coupon",
    "POST /api/v1/promo-coupons/[id]/void - Void coupon",
    "POST /api/v1/promo-coupons/[id]/replace - Replace coupon"
  ],

  "ws4_hooks": [
    "usePromoPrograms(query?) - List programs with filters",
    "usePromoProgram(programId) - Get single program",
    "usePromoCoupons(query?) - List coupons with filters",
    "usePromoCoupon(couponId) - Get single coupon",
    "usePromoCouponByValidation(validationNumber) - Lookup by validation",
    "usePromoCouponInventory(query?) - Inventory summary",
    "usePromoExposure(query?) - Dashboard rollup metrics",
    "useCreatePromoProgram() - Create program mutation",
    "useUpdatePromoProgram() - Update program mutation",
    "useIssueCoupon() - Issue coupon mutation",
    "useVoidCoupon() - Void coupon mutation",
    "useReplaceCoupon() - Replace coupon mutation"
  ],

  "ws5_tests": {
    "unit_tests": {
      "file": "__tests__/services/loyalty/promo-instruments.test.ts",
      "test_count": 40,
      "coverage": "service layer CRUD operations"
    },
    "mapper_tests": {
      "file": "__tests__/services/loyalty/promo-instruments-mappers.test.ts",
      "test_count": 35,
      "coverage": "type guards and DTO mappers"
    },
    "integration_tests": {
      "file": "__tests__/services/loyalty/promo-instruments.int.test.ts",
      "test_count": 30,
      "coverage": "RLS multi-tenant isolation, coupon lifecycle, rollups",
      "requires": "RUN_INTEGRATION_TESTS=true + local Supabase"
    }
  },

  "ws8_components": [
    "PromoExposurePanel - Dashboard promo lens component",
    "useDashboardPromoExposure - Dashboard-specific hook",
    "Integrated into pit-dashboard-client.tsx (separate from cash KPIs)"
  ],

  "promo_error_codes_added": [
    "PROMO_PROGRAM_NOT_FOUND",
    "PROMO_PROGRAM_INACTIVE",
    "PROMO_PROGRAM_NOT_STARTED",
    "PROMO_PROGRAM_ENDED",
    "COUPON_NOT_FOUND",
    "INVALID_COUPON_STATUS",
    "ANONYMOUS_ISSUANCE_DISABLED",
    "DUPLICATE_VALIDATION_NUMBER",
    "DUPLICATE_ENTRY"
  ],

  "promo_service_operations": [
    "listPrograms(query?) -> PromoProgramDTO[]",
    "getProgram(programId) -> PromoProgramDTO | null",
    "createProgram(input) -> PromoProgramDTO",
    "updateProgram(input) -> PromoProgramDTO",
    "issueCoupon(input) -> IssueCouponOutput (idempotent)",
    "voidCoupon(input) -> VoidCouponOutput (idempotent)",
    "replaceCoupon(input) -> ReplaceCouponOutput (idempotent)",
    "getCouponInventory(query?) -> CouponInventoryOutput",
    "listCoupons(query?) -> PromoCouponDTO[]",
    "getCoupon(couponId) -> PromoCouponDTO | null",
    "getCouponByValidationNumber(validationNumber) -> PromoCouponDTO | null"
  ],

  "rollup_service_operations": [
    "getPromoExposureRollup(query?) -> PromoExposureRollupDTO"
  ],

  "completion_summary": "PRD-LOYALTY-PROMO COMPLETE. All 8 workstreams (WS1-WS8) executed across 5 phases. 75 unit/mapper tests passing, 30 integration tests available for RLS verification with local Supabase."
}
