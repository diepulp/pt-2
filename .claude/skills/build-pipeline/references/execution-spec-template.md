# EXECUTION-SPEC Template

This template defines the format for EXECUTION-SPEC documents generated by the `lead-architect` skill.

## Format

EXECUTION-SPEC uses YAML frontmatter for machine-parseable workstream definitions, followed by human-readable markdown for context.

---

## Template

```markdown
---
# EXECUTION-SPEC Frontmatter
# Generated by lead-architect skill

prd: PRD-XXX
prd_title: "Service/Feature Name"
service: PrimaryServiceName
mvp_phase: 1  # 0=Horizontal, 1=Core, 2=Session, 3=Rewards

# Workstream Definitions
# Executor Types: "skill" (Skill tool) or "task-agent" (Task tool with subagent_type)
workstreams:
  WS1:
    name: Database Layer
    description: Migration, RLS policies, type generation
    executor: backend-service-builder  # Skill name
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/YYYYMMDDHHMMSS_description.sql
      - services/{domain}/dtos.ts
      - services/{domain}/schemas.ts
    gate: schema-validation
    estimated_complexity: low  # low, medium, high

  WS2:
    name: Service Layer
    description: Service factory, keys, HTTP fetchers
    executor: backend-service-builder  # Skill name
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - services/{domain}/index.ts
      - services/{domain}/keys.ts
      - services/{domain}/http.ts
      - services/{domain}/README.md
    gate: type-check
    estimated_complexity: medium

  WS3:
    name: Route Handlers
    description: API routes with withServerAction middleware
    executor: api-builder              # Skill name
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - app/api/v1/{domain}/route.ts
      - app/api/v1/{domain}/[id]/route.ts
    gate: lint
    estimated_complexity: medium

  WS4:
    name: React Query Hooks
    description: Query and mutation hooks for client consumption
    executor: typescript-pro           # Task agent subagent_type
    executor_type: task-agent
    depends_on: [WS2, WS3]
    outputs:
      - hooks/{domain}/index.ts
      - hooks/{domain}/use-{domain}.ts
      - hooks/{domain}/use-{domain}-mutations.ts
    gate: type-check
    estimated_complexity: low

  WS5:
    name: Tests
    description: Unit and integration tests
    executor: typescript-pro           # Task agent subagent_type
    executor_type: task-agent
    depends_on: [WS2, WS3, WS4]
    outputs:
      - services/{domain}/*.test.ts
      - services/{domain}/*.integration.test.ts
    gate: test-pass
    estimated_complexity: medium

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Foundation
    parallel: [WS1]
    gates: [schema-validation]

  - name: Phase 2 - Implementation
    parallel: [WS2, WS3]
    gates: [type-check, lint]

  - name: Phase 3 - Integration
    parallel: [WS4, WS5]
    gates: [type-check, test-pass]

# Validation Gates
gates:
  schema-validation:
    command: npm run db:types
    success_criteria: "Exit code 0, no type errors"

  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0"

  lint:
    command: npm run lint -- services/{domain}/ app/api/v1/{domain}/
    success_criteria: "Exit code 0, no errors (warnings OK)"

  test-pass:
    command: npm test services/{domain}/
    success_criteria: "All tests pass"

# Dependencies on other PRDs/Services
external_dependencies:
  - prd: PRD-000
    service: CasinoService
    required_for: "Temporal authority (gaming day computation)"

# Risks and Mitigations
risks:
  - risk: "Schema migration may conflict with existing data"
    mitigation: "Run against local DB first, validate with db:reset"

---

# EXECUTION-SPEC: {PRD-XXX} - {Service Name}

## Overview

Brief description of what this PRD delivers and why it matters.

## Scope

- **In Scope**: List of features/capabilities
- **Out of Scope**: Explicitly excluded items

## Architecture Context

Reference relevant SRM sections, ADRs, or architectural decisions.

## Workstream Details

### WS1: Database Layer

**Purpose**: Create database schema and policies for {service}.

**Deliverables**:
1. Migration file with tables and constraints
2. RLS policies for casino-scoped access
3. DTO type definitions derived from schema

**Acceptance Criteria**:
- [ ] `npm run db:types` succeeds
- [ ] RLS policies cover all CRUD operations
- [ ] DTOs follow Pattern B (Pick/Omit from Database types)

### WS2: Service Layer

**Purpose**: Implement service factory and supporting modules.

**Deliverables**:
1. Service factory with typed interface
2. React Query key factories
3. HTTP fetcher functions for route handlers

**Acceptance Criteria**:
- [ ] Service follows functional factory pattern
- [ ] No `ReturnType` inference
- [ ] Explicit interface exported

### WS3: Route Handlers

**Purpose**: Create API routes with middleware stack.

**Deliverables**:
1. CRUD routes using `withServerAction` middleware
2. Request/response validation with Zod schemas
3. Proper error mapping to HTTP status codes

**Acceptance Criteria**:
- [ ] All routes use `withServerAction` wrapper
- [ ] Casino context derived from auth (not headers)
- [ ] Response format matches `ServiceHttpResult<T>`

### WS4: React Query Hooks

**Purpose**: Provide client-side data fetching hooks.

**Deliverables**:
1. Query hooks for read operations
2. Mutation hooks for write operations
3. Proper cache invalidation

**Acceptance Criteria**:
- [ ] Hooks use key factories from keys.ts
- [ ] Mutations invalidate relevant queries
- [ ] Error handling follows pattern

### WS5: Tests

**Purpose**: Ensure implementation correctness.

**Deliverables**:
1. Unit tests for service logic
2. Integration tests with real Supabase
3. RLS policy validation tests

**Acceptance Criteria**:
- [ ] 90% coverage for service layer
- [ ] Integration tests cover happy path + error cases
- [ ] RLS tests verify access control

## Definition of Done

- [ ] All workstreams complete
- [ ] All gates pass
- [ ] MVP-ROADMAP.md updated
- [ ] MVPProgressContext records completion
```

---

## YAML Field Reference

### Top-Level Fields

| Field | Type | Description |
|-------|------|-------------|
| `prd` | string | PRD identifier (e.g., "PRD-003") |
| `prd_title` | string | Human-readable title |
| `service` | string | Primary service being implemented |
| `mvp_phase` | int | MVP phase number (0-3) |
| `workstreams` | object | Map of workstream definitions |
| `execution_phases` | array | Ordered list of execution phases |
| `gates` | object | Validation gate definitions |
| `external_dependencies` | array | Dependencies on other PRDs |
| `risks` | array | Identified risks and mitigations |

### Workstream Fields

| Field | Type | Description |
|-------|------|-------------|
| `name` | string | Workstream display name |
| `description` | string | Brief description |
| `executor` | string | Executor name (skill name or Task agent subagent_type) |
| `executor_type` | string | "skill" or "task-agent" |
| `depends_on` | array | Workstream IDs that must complete first |
| `outputs` | array | Expected file outputs (glob patterns OK) |
| `gate` | string | Validation gate to run after completion |
| `estimated_complexity` | string | low/medium/high |

### Execution Phase Fields

| Field | Type | Description |
|-------|------|-------------|
| `name` | string | Phase display name |
| `parallel` | array | Workstream IDs to run in parallel |
| `gates` | array | Gates to run after phase completion |

### Gate Fields

| Field | Type | Description |
|-------|------|-------------|
| `command` | string | Shell command to execute |
| `success_criteria` | string | Human-readable success definition |

---

## Example: PRD-003 (Player/Visit) - Backend Focus

```yaml
---
prd: PRD-003
prd_title: "Player Intake & Visit Management"
service: PlayerService
mvp_phase: 1

workstreams:
  WS1:
    name: Database Layer
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/20251130_player_visit.sql
      - services/player/dtos.ts
      - services/visit/dtos.ts
    gate: schema-validation

  WS2:
    name: PlayerService
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - services/player/index.ts
      - services/player/keys.ts
    gate: type-check

  WS3:
    name: VisitService
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - services/visit/index.ts
      - services/visit/keys.ts
    gate: type-check

  WS4:
    name: Player Routes
    executor: api-builder
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - app/api/v1/players/route.ts
      - app/api/v1/players/[id]/route.ts
    gate: lint

  WS5:
    name: Visit Routes
    executor: api-builder
    executor_type: skill
    depends_on: [WS3]
    outputs:
      - app/api/v1/visits/route.ts
      - app/api/v1/visits/[id]/route.ts
    gate: lint

  WS6:
    name: Tests
    executor: typescript-pro
    executor_type: task-agent
    depends_on: [WS2, WS3, WS4, WS5]
    outputs:
      - services/player/*.test.ts
      - services/visit/*.test.ts
    gate: test-pass

execution_phases:
  - name: Phase 1 - Schema
    parallel: [WS1]
    gates: [schema-validation]

  - name: Phase 2 - Services
    parallel: [WS2, WS3]
    gates: [type-check]

  - name: Phase 3 - Routes
    parallel: [WS4, WS5]
    gates: [lint]

  - name: Phase 4 - Tests
    parallel: [WS6]
    gates: [test-pass]
---
```

---

## Example: ZUSTAND-RSM (Frontend Focus) - Zustand Integration

This example shows the correct executor assignments for frontend-focused PRDs involving
Zustand stores, React 19 hooks, and component refactoring.

```yaml
---
prd: ZUSTAND-RSM
prd_title: "Rating Slip Modal Zustand Integration"
service: RatingSlipModalStore
mvp_phase: 2

workstreams:
  WS1:
    name: Zustand Store & Exports
    description: Create rating-slip-modal-store.ts with devtools middleware
    executor: typescript-pro           # Pure TypeScript store definition
    executor_type: task-agent
    depends_on: []
    outputs:
      - store/rating-slip-modal-store.ts
      - store/index.ts
    gate: type-check
    estimated_complexity: medium

  WS2:
    name: Selector Hooks
    description: Create field-specific selector hooks with useShallow
    executor: frontend-design-pt-2     # React 19 hook patterns, useShallow
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - hooks/ui/use-rating-slip-modal.ts
      - hooks/ui/index.ts
    gate: type-check
    estimated_complexity: medium

  WS3:
    name: Store Unit Tests
    description: Comprehensive unit tests for store actions
    executor: typescript-pro           # Jest tests
    executor_type: task-agent
    depends_on: [WS1]
    outputs:
      - store/__tests__/rating-slip-modal-store.test.ts
    gate: test-pass
    estimated_complexity: medium

  # Form section refactors can run in parallel (WS4a-WS4e)
  WS4a:
    name: Refactor FormSectionAverageBet
    description: Replace prop drilling with useAverageBetField() hook
    executor: frontend-design-pt-2     # React 19 component refactoring
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - components/modals/rating-slip/form-section-average-bet.tsx
    gate: type-check
    estimated_complexity: medium

  WS4b:
    name: Refactor FormSectionCashIn
    description: Replace prop drilling with useNewBuyInField() hook
    executor: frontend-design-pt-2     # React 19 component refactoring
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - components/modals/rating-slip/form-section-cash-in.tsx
    gate: type-check
    estimated_complexity: medium

  # ... WS4c, WS4d, WS4e follow same pattern ...

  WS5:
    name: Modal Integration & Cleanup
    description: Update RatingSlipModal to use store, remove loading state props
    executor: frontend-design-pt-2     # React 19 patterns (useTransition, key-based reset)
    executor_type: skill
    depends_on: [WS4a, WS4b]  # All WS4x workstreams
    outputs:
      - components/modals/rating-slip/rating-slip-modal.tsx
    gate: type-check
    estimated_complexity: high

  WS6:
    name: Hook Integration Tests
    description: Integration tests for form section hooks
    executor: typescript-pro           # Jest/React Testing Library
    executor_type: task-agent
    depends_on: [WS5]
    outputs:
      - hooks/ui/__tests__/use-rating-slip-modal.test.ts
    gate: test-pass
    estimated_complexity: medium

  WS7:
    name: Quality Validation
    description: Final validation gates
    executor: qa-specialist            # Quality gates
    executor_type: skill
    depends_on: [WS5, WS6]
    outputs: []
    gate: build
    estimated_complexity: low

execution_phases:
  - name: Phase 1 - Store Foundation
    parallel: [WS1]
    gates: [type-check]

  - name: Phase 2 - Hooks & Store Tests
    parallel: [WS2, WS3]
    gates: [type-check, test-pass]

  - name: Phase 3 - Form Section Refactors (Parallelized)
    parallel: [WS4a, WS4b]  # All form sections run concurrently
    gates: [type-check]

  - name: Phase 4 - Modal Integration
    parallel: [WS5]
    gates: [type-check]

  - name: Phase 5 - Final Tests & Validation
    parallel: [WS6, WS7]
    gates: [test-pass, build]
---
```

### Frontend Executor Selection Guide

| Workstream Type | Executor | Rationale |
|-----------------|----------|-----------|
| Zustand store creation | `typescript-pro` | Pure TypeScript, devtools middleware, type-safe actions |
| Selector hooks (useShallow) | `frontend-design-pt-2` | React 19 hook patterns, optimization |
| Store unit tests | `typescript-pro` | Jest testing patterns |
| Component refactors (prop drilling â†’ hooks) | `frontend-design-pt-2` | React 19 compliance, PT-2 patterns |
| Modal integration (useTransition) | `frontend-design-pt-2` | React 19 concurrent features |
| Hook integration tests | `typescript-pro` | Jest/React Testing Library |
| Quality validation | `qa-specialist` | Final gates, DevTools verification |

**Key Insight**: `frontend-design-pt-2` should be used for any workstream requiring:
- React 19 hook patterns (useTransition, useShallow, useActionState)
- Component refactoring that eliminates anti-patterns
- PT-2-specific layout or UX patterns
- ADR-003 Zustand conventions in React components
