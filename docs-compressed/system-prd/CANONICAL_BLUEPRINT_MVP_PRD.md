-V2

Objective Casino Tracker patterns triggers KISS YAGNI principles Player Visit Rating Casino Staff

Principles Source Supabase schema type export DB service API UI tests expansion RLS JWT audit logging gates lint type-check tests regeneration Lighthouse budgets Anti dual DB clients React Query business logic

System Requirements Patterns Data Supabase Integration Seed new project baseline migration Enforce forward-only migrations timestamped filenames CI validation shared Supabase client factories browser No client instantiation UI stores Enable RLS tables templates-policies Configure audit logging triggers Type System Generate `database.types.ts Supabase check repo Treat.types.ts source DTO/view/helper modules types type Shared helpers `types/helpers reference canonical definitions Build tooling regenerates `database.types.ts schema change fails stale alternative Schema rebuilds regenerate canonical file parallel type directories Forward-only SQL migrations regenerate types commit diff typecheckschema correction new migration types manual Single database.types repo fails stale types alternate schema types DTO/View files compile against Database 3.3 Service Layer System Standards Interface service factory interface methods type signatures Return interface factory export interface PlayerService searchPlayers createPlayerService

`ReturnType use service types export explicit interface PlayerService IPlayerService Factory functions type `supabase `SupabaseClient<Database> use `any Object Spread Without explicit return type interface prevents overwrites Correct export CasinoService CasinoCrudService CasinoTablesService interface createCasinoService ...crud ...tables Wrong untyped spread createCasinoService Export Export factory function service type Name `createXService XService Service Architecture

functional module pattern export factories functions Supabase calls Centralize helpers `generateRequestId utilities/shared domain logic database types prohibit hand table contracts Use DTOs/domains inputs/outputs Drop class abstractions V2 services factories modules Dependency injection call site Define typed error catalogue domain PlayerServiceError ValidationFailed return Map enum HTTP responses UI messaging Preserve layering CRUD modules persistence.ts workflows.ts/ adapters Document data layers add unit tests function Implement validation Zod schemas Define reusable schemas DTOs input validation rule enforcement operations validate inputs.safeParse() before processingschemas field-level constraints error messages Instantiate Supabase clients helpers cookie refresh auth flow Inject client service factory constructs client touches cookies operation tables wrap Postgres function run RPC Supavisor transaction-mode connections short session mode long-running Document concurrency expectations business module rating-slip status transitions check current status table-context updates prevent double-closes

State Management React Query remote data cache defaults/query-client.ts-zero false UI state/player.ts Query hooks templates entity operations overrides 0 require approval Queries declare domain zero-stale configs-time justification invalidation strategy Query keys follow-scope pattern invalidation modules expose keys domain Mutations cache updates updates opt-in domain helpers Query hooks wrap service-layer loading contracts UI advanced offline behaviour behind domain-specific services acceptance criteria integration Server Actions Data Fetching mutations privileged reads server actions call Supabase return DTOs actions emit structured telemetry duration request ID error codesDefault data Server Components React Query hooks DTOs Supabase clients Client-side Supabase access real-time subscriptions short flows helpers table queries Mutating server actions cache `revalidatePath invalidation React Query Supabase clients consume server actions action logs telemetry pipelines no stray output Real-Time Invalidations

helper payloads Real-time hooks React Query invalidations cleanup unmount Domain hooks manage channel lifecycle avoid Logging metrics dev tooling production hooks rely React Query retries advanced behaviour domain-specific services Preserve Next.js App Router code streaming Import HeroUI components imports Server perform data fetching Client accept DTO props Security Compliance Implement Staff/Auth role matrix Enforce least-privilege RLS policies audit logging MTL domain first-class compliance reporting Performance LCP 2.5s TBT 200 ms JS 250 KB automate Lighthouse smoke Use webpack builds disable Turbopack React Compiler Consolidate build configsavoid conflicts Strip dev logging production bundles Testing

Mandatory Jest integration Cypress E2E Service testing matrix.ts modules error-path contract test PostgREST column.ts orchestrators integration tests multi-step concurrency guards-submit error enums.ts deterministic tests DTO conversions Realtime hooks channel tests subscribe/unsubscribe scheduler UI adapters contract tests gates lint type-check tests Lighthouse Supabase migration validation type-regeneration check Document architectural decisions Observability Logging structured logging.log Next.js.ts platform logger Capture domain metrics API Export shared telemetry helper Supabase middleware callbacks token refreshes sign-outs events failed migrations type-generation mismatches long-running transactions deployment pipeline dashboard

Anti-Pattern

Supabase client creation stores-store.ts `staleTime 0 unless real-time-slip Block `Database = any manual table redefinitions intersection-based schema rebuilds modules Layer Ban `ReturnType patterns exports-slip Require explicit interface definitions factories Forbid `supabase any parameters factory functions Enforce explicit return type interfaces overwrites Ban duplicate factory patterns Prohibit zero-value wrapper functions creators Ban mixing default named exports named consistency traceability Prohibit runtime validation factory functions move development-only initialization-time checks any type casting bypass incompletemethod interface deprecated class services Delete deprecated code APIs public method type signature No silent additions Ban global real-time managers enforce hook-scoped subscriptions automated tests Ban service-layer factories state creation request-scoped Ban bulk library imports dev console logging Enforce UUID Primary Keys Mixed ID types UUID create technical debt type-unsafe joins ORM friction `ratingslip.id TEXT tables UUID casts key relationships logs UUID zero-cast schema consistency new domain tables use `UUID PRIMARY DEFAULT_random_uuid( Pre-migration schema audits inherited TEXT-based IDs

Deployment Release Management local dev staging production migration seed Supabase storage change dev staging production Run migrations Supabase CLI manual DDL Record diff Release staging pass before promotion Track candidates semantic tags Database connections URLs session mode Configure connection strings environment variables flags wrap risky features kill switches store metadata Supabase LaunchDarkly document rollout steps API compatibility deprecation timelines Rollback scripts restore invalidate caches

Roadmap Supabase baseline migration guardrails 1 Week RLS JWT audit logging compliance tables 2 Domains Player Rating 3 bundle optimizations scheduler enforce budgets 4 Reporting MTL workflows CTR exports staff tooling

Acceptance Criteria schema migrations RLS tables fail stale types Service layer error handling React Query remote data UI Real-time updates scheduler Production builds budgets CI gates Rating-slip domain four-week decoupling
