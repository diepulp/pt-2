PT-2 Hybrid Architecture 2025-10-10 Phase 2 87.5% (7/8 services roadmap_ARCHITECTURE

Summary 7/8 services 98 tests Template velocity 4x improvement MTL Service CTR aggregation Hybrid Week 3 integration Phase 3 HORIZONTAL VERTICAL UI infrastructure features hardening 2 infrastructure Phase 3 React Query domains vertical UI 4-5 Player Visit UI 6-8 Performance security deployment domains

Phase 2 3) Completed MTL Service Day 6 cash transactions regulatory services/mtl index MTLService crud operations queries Compliance queries CTR aggregation19/19 tests create getById update delete listByGamingDay filtering $10k threshold history compliance aggregation CTR threshold $10,000 patron Gaming day Date-based filtering Direction cash_in_out Area pit cage slot poker kiosk sportsbook Tender types cash cashier_check tito money_order chips ~2 hours compliance query Priority Loyalty Service 1 Day Medium-High compliance 6-8 hours Priority 2: Search Query Pattern Mining 2 Days Apply PT-1 patterns 6 services advanced search/query Multi-word search relevance scoringJOIN patterns active queries~8.75h adapt-Specific Player Service Search/Queries Multi-word search name email phone Relevance scoring getActivePlayers getPlayersByTier Visit Service Search/Queries Search Date range filtering Player name search Casino location getActiveVisits getVisitsByDateRange getVisitsByCasino getPlayerVisitHistory RatingSlip Service Search/Queries Table search Player search Date range

Query operations getActiveRatingSlips<ServiceResult<RatingSlipDTO getRatingSlipsByTable(tableId getRatingSlipsByPlayer(playerId calculatePlayerPoints dateRange Casino Service Search/Queries searchCasinos searchTables(casinoId<GamingTableDTO getActiveCasinos getFloorStatus(casinoId getTableUtilization TableContext Service Search/Queries getActiveTablesWithSettings(casinoId getTablesByGameType getSettingsChangeHistory(tableId dateRange MTL Service Search/Queries searchTransactions<ServiceResult Transaction Query getCTRCandidates(gamingDay<ServiceResult<MTLEntryDTOgetPatronDailyTotals gamingDay<ServiceResult getTransactionsByArea dateRange search Player Visit RatingSlip Casino TableContext MTL Add 3-5 tests per service 16 hours Priority 3: Integration Testing Audit 1 Day Cross-service FK integrity Cascade operations Point calculation Multi workflows MTL logging-of-Phase-2 services explicit interfaces `SupabaseClient Zero PRD violations Test coverage >80% location consistency Bounded context integrity Responsibility Documentation complete 6-8 hours

Phase 2 7/8 post-MVP Player (8 Visit (10 RatingSlip PlayerFinancial (16 Casino (13 TableContext (22 MTL 15/Query 6 services ~94 4x improvement Zero PRD violations

Phase 3: UI Layer State Management 3-5 Strategy Week 1 HORIZONTAL Weeks 2-3 VERTICAL real-time Critical Blockers Phase 2 Service layer (7/8 services 87.5% ServiceResult error Supabase clients Test infrastructure Hybrid architecture Week 3: State Management Infrastructure setup domains HORIZONTAL infrastructure 1-2 VERTICAL application 3-5 HORIZONTAL Infrastructure Query React Query remote ephemeral UI Action Modal visibility Selected IDs Navigation HORIZONTAL infrastructure vertical UI Weeks 4-5 Days 3-5 VERTICAL Domain Application infrastructure Player Visit domains Query Hook Templateexport function useServiceQuery unknown Promise<ServiceResult UseQueryOptions return useQuery queryKey async result await queryFn Error return result.data Wrap ServiceResult error React Query error Vertical Slice Domain Query Hooks Example-queries export function usePlayer(id string supabase createClient playerService useServiceQuery playerService.getById usePlayers( createClient useServiceQuery playerService.list usePlayerSearch(query string createClient

useServiceQuery playerService.searchPlayers query.length > 0 Vertical Slice 4: Mutation Hooks (Player Example hooks-mutations useCreatePlayer() queryClient supabase playerService useMutation mutationFn PlayerCreateDTO playerService.create queryClient.invalidateQueries'players useUpdatePlayer() queryClient createClient playerService createPlayerService useMutation mutationFn PlayerUpdateDTO playerService.update(id queryClient.invalidateQueries'player'players Vertical Slice 5: Server Actions Wrapper lib/actions-server-action-wrapper export async function withServerAction<T Promise<ServiceResult<T>> revalidatePath telemetry operation domain string startTime = Date.now requestIdrandomUUID result await action.success.revalidatePath revalidatePath revalidateTag Structured telemetry logger.info_action_completed requestId operation domain duration Date success result return result logger.error_action_failed requestId error duration Date success false error 'UNEXPECTED_ERROR Vertical Slice 6 Domain Server Actions app/actions/create-player-action async createPlayerAction supabase createClient playerService withServerAction playerService.create revalidatePath/players telemetry operation 'create_player domain Vertical Slice 7 UI Storeinterface UIState isPlayerModalOpen boolean void void selectedPlayerId null setSelectedPlayerId null void export useUIStore create<UIState isPlayerModalOpen false true false selectedPlayerId null setSelectedPlayerId id

stores contain server data (players visits ephemeral UI state (modal visibility IDs navigation Week 4: Player Management UI (VERTICAL Complete Player domain feature-stack Player Domain UI (VERTICAL components-list.tsx Server fetches data-list-client.tsx Client interactivity-form mutations-detail single player player-search.tsx search player-card.tsx Shared Component display (player-list Server fetches data export async function PlayerList() supabase createClient playerService createPlayerService result await playerService.list.success <ErrorDisplay (player-list-client.tsx): client PlayerListClientProps export function PlayerListClient usePlayers createPlayer useUIStore.map keyplayer createPlayer Working Player Management UI CRUD real-time testable deployable feature 5 days-stack Week 5 Visit RatingSlip UI Complete RatingSlip features Visit-form-list visits actions-badge display Real-time visit updates 2 days RatingSlip Domain UI rating-form-list-detail point-display calculations Real-time rating updates 2 days Visit lifecycle workflows Rating slip creation flows Cross-domain interactions Working Visit Tracking UI real RatingSlip UI points real-time

Phase 3 Hybrid Pattern React Query Zustand infrastructure domains benefit Player feature Visit feature RatingSlip Integrated domain HORIZONTAL 6 Real-Time integrated Weeks 4-5 Vertical Slice 11 Real-Time Channel Wrapper-supabase-channel useSupabaseChannel RealtimePostgresChangesPayload channelName event schema table filter callback void supabase createClient useEffect channel_changes supabase.removeChannel Automatic cleanup unmount typed payloads domain-specific channels Vertical Slice 12 Batch Invalidation Scheduler/realtime/invalidation-scheduler InvalidationScheduler pendingInvalidations NodeJS null scheduleInvalidation(queryKeyscheduledFlush setTimeout 100ms debounce private flush queryClient.invalidateQueries.clear null invalidationScheduler InvalidationScheduler Batch invalidations prevent React Query rapid updates Vertical Slice 13 Domain Real Hooks Example-realtime usePlayerRealtime useSupabaseChannel invalidationScheduler.scheduleInvalidation.scheduleInvalidation PlayerListClient usePlayerRealtime Auto-subscribes-cleans 2 days 3 domain hooks Vertical Slice 14 Real-Time Testing Mock Supabase channels Verify cleanup unmount Test invalidation scheduler batching Memory leak validation 1 day

Phase 3 React Query 100% data stores ZERO data UIs Real-time updates <1s Zero memory leaks structured telemetry Dynamic imports heavy components

Phase Compliance Workflows 7-8 15 MTL transaction form CTR dashboard Gaming calculator Audit trail MTL Service 16 Visit rating slip point calculation MTL Cancel rollback transition validation Player RatingSlip MTL 17 Table Context Shift handover Inventory tracking Fill slip Casino

Phase 5 Production 9-10 18 Performance Bundle analysis Dynamic imports Query optimization Lighthouse gates TBT 19 Security RLS JWT API rate CORS configuration 20 Deployment Automation Migration Rollback Health check Monitoring metrics

Action Plan 5 Days Day 1 MTL Service CRUD Create/mtl/index Implement/mtl/crud.ts delete/mtl.test.ts Run tests verify 100% pass rate Commit MTL CRUD Day 2: MTL Service Queries Implement/mtl/queries Add query tests Verify 15 tests Commit Add compliance query operations Day 3: Search/Query Pattern Mining Player Visit RatingSlip Add tests new operations Commit Add/query Player Day 4: Casino TableContext MTL Add tests new operations Commit Add search/query Casino TableContext MTL Day 5 Integration Testing Phase 2 Audit tests Cross-service FK integrity Cascade operations Multi-domain workflows end-phase audit checklist Update SESSION_HANDOFF.Phase 2 Update Phase 3 Commit Phase 2 smoke tests

Risk Mitigation MTL regulatory logic complexity patterns time 8h pattern rewrite PT-1 mining 4h rewrite React Query learning curve patterns Real-time memory leaks cleanup testing dependency audits Performance budget Weekly Lighthouse checks Week 4

Phase 2 3 7/8 services 94 tests Search Zero PRD violations Test coverage >80% Phase 3 6 Player Visit React Query Real-time updates <1s Zero pollution Phase 4 8 MTL compliance Visit Phase 5 10 LCP Initial JS Zero security warnings Deployment automation

References_ARCHITECTURE_QUICK.md strategy_HANDOFF.md implementation_GAPS.md gap analysis HORIZONTAL/VERTICAL_PRODUCTION_ROADMAP roadmap hybrid pattern_TEMPLATE_QUICK.md implementation guide-location location standard 1.1.0 2025-10-10 Week 3 2 Phase 2 87.5% (7/8 services complete HORIZONTAL infrastructure VERTICAL features HORIZONTAL hardening
