ADR Strategy PROPOSED 2025-10-17 Development Team Week 6

PT-2 Week 6 server state mutations invalidation patterns Casino operations table availability player status rating compliance signals Supabase Postgres feeds Realtime standardize code React Query cache resource leaks ergonomics Questions invalidation subscriptions memory leaks domains UI network drop auth refresh intervention

Subscription Architecture-Scoped context owns Supabase channel namespace.available Channels subscribe Postgres changes filtered table schema row-level filters channels duplicate sockets call `acquireChannel receive ref-counted subscription object `releaseChannel( cleanup Payload accept payload mappers typed DTOs React Query callbacks data contracts consistent DTOs Event Processing Cache Updates hooks enqueue cache micro scheduler coalesces events executes single invalidation/update batch Cache payloads entity snapshots call `queryClient.setQueryData Invalidation scheduler exposes helpers `setDetail `mergeList operationspayloads partial scope ambiguous hooks schedule `invalidateQueries calls helpers map Supabase topics query keys hard-code strings Invalidations bypass scheduler low-frequency events default batched thrashing Memory Leak Prevention

-counted `acquireChannel increments counter cleanup decrements invokes.unsubscribe( zero `useRealtimeSubscription hook wraps Supabase listeners cleanup registers `AbortController signalled unmount short-circuit scheduler tasks registry tracks last-activity timestamps idle channels sockets simulate mount/unmount channel counts zero scheduler queues flush Cypress smoke realtime warnings Domain-Specific Shared Channels-Specific domain hook filters payload transforms cache wiring concerns matches React domain-based query keys Utility Cross-domain workflows listen originating domain schedule invalidations( global “everything” channel payload over-fetching data Reconnection Resilience Status registry listens Supabase eventstransitions `CONNECTED replays tasks triggers refetch resync Supabase handle retries cap 5 reconnections prevents infinite networks document visibility hidden >2 minutes pause scheduler execution visibility flush queue React `refetchOnReconnect missed Refresh Supabase SSR helper rotates session tokens registry exposes `refreshAuth(token) updates without

Developer Workflow Testing-channel exports template accepts callbacks folders query keys scheduler operations Domain READMEs list realtime hooks channel names cache impact invalidations ADR-003 overrides `setQueryData invalidation builds channel events_REALTIME silent logging optional metrics custom events

Consequences Positive Cache Scheduler query keys minimize refetches React Query data Ref-counted registry cleanup avoid warnings evolve realtime rules regression risk Automatic reconnection selective refetch fresh data after outages Negative Registry abstractions complexity Training docs mitigate Batched updates 50ms delay immediate mode Supabase channels utilities simulate reconnect

Alternatives Direct Invalidations Scheduler Simpler fewer abstractions Burst events redundant refetches Rejected scheduler Single Global Channel subscription dispatcher High payload complicated routing Rejected Optimistic-Only Updates Minimal chatter fastest UI conflict resolution rollback-time feeds Rejected

Implementation Plan 6) Realtime-registry acquire idle cleanup status listener/invalidation-scheduler abort support Shared Hook-channel Supabase subscription lifecycle scheduler integration tests/unmount scheduler batching cache updates Supabase status listener React Query UI toast failures Update READMEs channel naming overrides testing recipes integration tests updates reconnection cache UI consistency

Supabase Realtime ADR-003 State Management Strategy Canonical Blueprint MVP §3.6 Real-Time Invalidations Balanced Architecture-time deliverables

Revision History Author 2025-10-17 proposal Week 6 strategy Development Team
