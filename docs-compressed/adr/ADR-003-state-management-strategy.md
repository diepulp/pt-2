ADR State Strategy ACCEPTED Development Team Phase 3 Waves 1-3 tests

PT-2 Server data visits tables casinos loyalty UI Real-time updates Cache invalidation Cross-component data sharing TypeScript safety patterns 7 services Performance optimization caching Developer experience boilerplate

Decision React Query Server State data Supabase database Wave 1) queryClient staleTime gcTime Evict unused data after 30 minutes overridden refetchOnWindowFocus false Disabled casino context Single retry failures No retries duplicates 5 Balances data freshness reduced network requests sub-minute updates 30 caches High-churn domains override shorter windows Prevents unnecessary refetches multi-window.retry Single retry network issues.retry No retries prevent operations Automatic caching background refetching Built-in loading error states Optimistic updates DevTools debugging TypeScript-first design 5-minute/30-minute defaults baseline set shorter high-volatility queries extend window accessed reportsDocument override domain README consumers freshness/home/diepulp/projects/pt-2/lib/query-client.ts 4 tests passing Query Key Pattern Wave 2)[domain operation ...params context player visit rating-slip table-context action detail search active Optional parameters filters pagination 7 Domain (30 patterns Wave 2) Casino Domain Player Domain casinoId

Visit Domain 'list' page limit visitId playerId-casino casinoId Rating Slip Domain-slip 'list slipId-visit visitId tableId Table Context Domain-context 'detail contextId 'active casinoId-table tableId Table Domain 'list tableId-casino casinoId 'available casinoId MTL Domain 'list-table-context contextId tableId **Hierarchical Invalidation** Wave 3) Invalidate player queries Invalidate specific player Invalidate player lists only/home/diepulp/projects/pt-2/hooks/shared/README.30 query key patterns Cache Invalidation Strategy **Validated Wave 2 1. Domain-Level Invalidation **create operations\*\* **bulk multiple queries createPlayer Invalidates player queries Create operations entity Bulk operations multiple entities Changes impacting unsure specific queries affected 2. Granular Invalidation **update operations** mutation impact known updatePlayer Invalidate player detail invalidate list reflect changes Update operations single entities limited Performance optimization unnecessary refetches Complex query hierarchies 3. Query Removal **delete operations\*\* remove queries deletePlayer Remove deleted entity detail query from cache.removeQueries Invalidate lists remove deleted entityinvalidateQueries queryKey'player 'list

Delete operations Entities 404 errors deleted entities Direct Cache Updates `setQueryData mutation responses contain updated entity collections keeps lists detail views sync without network hops updateVisit detail cache mutation payload Merge updated record list caches Mutation payloads include complete entity snapshot Lists small moderate avoids redundant refetches Optimistic updates mutated cache reconcile server response High mutations refetching Supabase rate limits Mutation payloads partial omit list-facing fields Multiple dependent queries need recalculation `invalidateQueries-mutation 3 strategies implementedCRUD examples Wave 3 tests patterns Ephemeral Wave 1) Modal type data Navigation tab filters Form-step draft data Temporary selections operations multi View mode preferences list table Server data visits rating slips React Query Fetched data Persistent database User session Next.js auth URL state Next

Filters React Query queries selector hooks Zustand state prevent divergence component read filters() pass values into service query hook cache keys filters shareable promote to URL params Next.js router helpers hydrate Zustand store from layout loaders ADR assumes state filters Wave 3 graduate filters to URL state cross-session persistence copy/paste links React Query source server data Zustand holds transient filter inputs view configuration UI interface Modal Sidebar UIinterface PlayerUIStore Search filters void statusFilter void View preferences void Pagination UI itemsPerPage setPage void Selection state togglePlayerSelection void clearSelection void Reset resetFilters void/diepulp/pt-2/store/ui-store.ts Global UI state (9 tests-store Player UI state (11 tests/README.md guidelines (7.8KB Real-Time Updates Integration Deferred feature implementation (Weeks 4-6 Real-time hooks update React Query cache Domain-specific hook subscription usePlayerRealtime Option update cache complete data.setQueryData Invalidate refetch data consistency.invalidateQueries queryKey

Choose event payload Subscribe relevant entities Use React Query refetch Measure optimize real-time load Single source truth Query cache-time updates patterns No separate state management Aligns domain real-time hooks patterns finalized implementation requirements known

Consequences Positive Separation Validated Server React Query 6 services UI Zustand (20 tests Real-time Updates cache No overlap Cache Validated Background refetching Stale-revalidate Memory management leaks Request deduplication Type Validated Query keys (30 patterns Response data Compile-time errors invalid state access ServiceResult<T type safety Validated Minimal boilerplate Consistent patterns 7 domains DevTools debugging patterns (729 Validated Intelligent caching reduces requests Single operations <1s Complex workflows Error responses <500ms Negative Mitigated React Query patterns hook templates documentation 30 examples 7 domains Invalidation logic complex 3 strategies Resolved Background refetching unnecessary data preventstuning 5-minute staleTime balances freshness performance Acceptable Query gzipped bundle Features refetching safety justify bundle size

Mitigated mock React Query Wave 3 tests QueryClient setup 32 tests Invalidation logic testing 3 invalidation strategies Wave 3

Alternatives Context API No dependencies Built React team Manual cache No refetching issues logic Rejected Redux Toolkit RTK Query Comprehensive state management Mature ecosystem TypeScript support boilerplate Steeper learning curve Over-engineered PT-2 Rejected 3: SWR Lightweight Simple API caching Less TypeScript Smaller ecosystem Fewer features Rejected 4: Everything Single state solution Tiny bundle Simple API Manual state management No caching refetching logic Rejected state features

Implementation Evidence Wave 1: Infrastructure Setup 4 tasks completed 37 tests React Query configured 4 tests Server action wrapper 13 tests stores 20 tests ADR-003 draft Wave 2: Hook Templates tasks completed documentation Query hook template 81 lines Mutation hook template 96 lines documentation 729 lines 30 query key patterns 3 cache invalidation strategies 36+ mutation examplesWave 3: Integration Validation 32 tests passing zero blocking 24 CRUD tests (6 2 cross-service workflow tests 6 error handling tests 2 structure validation tests Single CRUD operations ~750ms - 1.2s List operations ~800ms - 1.0s Cross-service workflows - 3.0s Error tests ~200ms (100ms - 400ms Casino Service (5 tests CRUD ListByCompany Player (3 Visit RatingSlip TableContext (4 ListByCasino MTL Service (4-results Wave 4: ADR Finalization ACCEPTED implementation evidence

Resolved Questions Query Defaults freshness performance 5 minutes Casino operations updates Balances freshness reduced network requests `refetchOnWindowFocus Multi casino environment Prevents refetches retry strategy Supabase 1 Mutations 0 Single retry handles issues No duplicate operations Invalidation Patterns Domain-level granular invalidation domain-level creates granular updates removal deletes Validated Wave 3 cross-domain cascades invalidate domains callbacks Wave 3 optimistic updates refetch Optimistic optional immediate feedback Adds complexity Standard invalidationQuery Key Conventions RESOLVED filters options query key values data cached separately status dynamic query params Include final elements query key array 30 patterns 7 domains Wave 2 Naming conventions computed queries descriptive names-casino Self-documenting consistent domains Real-Time Integration DEFERRED feature implementation 4-6 No features implementation-Time Updates Integration

References External Documentation React Query v5 Docs/query/react/overview Zustand Docs.pmnd.rs-started/introduction Project Architecture Service Layer Architecture_LAYER_ARCHITECTURE Balanced Architecture ADR-002 Test Location-test-location-strategy Implementation Files Query Client Server Action Wrapper Query Hook Template Mutation Hook Hook Documentation UI Store Player UI Store Store Guidelines/README Phase 3 Validation Evidence Wave 1 Signoff_SIGNOFFWave 2-2/docs-3/WAVE_2_SIGNOFF Wave 3_3_SIGNOFF Integration Test Results-3/integration-test-results Integration Test/services-smoke.test

Revision History Version Changes Author 2025-10-10 DRAFT Wave 1.4 Architect ACCEPTED Finalized Wave 1-3

Acceptance Criteria Query defaults 30 query patterns 7 domains 3 cache invalidation strategies scope boundaries enforced 32 integration tests Performance baselines open questions Implementation evidence Ready Weeks 4-6 2025-10-10
