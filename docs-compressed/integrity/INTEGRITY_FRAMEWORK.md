PT-2 Codebase Integrity Framework Automated guardrails integrity drift Active 2025-10-13

Table of Contents [Integrity Layers Guardrails [Enforcement Mechanisms [Developer Workflow [Troubleshooting

PT-2 Integrity Framework layers architectural violations Layer 1: IDE Editor-time TypeScript Language Server ESLint context rules Prettier (formatting consistency Layer 2: Pre-commit Hooks-time Schema verification test Linting Type generation validation Layer 3: CI/CD Pipeline-time Type check Schema verification Unit Integration tests E2E tests Layer 4: Runtime Guards Service operation wrappers Error boundary monitoring Schema migration rollback procedures

Integrity Layers 1: IDE Editor-time file save type Warnings Errors Individual files Configuration TypeScript LSP Type safety schema compliance.json ESLint context rules import restrictions.json Code formatting Schema mismatches Import violations Type errors Formatting inconsistencies Layer 2: Pre-commit commit Blocks commit checks fail Staged files.husky/pre-commit lint-staged Prettier Schema verification database changes git diff-only grepecho Schema changes detected npm test schema-verification echo Schema verification failed npm db:types schema-verification exit Schema drift Linting violations Formatting issues Migration safety Layer 3: CI/CD Pipeline Pull Request/develop Blocks merge checks fail codebase.github/workflows/ci.yml Type check npm Schema Verification false CRITICAL pass Unit Integration tests compile-time errors Schema drift Test failures Build failures E2E regressions Layer 4: Runtime Guards Service operation execution error handling monitoring alerts Production runtime/shared/operation-wrapper.ts export async executeOperation await operation success true failed

Return error success false Runtime schema mismatches Database constraint violations Service operation failures Unexpected error patterns

Automated Guardrails Schema Verification Test-verification.test.ts Compile-time verification service DTOs match database schema Table name correctness_case PascalCase Field name alignment Removed field detection Type generation freshness Pre-commit schema changes CI/CD Recommended After migration player_loyalty PlayerLoyaltyRow Database validFields-error old field name compile PlayerLoyaltyRow "points Type Generation Workflow database migration run db:types/database.types.ts (regenerated Supabase schema[Create Migration[Apply Migration db:types Commit Verification Test Service DTOs Types regenerated after migration no exceptions Service Layer Linting Rules.eslintrc.-restricted-imports Prevent cross-context imports-eslint/no-explicit-any Ban types/explicit-function-return-type Require return types Detect `ReturnType anti-pattern-imports import Use event bus DTOs." Migration Safety Checks `supabase/migrations/\*.sql Migration files timestamped No data mutations DDL migrations Idempotent operations EXISTS EXISTS Foreign key constraints before deploy-deploy Test migration locally Regenerate types Run schema verification Full test suite Review diff types

Enforcement Mechanisms Matrix Violation Type Layer 1 (IDE 2 (Pre-commit 3 (CI/CD 4 (Runtime) Schema drift Warning Block Monitor Import violations Type errors Test failures Linting violations Formatting Auto-fix Bypass Procedures Schema verification failures Type check failures Critical test failures Bypass with Approval\*\* E2E test failures infrastructure issue Non-critical linting violations-disable Auto-bypass Prettier formatting (auto-fixed on commit

Developer Workflow Create feature branch/loyalty-integration changes service layer edit services/loyalty local verification type-check schema-verification Commit changes add services/loyalty loyalty point accrual create PR-integration CI/CD checks Merge build code review Database Migration Create apply migration add_loyalty_fields edit migration file Regenerate types Verify schema alignment Update service DTOs edit services/loyalty Commit migration types.types loyalty reward tracking schema Schema Verification Fails Check Identify mismatched fields-verification Fix service DTOs match schema Re-run verification Commit fixes services types service DTOs database schema

Common Issues verification failing Schema Verification player_loyalty columns old field name PlayerLoyaltyRow "points Service DTOs non database columns Check schema Update DTOs correct field names Search codebase_balance Replace correct field name Re-run test schema-verification generation sync error TS2339 'loyalty_ledger 'Tables Database types not regenerated after migration db:types --no-edit-commit hook blocking commit Schema verification failed Schema drift staged files Fix issue schema-verification false positive commit --no-verify Use caution

Maintenance Evolution Adding New Integrity Checks test Integrity enforce new test logic CI/CD New Integrity Check-error false ADR-005 (Integrity Enforcement Reviewing Integrity Framework Quarterly major architectural changes layers functioning No bypasses False positive rate acceptable<5% New architectural patterns Team feedback Documentation up date

Related Documentation Fix Summary schema drift prevention-005 Automated Integrity Enforcement Architectural decision record Matrix context rules Standards standards

Metrics Monitoring Success Schema drift incidents 0 sprint Phase 6) Pre-commit block <10% ~5% False positive <5% ~2% detect <1 minute fix <15 minutes ~10 Monitoring Dashboards GitHub Actions Runtime guards Weekly review 2025-10-13 Engineering Team Quarterly
