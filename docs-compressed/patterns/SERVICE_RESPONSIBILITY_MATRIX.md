Service Matrix Context Integrity 2.1.0 Loyalty MTL Contexts 2025-10-14 CANONICAL Phase 6+ Architecture Loyalty MTL Services Loyalty Pre-Loyalty Maintain context integrity service domains

Changes 2025-10-14 MTL service-domain correlation audit note immutability Phase 6+ AML compliance Loyalty RatingSlip 2.0.0 2025-10-12 Loyalty service point calculation integration Phase 6 Loyalty point calculation 1.0.0 2025-10-06 Performance Finance separation coupling

Executive Summary RatingSlip without Loyalty service point calculation not measurement LOYALTY_SERVICE_HANDOFF logic player activity reward LoyaltyService activity RatingSlipService." Phase 6 Loyalty service prerequisite infrastructure

Updated Bounded Context Map CASINO TRACKER SYSTEM │ │ │ │ │ │ IDENTITY LOCATION FINANCE │ CONTEXT Player Casino │ Player │ Service Financial │ │ │ │ │ ▼ ▼ │ │ │ SESSION CONTEXT (Aggregate Root) │ │ │ │ Visit RatingSlip │ │ Service │ (Telemetry) │ │ │ │ │ │ │ │ │ Emits: RatingSlipCompletedEvent │ (telemetry data: avgBet, duration, gameSettings) │ │ ▼ │REWARD COMPLIANCE CONTEXT Loyalty MTL Service Read-only correlation (contextual enrichment Interprets telemetry Cash transaction log Applies reward policy Gaming day calculation Calculates points Threshold detection Stores LoyaltyLedger AML/CTR compliance Updates progression Immutable audit trail Updates RatingSlip.points (denormalized cache services read from Session/Telemetry context (read-only MTL reads Loyalty contextual enrichment (compliance only

Updated Service Responsibility Matrix Domain Owns References Responsibilities `PlayerService profile Contact info Identity data Visits RatingSlips Loyalty `CasinoService Casino details Tables Game configs Gaming day config Visits RatingSlips MTL entries Venue management configuration Visit sessions Check-in/out status Player Casino RatingSlips Financials MTL entries Session lifecycle Average bet Time Game settings Seat number Gaming Table `LoyaltyService calculation Loyalty ledger Tier status rules Preferences Points history Tier progression policy Cash in/out Chips tracking ReconciliationVisit RatingSlip Financial tracking transaction MTL entries Audit notes Gaming day Threshold detection Compliance exports Player Casino Staff RatingSlip Visit Daily Threshold monitoring CTR detection/CTR compliance

Loyalty Service Reward Context Policy Engine calculation rules formula multipliers `loyalty_ledger table transactions_loyalty table balance status_tier definitions Silver Bronze thresholds Tier progression rules Point multipliers conversion rates Reward preferences `player_id points_slip_id gameplay telemetry `visit_id Session context Gameplay telemetry_bet time_played `RatingSlipService Player identity Visit session `VisitService gameplay worth rewards?" Schema points transactions TABLE loyalty_ledger_slip points_earned transaction_type 'GAMEPLAY 'BONUS 'ADJUSTMENT Telemetry snapshot average_bet duration_seconds game_type player loyalty state TABLE player_loyalty current_balance lifetime_points'BRONZE GOLD PLATINUM tier_progress 0 next tier preferences Reward preferences Tier definitions table CREATE TABLE loyalty_tier_points DEFAULT 1.0 JSONB

MTL Service Compliance/CTR Compliance Engine transaction write-once records_entry table transactions_audit_note-only_settings day configuration thresholds calculation Threshold detection rules $3k CTR > $10k Compliance export reports Aggregation views_patron_aggregates_threshold_monitor_compliance_context_id Patron identification_id Venue context_employee_id Staff accountability_slip_id Session context_id `RatingSlip Session telemetry boundaries Identity resolution Ledger Reward activity correlation compliance `Staff Audit trail access control Player identity Staff management Visit sessions Gaming telemetry Loyalty rewards cash/monetary transactions AML/CTR PRINCIPLES Write-once entries append-only audit notes-Only other domains+ Year compliance Day Automatic calculation trigger Automated watchlist CTR alerts Cross-Domain Correlation Core compliance transaction log CREATE TABLE mtl_entry casino_id Patron identification carded_id carded_name uncarded_name_description Transaction details cash_in cash_out area pit cage slot poker kiosk tender_type amount Location context table_number_note Timing event_time gaming_day DATE Auto-calculated trigger

Accountability recorded_id NOT NULL "Staff" recorded_signature notes Legacy field mtl_audit_note Cross-domain correlation rating_slip_id visit_id correlation_id distributed tracing idempotency_key Duplicate prevention TIMESTAMPTZ updated Append-only audit notes immutability CREATE TABLE mtl_audit_note_random mtl_entry_id Casino configuration TABLE casino_settings casino_id timezone/Los_Angeles gaming_day_start '06:00 watchlist_floor_threshold 10000 updated Contextual Enrichment View Read-only view compliance analysis CREATE VIEW mtl_compliance_context Session context.average_bet_seconds Visit contextcheck_in_date_out_date Player.first_name_name_number Loyalty correlation compliance oversight.points_change_type loyalty_tx_type.staff_id loyalty_staff_id Threshold status.proximity_status_percentage_percentage mtl_entry JOIN ratingslip r_slip_id visit v_id player p.patron_id loyalty_ledger_slip_id mtl_threshold_monitor_id.gaming_day

RatingSlip Service Telemetry Context Telemetry `average_bet_time Duration play `accumulated_seconds Time played_settings configuration `seat_number `status Rating lifecycle state'T OWN `points` **Denormalized cache Loyalty** query performance Source `loyalty_ledger.points_earned` gameplay activity RatingSlip.points \*\*read-optimized NOT source truth

Integration Client Orchestration Workflow Complete Rating Slip Points Server Action/ratingslip export async completeRatingSlip Promise<ServiceResult return_slip End rating session.endSession return error Calculate assign points service loyaltyResult.calculateAndAssignPoints ratingSlipId playerId visitId Telemetry inputs averageBet durationSeconds gameSettings return error Update RatingSlip calculated points.update Invalidate React Query caches success true data ratingSlip loyalty Principles Server action coordinates services owns Business logic Loyalty.calculatePoints( caches points field fast queries \*\*LoyaltyLedger source Audit trail preserved

Loyalty Service Implementation Structure SERVICE_TEMPLATE.md services/loyalty index Factory interface crud ledger player_loyalty business calculatePoints() queries getBalance( models LoyaltyLedger PlayerLoyalty translation telemetry-mapper Map Loyalty Core Business Logic services/loyalty PointsInput averageBet durationSeconds gameSettings playerTier 'BRONZE Calculate points gameplay telemetry SINGLE SOURCE point calculation policy calculatePoints averageBet durationSeconds gameSettings playerTier Calculate rounds played totalRounds Calculate theoretical win totalRounds Apply conversion rate multiplierspoint_multiplier 1.0 pointsEarned conversionRate Apply tier multiplier BRONZE 1.0 SILVER 1.25 GOLD 1.5 PLATINUM 2.0 pointsEarned tierMultipliers Apply seat bonus (empty seats currentSeats 7 < 7) emptySeats bonusFactor 1 pointsEarned bonusFactor Apply high bonus expectedRounds > pointsEarned 1.1 10% bonus.round Calculate assign points tables ratingSlipId playerId visitId averageBet durationSeconds gameSettings pointsEarned executeOperation_assign_points player current playerLoyalty Calculate points policy engine averageBet gameSettings playerTier

Record loyalty ledger insertLedgerEntry player_id rating_slip visit_id points_earned transaction_type 'GAMEPLAY average_bet duration game_type Update player loyalty balance newBalance updatePlayerBalance Check progression checkTierProgression success true data pointsEarned newBalance

Data Flow: RatingSlip Completion with Loyalty ``` User Action: Complete Rating Slip ▼ Server Action completeRatingSlip(id) ▼ RatingSlipSvc (blocked until .endSession() step 1 done) Returns: • average_bet duration game_settings player_id ▼ LoyaltyService .calculateAndAssign() 1. Get player tier 2. calculatePoints() Insert ledger Update balance 5. Check tier progress Returns: • pointsEarned RatingSlipService .update(id, points: calculated Denormalized cache

Migration Path Phase 6 Expand Phase 6 Loyalty RatingSlip MTL Loyalty Service (6-8 hours Schema migrations CRUD business logic calculatePoints Server actions hooks Unit tests>80% coverage RatingSlip Loyalty integration integration (2h tests point calculation B MTL actions (2h (4h Integration tests (2h 24-26 hours hours Option B Phase 5.5 Loyalty phase 5.5 Loyalty (8 hours Loyalty RatingSlip Testing mock data 6 RatingSlip (13 hours 21 hours

Recommendation Option Expand Phase Maintains grouping Enables parallel execution Single integration validation wave Cleaner roadmap fractional phases Testing comprehensive-to-end real points

Updated Context Validation Checklist adding field service verify domain core responsibility source truth data vs coupling domain? Point calculatePoints(averageBet duration gameSettings RatingSlipService Single NO measurement not valuation Ownership NO owns reward policy Policy vs Measurement POLICY Dependencies YES (couples telemetry reward rules Decision Reject belongs LoyaltyService.business

Anti-Patterns Avoid Point Calculation RatingSlip RatingSlip points endSession await.getById Business policy telemetry service calculatePoints_bet_seconds_settings return(id Client Orchestration Client orchestrates Loyalty calculates RatingSlip ends session ratingSlip.endSession Loyalty calculates points await ratingSlipId telemetry ratingSlip.data Cache result RatingSlip.update.pointsEarned return ratingSlip loyalty

References_SERVICE_HANDOFF.md Conceptual design_CALCULATION_DEPENDENCY_ANALYSIS Technical validation_TEMPLATE.md Implementation 6 Workflow plan 1.0.0 2025-10-12 Architecture Decision Ready Implementation Update Phase 6 workflow Loyalty service Wave
