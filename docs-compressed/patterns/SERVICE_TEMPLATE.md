PT-2 Canonical Service Template 2 Slice 1.0.0 2025-10-06

template PRD service Player domain blueprint PT-2 services Casino

Anti-Pattern Guardrails service verify Anti-Pattern Correct Pattern `ReturnType createXService `interface XService `supabase/types/database-rebuilt/x/types.ts/domains/x/index.ts@deprecated code Delete maintain dual APIs BaseService Functional factories `console.\*` operations Structured logging/monitoring-Violation code rewrite don't patch

Directory Structure services shared infrastructure types.ts ServiceResult ServiceError utils.ts generateRequestId operation-wrapper executeOperation Domain service index.ts Factory interface crud.ts operations business.ts logic queries.ts Complex queries create.ts.ts 3rd instance pattern

Shared Infrastructure/shared/types service result PT-2 service operations return ServiceResult<T export interface ServiceError code message Human-readable unknown Optional error context export ServiceResult<T> data null Operation result Error details boolean success status HTTP-style status (200 400 500) timestamp string ISO timestamp requestId string Tracking ID/shared/utils Shared utilities export generateRequestId string/shared/operation-wrapper.ts Standardized operation wrapper error handling import ServiceResult generateRequestId export OperationOptions label string timeout number service operations error handling executeOperation<PlayerDTO error supabase messagereturn data export async function executeOperation label string Promise Promise<ServiceResult requestId generateRequestId timestamp Date result await operation data result error null success true status 200 timestamp requestId unknown Structured errors data null error code message details success false status 400 timestamp requestId Unexpected errors error data null "OPERATION message details success false status 500 timestamp requestId

Domain Service Implementation `services/crud.ts CRUD Module PT-2 service architecture import SupabaseClient Database executeOperation/operation ServiceResult DTOs Pick/Omit Database types export interface XCreateDTO field1: string field2 string export XDTO Pick Database "id Functional factory typing export function createXCrudService SupabaseClient<Database Creates new {domain entity ServiceResult created entity error result xService.create.success console.log(result.data async<ServiceResult executeOperation<XDTO entity error await supabase.select("id field1.single Map database constraints business errors"23505") "DUPLICATE "Entity error return entity Updates {domain entity async id string data Partial Promise<ServiceResult return executeOperation<XDTO async data entity error await supabase field1 "PGRST116") "NOT `Entity not found return entity Retrieves {domain by ID getById async Promise<ServiceResult<XDTO>> return executeOperation<XDTO_get_by async data error await supabase field1.eq "PGRST116") "NOT `Entity not found return data{domain/index {Domain Service Factory PT-2 service architecture interfaces

SupabaseClient Database createXCrudService XCreateDTO, XDTO ServiceResult/shared STEP 1: Explicit ReturnType export interface XService create update getById<ServiceResult STEP 2: factory explicit interface export createXService<Database XService crudService createXCrudService Pure composition no state side effects return ...crudService STEP Export explicit ReturnType XServiceType XService Re-export DTOs export XCreateDTO, XDTO

Testing Pattern (TDD) `services{domain.test {Domain Service Tests TDD approach Write tests BEFORE implementation import from createClient from/supabase Database createXService/services/x"; supabaseUrl supabaseAnonKey Service CRUD supabase SupabaseClient<Database xService ReturnType createXService supabase createClient<Database(supabaseUrl xService createXService create entity valid result xService.create field1: field2(result.success).toBe.error).toBeNull.data).toBeDefined return error for duplicate data field2 "value first await xService.createduplicate await xService.create expect.error"DUPLICATE_X describe( update existing async created await xService.create field1: field2 expect updated await xService.update(created.data expect(updated.data"updated return error non async result await xService.update("nonexistent field1: expect(result"NOT_FOUND

Server Action Integration/actions-x-action Action Create {Domain PT-2 vertical slice import createClient/supabase createXService/services ServiceResult/shared export CreateXInput CreateXResult ServiceResult Creates new entity server action input Entity creation data ServiceResult created entity error export async function createXAction CreateXInput<CreateXResult supabase createClient xService.create

UI Component Pattern `components/{domain-form.tsx import useState from createXAction from/app/actions/x/create-x export function XForm( [field1 useState( [loading useState [message setMessage useState "success text string null handleSubmit async React.FormEvent.preventDefault setLoading(true); setMessage result await createXAction( field1 field2 "value".success.data setMessage.data.id setField1(" setMessage "Operation (error setMessage "Unexpected error setLoading(false); return <form onSubmit className-green-600-red-600 value{field1 onChange setField1(e.target.value) <button type="submit{loading

Operational Guardrails Service Read template Review service Check PRD anti-pattern list PT-1 violations extract helpers 3rd use-Violation Rewrite PT-1 code violation Cap PT-1 exploration â‰¤4h per module Document code End-of-Week Audit No `ReturnType inference exports typed parameters-rebuilt imports/types.ts files@deprecated code `console.\* operations tests passing Type-check clean

Error Code Catalogue codes HTTP Status `DUPLICATE_X 400 constraint violation PostgreSQL error_FOUND 404 Entity PGRST116 error_ERROR 400 failed validation `UNAUTHORIZED 401 Auth RLS policy violation `FORBIDDEN 403 Action allowed Business rule violation_FAILED 500 Unexpected error unknown errors{DOMAIN_UPDATE_EXISTS

PT-1 Mining Strategy borrowing patterns Safe Mine Search query logic Error mapping tables Validation rules DTO transform patterns PRD-compliant Not Import.service abstractions/database-rebuilt manual types `ReturnType interfaces Deprecated wrapper functions Global state/singletons Mining Process PT-1 business violations mining >4h rebuild

Reference Implementation [services/player/ Explicit `PlayerService interface.ts:17-19 Typed factory parameter.ts:23-25 Functional composition.ts:26-30 ServiceResult pattern.ts:24-26 Database constraint mapping[crud.ts:34-40] TDD tests[**tests**/player-service.test.ts

Start Checklist New Domain Service -r services/player services{domain{Domain table canonical types tests Copy structure update Start `create()() `getById() complexity build `search.ts needed Check end-week checklist PR rule document WHY Estimated Time Service 4-6 hours (3 2h +3 hours +2 hours Business +2-4 hours 8-15 hours domain service

Version History Changes 2025-10-06 template Player Slice

Maintenance domain service Architecture team PR pattern changes
