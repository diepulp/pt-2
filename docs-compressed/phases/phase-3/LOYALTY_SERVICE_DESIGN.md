Loyalty Service Design Phase Loyalty Rewards player performance loyalty 3 Layer Development 2025-10-10

Table of Contents Summary [Architecture Overview Interface Design Layer Design Logic Design Operations Design [Query Operations Design Layer Design Integration Design 11. [Testing Strategy 12. [Implementation Roadmap

Executive Summary converts gameplay telemetry into player rewards Points accrual RatingSlip Tier progression Loyalty transaction ledgering Player reward preferences Design Decisions factory PT-2 architecture `LoyaltyService No `ReturnType inference win PT-1 algorithm-first Audit trail transactions-driven `RatingSlipCompletedEvent Points logic thresholds loyalty transactions preferences Player RatingSlip Player identity gameplay metrics casino config

Domain Responsibility Core Responsibilities Function Description Owner Calculate points RatingSlip telemetry LoyaltyService Record points transactions/debits **Tier Maintain tier thresholds progress tracking Store reward/communication preferences current points balance Retrieve transaction history Own `PlayerService **Gameplay Metrics** `RatingSlipService Configuration** \*\*Visit `VisitService Integration Points flowchart[RatingSlipService[LoyaltyService_loyalty|PointsAccruedEvent Analytics[PlayerService[CasinoService lookup

Architecture Overview Directory Structure services index Factory LoyaltyService loyalty_ledger player_loyalty business Points calculation tier progression queries Balance history queries translation telemetry-mapper Loyalty accrual Architectural Pattern Loyalty service_ARCHITECTURE_QUICK Scope 1 domain User-facing balance tier status Timeline 1 week actions Approach full stack Points calculation Complex queries history tier progress RatingSlip telemetry mapping

Service Interface Design Loyalty Service Interface PT-2 architecture Convert gameplay loyalty rewards interface LoyaltyService Accrue points RatingSlip telemetry performance data ServiceResult ledger entry await loyaltyServiceaccruePointsFromSlip playerId ratingSlipId averageBet 50 totalRounds 120 durationMinutes 90 gameSettings house_edge 2.5 accruePointsFromSlip Promise<ServiceResult<LoyaltyLedgerDTO>> Manual points adjustment action adjustment data ServiceResult adjustPoints<ServiceResult Redeem points for rewards Redemption data ServiceResult redeemPoints<ServiceResult<LoyaltyLedgerDTO>> current points balance player playerId UUID ServiceResult balance data getBalance current information player playerId ServiceResult data getTier transaction history player playerId UUID options Pagination/filtering options ServiceResult getTransactionHistoryPromise<ServiceResult<LoyaltyLedgerDTO tier progress playerId ServiceResult progress getTierProgress Promise<ServiceResult TIER MANAGEMENT Recalculate update player tier points accrual playerId ServiceResult updateTier Promise<ServiceResult<PlayerLoyaltyDTO>> Initialize loyalty record new player playerId ServiceResult loyalty initializePlayerLoyalty Promise<ServiceResult

Loyalty Service Factory PT-2 service export function createLoyaltyService supabase crudService businessService queriesService Accrual operations accruePointsFromSlip adjustPoints redeemPoints Query operations getBalance getTier getTransactionHistory management updateTier businessService initializePlayerLoyalty Export LoyaltyServiceType LoyaltyService

Data Layer Design Database Tables Schema Table `player_loyalty Source.ts:1038-1093 export PlayerLoyaltyDTO Database_loyalty_id_balance_earned_total_redeemed_total_expires_progress "achievements export interface PlayerLoyaltyCreateDTO player_id tier Default 'BRONZE' points_balance points_earned_total_redeemed_total tier_progress PlayerLoyaltyUpdateDTO points_balance_earned_total_redeemed_total tier_expires_progress achievements benefits milestones `player_id.id (1:1 Unique constraint `player_id Non-negative points balances Table `loyalty_ledger Created Migration/migrations_create_loyalty_ledgerCREATE TABLE loyalty_ledger UUID_random player_id DELETE CASCADE Transaction details Points gameplay 'REDEMPTION Points rewards 'ADJUSTMENT adjustment Points expired Promotional bonus points_change Positive credit Negative debit balance Snapshot balance transaction Source tracking_type_SLIP_id UUID ratingslipsource Metadata JSONB Flexible storage transaction context Audit created TIMESTAMPTZ NULL UUID Admin user Indexes CONSTRAINT ledger_points_balance_positive_after >= 0 CREATE INDEX_loyalty_ledger_player_id CREATE INDEX_loyalty_ledger_created INDEX_loyalty_ledger_source INDEX_loyalty_ledger_transaction_type export LoyaltyLedgerDTO Database"loyalty_ledger_id_type_change_after_type_id "created_at

export interface LoyaltyLedgerCreateDTO player_id transaction "ACCRUAL points_change balance source "RATING_SLIP source_id description metadata Record created string

Business Logic Design Points Calculation Algorithm-calculator Calculate loyalty points RatingSlip theoreticalWin houseEdge%) totalRounds basePoints conversionRate multiplier Apply bonuses Empty seats +5% High volume +10% > expectedRoundsPerHour integer RatingSlip performance game settings Calculated points calculatePoints averageBet totalRounds gameSettings house_edge average_rounds_hour point_multiplier 1.0_conversion_rate 10.0 seats_available 7 Calculate theoretical win profit house_edge totalRounds Base points win pointsEarned theoreticalWin_conversion_rate_multiplier Empty seat bonus off bonusFactor 5% empty seat High volume bonus extended play > average_rounds_per_hour 1.1 10% bonus Round integerround(pointsEarned); Input DTO export interface PointsCalculationInput averageBet totalRounds gameSettings house_edge average_rounds_per_hour point_multiplier points_conversion_rate seats_available Business Validation Validate points calculation error invalid validatePointsInput void.averageBet <= 0 "INVALID_AVERAGE.totalRounds <= 0 "INVALID_TOTAL.gameSettings.house_edge <= 0 > 100 "INVALID_HOUSE between 0 Tier Management Logic

Tier Definitions LOYALTY_TIERS BRONZE minPoints 0 maxPoints 999 benefits "Birthday bonus minPoints 1000 maxPoints 4999 benefits"Priority bonus "Quarterly rewards GOLD minPoints 5000 maxPoints 19999 lounge bonus "Monthly rewards PLATINUM minPoints 20000 maxPoints Infinity benefits bonus "Exclusive events LoyaltyTier_TIERS Tier Calculation Determine points earned pointsEarnedTotal calculateTier(pointsEarnedTotal LoyaltyTier >=.PLATINUM.minPoints return > return >minPoints return Calculate tier progress (0-100% pointsEarnedTotal Lifetime Progress percentage next calculateTierProgress(pointsEarnedTotal currentTier calculateTier return 100 Max tier reached tierConfig LOYALTY_TIERS currentTier "BRONZE.SILVER.GOLD.PLATINUM pointsEarnedTotal.minPoints pointsNeededForNextTier Math.round((pointsInCurrentTier pointsNeededForNextTier

CRUD Operations Design Module/loyalty/crud Loyalty CRUD Module PT-2 service architecture import SupabaseClient Database executeOperation/operation ServiceResult export createLoyaltyCrudService SupabaseClient<Database Initialize loyalty record new player created playerId UUID ServiceResult initial loyalty record initializePlayerLoyalty async playerId<ServiceResult<PlayerLoyaltyDTO>> executeOperation<PlayerLoyaltyDTO error supabase_loyalty") player_id points_balance_earned_total_redeemed_progress id player_id tier_progress achievements benefits milestones created updatedcode "LOYALTY record exists player error return data Create ledger entry entry data ServiceResult entry createLedgerEntry async LoyaltyLedgerCreateDTO<ServiceResult<LoyaltyLedgerDTO>> executeOperation async error await supabase id player_id transaction_type points_change balance source_type description metadata created return data Update player loyalty record playerId UUID updates update ServiceResult updated record updatePlayerLoyalty async playerId PlayerLoyaltyUpdateDTO<ServiceResult<PlayerLoyaltyDTO>> executeOperation_update async await supabase_loyalty")select id player_id points_balance achievements benefits milestones created updated.single "PGRST116") "LOYALTY_NOT record found player error

return data player loyalty record ID playerId ServiceResult loyalty record getPlayerLoyalty async playerId Promise<ServiceResult<PlayerLoyaltyDTO>> executeOperation<PlayerLoyaltyDTO_get async data error await supabase_loyalty") id player_id points_balance_earned_redeemed_expires_progress achievements benefits created updated "LOYALTY_NOT record not found player return data

Query Operations Design Module/loyalty/queries Loyalty Queries Module PT-2 service architecture player's loyalty metrics?" import SupabaseClient Database executeOperation ServiceResult export TransactionHistoryOptions limit offset transactionType "ACCRUAL "REDEMPTION "ADJUSTMENT "EXPIRATION startDate endDate export interface TierProgressDTO currentTier pointsEarnedTotal progressPercentage nextTier export createLoyaltyQueriesService SupabaseClient<Database points balance playerId ServiceResult balance getBalance async playerId<ServiceResult<PlayerLoyaltyDTO>> executeOperation<PlayerLoyaltyDTO_get error supabase_loyalty")\_id points_balance"PGRST116") "LOYALTY_NOT error return data current tier playerId UUID ServiceResult info getTier async playerId<ServiceResult<PlayerLoyaltyDTO>> executeOperation<PlayerLoyaltyDTO_get async supabase_loyalty") player_id tier_expires_progress benefits_id", "LOYALTY_NOT record not found return data transaction history playerId UUID options Filtering/pagination options ServiceResult ledger entries getTransactionHistory async playerId TransactionHistoryOptions<ServiceResult<LoyaltyLedgerDTO executeOperation_get_transaction async query supabase"loyalty_ledger") id player_id transaction_type points_change balance_after source_type_id description metadata created.eq("player_id", playerIdascending false

Apply filters.transactionType.eq(.startDate.endDate Apply pagination.limit.offset.range options.offset.limit - 1 data error await query throw error return data Get tier progress information playerId UUID ServiceResult progress data getTierProgress async playerId string Promise<ServiceResult<TierProgressDTO>> return executeOperation<TierProgressDTO_get_tier_progress", async data error await supabase_loyalty").select("tier points_earned_total_progress").eq("player_id",.single.code "PGRST116") throw "LOYALTY_NOT_FOUND", record not found player error currentTier data pointsEarnedTotal datapoints_earned_total 0 Calculate next points LOYALTY_TIERS nextTier null pointsToNextTier 0 "BRONZE") nextTier pointsToNextTier.SILVER.minPoints pointsEarnedTotal nextTier nextTier "PLATINUM"; pointsToNextTier.minPoints pointsEarnedTotal currentTier pointsEarnedTotal pointsToNextTier Math.max(0 progressPercentage data.tier_progress 0 nextTier

Translation Layer Design Module/loyalty/telemetry-mapper Map RatingSlip Loyalty input Telemetry Mapper RatingSlip Loyalty Context Translation Layer RatingSlip data Loyalty accrual import Database RatingSlip telemetry export id player_id average_bet accumulated_seconds points Pre points RatingSlip game_settings Loyalty accrual input LoyaltyService export playerId ratingSlipId pointsEarned averageBet durationMinutes gameType seatsAvailable RatingSlip telemetry Loyalty accrual input Loyalty loyaltyInput export mapRatingSlipToLoyaltyAccrual playerId ratingSlipId pointsEarnedUse pre-calculated points RatingSlip averageBet telemetry durationMinutes_seconds gameType telemetry_name seatsAvailable Use points RatingSlip field Avoid re-calculating points Loyalty RatingSlip owns calculation logic source Loyalty ledger transaction points NOT pre-calculated export mapRatingSlipToPointsCalculation averageBet telemetry totalRounds calculateRoundsFromDuration_seconds_rounds_per_hour gameSettings house_edge average_rounds_per_hour point_multiplier points_conversion_rate seats_available

Event Integration Design Flow RS RatingSlipService EventBus LoyaltyService Database Analytics Emit RatingSlipCompletedEvent trigger accruePointsFromSlip Map telemetry data Calculate points Insert loyalty_ledger Update player_loyalty balance Update tier Emit PointsAccruedEvent Notify Event Definitions RatingSlip completed RatingSlipService LoyaltyService RatingSlipCompletedEvent ratingSlipId playerId averageBet accumulatedSeconds points gameSettings timestamp points accrued LoyaltyService Analytics Marketing PointsAccruedEvent playerId pointsEarned newBalance timestamp Event Listener RatingSlip completion Triggers loyalty points accrual Supabase DB async function handleRatingSlipCompleted supabase createServerClientcreateLoyaltyService await.accruePointsFromSlip playerId ratingSlipId pointsEarned metadata averageBet durationMinutes.round gameType seatsAvailable Log error retry alert console.error"Failed accrue loyalty points Trigger** function insert/update **Supabase Edge-time listener queue completed slips call after RatingSlip creation Start migrate **Database Trigger**

Testing Strategy Test Structure-service Integration loyalty-business Business logic loyalty-points-calculation algorithm loyalty-tier-managementTier calculation tests Test Coverage Requirements Target Priority Points calculation 95%+ Critical Tier management 90%+ CRUD operations 85%+ Query operations 80%+ Medium Translation layer 75%+ Test Cases Points Calculation Tests base points averageBet 50 totalRounds 100 2.5_rounds 60_multiplier 1.0 10.0 seats 7 theoreticalWin 2.5%) 100 125 basePoints 1.0 1250 empty seat_multiplier 1.0 seats 5 2 empty seats 10% bonus basePoints 1250 bonus _ 1.10 1375 high volume averageBet 50 totalRounds 120 2.5 60_multiplier 1.0 seats 7basePoints (50 2.5% 120) 10 _ 1.0 1500 highVolumeBonus 1500 \* 1.10 = 1650 Tier Management Tests calculate tier(500(2500 calculate tier progress 500 points BRONZE (0-999) 500/1000 50% 3000 points (1000-4999) GOLD 2000/4000 50%

update threshold async supabase createTestClient loyaltyService Create player BRONZE createTestPlayer.initializePlayerLoyalty Accrue points.accruePointsFromSlip playerId ratingSlipId pointsEarned 1500 metadata result.getTier(player.data"SILVER Ledger Audit Tests"Loyalty create ledger entry async supabase createTestClient loyaltyService createLoyaltyService player createTestPlayer.initializePlayerLoyalty.accruePointsFromSlip playerId ratingSlipId pointsEarned 100 metadata(result.data.transaction"ACCRUAL.pointssource_SLIP maintain balance async supabase createTestClient loyaltyService player createTestPlayer.initializePlayerLoyalty Accrue 100 points.accruePointsFromSlip playerId ratingSlipId 100 Accrue 50 points result2 await loyaltyService.accruePointsFromSlip playerId ratingSlipId pointsEarned 50 Verify history await loyaltyService.getTransactionHistory(player

Implementation Roadmap Phase Foundation 1 Days 1-2 Database migration Type definitions CRUD module Unit tests CRUD 8-12 hours Phase 2: Business Logic 1 Days 3-4 Points calculation algorithm Tier management logic `accruePointsFromSlip() Unit tests 10-14 hours Phase 3: Queries Translation 1 Days 5-6 Query module Translation layer Integration tests Service factory 8-10 hours Phase 4: Actions Hooks 2 Days 1-3 Server actions-points-balance-history React Query hooks-loyalty-balance12-16 hours Phase 5 UI 2 4-5 Loyalty dashboard Points balance Tier progress card Transaction history table E2E tests 10-14 hours Phase 6 Event Integration 2 6-7 Points accrual Integration testing Documentation 8-10 26-36 hours (3-4.5 days 12-16 10-14 8-10 hours-1.5-76 (7-10 days (10

Appendices Error Codes HTTP Status `LOYALTY_EXISTS 400 loyalty record Duplicate initialization `LOYALTY_NOT_FOUND 404 No loyalty record player `INVALID_AVERAGE_BET invalid Validation failure `INVALID_TOTAL_ROUNDS invalid `INVALID_HOUSE_EDGE out range `INSUFFICIENT_BALANCE enough points redeem Redemption attempt `NEGATIVE_POINTS Points negative Invalid accrual Database Schema Reference migration file_loyalty_ledger.sql 5) Related Documents Service Handoff Initial requirements Template Implementation Responsibility Matrix ArchitectureVertical horizontal 1.0.0 Assistant 2025-10-10 Draft Ready Implementation Review approve Create database migration Phase 1 TDD approach
