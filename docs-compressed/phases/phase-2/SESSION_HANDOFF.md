Phase 2 Service Layer 2025-10-07 87.5% (7/8 services 4x improvement

Current State Completed 6 MTL Service Implementation_entry table RLS Columns id casino patron_id person direction area tender_type amount event_time gaming_day_id MtlDirection MtlArea TenderType money Constraints amount > 0 signature empty event_time validation/mtl create getById update delete Compliance CTR threshold patron transaction grouping Error handling FK violations validation errors NOT_FOUND/mtl/index.ts MTLService/mtl-service.test19 test cases pass rate CRUD compliance queries CTR error scenarios cash transactions Multiple Transaction Log AML/BSA compliance CTR threshold tracking ~2 hours compliance query 5 Casino Table Services Service Implementation table Columns id name location company_id/casino CRUD create getById update delete Queries list Error handling FK violations NOT_FOUND DUPLICATE_CASINO/casino/index 13 cases pass rate CRUD queries error scenarios ~2 hours Table Context

Context Service Implementation Three-table relationship gamingtable Tables casino gamesettings configuration house edge points Temporal join/table-context CRUD create update delete deactivateSettings Temporal configuration Automatic state management cascading deactivation/table-context 22 test cases pass rate Table CRUD settings operations temporal logic error scenarios 3-table relationships temporal validity windows state configuration ~2 hours execution Casino Location Standardization Test location inconsistency (4 services root-level 2 co-located standard Casino TableContext tests Updated_TEMPLATE_LOCATION_INCONSISTENCY 100% consistency 6 services.js conventions Test location orthogonal vertical slicing analysis 4 Schema Consistency Migration UUID Standardization.id TEXT tables UUID Type-unsafe FKs casting overhead ORM friction Migrated TEXT UUID zero production impact Unified ID semantics type-safe joins zero casting overhead Single FK_history.session_id migrated ยง4 Anti Guardrails_CONSISTENCY_RESOLUTION

Implementation [20251006234748_financial_transaction.sql Table_financial_transaction UUID FKs `ReconciliationStatus Constraints_least_one_value amount validations Indexes player_id visit_id rating_slip_id reconciliation_status/player-financial/crud create getById update delete Queries Error handling FK violations constraint violations NOT_FOUND/player-financial/index PlayerFinancialService/crud.test 16 test cases Fixture error handling CRUD queries cases anon key service_role adjustment money Domain ~2 hours schema migration audit documentation Responsibility/phase-2/SERVICE_RESPONSIBILITY_MATRIXDefines 5 contexts Identity Location Session Performance Finance Data flow patterns RatingSlip Player Casino PlayerFinancial Anti-patterns-domain ownership service-to-service calls Step PlayerFinancialService separate financial domain Completed 2-3 RatingSlip Service SIMPLIFIED/ratingslip/crud UUID generation FK violation handling PGRST116 NOT_FOUND Status averageBet endTime seatNumber support Removed financial fields PlayerFinancialService/ratingslip/index RatingSlipService interface tests/phase-2/ratingslip-simplification-analysis ~40 minutes 30% 3 financial fields Completed 2 Visit Service Velocity interface.test tests ~45 minutes (4x faster Player Completed 1-2 Player Service CRUD TDD/player/crud.ts create update getById(/index PlayerService interface-service.test tests ~3 hours template creation Completed 1 Foundation Documentation/patterns/SERVICE_TEMPLATE.md 500+ line reference_TEMPLATE_QUICK.md 2-page cheat sheet/patterns/controlled-hybrid-refactor-model.md

Architecture 85/100 compliance Controlled Hybrid mining Deferred CRUD

Agenda 7) Priority Final Core Service.5% 100% (1 day rewards_loyalty_preferences tables Multi-table relationships calculations points accrual Completes 8/8 core service MVP

Velocity Metrics 7 Services Complexity Player 180 min template creation Visit 45 Template application RatingSlip 40 JSON fields 120 schema migration audit Casino 120 CRUD queries parallel execution TableContext 3-table relationships parallel execution MTL 120 Compliance CTR aggregation regulatory logic minutes service 4x improvement 7 services proactive migration 2 services 98 tests 7 services

Week 2 Roadmap Player Visit RatingSlip Three Schema consistency PlayerFinancialService context Casino Service Table Context Service MTL Service Loyalty Service Integration layer PT-1 mining

Success Criteria Completed Zero PRD violations-Violation Rule operations return Explicit interfaces DB constraints business errors Test coverage >80% consistency UUID keys context 8/8 services 7/8 Loyalty Service Integration patterns documented PT-1 pattern mining

Architecture Decisions Hybrid TDD PT-1 mining Lock pattern acceleration of complexity Context Service Responsibility Matrix UUID standardization prevention inconsistencies phase Location Root-level orthogonal vertical slicing

Critical Files Implementation (7/8 Complete [services/player Identity domain/visit Session domain/ratingslip Performance domain/player-financial Financial domain/casino Location domain/table-context Configuration domain [services/mtl/ Compliance domain/loyalty/ Rewards domain Documentation/phase-2/SERVICE_RESPONSIBILITY_MATRIX.md context/audits/SCHEMA_CONSISTENCY_RESOLUTION.md \*\*UUID migration/patterns/SERVICE_TEMPLATE_QUICK.md/system-prd/CANONICAL_BLUEPRINT_MVP_PRD Anti-patterns ยง4/architecture/ADR-002-test-location-standard location/TEST_LOCATION_INCONSISTENCY_LOCATION_INCONSISTENCY inconsistency Migrations [20251006234000_migrate_ratingslip_uuid Schema consistency_create_player_financial_transaction.sql Financial domain

Start Session Loyalty Service Implementation Verify services tests Review context_RESPONSIBILITY_MATRIX Create Loyalty Service structure tests services/loyalty LoyaltyLedger player_loyalty_preferences Check schema Start create( services/player-financial-table relationships Rewards Points accrual tier management rewards Multi-table LoyaltyLedger player_loyalty player_preferences player_id visit_id Points calculations progression balance tracking

Anti-Pattern Guardrails Before Code `ReturnType createXService XService TEXT primary keys tables PRIMARY KEY DEFAULT_random_uuid Mixed ID types Consistent UUID references-rebuilt Cross-domain method calls Aggregate client layer-Violation code breaks rewrite Consistency new tables UUID keys Audit TEXT IDs

7. Phase 2 Service 87.5% MTL Service 7/8 services Visit RatingSlip Casino TableContext MTL UUID standardization Service Responsibility Matrix Template velocity 4x improvement 7 tests Player 8/8 Visit RatingSlip PlayerFinancial Casino TableContext 22/22 MTL 19/19 6) MTL Compliance CTR Gaming day calculations CTR threshold tracking queries Zero PRD violations Velocity ~2 hours compliance Loyalty Service 1 day Loyalty (8/8 LoyaltyLedger_loyalty Points accrual balance management Points calculations tier progression preference management Test coverage >80% ~1 day_RESPONSIBILITY_MATRIXservices-table LoyaltyLedger_loyalty Start Loyalty Service core layer
