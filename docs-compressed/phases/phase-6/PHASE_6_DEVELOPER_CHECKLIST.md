Phase 6 Checklist 2025-10-12 3.0 18-21h (30-35h Ready

Pre-Flight Checklist Documentation Review (30 min Read [LOYALTY_SERVICE_HANDOFF.md Review [PHASE_6_IMPLEMENTATION_PLAN_v3.md Execution plan Understand RatingSlip Loyalty (rewards Review event-driven architecture `RATINGS_SLIP_COMPLETED `POINTS_UPDATE_REQUESTED Environment Setup (15 min develop against db instance migrations `supabase/migrations Pull branch Verify Supabase connection Run tests Verify migration directory Check migration timestamp Agent Assignment Coordination Backend Architect TypeScript Pro Full-Stack Developer 3 Set communication channel dependency handoffs Establish quality gate checkpoints

Wave 0 Schema Corrections 2.5h Backend Architect waves Complete Task 0.1 Create Migration SQL (1h migration Create migrationCreate `loyalty_ledger table CREATE TABLE id UUID_random_uuid player_id rating_slip_id visit_id_id transaction_type 'GAMEPLAY 'MANUAL_BONUS 'PROMOTION 'ADJUSTMENT event_type 'RATINGS_SLIP_COMPLETED 'POINTS_UPDATE_REQUESTED points_change NOT reason source NOT NULL NOT Create idempotency index CREATE UNIQUE INDEX_loyalty_ledger_session_type_source NOT NULL Create performance indexes CREATE INDEX_loyalty_ledger_player_rating_slip Create/update `player_loyalty table CREATE TABLE player player_id current_balance lifetime_points_progress 0 updated TIMESTAMPTZ NOT CONSTRAINT_tier_progressCHECK_progress 0 100 Seed `loyalty_tier table INSERT threshold_points multiplier VALUES'BRONZE 1.25) 100000 2.0 CONFLICT DO Migrate data `LoyaltyLedger_ledger DROP `accrual_history table DROP `ratingslip.points DROP `LoyaltyLedger table Replace_player_session() RPC points logic Create `increment_player_loyalty() RPC UPDATE

Task 0.2 Apply Migration (30 min Use Supabase CLI MCP tool_migration_6_wave_0_bounded_context_corrections SQL Task 0.1 Monitor errors Supabase Check migration logs warnings Task 0.3 Verification (30 min schema return 0 column removed column_name 0_history dropped table_name show new schema (11 columns column_name data_type 'loyalty_ledger RPC show p_points parameter routine_name increment_player_loyalty routine 5 SELECT player_id SUM(points_change total player_id LIMIT 5 Task 0.4 Regenerate Types (15 min db:types-local Verifyupdated Check NO field_ledger correct schema Run TypeScript type-check errors Task 0.5 Grant Permissions role `loyalty_ledger_loyalty_role EXECUTE_player_loyalty() Test permissions query authenticated Wave 0 Exit Criteria verification queries pass Types regenerated no compilation errors No `ratingslip.points column_ledger 11 columns indexes_player_loyalty() RPC functional Backfill data migrated Wave 1-3 start 0 tasks

Wave 1: Parallel Foundation (8-10h COMPLETE (2025-10-13) 47/50 tests functionality verified_2_READINESS_REPORT Track 0 Loyalty Service 8h Backend Architect 1) Wave T1 2 Loyalty API Task 1.0.1 Loyalty Service Structure (1h directory/loyalty calculation operations operations definitions files Task 1.0.2 Business Logic Calculation 2h/loyaltyImplemented calculation functions `calculatePoints( export calculatePoints averageBet durationSeconds gameSettings playerTier Calculate win Apply tier multiplier BRONZE 1.0 1.25 GOLD 1.5 PLATINUM 2.0 Apply game multipliers seat bonus Return rounded points unit tests/loyalty/business passing Test PT-1 parity tier multipliers Platinum edge cases bet duration Coverage 55.47% deferred Wave 2 tests Task 1.0.3 CRUD Operations (Persistence/loyaltyexport async function insertLedgerEntry supabase player_id rating_slip_id visit_id session_id transaction 'GAMEPLAY_BONUS event_type points_change reason source Promise<ServiceResult executeOperation'loyalty_insert_ledger async error await supabase'loyalty_ledger

Unique violation success true data null processed success true data null Implement `updatePlayerBalance RPC export async updatePlayerBalance playerId deltaPoints current_balance string executeOperation_update_balance async await supabase.rpc_player_loyalty player_id delta_points success true Implement query methods Add CRUD tests 13/16 passing (81%) 97% coverage Idempotency verified Task 1.0.4 Manual Reward Infrastructure/loyalty/crudentry creation idempotency Ledger creation complete `manualReward( server action Wave 2 Task export async function manualReward supabase playerId sessionId points reason source staffId<ServiceResult newBalance Insert ledger entry index ledgerResult insertLedgerEntry player_id session_id transaction_type event_type 'POINTS_UPDATE_REQUESTED points_change reason source conflict return balance balance getBalance Update balance RPC updatePlayerBalance Infrastructure complete Ledger entry creation idempotency VERIFIED Tier progression threshold updates RPC integration tests passing Manual reward server action Wave 2 Task

Task 1.0.5 Service Factory Interface 1h `services/loyalty/index.ts Define interface export interface LoyaltyService calculatePoints calculateAndAssignPoints<ServiceResult manualReward<ServiceResult getBalance(playerId getTier(playerId getHistory(playerId options<ServiceResult<LedgerEntry Implement factory`typescript export function createLoyaltyService SupabaseClient<Database calculatePoints calculateAndAssignPoints async const.getPlayerTier points business.calculatePoints playerTier.insertLedgerEntry return.updatePlayerBalance.playerId manualReward getBalance (playerId.getBalance getTier getHistory (playerId optionsplayerId Track 2 MTL Wave 1 2h DEFERRED TypeScript Pro After Wave 0 T0 Deferred Wave 2 Task 1.2.1: MTL Server Actions (2h DEFERRED Implement CRUD actions CTR threshold detection gaming day calculation compliance reporting tests MTL business logic no dependency Loyalty Wave 1 Exit Criteria COMPLETE 5 tasks 94% test pass rate 80% threshold Idempotency balance Service interface compilation errors critical tests Server actions Wave 2) API ready Wave 2 47/50 tests Business 100% RPC 100% CRUD 97% coverage

Wave 2: Direct Service Integration APIs (7h COMPLETE Direct Service Invocation-001 simplified_2_COMPLETION_SIGNOFF PASSED 40% complexity reduction production reliability hardening service event reduced complexity 40% production Extension event bus 2nd (2h Track Schema Hardening Loyalty Integration COMPLETE Backend Architect tasks complete 13, 2025 Task 2.0.0 Schema Hardening COMPLETE_2_hardeninglines 6 audit columns loyalty_ledger_id attribution rewards_before_after_before_id correlation tracking 2 indexes_loyalty_ledger_correlation Forensic tracing_ledger_staff Audit queries RPC 11 columns player_id balance_before_after tier current_balance lifetime_points tier_progress updated row_locked Migration Types regenerated Verification script passes 8 checks Migration 20251013233420 database verification complete Task 2.0.1 Infrastructure Libraries (1.5h Created/correlation.ts AsyncLocalStorage correlation tracking/idempotency.ts SHA-256 key generation date bucketing/rate-limiter.ts LOC In-memory rate limiting (10/min staff/telemetryStructured logging wrapper canonical schema 34 infrastructure libraries.test (9/9 (13/13-limiter (12/12 Coverage >85% infrastructure components

files 41 tests Task 2.0.2 Loyalty Server Actions Created/loyalty-actions() Permission checks Rate limiting (10 Idempotency Audit logging_id tests-actions (7/7 Integrated infrastructure libraries idempotency rate-limiter File 7/7 tests RatingSlip Integration COMPLETE TypeScript Pro tasks complete 13, 2025 Task 2.1.1 Server Action RatingSlip Recovery-actionsLOC action Fetch slip Close session Accrue loyalty Emit telemetry service invocation event recovery PARTIAL_COMPLETION error Correlation ID tracking logging decision points `recoverSlipLoyalty `RatingSlipCompletionResult TypeScript diagnostics errors File orchestration logic Task 2.1.2 Integration Test Suite DEFERRED WAVE 3-loyalty 8 critical tests Wave 3 PRIORITY implementation end-end LOW tests 85%+ coverage manual testing Wave 3 priority

Wave 2 Exit Criteria COMPLETE deferral hardening (6 audit columns 2 indexes RPC enhanced 4 libraries 34 tests manualReward() rate limiting recovery pattern recovery pattern safety verified (0 errors DEFERRED WAVE 3 (8-test suite HIGH 41 unit tests 13/13 gates passed Wave 2 COMPLETE Wave 3 1,980 LOC 13/13 gates passed ADR-001 approved_3_KICKOFF

Wave 3: UI E2E (6-8h Track 1 RatingSlip UI 3h Full Developer Wave 2 Task 3.1.1 RatingSlip Modal Updates (2h-slip Remove logic Add Bonus Points button loyalty response balance loading states async error handling loyalty failures Task 3.1.2 Manual Reward UI (1h Player ID Points Reason Source success balanceTier error rewarded Accessibility ARIA labels keyboard navigation Track 2 MTL UI 3h T1) Full-Stack Developer 3) Task 3.2.1 MTL Entry Form (2h CTR threshold warnings gaming day display Integrate MTL hooks Wave 2 Task 3.2.2 MTL Dashboard (1h compliance dashboard Display CTR alerts Show transaction history Track 3: E2E Testing 2h T1 T2 Full-Stack Developer 3) Task 3.3.1 Loyalty E2E Tests (1h-integration.test Mid-session manual reward Start rating slip reward points bonus Complete rating slip

Verify additive behavior gameplay finalBalance getLoyaltyBalance(500 + completion Idempotency duplicate reward reward returns success reward1 issueManualReward playerId sessionId points 500 'Bonus reward2 points 500(reward1 processed Verify ledger entry getLoyaltyHistory.filter_id Tier progression threshold upgrades Award points reach Silver (10,000 threshold issueManualReward playerId sessionId points 10000 'Promotion getPlayerTierTask 3.3.2 Cross-Domain E2E (1h visit RatingSlip Loyalty MTL Performance Manual reward Accessibility loyalty WCAG 2.1 Localization text strings externalized Wave 3 Exit Criteria RatingSlip manual reward MTL forms dashboard 5 tests >90% test coverage new code WCAG 2.1 AA compliance Manual reward

Quality Gates Wave 0 (6/6 Legacy schema violations `loyalty_ledger schema (11 columns Idempotency index RPC functions Types regenerated Backfill data verified Wave 1 Gates (8/8 Loyalty business logic >80% `manualReward() RPC updates balance Service interface handoff MTL actions implemented tests TypeScript errors unit tests passing Wave 2 (9/9) Event dispatcher_SLIP_COMPLETED handler_UPDATE_REQUESTED Event replay idempotency RatingSlip point Integration Completion ledger entry Manual reward ledger MTL hooks implemented Cache strategies Wave 3 Gates (8/8) RatingSlip UI updated points column Manual reward dialog MTL UI Mid-session reward test Idempotency test Tier progression test Performance manual reward Accessibility checksQuality 31 pass

Parallel Execution Strategy Agent Workflow Agent 1 Architect Path Wave 0 (8h 2-T0 (4h 1-T0 T1 2 2-T0 E2E testing Agent 2 Parallel Path 1-T2 (2h 2-T1 (3h PARALLEL Agent 3 UI Path 3-T1 (3h 3-E2E (2h Timeline Gantt Chart Agent 1 2 3-StackWave 0 2.5-4.5 1-T0 4.5-6.5 6.5-9.5 10.5-14.5 2-T0 9.5-12.5 2-T1 12.5-14.5 14.5-17.5 17.5-19.5 3-E2E 14.5h Clock 19.5h 29.5h Efficiency 34% Handoff 0 1 1 Loyalty API 2 RatingSlip APIs 3 starts 3 E2E tests

Definition Done 6) Functional Requirements LoyaltyService owns point mutations `manualReward( staff-limited triggered RatingSlip emits events points_UPDATE_REQUESTED ledger Idempotency validated duplicates Mid rewards Tier progression functional Technical 31 quality gates passed >90% test coverage code Zero TypeScript errors E2E tests Manual reward UI <2s WCAG 2.1 AA compliance Structured logs loyalty mutations Documentation API Loyalty Event contracts Rollback procedure Migration guide RatingSlip MTL Observability dashboard Operational_loyalty accurate Backfill verified data migrated Permissions granted Rate limiting `manualReward Audit logging Monitoring dashboards

Rollback Emergency Phase 6 fails Restore ratingslip.points column ALTER ADD points DEFAULT 0 Restore points backup Wave 0 player_loyalty data Recalculate balances loyalty_ledger_loyalty_id current lifetime_points SELECT player_id lifetime threshold_points ORDER player_id current_balance EXCLUDED lifetime Loyalty Comment listeners Redirect no-op Display maintenance message Rollback Decision Matrix Data loss incorrect balances Immediate rollback rebuild ledger Idempotency broken duplicate points Disable manual rewards Performance degradation Scale RPC optimize queries UI bugs display issues Hotfix UI no rollback

Support Escalation Development Review [LOYALTY_SERVICE_HANDOFF.md_SCHEMA_AUDIT.md_6_IMPLEMENTATION_PLAN_v3.md Escalation Notify agent update ETA Gate Review exit fix rollback Escalate tech lead approval Integrity STOP work escalate DB owner

Final Validation Checklist Pre-Deployment 31 quality gates verified E2E tests Performance benchmarks reward <2s Rollback procedure Monitoring dashboards Runbook Post-Deployment Monitor loyalty mutation logs Verify_loyalty balances_ledger duplicate ledger entries Confirm tier progressions Review manual reward audit logs Performance metrics SLA Post-Launch Review (1 week Update documentation Archive Phase 6 artifacts Plan Phase 7 Ready Execution 2025-10-12 3.0 After Wave 0 completion
