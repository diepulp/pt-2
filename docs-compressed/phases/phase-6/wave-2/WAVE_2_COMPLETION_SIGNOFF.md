Phase 6 PT-2 Loyalty System Loyalty Points 2 Loyalty October 13, 2025 APPROVED INTEGRATION

Wave 2 completed production-ready integration service quality gates passed schema hardening infrastructure libraries 40% complexity reduction production reliability hardening

Sign-Off Checklist Schema Hardening Loyalty Service Integration Task 2.0.0 Schema Hardening Migration file 6 audit columns loyalty_ledger balance correlation 2 indexes RPC 11 columns Migration Types regenerated Verification script passes verification checks show_id balance_before RPC enhanced indexes Task 2.0.1 Infrastructure Libraries/correlation AsyncLocalStorage correlation tracking/idempotency SHA-256 key generation-limiter-memory rate limiting/loyalty-actions manualReward server action/loyalty Idempotency conflict handling Structured logging wrapper files unit tests passing Task 2.0.2 Unit Tests/correlation(9/9 tests (13/13-limiter (12/12-actions.test (7/7 Coverage >85% infrastructure libraries 41/41 tests RatingSlip Action Orchestration Task 2.1.1 Complete Rating Slip Recovery (1.5h-actions Fetch slip Close session Accrue loyalty Emit telemetry recovery PARTIAL_COMPLETION `RatingSlipCompletionResult Correlation ID tracking Structured logging decision points File 0 TypeScript errors Task 2.1.2 Integration Test Suite (2h/ratingslip-loyalty.test 8 critical tests idempotency concurrency

Wave Test not implementation tests end-to-end LOW Unit tests 85% coverage manual testing Assign QA team Wave 3

Verification Results Database Schema Run psql docs_2_VERIFICATION_SCRIPTloyalty_ledger columns 0 11 columns (id player_id rating_slip_id visit_id session_id transaction_type event_type points_change reason source created_at loyalty_ledger columns 2) staff_id balance_before tier correlation_id Idempotency unique index_type Correlation ID index (Wave 2) Staff audit index 2) increment_player_loyalty RPC result 11 columns player_id balance_before_after current_balance lifetime_points tier_progress updated_at row_locked RPC row locking Data integrity checks No duplicate session entries CHECKS Code Quality Verification TypeScript Safety PASS (0 errors IDE Diagnostics Check File app/actions/ratingslip.ts array no errors PT-2 Architecture Standards Compliance Functional factories classes Explicit interfaces `ReturnType inference No global singletons factories Single source types No `console.\* production code logging No code No type casting

Quality Gates Summary Requirement Status Evidence applies Migration 20251013000001 Returns 9 columns/after PASS Returns 11 columns SQL 6 columns added loyalty_ledger staff_id balance_before/after/after correlation_id 2 indexes created staff_loyalty_ledger_correlation `loyalty:award enforced manualReward action 10 requests/min per staff tests verify enforcement Keys deterministic hash consistency Request-scoped tracking runWithCorrelation( wraps actions No types 0 TypeScript diagnostics errors Test >80% infrastructure 41/41 tests passing Canonical telemetry schema emitTelemetry( uses canonical schema RPC UPDATE Verifiedfunction definition No duplicate session entries Database 0 duplicates QUALITY GATES

Deliverables Inventory Files Created (11/migrations/20251013000001_hardening (170 lines/correlation/idempotency-limiter/telemetry/emit-telemetry (99 lines/loyalty-actions (293 lines-actions (456 lines (9 (13-limiter (12/loyalty-actions (7 Lines ~1,500 LOC ~480 Files Modified (2/loyalty `LoyaltyLedgerDTO 6 audit columns Added `IncrementPlayerLoyaltyResult interface Updated `createLedgerEntry( 23505 conflicts snapshots RPC/server-actions-wrapper No changes

Architecture Decisions ADR-001 Direct Service Invocation direct invocation RatingSlip Loyalty integration APPROVED Loyalty consumes RatingSlip telemetry Phase 6 services Next.js network overhead ~100 concurrent sessions justify distributed infrastructure_ARCHITECTURE_QUICK Honors PRD principles 40% complexity reduction faster delivery simpler debugging Requires refactoring 2nd Performance <500ms faster queue_2_SIMPLIFIED_WORKFLOW.md ADR-002 In-Memory Rate Limiting vs Redis in-memory rate limiting manual rewards low No multi-instance deployment 90% code reduction Redis rate limit deployment Horizontal scaling enabled1h implementation interface Saga Recovery Pattern Atomicity compensating transaction pattern_COMPLETION error recovery Supabase Saga consistent semantics Recovery action replay Correlation IDs forensic analysis partial failures Simpler observable failure states manual intervention Structured logging correlation IDs automated recovery

Risk Assessment Resolved Risks Before After Mitigation Loss Completion Recovery correlation tracing **Duplicate Manual Deterministic keys date bucketing idempotency tests **Concurrency Races** before audit columns **Untraceable Failures** Correlation IDs structured logs recovery metadata **Staff Permission checks rate limiter audit trail **Balance Ledger verification columns Risk +2h investment hardening Outstanding Risks Severity Mitigation Plan **Integration Tests Implement 8 tests Wave 3 Team Service Integrate RBAC Wave 3 (1h Architect **Rate Limit State Loss Deploy** Expected behavior MVP \*\*Performance Unvalidated<500mstest integration Create test Wave 3 Replace permission RBAC Add performance benchmarks CI/CD LOW

Handoff Wave 3 Prerequisites Wave 3 UI Testing integration points API Contracts Ready Returns Success ratingSlip loyalty AccruePointsResult Partial error_COMPLETION metadata slipId correlationId correlationId Returns<AccruePointsResult completeRatingSlip returns PARTIAL_COMPLETION Returns<AccruePointsResult 10 requests/min staff Requires:award Type Definitions Import RatingSlipCompletionResult loyalty AccruePointsResultexport interface AccruePointsResult pointsEarned tier ledgerEntry UI Implementation Slip Completion success points update PARTIAL_COMPLETION recovery correlation ID support tickets Reward rate limit quota staff attribution audit Require reason 10 400 Validation error 429 Rate limit exceeded 207 Partial completion recovery 500 Internal error Wave 3 Task Breakdown T3.1 Integration Test Suite QA Team-loyalty 8 tests Complete slip update Duplicate completion ledger Manual reward Rate limiting >10 rewards 429 error Completion <500ms Recovery fails recovery operations balance reward 8 tests Coverage >85% action dependencies T3.2 Permission Service Integration (1h Backend Architect MEDIUM

Integrate_permissions Verify:award Add RBAC tests Permission checks enforce RBAC tests verify authorization Unauthorized users receive 403 Forbidden MTL UI (4-6h Frontend Rating Slip completion button Manual reward form rate limit Loyalty points Tier progress indicator Audit trail Error states Correlation IDs 2.1 AA compliant Observability Dashboard DevOps Loyalty accrual Partial completion reward completion latency Correlation ID search Alerts anomalies>10% completion Correlation ID search

Documentation Updates Completed/WAVE_2_SIMPLIFIED_WORKFLOW workflow_2_COMPLETION_SIGNOFF Pending (Wave 3) Update_DEVELOPER_CHECKLIST Wave 2 completion_2_EXTENSION_PATH.md Update-contracts `RatingSlipCompletionResult schema Create runbook_POINT_RECOVERY.md Recovery Update/INDEX.md Wave 2 documents

Lessons Learned Agent Backend Architect TypeScript Pro timeline 7h to ~5h Direct service invocation reduced complexity 40% production readiness +2h investment reduced risk_2_VERIFICATION_SCRIPT validation schema changes 0 TypeScript errors first compile PT-2 standards **Integration Tests implemented validation integrated RBAC Benchmarking** <500ms not validated tests Recommendations Future Waves Implement Integration defer Schema Dependencies tables Performance Tests Automate performance regression detection Extension Path justify simplification decisions

Approval Signatures Development Team Architect October 13, 2025 APPROVED quality gates passed Schema hardening Infrastructure libraries production-ready Pro October 13, 2025 APPROVED RatingSlip actions error recovery Type safety verified Ready integration testing Architect October 2025 Architecture BALANCED_ARCHITECTURE_QUICK.md Extension path Complexity reduction QA Sign-Off Integration test Wave 3 Performance validation<500ms Manual smoke testing Unit tests Schema verification Type safety Architecture standards compliant Integration tests Wave Performance tests End-to-end smoke tests Product Management Sign-Off WAVE 3 Scope delivered WAVE_2_SIMPLIFIED_WORKFLOW.md Integration tests Wave 3 MTL UI workCriteria Loyalty service writes_ledger APIs manualReward server action rate limiting replay_id uniqueness Integration tests Performance <500ms validation

Status 2 integration tests WAVE 3 Wave 3 MTL UI Implementation Integration Testing 8-10h 1.0 October 2025 Phase 6 Working Group Development Team Product Management DevOps

Appendix A File Listing Wave 2 Deliverables (11 new 2 modified supabase/migrations 20251013000001_wave_2_schema_hardening.sql correlation idempotency rate-limiter telemetry app/actions loyalty-actions ratingslip-actions services/loyalty crud lib correlation idempotency rate-limiter actions loyalty-actions docs/phase-6 WAVE_2_SIMPLIFIED_WORKFLOW.md WAVE_2_COMPLETION_SIGNOFF.md

Appendix B Verification Commands Run baseline verification@127.0/WAVE_2_VERIFICATION_SCRIPT.sql Apply migration supabase db:types Run unit tests-actions Type check --noEmit Lint check run lint Re-run verification-migration@127.0/WAVE_2_SCRIPT.sql

Appendix C API Usage Examples 1: Complete Rating Slip Path completeRatingSlip async handleCloseSlip(slipId await completeRatingSlip.success balance console.error'Failed complete slip Example 2: Recover Partial Completion completeRatingSlip recoverSlipLoyalty async handleCloseSlipWithRecovery(slipId await completeRatingSlip.error_COMPLETION.warn closed loyalty await recoverSlipLoyalty result.slipId.correlationId successful failed Contact support correlation IDExample 3: Manual Reward Rate Limiting manualReward getRateLimitInfo/loyalty-actions async handleManualReward(playerId staffId Check rate limit quota await getRateLimitInfo.remaining 0 console.error limit exceeded Try result await manualReward playerId pointsChange 500 welcome bonus staffId console.log quota 1.error_LIMIT_EXCEEDED console.error limit
