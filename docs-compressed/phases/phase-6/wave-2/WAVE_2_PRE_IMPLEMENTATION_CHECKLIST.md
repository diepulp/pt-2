Wave 2 Checklist 2025-10-13 Verify database schema infrastructure Wave 2

Current State EXISTS 0 Complete Status Evidence **loyalty_ledger base 11 columns session_id **Idempotency unique_loyalty_ledger_session_type_source_id transaction_type source_player_loyalty Returns 6 columns (player_id current_balance lifetime_points tier_progress updated row locking** Function body UPDATE_loyalty Denormalized aggregate tier tracking **loyalty_tier Tier thresholds (BRONZE/SILVER/PLATINUM MISSING 2 Hardening Required Component Status **loyalty_ledger.staff_id** Manual reward audit trail **loyalty_ledger.balance_before** Verification saga recovery.balance Tier change alertscorrelation Distributed tracing_loyalty_ledger Correlation ID lookups_loyalty Staff audit queries balance tier row_locked/correlation Request-scoped correlation IDs/idempotency Deterministic key hashing/rate-limiter In-memory rate limiting/actions/loyalty-actions manualReward server action/ratingslip-actions completeRatingSlip recoverSlipLoyalty actions

Wave 2 Implementation Blockers CRITICAL Before Production Missing Audit verify balance changes no staff audit trail correlation tracing Apply migration_wave_2_schema_hardening.sql_2_VERIFICATION_SCRIPT.sql check 6 hardening columns Returns Insufficient populate balance_before/after verify tier changes Update RPC return 9 columns balance_before_before Recovery Path Partial slip fails recover loss Implement `recoverSlipLoyalty Integration test Recovery Keys Manual rewards duplicated Implement `hashIdempotencyKey date bucketing Correlation trace partial failures Implement AsyncLocalStorage correlation server action logs include `correlation_id field

Pre-Wave-2 Verification Procedure Run Baseline Verification/WAVE_2_VERIFICATION_SCRIPT Output 6 hardening columns Correlation ID index Staff audit index RPC returns basic result Idempotency index EXISTS UPDATE Apply Schema Hardening Migration Create migration file wave_2_schema Apply Regenerate TypeScript types db:types Verify Schema Changes/WAVE_2_VERIFICATION_SCRIPT verification_after_migration.txt Output 6 hardening columns EXIST Correlation ID index Staff audit index RPC returns enhanced result Idempotency index EXISTS UPDATE Implement Infrastructure Code/correlation.ts IDs/idempotency.ts key hashing-limiter.ts-memory rate limiting-actions-wrapperID Implement Server Actions/loyalty-actions `manualReward permission checks idempotency key generation Rate limiting enforcement Correlation ID propagation/ratingslip-actions `completeRatingSlip error recovery `recoverSlipLoyalty failures Correlation ID logging Update Loyalty Service/loyalty `createLedgerEntry 23505 conflicts balance_before/after tier correlation_id staff_id manual rewards Run Integration Tests-loyalty.test

Tests Happy path Complete slip ledger tier update Idempotency Duplicate completion ledger Manual reward rate limiting Performance Completion <500ms Slip fails recovery Simultaneous operations correct balance Manual reward date-bucketed keys Verify Observability Structured logs loyalty operations correlation_id balance tier Error recovery instructions

Ship-Blocker Verification Before Production Critical Verification 1: Schema Implemented loyalty_ledger_id_before_id column missing Critical Verification 2: RPC Returns Before/After increment_player_loyalty TABLE player_id balance_before balance_after_before_progress lifetime_points updated row_locked boolean Return include `balance_before Critical Verification 3: Recovery Path Wired Partial completion returns correlation loyalty failure await completeRatingSlip success false error 'PARTIAL_COMPLETION closed loyalty pending recovery action metadata slipId correlationId.metadata.correlationId undefined 2: Recovery reuses idempotency check ledger await recoverSlipLoyalty(slipId Query ledger_ledgereq_slip_id expect Deterministic Recovery duplicate ledger entry broken Critical Verification Idempotency Tests npm test-loyalty completion reward idempotency Duplicate completion single ledger entry Manual reward single entry test fails ledger entries

Post-Implementation Hygiene Monitoring Ship-Blockers Verification Daily Compare_loyalty.current_balance vs(loyalty_ledger.points_change mismatch >0 Hourly duplicate entries duplicates ID Weekly Check ledger entries non-null correlation_id >95% coverage 1 week Action Real-time invocation <0.1% completions higher investigate root cause

/No-Go Checklist Ready Wave 2 Implementation 6 columns loyalty_ledger Correlation staff indexes Returns 9 columns balance_before/after_locked correlation idempotency rate-limiter manualReward/recoverSlipLoyalty Loyalty CRUD audit columns 8 integration tests 3 hardening tests Ship-Blockers Schema columns RPC returns enhanced result balance_before Recovery path failure correlation_id Idempotency tests green duplicate entries 2 implementation pending Apply_wave_2_schema_hardening.sql migration verify_2_VERIFICATION_SCRIPT.sql
