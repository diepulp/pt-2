Wave 2 Simplified Integration Workflow Phase 6 Loyalty direct service invocation replaces event-bus lean Phase 6 requirements service-service calls dispatcher extension-consumer scenarios

Scope Objectives RatingSlip Loyalty integration point accrual manual reward HYBRID_ARCHITECTURE Loyalty service integration RatingSlip Out event bus infrastructure >1 consumer event_log table_ledger Redis rate limiting MTL hooks work 3) Success Criteria RatingSlip Loyalty service returns result consumes telemetry in-memory rate limiting audit enforcement tests ledger entries tier updates replay Performance <500ms end-to response

Dependencies Preconditions 0 schema corrections_ledger_loyalty RPCs verified Phase 6 checklist 1 deliverables/loyalty business CRUD modules RPC_loyalty Unit tests>80% coverage Supabase migrations:types No dirty migrations schema verification tests

Roles Communication Backend Architect Agent 1 Loyalty idempotency verification-memory TypeScript Pro Agent 2 type-safe integration contract QA Reviewer Validate compliance Kickoff sync final verification 4)

High-Level Timeline hardening 0-1.5 T0.1 Schema correlation T0.2 Loyalty reward 3-4.5 T1.1 recovery T1.2 idempotency 6-7 Documentation observability verification +2h production hardening idempotency correlation

Task Breakdown Track Loyalty Service Integration Task Schema Hardening Add audit columns strengthen RPC Create migration_hardeningAdd audit/tracing columns loyalty_ledger ALTER TABLE ADD COLUMN staff_id balance_before_after_before_after correlation_id Indexes queries CREATE INDEX_loyalty_ledger_correlation NOT NULL CREATE INDEX_staff NULL Update `increment_player_loyalty` RPC return before/after values CREATE REPLACE FUNCTION increment_player_loyalty_id_delta_points RETURNS TABLE player_id balance_before_after_before_progress lifetime_points updated row_locked SECURITY DEFINER search_path public before/after Run migration Regenerate types Verify RPC returns enhanced result/migrations/20251013_wave_2_schema_hardening Updated TypeScript types/databaseMigration RPC returns 9 columns No changes queries Task 2.0.1 Server Action Manual Reward loyalty service rate limiting enforcement PT-2 Create correlation ID infrastructure AsyncLocalStorage IDs deterministic idempotency key hashing Date-bucketed keys rewards External support in-memory rate limiter-limiter Map storage TTL cleanup limit 10 requests/min staff ~50 LOC 300

Create/loyalty-actions.ts `manualReward server action Permission checks staff `loyalty:award permission Deterministic idempotency key generation Rate limiting enforcement Integrate `LoyaltyService.createLedgerEntry export async manualReward playerId pointsChange reason staffId ratingSlipId Link recovering failed slip rewardId External reward ID promotions Promise<ServiceResult<AccruePointsResult>> return_reward async correlationId getCorrelationId Permission check error 'FORBIDDEN Rate limit check max 10_LIMIT_EXCEEDED Validate audit requirements.reason.length < 10_ERROR 10 characters Generate DETERMINISTIC idempotency key input.rewardId.ratingSlipIdratingSlipId hashIdempotencyKey playerId staffId points reason date Create ledger entry loyaltyService return.createLedgerEntry player_id rating_slip session_id idempotencyKey transaction_type.pointsChange_BONUS 'ADJUSTMENT event 'POINTS_UPDATE_REQUESTED points_change reason source staff_id Audit trail correlation_id Update `LoyaltyService.createLedgerEntry Handle idempotency conflicts Return entry conflict Call_player_loyalty RPC Store before/after values ledger audit verification/correlation/idempotency-limiter/loyalty-actions Updated/loyalty.ts conflict handling Unit tests/loyalty-actions.test

Permission checks:award Rate limiter >10 requests staff Idempotency keys inputs key Date-bucketed keys prevent duplicates Ledger stores staff_id correlation_id before Tests verify idempotency single ledger Task 2.0.2 Optional Telemetry Wrapper wrapper structured logging swap point queue workers logger Emit telemetry Structured logging Replace queue.publish emitTelemetry_SLIP_COMPLETED_UPDATE_REQUESTED playerId pointsEarned sessionId logger_telemetry event player_id points session_idtimestamp loyalty accrual-forget logs Implementation Plan ยง6 Track Exit Checklist Schema migration_ledger audit columns RPC Correlation ID infrastructure idempotency key hashing permission checks In rate limiter.createLedgerEntry idempotency conflicts telemetry wrapper Unit tests rate limit idempotency date bucketing Track 1 RatingSlip Action Orchestration Task 2.1.1 Rating Slip Recovery Orchestrate RatingSlip closure Loyalty point accrual transaction

Create/actions/ratingslip Implement `completeRatingSlip action error recovery export async function completeRatingSlip(slipId ServiceResult ratingSlip loyalty AccruePointsResult return_rating_slip async correlationId ratingSlipService loyaltyService Fetch rating slip data slipResult ratingSlipService.getById return slipResult Close session RPC points error await_slip_id_id_taken_time throw Calculate assign points loyaltyResult await loyaltyService.accruePointsFromSlip playerId ratingSlipId visitId averageBet durationSeconds gameSettings.success throwEmit telemetry observability'RATING_SLIP_COMPLETED playerId sessionId correlationId pointsEarned success true ratingSlip loyalty Log partial failure correlation ID_completion_failed correlation_id slip error recovery_needed true Return partial state UI success false error 'PARTIAL_COMPLETION message 'Slip closed loyalty recovery action metadata slipId correlationId Implement recovery action partial completions export async function recoverSlipLoyalty slipId correlationId_loyalty Check loyalty accrued_ledger_slip_id_type recovered success true pointsEarned_after ledgerEntryId true Verify slip CLOSED data slip await supabase\* slipId 'CLOSED success false error 'SLIP_NOT_CLOSED recover loyalty open slip

Accrue points deterministic key_slip_id loyaltyService return.accruePointsFromSlip ratingSlipId playerId visitId averageBet gameSettings Update RatingSlip remove points logic Audit/ratingslip residual points calculations Verify_player_session accepts points/ratingslip RatingSlipCompletionResult ratingSlip loyalty AccruePointsResult/actions/ratingslip/loyalty/recovery/ratingslip/index Integration tests-loyaltyAction returns ratingSlip loyalty payload success Partial failures return_COMPLETION error slipId correlationId Recovery action idempotent replay TypeScript type-safe interfaces Performance <500ms path No residual points RatingSlip Correlation IDs logged outcomes failure Task 2.1.2 Integration Test Suite Validate RatingSlip Loyalty flow recovery concurrency idempotency Tests-loyalty Loyalty Integration Complete ledger entry update Create test player slip Complete rating slip Verify response.loyalty Verify ledger entry rating_slip transaction event_SLIP_COMPLETED points_change.loyaltypointsEarned Verify player balance getPlayerBalance.loyalty Duplicate completion single ledger entry createTestScenario Complete twice Verify 1 ledger queryLedger reward Staff action MANUAL_BONUS ledger entry createTestScenario result manualReward playerId pointsChange 500 welcome bonus staffId-123

ledger await queryLedger(player transaction_BONUS welcome bonus test >10 manual rewards/min 429 error createTestScenario Exhaust rate limit i = 0 < 10 await manualReward playerId pointsChange 10 reason staffId 11th request fail await manualReward playerId pointsChange 10 11 staffId.error'RATE_LIMIT_EXCEEDED Completion <500ms createTestScenario start completeRatingSlip duration Saga recovery test Slip closed loyalty fails recovery succeeds await createTestScenario loyalty service failure createLoyaltyService(loyaltyService Error'Database connection lost Attempt completion PARTIAL_COMPLETION await completeRatingSlip(slip.error'PARTIAL_COMPLETION'correlationId Verify slip CLOSED no ledger entry closedSlip await supabase slip.id'CLOSED ledger await supabase_ledger_slip_id Run recovery key await recoverSlipLoyalty(slip.id result.error.metadata.data Verify ledger entry exists await supabase_ledger_slip_id slip(ledgerAfter).toHaveLength(1)Deterministic idempotency Concurrency test manual reward slip completion final balance async player slip createTestScenario Start operations Promise manualReward playerId pointsChange 500 welcome bonus staffId rewardId_001 Unique completeRatingSlip Verify final balance sum operations balance_loyalty_balance_id expectedBalance 500 completionResult.loyalty.pointsEarned

Verify 2 ledger entries await supabase_ledger_id'created true(ledger).toHaveLength(2)'MANUAL_BONUS'GAMEPLAY Idempotency case reward date bucketing reward single entry next second entry async player createTestScenario playerId pointsChange 250 bonus reward staffId Day 1: Issue reward await manualReward Same day await manualReward Verify 1 ledger entry await supabase_id(ledgerDay1).toHaveLength(1) advance next day Day 2: Issue same reward new entry await manualReward Verify 2 ledger entries date buckets supabaseeq Data creates player loyalty record visit rating slip Reuse 8 integration tests passing (5 3 Coverage >85% new action code recovery completion Concurrency test lost updates Idempotency test validates date keys CI dependencies

Track 1 Exit Checklist recovery path partial completion Integration tests Happy path ledger entry Idempotency single entry Manual reward rate Performance<500ms Saga recovery completion Concurrency balance Idempotency rewards No residual points RatingSlip Type definitions Correlation IDs flow paths Structured error logs recovery instructions

Quality Gates Verification Matrix Timing Evidence Manual reward tests Task 2.0.1 test-actions Rate limiter tests-limiter RatingSlip tests TypeScript Pro Task 2.1.1-actions Integration test Task 2.1.2 test/ratingslip-loyalty.test Type check tsc --noEmit (0 errors Lint lint (0 warnings Performance validation TypeScript Pro Integration tests <500ms Observability logs Manual verification logs schema

Risk Management Mitigations Trigger Action Rate limit lost rewards add 2nd consumer extension ยง9 event wrapper Analytics telemetry Loyalty service error slip backfill points_slip runbook point recovery Performance >500ms Direct service call fastest Monitor latency optimize RPC >500ms

Deliverables Documentation Updates/loyalty-actions-actions-limiter/emit-telemetry/loyalty-actions/ratingslip-actions/ratingslip-loyalty-limiter Update `PHASE_6_DEVELOPER_CHECKLIST.md revised Wave 2 tasks Create_2_EXTENSION_PATH.md upgrade triggers Update API contract docs `RatingSlipCompletionResult

Extension Path Phases Re-Introduce Deferred Components Observable Trigger Estimated Effort Second consumer domain Analytics Marketing `RATING_SLIP_COMPLETED 2h log Async replay Event versioning compliance mandates 3h rate Multi-instance deployment Horizontal scaling>2 Next.js instances 1h Processing latency >2s >2s 4h Migration Strategy Direct Call Event Bus 1 Direct service invocation.accruePointsFromSlip 2 >1 Consumer Thin event wrapper Replace implementation_SLIP_COMPLETED async Call consumers marketing loyalty 3 Async Required Queue workerpublish payload return timeout 2000 Stability.accruePointsFromSlip signature stable phases

Handoff Checklist Wave 3 Provide schema UI Share MTL Confirm integration test CI pipeline logging schema dashboard Archive extension path infrastructure upgrades

Complexity Risk Complexity Reduction Original Plan Original Wave 2 Hardened Simplified Reduction 7h production_ledger event_log audit columns **50%** handlers bus ledger business actions recovery Redis Queue-memory rate limiter ~800 LOC ~500 LOC **38%** 8 scenarios replay concurrency better coverage Event replay Redis failover queue monitoring Saga recovery correlation tracing 40% reduction infrastructure complexity production reliability hardeningRisk Mitigation Progress Before After Evidence Loss Recovery action correlation tracing **Duplicate Manual Deterministic keys date bucketing idempotency tests **Concurrency MEDIUM before audit columns concurrency test **Untraceable Correlation IDs logs recovery metadata **Staff Permission checks rate limiter audit trail \*\*Balance Ledger verification before columns Risk +2h investment hardening

Architecture Decision direct service invocation RatingSlip Loyalty integration APPROVED recommendation Backend Loyalty RatingSlip telemetry Phase 6 services Next.js network overhead ~100 sessions distributed event infrastructure_ARCHITECTURE_QUICK.md 2-domain workflows PRD principles 55% complexity reduction faster delivery simpler debugging lower operational burden refactoring extension Performance event bus <500ms >2s event dispatcher Over-engineered Database triggers Direct call wrapper Ready Execution 2025-10-13 Phase 6 Working Group Backend Architect TypeScript Pro System Architect approval_2_EVENT_API_WORKFLOW.md
