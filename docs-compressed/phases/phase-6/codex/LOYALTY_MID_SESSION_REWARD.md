Loyalty Service Mid-Session Reward design emits accrues points session end Issue adjust loyalty points session active real-time bonuses promos staff overrides LoyaltyService points mutation RatingSlipService emit interim events accrual events policy execution Maintain event-driven integrity events triggers accruals Allow in-session updates Add pathway Prevent double-counting_id_type ledger entries Ensure idempotency composite keys

Event Model **Existing** "RATINGS_SLIP_COMPLETED", "playerId "averageBet 200 "durationMinutes 45 (In-Session Event "POINTS_UPDATE_REQUESTED", "sessionId 300 "Mid-session "manual

Loyalty Service Handling Unified Handler mid events accruePoints pipeline loyaltyService accruePoints playerId sessionId reason.insertUnique playerLoyalty.updateBalance insertUnique duplicate accruals Direct Invocation event emission overkill staff tools call logic loyaltyService.manualReward playerId points reason sessionId Schema Adjustments Loyalty Ledger loyalty_ledger session_id reason source CREATE UNIQUE INDEX loyalty_ledger enables mid-session accruals double-countingEvent logic flowchart StaffPanel( Anti-Pattern RatingSlip updates loyalty balance event services ledger LoyaltyService Mid-session points RatingSlip loyalty_ledger Separate ledger unified ledger reason metadata Session closure final event Loyalty ignore duplicates balance field player_loyalty authoritative recalculated ledger Resolution Domain owner LoyaltyService Mid-session issuance_UPDATE_REQUESTED()\_ledger updates events Duplication control Composite index_id event source Triggering contexts RatingSlip StaffPanel PromotionEngine Extend loyalty_ledger schema accruePoints() handler manualReward() wrapper Register event listeners RATINGS_SLIP_COMPLETED POINTS_UPDATE_REQUESTED

Update player_loyalty accrual Mid-Session Reward Total Points Update loyalty_ledger event log point deltas accrual reward recorded player_loyalty.total_points cached aggregate derived ledger Mid-Session Reward Issued Event call_UPDATE 200 LoyaltyService loyalty/business/accrual accruePoints playerId sessionId reason source Log ledger_ledger").insert player_id session points_change Increment cached total progress delta_points Total Points Adjustment Logic Materialized View nightly Rebuild totals ledger integrity anti verificationLive Update RPC SQL trigger increment_player_loyalty_id delta_points RETURNS VOID_loyalty total_points_update player_id keeps player_loyalty accurate mid-session Session End RATINGS_SLIP_COMPLETED Loyalty adds remaining earned points mid-session bonuses additive no overwrite re-calc Mid-session reward ledger row immutable entry audit Increments total_points recalculates tier player snapshot End-session accrual Adds final earned points Completes session accounting real-time point increase Ledger No duplication close Tier logic-evaluates increment
