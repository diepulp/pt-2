RatingSlip Schema Audit Violations 2025-10-12 6 Wave corrections

RatingSlip schema PT-1) contains measurement/telemetry loyalty/reward violations prevent implementation Phase 6 telemetry Reward policy point calculation schema corrections separation concerns rewards testable services

Violations Identified Violation #1 `ratingslip.points/migrations/20250828011313 `20250116093905_add_points_ratingslip ADD loyalty points telemetry table RatingSlipService distinguish gameplay points bonuses No audit points Table 5 bet $50/hand played 2 hours session 1,543 points Mixing domains coupling COLUMN points Violation #2 `accrual_history Table/migrations/20250828011313sql:1325-1349_lightweight_points_tracking CREATE TABLE "accrual_history NULL_random_uuid_id ratingslip_id NULL Loyalty concern_theo Loyalty calculation_applied NULL_details NULL CONSTRAINT "accrual_history_pkey couples ratingslip ALTER TABLE_history CONSTRAINT_session_id_fkey REFERENCES DELETE UPDATE table not telemetry Stores point accruals promotions calculations Creates competing source `LoyaltyLedger Foreign key couples domains database level proto-loyalty-ledger before context separation RatingSlip TABLE accrual_history CASCADE Violation #3_player_session()/migrations/20250828011313_correctedsql

close_player_session p_rating_slip_id_chips_taken_time zone_points 0 Loyalty parameter returns json Update rating slip status 'CLOSED chips_taken end_time points Assigns loyalty points id_slip status 'OPEN Update visit check_out_date_end_time null json_build RPC mixes operations Close rating slip Assign loyalty points test closure point calculation Forces domains succeed Prevents mid rewards close Database RPCs single context RPC violates responsibility principle measurement finalization reward assignment Remove `p_points parameter assignment logic Violation `LoyaltyLedger Table Schema Insufficiency/migrationssql:1831-1843_modes_ledger CREATE TABLE "LoyaltyLedger NULL_id_id NULL Missing delta semantics NOT NULL points_change_date NULL_after NULL Denormalized calculation DEFAULT "LoyaltyLedger_pkey PRIMARY KEY Missing Columns Phase 6 No_slip_id Cannot link ledger session No_id support mid end-session linking No_type distinguish GAMEPLAY MANUAL_BONUS PROMOTION No_type audit explanation manual rewards distinguish system manual promotion

Incompatible Column/DEBIT_change_after Denormalized data calculated RPC( mid bonuses No idempotency protection Poor audit track session points Replace `loyalty_ledger schema PHASE_6_LOYALTY_PREREQUISITE

Required Schema Changes MigrationWave 0 Prerequisites service Phase 6 Wave 0 Context Corrections Remove RatingSlip/Loyalty coupling PT-1 STEP Create Loyalty Ledger Schema CREATE TABLE loyalty_ledger_random player_id rating_slip_id Link session visit_id session points_change transaction_type 'GAMEPLAY_BONUS 'PROMOTION event_SLIP_COMPLETED 'POINTS_UPDATE_REQUESTED Human-readable explanation source Prevent duplicate accruals session UNIQUE INDEX_loyalty_ledger_idempotency loyalty_ledger NOT NULL Performance indexes CREATE INDEX_loyalty_ledger_player_created_loyalty_ledger_rating_slip_loyalty_ledger_visit COMMENT TABLEloyalty point transactions supports end mid-session accruals.session_id session rating_slip_id visit_id.points_change delta (positive accrual negative redemption.transaction_type category MANUAL_BONUS PROMOTION REDEMPTION.source system manual promotion Migrate LoyaltyLedger Data entries new loyalty_ledger player_id visit_id rating_slip_id session_id points_change transaction_type event_type reason source_id_id NULL Old schema doesn track rating_slip_id_id Use visit_id session_id 'CREDIT 'DEBIT entries gameplay NULL_date Drop old LoyaltyLedger table Migrate ratingslip.points to loyalty_ledger

Migrate points rating slips loyalty_ledger player rating visit session transaction event reason source SELECT_id session_id rating_slip_SLIP_COMPLETED COALESCE_time ratingslip.points > 0CONFLICT_id transaction source Skip duplicates STEP Remove Context Violations Drop accrual_history table loyalty Drop points column ratingslip ALTER TABLE DROP STEP 5 Replace close_player_session Loyalty Logic Drop old function points Create new function points_session_rating_slip_visit_id_chips_taken_end_time timestamp REMOVED_points RETURNS json v_result_rows_affected Update rating slip telemetry status 'CLOSED chips_taken end_time REMOVED points id_slip_id status 'OPEN DIAGNOSTICS v_rows_affected ROW_COUNT Update visit NULL check_out_date p_end_time Return result v_rows_affected > 0 SELECT json_buildsession closed_slip_id_time v_result SELECT json_build_object false open rating slip ID_result RETURN v_result 'Failed close player session close rating slip visit (telemetry loyalty point assignment LoyaltyService STEP 6 Create Loyalty RPC Atomic Point Updates

CREATE FUNCTION increment_loyalty_id delta_points RETURNS TABLE_balance DECLARE new_balance Update balance player_loyalty current_balance lifetime player_loyalty_id_param new_balance no row initialize loyalty NOT INSERT_loyalty_id current_balance lifetime_points delta_points RETURNING_loyalty new_balance_tier 'BRONZE Determine new balance SELECT.tier new_tier new_balance >.threshold_points ORDER Update tier NULL UPDATE_loyalty tier new_tierplayer_id new_tier 'BRONZE Default tier Return state SELECT new_balance_tier LANGUAGE plpgsql increment_player_loyalty updates points recalculates tier VERIFICATION QUERIES Verify ratingslip points column_name return 0 Verify accrual_history table 0 Verify loyalty_ledger exists column_name data_type show id player_id rating_slip_id visit_id session_id points_change transaction_type event_type reason source created close_player_session points routine_name data_type show p_points parameter

Architecture Impact Before (PT-1 Coupled Architecture RatingSlipService Measures telemetry Calculates loyalty points Violation Mixed concerns ratingslip table average_bet duration (telemetry points Violation Wrong domain accrual_history table Violation Loyalty table points promo_details RatingSlip domain After (Phase 6 Bounded Contexts RatingSlipService Measures telemetry Returns avgBet duration writes telemetry ratingslip table average_bet accumulated_seconds NO points column Pure telemetryemits event/returns data LoyaltyService Receives telemetry Calculates points Assigns via RPC writes rewards loyalty_ledger table • points_change transaction_type session_id, reason, source │ Full audit trail

Data Migration Decision Matrix Scenario SQL Strategy PT-2 DROP points migration production data Preserve history Migrate points loyalty_ledger DROP DROP Preserve history Migrate archive old schema Phase 6 new no production data

Service Code Impact RatingSlipService Changes Required pattern RatingSlip calculating points async(slipId telemetry getTelemetry points calculatePoints Wrong domain_player_session_slip_id_id_taken Loyalty concern telemetry RPC 6 CORRECT RatingSlip returns telemetry async(slipId<RatingSlipTelemetry telemetry getTelemetry finalize telemetry_slip_id_id_taken NO p_points parameter Return telemetry Loyalty ratingSlipId playerId visitId averageBet durationSeconds gameSettings Server Action Orchestration Pattern-actionsexport async function completeRatingSlip(slipId createClient Finalize telemetry (RatingSlipService RatingSlipService.endSession.success success false error.error Calculate assign points (LoyaltyService ratingSlipId playerId visitId averageBet durationSeconds gameSettings success true data telemetry loyalty.data

Testing Impact Before Testing test telemetry point calculation closes rating slip await endSession verify telemetry points'CLOSED test loyalty logic After Testing RatingSlip tests telemetry closes await.endSession NO points assertion not Loyalty tests point calculation await LoyaltyService averageBet 50 durationSeconds 7200 gameSettings playerTier 'BRONZE NO telemetry assertions not Loyalty concern

Quality Gates Wave 0 Schema Corrections Migration script local database Verification queries points accrual loyalty_ledger table schema increment_loyalty close p_points database.types points ratingslip Service interfaces points Wave 0 Implementation Service Separation RatingSlipService returns telemetry point calculation LoyaltyService calculates assigns points Server actions services RatingSlip point calculation Loyalty telemetry measurement Integration telemetry points

\_6_LOYALTY_PREREQUISITE Enhanced loyalty_RESPONSIBILITY_MATRIX context definitions_ARCHITECTURE_QUICK.md Vertical horizontal slicing 1.0.0 2025-10-12 Audit Complete Migration Ready migration Wave 0
