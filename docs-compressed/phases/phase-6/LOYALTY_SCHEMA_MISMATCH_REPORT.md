Loyalty Service Schema Mismatch 2025-10-12 Wave 1 incorrect assumptions

Summary Wave 1 LoyaltyService developed schema references table field names database until corrected issue discovered Wave 2 RatingSlip LoyaltyService discard 2 schema review

Critical Issues Table Name Error/loyalty/crud.ts:22 WRONG Database"LoyaltyLedger CORRECT (snake_case Database ledger CRUD operations fail "relation errors player_loyalty Table Field Name Mismatches CREATE TABLE player_loyalty id UUID player_id tier TEXT DEFAULT 'bronze' current_balance DEFAULT 0 lifetime_points 0_progress DEFAULT 0.0 <created updated **Service Implementation** (WRONG): export PlayerLoyaltyDTO = PlayerLoyaltyRow "points_balance" current_balance "points_earned_total lifetime_points "points_redeemed_total "tier_expires_at "achievements "benefits" "milestones" **Field Mapping** Service Field (WRONG) Schema Field `points_balance `current_balance Redeemable balance `points_earned_total `lifetime_points`increasing total`points_redeemed_total`Not tracked schema`tier_expires_at`Tiers don't expire design`achievements`Not in MVP scope`benefits`Stored code (LOYALTY_TIERS)`milestones` Not in MVP scopeCRUD operations_loyalty incomplete loyalty_ledger Mismatches

`sql CREATE TABLE loyalty_ledger id player_id NOT rating_slip_id visit_id session_id transaction_type NOT NULL_BONUS event_type points_change NOT NULL Delta positive credit negative debit source DEFAULT 'system' created_at TIMESTAMPTZ DEFAULT export LoyaltyLedgerDTO LoyaltyLedgerRow "transaction_date" created_at "points" points_change "direction points_change sign "description" reason "balance_after" "metadata" schema Service Field (WRONG Schema Field Notes `transaction_date `created_at Timestamp field name `points_change Delta value negative `direction Use `points_change sign `description `reason Text description field `balanceCalculated not stored `metadata Not MVP scope `transaction_type Required field `event_type Domain event identifier `source Transaction source `session_id` Idempotency key_slip_id Link RatingSlip context ledger entry creation queries fail

Affected Files Schema References/loyalty/crud CRUD operations/loyalty/queries operations/loyalty/business References DTOs Dependent Files/loyalty/index Exports DTOs wrong field names Wave 2 RatingSlip Loyalty coordination

Root Cause Analysis Wave 0 schema corrections field Wave schema verification Wave 1 LoyaltyService implemented against document database TypeScript compilation.types.ts regenerated schema changes Issue discovered Wave 2 runtime errors TypeScript.types.ts out sync database schema invalid field names

Fix Service Match Schema No database migration Preserves schema integrity Wave Aligns schema service layer code design documents Regenerate.types schema Update DTOs match fields CRUD operations business logic field mappings Verify TypeScript compilation Add integration tests regression Option B Migrate Database Match Service Design code Aligns design migration data loss conflict Wave 0 complexity schema complexity

Immediate Action Regenerate Database Types Verify schema Create Service Implementation Update services schema fields_balance_earned_total_points Remove_redeemed_total_expires \*\*loyalty_date_change Remove_after Add `transaction_type_type_id_slip_id Update Business Logic/loyalty Update `accruePointsFromSlip( `points_change Use_balance `lifetime_points calculations Remove references non fields Add Integration Tests Player loyalty initialization Points accrual RatingSlip Ledger entry creation Balance tier queries Transaction history retrieval

Verification Checklist Wave 2:.types.ts regenerated verified DTOs updated schema CRUD operations queries Business logic mappings TypeScript compilation no errors Initialize player loyalty Create ledger entry Query balance tier Retrieve transaction history Integration test added

Design Document Updates fix update documents schema_CHECKLIST Wave 1 deliverables-prd Loyalty schema_RESPONSIBILITY_MATRIX Loyalty context

Timeline Impact Wave 1 COMMITTED NON-FUNCTIONAL 2 BLOCKED fix Fix 2-3 hours verification Fix Wave 1

User identified issue Wave 2 2 report schema correction No production impact 6 not deployed

Appendix Database Schema player_loyalty CREATE TABLE id UUID_random_uuid player_id tier 'bronze' current_balance DEFAULT 0 > lifetime_points 0_progress DEFAULT 0.0 >= 0.0 < created updated COMMENT TABLE player_loyalty aggregate loyalty_ledger current balance tier status_loyalty.current_balance redeemable points balance redemptions_loyalty.lifetime_points points earned increasing player_loyalty_progress next tier (0-100%) loyalty_ledger CREATE TABLE loyalty_ledger id gen_random_uuid player_id rating_slip_id visit_id session_id transaction_type_BONUS event_type points_change NOT reason source NOT 'system' created_at TIMESTAMPTZ NOT NULL COMMENT TABLE loyalty_ledger ledger loyalty point transactions rewards.session_id session ratingslip.id.transaction_type 'GAMEPLAY earned MANUAL_BONUS staff-issued PROMOTION marketing campaign ADJUSTMENT correction.event_type event transaction-driven.points_change 'Delta points (positive credit negative debit
