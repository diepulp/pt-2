Phase 6 Kickoff PT-2 Loyalty System Loyalty Points Testing MTL October 14 2025

Wave 3 integration testing deferred MTL UI 2 production-ready APIs direct service invocation start 2 APIs functional schema infrastructure complete Changes Integration tests Track 0 Architecture direct service invocation Permission service integration

Wave 2 Handoff Direct Service Invocation Pattern Server actions RatingSlip closure Loyalty accrual 40% complexity reduction event-driven approach Extension event bus (2h effort Migration 6 audit columns loyalty_ledger balance correlation_id 2 indexes staff RPC 11 columns/after (1,500/correlation correlation tracking key generation-limiter 10 req/min enforcement Structured logging (749 `recoverSlipLoyalty 41 unit tests passing 13/13 quality gates 0 TypeScript diagnostics errors Integration tests deferred Wave 3_2_COMPLETION_SIGNOFF

Wave 3 Objectives 8-test Validate workflows Verify idempotency recovery concurrency Performance validation<500ms UI Transaction CTR threshold Compliance dashboard reporting Loyalty data Replace permission service observability Documentation updates Success Criteria 8/8 tests>85% MTL UI WCAG 2.1 Performance<500ms Permission service RBAC documentation updated

API Contracts Reference Complete Rating Slip completeRatingSlip slipId Promise<ServiceResult Success true data ratingSlip loyalty pointsEarned ledgerEntry LoyaltyLedgerDTO Partial Completion Error closed loyalty success false error_COMPLETION message slip closed loyalty accrual failed metadata slipId correlationId result await completeRatingSlip.error_COMPLETION recovery option recoverSlipLoyalty result.slipId.correlationId Recover Partial Completion/actions/ratingsliprecoverSlipLoyalty slipId correlationId<ServiceResult returns_COMPLETION error Manual Reward/loyalty-actions manualReward playerId pointsChange reason staffId<ServiceResult Rate Limited Response false error_LIMIT_EXCEEDED 10 manual rewards per minute exceeded Idempotent Duplicate Response true processed 10 requests/minute per staff Date-bucketed staffId date points reason

Track Integration Testing 2-3h Team Backend Architect Wave 2 APIs CRITICAL production Task 3.0.1 Integration Test Suite(8 Path Complete creates ledger updates tier Create rating slip telemetry data Call completeRatingSlip Verify ledger entry transaction player balance increased updated threshold crossed Duplicate returns result Complete slip Attempt ledger entry Balance unchanged second attempt Reward Staff creates_BONUS ledger entry Call manualReward valid input Verify ledger entry transaction_type_BONUS staff_id recorded audit column balance updated Limiting Manual Reward 10 requests Issue 10 rewards Attempt 11th reward returns RATE_LIMIT_EXCEEDED error Wait rate limit reset Next reward succeeds \*\*Performance <500ms completes <500ms Start timer Call completeRatingSlip End timer Assert duration < 500ms Recovery Partialcompletion Simulate slip closes loyalty fails PARTIAL_COMPLETION error recoverSlipLoyalty Loyalty accrual No duplicate ledger entries

Race operations maintain balance Start two operations reward slip completion Wait both complete Verify Final balance sum operations No lost updates locking \*\*Idempotency Edge Case Date reward date bucketing Issue manual reward Day 1 identical reward Day 2 Verify Two separate ledger entries Day 1 duplicate idempotent Acceptance Criteria 8 tests passing Coverage >85% dependencies Performance test validates <500ms requirement Track 1: Permission Service Integration 1h Backend Architect None MEDIUM Task 3.1.1 Replace Permission Placeholder/loyalty-actions.ts permission check capability Integrate staff_permissions table true checkPermission staffId capability supabase_permissionsselect_id success false_CHECK_FAILED hasPermission success false error 'FORBIDDEN capability success true( verify `loyalty Return 403 Forbidden unauthorized users unit tests permission logic Acceptance Criteria Permission checks_permissions `loyalty:award enforced Unauthorized users 403 Forbidden error Unit tests verify authorization logic Track MTL UI Implementation 4-6h

Developer None Loyalty HIGH Task 3.2.1 MTL Transaction Entry Form (2h Transaction type amount player ID timestamp CTR threshold Gaming day validation-hook Integration MTL server $10k threshold CTR warning Gaming day Validation errors WCAG 2.1 AA compliant Task 3.2.2 MTL Compliance Dashboard (2h transactions CTR alert Transaction history Player lookup Export CTR alerts Filters Export reports Loading Task 3.2.3 Loyalty Data Consumption-loyalty-widgetDisplay player loyalty tier balance Read-only integration loyalty Real-time updates React Query Tier progress visualization import usePlayerLoyalty PlayerLoyaltyWidget {loyalty.tierProgress Widget displays loyalty tier balance MTL code mutate loyalty data React Query cache Updates reflect Track 3: E2E Testing Documentation 2-3h Full-Stack Developer Tracks 0 1 2 Task 3.3.1 Cross-Domain E2E Tests (1.5h/e2e/loyalty-mtl-integration.test

visit RatingSlip Loyalty MTL Manual reward MTL Tier progression MTL End-to completion <2s Task 3.3.2 Documentation Updates RatingSlipCompletionResult_POINT_RECOVERY Recovery partial completions_CHECKLIST Wave 2 update 3 Wave 3 links Acceptance Criteria 4/4 E2E tests API contracts Recovery Developer checklist

Quality Gates (16/16 Integration Testing tests Coverage >85% action code Performance validated<500ms Tests CI Permission Service 1) Permission checks:award enforced 403 Forbidden unauthorized tests verify authorization MTL UI 2) Transaction form functional CTR threshold detection Compliance dashboard Loyalty widget read-only WCAG 2.1 AA compliance verified E2E Documentation 3) Cross-domain E2E tests API contracts documented Recovery runbook complete

Timeline Parallel Workflow (8-10h 2 Integration Tests MTL Form 2.5-3.5 Permission 3.5-4.5 Refinement MTL Dashboard 4.5-6.5 Loyalty Widget 6.5-8.5 E2E Tests Documentation 10h 15-17h Handoff tracks Integration validate implementation Documentation

Assessment High Priority Risks Mitigation Integration tests bugs Early testing Track 0 buffer Performance <500ms Optimize RPC fallback async Permission schema missing_permissions table MTL-Loyalty coupling Code review read-only boundary Priority Risks Likelihood Impact Mitigation E2E test flakiness Retry cleanup Documentation drift Update docs changes WCAG compliance failures components

Done 3) Functional Requirements 8/8 integration tests MTL transaction dashboard Loyalty data Permission service RBAC Recovery procedures Technical 16 quality gates passed Performance<500ms Coverage >85% Zero TypeScript WCAG 2.1 compliance API contracts Recovery runbook Developer checklist Wave 3 completion Operational Rate limiting Permission checks Structured logging Correlation IDs tracked

Success Metrics 100% gates Integration tests MTL UI E2E validation Phases 4-5 100%

References_2_COMPLETION_SIGNOFF.md deliverables_SIMPLIFIED_WORKFLOW Architecture decisions_6_IMPLEMENTATION_PLAN_v3.md Overall plan_6_DEVELOPER_CHECKLIST.md workflow 1.0 October 14, 2025 Ready for Wave 3 Completion 8-10h

Quick Start Checklist Read Wave 2 Review API contract examples Verify_permissions table Confirm Supabase instance Pull branch Track 0 (Integration Tests START Create/ratingslip-loyalty.test Implement 8 tests Verify coverage Track 1 (Permission Service Update/actions/loyalty-actions Implement database permission check Add unit tests Track 2 (MTL UI Create/transaction-form-dashboard-loyalty-widget Test UI browser Track 3 (E2E Create E2E tests Update documentation Create Wave 3 start Wave 3 production-ready integration testing MTL UI
