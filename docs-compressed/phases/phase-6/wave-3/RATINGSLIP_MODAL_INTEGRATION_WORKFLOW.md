2025-10-14 Ready Wave 3 Task 3.1.1

Architecture Alignment workflow compliant architectural patterns Standards Applied Status State Management-003-state-management-strategy.md COMPLIANT Server Actions_ACTIONS_ARCHITECTURE Service Layer_LAYER_ARCHITECTURE_DIAGRAM ADR-003 State Management Principles Query Server `useServiceMutation `completeRatingSlip( `manualReward() Automatic loading/error state management retry logic (1 queries 0 mutations Server actions Invalidation Domain-level invalidation queries Query keys-slip pattern tests Component State `useState modal visibility No needed cross-component Key Structure operation Examples'loyalty-slip SERVER_ACTIONS_ARCHITECTURE.md Compliance Actions/actions `completeRatingSlip-actions marked server directive Integration Server actions NOT wrapped closures NOT called actions return `ServiceResult<T TypeScript support interfaces inputs/outputs architecture patterns follow standards Phase 3-6

Problem Wave 3 MTL RatingSlip updates Tasks 3.1.1 3.1.2 Phase 6 Checklist `points logic OLD.points dropped Wave 0 points display shows points gameplay Points 332-334) CORRECT

Current State Analysis-slip (402 LOC Points 332-334) loyalty points Session 365 Triggers callback Info 158 Name membership ID tier State Draft state validation No connection `completeRatingSlip Response Points New balance tier progress Reward No "Issue Bonus Points No async feedback No loyalty failure recovery UI Reward Component exist

Workflow Phase 1: Analysis Setup (30 min 1.1 Understand `completeRatingSlip() action 2) `manualReward() `usePlayerLoyalty() 3) State management strategy ADR-003 1.2 Apply ADR-003 State Management-003-state-management-strategy Query useServiceMutation completeRatingSlip RatingSlipModal closeSlip loyaltyResult error useServiceMutation(completeRatingSlip Invalidate queries ADR-003 queryClient.invalidateQueries-slip success feedback closed.tierUpgraded TierloyaltyTier component state Modal visibility component-local no cross-component sharing useState `closeSlip mutation React Query Modal visibility component-local No Zustand unless cross-component sharing Follows ADR-003 cache invalidation domain-level operations multiple queries Phase 2: Task 3.1.2 Manual Reward Dialog Task 3.1.1 integration/loyalty/manual-reward-dialog Player ID-only Points Reason (textarea 10 chars Source Points positive integer Reason non meaningful Action (ADR-003 useServiceMutation useQueryClient manualReward queryClient useServiceMutation manualReward Cache invalidation ADR-003 (domain-level queryClientinvalidateQueries'loyalty.invalidateQueries-slip sessionId Success feedback toast.success`Awarded{result toast.info balance{result Tier.tier

(false); Idempotency handling.code "IDEMPOTENCY_CONFLICT").warning reward processed.error.message); handleSubmit React.FormEvent<HTMLFormElement.preventDefault formData awardPoints playerId sessionId points reason source staffId \*\*Idempotency Show friendly message duplicate rewards Don hard error ARIA labels inputs Keyboard navigation Focus management dialog interface ManualRewardDialogProps open boolean void playerId sessionId currentBalance currentTier ManualRewardResult void export ManualRewardDialog Form validation works Server action correct params Success closes dialog Idempotency warning Error Accessibility keyboard navigation Phase 3: Task 3.1.1 RatingSlip Modal Updates (2h/rating-slip-modalChange 3.1 Add Loyalty Integration (ADR-003 Pattern React Query Mutation useServiceMutation useQueryClient/react completeRatingSlip/actions State ADR-003 SERVER_ACTIONS_ARCHITECTURE queryClient [showManualReward useState React Query mutation server state-003 Server action Pass action closeSlip completionResult error loyaltyError useServiceMutation completeRatingSlip Pass server action_ACTIONS_ARCHITECTURE Call callback local state sync Cache invalidation ADR-003-level queryClient.invalidateQueries-slip.id success feedback closed.loyalty upgraded celebration.loyalty.tierUpgraded

Close modal completion setTimeout recovery guidance.code closed processing failed Contact support close session Session React handleCloseSession server action mutation Local state callback onSuccess closeSlip(snapshot_ACTIONS Server action `useServiceMutation `completeRatingSlip server directive Returns `ServiceResult<RatingSlipCompletionResult typing Local state callback`onCloseSession `onSuccess after operation React Query manages loading/error states Cache invalidation follows ADR-003 domain-level pattern No manual state management async operations Consistent patterns codebase Change 3.2 Add Manual Reward Button "Current Points line 327)-y-4 rounded-xl-muted-medium-muted font-semibold( "0 NEW Manual Reward Button.status "OPEN variant="outline className="w-full gap-2 setShowManualReward(true className="size-4 Issue Bonus Points NEW Loyalty Result Display React Query mutation data-y-2-green-500/20-green-50/50-sm-semibold-green Session Complete-y-1 text-green Earned.loyalty.pointsEarned Balance.loyalty.newBalance.loyalty.tier.loyalty.tierProgress className="h-2 text-xs-muted.loyalty.tierProgress next tier NEW Error Display React Query mutation error className="h-4 w-4 {loyaltyError.messageclassName="mt-1 text-xs.correlationId-y-2 text-sm-muted tracking loyalty integration active Change 3.3 Manual Reward Dialog Integration

end component closing Manual Reward Dialog open{setShowManualReward playerId sessionId currentBalance "BRONZE(result) Refresh loyalty display setLoyaltyResult pointsEarned newBalance Change 3.4 Update Close Session Button button loading variant="destructive{handleCloseSession snapshot"CLOSED <Loader2 animate-spin Session Change 3.5 Add Required Imports (ADR-003 Compliant import useState from Gift AlertCircle Loader2 Alert AlertDescription AlertTitle Progress useToast ManualRewardDialog ADR-003 React Query server state management useServiceMutation useQueryClient/react completeRatingSlip/actions/ratingslip Phase 4: Testing Validation (1h/components/rating-slip-modal.test"RatingSlipModal Loyalty loyalty result after session completeRatingSlip return success mockComplete success true loyaltyPoints 500 1500 60 tierUpgraded false render<RatingSlipModal closeButton session await userEventawait expect.getByText Earned+500 Balance 1500 manual reward dialog bonus button render<RatingSlipModal snapshot status "OPEN bonusButton.getByRole bonus points await.click.getByRole /manual reward loyalty errors async mockComplete success false error "PARTIAL "Loyalty processing metadata correlationId "test-123" render<RatingSlipModal closeButton.getByRole session await.click await.getByText/loyalty processing failed **Integration Tests**/integration/ratingslip-loyalty.test

reward session updates balance real playerId await createTestScenario Issue manual reward session open rewardResult await manualReward playerId sessionId points 500 roller source staffId testStaffId expect(rewardResult Close session accumulate manual gameplay points completeResult await completeRatingSlip.data Manual gameplay **E2E Tests**/rating-slip-loyalty"RatingSlip Loyalty issue bonus points close-slip Issue bonus points bonus points roller welcome bonus points 500 points Close session Verify loyalty result earnedcontains balance.visible");.visible");` ---

Quality Gates Before Merge Manual reward dialog RatingSlip loyalty results Loading spinner Error handling reward button OPEN Idempotency unit tests integration tests E2E test workflow TypeScript compilation errors ESLint console.log keyboard navigation screen reader After Merge Update Wave 3 additions Mark Task 3.1.1 3.1.2 complete follow task deferred enhancements

Server Action Compliance_ACTIONS_ARCHITECTURE.md Verified Server Actions`completeRatingSlip(slipId:112 server directive 11 Returns `ServiceResult<RatingSlipCompletionResult Includes correlation ID tracking Implements recovery pattern_COMPLETION error Type-safe TypeScript support interfaces `withServerAction wrapper`manualReward:174 server directive Returns `ServiceResult<ManualRewardResult Includes permission checks rate limiting idempotency Audit logging-telemetry.ts Integration-003 SERVER_ACTIONS_ARCHITECTURE Pass server action useServiceMutation Don't wrap server action Don't call server actions services

Dependencies Risks `completeRatingSlip() action 2 `manualReward() `usePlayerLoyalty() `useServiceMutation Permission service loyalty:award 3 staff authentication context Toast notification system Risks Server actions tested Wave 2 UI components patterns Staff auth adjustment session ID correlation

Implementation Order Create standalone RatingSlip integration Update (2h Integrate loyalty completion Add manual reward button result displays Add tests (1h Unit Integration E2E 4.5 hours

Success Criteria Staff bonus points RatingSlip closure loyalty accrual Loyalty results Errors recovery guidance Idempotency rewards-count Zero TypeScript errors tests console warnings Accessibility standards 2.1 <100ms actions <2s feedback Intuitive button error messages tier upgrades Smooth transitions animations

Steps Mark Task 3.1.1 3.1.2 Phase 4 Run quality gates merge Update Wave 3 completion Phase 6 deployment Ready execution HIGH 3 2025-10-14 hours
