---
# EXECUTION-SPEC Frontmatter
# Generated by build-pipeline skill (lead-architect scaffold + 5 domain expert consultations)

prd: PRD-037
prd_title: "CSV Player Import — Lane 1 MVP"
service: PlayerImportService
mvp_phase: 3  # Phase 3 (Onboarding & Intake)

workstreams:
  WS1:
    name: Database Schema & RPCs
    description: "Enums, staging tables (import_batch, import_row), 3 SECURITY DEFINER RPCs, SRM registration, type regeneration"
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/20260223021214_prd037_csv_player_import_schema.sql
      - docs/20-architecture/SERVICE_RESPONSIBILITY_MATRIX.md
      - types/database.types.ts
    gate: schema-validation
    estimated_complexity: high

  WS2:
    name: RLS Policies
    description: "Casino-scoped RLS on import_batch and import_row — Pattern C hybrid reads, session-vars-only writes, role gating, delete denial, actor binding"
    executor: rls-expert
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - supabase/migrations/20260223021215_prd037_csv_player_import_rls.sql
    gate: type-check
    estimated_complexity: medium

  WS3:
    name: Service Layer
    description: "Pattern C (Hybrid) service — DTOs, Zod schemas, React Query keys, mappers, CRUD, HTTP fetchers, service factory"
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - services/player-import/dtos.ts
      - services/player-import/schemas.ts
      - services/player-import/keys.ts
      - services/player-import/mappers.ts
      - services/player-import/crud.ts
      - services/player-import/http.ts
      - services/player-import/index.ts
      - services/player-import/README.md
    gate: type-check
    estimated_complexity: medium

  WS4:
    name: Route Handlers
    description: "6 API endpoints (across 4 route files with multiple methods) under /api/v1/player-import/ with ServiceHttpResult contracts, Zod validation, idempotency enforcement"
    executor: api-builder
    executor_type: skill
    depends_on: [WS3]
    outputs:
      - app/api/v1/player-import/batches/route.ts
      - app/api/v1/player-import/batches/[id]/route.ts
      - app/api/v1/player-import/batches/[id]/rows/route.ts
      - app/api/v1/player-import/batches/[id]/execute/route.ts
    gate: lint
    estimated_complexity: medium

  WS5:
    name: Frontend — Import Wizard
    description: "6-step wizard with Papa Parse Web Worker, column mapping auto-detect, chunked upload, report display, CSV download with injection sanitization"
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS4]
    outputs:
      - app/(protected)/player-import/page.tsx
      - components/player-import/import-wizard.tsx
      - components/player-import/step-file-selection.tsx
      - components/player-import/step-column-mapping.tsx
      - components/player-import/step-preview.tsx
      - components/player-import/step-staging-upload.tsx
      - components/player-import/step-execute.tsx
      - components/player-import/step-report.tsx
      - components/player-import/column-mapping-row.tsx
      - components/player-import/report-summary-card.tsx
      - components/player-import/csv-download-button.tsx
      - hooks/player-import/use-import-wizard.ts
      - hooks/player-import/use-papa-parse.ts
      - hooks/player-import/use-column-mapping.ts
      - hooks/player-import/use-staging-upload.ts
      - hooks/player-import/use-import-report.ts
      - hooks/player-import/use-csv-download.ts
      - lib/csv/column-auto-detect.ts
      - lib/csv/csv-sanitize.ts
    gate: type-check
    estimated_complexity: high

  WS6:
    name: Unit & Integration Tests
    description: "Zod schema tests, mapper tests (100%), column mapping heuristic tests, CSV sanitization tests, HTTP contract tests"
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS3, WS4]
    outputs:
      - services/player-import/__tests__/schemas.test.ts
      - services/player-import/__tests__/mappers.test.ts
      - services/player-import/__tests__/column-mapping.test.ts
      - services/player-import/__tests__/csv-sanitization.test.ts
      - services/player-import/__tests__/http-contract.test.ts
      - services/player-import/__tests__/rls-policies.int.test.ts
      - services/player-import/__tests__/execute-rpc.int.test.ts
    gate: test-pass
    estimated_complexity: medium

  WS7:
    name: E2E Tests
    description: "Playwright happy-path wizard flow — upload, map, stage, execute, report — with isolated test data and sample CSVs"
    executor: e2e-testing
    executor_type: skill
    depends_on: [WS5]
    outputs:
      - e2e/workflows/csv-player-import.spec.ts
      - e2e/fixtures/import-test-data.ts
      - e2e/fixtures/sample-csvs/valid-players.csv
      - e2e/fixtures/sample-csvs/unknown-headers.csv
      - e2e/fixtures/sample-csvs/missing-identifiers.csv
    gate: test-pass
    estimated_complexity: medium

execution_phases:
  - name: "Phase 1 — Foundation"
    parallel: [WS1]
    gates: [schema-validation]

  - name: "Phase 2 — RLS + Service Layer"
    parallel: [WS2, WS3]
    gates: [type-check]

  - name: "Phase 3 — Route Handlers"
    parallel: [WS4]
    gates: [lint]

  - name: "Phase 4 — Frontend + Service Tests"
    parallel: [WS5, WS6]
    gates: [type-check, test-pass]

  - name: "Phase 5 — E2E Tests + Final Build"
    parallel: [WS7]
    gates: [test-pass, build]

gates:
  schema-validation:
    command: "npm run db:types-local"
    success_criteria: "Exit code 0, types regenerated successfully"

  type-check:
    command: "npm run type-check"
    success_criteria: "Exit code 0, no type errors"

  lint:
    command: "npm run lint"
    success_criteria: "Exit code 0"

  test-pass:
    command: "npm test services/player-import/"
    success_criteria: "All tests pass, coverage >= 80% service layer, 100% mappers"

  build:
    command: "npm run build"
    success_criteria: "Exit code 0, no build errors"

external_dependencies:
  - prd: PRD-035
    service: OnboardingBootstrapAuth
    required_for: "Auth pipeline must be deployed for import to work in onboarding flow"
  - prd: ADR-024
    service: CasinoService
    required_for: "set_rls_context_from_staff() RPC must exist"
  - prd: ADR-030
    service: CasinoService
    required_for: "Auth pipeline hardening (RETURNS TABLE pattern)"

risks:
  - risk: "Execute RPC complexity — cross-context writes to player + player_casino with identifier resolution"
    mitigation: "Schema-qualified references, thorough integration tests, batch size limits"
  - risk: "Papa Parse Web Worker cannot pause/resume — only abort"
    mitigation: "Decouple parsing from upload; queue rows locally, upload chunks independently"
  - risk: "raw_row PII retention — vendor CSVs may contain arbitrary PII"
    mitigation: "Accepted for MVP; GA gate documented — redaction policy required before general availability"
  - risk: "Weak-machine browser performance for large CSV files"
    mitigation: "Web Worker prevents UI blocking; recommend modern browser; 10,000 row limit"

npm_dependencies:
  - package: "papaparse"
    version: "^5"
    reason: "Browser-side CSV parsing with Web Worker support (ADR-036 D1)"
  - package: "@types/papaparse"
    version: "^5"
    reason: "TypeScript type definitions for Papa Parse"
---

# EXECUTION-SPEC: PRD-037 — CSV Player Import (Lane 1 MVP)

## Overview

Casino properties onboarding onto PT-2 need to seed their player pool from vendor-provided CSV exports with unknown schemas. This EXECUTION-SPEC delivers a browser-side CSV import pipeline (Papa Parse + column mapping UI) that normalizes vendor data to a canonical `ImportPlayerV1` contract, stages rows in dedicated tables, and executes an auditable, idempotent, casino-scoped merge via SECURITY DEFINER RPCs.

**Bounded Context**: PlayerImportService (NEW — SRM registration in WS1)
**Cross-Context Writes**: `player` (PlayerService), `player_casino` (CasinoService) — via SECURITY DEFINER RPCs only

## Scope

**In Scope:**
- Browser-side CSV parsing with Papa Parse (Web Worker + streaming)
- Column mapping UI with auto-detect heuristics + manual override
- Staging tables (`import_batch`, `import_row`) with batch lifecycle
- 3 SECURITY DEFINER RPCs (create, stage, execute)
- 6 API endpoints under `/api/v1/player-import/`
- 6-step wizard UI (File Selection → Column Mapping → Preview → Staging Upload → Execute → Report)
- Per-row outcome report with downloadable results CSV
- CSV injection sanitization (OWASP tab-prefix)
- RLS with casino-scoped isolation, role gating, actor binding, delete denial

**Out of Scope:**
- Loyalty tier/points writes (staged as metadata only in `raw_row`)
- Server-side file parsing or upload pipeline
- Reusable mapping preset templates (per-batch mapping stored for audit)
- External ID matching via `player_identity` (deferred until ADR-022 matures)
- Fuzzy matching or name similarity dedup
- Batch expiry / staging data cleanup automation
- `raw_row` PII redaction (deadline required before GA)

## Architecture Context

| Reference | Purpose |
|-----------|---------|
| ADR-036 | CSV Player Import Strategy — frozen architectural decisions |
| ADR-024 | Authoritative context derivation (`set_rls_context_from_staff()`) |
| ADR-030 | Auth pipeline hardening — write-path session-var enforcement |
| ADR-018 | SECURITY DEFINER governance |
| ADR-015 | Pattern C hybrid RLS |
| SRM v4.14.0 | Current bounded context registry (PlayerImportService registration pending) |

**Pinned Dependency: `set_rls_context_from_staff()`**
- Signature: `set_rls_context_from_staff(p_correlation_id text DEFAULT NULL) RETURNS TABLE(actor_id uuid, casino_id uuid, staff_role staff_role)` (ADR-030 D1)
- Location: existing migration (pre-ADR-030 hardening)
- Derives context from JWT `app_metadata.staff_id` + staff table lookup; sets `app.actor_id`, `app.casino_id`, `app.staff_role` via `SET LOCAL`
| SEC-NOTE-CSV-PLAYER-IMPORT | Threat model, controls, deferred risks |
| RFC-CSV-PLAYER-IMPORT | Design brief with table schemas, API surface, UX flow |

---

## Workstream Details

### WS1: Database Schema & RPCs

**Executor**: `backend-service-builder`
**Purpose**: Create the database foundation — enums, staging tables, SECURITY DEFINER RPCs, SRM registration.

**Deliverables:**
1. SRM update: Register `PlayerImportService` in SRM (v4.14.0 → v4.15.0) with ownership of `import_batch`, `import_row`
2. Migration file with:
   - Enums: `import_batch_status` (`staging`, `executing`, `completed`, `failed`), `import_row_status` (`staged`, `created`, `linked`, `skipped`, `conflict`, `error`)
   - `import_batch` table: PK uuid, `casino_id` FK, `created_by_staff_id` FK, `idempotency_key`, `status`, `file_name`, `vendor_label`, `column_mapping` jsonb, `total_rows`, `report_summary` jsonb, timestamps; `UNIQUE(casino_id, idempotency_key)`
   - `import_row` table: PK uuid, `batch_id` FK (CASCADE), `casino_id` FK, `row_number`, `raw_row` jsonb, `normalized_payload` jsonb, `status`, `reason_code`, `reason_detail`, `matched_player_id` FK nullable, `created_at`; `UNIQUE(batch_id, row_number)`
   - Indexes: `import_batch(casino_id, status)`, `import_row(batch_id, status)`, **functional index** `CREATE INDEX IF NOT EXISTS idx_player_email_lower ON public.player (lower(email))`, `player(phone)` (if not exists), `player_casino(casino_id, player_id)` (if not exists) — required for enrollment-first identity resolution (join through `player_casino` to scope by casino, then match on `lower(email)` or `phone`); if later migrated to `player_identity`, update index list accordingly
   - Trigger: `BEFORE UPDATE` on `import_batch` to set `updated_at = now()`
3. Three SECURITY DEFINER RPCs:
   - `rpc_import_create_batch(p_idempotency_key, p_file_name, p_vendor_label, p_column_mapping)` — creates batch or returns existing on idempotency match
   - `rpc_import_stage_rows(p_batch_id, p_rows)` — locks batch row via `SELECT total_rows FROM import_batch WHERE id = p_batch_id FOR UPDATE` (prevents concurrent staging from overshooting 10k cap), validates batch ownership + status, enforces server-side batch row limit (`IF total_rows + array_length(p_rows) > 10000 THEN RAISE EXCEPTION 'IMPORT_SIZE_LIMIT_EXCEEDED'`), validates each row has identifier, inserts staged rows using `INSERT ... ON CONFLICT (batch_id, row_number) DO NOTHING` (retry-safe: re-staging the same chunk is a no-op; rows are immutable once staged — to correct a staged row, the operator must create a new batch), updates `import_batch.total_rows` while holding lock
   - `rpc_import_execute(p_batch_id)` — sets `SET LOCAL statement_timeout = '120s'` to bound execution time, acquires batch row via `SELECT ... FOR UPDATE` (blocks concurrent callers; if a second execute call arrives while the batch is locked/executing, it waits on the lock and then returns the final status/report — it must not re-process rows; if batch is already `completed`/`failed`, returns existing status/report immediately), transitions `staging` → `executing`, performs casino-scoped identifier resolution using `LOWER(email)` for case-insensitive email matching (0=create new player+enrollment, 1=link only — sets `matched_player_id` with NO updates to existing player fields, N=conflict — no production writes), runs production writes in a subtransaction (failure rolls back all player/player_casino inserts but preserves the outer transaction); on exception, the outer transaction catches the error and updates `import_batch.status = 'failed'` with error detail in `report_summary` (two-phase pattern: production writes roll back, failure metadata persists), writes report_summary on success
4. Type regeneration: `npm run db:types-local`

**RPC Security (all 3 RPCs):**
- `SECURITY DEFINER`, `SET search_path = ''`
- RLS remains enabled on staging tables as defense-in-depth; tenant scope and role authorization are enforced inside RPC bodies using derived session vars, with schema-qualified references to prevent object shadowing
- First statement: `PERFORM public.set_rls_context_from_staff()`
- Derive `v_casino_id`, `v_actor_id`, `v_staff_role` from session vars
- Role gate: `IF v_staff_role NOT IN ('admin', 'pit_boss') THEN RAISE EXCEPTION`
- No `casino_id` or `actor_id` parameters (ADR-024 INV-8)
- Execute RPC: schema-qualified `public.player`, `public.player_casino` for cross-context writes
- GRANT: `REVOKE ALL ON FUNCTION rpc_import_* FROM PUBLIC; GRANT EXECUTE ON FUNCTION rpc_import_* TO authenticated` for all 3 RPCs

**Acceptance Criteria:**
- [ ] `npm run db:types-local` exits 0
- [ ] SRM v4.15.0 includes PlayerImportService with correct ownership
- [ ] All RPCs have no `casino_id`/`actor_id` parameters
- [ ] All RPCs call `set_rls_context_from_staff()` before data access
- [ ] UNIQUE constraints verified: `(casino_id, idempotency_key)`, `(batch_id, row_number)`
- [ ] Execute RPC handles all 3 outcomes: create (0 matches), link (1 match), conflict (N matches)
- [ ] Stage rows RPC locks `import_batch` row with `SELECT ... FOR UPDATE` before enforcing 10k cap and updating `total_rows` (race-safe; total_rows + new_rows <= 10,000)
- [ ] Stage rows RPC uses `INSERT ... ON CONFLICT (batch_id, row_number) DO NOTHING` for retry safety
- [ ] Execute RPC uses two-phase pattern: production writes in subtransaction, failure metadata persists
- [ ] Execute RPC sets `SET LOCAL statement_timeout = '120s'`
- [ ] GRANT: `REVOKE ALL FROM PUBLIC; GRANT EXECUTE TO authenticated` on all 3 RPCs
- [ ] Functional index: `CREATE INDEX IF NOT EXISTS idx_player_email_lower ON public.player (lower(email))`
- [ ] Identifier resolution indexes present: `player(phone)`, `player_casino(casino_id, player_id)`
- [ ] `updated_at` trigger on `import_batch`
- [ ] Migration ends with `NOTIFY pgrst, 'reload schema'`

---

### WS2: RLS Policies

**Executor**: `rls-expert`
**Purpose**: Casino-scoped RLS on both staging tables per SEC Note threat controls.

**Deliverables:**
1. RLS migration file with policies for `import_batch` and `import_row`

**Policy Matrix — import_batch:**

| Policy | Operation | Pattern | Key Expression |
|--------|-----------|---------|----------------|
| `import_batch_select` | SELECT | Pattern C hybrid + role gate | `casino_id = COALESCE(session_var, JWT)` + `role IN ('admin','pit_boss')` |
| `import_batch_insert` | INSERT | Session-vars only + actor binding | `casino_id = session_var` + `created_by_staff_id = app.actor_id` + role gate |
| `import_batch_update` | UPDATE | Session-vars only + role gate | `casino_id = session_var` + role gate |
| `import_batch_no_delete` | DELETE | Denial | `USING (auth.uid() IS NOT NULL AND false)` |

**Policy Matrix — import_row:**

| Policy | Operation | Pattern | Key Expression |
|--------|-----------|---------|----------------|
| `import_row_select` | SELECT | Pattern C hybrid + role gate | `casino_id = COALESCE(session_var, JWT)` + role gate |
| `import_row_insert` | INSERT | Session-vars only + role gate | `casino_id = session_var` + role gate |
| `import_row_update` | UPDATE | Session-vars only + role gate | `casino_id = session_var` + role gate |
| `import_row_no_delete` | DELETE | Denial | `USING (auth.uid() IS NOT NULL AND false)` |

**All policies include:** `auth.uid() IS NOT NULL` guard.
**Write policies:** Session-vars only (no COALESCE JWT fallback) per SEC Note T1/T2 controls.
**Read policies:** Pattern C hybrid (COALESCE session-var + JWT) per ADR-015.

**Acceptance Criteria:**
- [ ] RLS enabled on both tables (`ALTER TABLE ... ENABLE ROW LEVEL SECURITY`)
- [ ] `FORCE ROW LEVEL SECURITY` on both tables (defense in depth)
- [ ] Write policies use session-vars only — no JWT COALESCE fallback
- [ ] Read policies use Pattern C hybrid
- [ ] DELETE denied on both tables
- [ ] Role gate excludes dealer and cashier
- [ ] Actor binding enforced on `import_batch` INSERT
- [ ] All policies include `auth.uid() IS NOT NULL`

---

### WS3: Service Layer

**Executor**: `backend-service-builder`
**Purpose**: Implement PlayerImportService following Pattern C (Hybrid) — Pattern A for canonical contracts, Pattern B for CRUD DTOs.

**Deliverables:**

| File | Purpose | Pattern |
|------|---------|---------|
| `dtos.ts` | `ImportPlayerV1` (A), `ImportBatchDTO` (B: Pick), `ImportRowDTO` (B: Pick), `ImportBatchReportV1` (A), `ColumnMapping` (A), filter types | Hybrid |
| `schemas.ts` | `importPlayerV1Schema` (at-least-one-identifier `.refine()`), `createBatchSchema`, `stageRowsSchema` (max 2000 rows), `batchIdParamSchema`, list query schemas | ADR-013 |
| `keys.ts` | `playerImportKeys`: root, batches.list(filters), batches.detail(id), batches.rows(batchId, filters) | React Query |
| `mappers.ts` | `toImportBatchDTO`, `toImportRowDTO`, `toImportBatchReportV1`, list/nullable variants | 100% coverage |
| `crud.ts` | `createBatch`, `stageRows`, `executeBatch`, `getBatch`, `listBatches`, `listRows` — all call RPCs | ADR-012 (throws DomainError) |
| `http.ts` | Client-side HTTP fetchers with `Idempotency-Key` header support | Edge Transport |
| `index.ts` | `createPlayerImportService(supabase)` factory with explicit `PlayerImportServiceInterface` | Functional factory |
| `README.md` | Service documentation: bounded context, ownership, dependencies, pattern | Required |

**Acceptance Criteria:**
- [ ] `npm run type-check` exits 0
- [ ] No `as any` in any file
- [ ] No `console.*` in any file
- [ ] Functional factory with explicit interface (no `ReturnType` inference)
- [ ] `ImportPlayerV1` Zod schema validates at-least-one-identifier rule
- [ ] DTOs derive from `Database` types where applicable (Pattern B)
- [ ] Service throws `DomainError` (ADR-012), never returns `ServiceResult`

---

### WS4: Route Handlers

**Executor**: `api-builder`
**Purpose**: Create 6 API endpoints across 4 route files (some files handle multiple HTTP methods) with `ServiceHttpResult` contracts, Zod validation, and idempotency enforcement.

> **Note:** Preview and Report wizard steps are derived client-side using `GET /batches/:id` (includes `report_summary`) and `GET /batches/:id/rows` (with status filter). No dedicated preview/report/download endpoints required.

**Deliverables:**

| File | Methods | Endpoints |
|------|---------|-----------|
| `app/api/v1/player-import/batches/route.ts` | POST, GET | Create batch (idempotent), list batches (cursor paginated) |
| `app/api/v1/player-import/batches/[id]/route.ts` | GET | Get batch + report summary |
| `app/api/v1/player-import/batches/[id]/rows/route.ts` | POST, GET | Stage rows (max 2000, idempotent), list rows (cursor paginated) |
| `app/api/v1/player-import/batches/[id]/execute/route.ts` | POST | Execute merge (idempotent) |

**Error Code Mapping:**

| Domain Code | HTTP | Trigger |
|-------------|------|---------|
| `IMPORT_BATCH_NOT_FOUND` | 404 | Batch ID not found or not visible |
| `IMPORT_BATCH_NOT_STAGING` | 409 | Batch not in `staging` status |
| `IMPORT_BATCH_ALREADY_EXECUTING` | 409 | Batch currently executing |
| `IMPORT_ROW_NO_IDENTIFIER` | 422 | Row missing email and phone |
| `IMPORT_ROW_VALIDATION_FAILED` | 422 | Row fails schema validation |
| `IMPORT_IDEMPOTENCY_CONFLICT` | 409 | Idempotency key used for different batch |
| `IMPORT_SIZE_LIMIT_EXCEEDED` | 413 | File or row count exceeds limits |

**Route Handler Requirements:**
- `export const dynamic = 'force-dynamic'` on all routes
- `withServerAction` wrapper on all service calls
- `requireIdempotencyKey` on all POST mutations
- Zod validation for all request bodies and query params
- `await params` for dynamic route segments (Next.js 16)
- Casino context derived from auth middleware (ADR-024) — never from request payload

**Acceptance Criteria:**
- [ ] `npm run lint` exits 0
- [ ] All routes use `withServerAction` wrapper
- [ ] All POST mutations enforce `Idempotency-Key` header
- [ ] All request bodies validated with Zod before service calls
- [ ] Response contract is `ServiceHttpResult<T>` for all endpoints
- [ ] No manual `casino_id` extraction from headers or body

---

### WS5: Frontend — Import Wizard

**Executor**: `frontend-design-pt-2`
**Purpose**: 6-step wizard with Papa Parse Web Worker, column mapping auto-detect, chunked upload, and report display.

**Component Architecture:**

| Component | Responsibility |
|-----------|---------------|
| `import-wizard.tsx` | 6-step state machine, step indicator, conditional rendering |
| `step-file-selection.tsx` | Drag-and-drop + file picker, 10MB/10K row validation |
| `step-column-mapping.tsx` | Auto-detect results, manual override dropdowns, identifier requirement |
| `step-preview.tsx` | Summary cards, sample data table (first 10 rows), warning badges |
| `step-staging-upload.tsx` | Progress bar, chunk counter, retry logic, abort button |
| `step-execute.tsx` | Confirmation dialog, `useTransition` pending state |
| `step-report.tsx` | Outcome summary card, expandable row detail table, CSV download |
| `column-mapping-row.tsx` | Single mapping row (CSV header → canonical field dropdown) |
| `report-summary-card.tsx` | Created/linked/skipped/conflict/error count display |
| `csv-download-button.tsx` | Download results CSV with OWASP tab-prefix sanitization |

**Hook Architecture:**

| Hook | Purpose |
|------|---------|
| `use-import-wizard.ts` | Wizard state machine: step, batchId, file, mappings, parseResult |
| `use-papa-parse.ts` | Papa Parse wrapper (worker: true), returns rows/headers/isComplete/abort |
| `use-column-mapping.ts` | Mapping state, `autoDetect(headers)`, `setMapping()`, `isValid` |
| `use-staging-upload.ts` | Chunks rows into 500-row batches, TanStack Query mutation per chunk, progress tracking |
| `use-import-report.ts` | TanStack Query for batch detail + row listing with pagination |
| `use-csv-download.ts` | Generates CSV blob, applies tab-prefix sanitization, triggers download |

**Utility Files:**

| File | Purpose |
|------|---------|
| `lib/csv/column-auto-detect.ts` | Header alias dictionary for common vendor patterns (email, phone, first_name, etc.) |
| `lib/csv/csv-sanitize.ts` | Tab-prefix (`0x09`) sanitization for `=`, `+`, `-`, `@`, `\t`, `\r` per OWASP (conservative coverage across spreadsheet apps) |

**npm Dependencies:** `papaparse`, `@types/papaparse`

**Papa Parse Configuration:** `header: true`, `skipEmptyLines: true`, `worker: true`, `dynamicTyping: false`

**Acceptance Criteria:**
- [ ] `npm run type-check` exits 0
- [ ] No `useEffect` sync patterns (React 19 compliance)
- [ ] All async operations use `useTransition` (no manual `useState(false)` for pending)
- [ ] Column auto-detect covers all alias patterns from PRD
- [ ] CSV download sanitizes formula injection characters (tab-prefix)
- [ ] File validation enforces 10MB and 10,000 row limits
- [ ] Parsing and upload are decoupled (queue rows locally, upload independently)

---

### WS6: Unit & Integration Tests

**Executor**: `backend-service-builder`
**Purpose**: Comprehensive test coverage for schemas, mappers, column mapping, CSV sanitization, and HTTP contracts.

**Deliverables:**

| Test File | Coverage Target | Key Scenarios |
|-----------|----------------|---------------|
| `schemas.test.ts` | All schema variants | Valid/invalid `ImportPlayerV1` (identifier permutations), batch/row schemas, size limits |
| `mappers.test.ts` | 100% | All mappers with null/optional field handling |
| `column-mapping.test.ts` | All aliases | Auto-detect for email, phone, first_name, last_name, dob, external_id, notes variants |
| `csv-sanitization.test.ts` | All trigger chars | `=`, `+`, `-`, `@` get tab-prefixed; normal/empty strings unchanged |
| `http-contract.test.ts` | All endpoints | Happy path + error cases per endpoint, idempotency enforcement, 403 for unauthorized roles |
| `rls-policies.int.test.ts` | Casino isolation + role enforcement | Cross-casino SELECT denied, dealer/cashier INSERT denied, actor binding enforced, DELETE denied |
| `execute-rpc.int.test.ts` | All execute outcomes | 0-match=create, 1-match=link (no player update), N-match=conflict, idempotent re-execute returns same report, concurrent execute blocks |

**Key Test Scenarios:**

**Schema Tests:**
- `importPlayerV1Schema`: valid with email only, phone only, both; invalid with no identifiers, bad email
- `stageRowsSchema`: valid array, invalid > 2000 rows, empty array
- `createBatchSchema`: valid with idempotency_key, missing key rejected

**RLS Policy Integration Tests:**
- Casino A admin cannot SELECT/INSERT import_batch belonging to Casino B
- Dealer role cannot INSERT into import_batch or import_row
- Cashier role cannot INSERT into import_batch or import_row
- Actor binding: INSERT with mismatched `created_by_staff_id` rejected
- DELETE denied on both tables (even for admin)

**Execute RPC Integration Tests:**
- 0 matches: creates new player + player_casino enrollment, row status = `created`
- 1 match (email): links to existing player, sets `matched_player_id`, row status = `linked`, NO updates to existing player fields
- N matches: row status = `conflict`, no production writes, reason_detail includes match count
- Idempotent re-execute: second call returns existing report with `completed` status
- Concurrent execute: second caller blocks, then returns existing report (not double-process)
- Case-insensitive email: `FOO@BAR.COM` matches existing `foo@bar.com`
- Server-side batch limit: staging > 10,000 total rows raises `IMPORT_SIZE_LIMIT_EXCEEDED`

**HTTP Contract Tests:**
- POST `/batches`: 200 success, 409 idempotency conflict
- POST `/batches/:id/rows`: 200 success, 409 batch not staging, 413 size limit, 422 validation
- POST `/batches/:id/execute`: 200 success, 409 already executing
- All POST: 400 missing `Idempotency-Key`
- GET endpoints: 200 with correct response shape, 404 not found

**Acceptance Criteria:**
- [ ] `npm test services/player-import/` — all tests pass
- [ ] Coverage >= 80% for service layer modules
- [ ] Coverage 100% for `mappers.ts`
- [ ] No `as any` in test files
- [ ] `DomainError` assertions for error paths

---

### WS7: E2E Tests

**Executor**: `e2e-testing`
**Purpose**: Playwright happy-path wizard flow with isolated test data.

**Deliverables:**

| File | Purpose |
|------|---------|
| `e2e/workflows/csv-player-import.spec.ts` | Wizard flow tests (happy path, manual mapping, validation warnings) |
| `e2e/fixtures/import-test-data.ts` | Test scenario factory: casino + admin staff + auth token + cleanup |
| `e2e/fixtures/sample-csvs/valid-players.csv` | 5 rows with standard headers |
| `e2e/fixtures/sample-csvs/unknown-headers.csv` | 5 rows with non-standard headers (e-mail, Phone Number, fname) |
| `e2e/fixtures/sample-csvs/missing-identifiers.csv` | 3 valid rows + 2 rows missing both email and phone |

**Test Scenarios:**

1. **Happy Path**: Upload `valid-players.csv` → auto-detect maps columns → preview shows 5 rows → stage → execute → report shows 5 created
2. **Manual Mapping**: Upload `unknown-headers.csv` → unmapped columns shown → manually map via dropdowns → complete flow
3. **Validation Warnings**: Upload `missing-identifiers.csv` → preview shows warnings for 2 rows → staged rows reflect validation errors

**Acceptance Criteria:**
- [ ] `npx playwright test e2e/workflows/csv-player-import.spec.ts` — all tests pass
- [ ] Happy-path test covers full wizard flow (PRD DoD requirement)
- [ ] Test data isolated with per-test cleanup
- [ ] No hard waits (Playwright auto-waiting only)
- [ ] File upload via `page.setInputFiles()`

---

## Definition of Done

**Functionality:**
- [ ] Staff can upload a vendor CSV, map columns, stage rows, execute merge, and view report end-to-end
- [ ] Auto-detect correctly maps common header patterns (email, phone, first_name, last_name, dob)
- [ ] Rows without identifiers are rejected at staging with clear reason codes
- [ ] Conflict rows (N matches) produce conflict status with no production writes
- [ ] Idempotent re-execution returns the same completed report

**Data & Integrity:**
- [ ] `import_batch` and `import_row` tables created with correct constraints
- [ ] Production writes only via SECURITY DEFINER RPCs — no direct INSERT to `player` or `player_casino`
- [ ] Batch status machine prevents double-execution

**Security & Access:**
- [ ] RLS enabled on `import_batch` and `import_row` with casino-scoped policies
- [ ] INSERT/UPDATE restricted to `admin` and `pit_boss` roles
- [ ] DELETE denied on both staging tables
- [ ] Actor attribution (`created_by_staff_id`) enforced via `app.actor_id`
- [ ] CSV export sanitizes formula-injection characters (OWASP tab-prefix)
- [ ] All SECURITY DEFINER RPCs set explicit `search_path` (empty, schema-qualified references)

**Testing:**
- [ ] Unit tests for `ImportPlayerV1` Zod schema validation
- [ ] Unit tests for column mapping auto-detect heuristics
- [ ] Integration test for execute RPC: create, link, skip, conflict outcomes
- [ ] At least one happy-path E2E test: upload → map → stage → execute → report

**Gates:**
- [ ] `npm run db:types-local` exits 0 (schema-validation)
- [ ] `npm run type-check` exits 0
- [ ] `npm run lint` exits 0
- [ ] `npm test services/player-import/` — all tests pass
- [ ] `npm run build` exits 0

**Documentation:**
- [ ] SRM updated to v4.15.0 with PlayerImportService
- [ ] Service README.md documents bounded context, ownership, dependencies

---

## Appendix: Canonical Contract Reference

```typescript
// ImportPlayerV1 — canonical import payload (ADR-036 D2)
interface ImportPlayerV1 {
  contract_version: "v1";
  source: { vendor?: string; file_name?: string };
  row_ref: { row_number: number };
  identifiers: { email?: string; phone?: string; external_id?: string };
  profile: { first_name?: string; last_name?: string; dob?: string | null };
  notes?: string;
}
// Rule: at least one of identifiers.email or identifiers.phone must be present
```

## Appendix: Error Codes

| Code | HTTP | Description |
|------|------|-------------|
| `IMPORT_BATCH_NOT_FOUND` | 404 | Batch ID not found or not visible to caller |
| `IMPORT_BATCH_NOT_STAGING` | 409 | Batch not in `staging` status |
| `IMPORT_BATCH_ALREADY_EXECUTING` | 409 | Batch currently executing |
| `IMPORT_ROW_NO_IDENTIFIER` | 422 | Row lacks any identifier (email or phone) |
| `IMPORT_ROW_VALIDATION_FAILED` | 422 | Row fails schema validation |
| `IMPORT_IDEMPOTENCY_CONFLICT` | 409 | Idempotency key already used for different batch |
| `IMPORT_SIZE_LIMIT_EXCEEDED` | 413 | File or row count exceeds limits |

## Appendix: Column Mapping Alias Dictionary

| Canonical Field | Aliases |
|----------------|---------|
| `email` | `e-mail`, `email_address`, `player_email`, `Email Address` |
| `phone` | `phone_number`, `mobile`, `cell`, `telephone`, `Phone Number` |
| `first_name` | `first`, `fname`, `given_name`, `First Name` |
| `last_name` | `last`, `lname`, `surname`, `family_name`, `Last Name` |
| `dob` | `date_of_birth`, `birthday`, `birth_date`, `DOB`, `Date of Birth` |
| `external_id` | `player_id`, `member_id`, `patron_id`, `Player ID` |
| `notes` | `comment`, `comments`, `note`, `remarks` |
