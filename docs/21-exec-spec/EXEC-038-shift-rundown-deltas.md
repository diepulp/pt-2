---
# EXECUTION-SPEC Frontmatter
# Generated by feature-pipeline skill (Phase 5: EXEC-SPEC + DoD)

prd: PRD-038
prd_title: "Shift Rundown Persistence & Mid-Shift Delta Checkpoints"
service: TableContextService
mvp_phase: 2  # Phase 2 (Table Operations)

workstreams:
  WS1:
    name: Schema & RPCs
    description: "New tables (table_rundown_report, shift_checkpoint), new RPCs (rpc_persist_table_rundown, rpc_finalize_rundown, rpc_create_shift_checkpoint), modified RPCs (rpc_request_table_fill, rpc_request_table_credit for session totals + session_id linkage, rpc_close_table_session for inline persistence), RLS policies, privilege posture, type regeneration"
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/YYYYMMDDHHMMSS_prd038_rundown_persistence_schema.sql
      - supabase/migrations/YYYYMMDDHHMMSS_prd038_rundown_rls.sql
      - supabase/migrations/YYYYMMDDHHMMSS_prd038_modify_fill_credit_rpcs.sql
      - supabase/migrations/YYYYMMDDHHMMSS_prd038_rundown_rpcs.sql
      - supabase/migrations/YYYYMMDDHHMMSS_prd038_checkpoint_rpc.sql
      - supabase/migrations/YYYYMMDDHHMMSS_prd038_close_session_inline_persist.sql
      - docs/20-architecture/SERVICE_RESPONSIBILITY_MATRIX.md
      - types/database.types.ts
    gate: schema-validation
    estimated_complexity: high

  WS2:
    name: Service Layer
    description: "DTOs, Zod schemas, React Query keys, mappers, CRUD functions, HTTP fetchers for rundown reports and shift checkpoints — extends TableContextService"
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - services/table-context/rundown-report/dtos.ts
      - services/table-context/rundown-report/schemas.ts
      - services/table-context/rundown-report/keys.ts
      - services/table-context/rundown-report/mappers.ts
      - services/table-context/rundown-report/crud.ts
      - services/table-context/rundown-report/http.ts
      - services/table-context/shift-checkpoint/dtos.ts
      - services/table-context/shift-checkpoint/schemas.ts
      - services/table-context/shift-checkpoint/keys.ts
      - services/table-context/shift-checkpoint/mappers.ts
      - services/table-context/shift-checkpoint/crud.ts
      - services/table-context/shift-checkpoint/http.ts
      - services/table-context/index.ts
    gate: type-check
    estimated_complexity: medium

  WS3:
    name: API Routes
    description: "8 API endpoints for rundown report CRUD/finalization and shift checkpoint CRUD/delta under /api/v1/"
    executor: api-builder
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - app/api/v1/table-rundown-reports/route.ts
      - app/api/v1/table-rundown-reports/[id]/route.ts
      - app/api/v1/table-rundown-reports/[id]/finalize/route.ts
      - app/api/v1/shift-checkpoints/route.ts
      - app/api/v1/shift-checkpoints/latest/route.ts
      - app/api/v1/shift-checkpoints/delta/route.ts
    gate: lint
    estimated_complexity: medium

  WS4:
    name: React Hooks
    description: "TanStack Query hooks for rundown persistence, finalization, checkpoint mutations, and delta-aware shift metrics"
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS3]
    outputs:
      - hooks/table-context/use-persist-rundown.ts
      - hooks/table-context/use-finalize-rundown.ts
      - hooks/table-context/use-rundown-report.ts
      - hooks/table-context/use-rundowns-by-day.ts
      - hooks/table-context/use-create-checkpoint.ts
      - hooks/table-context/use-latest-checkpoint.ts
      - hooks/table-context/use-checkpoint-delta.ts
    gate: type-check
    estimated_complexity: low

  WS5:
    name: UI Integration
    description: "RundownSummaryPanel (Save Report + Finalized badge), Checkpoint button in shift dashboard, casino-scope delta badge in HeroWinLossCompact, late-event warning badge, formatCents(null) fix"
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS4]
    outputs:
      - components/table/rundown-report-card.tsx
      - components/table/finalize-rundown-button.tsx
      - components/shift-dashboard/checkpoint-button.tsx
      - components/shift-dashboard/delta-badge.tsx
      - components/shift-dashboard/late-event-badge.tsx
      - lib/format.ts
    gate: type-check
    estimated_complexity: medium

  WS6:
    name: Unit & Integration Tests
    description: "RPC tests (reconciliation, finalization, session linkage, concurrent fills, cross-casino isolation), service layer tests (mappers, schemas), HTTP contract tests"
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS2, WS3]
    outputs:
      - services/table-context/__tests__/rundown-report-schemas.test.ts
      - services/table-context/__tests__/rundown-report-mappers.test.ts
      - services/table-context/__tests__/shift-checkpoint-schemas.test.ts
      - services/table-context/__tests__/shift-checkpoint-mappers.test.ts
      - services/table-context/__tests__/rundown-report-http.test.ts
      - services/table-context/__tests__/shift-checkpoint-http.test.ts
    gate: test-pass
    estimated_complexity: medium

execution_phases:
  - name: "Phase 1 -- Foundation (Schema + RPCs)"
    parallel: [WS1]
    gates: [schema-validation]

  - name: "Phase 2 -- Service Layer"
    parallel: [WS2]
    gates: [type-check]

  - name: "Phase 3 -- API Routes + Tests"
    parallel: [WS3, WS6]
    gates: [lint, test-pass]

  - name: "Phase 4 -- Frontend (Hooks + UI)"
    parallel: [WS4, WS5]
    gates: [type-check]

  - name: "Phase 5 -- Final Build"
    parallel: []
    gates: [build]

gates:
  schema-validation:
    command: "npm run db:types-local"
    success_criteria: "Exit code 0, types regenerated successfully"

  type-check:
    command: "npm run type-check"
    success_criteria: "Exit code 0, no type errors"

  lint:
    command: "npm run lint"
    success_criteria: "Exit code 0"

  test-pass:
    command: "npm test services/table-context/"
    success_criteria: "All tests pass, 100% mappers coverage"

  build:
    command: "npm run build"
    success_criteria: "Exit code 0, no build errors"

external_dependencies:
  - prd: ADR-027
    service: TableContextService
    required_for: "rpc_compute_table_rundown ephemeral computation (wrapping with persistence)"
  - prd: ADR-024
    service: CasinoService
    required_for: "set_rls_context_from_staff() for all new RPCs"
  - prd: ADR-028
    service: TableContextService
    required_for: "Session lifecycle states (OPEN/ACTIVE/RUNDOWN/CLOSED)"
  - prd: PRD-036
    service: TableContextService
    required_for: "rpc_shift_table_metrics for checkpoint metric snapshots"

risks:
  - risk: "Modifying rpc_request_table_fill / rpc_request_table_credit adds side-effects — regression risk on existing chip custody flow"
    mitigation: "Reconciliation test (session totals == SUM raw events); existing fill/credit tests must still pass"
  - risk: "rpc_close_table_session inline persistence adds latency to close flow"
    mitigation: "Single CTE query + INSERT — measure and validate overhead in WS1; no hard NFR imposed"
  - risk: "Concurrent fill + close race condition on session totals"
    mitigation: "Atomic col = col + amount inside RPC transaction; rundown computes from totals at close time"
  - risk: "Gating bugs (GB-1 through GB-5) may not be fully resolved — blocks accurate rundown persistence"
    mitigation: "Gating bugs are Phase 1 prerequisites; WS1 migration must fix GB-2, GB-3; WS5 fixes GB-4"

npm_dependencies: []
---

# EXECUTION-SPEC: PRD-038 --- Shift Rundown Persistence & Mid-Shift Delta Checkpoints

## Overview

When a table session closes, the system computes the rundown (win/loss, fills, credits, drop) but discards the result. This EXECUTION-SPEC delivers: (A) automatic rundown persistence at session close with UPSERT mutability and supervisor finalization, and (B) mid-shift delta checkpoints for "what changed since I last looked" on the shift dashboard. Both capabilities are owned by TableContextService.

**Bounded Context**: TableContextService (EXISTING -- SRM update to register new tables)
**New Tables**: `table_rundown_report`, `shift_checkpoint`
**Modified RPCs**: `rpc_request_table_fill`, `rpc_request_table_credit`, `rpc_close_table_session`
**New RPCs**: `rpc_persist_table_rundown`, `rpc_finalize_rundown`, `rpc_create_shift_checkpoint`

## Scope

**In Scope:**
- `table_rundown_report` table with UPSERT contract (ABSENT -> DRAFT -> FINALIZED lifecycle)
- `shift_checkpoint` table (INSERT-only, immutable snapshots)
- Session totals denormalization (`fills_total_cents`, `credits_total_cents` updated atomically in fill/credit RPCs)
- `session_id` FK linkage on `table_fill` and `table_credit` rows
- Inline rundown persistence inside `rpc_close_table_session` (same transaction)
- Manual pre-close "Save Report" path via `rpc_persist_table_rundown`
- Supervisor finalization via `rpc_finalize_rundown` (role-gated, session-closed prerequisite)
- Late-event handling: `has_late_events` flag + `audit_log` entry
- Casino-scoped RLS (Pattern C hybrid) on both new tables
- Privilege posture: REVOKE UPDATE/DELETE from authenticated, INSERT/UPDATE only via GRANT EXECUTE on RPCs
- Casino-scope delta computation (current metrics minus last checkpoint)

**Out of Scope:**
- Per-table / per-pit checkpoint rows and delta UI (schema forward-compatible; MVP is casino-scope only -- vNext)
- Soft count evidence manifest
- Reconciliation exception framework
- RECONCILED/FINALIZED session lifecycle states
- Auto-scheduled checkpoints
- Cross-shift comparison views
- Unfinalize workflow
- Checkpoint retention/TTL policies
- Late-event structured exception records

## Architecture Context

| Reference | Purpose |
|-----------|---------|
| ADR-038 | Rundown persistence finalization contract -- D1 (session totals), D2 (UPSERT), D3 (finalization) |
| ADR-027 | Rundown formula, par columns, table_bank_mode, session totals schema |
| ADR-024 | Authoritative context derivation (`set_rls_context_from_staff()`) |
| ADR-028 | Session lifecycle states (OPEN/ACTIVE/RUNDOWN/CLOSED) |
| ADR-018 | SECURITY DEFINER governance |
| ADR-015 | Pattern C hybrid RLS |
| SEC-NOTE | `docs/30-security/SEC-NOTE-SHIFT-RUNDOWN-DELTAS.md` |
| SRM | `docs/20-architecture/SERVICE_RESPONSIBILITY_MATRIX.md` |

**Pinned Dependency: `set_rls_context_from_staff()`**
- All new RPCs MUST call this as first statement
- Derives `app.actor_id`, `app.casino_id`, `app.staff_role` from JWT
- Actor values are NEVER accepted as parameters (ADR-024 INV-8)

**Pinned Dependency: `unique_active_session_per_table` partial unique index**
- `CREATE UNIQUE INDEX ON table_session (casino_id, gaming_table_id) WHERE status IN ('OPEN','ACTIVE','RUNDOWN')`
- Fill/credit RPCs use `INTO STRICT` to resolve session -- fail loud on invariant violation
- Tests MUST verify the index by **predicate and columns**, not just name

**Pinned Dependency: `rpc_shift_table_metrics` determinism for historical windows**
- Signature: `rpc_shift_table_metrics(p_window_start timestamptz, p_window_end timestamptz)`
- Source: `20260114004336_rpc_shift_table_metrics.sql`
- Accepts arbitrary `timestamptz` parameters (not hard-coded to "current shift")
- All source tables are append-only (`table_fill`, `table_credit`, `table_inventory_snapshot`, `table_drop_event`, `table_buyin_telemetry`) — no UPDATE/DELETE semantics exist on these tables
- Given the same `(window_start, window_end)`, the RPC produces identical results (deterministic for past windows)
- **Constraint:** If any source table gains UPDATE or DELETE semantics in a future migration, per-table delta determinism must be revalidated and the DoD determinism test becomes a blocking gate
- **DoD gate (WS6):** Test must call `rpc_shift_table_metrics(window_start, checkpoint.window_end)` and verify result matches stored checkpoint metrics

### Role Gate Contract

**Canonical source of truth:** `public.staff_role` enum (`"dealer" | "pit_boss" | "cashier" | "admin"`)

Role literals in SQL RPCs MUST match the canonical `public.staff_role` enum values exactly. The enum is the authority; if it evolves, all role gates in this feature MUST be updated to match.

**Write-authorized roles (MVP):** `'pit_boss'`, `'admin'`
**Read-authorized roles:** All `authenticated` staff (via RLS Pattern C)

**Invariant:** If `public.staff_role` gains new values, the role gate defaults to deny (new roles are NOT automatically authorized). Gate drift is a security regression.

### Gaming Day Derivation Rules

| Context | Derivation | Source |
|---------|-----------|--------|
| `table_rundown_report.gaming_day` | `compute_gaming_day(table_session.opened_at, casino_settings)` | Session start determines gaming day |
| `shift_checkpoint.gaming_day` | `compute_gaming_day(now(), casino_settings)` | Capture time determines gaming day |

Both use `casino_settings.timezone` + `casino_settings.gaming_day_start` via the `compute_gaming_day` contract. Never client-supplied.

### Null Semantics Contract (Per-Field)

| Field | NULL means | UI rendering |
|-------|-----------|-------------|
| `table_win_cents` | Drop not posted (count unavailable) | "---" + tooltip "Drop not posted" |
| `opening_bankroll_cents` | No opening snapshot available | "---" + tooltip "No opening count" |
| `closing_bankroll_cents` | No closing snapshot available | "---" + tooltip "No closing count" |
| `drop_total_cents` | Drop count not posted | "---" |
| `par_target_cents` | No par target configured | "---" |
| `variance_from_par_cents` | Cannot compute (par or win is NULL) | "---" |
| `win_loss_cents` (checkpoint) | No tables have coverage | "---" |
| `drop_total_cents` (checkpoint) | No drop events in window | "---" |
| Delta fields | No prior checkpoint exists | NULL (not zero) -- render "---" |

**Rule:** NULL always means "unknown/unavailable", never "zero". `formatCents(null)` MUST return `"---"`. Zero is rendered as `"$0"`.

---

## Workstream Details

### WS1: Schema & RPCs

**Executor**: `backend-service-builder`
**Purpose**: Database foundation -- new tables, RLS, privilege posture, modified RPCs, new RPCs, SRM registration.

**Deliverables:**

#### 1. SRM Update

Register new tables in TableContextService ownership (SRM version bump):
- `table_rundown_report` -- owned by TableContextService
- `shift_checkpoint` -- owned by TableContextService

#### 2. Migration: New Tables

**`table_rundown_report`:**

```sql
CREATE TABLE table_rundown_report (
  id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  casino_id               UUID NOT NULL REFERENCES casino(id),
  table_session_id        UUID NOT NULL REFERENCES table_session(id),
  gaming_table_id         UUID NOT NULL REFERENCES gaming_table(id),
  gaming_day              DATE NOT NULL,

  -- Snapshot references
  opening_snapshot_id     UUID REFERENCES table_inventory_snapshot(id),
  closing_snapshot_id     UUID REFERENCES table_inventory_snapshot(id),
  drop_event_id           UUID REFERENCES table_drop_event(id),

  -- Computed values
  opening_bankroll_cents  INTEGER,
  closing_bankroll_cents  INTEGER,
  fills_total_cents       INTEGER NOT NULL DEFAULT 0,
  credits_total_cents     INTEGER NOT NULL DEFAULT 0,
  drop_total_cents        INTEGER,
  table_win_cents         INTEGER,           -- NULL when drop not posted

  -- Provenance
  opening_source          TEXT NOT NULL,
  computation_grade       TEXT NOT NULL DEFAULT 'ESTIMATE',

  -- Variance
  par_target_cents        INTEGER,
  variance_from_par_cents INTEGER,

  -- Late events
  has_late_events         BOOLEAN NOT NULL DEFAULT false,

  -- Metadata
  computed_by             UUID REFERENCES staff(id),
  computed_at             TIMESTAMPTZ NOT NULL DEFAULT now(),
  finalized_at            TIMESTAMPTZ,
  finalized_by            UUID REFERENCES staff(id),
  notes                   TEXT,

  created_at              TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE UNIQUE INDEX uq_rundown_report_session
  ON table_rundown_report (table_session_id);

CREATE INDEX idx_rundown_report_gaming_day
  ON table_rundown_report (casino_id, gaming_day);
```

**`shift_checkpoint`:**

```sql
CREATE TABLE shift_checkpoint (
  id                        UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  casino_id                 UUID NOT NULL REFERENCES casino(id),
  gaming_day                DATE NOT NULL,

  checkpoint_scope          TEXT NOT NULL DEFAULT 'casino'
                            CHECK (checkpoint_scope IN ('casino', 'pit', 'table')),
  gaming_table_id           UUID REFERENCES gaming_table(id),  -- MVP: always NULL (pit/table scope deferred)
  pit_id                    UUID,  -- MVP: MUST be NULL. Pit entity does not exist as a first-class table;
                            --   pit_id on gaming_table is a text label, not a UUID FK.
                            --   Column reserved for vNext when Pit model is formalized.
                            --   No FK constraint — will be added when pit table is created.

  checkpoint_type           TEXT NOT NULL
                            CHECK (checkpoint_type IN ('mid_shift', 'end_of_shift', 'handoff')),

  window_start              TIMESTAMPTZ NOT NULL,
  window_end                TIMESTAMPTZ NOT NULL,

  -- Metric snapshot
  win_loss_cents            INTEGER,
  fills_total_cents         INTEGER NOT NULL DEFAULT 0,
  credits_total_cents       INTEGER NOT NULL DEFAULT 0,
  drop_total_cents          INTEGER,
  tables_active             INTEGER NOT NULL DEFAULT 0,
  tables_with_coverage      INTEGER NOT NULL DEFAULT 0,

  -- Buy-in telemetry snapshot
  rated_buyin_cents         INTEGER NOT NULL DEFAULT 0,
  grind_buyin_cents         INTEGER NOT NULL DEFAULT 0,

  -- Cash observation snapshot
  cash_out_observed_cents   INTEGER NOT NULL DEFAULT 0,

  -- Metadata
  created_by                UUID REFERENCES staff(id),
  created_at                TIMESTAMPTZ NOT NULL DEFAULT now(),
  notes                     TEXT
);

CREATE INDEX idx_shift_checkpoint_latest
  ON shift_checkpoint (casino_id, checkpoint_scope, created_at DESC);

-- idx_shift_checkpoint_pit DEFERRED to vNext (pit_id always NULL in MVP)
-- CREATE INDEX idx_shift_checkpoint_pit
--   ON shift_checkpoint (casino_id, pit_id, created_at DESC)
--   WHERE pit_id IS NOT NULL;
```

> **MVP constraint:** `checkpoint_scope` is always `'casino'` in MVP. `pit_id` and `gaming_table_id` are always NULL. The schema allows `'pit'` and `'table'` scopes for forward-compatibility, but the UI, RPC, and service layer only produce/consume `'casino'` scope. Per-pit and per-table checkpoint *rows* are deferred until Pit is a first-class entity.

#### 3. Migration: RLS Policies

**`table_rundown_report` RLS:**

| Policy | Operation | Pattern |
|--------|-----------|---------|
| `rundown_report_select` | SELECT | Pattern C hybrid: `casino_id = COALESCE(session_var, JWT)` |

**`shift_checkpoint` RLS:**

| Policy | Operation | Pattern |
|--------|-----------|---------|
| `shift_checkpoint_select` | SELECT | Pattern C hybrid: `casino_id = COALESCE(session_var, JWT)` |

> **Write denial is privilege-based, not RLS-based.** `authenticated` has no INSERT/UPDATE/DELETE privileges on either table (`REVOKE ALL` + `GRANT SELECT` only). Writes occur exclusively through `GRANT EXECUTE` on SECURITY DEFINER RPCs. RLS provides casino-scoped SELECT filtering. This is a two-layer defense: privileges deny unauthorized operations, RLS scopes authorized reads.

**Privilege Posture:**

```sql
-- table_rundown_report
REVOKE ALL ON table_rundown_report FROM authenticated;
GRANT SELECT ON table_rundown_report TO authenticated;

-- shift_checkpoint
REVOKE ALL ON shift_checkpoint FROM authenticated;
GRANT SELECT ON shift_checkpoint TO authenticated;
```

#### 4. Migration: Modify Fill/Credit RPCs (ADR-038 D1)

Modify `rpc_request_table_fill`:
1. Resolve session via `INTO STRICT` from `unique_active_session_per_table` index
2. Write `session_id` FK onto `table_fill` row
3. Atomic increment: `UPDATE table_session SET fills_total_cents = COALESCE(fills_total_cents, 0) + p_amount_cents WHERE id = v_session_id`

Modify `rpc_request_table_credit`:
1. Same pattern: resolve session, write `session_id`, atomic increment `credits_total_cents`

**Prerequisite check:** Verify `session_id` column exists on `table_fill` and `table_credit`. If not, add via ALTER TABLE + backfill.

#### 5. Migration: New RPCs

**`rpc_persist_table_rundown(p_table_session_id UUID)`:**
- SECURITY DEFINER, `SET search_path = ''`
- Calls `PERFORM public.set_rls_context_from_staff()`
- Role gate: `pit_boss`, `admin`
- Checks finalization: if existing row has `finalized_at IS NOT NULL`, RAISE `TBLRUN_ALREADY_FINALIZED`
- Computes rundown via existing `rpc_compute_table_rundown` logic (CTE)
- Derives `gaming_day` from `table_session.opened_at` using `compute_gaming_day` contract
- UPSERT keyed on `(table_session_id)`: INSERT on first call, UPDATE all fields on subsequent
- Sets `computed_at = now()`, `computed_by = current_setting('app.actor_id')::uuid`
- Returns the persisted row

**`rpc_finalize_rundown(p_report_id UUID)`:**
- SECURITY DEFINER, `SET search_path = ''`
- Calls `PERFORM public.set_rls_context_from_staff()`
- Role gate: `pit_boss`, `admin`
- Verify report exists: RAISE `TBLRUN_NOT_FOUND` if missing
- Verify `table_session.status = 'CLOSED'`: RAISE `TBLRUN_SESSION_NOT_CLOSED` if not
- Verify `finalized_at IS NULL`: RAISE `TBLRUN_ALREADY_FINALIZED` if already finalized
- Stamp `finalized_at = now()`, `finalized_by = current_setting('app.actor_id')::uuid`
- Returns the finalized row

**`rpc_create_shift_checkpoint(p_checkpoint_type TEXT, p_notes TEXT DEFAULT NULL)`:**
- SECURITY DEFINER, `SET search_path = ''`
- Calls `PERFORM public.set_rls_context_from_staff()`
- Role gate: `pit_boss`, `admin`
- MVP: hardcodes `checkpoint_scope = 'casino'`, `pit_id = NULL`, `gaming_table_id = NULL`
- Derives `gaming_day` server-side via `compute_gaming_day(now(), casino_settings)`
- Computes `window_start` = gaming day start boundary, `window_end` = `now()`
- Calls `rpc_shift_table_metrics(window_start, window_end)` internally to get metric snapshot
- Inserts `shift_checkpoint` row with computed metrics
- Returns the created checkpoint

#### 6. Migration: Modify rpc_close_table_session

Add inline call to `rpc_persist_table_rundown` (or equivalent CTE logic) within the same transaction body. The close RPC already transitions session to CLOSED; the persistence happens after status update, before RETURN.

If a report already exists (manual pre-close persist), the UPSERT updates it with final values.

#### 7. Late-Event Detection

Modify `rpc_request_table_fill` and `rpc_request_table_credit` to check if the session's rundown report is already finalized:
- If finalized: set `has_late_events = true` on the report (monotonic `false -> true` only)
- Insert `audit_log` entry with event type `LATE_EVENT_AFTER_FINALIZATION`
- Do NOT block the fill/credit -- the raw event is still recorded

**RPC Security (all new RPCs):**
- SECURITY DEFINER, `SET search_path = ''`
- First statement: `PERFORM public.set_rls_context_from_staff()`
- Derive context from session vars, NEVER from parameters
- Role gate: `current_setting('app.staff_role') IN ('pit_boss', 'admin')` -- literals match canonical `public.staff_role` enum (see Role Gate Contract above). If enum evolves, update gate.
- GRANT: `REVOKE ALL ON FUNCTION rpc_* FROM PUBLIC; GRANT EXECUTE ON FUNCTION rpc_* TO authenticated`

**Acceptance Criteria:**
- [ ] `npm run db:types-local` exits 0
- [ ] SRM updated with `table_rundown_report` and `shift_checkpoint` in TableContextService
- [ ] All new RPCs call `set_rls_context_from_staff()` before data access
- [ ] All new RPCs have no `casino_id`/`actor_id` parameters
- [ ] UNIQUE constraint: `uq_rundown_report_session` on `(table_session_id)`
- [ ] Pattern C hybrid RLS SELECT on both tables
- [ ] Privileges deny writes (`REVOKE ALL` + `GRANT SELECT`); RLS scopes reads (Pattern C SELECT only)
- [ ] `REVOKE UPDATE, DELETE` on both tables from `authenticated`
- [ ] Fill/credit RPCs: `INTO STRICT` session resolution, `session_id` FK written, atomic totals increment
- [ ] `rpc_persist_table_rundown`: UPSERT contract (INSERT new, UPDATE existing if not finalized, REJECT if finalized)
- [ ] `rpc_finalize_rundown`: session CLOSED prerequisite, role gate, irreversible stamp
- [ ] `rpc_create_shift_checkpoint`: server-derived `gaming_day`, `window_start`/`window_end`, internal metrics call
- [ ] `rpc_close_table_session`: inline persistence in same transaction
- [ ] Late-event detection: `has_late_events` flag flip + audit_log entry
- [ ] `GRANT EXECUTE` + `REVOKE ALL FROM PUBLIC` on all new RPCs
- [ ] Migration ends with `NOTIFY pgrst, 'reload schema'`

---

### WS2: Service Layer

**Executor**: `backend-service-builder`
**Purpose**: Extend TableContextService with rundown report and shift checkpoint service modules.

**Deliverables:**

#### Rundown Report Module (`services/table-context/rundown-report/`)

| File | Purpose |
|------|---------|
| `dtos.ts` | `TableRundownReportDTO`, `TableRundownReportSummaryDTO`, `PersistRundownInput`, `FinalizeRundownInput` |
| `schemas.ts` | Zod schemas for persist input, finalize input, query params (gaming_day, table_id) |
| `keys.ts` | React Query key factory: `rundownReport.bySession(id)`, `rundownReport.byDay(day)`, `rundownReport.byId(id)` |
| `mappers.ts` | `toRundownReportDTO(row)`, `toRundownReportSummaryDTO(row)` |
| `crud.ts` | `persistRundown(sessionId)`, `finalizeRundown(reportId)`, `getBySession(sessionId)`, `getById(id)`, `listByDay(gamingDay)` |
| `http.ts` | HTTP fetchers wrapping CRUD with `ServiceHttpResult` |

**DTO Design:**

```typescript
// Derived from Database['public']['Tables']['table_rundown_report']['Row']
export interface TableRundownReportDTO {
  id: string;
  casino_id: string;
  table_session_id: string;
  gaming_table_id: string;
  gaming_day: string;
  opening_bankroll_cents: number | null;
  closing_bankroll_cents: number | null;
  fills_total_cents: number;
  credits_total_cents: number;
  drop_total_cents: number | null;
  table_win_cents: number | null;
  opening_source: string;
  computation_grade: string;
  par_target_cents: number | null;
  variance_from_par_cents: number | null;
  has_late_events: boolean;
  computed_by: string | null;
  computed_at: string;
  finalized_at: string | null;
  finalized_by: string | null;
  notes: string | null;
  created_at: string;
}
```

#### Shift Checkpoint Module (`services/table-context/shift-checkpoint/`)

| File | Purpose |
|------|---------|
| `dtos.ts` | `ShiftCheckpointDTO`, `ShiftCheckpointDeltaDTO`, `CreateCheckpointInput` |
| `schemas.ts` | Zod schemas for create input, query params |
| `keys.ts` | React Query key factory: `shiftCheckpoint.latest()`, `shiftCheckpoint.delta()`, `shiftCheckpoint.list(day)` |
| `mappers.ts` | `toCheckpointDTO(row)`, `toCheckpointDeltaDTO(current, checkpoint)` |
| `crud.ts` | `createCheckpoint(input)`, `getLatest()`, `computeDelta()`, `listByDay(gamingDay)` |
| `http.ts` | HTTP fetchers wrapping CRUD with `ServiceHttpResult` |

**Delta DTO Design:**

```typescript
export interface ShiftCheckpointDeltaDTO {
  checkpoint: ShiftCheckpointDTO;
  current: {
    win_loss_cents: number | null;
    fills_total_cents: number;
    credits_total_cents: number;
    drop_total_cents: number | null;
    tables_active: number;
    tables_with_coverage: number;
  };
  delta: {
    win_loss_cents: number | null;      // NULL if either side is NULL
    fills_total_cents: number;
    credits_total_cents: number;
    drop_total_cents: number | null;
    tables_active: number;
    tables_with_coverage: number;
  };
  checkpoint_time: string;  // ISO timestamp for "since HH:MM" display
}
```

#### Service Factory Update

Update `services/table-context/index.ts` to expose new modules:
- `rundownReport: { persist, finalize, getBySession, getById, listByDay }`
- `shiftCheckpoint: { create, getLatest, computeDelta, listByDay }`

**Error Mapping Contract (SQL -> TypeScript -> HTTP):**

SQL RPCs raise exceptions using a stable encoding convention:

```sql
RAISE EXCEPTION USING
  ERRCODE = 'P0001',
  MESSAGE = 'TBLRUN_ALREADY_FINALIZED',  -- error code IS the message (no prose)
  DETAIL  = '{"report_id": "..."}';       -- optional structured context
```

**Extraction rule:** The error code is the entire `error.message` string from the Supabase RPC response (not a substring — the message IS the code). The service layer matches `error.message` exactly against the mapping table below. Unrecognized codes fall through to a generic 500.

| SQL Error Code (RAISE EXCEPTION) | TypeScript Constant | HTTP Status | Description |
|----------------------------------|---------------------|-------------|-------------|
| `TBLRUN_ALREADY_FINALIZED` | `TABLE_RUNDOWN_ALREADY_FINALIZED` | 409 Conflict | Report finalized, mutation rejected |
| `TBLRUN_NOT_FOUND` | `TABLE_RUNDOWN_NOT_FOUND` | 404 Not Found | Report not found |
| `TBLRUN_SESSION_NOT_CLOSED` | `TABLE_RUNDOWN_SESSION_NOT_CLOSED` | 400 Bad Request | Cannot finalize: session not CLOSED |
| `NO_DATA_FOUND` (session lookup) | `TABLE_RUNDOWN_SESSION_NOT_FOUND` | 404 Not Found | No active session for this table |
| `TOO_MANY_ROWS` (session lookup) | `TABLE_SESSION_INVARIANT_VIOLATION` | 500 Internal | Unique active session index violated |
| `CHKPT_METRICS_UNAVAILABLE` | `TABLE_CHECKPOINT_METRICS_UNAVAILABLE` | 503 Service Unavailable | Could not compute shift metrics |
| `CHKPT_GAMING_DAY_UNRESOLVABLE` | `TABLE_CHECKPOINT_GAMING_DAY_UNRESOLVABLE` | 500 Internal | Could not derive gaming day |
| `FORBIDDEN` | `FORBIDDEN` | 403 Forbidden | Role lacks authorization |

**Implementation location:** `services/table-context/rundown-report/crud.ts` and `services/table-context/shift-checkpoint/crud.ts` — each CRUD function catches the Supabase RPC error and maps to the appropriate `ServiceHttpResult` error.

**Acceptance Criteria:**
- [ ] DTOs derived from `Database` types using Pick/Omit (no `as any`)
- [ ] Zod schemas validate all inputs
- [ ] Mappers are pure functions with 100% test coverage
- [ ] Key factories produce stable, cache-friendly keys
- [ ] CRUD functions call RPCs via `supabase.rpc()`
- [ ] HTTP fetchers return `ServiceHttpResult<T>`
- [ ] Error codes mapped per the SQL -> TS -> HTTP table above (not ad-hoc)
- [ ] `npm run type-check` exits 0

---

### WS3: API Routes

**Executor**: `api-builder`
**Purpose**: REST endpoints for rundown reports and shift checkpoints.

**Deliverables:**

| Method | Path | Auth | Description |
|--------|------|------|-------------|
| POST | `/api/v1/table-rundown-reports` | pit_boss, admin | Persist rundown report (manual path) |
| GET | `/api/v1/table-rundown-reports` | authenticated | List reports by `gaming_day` + optional `table_id` |
| GET | `/api/v1/table-rundown-reports/[id]` | authenticated | Get report by ID |
| PATCH | `/api/v1/table-rundown-reports/[id]/finalize` | pit_boss, admin | Finalize report |
| POST | `/api/v1/shift-checkpoints` | pit_boss, admin | Create checkpoint |
| GET | `/api/v1/shift-checkpoints/latest` | authenticated | Get latest checkpoint (casino-scope) |
| GET | `/api/v1/shift-checkpoints/delta` | authenticated | Compute delta from latest checkpoint |
| GET | `/api/v1/shift-checkpoints` | authenticated | List checkpoints for gaming day |

**Route Handler Pattern:**
- All route handlers use `ServiceHttpResult` contract
- Request body validated via Zod schemas
- Query params validated and typed
- Auth checked via `createSupabaseRouteClient()` + service layer auth
- No `casino_id` in request bodies -- derived server-side

**Acceptance Criteria:**
- [ ] All routes use `ServiceHttpResult` wrappers
- [ ] Zod validation on all inputs
- [ ] No `casino_id` or `actor_id` accepted in request bodies
- [ ] PATCH finalize returns 409 on already-finalized
- [ ] GET endpoints support query params (`gaming_day`, `table_id`)
- [ ] `npm run lint` exits 0

---

### WS4: React Hooks

**Executor**: `frontend-design-pt-2`
**Purpose**: TanStack Query hooks for all frontend interactions with rundown and checkpoint data.

**Deliverables:**

| File | Hook | Type | Purpose |
|------|------|------|---------|
| `use-persist-rundown.ts` | `usePersistRundown(sessionId)` | Mutation | Persist rundown report |
| `use-finalize-rundown.ts` | `useFinalizeRundown(reportId)` | Mutation | Finalize report |
| `use-rundown-report.ts` | `useRundownReport(sessionId)` | Query | Fetch report by session |
| `use-rundowns-by-day.ts` | `useRundownsByDay(gamingDay)` | Query | List reports by gaming day |
| `use-create-checkpoint.ts` | `useCreateCheckpoint()` | Mutation | Create shift checkpoint |
| `use-latest-checkpoint.ts` | `useLatestCheckpoint()` | Query | Fetch latest checkpoint |
| `use-checkpoint-delta.ts` | `useCheckpointDelta()` | Query | Fetch delta from latest checkpoint |

**Query Key Invalidation:**
- `usePersistRundown` invalidates `rundownReport.bySession(sessionId)` + `rundownReport.byDay(*)`
- `useFinalizeRundown` invalidates `rundownReport.byId(reportId)` + `rundownReport.bySession(*)`
- `useCreateCheckpoint` invalidates `shiftCheckpoint.latest()` + `shiftCheckpoint.delta()` + `shiftCheckpoint.list(*)`

**Acceptance Criteria:**
- [ ] All hooks use key factories from `keys.ts`
- [ ] Mutations invalidate correct cache keys
- [ ] Error states typed and handled
- [ ] `npm run type-check` exits 0

---

### WS5: UI Integration

**Executor**: `frontend-design-pt-2`
**Purpose**: Wire hooks into existing UI components for rundown persistence and checkpoint deltas.

**Deliverables:**

#### 1. `formatCents(null)` Fix (GB-4)

Update `lib/format.ts`:
- `formatCents(null)` -> returns `"---"` (not `"$0"`)
- Verify all callsites -- no regression on valid numbers

#### 2. RundownSummaryPanel Updates

In the existing `RundownSummaryPanel` component:
- Add "Save Report" button (calls `usePersistRundown`) -- visible during RUNDOWN state
- Add "Finalize" button (calls `useFinalizeRundown`) -- visible when session CLOSED and report not finalized
- Add "Finalized" badge -- shown when `finalized_at IS NOT NULL`
- Add "Late activity" warning badge -- shown when `has_late_events = true`

#### 3. Shift Dashboard -- Checkpoint Button

New `CheckpointButton` component in shift dashboard toolbar:
- Calls `useCreateCheckpoint()` mutation
- Shows confirmation toast with checkpoint time
- Disabled during mutation (loading state)

#### 4. Shift Dashboard -- Delta Badge

New `DeltaBadge` component in `HeroWinLossCompact`:
- Consumes `useCheckpointDelta()` query
- Displays "+$X since HH:MM" or "-$X since HH:MM"
- Hidden when no checkpoint exists
- NULL delta renders as "---" (not "$0")

#### 5. MetricsTable -- Per-Table Deltas (vNext)

> **Deferred to vNext.** Per-table and per-pit deltas are not in MVP scope. The deterministic re-query capability exists (`rpc_shift_table_metrics` accepts arbitrary `timestamptz` windows), but the UI and service complexity for per-table delta rendering is deferred. MVP displays casino-scope deltas only (via `DeltaBadge` in hero card).

#### 6. Late-Event Warning Badge

New `LateEventBadge` component:
- Shown on rundown report cards when `has_late_events = true`
- Tooltip: "Activity recorded after this report was finalized"
- Visual: warning icon + amber color

**Acceptance Criteria:**
- [ ] `formatCents(null)` returns `"---"` globally
- [ ] "Save Report" button visible during RUNDOWN, calls persist mutation
- [ ] "Finalize" button visible for CLOSED sessions with unfinalised report
- [ ] "Finalized" badge displayed after finalization
- [ ] Checkpoint button creates checkpoint with toast confirmation
- [ ] Casino-scope delta badge shows correct "+/-$X since HH:MM" values
- [ ] Late-event badge renders when `has_late_events = true`
- [ ] NULL values render as "---" throughout, never "$0"
- [ ] `npm run type-check` exits 0

---

### WS6: Unit & Integration Tests

**Executor**: `backend-service-builder`
**Purpose**: Automated test coverage for all DoD gates.

**Deliverables:**

#### Mapper & Schema Tests

- `rundown-report-schemas.test.ts` -- Zod schema validation for persist/finalize inputs
- `rundown-report-mappers.test.ts` -- Row -> DTO transformation (100% coverage)
- `shift-checkpoint-schemas.test.ts` -- Zod schema validation for checkpoint creation
- `shift-checkpoint-mappers.test.ts` -- Row -> DTO transformation (100% coverage)

#### HTTP Contract Tests

- `rundown-report-http.test.ts` -- ServiceHttpResult contract verification
- `shift-checkpoint-http.test.ts` -- ServiceHttpResult contract verification

#### RPC Integration Tests (to be run against local Supabase)

These are the **mandatory DoD gate tests** from ADR-038:

| Test | Assertion |
|------|-----------|
| Session totals reconciliation | `table_session.fills_total_cents == SUM(table_fill.amount_cents)` by session |
| Session totals reconciliation | `table_session.credits_total_cents == SUM(table_credit.amount_cents)` by session |
| Finalization prerequisite | `rpc_finalize_rundown` requires `table_session.status = 'CLOSED'` |
| Finalization immutability | `rpc_persist_table_rundown` after finalization returns 409 |
| Late-event audit trail | Fill on finalized session emits `audit_log` entry |
| Late-event flag | Fill on finalized session sets `has_late_events = true` |
| Late-event flag irreversibility | `has_late_events` cannot be reset to `false` |
| Session linkage | Every `table_fill`/`table_credit` has non-null `session_id` FK |
| Index invariant (fail loud) | `INTO STRICT` raises `TOO_MANY_ROWS` on index violation |
| Role gate enforcement | `rpc_finalize_rundown` with `dealer` role raises `FORBIDDEN` |
| Cross-casino isolation | Staff from Casino A cannot read Casino B reports/checkpoints |
| Close-session persistence | `rpc_close_table_session` creates `table_rundown_report` row |
| UPSERT contract | Pre-close persist + close = single row, updated values |
| Checkpoint creation | `rpc_create_shift_checkpoint` creates row with correct metrics |
| Checkpoint delta | Delta = current metrics minus checkpoint metrics |
| Delta with no checkpoint | Returns NULL deltas (not zero) |
| Deterministic re-query | `rpc_shift_table_metrics` at checkpoint's `window_end` matches snapshot |

**Acceptance Criteria:**
- [ ] Mapper tests at 100% coverage
- [ ] Schema validation tests for all input types
- [ ] All 17 DoD gate tests enumerated above pass
- [ ] `npm test services/table-context/` exits 0

---

## Data Flow

```
   Fill/Credit Flow (Modified)
   ============================
   Client -> rpc_request_table_fill/credit
     |-> set_rls_context_from_staff()
     |-> Resolve session via unique_active_session_per_table (INTO STRICT)
     |-> INSERT table_fill/credit WITH session_id FK
     |-> UPDATE table_session SET totals += amount (atomic)
     |-> Check if session's report is finalized
     |   |-> If yes: SET has_late_events = true, INSERT audit_log
     |-> RETURN

   Close Session Flow (Modified)
   ==============================
   Client -> rpc_close_table_session
     |-> Transition session to CLOSED
     |-> [INLINE] rpc_persist_table_rundown
     |   |-> Compute rundown (CTE from snapshots, fills, credits, drop)
     |   |-> Derive gaming_day from session.opened_at
     |   |-> UPSERT table_rundown_report
     |-> RETURN

   Manual Persist Flow (New)
   ==========================
   Client -> POST /api/v1/table-rundown-reports
     |-> Service: persistRundown(sessionId)
     |   |-> supabase.rpc('rpc_persist_table_rundown', { session_id })
     |-> RETURN report DTO

   Finalize Flow (New)
   ====================
   Client -> PATCH /api/v1/table-rundown-reports/[id]/finalize
     |-> Service: finalizeRundown(reportId)
     |   |-> supabase.rpc('rpc_finalize_rundown', { report_id })
     |-> RETURN finalized report DTO

   Checkpoint Flow (New)
   ======================
   Client -> POST /api/v1/shift-checkpoints
     |-> Service: createCheckpoint(input)
     |   |-> supabase.rpc('rpc_create_shift_checkpoint', { type, notes })
     |   |   |-> Derive gaming_day, window_start/end
     |   |   |-> Call rpc_shift_table_metrics internally
     |   |   |-> INSERT shift_checkpoint
     |-> RETURN checkpoint DTO

   Delta Flow (New)
   =================
   Client -> GET /api/v1/shift-checkpoints/delta
     |-> Service: computeDelta()
     |   |-> Fetch latest checkpoint
     |   |-> Re-query rpc_shift_table_metrics(window_start, now())
     |   |-> Compute delta: current - checkpoint values
     |-> RETURN ShiftCheckpointDeltaDTO
```

## Security Posture

| Control | Implementation | Reference |
|---------|---------------|-----------|
| Casino isolation | Pattern C hybrid RLS on both tables | SEC-NOTE T1, ADR-015 |
| Finalization immutability | RPC-level guard: `finalized_at IS NOT NULL` check | SEC-NOTE T2, ADR-038 D3 |
| Actor binding | `computed_by`/`finalized_by`/`created_by` from `app.actor_id` | SEC-NOTE T3, ADR-024 |
| Session totals integrity | Atomic `col = col + amount` in RPC transaction | SEC-NOTE T4, ADR-038 D1 |
| Role gating | `app.staff_role IN ('pit_boss','admin')` in all write RPCs | SEC-NOTE T5 |
| Metric anti-injection | `rpc_create_shift_checkpoint` computes metrics internally | SEC-NOTE T6 |
| Gaming day anti-manipulation | Server-derived via `compute_gaming_day`, never client-supplied | SEC-NOTE T7 |
| Privilege posture | `REVOKE UPDATE, DELETE` from authenticated on both tables | ADR-038 |

## Rollout Plan

- [ ] Migrations applied (local + remote)
- [ ] Types regenerated (`npm run db:types-local`)
- [ ] SRM updated (version bump)
- [ ] All DoD gate tests passing
- [ ] `npm run type-check` exits 0
- [ ] `npm run lint` exits 0
- [ ] `npm run build` exits 0
- [ ] Feature brief/investigation status updated

## Known Gaps / Deviations from PRD

| PRD Specification | Implementation | Rationale |
|-------------------|---------------|-----------|
| GB-1: `snapshot.session_id` fix | May require separate migration if invasive | Scoped to WS1 but may need triage |
| GB-2: Chipset JSON parsing | Fixed in WS1 migration | Must be resolved before persist works |
| GB-3: `snapshot.total_cents` | Use `chipset_total_cents()` exclusively | Avoids dual-path ambiguity |
| GB-5: Opening baseline provenance | Depends on PRD-036 progress | May be `ESTIMATE` grade at launch |

## Links

- Feature Boundary: `docs/20-architecture/specs/shift-rundown-deltas/FEATURE_BOUNDARY.md`
- Feature Brief: `docs/20-architecture/specs/shift-rundown-deltas/FEATURE_BRIEF.md`
- ADR: `docs/80-adrs/ADR-038-rundown-persistence-finalization-contract.md`
- PRD: `docs/10-prd/PRD-038-shift-rundown-persistence-deltas-v0.1.md`
- SEC Note: `docs/30-security/SEC-NOTE-SHIFT-RUNDOWN-DELTAS.md`
- Investigation: `docs/issues/gaps/table-inventory-lifecycle/INVESTIGATION-CLOSE-TABLE-SHIFT-DELTAS.md`
