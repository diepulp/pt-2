---
# EXECUTION-SPEC Frontmatter
# Generated by build-pipeline skill (Stage 3: Assemble)
# Source: PRD-038A (Audit + Patch — delta to PRD-038)

prd: PRD-038A
prd_title: "Table Lifecycle Audit Patch"
service: TableContextService
mvp_phase: 2  # Phase 2 (Table Operations)

workstreams:
  WS1:
    name: Schema Additions & RPC Modifications
    description: >
      PRD-038A delta patch: add close_reason_type enum, close guardrail columns
      (has_unresolved_items, requires_reconciliation), attribution columns
      (activated_by, paused_by, resumed_by, rolled_over_by), crossed_gaming_day flag.
      Modify rpc_close_table_session with guardrail + close_reason params.
      New rpc_force_close_table_session for privileged override with audit_log emission.
      Note: rpc_open_table_session is NOT modified — activated_by_staff_id
      remains unpopulated until a future rpc_activate_table_session exists
      (open ≠ activate).
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/YYYYMMDDHHMMSS_prd038a_schema_additions.sql
      - supabase/migrations/YYYYMMDDHHMMSS_prd038a_close_guardrails_rpcs.sql
      - docs/20-architecture/SERVICE_RESPONSIBILITY_MATRIX.md
      - types/database.types.ts
    gate: schema-validation
    estimated_complexity: high

  WS2:
    name: Service Layer Updates
    description: >
      Update DTOs for new columns (close_reason, attribution, reconciliation, crossed_gaming_day).
      Update Zod schemas (close_reason required on close, force-close schema).
      Update CRUD wrappers (closeTableSession passes close_reason, new forceCloseTableSession).
      Update error mapping (UNRESOLVED_LIABILITIES). Update service factory interface.
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - services/table-context/dtos.ts
      - services/table-context/schemas.ts
      - services/table-context/table-session.ts
      - services/table-context/index.ts
    gate: type-check
    estimated_complexity: medium

  WS3:
    name: API Route Updates
    description: >
      Modify existing PATCH /api/v1/table-sessions/[id]/close to require close_reason
      and handle UNRESOLVED_LIABILITIES error (409). New POST /api/v1/table-sessions/[id]/force-close
      endpoint for privileged forced close with audit trail.
    executor: api-builder
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - app/api/v1/table-sessions/[id]/close/route.ts
      - app/api/v1/table-sessions/[id]/force-close/route.ts
    gate: lint
    estimated_complexity: low

  WS4:
    name: Unit & Integration Tests
    description: >
      Close guardrail tests (reject/allow based on has_unresolved_items), force close tests
      (privileged role, requires_reconciliation, audit_log emission, dealer rejection),
      close reason schema validation, mapper tests for new fields.
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS2, WS3]
    outputs:
      - services/table-context/__tests__/close-guardrails.test.ts
      - services/table-context/__tests__/close-reason-schema.test.ts
      - services/table-context/__tests__/session-mapper.test.ts
    gate: test-pass
    estimated_complexity: medium

execution_phases:
  - name: "Phase 1 — Schema Foundation"
    parallel: [WS1]
    gates: [schema-validation, schema-verification]

  - name: "Phase 2 — Service + API"
    parallel: [WS2, WS3]
    gates: [type-check, lint]

  - name: "Phase 3 — Tests"
    parallel: [WS4]
    gates: [test-pass]

gates:
  schema-validation:
    command: "npm run db:types-local"
    success_criteria: "Exit code 0, types regenerated, new columns and enum visible in database.types.ts"

  schema-verification:
    command: "npm run type-check"
    success_criteria: "Exit code 0, all types consistent after schema change"

  type-check:
    command: "npm run type-check"
    success_criteria: "Exit code 0, no type errors"

  lint:
    command: "npm run lint --max-warnings=0"
    success_criteria: "Exit code 0, no errors, no warnings"

  test-pass:
    command: "npm test services/table-context/__tests__/close-guardrails.test.ts services/table-context/__tests__/close-reason-schema.test.ts services/table-context/__tests__/session-mapper.test.ts"
    success_criteria: "All tests pass"

external_dependencies:
  - prd: PRD-038
    service: TableContextService
    required_for: "Existing table_session schema, rpc_close_table_session with inline rundown persistence, table_rundown_report UPSERT"

risks:
  - risk: "rpc_close_table_session signature change (adding close_reason param) may break existing callers"
    mitigation: "New params have defaults (p_close_reason DEFAULT NULL initially during migration, then enforced in service layer). Existing RPC callers continue to work until service layer enforces."
  - risk: "Force close inline rundown logic duplicates close RPC logic"
    mitigation: "Extract shared rundown persistence into a helper function within the same migration file to avoid drift."
  - risk: "Phase A close_reason nullable becomes permanent (no enforcement pressure)"
    mitigation: "Track NULL close_reason rate on closed sessions. Phase B triggers when NULL rate reaches ~0% across production data. No new code required — governance hook only."

---

# EXECUTION-SPEC: PRD-038A — Table Lifecycle Audit Patch

## Overview

PRD-038A is a **delta patch** to PRD-038 (Shift Rundown Persistence & Mid-Shift Delta Checkpoints). This is a **close governance + attribution delta**; pause/resume/rollover RPCs remain deferred. It adds five audit/compliance gaps identified during review:

- **Gap A**: Close guardrails — block close when unresolved liabilities exist, with privileged force-close escape hatch
- **Gap B**: Close reason — capture why a table was closed (enum + note)
- **Gap C**: Actor attribution — record who performed each lifecycle transition
- **Gap D**: Active time semantics — formal definition of active_seconds_in_window (deferred — no pause/resume RPCs yet)
- **Gap E**: Gaming day alignment — crossed_gaming_day flag for rollover provenance

## Scope

**In Scope:**
- `close_reason_type` enum (8 values) and `close_reason`/`close_note` columns on `table_session`
- `has_unresolved_items` and `requires_reconciliation` boolean columns on `table_session`
- Attribution columns: `activated_by_staff_id`, `paused_by_staff_id`, `resumed_by_staff_id`, `rolled_over_by_staff_id`
- `crossed_gaming_day` boolean column on `table_session`
- Close guardrail logic in `rpc_close_table_session` (reject if unresolved)
- New `rpc_force_close_table_session` RPC (privileged, audit_log emission)
- `rpc_open_table_session` is NOT modified (`activated_by_staff_id` deferred until activate RPC exists; `opened_by_staff_id` already set on open)
- Service layer updates (DTOs, schemas, CRUD, factory)
- Force-close API endpoint
- Unit + integration tests

**Out of Scope:**
- Gap D implementation (active_seconds_in_window) — requires pause/resume RPCs which don't exist yet. Formula is *defined* in PRD-038A for future implementation.
- Rollover RPC — `crossed_gaming_day` and `rolled_over_by_staff_id` are forward-compatible columns only.
- Full rim-credit / marker / Finance domain integration — unresolved liabilities modeled as simple boolean placeholder.
- Pause/resume RPCs — `paused_by_staff_id` and `resumed_by_staff_id` are schema-ready columns for future use.
- UI changes — no frontend components in this patch.

## Architecture Context

- **Bounded Context**: TableContextService (SRM v4.16.0)
- **State Machine**: `OPEN → ACTIVE → RUNDOWN → CLOSED` (unchanged — PRD-038A does NOT modify the enum)
- **Existing RPCs**: `rpc_open_table_session`, `rpc_start_table_rundown`, `rpc_close_table_session` (with inline rundown persistence from PRD-038), `rpc_get_current_table_session`
- **Security Model**: ADR-024 (authoritative context derivation), ADR-018 (SECURITY DEFINER governance), ADR-030 (write-path session-var enforcement)
- **audit_log table**: Exists in baseline_srm with columns `(id, casino_id, domain, actor_id, action, details jsonb, created_at)` — used for force-close audit emission

## Workstream Details

### WS1: Schema Additions & RPC Modifications

**Purpose**: Add columns, enum, and guardrail logic to the database layer.

**Migration 1 — Schema Additions** (`YYYYMMDDHHMMSS_prd038a_schema_additions.sql`):

| Change | Column/Type | Details |
|--------|------------|---------|
| New enum | `close_reason_type` | `('end_of_shift','maintenance','game_change','dealer_unavailable','low_demand','security_hold','emergency','other')` |
| New column | `table_session.close_reason` | `close_reason_type NULL` |
| New column | `table_session.close_note` | `text NULL` |
| New column | `table_session.has_unresolved_items` | `boolean NOT NULL DEFAULT false`. **Write ownership: Future Finance/MTL RPCs or `service_role` only. TableContextService reads this column but never writes it (except force-close side effect on `requires_reconciliation`).** |
| New column | `table_session.requires_reconciliation` | `boolean NOT NULL DEFAULT false`. Set to `true` by `rpc_force_close_table_session` only. |
| New column | `table_session.activated_by_staff_id` | `uuid NULL REFERENCES staff(id)` |
| New column | `table_session.paused_by_staff_id` | `uuid NULL REFERENCES staff(id)` |
| New column | `table_session.resumed_by_staff_id` | `uuid NULL REFERENCES staff(id)` |
| New column | `table_session.rolled_over_by_staff_id` | `uuid NULL REFERENCES staff(id)` |
| New column | `table_session.crossed_gaming_day` | `boolean NOT NULL DEFAULT false` |
| Check constraint | — | `close_reason IS DISTINCT FROM 'other' OR length(trim(close_note)) > 0` (rejects NULL, empty, and whitespace-only notes) |

**Migration 2 — RPC Modifications** (`YYYYMMDDHHMMSS_prd038a_close_guardrails_rpcs.sql`):

1. **`rpc_close_table_session`** — Modified (CREATE OR REPLACE):
   - New params: `p_close_reason close_reason_type DEFAULT NULL`, `p_close_note text DEFAULT NULL`
   - Guardrail: Before close UPDATE, check `has_unresolved_items`. If true, raise `'unresolved_liabilities'` (ERRCODE `P0005`)
   - Validation: If `p_close_reason = 'other'` and (`p_close_note IS NULL` or `length(trim(p_close_note)) = 0`), raise `'close_note_required'` (ERRCODE `P0006`)
   - UPDATE SET adds: `close_reason = p_close_reason`, `close_note = p_close_note`
   - **Preserves ALL existing inline rundown persistence logic from PRD-038**

2. **`rpc_force_close_table_session`** — New:
   - Signature: `(p_table_session_id uuid, p_close_reason close_reason_type, p_close_note text DEFAULT NULL)`
   - SECURITY DEFINER, SET search_path = public
   - `set_rls_context_from_staff()` first (ADR-024)
   - Role gate: `pit_boss | admin`
   - Skips `has_unresolved_items` check (does **not** clear it — the flag remains true for reconciliation tracking)
   - Sets `requires_reconciliation = true`, `close_reason`, `close_note`, `closed_at`, `closed_by_staff_id`
   - Emits audit_log: `INSERT INTO audit_log (casino_id, domain, actor_id, action, details) VALUES (v_casino_id, 'table-context', v_actor_id, 'force_close', jsonb_build_object(...))`
   - Includes inline rundown persistence (same logic as close RPC)
   - `GRANT EXECUTE ON FUNCTION rpc_force_close_table_session TO authenticated`

3. **`rpc_open_table_session`** — NOT modified:
   - `opened_by_staff_id` is already set on open (existing behavior).
   - `activated_by_staff_id` remains NULL until a future `rpc_activate_table_session` exists.
   - Rationale: open ≠ activate. Setting `activated_by_staff_id` at open pollutes attribution semantics.

**New Error Codes**:

| ERRCODE | Error Name | HTTP Status | Meaning |
|---------|-----------|-------------|---------|
| `P0005` | `unresolved_liabilities` | 409 | Session has unresolved items — use force close |
| `P0006` | `close_note_required` | 400 | close_reason='other' requires a note |

**close_reason Enforcement Deprecation Plan:**
- **Phase A (this patch):** DB column is nullable (`close_reason_type NULL`). RPC accepts `p_close_reason DEFAULT NULL`. Service-layer Zod schema requires `close_reason` on new close calls. Existing direct RPC callers continue to work without it.
- **Phase B (post-rollout):** After all callers are updated, tighten Zod schema enforcement and verify no NULL close_reasons in production data.
- **Phase C (future, optional):** Add DB constraint `CHECK (status != 'CLOSED' OR close_reason IS NOT NULL)` once legacy NULL rows are backfilled or accepted.

**SRM Update**: Register 10 new columns, 1 new RPC, 1 modified RPC in TableContextService section. Bump version.

**Acceptance Criteria**:
- [ ] `npm run db:types-local` succeeds — new enum and columns visible in `database.types.ts`
- [ ] Existing `rpc_close_table_session` callers continue to work (new params have defaults)
- [ ] `rpc_force_close_table_session` exists and is callable
- [ ] Check constraint prevents `close_reason='other'` without `close_note`

---

### WS2: Service Layer Updates

**Purpose**: Extend TypeScript service layer for new fields, schemas, and force-close operation.

**File Changes**:

| File | Changes |
|------|---------|
| `services/table-context/dtos.ts` | Add `CloseReasonType` enum alias. Add 10 new fields to `TableSessionDTO`. Add `closeReason`/`closeNote` to `CloseTableSessionInput`. New `ForceCloseTableSessionInput` interface. |
| `services/table-context/schemas.ts` | New `closeReasonSchema` (z.enum). Update `closeTableSessionSchema` with `close_reason` (required) + `close_note` + refinement. New `forceCloseTableSessionSchema`. Export transport types. |
| `services/table-context/table-session.ts` | Update `TableSessionRow` with new fields. Update `toTableSessionDTO()` mapper. Update `closeTableSession()` to pass `p_close_reason` + `p_close_note`. New `forceCloseTableSession()`. Add `UNRESOLVED_LIABILITIES` + `CLOSE_NOTE_REQUIRED` to error mapping. |
| `services/table-context/index.ts` | Import + re-export new types. Add `forceCloseSession` to `TableContextServiceInterface` and factory. |

**Error Mapping (additions)**:

| SQL Error | DomainError Code | HTTP | Description |
|-----------|-----------------|------|-------------|
| `unresolved_liabilities` / `P0005` | `UNRESOLVED_LIABILITIES` | 409 | Cannot close — use force close |
| `close_note_required` / `P0006` | `CLOSE_NOTE_REQUIRED` | 400 | close_reason='other' needs note |

**Acceptance Criteria**:
- [ ] `npm run type-check` passes
- [ ] `CloseReasonType` derives from `Database['public']['Enums']['close_reason_type']`
- [ ] `TableSessionDTO` includes all 10 new fields
- [ ] `forceCloseTableSession()` calls correct RPC
- [ ] Error mapping handles `UNRESOLVED_LIABILITIES` and `CLOSE_NOTE_REQUIRED`

---

### WS3: API Route Updates

**Purpose**: Update close endpoint and add force-close endpoint.

**Existing Route Modification**:

| Route | Method | Change |
|-------|--------|--------|
| `/api/v1/table-sessions/[id]/close` | PATCH | Request body now requires `close_reason`. Add `close_note` (optional). Handle `UNRESOLVED_LIABILITIES` → 409. |

**New Route**:

| Route | Method | Auth | Purpose |
|-------|--------|------|---------|
| `/api/v1/table-sessions/[id]/force-close` | POST | pit_boss, admin | Privileged forced close with audit trail |

**Force-Close Endpoint Details**:
- `export const dynamic = 'force-dynamic'`
- `createRequestContext(request)` + `requireIdempotencyKey(request)`
- Validate body with `forceCloseTableSessionSchema`
- `withServerAction` wrapper: `domain='table-context'`, `action='force-close-session'`
- Calls `forceCloseTableSession(mwCtx.supabase, { sessionId, closeReason, closeNote })`
- Returns `ServiceHttpResult<TableSessionDTO>`
- Error responses: 400 (validation), 403 (forbidden), 404 (not found), 409 (invalid state)

**Acceptance Criteria**:
- [ ] `npm run lint` passes
- [ ] Force-close endpoint enforces Idempotency-Key
- [ ] Both endpoints use `withServerAction` wrapper
- [ ] Response format is `ServiceHttpResult<TableSessionDTO>`

---

### WS4: Unit & Integration Tests

**Purpose**: Validate close guardrails, force close, close reason, and mapper accuracy.

**Test Files**:

| File | Tests | Type |
|------|-------|------|
| `close-guardrails.test.ts` | 6 tests | RPC contract |
| `close-reason-schema.test.ts` | 5 tests | Schema validation |
| `session-mapper.test.ts` | 2 tests | Mapper unit |

**Test Matrix**:

| # | Test | File | Assert |
|---|------|------|--------|
| 1 | Reject close when has_unresolved_items=true | close-guardrails | `DomainError('UNRESOLVED_LIABILITIES')` thrown |
| 2 | Allow close when has_unresolved_items=false | close-guardrails | `session.status === 'CLOSED'` |
| 3 | Force close succeeds for pit_boss | close-guardrails | `session.requires_reconciliation === true` |
| 4 | Force close rejected for dealer role | close-guardrails | `DomainError('UNAUTHORIZED')` thrown |
| 5 | Force close emits audit_log entry | close-guardrails | audit_log row with `action='force_close'` exists |
| 6 | Close reason persisted on session | close-guardrails | `session.close_reason === input.closeReason` |
| 7 | close_reason required — reject missing | close-reason-schema | `safeParse` fails without close_reason |
| 8 | 'other' requires close_note | close-reason-schema | Rejects `{close_reason:'other'}` without note |
| 9 | 'other' with note passes | close-reason-schema | Accepts `{close_reason:'other', close_note:'...'}` |
| 10 | All 8 enum values accepted | close-reason-schema | Each value passes validation |
| 11 | forceCloseSchema validates correctly | close-reason-schema | Accepts valid, rejects 'other' without note |
| 12 | toTableSessionDTO maps all PRD-038A fields | session-mapper | DTO includes all 10 new fields |
| 13 | activated_by_staff_id is NULL on open (deferred) | session-mapper | DTO field is null until activate RPC exists |

**Acceptance Criteria**:
- [ ] All 13 tests pass
- [ ] No regressions in existing tests

---

## Security Posture

| Concern | Mitigation |
|---------|-----------|
| Casino isolation | Pattern C hybrid RLS on table_session (unchanged) |
| Actor attribution | `*_by_staff_id` columns derived from `app.actor_id` (session var), not parameters |
| Force close audit trail | `audit_log` entry with `domain='table-context'`, `action='force_close'`, `details` JSONB |
| Role gating | `app.staff_role IN ('pit_boss','admin')` on both close and force-close RPCs. Close is available to the same roles as existing close workflows (unchanged). Force-close is additionally restricted to `pit_boss\|admin`. |
| ADR-024 compliance | No `p_casino_id` or `p_actor_id` parameters — all derived from `set_rls_context_from_staff()` |
| ADR-030 compliance | Write-path on `table_session` (critical table) uses session vars only |

**Assumptions:**
- `current_setting('app.staff_role')` values match `public.staff_role` enum values; this patch follows the established RPC gating pattern used by all 4 existing session RPCs.
- SECURITY DEFINER RPCs MUST set a fixed `search_path` (`public`) and MUST NOT rely on caller search_path. This patch uses `SET search_path = public` consistent with existing RPCs.

## Definition of Done

- [ ] All 4 workstreams complete
- [ ] All gates pass (schema-validation, type-check, lint, test-pass)
- [ ] `npm run build` succeeds (no build regression)
- [ ] No regressions in existing tests
- [ ] SRM updated with new columns and RPCs
- [ ] Security invariants validated (ADR-024 + ADR-030)
- [ ] `rpc_close_table_session` backward compatible (new params have defaults)
