---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline skill

prd: ADR-022
prd_title: "Player Identity & Enrollment Architecture (Casino-Scoped, Least-Privilege)"
service: PlayerService
mvp_phase: 1

# Workstream Definitions
workstreams:
  WS1:
    name: Database Foundation - Compliance Role & Audit Infrastructure
    description: Add 'compliance' role to staff_role enum, enhance audit_log for idempotent security events
    agent: rls-security-specialist
    depends_on: []
    outputs:
      - supabase/migrations/YYYYMMDDHHMMSS_adr022_compliance_role_audit.sql
    gate: schema-validation
    estimated_complexity: low

  WS2:
    name: Database Layer - Identity Tables
    description: Create player_identity and player_tax_identity tables with FK to player_casino, RLS policies
    agent: rls-security-specialist
    depends_on: [WS1]
    outputs:
      - supabase/migrations/YYYYMMDDHHMMSS_adr022_player_identity_tables.sql
    gate: schema-validation
    estimated_complexity: high

  WS3:
    name: SECURITY DEFINER RPCs
    description: Create hardened RPCs (player_has_tax_id_on_file, reveal_tax_id, upsert_tax_identity) per ADR-018
    agent: rls-security-specialist
    depends_on: [WS2]
    outputs:
      - supabase/migrations/YYYYMMDDHHMMSS_adr022_identity_rpcs.sql
    gate: schema-validation
    estimated_complexity: high

  WS4:
    name: Service Layer - PlayerIdentityService
    description: TypeScript service factory for identity operations, DTOs, keys
    agent: backend-developer
    depends_on: [WS3]
    outputs:
      - services/player-identity/index.ts
      - services/player-identity/dtos.ts
      - services/player-identity/keys.ts
      - services/player-identity/schemas.ts
    gate: type-check
    estimated_complexity: medium

  WS5:
    name: Route Handlers
    description: API routes for identity operations (non-tax via REST, tax via RPC-only)
    agent: api-expert
    depends_on: [WS4]
    outputs:
      - app/api/v1/players/[playerId]/identity/route.ts
    gate: lint
    estimated_complexity: medium

  WS6:
    name: Tests
    description: Integration tests for RLS policies and RPCs
    agent: backend-developer
    depends_on: [WS3, WS4, WS5]
    outputs:
      - services/player-identity/*.test.ts
    gate: test-pass
    estimated_complexity: medium

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Foundation (Compliance Role + Audit Enhancement)
    parallel: [WS1]
    gates: [schema-validation]

  - name: Phase 2 - Identity Tables + RLS
    parallel: [WS2]
    gates: [schema-validation]

  - name: Phase 3 - SECURITY DEFINER RPCs
    parallel: [WS3]
    gates: [schema-validation]

  - name: Phase 4 - Service Layer + Routes
    parallel: [WS4, WS5]
    gates: [type-check, lint]

  - name: Phase 5 - Tests
    parallel: [WS6]
    gates: [test-pass]

# Validation Gates
gates:
  schema-validation:
    command: npm run db:types
    success_criteria: "Exit code 0, no type errors"

  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0"

  lint:
    command: npm run lint
    success_criteria: "Exit code 0, no errors (warnings OK)"

  test-pass:
    command: npm test services/player-identity/
    success_criteria: "All tests pass"

# Dependencies on other PRDs/Services
external_dependencies:
  - prd: PRD-003
    service: PlayerService
    required_for: "player table exists"
  - prd: PRD-003
    service: CasinoService
    required_for: "player_casino enrollment table exists"
  - adr: ADR-015
    required_for: "Pattern C (Hybrid) RLS context injection"
  - adr: ADR-018
    required_for: "SECURITY DEFINER governance patterns"

# Risks and Mitigations
risks:
  - risk: "compliance role may not exist in staff_role enum"
    mitigation: "WS1 adds it via ALTER TYPE ... ADD VALUE"
  - risk: "audit_log lacks idempotency key columns for ADR-022 requirements"
    mitigation: "WS1 adds request_id column and unique constraint"
  - risk: "Tax ID encryption requires Vault/pgsodium setup"
    mitigation: "MVP uses app-layer encryption; add migration stub for Vault when ready"

---

# EXECUTION-SPEC: ADR-022 - Player Identity & Enrollment Architecture

## Overview

Implements casino-scoped player identity storage with structural separation between non-tax PII (`player_identity`) and tax identifiers (`player_tax_identity`). This design enforces least-privilege access without relying on PostgreSQL column-level security (which doesn't exist).

**Key Decisions from ADR-022:**
- **D1:** Identity is casino-scoped (tied to `player_casino` enrollment)
- **D2:** Two-table split: identity vs tax identity
- **D3:** Finance/MTL enforces CTR thresholds; PlayerService provides only `has_tax_id` contract

## Scope

### In Scope
- `compliance` role addition to `staff_role` enum
- `player_identity` table with enrollment FK and RLS policies
- `player_tax_identity` table (RPC-only access) with audit-on-reveal
- Three hardened RPCs: `player_has_tax_id_on_file`, `reveal_tax_id`, `upsert_tax_identity`
- TypeScript service layer and route handlers
- Audit infrastructure enhancements for idempotent security events

### Out of Scope
- Full CRM/marketing profile
- ID scanner integration
- Document history (multi-doc model)
- Vault/pgsodium encryption (app-layer fallback for MVP)

## Architecture Context

**Referenced Documents:**
- ADR-022: Player Identity & Enrollment Architecture (source ADR)
- ADR-015: Pattern C (Hybrid) RLS context injection
- ADR-018: SECURITY DEFINER governance
- SEC-001: RLS policy matrix (Template 5 for SECURITY DEFINER)

**SRM Ownership:**
- **PlayerService** owns: `player_identity`, `player_tax_identity`
- **CasinoService** owns: `player_casino` (enrollment relationship)
- **FinanceService/MTLService** consumes: `player_has_tax_id_on_file` contract

## Workstream Details

### WS1: Database Foundation - Compliance Role & Audit Infrastructure

**Purpose:** Add `compliance` role and enhance `audit_log` for ADR-022 security events.

**Deliverables:**
1. `ALTER TYPE staff_role ADD VALUE 'compliance'`
2. Add `request_id uuid` column to `audit_log`
3. Create partial unique index for idempotent security events: `(casino_id, actor_id, action, request_id)` WHERE `action IN ('tax_id_reveal', 'tax_id_write')`

**Acceptance Criteria:**
- [ ] `compliance` role exists in `staff_role` enum
- [ ] `audit_log.request_id` column exists
- [ ] Idempotency constraint prevents duplicate audit events for same request

### WS2: Database Layer - Identity Tables

**Purpose:** Create `player_identity` and `player_tax_identity` with proper constraints and RLS.

**Deliverables:**

**`player_identity` table:**
```
- id: uuid PK
- casino_id: uuid NOT NULL
- player_id: uuid NOT NULL
- (casino_id, player_id) FK → player_casino(casino_id, player_id)
- UNIQUE (casino_id, player_id)
- id_document_type: text (e.g., 'drivers_license', 'passport')
- id_document_number: text (encrypted app-layer)
- id_document_expiry: date
- address_line_1: text
- address_line_2: text
- city: text
- state: text
- postal_code: text
- country: text (ISO 3166-1 alpha-2)
- phone: text
- email: text
- verification_status: text ('unverified', 'pending', 'verified', 'expired')
- verified_at: timestamptz
- verified_by: uuid FK → staff(id)
- is_active: boolean DEFAULT true
- deactivated_at: timestamptz
- deactivated_by: uuid FK → staff(id)
- deactivation_reason: text
- created_at: timestamptz
- updated_at: timestamptz
```

**`player_tax_identity` table (RPC-only):**
```
- id: uuid PK
- casino_id: uuid NOT NULL
- player_id: uuid NOT NULL
- (casino_id, player_id) FK → player_casino(casino_id, player_id)
- UNIQUE (casino_id, player_id)
- tax_id_encrypted: bytea (app-layer encrypted SSN/TIN)
- tax_last4: text (4 digits, stored separately per C1 contract)
- tax_id_source: text ('enrollment', 'ctr_request', 'manual')
- is_active: boolean DEFAULT true
- deactivated_at: timestamptz
- deactivated_by: uuid FK → staff(id)
- deactivation_reason: text
- created_at: timestamptz
- updated_at: timestamptz
```

**RLS Policies:**

`player_identity`:
- SELECT: `pit_boss`, `cashier`, `compliance`, `admin` WHERE `casino_id = context.casino_id` AND `is_active = true` (non-active only for `compliance`/`admin`)
- INSERT: `pit_boss`, `admin` WHERE `casino_id = context.casino_id`
- UPDATE: `pit_boss` (limited fields), `compliance`, `admin` WHERE `casino_id = context.casino_id` WITH CHECK same

`player_tax_identity`:
- **NO direct SELECT/INSERT/UPDATE/DELETE policies** — all access via RPCs

**Acceptance Criteria:**
- [ ] FK constraint to `player_casino(casino_id, player_id)` prevents orphan identity
- [ ] `player_identity` RLS allows pit_boss/cashier read, pit_boss/admin write
- [ ] `player_tax_identity` has NO direct table privileges (RPC-only)
- [ ] `npm run db:types` succeeds

### WS3: SECURITY DEFINER RPCs

**Purpose:** Create hardened RPCs per ADR-018 for tax identity access.

**Deliverables:**

**`rpc_player_has_tax_id_on_file(p_player_id uuid)`**
- Returns `{ has_tax_id: boolean }` for pit_boss/cashier
- Returns `{ has_tax_id: boolean, last4: text }` for compliance/admin
- Derives `casino_id` from context (INV-1)
- Role check: pit_boss, cashier, compliance, admin

**`rpc_reveal_tax_id(p_player_id uuid, p_reason_code text, p_request_id uuid)`**
- Returns `{ ssn: text }` (decrypted from app-layer encryption)
- Derives `casino_id` from context (INV-1)
- Role check: compliance, admin only
- Writes audit event in same transaction (INV-4)
- Idempotent: same `(request_id, actor_id)` returns cached result, no duplicate audit
- Validates `reason_code` against allow-list

**`rpc_upsert_tax_identity(p_player_id uuid, p_ssn text, p_source text, p_request_id uuid)`**
- Returns `{ has_tax_id: boolean, last4: text }`
- Derives `casino_id` from context (INV-1)
- Role check: compliance, admin only
- Writes audit event for create/update (INV-7)
- Computes and stores `tax_last4` server-side
- Encrypts SSN app-layer before storage

**ADR-018 Hardening (all RPCs):**
```sql
SECURITY DEFINER
SET search_path = public
-- Context validation at start:
v_casino_id := COALESCE(
  NULLIF(current_setting('app.casino_id', true), '')::uuid,
  (auth.jwt() -> 'app_metadata' ->> 'casino_id')::uuid
);
v_actor_id := COALESCE(
  NULLIF(current_setting('app.staff_id', true), '')::uuid,
  (auth.jwt() -> 'app_metadata' ->> 'staff_id')::uuid
);
v_role := COALESCE(
  current_setting('app.staff_role', true),
  auth.jwt() -> 'app_metadata' ->> 'staff_role'
);
-- Fail if context missing
-- Explicit role check
-- No dynamic SQL
```

**Acceptance Criteria:**
- [ ] All RPCs derive casino_id/actor_id from context (never parameters)
- [ ] Role checks explicitly fail-closed
- [ ] Audit events written in same transaction as reveal/write
- [ ] Idempotency prevents duplicate audit entries
- [ ] `npm run db:types` succeeds

### WS4: Service Layer - PlayerIdentityService

**Purpose:** TypeScript service factory for identity operations.

**Deliverables:**

**`services/player-identity/dtos.ts`:**
```typescript
// Pattern B: Pick from Database types
export type PlayerIdentityDTO = Pick<
  Database['public']['Tables']['player_identity']['Row'],
  'id' | 'player_id' | 'casino_id' | 'id_document_type' | 'verification_status' | ...
>;

export type CreatePlayerIdentityDTO = Pick<
  Database['public']['Tables']['player_identity']['Insert'],
  'player_id' | 'id_document_type' | ...
>;

// Tax identity contracts (RPC responses)
export interface TaxIdStatusResponse {
  has_tax_id: boolean;
  last4?: string; // compliance/admin only
}

export interface TaxIdRevealResponse {
  ssn: string;
}
```

**`services/player-identity/index.ts`:**
```typescript
export interface PlayerIdentityService {
  // Identity CRUD
  getIdentity(playerId: string): Promise<PlayerIdentityDTO | null>;
  createIdentity(dto: CreatePlayerIdentityDTO): Promise<PlayerIdentityDTO>;
  updateIdentity(playerId: string, dto: UpdatePlayerIdentityDTO): Promise<PlayerIdentityDTO>;
  deactivateIdentity(playerId: string, reason: string): Promise<void>;

  // Tax identity contracts (RPC wrappers)
  hasTaxIdOnFile(playerId: string): Promise<TaxIdStatusResponse>;
  revealTaxId(playerId: string, reasonCode: string, requestId: string): Promise<TaxIdRevealResponse>;
  upsertTaxIdentity(playerId: string, ssn: string, source: string, requestId: string): Promise<TaxIdStatusResponse>;
}

export function createPlayerIdentityService(supabase: SupabaseClient): PlayerIdentityService { ... }
```

**Acceptance Criteria:**
- [ ] Functional factory pattern (no classes)
- [ ] DTOs use Pick/Omit from database.types.ts
- [ ] Tax identity methods call RPCs (not direct table access)
- [ ] `npm run type-check` succeeds

### WS5: Route Handlers

**Purpose:** API routes for identity operations.

**Deliverables:**

**`app/api/v1/players/[playerId]/identity/route.ts`:**
- GET: Retrieve player identity (non-tax PII)
- POST: Create player identity
- PATCH: Update player identity
- DELETE: Deactivate player identity (soft delete)

**Tax identity operations are NOT exposed via REST routes** — they are service-layer only, called by Finance/MTL or compliance UIs through server actions.

**Acceptance Criteria:**
- [ ] Routes use `withServerAction` middleware
- [ ] Casino context derived from auth
- [ ] No tax identity endpoints (RPC-only)
- [ ] `npm run lint` succeeds

### WS6: Tests

**Purpose:** Integration tests for RLS policies and RPCs.

**Deliverables:**
- RLS policy tests: verify role-based access for pit_boss, cashier, compliance, admin, dealer
- RPC tests: verify context derivation, role checks, audit logging, idempotency
- Service layer tests: verify DTO mapping and RPC calls

**Acceptance Criteria:**
- [ ] Tests cover all roles in access matrix
- [ ] Tests verify dealer cannot access any identity data
- [ ] Tests verify tax identity is RPC-only (no direct SELECT succeeds)
- [ ] Tests verify audit events created for reveal/write
- [ ] All tests pass

## Definition of Done

- [ ] All workstreams complete
- [ ] All gates pass
- [ ] `compliance` role exists and is documented
- [ ] `player_identity` accessible by pit_boss, cashier, compliance, admin (no dealer)
- [ ] `player_tax_identity` has zero direct table privileges
- [ ] All tax identity access is via hardened RPCs
- [ ] Audit events created for reveal and write operations
- [ ] MVP-ROADMAP.md updated (if applicable)
