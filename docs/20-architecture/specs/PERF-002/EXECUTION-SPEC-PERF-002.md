---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline skill

prd: PERF-002
prd_title: "Pit Dashboard Data Flow Optimization"
service: DashboardService
mvp_phase: 2
source_document: docs/issues/perf/PIT_DASHBOARD_DATA_FLOW_INVESTIGATION.md

workstreams:
  WS1:
    name: Stats Aggregation RPC
    description: Create rpc_get_dashboard_stats returning aggregate counts in single call
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/YYYYMMDDHHMMSS_perf002_dashboard_stats_rpc.sql
      - services/dashboard/http.ts
    gate: schema-validation
    estimated_complexity: medium

  WS2:
    name: Player-Joined Slip Select
    description: Add RATING_SLIP_WITH_PLAYER_SELECT that joins visit→player for player names
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - services/rating-slip/selects.ts
      - services/rating-slip/dtos.ts
      - services/rating-slip/mappers.ts
    gate: type-check
    estimated_complexity: low

  WS3:
    name: Active Slips with Player CRUD
    description: Add listActiveForTableWithPlayer() function in crud.ts
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - services/rating-slip/crud.ts
    gate: type-check
    estimated_complexity: low

  WS4:
    name: Dashboard Stats Hook Refactor
    description: Refactor useDashboardStats to call single rpc_get_dashboard_stats RPC
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - hooks/dashboard/use-dashboard-stats.ts
    gate: type-check
    estimated_complexity: medium

  WS5:
    name: Dashboard Slips Hook Refactor
    description: Refactor useActiveSlipsForDashboard to include player names via join
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS3]
    outputs:
      - hooks/dashboard/use-dashboard-slips.ts
    gate: type-check
    estimated_complexity: medium

  WS6:
    name: PitDashboardClient Cleanup
    description: Remove useCasinoActivePlayers() call and simplify seat occupant mapping
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS4, WS5]
    outputs:
      - components/dashboard/pit-dashboard-client.tsx
      - components/dashboard/seat-context-menu.tsx
    gate: lint
    estimated_complexity: medium

  WS7:
    name: Unit Tests
    description: Mapper tests for new DTO, hook tests
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS2, WS3]
    outputs:
      - services/rating-slip/__tests__/mappers.test.ts
      - hooks/dashboard/__tests__/use-dashboard-stats.test.ts
    gate: test-pass
    estimated_complexity: medium

  WS8:
    name: Performance Validation
    description: Benchmark suite, SLO targets, EXPLAIN ANALYZE validation
    executor: performance-engineer
    executor_type: skill
    depends_on: [WS1, WS4, WS5, WS6]
    outputs:
      - .perf/slos.json (updated)
      - .perf/benchmarks/dashboard.json
    gate: build
    estimated_complexity: low

execution_phases:
  - name: Phase 1 - Database & Service Foundation
    parallel: [WS1, WS2]
    gates: [schema-validation, type-check]

  - name: Phase 2 - Service CRUD
    parallel: [WS3]
    gates: [type-check]

  - name: Phase 3 - Hook Refactoring
    parallel: [WS4, WS5]
    gates: [type-check]

  - name: Phase 4 - Client Integration
    parallel: [WS6]
    gates: [type-check, lint]

  - name: Phase 5 - Tests & Validation
    parallel: [WS7, WS8]
    gates: [test-pass, build]

gates:
  schema-validation:
    command: npm run db:types
    success_criteria: "Exit code 0, types regenerated successfully"

  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0, no type errors"

  lint:
    command: npm run lint
    success_criteria: "Exit code 0, no errors (warnings OK)"

  test-pass:
    command: npm test services/rating-slip/__tests__/mappers.test.ts hooks/dashboard/__tests__/
    success_criteria: "All tests pass"

  build:
    command: npm run build
    success_criteria: "Exit code 0, no build errors"

external_dependencies: []

risks:
  - risk: "RPC may need casino_id parameter for existing pattern compatibility"
    mitigation: "ADR-024 mandates context derivation; update existing callers if needed"
  - risk: "Player join may add latency to slip queries"
    mitigation: "Index exists; benchmark validates <150ms p95 target"

---

# EXECUTION-SPEC: PERF-002 - Pit Dashboard Data Flow Optimization

## Overview

Optimize the Pit Dashboard page load by eliminating redundant API calls and consolidating data fetching patterns. This reduces HTTP requests from 11+ to ~5 and improves page load latency by ~60%.

**Source**: `docs/issues/perf/PIT_DASHBOARD_DATA_FLOW_INVESTIGATION.md`

## Scope

**In Scope**:
- Create `rpc_get_dashboard_stats` for aggregate counts
- Add player-joined query for rating slips
- Refactor dashboard hooks to use optimized queries
- Remove casino-wide player fetch workaround
- Performance validation with SLO targets

**Out of Scope**:
- Real-time subscriptions (future enhancement)
- Dashboard caching layer (evaluate post-optimization)
- Table session queries (separate issue)

## Architecture Context

**Bounded Contexts Affected**:
- `RatingSlipService` - Owns `rating_slip` table, adds new select projection
- `DashboardService` - Presentation layer, consumes DTOs

**ADR Compliance**:
- **ADR-024**: RPC derives `casino_id` from `set_rls_context_from_staff()`, not parameters
- **ADR-015**: Uses `SECURITY INVOKER` for read-only RPC

**Performance Targets** (per `references/slo-definitions.md`):
- `rpc_get_dashboard_stats`: Fast tier (p95 < 80ms)
- `listActiveForTableWithPlayer`: Standard tier (p95 < 150ms)
- Dashboard page load: Standard tier (p95 < 800ms)

---

## Workstream Details

### WS1: Stats Aggregation RPC

**Purpose**: Replace 4 HTTP calls with single RPC returning aggregate counts.

**Deliverables**:

1. **Migration**: `supabase/migrations/YYYYMMDDHHMMSS_perf002_dashboard_stats_rpc.sql`

```sql
-- ============================================================================
-- Migration: PERF-002 Dashboard Stats Aggregation RPC
-- Created: 2026-01-26
-- Reference: docs/issues/perf/PIT_DASHBOARD_DATA_FLOW_INVESTIGATION.md
-- ADR: ADR-024 (Authoritative Context Derivation)
-- ============================================================================

CREATE OR REPLACE FUNCTION rpc_get_dashboard_stats()
RETURNS jsonb
LANGUAGE plpgsql
SECURITY INVOKER
STABLE
AS $$
DECLARE
  v_casino_id uuid;
BEGIN
  -- ADR-024: Authoritative context derivation
  PERFORM set_rls_context_from_staff();

  v_casino_id := NULLIF(current_setting('app.casino_id', true), '')::uuid;

  IF v_casino_id IS NULL THEN
    RAISE EXCEPTION 'UNAUTHORIZED: casino context not set';
  END IF;

  RETURN jsonb_build_object(
    'activeTablesCount', (
      SELECT COUNT(*) FROM gaming_table
      WHERE casino_id = v_casino_id AND status = 'active'
    ),
    'openSlipsCount', (
      SELECT COUNT(*) FROM rating_slip
      WHERE casino_id = v_casino_id AND status IN ('open', 'paused')
    ),
    'checkedInPlayersCount', (
      SELECT COUNT(DISTINCT player_id) FROM visit
      WHERE casino_id = v_casino_id AND ended_at IS NULL AND player_id IS NOT NULL
    )
  );
END;
$$;

GRANT EXECUTE ON FUNCTION rpc_get_dashboard_stats() TO authenticated;

COMMENT ON FUNCTION rpc_get_dashboard_stats IS
  'PERF-002: Aggregates dashboard KPI counts in single RPC call. '
  'ADR-024 compliant: derives casino_id from set_rls_context_from_staff(). '
  'Replaces 4 HTTP calls (fetchTables, listRatingSlips×2, getVisits).';

NOTIFY pgrst, 'reload schema';
```

2. **HTTP Fetcher**: Add to `services/dashboard/http.ts` or `hooks/dashboard/`

```typescript
export async function fetchDashboardStats(): Promise<DashboardStatsDTO> {
  const supabase = createBrowserComponentClient();
  const { data, error } = await supabase.rpc('rpc_get_dashboard_stats');

  if (error) throw new Error(`Dashboard stats RPC failed: ${error.message}`);
  if (!data) throw new Error('No stats data returned');

  return {
    activeTablesCount: data.activeTablesCount,
    openSlipsCount: data.openSlipsCount,
    checkedInPlayersCount: data.checkedInPlayersCount,
  };
}
```

**Acceptance Criteria**:
- [ ] RPC does NOT accept `p_casino_id` parameter (ADR-024)
- [ ] RPC calls `set_rls_context_from_staff()` first
- [ ] Returns `{ activeTablesCount, openSlipsCount, checkedInPlayersCount }`
- [ ] `npm run db:types` succeeds
- [ ] EXPLAIN ANALYZE shows Index Scans for all COUNT queries

---

### WS2: Player-Joined Slip Select

**Purpose**: Add select projection that joins `visit→player` to include player names.

**Deliverables**:

1. **Select Projection** (`services/rating-slip/selects.ts`):

```typescript
/**
 * Rating slip with player info via visit→player join.
 * Used by dashboard to show player names without separate fetch.
 *
 * @see PERF-002 Pit Dashboard Data Flow Optimization
 */
export const RATING_SLIP_WITH_PLAYER_SELECT = `
  id,
  casino_id,
  visit_id,
  table_id,
  seat_number,
  start_time,
  end_time,
  status,
  average_bet,
  visit!inner (
    player_id,
    player (
      id,
      first_name,
      last_name,
      tier
    )
  )
` as const;
```

2. **DTO** (`services/rating-slip/dtos.ts`):

```typescript
/**
 * Rating slip with embedded player info.
 * @see PERF-002
 */
export interface RatingSlipWithPlayerDTO {
  id: string;
  casino_id: string;
  visit_id: string;
  table_id: string;
  seat_number: string | null;
  start_time: string;
  end_time: string | null;
  status: 'open' | 'paused' | 'closed';
  average_bet: number | null;
  player: {
    id: string;
    firstName: string;
    lastName: string;
    tier: string | null;
  } | null;
}
```

3. **Mapper** (`services/rating-slip/mappers.ts`):

```typescript
type RatingSlipWithPlayerSelectedRow = {
  id: string;
  casino_id: string;
  visit_id: string;
  table_id: string;
  seat_number: string | null;
  start_time: string;
  end_time: string | null;
  status: 'open' | 'paused' | 'closed';
  average_bet: number | null;
  visit: {
    player_id: string | null;
    player: {
      id: string;
      first_name: string;
      last_name: string;
      tier: string | null;
    } | null;
  };
};

export function toRatingSlipWithPlayerDTO(
  row: RatingSlipWithPlayerSelectedRow,
): RatingSlipWithPlayerDTO {
  return {
    id: row.id,
    casino_id: row.casino_id,
    visit_id: row.visit_id,
    table_id: row.table_id,
    seat_number: row.seat_number,
    start_time: row.start_time,
    end_time: row.end_time,
    status: row.status,
    average_bet: row.average_bet,
    player: row.visit.player
      ? {
          id: row.visit.player.id,
          firstName: row.visit.player.first_name,
          lastName: row.visit.player.last_name,
          tier: row.visit.player.tier,
        }
      : null,
  };
}

export function toRatingSlipWithPlayerDTOList(
  rows: RatingSlipWithPlayerSelectedRow[],
): RatingSlipWithPlayerDTO[] {
  return rows.map(toRatingSlipWithPlayerDTO);
}
```

**Acceptance Criteria**:
- [ ] Select projection defined in `selects.ts`
- [ ] DTO exported from `dtos.ts`
- [ ] Mapper handles null player (ghost visits)
- [ ] `npm run type-check` passes

---

### WS3: Active Slips with Player CRUD

**Purpose**: Add `listActiveForTableWithPlayer()` that fetches slips with player names.

**Deliverables** (`services/rating-slip/crud.ts`):

```typescript
import { RATING_SLIP_WITH_PLAYER_SELECT } from './selects';
import { toRatingSlipWithPlayerDTOList, type RatingSlipWithPlayerDTO } from './mappers';

/**
 * Get active (open/paused) rating slips for a table with player info.
 * Eliminates N+1 pattern where slips are fetched then players separately.
 *
 * @see PERF-002 Pit Dashboard Data Flow Optimization
 */
export async function listActiveForTableWithPlayer(
  supabase: SupabaseClient<Database>,
  tableId: string,
): Promise<RatingSlipWithPlayerDTO[]> {
  const { data, error } = await supabase
    .from('rating_slip')
    .select(RATING_SLIP_WITH_PLAYER_SELECT)
    .eq('table_id', tableId)
    .in('status', ['open', 'paused'])
    .order('start_time', { ascending: false });

  if (error) throw mapDatabaseError(error);

  return toRatingSlipWithPlayerDTOList(data ?? []);
}
```

**Acceptance Criteria**:
- [ ] Function uses `RATING_SLIP_WITH_PLAYER_SELECT`
- [ ] Returns `RatingSlipWithPlayerDTO[]`
- [ ] Filters by `status IN ('open', 'paused')`

---

### WS4: Dashboard Stats Hook Refactor

**Purpose**: Replace 4-fetch pattern with single RPC call.

**File**: `hooks/dashboard/use-dashboard-stats.ts`

**Changes**:
1. Remove imports: `fetchTables`, `listRatingSlips`, `getVisits`
2. Add import: `createBrowserComponentClient`
3. Replace `queryFn` with RPC call

```typescript
queryFn: async (): Promise<DashboardStats> => {
  const supabase = createBrowserComponentClient();

  const { data, error } = await supabase.rpc('rpc_get_dashboard_stats');

  if (error) throw new Error(`Failed to fetch dashboard stats: ${error.message}`);
  if (!data) throw new Error('No stats data returned from RPC');

  return {
    activeTablesCount: data.activeTablesCount,
    openSlipsCount: data.openSlipsCount,
    checkedInPlayersCount: data.checkedInPlayersCount,
    gamingDay: null, // Fetched separately via useGamingDay
  };
},
```

**Acceptance Criteria**:
- [ ] Hook calls single RPC `rpc_get_dashboard_stats`
- [ ] No longer imports `listRatingSlips`, `fetchTables`, `getVisits`
- [ ] Network tab shows 1 RPC call instead of 4 HTTP requests

---

### WS5: Dashboard Slips Hook Refactor

**Purpose**: Include player names in slip data via join.

**File**: `hooks/dashboard/use-dashboard-slips.ts`

**Changes**:
1. Update return type to `RatingSlipWithPlayerDTO[]`
2. Use `listActiveForTableWithPlayer` from WS3

```typescript
import { listActiveForTableWithPlayer } from '@/services/rating-slip/crud';
import type { RatingSlipWithPlayerDTO } from '@/services/rating-slip/dtos';

export function useActiveSlipsForDashboard(
  tableId: string | undefined
): UseQueryResult<RatingSlipWithPlayerDTO[]> {
  return useQuery({
    queryKey: dashboardKeys.activeSlips(tableId ?? ''),
    queryFn: async () => {
      const supabase = createBrowserComponentClient();
      return listActiveForTableWithPlayer(supabase, tableId!);
    },
    enabled: !!tableId,
    staleTime: 10_000,
    refetchOnWindowFocus: true,
  });
}
```

**Acceptance Criteria**:
- [ ] Returns `RatingSlipWithPlayerDTO[]` with player names
- [ ] No longer requires separate `useCasinoActivePlayers()` call

---

### WS6: PitDashboardClient Cleanup

**Purpose**: Remove casino-wide player fetch workaround.

**Files**:
- `components/dashboard/pit-dashboard-client.tsx`
- `components/dashboard/seat-context-menu.tsx`

**Changes to `pit-dashboard-client.tsx`**:
1. Remove: `useCasinoActivePlayers` import and call
2. Simplify `seatOccupants` memo to use new mapper

```typescript
// REMOVE
const { data: casinoActivePlayers } = useCasinoActivePlayers();

// REPLACE seatOccupants memo
const seatOccupants = React.useMemo(() => {
  return mapSlipsWithPlayerToOccupants(activeSlips ?? []);
}, [activeSlips]);
```

**Add to `seat-context-menu.tsx`**:

```typescript
/**
 * Maps rating slips with player data to seat occupants.
 * @see PERF-002 WS6
 */
export function mapSlipsWithPlayerToOccupants(
  slips: RatingSlipWithPlayerDTO[],
): Map<string, SeatOccupant> {
  const occupants = new Map<string, SeatOccupant>();

  for (const slip of slips) {
    if (!slip.seat_number) continue;
    if (slip.status !== 'open' && slip.status !== 'paused') continue;

    occupants.set(slip.seat_number, {
      firstName: slip.player?.firstName ?? 'Guest',
      lastName: slip.player?.lastName ?? '',
      slipId: slip.id,
      slipStatus: slip.status,
    });
  }

  return occupants;
}
```

**Acceptance Criteria**:
- [ ] `useCasinoActivePlayers()` removed from component
- [ ] No `/active-players` network call
- [ ] Seat occupants show real player names (not "Player #3" placeholders)

---

### WS7: Unit Tests

**Purpose**: Validate mappers and hook behavior.

**Deliverables**:

1. **Mapper tests** (`services/rating-slip/__tests__/mappers.test.ts`):

```typescript
describe('toRatingSlipWithPlayerDTO', () => {
  it('maps slip with player correctly', () => {
    const row = {
      id: 'slip-1',
      casino_id: 'casino-1',
      visit_id: 'visit-1',
      table_id: 'table-1',
      seat_number: '3',
      start_time: '2026-01-26T10:00:00Z',
      end_time: null,
      status: 'open' as const,
      average_bet: 50,
      visit: {
        player_id: 'player-1',
        player: { id: 'player-1', first_name: 'John', last_name: 'Doe', tier: 'gold' },
      },
    };

    const result = toRatingSlipWithPlayerDTO(row);
    expect(result.player).toEqual({
      id: 'player-1',
      firstName: 'John',
      lastName: 'Doe',
      tier: 'gold',
    });
  });

  it('handles ghost visit (null player)', () => {
    const row = {
      // ... with visit.player: null
    };
    const result = toRatingSlipWithPlayerDTO(row);
    expect(result.player).toBeNull();
  });
});
```

**Acceptance Criteria**:
- [ ] Mapper tests cover player present and null cases
- [ ] `npm test services/rating-slip/__tests__/mappers.test.ts` passes

---

### WS8: Performance Validation

**Purpose**: Verify optimization meets SLO targets.

**Deliverables**:

1. **SLO Configuration** (`.perf/slos.json` update):

```json
{
  "slos": [
    {
      "service": "Dashboard",
      "operation": "rpc_get_dashboard_stats",
      "p95_target_ms": 80,
      "metric_name": "dashboard_stats_latency_p95"
    },
    {
      "service": "RatingSlip",
      "operation": "listActiveForTableWithPlayer",
      "p95_target_ms": 150,
      "metric_name": "active_slips_player_join_p95"
    }
  ]
}
```

2. **EXPLAIN ANALYZE Validation** (include in PR):

```sql
-- Verify index usage for stats RPC
EXPLAIN (ANALYZE, COSTS, BUFFERS)
SELECT COUNT(*) FROM gaming_table WHERE casino_id = $1 AND status = 'active';
-- Expected: Index Scan on idx_gaming_table_casino_active, <5ms

EXPLAIN (ANALYZE, COSTS, BUFFERS)
SELECT COUNT(*) FROM rating_slip WHERE casino_id = $1 AND status IN ('open', 'paused');
-- Expected: Bitmap Index Scan, <10ms
```

**Acceptance Criteria**:
- [ ] `rpc_get_dashboard_stats` p95 < 80ms
- [ ] Dashboard page load p95 < 800ms (from ~1800ms baseline)
- [ ] HTTP requests reduced from 11 to ≤5

---

## Definition of Done

- [ ] All workstreams complete (WS1-WS8)
- [ ] All gates pass (schema-validation, type-check, lint, test-pass, benchmark-pass)
- [ ] Network tab shows ≤5 requests on dashboard load (down from 11)
- [ ] Player names display correctly in seat occupants
- [ ] No regressions in existing tests
- [ ] Performance metrics documented in PR

## Performance Comparison

| Metric | Before | After | Improvement |
|--------|--------|-------|-------------|
| HTTP requests | 11+ | ~5 | 55% reduction |
| Page load p95 | ~1800ms | <800ms | 56% faster |
| Data transfer | ~15KB | <5KB | 67% reduction |
| Stats queries | 4 | 1 | 75% reduction |

## Rollback Strategy

Each workstream is independently reversible:
1. **WS6**: Restore `useCasinoActivePlayers()` call
2. **WS5**: Restore `listRatingSlips()` without player join
3. **WS4**: Restore multi-fetch stats implementation
4. **WS1**: Drop RPC (other code paths still work)
