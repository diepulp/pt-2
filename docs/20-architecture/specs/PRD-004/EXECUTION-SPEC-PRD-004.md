---
# EXECUTION-SPEC Frontmatter
# Generated by lead-architect skill

prd: PRD-004
prd_title: "Loyalty Service - Ledger-Based Points System"
service: LoyaltyService
mvp_phase: 3  # Phase 3 (Rewards)

# Workstream Definitions
workstreams:
  WS1:
    name: Database Layer - Schema Creation
    description: |
      Create clean loyalty schema per ADR-019 v2 (greenfield - no legacy data):
      - Create loyalty_reason enum with canonical values only
        (base_accrual, promotion, redeem, manual_reward, adjustment, reversal)
      - Create loyalty_ledger table with points_delta (allows negatives)
      - Add source_kind, source_id, metadata, note columns
      - Casino-scoped idempotency index
      - Base accrual uniqueness index (prevents double-minting)
      - Create/update player_loyalty table with current_balance
      - RLS policies (SECURITY INVOKER pattern, hybrid per ADR-015)
      - Append-only denial policies (no UPDATE/DELETE on ledger)

      **Schema is greenfield.** Migrations may be squashed/reset until first pilot data.
      **No backward compatibility required.** Old enum values removed.
      **If/when pilot data exists, create ADR-0xx for production migration.**

      **Reference:** docs/20-architecture/specs/PRD-004/MIGRATION-STRATEGY-PRD-004.md
      **Reference:** docs/20-architecture/specs/PRD-004/IDEMPOTENCY-DRIFT-CONTRACT.md §2 (index DDL)
    agent: backend-developer
    depends_on: []
    outputs:
      - supabase/migrations/20251212175911_prd004_loyalty_service_schema.sql
    gate: schema-validation
    estimated_complexity: medium

  WS2:
    name: Database Layer - RPCs
    description: |
      Create SECURITY INVOKER RPCs per ADR-019:
      - rpc_accrue_on_close: Deterministic base accrual from policy_snapshot.loyalty
      - rpc_redeem: Comp issuance with overdraw support and row locking
      - rpc_manual_credit: Service recovery credits
      - rpc_apply_promotion: Promotional overlay credits
      - evaluate_session_reward_suggestion: Read-only suggestion helper (replaces mid-session eval)
      All RPCs use row-level locking on player_loyalty and return balance info.

      **Reference:** docs/20-architecture/specs/PRD-004/RPC-RLS-ROLE-ENFORCEMENT-PRD-004.md §3 (SECURITY INVOKER)
      **Reference:** docs/20-architecture/specs/PRD-004/RPC-RLS-ROLE-ENFORCEMENT-PRD-004.md §4 (Role Matrix)
    agent: backend-developer
    depends_on: [WS1]
    outputs:
      - supabase/migrations/20251212180000_prd004_loyalty_rpcs.sql
    gate: schema-validation
    estimated_complexity: high

  WS3:
    name: Service Layer - DTOs and Schemas
    description: |
      Create Pattern A DTOs for LoyaltyService:
      - LoyaltyLedgerEntryDTO (read DTO)
      - PlayerLoyaltyDTO (balance + tier)
      - AccrueOnCloseInput/Output
      - RedeemInput/Output (with balance_before/after, overdraw_applied)
      - ManualCreditInput/Output
      - ApplyPromotionInput/Output
      - SessionRewardSuggestionOutput
      - LedgerListQuery (filters, pagination per LEDGER-PAGINATION-CONTRACT.md)
      Plus Zod schemas for all inputs.

      **Reference:** docs/20-architecture/specs/PRD-004/LEDGER-PAGINATION-CONTRACT.md §4 (Cursor DTO)
    agent: backend-developer
    depends_on: [WS1]
    outputs:
      - services/loyalty/dtos.ts
      - services/loyalty/schemas.ts
    gate: type-check
    estimated_complexity: medium

  WS4:
    name: Service Layer - Core Implementation
    description: |
      Implement LoyaltyService factory with:
      - accrueOnClose(input): Call rpc_accrue_on_close
      - redeem(input): Call rpc_redeem with overdraw handling
      - manualCredit(input): Call rpc_manual_credit
      - applyPromotion(input): Call rpc_apply_promotion
      - evaluateSuggestion(slipId): Call evaluate_session_reward_suggestion
      - getBalance(playerId, casinoId): Get player_loyalty record
      - getLedger(query): Paginated ledger entries
      Plus mappers, selects, keys, and HTTP fetchers.
    agent: backend-developer
    depends_on: [WS2, WS3]
    outputs:
      - services/loyalty/index.ts
      - services/loyalty/crud.ts
      - services/loyalty/mappers.ts
      - services/loyalty/selects.ts
      - services/loyalty/keys.ts
      - services/loyalty/http.ts
    gate: type-check
    estimated_complexity: medium

  WS5:
    name: Route Handlers
    description: |
      Create API routes with withServerAction middleware:
      - POST /api/v1/loyalty/accrue - Trigger base accrual on slip close
      - POST /api/v1/loyalty/redeem - Issue comp (debit)
      - POST /api/v1/loyalty/manual-credit - Service recovery credit
      - POST /api/v1/loyalty/promotion - Apply promotional overlay
      - GET /api/v1/loyalty/suggestion - Get session reward suggestion
      - GET /api/v1/players/[playerId]/loyalty - Get balance and tier
      - GET /api/v1/loyalty/ledger - List ledger entries (keyset pagination per LEDGER-PAGINATION-CONTRACT.md)

      **Reference:** docs/20-architecture/specs/PRD-004/RPC-RLS-ROLE-ENFORCEMENT-PRD-004.md §2 (withServerAction)
      **Reference:** docs/20-architecture/specs/PRD-004/LEDGER-PAGINATION-CONTRACT.md §3 (RPC signature)
    agent: api-expert
    depends_on: [WS4]
    outputs:
      - app/api/v1/loyalty/accrue/route.ts
      - app/api/v1/loyalty/redeem/route.ts
      - app/api/v1/loyalty/manual-credit/route.ts
      - app/api/v1/loyalty/promotion/route.ts
      - app/api/v1/loyalty/suggestion/route.ts
      - app/api/v1/loyalty/ledger/route.ts
      - app/api/v1/players/[playerId]/loyalty/route.ts
    gate: lint
    estimated_complexity: medium

  WS6:
    name: React Query Hooks
    description: |
      Create TanStack Query hooks for client consumption:
      - usePlayerLoyalty(playerId, casinoId): Balance query
      - useLoyaltyLedger(query): Paginated ledger entries
      - useSessionSuggestion(slipId): Suggestion query
      - useAccrueMutation(): Base accrual mutation
      - useRedeemMutation(): Redemption mutation
      - useManualCreditMutation(): Manual credit mutation
      - usePromotionMutation(): Promotion mutation
    agent: backend-developer
    depends_on: [WS4, WS5]
    outputs:
      - hooks/loyalty/index.ts
      - hooks/loyalty/use-loyalty-queries.ts
      - hooks/loyalty/use-loyalty-mutations.ts
    gate: type-check
    estimated_complexity: low

  WS7:
    name: Tests
    description: |
      Comprehensive test suite:
      - Mapper unit tests (Row -> DTO transformations)
      - Service unit tests (business logic, validation)
      - RPC integration tests (idempotency, concurrency)
      - RLS policy tests (casino isolation, role gates)
      - Golden fixtures: TS reference formula matches DB RPC outputs
      - Idempotency tests per IDEMPOTENCY-DRIFT-CONTRACT.md §3
      - Drift detection tests per IDEMPOTENCY-DRIFT-CONTRACT.md §5
      - Role enforcement tests per RPC-RLS-ROLE-ENFORCEMENT-PRD-004.md §4

      **Reference:** All spec documents in docs/20-architecture/specs/PRD-004/
    agent: backend-developer
    depends_on: [WS4, WS5, WS6]
    outputs:
      - services/loyalty/__tests__/mappers.test.ts
      - services/loyalty/__tests__/service.test.ts
      - services/loyalty/__tests__/rls.integration.test.ts
      - services/loyalty/__tests__/golden-fixtures.test.ts
    gate: test-pass
    estimated_complexity: high

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Database Foundation
    parallel: [WS1]
    gates: [schema-validation]

  - name: Phase 2 - Database RPCs & DTOs
    parallel: [WS2, WS3]
    gates: [schema-validation, type-check]

  - name: Phase 3 - Service Implementation
    parallel: [WS4]
    gates: [type-check]

  - name: Phase 4 - Transport Layer
    parallel: [WS5, WS6]
    gates: [lint, type-check]

  - name: Phase 5 - Verification
    parallel: [WS7]
    gates: [test-pass]

# Validation Gates
gates:
  schema-validation:
    command: npm run db:types
    success_criteria: "Exit code 0, types regenerated without errors"

  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0, no TypeScript errors"

  lint:
    command: npm run lint -- services/loyalty/ app/api/v1/loyalty/ hooks/loyalty/
    success_criteria: "Exit code 0, no errors (warnings OK)"

  test-pass:
    command: npm test services/loyalty/
    success_criteria: "All tests pass"

# Dependencies on other PRDs/Services
external_dependencies:
  - prd: PRD-HZ-001
    service: withServerAction middleware
    required_for: "Auth, RLS context injection, idempotency"

  - prd: PRD-002
    service: RatingSlipService
    required_for: "Slip close triggers base accrual; policy_snapshot.loyalty source"

  - prd: PRD-003
    service: VisitService
    required_for: "Visit context for ledger entries; visit_kind for accrual eligibility"

  - prd: ADR-015
    service: RLS Connection Pooling
    required_for: "Pattern C hybrid context injection"

  - prd: ADR-019
    service: Loyalty Points Policy
    required_for: "Authoritative policy for all RPC semantics"

# Risks and Mitigations
risks:
  - risk: "Existing loyalty_ledger data uses legacy enum values (mid_session, session_end)"
    mitigation: "Strategy B: Add new values, keep legacy readable, write-prohibit legacy in RPCs"

  - risk: "Snapshot population gaps in rating_slip.policy_snapshot.loyalty"
    mitigation: "RPC returns clear error; add validation at slip creation in future iteration"

  - risk: "Concurrent redemptions could cause race conditions"
    mitigation: "Row-level locking on player_loyalty (SELECT FOR UPDATE)"

  - risk: "Overdraw abuse by staff"
    mitigation: "Role-gated approval, caps (max_overdraw_points_per_redeem=5000), audit logging"

---

# EXECUTION-SPEC: PRD-004 - Loyalty Service

## Overview

PRD-004 implements LoyaltyService as a ledger-based points system with four distinct paths:
1. **Base Accrual** (Credit): Deterministic theo-based points on rating slip close
2. **Promotions** (Credit): Campaign/offer overlay credits
3. **Comp Issuance / Redemption** (Debit): Points spent on comps
4. **Manual Credits / Corrections**: Service recovery and admin adjustments

This version corrects prior semantic confusion ("mid-session rewards" were actually comp debits) and implements full ADR-019 v2 compliance.

## Scope

### In Scope
- Base accrual formula: `base_points = round(theo * conversion_rate)` where `theo = avg_bet * house_edge/100 * duration_hours * decisions_per_hour`
- Comp issuance with controlled overdraw (role-gated, capped)
- Manual credits with mandatory staff + note
- Promotion overlays (API only, no management UI)
- Idempotent operations (idempotency_key on all mutations)
- Balance management with row locking
- Append-only ledger (no UPDATE/DELETE)
- `evaluate_session_reward_suggestion` read-only helper

### Out of Scope
- Promotional campaign management UI (post-MVP)
- Tier progression rules
- Point expiration policies
- External reward program integrations
- Seat bonus in base accrual (becomes promotion if needed)

## Architecture Context

- **Pattern**: A (Contract-First with manual DTOs)
- **Security Model**: All RPCs are SECURITY INVOKER (no SECURITY DEFINER)
- **RLS**: Hybrid pattern per ADR-015 (context injection + JWT fallback)
- **Concurrency**: Row locking on `player_loyalty` for balance updates
- **Immutability**: Append-only `loyalty_ledger` (denial policies on UPDATE/DELETE)

**Key Documents**:
- `docs/80-adrs/ADR-019-loyalty-points-policy_v2.md` - Authoritative policy
- `docs/00-vision/LoyaltyService_Points_Policy_PT-2.md` - Vision document
- `docs/20-architecture/SERVICE_RESPONSIBILITY_MATRIX.md` - LoyaltyService section

**Supplementary Specifications** (PRD-004 specs directory):
- `RPC-RLS-ROLE-ENFORCEMENT-PRD-004.md` - SECURITY INVOKER pattern, RLS policies, role enforcement matrix
- `IDEMPOTENCY-DRIFT-CONTRACT.md` - Two-tier idempotency, business uniqueness indexes, drift detection
- `LEDGER-PAGINATION-CONTRACT.md` - Keyset pagination, cursor strategy, ordering contract
- `MIGRATION-STRATEGY-PRD-004.md` - Greenfield schema design, seed scripts

## Workstream Details

### WS1: Database Layer - Schema Evolution

**Purpose**: Evolve existing loyalty tables to support ADR-019 v2 requirements.

**Key Changes**:
1. Add new enum values to `loyalty_reason`:
   - `base_accrual`, `promotion`, `redeem`, `manual_reward`, `adjustment`, `reversal`
2. Add `points_delta` column (int, NOT NULL) - replaces `points_earned` semantically
   - Positive for credits, negative for debits
3. Add `source_kind` (text) and `source_id` (uuid) for tracking
4. Add `metadata` (jsonb) for calculation provenance
5. Add `note` (text) for mandatory notes on redemptions
6. Update idempotency index to be casino-scoped
7. Add base accrual uniqueness index
8. RLS policies with SECURITY INVOKER pattern
9. Append-only denial policies

**Acceptance Criteria**:
- [ ] `npm run db:types` succeeds
- [ ] New enum values added without breaking existing data
- [ ] `points_delta` column allows negative values
- [ ] RLS policies enforce casino isolation
- [ ] Append-only: UPDATE/DELETE denied on loyalty_ledger

### WS2: Database Layer - RPCs

**Purpose**: Create all loyalty RPCs per ADR-019 v2.

**RPCs**:
1. `rpc_accrue_on_close(p_rating_slip_id, p_idempotency_key)`
   - Reads `policy_snapshot.loyalty` from rating slip
   - Computes theo and base_points
   - Inserts `base_accrual` entry if not exists
   - Returns `ledger_id`, `points_delta`, `theo`, `balance_after`, `is_existing`

2. `rpc_redeem(p_player_id, p_casino_id, p_points, p_issued_by_staff_id, p_note, p_idempotency_key, p_allow_overdraw, p_reward_id, p_reference)`
   - Row-locks `player_loyalty`
   - Validates balance or overdraw approval
   - Inserts `redeem` entry with negative `points_delta`
   - Returns `ledger_id`, `points_delta`, `balance_before`, `balance_after`, `overdraw_applied`

3. `rpc_manual_credit(p_player_id, p_casino_id, p_points, p_awarded_by_staff_id, p_note, p_idempotency_key)`
   - Inserts `manual_reward` entry
   - Returns `ledger_id`, `points_delta`, `balance_after`

4. `rpc_apply_promotion(p_rating_slip_id, p_campaign_id, p_promo_multiplier, p_bonus_points, p_idempotency_key)`
   - Inserts `promotion` entry
   - Returns `ledger_id`, `promo_points_delta`

5. `evaluate_session_reward_suggestion(p_rating_slip_id, p_as_of_ts)`
   - Pure read-only function
   - Returns `suggested_theo`, `suggested_points`, `policy_version`, `max_recommended_points`, `notes`

**Acceptance Criteria**:
- [ ] All RPCs are SECURITY INVOKER
- [ ] Idempotency works (duplicate calls return existing entry)
- [ ] Base accrual reads from `policy_snapshot.loyalty` only
- [ ] Redemption returns balance_before/after
- [ ] Overdraw is role-gated and capped
- [ ] Row locking prevents race conditions

### WS3: Service Layer - DTOs and Schemas

**Purpose**: Define TypeScript types for all loyalty operations.

**DTOs**:
- `LoyaltyLedgerEntryDTO`: Read DTO for ledger entries
- `PlayerLoyaltyDTO`: Balance, tier, preferences
- `AccrueOnCloseInput/Output`: Base accrual types
- `RedeemInput/Output`: Redemption types with overdraw info
- `ManualCreditInput/Output`: Service recovery types
- `ApplyPromotionInput/Output`: Promotion types
- `SessionRewardSuggestionOutput`: Suggestion helper response
- `LedgerListQuery`: Filters and pagination

**Zod Schemas**:
- `accrueOnCloseInputSchema`
- `redeemInputSchema`
- `manualCreditInputSchema`
- `applyPromotionInputSchema`
- `ledgerListQuerySchema`

**Acceptance Criteria**:
- [ ] All DTOs follow Pattern A (manual interfaces)
- [ ] Zod schemas match DTO types
- [ ] No `as any` casting
- [ ] Error codes match ERROR_TAXONOMY

### WS4: Service Layer - Core Implementation

**Purpose**: Implement LoyaltyService factory.

**Service Interface**:
```typescript
interface LoyaltyService {
  accrueOnClose(input: AccrueOnCloseInput): Promise<AccrueOnCloseOutput>;
  redeem(input: RedeemInput): Promise<RedeemOutput>;
  manualCredit(input: ManualCreditInput): Promise<ManualCreditOutput>;
  applyPromotion(input: ApplyPromotionInput): Promise<ApplyPromotionOutput>;
  evaluateSuggestion(slipId: string, asOfTs?: string): Promise<SessionRewardSuggestionOutput>;
  getBalance(playerId: string, casinoId: string): Promise<PlayerLoyaltyDTO | null>;
  getLedger(query: LedgerListQuery): Promise<{ items: LoyaltyLedgerEntryDTO[]; cursor: string | null }>;
}
```

**Acceptance Criteria**:
- [ ] Functional factory pattern (no classes)
- [ ] Explicit interface (no ReturnType inference)
- [ ] Mappers transform Row -> DTO without `as` casting
- [ ] Keys follow existing patterns
- [ ] HTTP fetchers for route handlers

### WS5: Route Handlers

**Purpose**: Create API endpoints with withServerAction middleware.

**Routes**:
- `POST /api/v1/loyalty/accrue`: Trigger base accrual
- `POST /api/v1/loyalty/redeem`: Issue comp (debit)
- `POST /api/v1/loyalty/manual-credit`: Service recovery credit
- `POST /api/v1/loyalty/promotion`: Apply promotional overlay
- `GET /api/v1/loyalty/suggestion`: Get session reward suggestion
- `GET /api/v1/loyalty/ledger`: List ledger entries (paginated)
- `GET /api/v1/players/[playerId]/loyalty`: Get balance and tier

**Acceptance Criteria**:
- [ ] All routes use `withServerAction` wrapper
- [ ] Request validation with Zod schemas
- [ ] Response format matches `ServiceHttpResult<T>`
- [ ] Role gates enforced:
  - Redeem: `pit_boss`, `cashier`, `admin`
  - Overdraw: `pit_boss`, `admin`
  - Manual credit: `pit_boss`, `admin`
  - Adjustment/reversal: `admin`

### WS6: React Query Hooks

**Purpose**: Provide client-side data fetching hooks.

**Hooks**:
- `usePlayerLoyalty(playerId, casinoId)`: Balance query
- `useLoyaltyLedger(query)`: Paginated ledger entries
- `useSessionSuggestion(slipId)`: Suggestion query
- `useAccrueMutation()`: Base accrual mutation
- `useRedeemMutation()`: Redemption mutation
- `useManualCreditMutation()`: Manual credit mutation
- `usePromotionMutation()`: Promotion mutation

**Acceptance Criteria**:
- [ ] Hooks use key factories from keys.ts
- [ ] Mutations invalidate relevant queries
- [ ] Error handling follows pattern
- [ ] Optimistic updates where appropriate

### WS7: Tests

**Purpose**: Comprehensive test coverage.

**Test Categories**:
1. **Mapper Unit Tests**: Row -> DTO transformations
2. **Service Unit Tests**: Business logic, validation
3. **RPC Integration Tests**:
   - Idempotency behavior
   - Concurrent redemption (race condition prevention)
   - Overdraw caps enforcement
4. **RLS Policy Tests**:
   - Casino isolation (no cross-casino data leakage)
   - Role gates (pit_boss can redeem, dealer cannot)
   - Append-only enforcement
5. **Golden Fixtures**:
   - TS reference formula matches DB RPC outputs
   - Same inputs produce same outputs

**Acceptance Criteria**:
- [ ] 90%+ coverage for service layer
- [ ] Integration tests cover happy path + error cases
- [ ] RLS tests verify access control
- [ ] Golden fixtures pass for known theo calculations

## Definition of Done

### Functionality
- [ ] Base accrual mints correct points for known golden fixtures
- [ ] Base accrual is idempotent (double call does not double-mint)
- [ ] Comp issuance creates negative ledger entry and updates balance
- [ ] Redemption returns `balance_before`, `balance_after`, `overdraw_applied`
- [ ] Manual credit requires staff + note and mints positive entry
- [ ] Promotions add separate ledger entry (do not modify base accrual)
- [ ] `evaluate_session_reward_suggestion` returns estimated values without minting

### Data & Integrity
- [ ] `policy_snapshot.loyalty` is sole input for deterministic minting
- [ ] No duplicate ledger entries for same `(casino_id, idempotency_key)` - general idempotency index
- [ ] Base accrual uniqueness: one entry per `(casino_id, rating_slip_id)` where reason='base_accrual'
- [ ] Balance equals SUM(points_delta) from ledger at all times
- [ ] Drift detection: `mv_loyalty_balance_reconciliation` materialized view for admin audit
- [ ] Reconciliation RPC: `rpc_reconcile_loyalty_balance()` for admin-only correction
- [ ] Changing `game_settings` after slip close does not affect historical points
- [ ] Append-only enforced: UPDATE/DELETE blocked by RLS

**Reference:** docs/20-architecture/specs/PRD-004/IDEMPOTENCY-DRIFT-CONTRACT.md

### Security & Access
- [ ] All loyalty RPCs are SECURITY INVOKER (not SECURITY DEFINER)
- [ ] RLS enforces casino-scoped isolation via Pattern C hybrid (context + JWT fallback)
- [ ] Direct RPC calls (without withServerAction) fail for write operations
- [ ] Comp issuance requires `pit_boss|cashier|admin` role
- [ ] Overdraw requires `pit_boss|admin` role + caps enforced
- [ ] Manual credit requires `pit_boss|admin` role
- [ ] Adjustment/reversal requires `admin` role
- [ ] No cross-casino data leakage in integration tests

**Reference:** docs/20-architecture/specs/PRD-004/RPC-RLS-ROLE-ENFORCEMENT-PRD-004.md

### Testing
- [ ] Unit tests for mappers (Row -> DTO transformations)
- [ ] Integration tests for RPC idempotency behavior (general + business uniqueness)
- [ ] RLS policy enforcement tests (cross-casino isolation)
- [ ] Role enforcement tests (pit_boss vs cashier vs admin capabilities)
- [ ] Concurrent redemption test (no race conditions)
- [ ] Keyset pagination tests (cursor encoding/decoding, page navigation)
- [ ] Golden fixtures: TS reference formula matches DB RPC outputs
- [ ] Drift detection tests (mv_loyalty_balance_reconciliation accuracy)

### Operational Readiness
- [ ] Error responses include actionable messages
- [ ] Key operations logged with correlation IDs
- [ ] Rollback path: can soft-disable loyalty features via feature flag
