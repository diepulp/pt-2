---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline with lead-architect scaffold + expert consultations

prd: PRD-029
prd_title: "Game Settings Schema Evolution — Wizard Template Support"
service: CasinoService
mvp_phase: 1
sdlc_categories: [DATA, SERVICE]
bounded_context: CasinoService

workstreams:
  WS1:
    name: Database Schema Evolution + Side-Bet Table + RLS
    description: >
      Single migration: extend game_type enum, drop old unique constraint,
      add code column + new unique, add variant columns, create side-bet table
      with expression unique index, casino_id derivation trigger, RLS policies,
      and updated_at trigger.
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/20260210081119_prd029_game_settings_schema_evolution.sql
    gate: schema-validation
    estimated_complexity: high

  WS2:
    name: Seed RPC — rpc_seed_game_settings_defaults
    description: >
      Separate migration: SECURITY DEFINER function with set_rls_context_from_staff(),
      role allow-list (admin/manager), ON CONFLICT (casino_id, code) DO NOTHING
      idempotency. Template 'small_pit_starter' inserts 11 game settings + 3 side bets.
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - supabase/migrations/20260210081120_prd029_rpc_seed_game_settings_defaults.sql
    gate: schema-validation
    estimated_complexity: medium

  WS3:
    name: Service Layer Updates (DTOs, Schemas, Mappers, CRUD)
    description: >
      Update services/casino/ for new game_settings columns and new side-bet entity.
      Pattern B DTOs derived from Database types. Zod schemas for validation.
      Mapper functions for row-to-DTO transformations. CRUD operations for both entities.
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - services/casino/game-settings-dtos.ts
      - services/casino/game-settings-schemas.ts
      - services/casino/game-settings-mappers.ts
      - services/casino/game-settings-crud.ts
      - services/casino/game-settings-side-bet-dtos.ts
      - services/casino/game-settings-side-bet-crud.ts
    gate: type-check
    estimated_complexity: medium

  WS4:
    name: Integration & Contract Tests
    description: >
      Seed RPC contract tests, CHECK constraint validation, expression unique index,
      casino_id trigger derivation, service layer CRUD tests.
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS2, WS3]
    outputs:
      - services/casino/__tests__/game-settings.test.ts
      - services/casino/__tests__/game-settings-seed-rpc.int.test.ts
    gate: test-pass
    estimated_complexity: medium

execution_phases:
  - name: "Phase 1 — Schema Foundation"
    parallel: [WS1]
    gates: [schema-validation]

  - name: "Phase 2 — Seed RPC + Service Layer"
    parallel: [WS2, WS3]
    gates: [schema-validation, type-check]

  - name: "Phase 3 — Tests + Final Validation"
    parallel: [WS4]
    gates: [test-pass, build]

gates:
  schema-validation:
    command: "npm run db:types"
    success_criteria: "Exit code 0, types regenerated successfully"

  type-check:
    command: "npm run type-check"
    success_criteria: "Exit code 0, no type errors"

  lint:
    command: "npm run lint"
    success_criteria: "Exit code 0"

  test-pass:
    command: "npm test services/casino/__tests__/game-settings"
    success_criteria: "All tests pass"

  build:
    command: "npm run build"
    success_criteria: "Exit code 0"

external_dependencies:
  - prd: PRD-025
    service: CasinoService
    required_for: "Bootstrap/onboarding — already merged"

risks:
  - risk: "Shared game_type enum affects gaming_table and loyalty_ledger"
    mitigation: "ALTER TYPE ADD VALUE is additive; existing rows unaffected. Enum values cannot be removed without DROP TYPE + recreate + column migration; ordering is not relied upon"
  - risk: "Side-bet trigger complexity"
    mitigation: "Simple single-row lookup BEFORE trigger; well-tested Postgres pattern"
  - risk: "Expression unique index unfamiliar to some engineers"
    mitigation: "Standard Postgres feature; COALESCE handles NULL paytable_id correctly"
  - risk: "Existing consumers assume one row per game_type"
    mitigation: "Selection should be by code (stable) or id (FK); update any maybeSingle() calls"
---

# EXECUTION-SPEC: PRD-029 — Game Settings Schema Evolution

## Overview

Extends the `game_settings` schema to support variant-level granularity for the Setup Wizard (Wizard B Step 2). Adds new enum values, variant columns, a side-bet catalog table, and a seed RPC for template pre-loading. This is a backend-only PRD within CasinoService bounded context.

## Scope

**In Scope:**
- Extend `game_type` enum with `pai_gow` and `carnival`
- Drop `ux_game_settings_casino_type`, add `code` column + `UNIQUE(casino_id, code)`
- Add variant columns: `variant_name`, `shoe_decks`, `deck_profile`, `rating_edge_for_comp`, `notes`
- Create `game_settings_side_bet` table with expression unique index and casino_id derivation trigger
- RLS policies for side-bet table (Pattern C hybrid, admin-only writes)
- Seed RPC `rpc_seed_game_settings_defaults` (SECURITY DEFINER, 11 games + 3 side bets)
- Service layer DTOs, schemas, mappers, CRUD for new columns + side-bet entity
- Integration tests

**Out of Scope:**
- Setup Wizard UI components
- `gaming_table.type` backfilling
- Side-bet financial tracking
- Per-table setting overrides
- Dynamic game-type management UI

## Architecture Context

- **SRM**: CasinoService owns `game_settings` and `game_settings_side_bet` (v4.12.0)
- **RLS**: Pattern C hybrid (ADR-015/ADR-020), admin-only writes
- **RPC Security**: SECURITY DEFINER with `set_rls_context_from_staff()` (ADR-024), bypass-by-design (SEC-006/SEC-007 precedent)
- **DTO Pattern**: Pattern B (Pick/Omit from Database types)

---

## Workstream Details

### WS1: Database Schema Evolution + Side-Bet Table + RLS

**Purpose**: Single migration containing all DDL changes, new table, trigger, and RLS policies.

**Migration**: `20260210081119_prd029_game_settings_schema_evolution.sql`

**Deliverables**:

1. **Enum extension** (FR-1):
   ```sql
   ALTER TYPE game_type ADD VALUE IF NOT EXISTS 'pai_gow';
   ALTER TYPE game_type ADD VALUE IF NOT EXISTS 'carnival';
   ```

2. **Drop old unique constraint** (FR-2):
   ```sql
   DROP INDEX IF EXISTS ux_game_settings_casino_type;
   ```

3. **Add `code` column + new unique** (FR-2):
   ```sql
   -- Add `code` column (nullable first), backfill, then enforce NOT NULL
   ALTER TABLE game_settings
     ADD COLUMN IF NOT EXISTS code text;

   -- Precondition: prior schema enforced UNIQUE(casino_id, game_type), so mapping
   -- existing rows code = game_type::text is collision-free against the new
   -- UNIQUE(casino_id, code) constraint. Do NOT reuse this pattern without verifying
   -- 1:1 uniqueness between source and target columns.
   UPDATE game_settings
   SET code = game_type::text
   WHERE code IS NULL OR code = '';

   -- Enforce NOT NULL after backfill
   ALTER TABLE game_settings
     ALTER COLUMN code SET NOT NULL;

   -- Uniqueness: stable identifier per casino
   CREATE UNIQUE INDEX IF NOT EXISTS ux_game_settings_casino_code
     ON game_settings (casino_id, code);
   ```

4. **Add variant columns** (FR-3):
   ```sql
   ALTER TABLE game_settings
     ADD COLUMN IF NOT EXISTS variant_name text,
     ADD COLUMN IF NOT EXISTS shoe_decks smallint,
     ADD COLUMN IF NOT EXISTS deck_profile text,
     ADD COLUMN IF NOT EXISTS rating_edge_for_comp numeric(6,3),
     ADD COLUMN IF NOT EXISTS notes text;

   -- CHECK constraints (re-runnable)
   DO $$
   BEGIN
     ALTER TABLE game_settings
       ADD CONSTRAINT chk_shoe_decks CHECK (shoe_decks IN (1, 2, 4, 6, 8));
   EXCEPTION WHEN duplicate_object THEN
     NULL;
   END $$;

   DO $$
   BEGIN
     ALTER TABLE game_settings
       ADD CONSTRAINT chk_deck_profile CHECK (deck_profile IN ('standard_52', 'with_joker_53', 'spanish_48'));
   EXCEPTION WHEN duplicate_object THEN
     NULL;
   END $$;

   DO $$
   BEGIN
     ALTER TABLE game_settings
       ADD CONSTRAINT chk_rating_edge_for_comp CHECK (rating_edge_for_comp >= 0 AND rating_edge_for_comp <= 100);
   EXCEPTION WHEN duplicate_object THEN
     NULL;
   END $$;
   ```

   > **Note**: A CHECK constraint is satisfied if the expression evaluates to TRUE **or NULL**, so it won't prevent NULLs unless paired with `NOT NULL`.

5. **Create `game_settings_side_bet` table** (FR-4):
   ```sql
   CREATE TABLE IF NOT EXISTS game_settings_side_bet (
     id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
     game_settings_id uuid NOT NULL REFERENCES game_settings(id) ON DELETE CASCADE,
     casino_id uuid NOT NULL REFERENCES casino(id) ON DELETE CASCADE,
     side_bet_name text NOT NULL,
     house_edge numeric(6,3) NOT NULL,
     paytable_id text,
     enabled_by_default boolean NOT NULL DEFAULT false,
     created_at timestamptz NOT NULL DEFAULT now(),
     updated_at timestamptz NOT NULL DEFAULT now(),
     CONSTRAINT chk_side_bet_house_edge CHECK (house_edge >= 0 AND house_edge <= 100)
   );
   ```

6. **Expression unique index** (FR-4):
   ```sql
   CREATE UNIQUE INDEX IF NOT EXISTS game_settings_side_bet_uq
     ON game_settings_side_bet (game_settings_id, side_bet_name, COALESCE(paytable_id, 'default'));
   ```

   > This is an **expression unique index**; Postgres supports indexes on expressions to enforce constraints not definable as simple unique constraints (e.g., `COALESCE(...)`).

7. **Casino_id derivation trigger** (FR-4, Option C2):

   > **Normative**: `casino_id` on `game_settings_side_bet` is **trigger-derived, not client-supplied**. The DDL column is `NOT NULL` (constraint checked after BEFORE trigger populates it), but client inserts MUST NOT include `casino_id`. Service DTOs, Zod schemas, and PostgREST calls must omit it. The trigger overwrites any client-supplied value.

   ```sql
   CREATE OR REPLACE FUNCTION set_game_settings_side_bet_casino_id()
   RETURNS trigger LANGUAGE plpgsql AS $$
   BEGIN
     NEW.casino_id := (SELECT casino_id FROM game_settings WHERE id = NEW.game_settings_id);
     IF NEW.casino_id IS NULL THEN
       RAISE EXCEPTION 'Parent game_settings row not found for id %', NEW.game_settings_id;
     END IF;
     RETURN NEW;
   END;
   $$;

   CREATE TRIGGER trg_side_bet_derive_casino_id
     BEFORE INSERT OR UPDATE ON game_settings_side_bet
     FOR EACH ROW EXECUTE FUNCTION set_game_settings_side_bet_casino_id();
   ```

8. **Updated_at trigger** for side-bet table:

   > **Precondition**: The existing migration `20251126131051_game_settings_theo_fields.sql` defines a table-specific `update_game_settings_updated_at()` function. No generic `update_updated_at()` exists in the baseline. WS1 migration MUST create a table-specific trigger function for `game_settings_side_bet` (or a reusable generic one if preferred).

   ```sql
   CREATE OR REPLACE FUNCTION update_game_settings_side_bet_updated_at()
   RETURNS TRIGGER AS $$
   BEGIN
     NEW.updated_at = now();
     RETURN NEW;
   END;
   $$ LANGUAGE plpgsql;

   DROP TRIGGER IF EXISTS trg_game_settings_side_bet_updated_at ON game_settings_side_bet;
   CREATE TRIGGER trg_game_settings_side_bet_updated_at
     BEFORE UPDATE ON game_settings_side_bet
     FOR EACH ROW EXECUTE FUNCTION update_game_settings_side_bet_updated_at();
   ```

9. **RLS policies** (from rls-expert consultation):

   ```sql
   -- REQUIRED: Enable RLS (policies have no effect without this)
   ALTER TABLE game_settings_side_bet ENABLE ROW LEVEL SECURITY;

   -- SELECT: All authenticated, casino-scoped (Pattern C hybrid)
   CREATE POLICY side_bet_select ON game_settings_side_bet
     FOR SELECT TO authenticated
     USING (
       auth.uid() IS NOT NULL
       AND casino_id = COALESCE(
         current_setting('app.casino_id', true)::uuid,
         ((auth.jwt()->'app_metadata')::jsonb->>'casino_id')::uuid
       )
     );

   -- INSERT: Admin-only, casino-scoped (Pattern C hybrid)
   CREATE POLICY side_bet_insert ON game_settings_side_bet
     FOR INSERT TO authenticated
     WITH CHECK (
       auth.uid() IS NOT NULL
       AND casino_id = COALESCE(
         current_setting('app.casino_id', true)::uuid,
         ((auth.jwt()->'app_metadata')::jsonb->>'casino_id')::uuid
       )
       AND COALESCE(
         current_setting('app.staff_role', true),
         (auth.jwt()->'app_metadata')::jsonb->>'staff_role'
       ) IN ('admin', 'manager')
     );

   -- UPDATE: Admin-only, casino-scoped (USING + WITH CHECK)
   CREATE POLICY side_bet_update ON game_settings_side_bet
     FOR UPDATE TO authenticated
     USING (
       auth.uid() IS NOT NULL
       AND casino_id = COALESCE(
         current_setting('app.casino_id', true)::uuid,
         ((auth.jwt()->'app_metadata')::jsonb->>'casino_id')::uuid
       )
       AND COALESCE(
         current_setting('app.staff_role', true),
         (auth.jwt()->'app_metadata')::jsonb->>'staff_role'
       ) IN ('admin', 'manager')
     )
     WITH CHECK (
       casino_id = COALESCE(
         current_setting('app.casino_id', true)::uuid,
         ((auth.jwt()->'app_metadata')::jsonb->>'casino_id')::uuid
       )
     );

   -- No DELETE policy: denied by default (mirrors game_settings)
   ```

   - **SELECT**: All authenticated, casino-scoped (Pattern C hybrid)
   - **INSERT**: Admin-only, casino-scoped (Pattern C hybrid)
   - **UPDATE**: Admin-only, casino-scoped (USING + WITH CHECK)
   - **No DELETE policy** (denied by default, mirrors game_settings)
   - Decision: Not a critical table per ADR-030 D4, so COALESCE fallback is acceptable on writes

   > RLS policies govern direct table access (PostgREST/service CRUD). The seed RPC in WS2 is **SECURITY DEFINER bypass-by-design** and enforces role + tenancy checks internally. Table owners and roles with `BYPASSRLS` normally bypass RLS unless `FORCE ROW LEVEL SECURITY` is enabled.

10. **PostgREST schema cache reload** (optional for local/dev):
    - `NOTIFY pgrst, 'reload schema';`
    - CI gate is `npm run db:types` (generated types must match DB), so PostgREST reload is not relied upon in automated validation.
    - **Note**: PostgREST can drop `NOTIFY` events if a schema reload is already in progress. Do not depend on manual `NOTIFY` for correctness in dev — restart the PostgREST container if schema changes aren't reflected.

**Acceptance Criteria**:
- [ ] `ALTER TYPE game_type ADD VALUE` succeeds for `pai_gow` and `carnival`
- [ ] Old unique constraint dropped; new `(casino_id, code)` constraint active
- [ ] All CHECK constraints exist and reject invalid data
- [ ] Side-bet table created with expression unique index
- [ ] Casino_id derivation trigger fires on INSERT/UPDATE
- [ ] RLS enabled on side-bet table with SELECT/INSERT/UPDATE policies
- [ ] `npm run db:types` exits 0

---

### WS2: Seed RPC — rpc_seed_game_settings_defaults

**Purpose**: SECURITY DEFINER function to bulk-insert template game settings for a casino.

**Migration**: `20260210081120_prd029_rpc_seed_game_settings_defaults.sql`

**Security Posture** (from rls-expert consultation):
- **SECURITY DEFINER** with `SET search_path TO 'public', pg_temp`
- **Bypass-by-design**: RLS bypassed by DEFINER; compensated with explicit casino_id scoping
- **Context injection**: `PERFORM set_rls_context_from_staff()` (ADR-024)
- **Role allow-list**: `admin`, `manager`
- **ADR-024 INV-8**: No `casino_id` parameter — derived from context

**Function signature**:
```sql
CREATE OR REPLACE FUNCTION rpc_seed_game_settings_defaults(
  p_template text DEFAULT 'small_pit_starter'
)
RETURNS integer  -- count of inserted rows
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path TO 'public', pg_temp
```

**Template**: `small_pit_starter` — 11 game settings + 3 side bets per Appendix A/B of PRD-029.

**Idempotency**: `ON CONFLICT (casino_id, code) DO NOTHING` — re-running inserts 0 rows.

**Side-bet insertion**: After game settings, insert side bets by looking up the parent `game_settings.id` via `(casino_id, code)` join.

**Acceptance Criteria**:
- [ ] Seed RPC creates all 11 game settings rows for a casino
- [ ] Seed RPC creates all 3 side-bet rows
- [ ] Idempotent: second call returns 0
- [ ] Role enforcement: pit_boss/dealer/cashier rejected
- [ ] No casino_id parameter (ADR-024 INV-8)
- [ ] GRANT EXECUTE to authenticated role (broad grant; authorization enforced inside function via actor role from `set_rls_context_from_staff()` — do NOT tighten the GRANT without updating internal checks)
- [ ] `NOTIFY pgrst, 'reload schema'`

---

### WS3: Service Layer Updates (DTOs, Schemas, Mappers, CRUD)

**Purpose**: Expose new game_settings columns and side-bet entity through CasinoService.

**Pattern**: Pattern B (Pick/Omit from Database types)

**Deliverables**:

1. **`services/casino/game-settings-dtos.ts`**:
   - `GameSettingsRow` — raw database row type from `Database['public']['Tables']['game_settings']['Row']`
   - `GameSettingsDTO` — Pick from Row: id, casino_id, game_type, code, name, variant_name, shoe_decks, deck_profile, house_edge, rating_edge_for_comp, decisions_per_hour, seats_available, min_bet, max_bet, notes, created_at, updated_at
   - `CreateGameSettingsDTO` — Omit id, created_at, updated_at from GameSettingsDTO
   - `UpdateGameSettingsDTO` — Partial of Omit id, casino_id, code from GameSettingsDTO

2. **`services/casino/game-settings-side-bet-dtos.ts`**:
   - `GameSettingsSideBetRow` — from `Database['public']['Tables']['game_settings_side_bet']['Row']`
   - `GameSettingsSideBetDTO` — Pick all fields
   - `CreateGameSettingsSideBetDTO` — Omit id, casino_id (trigger-derived), created_at, updated_at
   - `UpdateGameSettingsSideBetDTO` — Partial of Omit id, casino_id, game_settings_id

3. **`services/casino/game-settings-schemas.ts`**:
   - `createGameSettingsInput` — Zod schema for create
   - `updateGameSettingsInput` — Zod schema for update
   - `createGameSettingsSideBetInput` — Zod schema (no casino_id field)
   - Enum validation for `shoe_decks`, `deck_profile`

4. **`services/casino/game-settings-mappers.ts`**:
   - `toGameSettingsDTO(row)` — row-to-DTO transformation
   - `toGameSettingsSideBetDTO(row)` — row-to-DTO transformation

5. **`services/casino/game-settings-crud.ts`**:
   - `listGameSettings(supabase, filters?)` — list with optional game_type filter. **Returns a list** (multiple variants per game_type); callers must never use `.maybeSingle()`
   - `getGameSettingsByCode(supabase, code)` — lookup by stable code
   - `getGameSettingsById(supabase, id)` — lookup by id
   - `createGameSettings(supabase, input)` — create
   - `updateGameSettings(supabase, id, input)` — update
   - `listSideBets(supabase, gameSettingsId)` — list side bets for a game setting
   - `createSideBet(supabase, input)` — create (no casino_id in input)
   - `updateSideBet(supabase, id, input)` — update
   - `seedGameSettingsDefaults(supabase, template?)` — call seed RPC

**Acceptance Criteria**:
- [ ] DTOs derived from Database types (Pattern B)
- [ ] No `as any` casting
- [ ] Zod schemas validate all CHECK constraints (shoe_decks, deck_profile, edges)
- [ ] CreateGameSettingsSideBetDTO omits casino_id
- [ ] Service functions follow functional pattern (no classes)
- [ ] `npm run type-check` exits 0

---

### WS4: Integration & Contract Tests

**Purpose**: Validate schema constraints, RPC behavior, and service layer correctness.

**Test Files**:

1. **`services/casino/__tests__/game-settings.test.ts`** (unit):
   - Mapper tests: `toGameSettingsDTO` produces correct shape
   - Mapper tests: `toGameSettingsSideBetDTO` produces correct shape
   - Schema validation: valid/invalid shoe_decks values
   - Schema validation: valid/invalid deck_profile values
   - Schema validation: edge range 0..100
   - CreateGameSettingsSideBetDTO omits casino_id

2. **`services/casino/__tests__/game-settings-seed-rpc.int.test.ts`** (integration):
   - Seed RPC inserts 11 game settings for a casino
   - Seed RPC inserts 3 side bets
   - Idempotency: second call inserts 0 rows
   - New columns accept valid data (shoe_decks=6, deck_profile='spanish_48')
   - CHECK constraints reject invalid data (shoe_decks=3, deck_profile='invalid')
   - Expression unique index blocks duplicate side bets
   - Casino_id derivation trigger works (insert without casino_id succeeds)
   - Casino_id derivation trigger catches missing parent
   - Side-bet insert without client-supplied casino_id succeeds AND stored casino_id equals parent game_settings.casino_id
   - Side-bet insert with a **mismatched** client-supplied casino_id is overwritten by trigger; stored casino_id equals parent game_settings.casino_id (tenancy footgun guard)
   - `(casino_id, code)` uniqueness enforced

**Acceptance Criteria**:
- [ ] All mapper tests pass with 100% coverage
- [ ] Seed RPC idempotency verified
- [ ] CHECK constraint tests pass
- [ ] Expression unique index test passes
- [ ] Casino_id trigger derivation test passes
- [ ] `npm test services/casino/__tests__/game-settings` exits 0

---

## Definition of Done

**Functionality**:
- [ ] `game_type` enum includes `pai_gow` and `carnival`
- [ ] `game_settings` has `variant_name`, `shoe_decks`, `deck_profile`, `rating_edge_for_comp`, `notes`, `code`
- [ ] `UNIQUE(casino_id, code)` enforced; old `(casino_id, game_type)` dropped
- [ ] `game_settings_side_bet` table exists with RLS
- [ ] `rpc_seed_game_settings_defaults` inserts 11 games + 3 side bets
- [ ] Seed RPC is idempotent

**Security**:
- [ ] Side-bet RLS: Pattern C hybrid, admin-only writes
- [ ] Seed RPC: SECURITY DEFINER, `set_rls_context_from_staff()`, role allow-list
- [ ] No casino_id/actor_id parameters on RPC (ADR-024 INV-8)

**Quality Gates**:
- [ ] `npm run db:types` exits 0
- [ ] `npm run type-check` exits 0
- [ ] `npm run lint` exits 0
- [ ] `npm test services/casino/__tests__/game-settings` — all pass
- [ ] `npm run build` exits 0

**Documentation**:
- [ ] SRM updated if needed (CasinoService already owns game_settings)
- [ ] Migration follows MIGRATION_NAMING_STANDARD
