---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline skill

prd: GAP-ACTIVITY-PANEL-CASINO-WIDE
prd_title: "Activity Panel Enhancement - Casino-Wide Player Lookup"
service: RatingSlipService
mvp_phase: 2  # Session phase - dashboard enhancement

# Workstream Definitions
workstreams:
  WS1:
    name: Service Layer
    description: Add ActivePlayerForDashboardDTO, mapper function, and listActivePlayersCasinoWide CRUD function
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - services/rating-slip/dtos.ts
      - services/rating-slip/mappers.ts
      - services/rating-slip/crud.ts
      - services/rating-slip/index.ts
    gate: type-check
    estimated_complexity: low

  WS2:
    name: Route Handler
    description: Create GET /api/v1/rating-slips/active-players endpoint with ADR-024 compliance
    executor: api-builder
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - app/api/v1/rating-slips/active-players/route.ts
    gate: lint
    estimated_complexity: low

  WS3:
    name: Zustand Store Update
    description: Add activitySearchQuery and activitySortMode state with actions
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - store/pit-dashboard-store.ts
    gate: type-check
    estimated_complexity: low

  WS4:
    name: React Query Hook
    description: Create useCasinoActivePlayers hook with proper query keys and cache invalidation
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS1, WS2]
    outputs:
      - hooks/dashboard/use-casino-active-players.ts
      - hooks/dashboard/keys.ts
      - hooks/dashboard/index.ts
    gate: type-check
    estimated_complexity: medium

  WS5:
    name: ActivityPanel Component Rewrite
    description: Replace table-scoped timeline with casino-wide responsive data table
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS3, WS4]
    outputs:
      - components/pit-panels/activity-panel.tsx
      - components/pit-panels/panel-container.tsx
    gate: type-check
    estimated_complexity: high

  WS6:
    name: Quality Validation
    description: Final build validation and quality gates
    executor: qa-specialist
    executor_type: skill
    depends_on: [WS1, WS2, WS3, WS4, WS5]
    outputs: []
    gate: build
    estimated_complexity: low

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Foundation
    parallel: [WS1, WS3]
    gates: [type-check]

  - name: Phase 2 - Route Handler
    parallel: [WS2]
    gates: [lint]

  - name: Phase 3 - Data Fetching
    parallel: [WS4]
    gates: [type-check]

  - name: Phase 4 - UI Implementation
    parallel: [WS5]
    gates: [type-check]

  - name: Phase 5 - Validation
    parallel: [WS6]
    gates: [build]

# Validation Gates
gates:
  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0"

  lint:
    command: npm run lint
    success_criteria: "Exit code 0"

  build:
    command: npm run build
    success_criteria: "Exit code 0"

# Dependencies on other PRDs/Services
external_dependencies:
  - prd: GAP-ACTIVITY-PANEL-CASINO-WIDE
    service: Database
    required_for: "RPC rpc_list_active_players_casino_wide (already created in migration 20260118151907)"
    status: completed

# Risks and Mitigations
risks:
  - risk: "Data table performance with many active players"
    mitigation: "Default limit of 100 players, search filter reduces result set, server-side filtering"

  - risk: "Real-time cache invalidation"
    mitigation: "Integrate with existing realtime subscription pattern for rating_slip changes"

  - risk: "Responsive column complexity"
    mitigation: "Use shadcn/ui data table with built-in responsive utilities"
---

# EXECUTION-SPEC: GAP-ACTIVITY-PANEL-CASINO-WIDE

## Overview

Enhance the ActivityPanel component from single-table scope to casino-wide player lookup. This enables pit bosses to quickly locate any active player across all pits and tables from a unified interface.

## Scope

### In Scope
- Casino-wide active player data table with search and sort
- Responsive column visibility (desktop/tablet/mobile)
- Zustand-persisted search query and sort mode
- ADR-024 compliant API endpoint
- shadcn/ui data table integration

### Out of Scope
- Pagination (will use default limit of 100 with search filter)
- Real-time subscription for activity updates (defer to follow-up)
- Player photos or avatars
- Advanced filtering (tier, table type, etc.)

## Architecture Context

### Bounded Context Ownership
- **RatingSlipService** owns the `rating_slip` table and related queries
- Player data is read-only consumption via JOIN in the existing RPC
- This is a dashboard/BFF concern, not a new service

### ADR-024 Compliance
The existing RPC `rpc_list_active_players_casino_wide` implements:
- `set_rls_context_from_staff()` for context injection
- No `p_casino_id` parameter (derived from context)
- `SECURITY INVOKER` with proper tenant isolation

### Related Documents
- PRD: `docs/issues/gaps/GAP-ACTIVITY-PANEL-CASINO-WIDE.md`
- Migration: `supabase/migrations/20260118151907_add_active_players_casino_wide_rpc.sql`
- SRM: `docs/20-architecture/SERVICE_RESPONSIBILITY_MATRIX.md`

---

## Workstream Details

### WS1: Service Layer

**Purpose**: Add DTO, mapper, and CRUD function for casino-wide active players.

**Deliverables**:
1. `ActivePlayerForDashboardDTO` in `services/rating-slip/dtos.ts`
2. `mapRpcRowToActivePlayerDTO` in `services/rating-slip/mappers.ts`
3. `listActivePlayersCasinoWide` in `services/rating-slip/crud.ts`
4. Export in `services/rating-slip/index.ts`

**DTO Structure** (from PRD):
```typescript
export interface ActivePlayerForDashboardDTO {
  slipId: string;
  visitId: string;
  tableId: string;
  tableName: string;
  pitName: string | null;
  seatNumber: string | null;
  startTime: string;
  status: 'open' | 'paused';
  averageBet: number | null;
  player: {
    id: string;
    firstName: string;
    lastName: string;
    birthDate: string | null;
    tier: string | null;
  } | null;
}
```

**Acceptance Criteria**:
- [ ] DTO follows Pattern A (Contract-First camelCase) with proper eslint-disable comment
- [ ] Mapper handles null player (ghost visits)
- [ ] CRUD function calls RPC with search/limit params
- [ ] Export added to index.ts

---

### WS2: Route Handler

**Purpose**: Create API endpoint for fetching casino-wide active players.

**Deliverables**:
1. `GET /api/v1/rating-slips/active-players` route handler

**Route Specification**:
```typescript
// GET /api/v1/rating-slips/active-players?search=John&limit=100
// Response: { items: ActivePlayerForDashboardDTO[], count: number }
```

**Implementation Requirements**:
- Use `withServerAction` middleware (ADR-024 compliance)
- Parse `search` and `limit` query params with Zod validation
- Return `ServiceHttpResult<T>` format
- Casino context derived from auth (not headers)

**Acceptance Criteria**:
- [ ] Route uses withServerAction wrapper
- [ ] Zod schema validates query params
- [ ] Response format matches ServiceHttpResult
- [ ] No casino_id in request params

---

### WS3: Zustand Store Update

**Purpose**: Add activity panel state to pit-dashboard-store.

**Deliverables**:
1. Add `activitySearchQuery: string` state
2. Add `activitySortMode: 'recent' | 'alpha-asc' | 'alpha-desc'` state
3. Add `setActivitySearchQuery` action
4. Add `setActivitySortMode` action

**Interface Update**:
```typescript
interface PitDashboardStore {
  // ... existing fields

  // Activity panel state (new)
  activitySearchQuery: string;
  activitySortMode: 'recent' | 'alpha-asc' | 'alpha-desc';
  setActivitySearchQuery: (query: string) => void;
  setActivitySortMode: (mode: 'recent' | 'alpha-asc' | 'alpha-desc') => void;
}
```

**Acceptance Criteria**:
- [ ] State initializes with empty search and 'recent' sort
- [ ] Actions properly update state with devtools action names
- [ ] No breaking changes to existing store interface

---

### WS4: React Query Hook

**Purpose**: Create data fetching hook for casino-wide active players.

**Deliverables**:
1. `useCasinoActivePlayers` hook in `hooks/dashboard/use-casino-active-players.ts`
2. Add query key factory to `hooks/dashboard/keys.ts`
3. Export from `hooks/dashboard/index.ts`

**Hook Specification**:
```typescript
export function useCasinoActivePlayers(options?: {
  search?: string;
  limit?: number;
}) {
  return useQuery({
    queryKey: dashboardKeys.casinoActivePlayers(options),
    queryFn: () => fetchCasinoActivePlayers(options),
    staleTime: 15_000, // 15 seconds
    refetchOnWindowFocus: true,
  });
}
```

**Query Key Factory**:
```typescript
export const dashboardKeys = {
  // ... existing keys
  casinoActivePlayers: (options?: { search?: string; limit?: number }) =>
    ['dashboard', 'casino-active-players', options] as const,
};
```

**Acceptance Criteria**:
- [ ] Hook uses React Query v5 patterns
- [ ] Query key factory follows existing pattern
- [ ] HTTP fetcher uses typed fetch with DTO
- [ ] Proper error handling

---

### WS5: ActivityPanel Component Rewrite

**Purpose**: Replace timeline-based UI with responsive data table for casino-wide lookup.

**Deliverables**:
1. Complete rewrite of `components/pit-panels/activity-panel.tsx`
2. Update `components/pit-panels/panel-container.tsx` (remove table-scoped props)

**ActivityPanel Requirements**:
- Search input with debounced onChange
- Sort toggle (Recent / A→Z / Z→A)
- shadcn/ui data table with responsive columns
- Row click triggers `onSlipClick(slipId)`
- Loading skeleton (not spinner)
- Empty state for no results

**Responsive Column Matrix** (from PRD):

| Column | Desktop | Tablet | Mobile |
|--------|---------|--------|--------|
| Name | Yes | Yes | Yes |
| Birthdate | Yes | Yes | Yes |
| Table/Pit | Yes | Yes | No |
| Seat | Yes | No | No |
| Duration | Yes | Yes | No |
| Status | Yes | No | No |
| Tier | Yes | No | No |
| Avg Bet | Yes | No | No |

**Sort Behavior**:
- `'recent'`: start_time DESC (default)
- `'alpha-asc'`: last_name ASC
- `'alpha-desc'`: last_name DESC

**PanelContainer Update**:
- Remove `tableName`, `activeSlips`, `seats`, `isLoading` props from ActivityPanel call
- ActivityPanel fetches its own data via `useCasinoActivePlayers`

**Acceptance Criteria**:
- [ ] Uses useCasinoActivePlayers hook for data fetching
- [ ] Uses Zustand store for search/sort state
- [ ] Responsive columns work correctly
- [ ] No useState for loading (uses query's isLoading)
- [ ] No useEffect sync patterns
- [ ] shadcn/ui data table component

---

### WS6: Quality Validation

**Purpose**: Final validation that all changes integrate correctly.

**Validation Steps**:
1. Run `npm run type-check` - verify no type errors
2. Run `npm run lint` - verify no lint errors
3. Run `npm run build` - verify production build succeeds

**Acceptance Criteria**:
- [ ] Type check passes
- [ ] Lint passes (warnings OK)
- [ ] Build completes successfully
- [ ] No regressions in existing functionality

---

## Definition of Done

- [ ] All 6 workstreams complete
- [ ] All gates pass (type-check, lint, build)
- [ ] ActivityPanel shows casino-wide active players with search/sort
- [ ] Responsive columns work on desktop/tablet/mobile
- [ ] Row click opens rating slip modal
- [ ] Search filters by player name
- [ ] Sort toggles between recent/alphabetical
- [ ] No regressions in existing PanelContainer functionality
