---
# EXECUTION-SPEC Frontmatter
# Generated by lead-architect skill

prd: ADR-029
prd_title: "Player 360° Dashboard — Interaction Event Taxonomy"
service: PlayerTimelineService
mvp_phase: 1

# Workstream Definitions
# Executor Types: "skill" (Skill tool) or "task-agent" (Task tool with subagent_type)
workstreams:
  WS1-A:
    name: Enum & Extension Setup
    description: Create interaction_event_type enum with 22 event types
    executor: rls-expert
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/20260121145500_adr029_event_taxonomy_enum.sql
    gate: schema-validation
    estimated_complexity: low

  WS1-B:
    name: player_note Table
    description: Create player_note table with RLS policies (ADR-015 Pattern C)
    executor: rls-expert
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/20260121145501_adr029_player_note_table.sql
    gate: schema-validation
    estimated_complexity: medium

  WS1-C:
    name: player_tag Table
    description: Create player_tag table with RLS policies and partial unique index
    executor: rls-expert
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/20260121145502_adr029_player_tag_table.sql
    gate: schema-validation
    estimated_complexity: medium

  WS1-D:
    name: Timeline Indexes (Phase 1)
    description: Composite indexes for keyset pagination on 5 source tables
    executor: rls-expert
    executor_type: skill
    depends_on: [WS1-B, WS1-C]
    outputs:
      - supabase/migrations/20260121145503_adr029_timeline_indexes_phase1.sql
    gate: schema-validation
    estimated_complexity: low

  WS1-E:
    name: rpc_get_player_timeline RPC
    description: SECURITY DEFINER RPC with ADR-024 context and keyset pagination
    executor: rls-expert
    executor_type: skill
    depends_on: [WS1-A, WS1-D]
    outputs:
      - supabase/migrations/20260121145504_adr029_rpc_player_timeline.sql
    gate: schema-validation
    estimated_complexity: high

  WS2-A:
    name: DTOs & Types
    description: Discriminated union types per ADR-029 D9
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1-E]
    outputs:
      - services/player-timeline/dtos.ts
    gate: type-check
    estimated_complexity: medium

  WS2-B:
    name: Mappers & Validation
    description: RPC-to-DTO mappers with metadata validation
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1-E]
    outputs:
      - services/player-timeline/mappers.ts
    gate: type-check
    estimated_complexity: medium

  WS2-C:
    name: CRUD Service
    description: getPlayerTimeline wrapper with error handling
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS2-A, WS2-B]
    outputs:
      - services/player-timeline/crud.ts
      - services/player-timeline/keys.ts
      - services/player-timeline/index.ts
    gate: type-check
    estimated_complexity: medium

  WS2-D:
    name: React Query Hooks
    description: usePlayerTimeline and useInfinitePlayerTimeline hooks
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS2-C]
    outputs:
      - hooks/player-timeline/use-player-timeline.ts
      - hooks/player-timeline/index.ts
    gate: type-check
    estimated_complexity: medium

  WS-UX-A:
    name: Timeline Card Contract
    description: Card types, icon mapping, source categories
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - components/player-360/timeline/types.ts
    gate: type-check
    estimated_complexity: medium

  WS-UX-B:
    name: Filter Contract
    description: Filter types, date presets, filter-to-query mapper
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - components/player-360/timeline/filters.ts
    gate: type-check
    estimated_complexity: medium

  WS-UX-C:
    name: Pagination Contract
    description: Cursor types, hook return types, infinite scroll contract
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - components/player-360/timeline/pagination.ts
    gate: type-check
    estimated_complexity: low

  WS-UX-D:
    name: Panel Layout + States
    description: 3-panel layout, loading/empty/error states
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS-UX-A, WS-UX-B, WS-UX-C]
    outputs:
      - components/player-360/layout.tsx
      - components/player-360/skeletons.tsx
      - components/player-360/empty-states.tsx
    gate: type-check
    estimated_complexity: high

  WS-UX-E:
    name: Collaboration Panel
    description: Notes/tags/share contracts and inline note composer
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS-UX-D]
    outputs:
      - components/player-360/collaboration/panel.tsx
      - components/player-360/collaboration/note-composer.tsx
      - components/player-360/collaboration/tag-chips.tsx
    gate: type-check
    estimated_complexity: high

  WS-UX-F:
    name: Compliance & Snapshot Panels
    description: CTR aggregate, MTL list, snapshot card
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS-UX-D]
    outputs:
      - components/player-360/compliance/panel.tsx
      - components/player-360/snapshot/card.tsx
    gate: type-check
    estimated_complexity: high

  WS3-A:
    name: TypeScript Types Regeneration
    description: Regenerate types after migrations (npm run db:types)
    executor: manual
    executor_type: manual
    depends_on: [WS1-E]
    outputs:
      - types/database.types.ts
    gate: schema-validation
    estimated_complexity: low

  WS3-B:
    name: Integration Tests
    description: Pagination tests, RLS enforcement, event mapping
    executor: qa-specialist
    executor_type: skill
    depends_on: [WS3-A, WS2-D]
    outputs:
      - services/player-timeline/__tests__/timeline.integration.test.ts
    gate: test-pass
    estimated_complexity: medium

  WS3-C:
    name: Baseline Page Rendering
    description: Timeline page with 3-panel layout per UX contracts
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS3-B, WS-UX-D, WS-UX-E, WS-UX-F]
    outputs:
      - app/(dashboard)/players/[playerId]/timeline/page.tsx
    gate: build
    estimated_complexity: high

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Database Layer
    parallel: [WS1-A, WS1-B, WS1-C]
    gates: [schema-validation]
    note: "WS1-D depends on WS1-B/C; WS1-E depends on WS1-A/D (sequential within phase)"

  - name: Phase 2 - Service Layer
    parallel: [WS2-A, WS2-B]
    gates: [type-check]
    note: "WS2-C depends on WS2-A/B; WS2-D depends on WS2-C (sequential within phase)"

  - name: Parallel Track - UX Contracts
    parallel: [WS-UX-A, WS-UX-B, WS-UX-C]
    gates: [type-check]
    note: "Runs concurrent with Phase 1-2; WS-UX-D/E/F depend on A/B/C"

  - name: Phase 3 - Integration
    parallel: [WS3-A]
    gates: [schema-validation, type-check, test-pass, build]
    note: "WS3-B depends on WS3-A; WS3-C depends on WS3-B and UX contracts"

# Validation Gates
gates:
  schema-validation:
    command: npm run db:types
    success_criteria: "Exit code 0, interaction_event_type enum in database.types.ts"

  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0"

  lint:
    command: npm run lint -- services/player-timeline/ components/player-360/
    success_criteria: "Exit code 0, no errors (warnings OK)"

  test-pass:
    command: npm test services/player-timeline/
    success_criteria: "All tests pass"

  build:
    command: npm run build
    success_criteria: "Exit code 0, no build errors"

# Dependencies on other PRDs/Services
external_dependencies:
  - prd: ADR-024
    service: RLSContextService
    required_for: "Authoritative context derivation via set_rls_context_from_staff()"

  - prd: ADR-015
    service: RLSPolicies
    required_for: "Pattern C hybrid RLS policies"

# Risks and Mitigations
risks:
  - risk: "UNION ALL performance with large datasets"
    mitigation: "Phase 1 indexes; EXPLAIN ANALYZE before merge; keyset pagination"

  - risk: "Metadata type drift between RPC and TypeScript"
    mitigation: "Discriminated union types in TS; runtime validation in mapper"

  - risk: "RLS bypass vulnerability"
    mitigation: "SECURITY DEFINER with set_rls_context_from_staff(); read-only guardrail"

  - risk: "Pagination cursor bugs causing duplicates/drops"
    mitigation: "Integration tests for cursor stability across pages"

  - risk: "Backend/UI drift causing rework"
    mitigation: "UX contracts run parallel; Gate 2 validates both before integration"

  - risk: "Engine shape doesn't match UI needs"
    mitigation: "Card + filter contracts constrain RPC response fields before impl"

---

# EXECUTION-SPEC: ADR-029 - Player 360° Dashboard Interaction Event Taxonomy

**ADR Reference:** [ADR-029-player-360-interaction-event-taxonomy.md](../../../80-adrs/ADR-029-player-360-interaction-event-taxonomy.md)
**Status:** In Progress
**Created:** 2026-01-21

---

## Overview

This execution spec implements the Player 360° Dashboard interaction event taxonomy per ADR-029. The implementation creates a unified timeline view of all player interactions using a read-only projection pattern (UNION ALL across source tables) with no physical event store. It also applies the UX constraints defined in [player-360-crm-dashboard-ux-ui-baselines.md](../../../00-vision/player-dashboard/player-360-crm-dashboard-ux-ui-baselines.md) so the data plane and UI contracts stay congruent.

**MVP Scope (Phase 1):** 9 event types from 5 source tables
**Post-MVP (Phase 2):** 13 additional event types

---

## Scope

- **In Scope**:
  - `interaction_event_type` enum with 22 event types
  - `player_note` and `player_tag` tables with RLS policies
  - `rpc_get_player_timeline` RPC with keyset pagination
  - Service layer (DTOs, mappers, CRUD, hooks)
  - UX contracts (timeline cards, filters, pagination, panels)
  - Integration tests and baseline page rendering

- **Out of Scope**:
  - Supabase Realtime subscriptions (deferred)
  - Advanced session clustering by visit_id (deferred)
  - Pixel-perfect styling polish (deferred)
  - Smart insights beyond deltas (deferred)

---

## Architecture Context

- **SRM Entry**: PlayerTimelineService (bounded context: player-timeline)
- **Key ADRs**:
  - ADR-029: Interaction event taxonomy and UNION ALL projection pattern
  - ADR-024: Authoritative context derivation via `set_rls_context_from_staff()`
  - ADR-015: Pattern C hybrid RLS policies
- **UX Baseline**: [player-360-crm-dashboard-ux-ui-baselines.md](../../../00-vision/player-dashboard/player-360-crm-dashboard-ux-ui-baselines.md)

---

## Workstream Dependency Graph

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PHASE 1: DATABASE LAYER                       │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  WS1-A: Enum & Extension     WS1-B: player_note Table               │
│  (uuid-ossp, enum)           (schema + RLS)                         │
│         │                           │                                │
│         │                           │        WS1-C: player_tag Table │
│         │                           │        (schema + RLS)          │
│         │                           │               │                │
│         └───────────┬───────────────┴───────────────┘                │
│                     │                                                │
│                     ▼                                                │
│              WS1-D: Timeline Indexes (Phase 1 sources)               │
│                     │                                                │
│                     ▼                                                │
│              WS1-E: rpc_get_player_timeline RPC                      │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
        │                                                    ║
        │                           ╔════════════════════════╬════════════════════════╗
        │                           ║    PARALLEL: UX CONTRACTS (constrains engine)   ║
        │                           ╠═════════════════════════════════════════════════╣
        │                           ║                                                 ║
        │                           ║  WS-UX-A: Timeline Card Contract                ║
        │                           ║  WS-UX-B: Filter Contract                       ║
        │                           ║  WS-UX-C: Pagination Contract                   ║
        │                           ║  WS-UX-D: Panel Layout + States                 ║
        │                           ║  WS-UX-E: Collaboration Panel                   ║
        │                           ║  WS-UX-F: Compliance + Snapshot Panels          ║
        │                           ║                                                 ║
        │                           ╚═════════════════════════════════════════════════╝
        │                                                    ║
        ▼ GATE 1: DB Migration Validation                    ║
┌─────────────────────────────────────────────────────────────────────┐
│                      PHASE 2: SERVICE LAYER                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  WS2-A: DTOs & Types         WS2-B: Mappers & Validation            │
│  (dtos.ts)                   (mappers.ts)                           │
│         │                           │                                │
│         └───────────┬───────────────┘                                │
│                     │                                                │
│                     ▼                                                │
│              WS2-C: CRUD Service (crud.ts)                           │
│                     │                                                │
│                     ▼                                                │
│              WS2-D: React Query Hooks                                │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼ GATE 2: Service Layer + UX Contracts Validation
┌─────────────────────────────────────────────────────────────────────┐
│                      PHASE 3: INTEGRATION                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  WS3-A: TypeScript Types Regeneration (npm run db:types)            │
│                     │                                                │
│                     ▼                                                │
│  WS3-B: Integration Tests (pagination, event mapping)               │
│                     │                                                │
│                     ▼                                                │
│  WS3-C: Minimal Page Rendering (timeline list + pagination)         │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼ GATE 3: Integration Validation
```

---

## Workstream Details

### WS1-A: Enum & Extension Setup

**Purpose**: Create `interaction_event_type` enum with 22 event types.

**Deliverables**:
1. Migration file with enum definition
2. All 22 event types per ADR-029

**Acceptance Criteria**:
- [ ] `npm run db:types` succeeds
- [ ] Enum appears in `database.types.ts`

---

### WS1-B: player_note Table

**Purpose**: Create `player_note` table for staff notes on players.

**Deliverables**:
1. Table with `id`, `casino_id`, `player_id`, `created_by`, `content`, `visibility`, `created_at`
2. RLS policies (ADR-015 Pattern C)
3. Append-only (deny update/delete)

**Acceptance Criteria**:
- [ ] RLS policies cover SELECT, INSERT
- [ ] UPDATE and DELETE denied
- [ ] Visibility enum (`private`, `team`, `all`)

---

### WS1-C: player_tag Table

**Purpose**: Create `player_tag` table for tagging players.

**Deliverables**:
1. Table with soft-delete pattern (`removed_at`, `removed_by`)
2. Partial unique index for active tags
3. RLS policies (ADR-015 Pattern C)

**Acceptance Criteria**:
- [ ] Partial unique index prevents duplicate active tags
- [ ] RLS policies cover SELECT, INSERT, UPDATE
- [ ] DELETE denied (use soft-delete)

---

### WS1-D: Timeline Indexes (Phase 1)

**Purpose**: Create composite indexes for keyset pagination on 5 source tables.

**Deliverables**:
1. Indexes on: `visit`, `rating_slip`, `player_financial_transaction`, `loyalty_ledger`, `mtl_entry`
2. Pattern: `(casino_id, player_id, timestamp DESC, id DESC)`

**Acceptance Criteria**:
- [ ] All 5 indexes created with `CONCURRENTLY`
- [ ] Index patterns support keyset pagination

---

### WS1-E: rpc_get_player_timeline RPC

**Purpose**: Create SECURITY DEFINER RPC for unified timeline retrieval.

**Deliverables**:
1. RPC with keyset pagination
2. `set_rls_context_from_staff()` call for ADR-024 compliance
3. Read-only guardrail
4. Phase 1 event types in UNION ALL

**Acceptance Criteria**:
- [ ] Uses `set_rls_context_from_staff()` (not spoofable parameters)
- [ ] `search_path = public`
- [ ] `SET default_transaction_read_only = on`
- [ ] Returns: `event_id`, `event_type`, `occurred_at`, `source_id`, `source_table`, `summary`, `metadata`, `actor_id`, `actor_name`

---

### WS2-A: DTOs & Types

**Purpose**: Create discriminated union types for timeline events.

**Deliverables**:
1. `InteractionEventType` union type
2. `InteractionEventDTO` with discriminated metadata
3. `TimelineQuery` and `TimelineResponse` types

**Acceptance Criteria**:
- [ ] All 22 event types in union
- [ ] Metadata types per event category
- [ ] Cursor pagination types

---

### WS2-B: Mappers & Validation

**Purpose**: Map RPC results to DTOs with metadata validation.

**Deliverables**:
1. `mapRpcRowToEvent` function
2. `mapRpcResultToTimelineResponse` function
3. Source category and icon helpers

**Acceptance Criteria**:
- [ ] Runtime validation of metadata per event type
- [ ] Graceful handling of unknown event types

---

### WS2-C: CRUD Service

**Purpose**: Implement `getPlayerTimeline` wrapper with error handling.

**Deliverables**:
1. `crud.ts` with RPC call
2. `keys.ts` with query key factory
3. `index.ts` service exports

**Acceptance Criteria**:
- [ ] Error mapping to `DomainError`
- [ ] Key factory follows project pattern

---

### WS2-D: React Query Hooks

**Purpose**: Provide client-side data fetching hooks.

**Deliverables**:
1. `usePlayerTimeline` query hook
2. `useInfinitePlayerTimeline` for infinite scroll

**Acceptance Criteria**:
- [ ] Uses key factory from `keys.ts`
- [ ] Proper staleTime configuration
- [ ] Infinite scroll with `getNextPageParam`

---

### WS-UX-A: Timeline Card Contract

**Purpose**: Define card types for collapsed/expanded timeline rendering.

**Deliverables**:
1. `TimelineCardCollapsed` and `TimelineCardExpanded` interfaces
2. `SourceCategory` type and mapping function
3. `EVENT_ICON_MAP` constant

**Acceptance Criteria**:
- [ ] All 22 event types have icon mapping
- [ ] Source categories match RPC response

---

### WS-UX-B: Filter Contract

**Purpose**: Define filter UI that maps to RPC parameters.

**Deliverables**:
1. `TimelineFilters` interface
2. `DatePreset` type with gaming day support
3. `filtersToQuery` mapper function

**Acceptance Criteria**:
- [ ] Event type chips grouped by source category
- [ ] Date presets include gaming day

---

### WS-UX-C: Pagination Contract

**Purpose**: Confirm UI consumes RPC pagination correctly.

**Deliverables**:
1. `PaginationCursor` interface
2. `UseTimelineResult` hook return type
3. Pagination behavior documentation

**Acceptance Criteria**:
- [ ] Matches RPC cursor semantics
- [ ] Infinite scroll pattern documented

---

### WS-UX-D: Panel Layout + States

**Purpose**: Define 3-panel layout and state handling.

**Deliverables**:
1. Layout component structure
2. Loading skeleton components
3. Empty and error state components

**Acceptance Criteria**:
- [ ] Sticky header
- [ ] Left rail, center timeline, right collaboration rail
- [ ] All panel states (loading, empty, error, success)

---

### WS-UX-E: Collaboration Panel

**Purpose**: Implement right-rail collaboration features.

**Deliverables**:
1. Inline note composer
2. Tag chip interactions
3. Share-to-shift CTA

**Acceptance Criteria**:
- [ ] Note visibility selection
- [ ] Tag apply/remove with confirmation
- [ ] Snapshot payload type for sharing

---

### WS-UX-F: Compliance & Snapshot Panels

**Purpose**: Implement compliance and shareable snapshot features.

**Deliverables**:
1. Compliance panel with CTR progress
2. MTL event list with drill-down
3. Shareable snapshot card

**Acceptance Criteria**:
- [ ] CTR shown as aggregate metric
- [ ] Snapshot card reusable across dashboards

---

### WS3-A: TypeScript Types Regeneration

**Purpose**: Regenerate types after migrations.

**Command**: `npm run db:types`

**Acceptance Criteria**:
- [ ] `interaction_event_type` enum in types
- [ ] `player_note` and `player_tag` tables in types
- [ ] RPC types available

---

### WS3-B: Integration Tests

**Purpose**: Validate pagination and RLS enforcement.

**Test Cases**:
1. Keyset pagination: no duplicates, no drops
2. Event type filtering works
3. Date range filtering works
4. RLS: cannot access other casino's players
5. Actor name resolution

**Acceptance Criteria**:
- [ ] All tests pass
- [ ] Coverage for happy path and error cases

---

### WS3-C: Baseline Page Rendering

**Purpose**: Implement timeline page with 3-panel layout.

**Deliverables**:
1. Page route at `/players/[playerId]/timeline`
2. Integration of all UX contracts
3. Working pagination

**Acceptance Criteria**:
- [ ] Sticky header with player identity
- [ ] Metrics rail with KPI tiles
- [ ] Timeline with filter bar and virtualization
- [ ] Collaboration rail with notes/tags
- [ ] Compliance panel accessible

---

## Definition of Done

### Gate 1: Database Layer

- [ ] `interaction_event_type` enum created
- [ ] `player_note` table created with RLS policies
- [ ] `player_tag` table created with RLS policies
- [ ] Phase 1 timeline indexes created on 5 source tables
- [ ] `rpc_get_player_timeline` returns unified events
- [ ] RPC uses `set_rls_context_from_staff()` (ADR-024 compliant)
- [ ] RPC has read-only guardrail

### Gate 2: Service Layer + UX Contracts

- [ ] `services/player-timeline/dtos.ts` with discriminated union metadata
- [ ] `services/player-timeline/mappers.ts` with validation
- [ ] `services/player-timeline/crud.ts` with error handling
- [ ] React Query hooks for timeline data
- [ ] Timeline card contract defined (collapsed/expanded fields)
- [ ] Source chip + icon mapping per event_type
- [ ] Filter contract with event type chips + date presets
- [ ] Pagination cursor consumption verified
- [ ] 3-panel layout wireframe + loading/empty/error states
- [ ] Collaboration panel + quick action contract
- [ ] Compliance panel + snapshot card contract

### Gate 3: Integration

- [ ] TypeScript types regenerated (`npm run db:types`)
- [ ] Integration tests pass for pagination
- [ ] Performance benchmark: < 500ms for 500 events
- [ ] Baseline page rendering works end-to-end
- [ ] Filter bar + virtualization + pagination match UX baseline

---

## References

- ADR: [ADR-029-player-360-interaction-event-taxonomy.md](../../../80-adrs/ADR-029-player-360-interaction-event-taxonomy.md)
- Event Taxonomy: [PLAYER_360_EVENT_TAXONOMY.md](../../../25-api-data/PLAYER_360_EVENT_TAXONOMY.md)
- RLS Pattern: [ADR-024_DECISIONS.md](../../../80-adrs/ADR-024_DECISIONS.md)
- Vision: [player-360-dashboard-mvp-outline.md](../../../00-vision/player-dashboard/player-360-dashboard-mvp-outline.md)
- UX Baseline: [player-360-crm-dashboard-ux-ui-baselines.md](../../../00-vision/player-dashboard/player-360-crm-dashboard-ux-ui-baselines.md)
