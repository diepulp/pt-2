---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline (lead-architect scaffold + expert refinements)

prd: ADR-031
prd_title: "Financial Amount Convention — Cents Storage, Dollars at Service Boundary"
# service: Cross-cutting (all bounded contexts with financial fields)
mvp_phase: 1

workstreams:
  WS1:
    name: Formatting Functions & Deprecation
    description: Add formatDollars/formatCents/formatDollarsDelta/formatCentsDelta to lib/format.ts, deprecate formatCurrency/formatCurrencyDelta, add unit tests
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - lib/format.ts
      - lib/__tests__/format.test.ts
    gate: type-check
    estimated_complexity: low

  WS2:
    name: SQL Column Comments Migration
    description: Create migration with COMMENT ON COLUMN for all financial columns per ADR-031 Rule 5
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/20260202011751_adr031_financial_column_comments.sql
    gate: schema-validation
    estimated_complexity: low

  WS3:
    name: DTO Unit Annotations
    description: Add JSDoc unit annotations to financial DTO fields across 5 services per ADR-031 Rule 4
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - services/dtos-jsdoc-annotations.md
    gate: type-check
    estimated_complexity: low

  WS4:
    name: Component Migration
    description: Replace formatCurrency/formatCurrencyDelta with formatCents/formatDollars across all UI components
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - components/shift-dashboard-v3/center/metrics-table.tsx
      - components/shift-dashboard-v3/left-rail/hero-win-loss-compact.tsx
      - components/shift-dashboard-v3/left-rail/secondary-kpi-stack.tsx
      - components/shift-dashboard-v3/right-rail/telemetry-rail-panel.tsx
      - components/shift-dashboard-v3/center/alerts-strip.tsx
      - components/shift-dashboard-v3/charts/win-loss-trend-chart.tsx
      - components/mtl/entry-detail.tsx
      - components/mtl/entry-list.tsx
      - components/mtl/gaming-day-summary.tsx
      - components/mtl/mtl-entry-form.tsx
      - components/mtl/mtl-entry-view-modal.tsx
      - components/shift-dashboard/alerts-panel.tsx
      - components/shift-dashboard/cash-observations-panel.tsx
      - components/shift-dashboard/pit-metrics-table.tsx
      - components/shift-dashboard/table-metrics-table.tsx
      - components/pit-panels/closed-sessions-panel.tsx
      - components/table/rundown-summary-panel.tsx
    gate: type-check
    estimated_complexity: medium

  WS5:
    name: Quality Validation
    description: Full build, type-check, lint, and test suite validation after all changes
    executor: qa-specialist
    executor_type: skill
    depends_on: [WS1, WS2, WS3, WS4]
    outputs: []
    gate: build
    estimated_complexity: low

execution_phases:
  - name: "Phase 1 — Foundation (Parallel)"
    parallel: [WS1, WS2, WS3]
    gates: [type-check, schema-validation]

  - name: "Phase 2 — Component Migration"
    parallel: [WS4]
    gates: [type-check]

  - name: "Phase 3 — Quality Validation"
    parallel: [WS5]
    gates: [build, test-pass]

gates:
  schema-validation:
    command: npm run db:types
    success_criteria: "Exit code 0, types regenerated successfully"

  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0, no type errors"

  lint:
    command: npm run lint
    success_criteria: "Exit code 0"

  test-pass:
    command: npm test lib/__tests__/format.test.ts
    success_criteria: "All formatting tests pass"

  build:
    command: npm run build
    success_criteria: "Exit code 0, no build errors"

external_dependencies: []

risks:
  - risk: "formatCurrency callers passing dollars (not cents) will produce wrong results until migrated"
    mitigation: "WS4 migrates all callers; @deprecated tag flags unmigrated usage"
  - risk: "pit_cash_observation.amount unit is ambiguous"
    mitigation: "WS2 resolves by inspecting write path (CreatePitCashObservationInput says dollars)"

---

# EXECUTION-SPEC: ADR-031 — Financial Amount Convention

## Overview

Implement ADR-031 across the PT-2 codebase: standardize financial amount formatting, document storage units at the SQL level, annotate all DTO financial fields, and migrate all component callers from the ambiguous `formatCurrency()` to the explicit `formatDollars()` / `formatCents()` API.

**Triggered by**: Three production display bugs (2026-01-29, 2026-02-02) caused by undocumented cents-vs-dollars conventions.

## Scope

- **In Scope**:
  - New formatting functions in `lib/format.ts` (Rule 3)
  - SQL `COMMENT ON COLUMN` migration for all financial columns (Rule 5)
  - JSDoc unit annotations on ~20 DTO fields across 5 services (Rule 4)
  - Mechanical migration of ~41 component files from `formatCurrency` → `formatCents`/`formatDollars`
  - Deprecation of `formatCurrency` and `formatCurrencyDelta`

- **Out of Scope**:
  - Branded types (`Cents` / `Dollars`) — deferred per ADR-031 Future Work
  - Service-layer conversion restructuring — existing `_cents` DTO convention is compliant
  - Schema changes to existing columns — no data migration
  - New tables or RLS policies

## Architecture Context

- **SRM Impact**: None — no ownership changes, no new tables
- **ADR-031 Rules Implemented**: Rule 3 (formatting API), Rule 4 (DTO annotations), Rule 5 (SQL comments)
- **ADR-031 Rules Established** (enforcement going forward): Rule 1 (cents storage), Rule 2 (service-layer boundary)

---

## Workstream Details

### WS1: Formatting Functions & Deprecation

**Purpose**: Create unambiguous formatting API per ADR-031 Rule 3.

**Current state**: `lib/format.ts` has `formatCurrency(cents)` and `formatCurrencyDelta(cents)` — both take cents, convert to dollars internally, and format. The function name does not indicate the expected input unit.

**Deliverables**:

1. **`formatDollars(dollars)`** — Formats a dollar amount directly (no conversion). New behavior.
2. **`formatCents(cents)`** — Converts cents to dollars, then formats. Same logic as current `formatCurrency`.
3. **`formatDollarsDelta(dollars)`** — Signed dollar display (no conversion).
4. **`formatCentsDelta(cents)`** — Converts cents then signed display. Same logic as current `formatCurrencyDelta`.
5. **Deprecate** `formatCurrency` / `formatCurrencyDelta` with `@deprecated` JSDoc pointing to replacements.
6. **Unit tests** in `lib/__tests__/format.test.ts`:
   - `formatDollars(100)` → `"$100"`, `formatCents(10000)` → `"$100"` (equivalence)
   - Null/undefined → `"$0"`
   - Negative values, zero, large values
   - Delta variants with sign display

**Patterns**: `Intl.NumberFormat` (matches existing), `@deprecated` JSDoc tag.

**Acceptance Criteria**:
- [ ] All 4 new functions exported from `lib/format.ts`
- [ ] `formatCurrency` has `@deprecated Use formatCents() or formatDollars() instead` JSDoc
- [ ] `formatCurrencyDelta` has matching `@deprecated` JSDoc
- [ ] `npm run type-check` passes
- [ ] `npm test lib/__tests__/format.test.ts` passes with 100% coverage of new functions

---

### WS2: SQL Column Comments Migration

**Purpose**: Document financial column units at the database level per ADR-031 Rule 5.

**Deliverables**:

1. Migration `supabase/migrations/20260202011751_adr031_financial_column_comments.sql` with:

```sql
-- player_financial_transaction.amount
COMMENT ON COLUMN player_financial_transaction.amount IS
  'Transaction amount in cents (1 dollar = 100). Positive for buy-ins, negative for adjustments.';

-- mtl_entry.amount
COMMENT ON COLUMN mtl_entry.amount IS
  'Transaction amount in cents (1 dollar = 100) per ISSUE-FB8EB717 standardization.';

-- table_buyin_telemetry.amount_cents
COMMENT ON COLUMN table_buyin_telemetry.amount_cents IS
  'Buy-in amount in cents (1 dollar = 100).';

-- rating_slip.average_bet
COMMENT ON COLUMN rating_slip.average_bet IS
  'Average bet in dollars. Stored as-is from user input (not cents). Grandfathered per ADR-031.';

-- pit_cash_observation.amount
COMMENT ON COLUMN pit_cash_observation.amount IS
  'Observed cash amount in dollars. Pit boss observations stored in dollars per CreatePitCashObservationInput contract.';

-- visit_financial_summary view columns
COMMENT ON COLUMN visit_financial_summary.total_in IS
  'Total amount IN in cents (aggregated from player_financial_transaction.amount).';
COMMENT ON COLUMN visit_financial_summary.total_out IS
  'Total amount OUT in cents (aggregated from player_financial_transaction.amount).';
COMMENT ON COLUMN visit_financial_summary.net_amount IS
  'Net amount in cents (total_in - total_out).';
```

**Acceptance Criteria**:
- [ ] Migration follows `YYYYMMDDHHMMSS_description.sql` naming
- [ ] Migration header references ADR-031
- [ ] `NOTIFY pgrst, 'reload schema'` at end
- [ ] `npm run db:types` succeeds (schema gate)
- [ ] `pit_cash_observation.amount` resolved as dollars (per `CreatePitCashObservationInput` JSDoc)

---

### WS3: DTO Unit Annotations

**Purpose**: Ensure every financial `number` field in DTOs has unit documentation per ADR-031 Rule 4.

**Deliverables** (JSDoc additions only — no runtime changes):

**`services/visit/dtos.ts`** (6 fields):
- `VisitLiveViewDTO.session_total_buy_in` — `/** Total buy-in amount in dollars (converted from cents at service layer) */`
- `VisitLiveViewDTO.session_total_cash_out` — `/** Total cash-out amount in dollars (converted from cents at service layer) */`
- `VisitLiveViewDTO.session_net` — `/** Net amount in dollars (buy_in - cash_out, converted at service layer) */`
- `VisitLiveViewDTO.current_segment_average_bet` — `/** Current average bet in dollars (stored as dollars in rating_slip) */`
- `RecentSessionDTO.total_buy_in` / `total_cash_out` / `net` — `/** Amount in dollars (converted from cents at service layer) */`
- `LastSessionContextDTO.last_average_bet` — `/** Last average bet in dollars */`

**`services/rating-slip/dtos.ts`** (4 fields):
- `RatingSlipDTO.average_bet` — `/** Average bet in dollars (stored as dollars, not cents) */`
- `PitCashObservationDTO.amount` — `/** Observed cash amount in dollars */`
- `ActivePlayerForDashboardDTO.averageBet` — `/** Average bet in dollars */`
- `ClosedSlipForGamingDayDTO.average_bet` — `/** Average bet in dollars */`

**`services/player-financial/dtos.ts`** (7 fields):
- `FinancialTransactionDTO.amount` — `/** Transaction amount in cents (1 dollar = 100) */`
- `VisitFinancialSummaryDTO.total_in` / `total_out` / `net_amount` — `/** Amount in cents */`
- `CreateFinancialTxnInput.amount` — `/** Transaction amount in cents (positive number) */`
- `CreateFinancialAdjustmentInput.delta_amount` — `/** Delta amount in cents (signed) */`
- `VisitCashInWithAdjustmentsDTO` fields — `/** Amount in cents */`

**`services/player-timeline/dtos.ts`** (3 fields):
- `InteractionEventDTO.amount` — `/** Monetary amount in dollars or loyalty points; unit depends on eventType */`
- `RpcTimelineRow.amount` — `/** Raw amount from RPC — dollars for financial events, points for loyalty */`
- `PromoEventMetadata.amount` — `/** Promo amount in dollars */`

**`services/casino/dtos.ts`** (2 fields):
- `CasinoSettingsDTO.watchlist_floor` — `/** MTL watchlist threshold in cents (default 300000 = $3,000) */`
- `CasinoSettingsDTO.ctr_threshold` — `/** CTR reporting threshold in cents (default 1000000 = $10,000) */`

**No changes needed**:
- `services/table-context/shift-metrics/dtos.ts` — all 29 fields already use `_cents` suffix
- `services/mtl/dtos.ts` — already has `CENTS per ISSUE-FB8EB717` annotations

**Acceptance Criteria**:
- [ ] Every financial `number` field in listed DTOs has unit documentation
- [ ] `npm run type-check` passes (JSDoc-only changes, no runtime impact)

---

### WS4: Component Migration

**Purpose**: Replace all `formatCurrency()` / `formatCurrencyDelta()` calls with the correct explicit function per ADR-031 Rule 3.

**Migration Rules by Component Group**:

| Component Group | Current Pattern | Target Function | Rationale |
|-----------------|-----------------|-----------------|-----------|
| Shift Dashboard V3 (6 files) | `formatCurrency(pit.fills_total_cents)` | `formatCents(pit.fills_total_cents)` | DTO fields have `_cents` suffix |
| Shift Dashboard V2 (4 files) | `formatCurrency(pit.fills_total_cents)` | `formatCents(pit.fills_total_cents)` | Same `_cents` suffix pattern |
| MTL components (5 files) | Manual `/100` + `toLocaleString` | `formatCents(amountCents)` | Replace manual conversion with `formatCents` |
| Pit panels (1 file) | `formatCurrency(...)` | `formatCents(...)` | Consumes `_cents` DTO fields |
| Table rundown (1 file) | `formatCurrency(dropCents)` + manual `/100` | `formatCents(dropCents)` | Replace manual conversion |
| Review/app routes | `formatCurrency(...)` | `formatCents(...)` or `formatDollars(...)` | Depends on data source |

**Key Decision**: Components consuming `_cents`-suffixed DTO fields use `formatCents()`. Components receiving dollars from service-layer conversion use `formatDollars()`. This is determined per-file by inspecting the data source.

**Import Change** (all migrated files):
```typescript
// Before
import { formatCurrency } from '@/lib/format';
// After
import { formatCents } from '@/lib/format';
// Or for dollar values:
import { formatDollars } from '@/lib/format';
```

**Deliverables**:
1. Update all shift-dashboard-v3 components (6 files): `formatCurrency` → `formatCents`
2. Update MTL components (5 files): replace manual `/100` + `toLocaleString` with `formatCents`
3. Update shift-dashboard v2 components (4 files): `formatCurrency` → `formatCents`
4. Update pit-panels, table components (2 files): `formatCurrency` → `formatCents`
5. Update remaining callers across `app/review/` and other paths
6. Update `formatCurrencyDelta` → `formatCentsDelta` where used

**Acceptance Criteria**:
- [ ] Zero remaining imports of `formatCurrency` in production code
- [ ] Zero remaining imports of `formatCurrencyDelta` in production code
- [ ] Zero remaining manual `/100` financial conversions in components
- [ ] `npm run type-check` passes
- [ ] `npm run lint` passes
- [ ] No visual regressions (output values unchanged — same formatting logic)

---

### WS5: Quality Validation

**Purpose**: Full regression sweep after all ADR-031 changes.

**Gate Sequence**:

1. **Type Check**: `npm run type-check` — verify all TypeScript compiles
2. **Lint**: `npm run lint` — verify no lint errors
3. **Unit Tests**: `npm test` — verify no regressions in existing tests + new format tests pass
4. **Build**: `npm run build` — verify production build succeeds

**Regression Risks**:
- Components that were passing dollars to `formatCurrency` (which expected cents) would have been silently producing wrong values. Migration to `formatDollars` fixes this — verify output values are correct.
- MTL components replacing manual `/100 + toLocaleString` with `formatCents` may have minor formatting differences (e.g., `$3,000` vs `$3000.00`). Verify `Intl.NumberFormat` output matches expectations.
- Test files that reference `formatCurrency` in assertions need updating.

**Acceptance Criteria**:
- [ ] `npm run type-check` — exit 0
- [ ] `npm run lint` — exit 0
- [ ] `npm test` — all tests pass, no regressions
- [ ] `npm run build` — exit 0

---

## Definition of Done

- [ ] All 5 workstreams complete
- [ ] All gates pass (type-check, schema-validation, lint, test-pass, build)
- [ ] Zero `formatCurrency` imports remaining in production code
- [ ] Every financial column has SQL `COMMENT ON COLUMN`
- [ ] Every financial DTO field has unit documentation (suffix or JSDoc)
- [ ] ADR-031 status updated from "Proposed" to "Accepted"
- [ ] No regressions in existing test suite
