---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline for Table Rundown Read Model

prd: ADDENDUM-TBL-RUNDOWN
prd_title: "Table Inventory Rundown Read Model (Shift Table Metrics)"
service: TableContext
mvp_phase: 2
source_doc: "docs/00-vision/table-context-read-model/ADDENDUM_TABLE_RUNDOWN_READMODEL_v0.3_PATCH.md"
version: "v0.4.0-PATCH"

workstreams:
  WS1:
    name: Database Layer - table_buyin_telemetry
    description: Create table_buyin_telemetry table for unified rated + grind buy-in tracking
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/*_table_buyin_telemetry.sql
    gate: schema-validation
    estimated_complexity: medium

  WS2:
    name: Logging RPC - rpc_log_table_buyin_telemetry
    description: ADR-024 compliant RPC for logging buy-in telemetry events
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - supabase/migrations/*_rpc_log_table_buyin_telemetry.sql
    gate: schema-validation
    estimated_complexity: medium

  WS3:
    name: SQL Helper - chipset_total_cents
    description: SQL function to aggregate chipset JSONB to total cents for snapshot totals
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/*_chipset_total_cents_helper.sql
    gate: schema-validation
    estimated_complexity: low

  WS4:
    name: Shift Table Metrics RPC
    description: RPC to compute per-table shift metrics with dual-stream win/loss
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1, WS2, WS3]
    outputs:
      - supabase/migrations/*_rpc_shift_table_metrics.sql
    gate: schema-validation
    estimated_complexity: high

  WS5:
    name: Pit/Casino Rollup RPCs
    description: Rollup RPCs for pit-level and casino-level shift metrics aggregation
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS4]
    outputs:
      - supabase/migrations/*_rpc_shift_rollups.sql
    gate: schema-validation
    estimated_complexity: medium

  WS6:
    name: Integration Tests
    description: Integration tests for shift metrics RPCs
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS4, WS5]
    outputs:
      - __tests__/services/table-context/shift-metrics.int.test.ts
    gate: test-pass
    estimated_complexity: medium

execution_phases:
  - name: Phase 1 - Foundation
    parallel: [WS1, WS3]
    gates: [schema-validation]

  - name: Phase 2 - Telemetry RPC
    parallel: [WS2]
    gates: [schema-validation]

  - name: Phase 3 - Table Metrics
    parallel: [WS4]
    gates: [schema-validation]

  - name: Phase 4 - Rollups
    parallel: [WS5]
    gates: [schema-validation]

  - name: Phase 5 - Tests
    parallel: [WS6]
    gates: [test-pass]

gates:
  schema-validation:
    command: npm run db:types
    success_criteria: "Exit code 0, no type errors"

  test-pass:
    command: npm test __tests__/services/table-context/shift-metrics
    success_criteria: "All tests pass"

external_dependencies:
  - table: table_inventory_snapshot
    service: TableContext
    required_for: "Opening/closing bankroll snapshots"

  - table: table_fill
    service: TableContext
    required_for: "Fill aggregation in shift metrics"

  - table: table_credit
    service: TableContext
    required_for: "Credit aggregation in shift metrics"

  - table: gaming_table
    service: TableContext
    required_for: "Table enumeration and pit association"

  - function: set_rls_context_from_staff
    service: Security
    required_for: "ADR-024 compliant context injection"

risks:
  - risk: "Performance of chipset JSONB aggregation at scale"
    mitigation: "Use SQL helper function; monitor query plans; consider materialized column if needed"

  - risk: "Telemetry coverage depends on pit boss adoption of grind logging"
    mitigation: "telemetry_quality flag exposes coverage gaps; UX designed for fast one-tap logging"

  - risk: "Shift window boundaries may not align with snapshots"
    mitigation: "Metrics return missing_opening_snapshot/missing_closing_snapshot flags"

---

# EXECUTION-SPEC: ADDENDUM-TBL-RUNDOWN - Table Inventory Rundown Read Model

## Overview

This EXECUTION-SPEC implements the **Table Inventory Rundown Read Model** as defined in the v0.4.0-PATCH addendum. It extends the TableContext bounded context with:

1. **Buy-in telemetry infrastructure** - `table_buyin_telemetry` table supporting both rated and grind (anonymous) buy-ins
2. **Read model RPCs** - Shift metrics computation with dual-stream win/loss (inventory-based + telemetry-estimated)
3. **Rollup aggregations** - Pit and casino level summaries

## Scope

### In Scope
- `table_buyin_telemetry` table with RLS policies
- `rpc_log_table_buyin_telemetry` - ADR-024 compliant logging
- `chipset_total_cents(jsonb)` - SQL helper for snapshot totals
- `rpc_shift_table_metrics(p_window_start, p_window_end)` - Per-table metrics
- `rpc_shift_pit_metrics(...)` - Pit-level rollup
- `rpc_shift_casino_metrics(...)` - Casino-level rollup
- Integration tests for RPCs

### Out of Scope (Deferred to Phase 4 UI)
- Table card "Log Grind" button UI
- Rating slip panel "Grind" button
- "Undo last grind" functionality
- Count room integration (`table_drop_count_result`)
- `win_loss_stat_cents` / `metric_grade = 'FINAL'`

## Architecture Context

**Bounded Context**: TableContext
**Related ADRs**: ADR-024 (RLS Context Injection)
**Source Document**: `docs/00-vision/table-context-read-model/ADDENDUM_TABLE_RUNDOWN_READMODEL_v0.3_PATCH.md`

### Key Design Decisions

1. **Unified telemetry table**: `table_buyin_telemetry` replaces `player_financial_transaction` as the source for estimated drop. Direct `table_id` FK eliminates JOIN complexity.

2. **Dual-stream metrics**:
   - `win_loss_inventory_cents` = (closing - opening) + fills - credits
   - `win_loss_estimated_cents` = inventory + estimated_drop_buyins

3. **Telemetry quality**: Based on grind tracking activity:
   - `GOOD_COVERAGE` if grind_count > 0
   - `LOW_COVERAGE` if only rated buy-ins
   - `NONE` if no telemetry

4. **MVP estimate-only**: `metric_grade = 'ESTIMATE'` always (count room deferred)

---

## Workstream Details

### WS1: Database Layer - table_buyin_telemetry

**Purpose**: Create the unified telemetry table for all buy-in observations at the table level.

**Schema**:
```sql
CREATE TABLE table_buyin_telemetry (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  casino_id uuid NOT NULL REFERENCES casino(id),
  gaming_day date NOT NULL,
  table_id uuid NOT NULL REFERENCES gaming_table(id),
  visit_id uuid NULL REFERENCES visit(id),
  rating_slip_id uuid NULL REFERENCES rating_slip(id),
  amount_cents bigint NOT NULL CHECK (amount_cents > 0),
  telemetry_kind text NOT NULL,  -- 'RATED_BUYIN' | 'GRIND_BUYIN'
  tender_type text NULL,
  occurred_at timestamptz NOT NULL DEFAULT now(),
  actor_id uuid NOT NULL REFERENCES staff(id),
  note text NULL,
  idempotency_key text NULL,
  created_at timestamptz NOT NULL DEFAULT now(),
  CONSTRAINT unique_idempotency UNIQUE (casino_id, idempotency_key)
    WHERE idempotency_key IS NOT NULL
);

-- Indexes
CREATE INDEX idx_tbt_table_window ON table_buyin_telemetry (casino_id, table_id, occurred_at);
CREATE INDEX idx_tbt_gaming_day ON table_buyin_telemetry (casino_id, gaming_day, table_id);
CREATE INDEX idx_tbt_visit ON table_buyin_telemetry (casino_id, visit_id, occurred_at)
  WHERE visit_id IS NOT NULL;
```

**RLS Policies**:
- SELECT: `casino_id = current_setting('app.casino_id')::uuid`
- INSERT: Via RPC only (SECURITY DEFINER)

**Deliverables**:
- [ ] Migration file with table, indexes, RLS policies
- [ ] `npm run db:types` succeeds

---

### WS2: Logging RPC - rpc_log_table_buyin_telemetry

**Purpose**: ADR-024 compliant RPC for logging buy-in telemetry events.

**Signature**:
```sql
rpc_log_table_buyin_telemetry(
  p_table_id uuid,
  p_amount_cents bigint,
  p_telemetry_kind text,
  p_visit_id uuid DEFAULT NULL,
  p_rating_slip_id uuid DEFAULT NULL,
  p_tender_type text DEFAULT NULL,
  p_note text DEFAULT NULL,
  p_idempotency_key text DEFAULT NULL
) RETURNS table_buyin_telemetry
```

**Implementation Pattern**:
```sql
PERFORM set_rls_context_from_staff();

v_casino_id := current_setting('app.casino_id')::uuid;
v_actor_id := current_setting('app.actor_id')::uuid;
v_gaming_day := compute_gaming_day(v_casino_id);

INSERT INTO table_buyin_telemetry (...)
RETURNING *;
```

**Validation**:
- p_amount_cents > 0
- p_telemetry_kind IN ('RATED_BUYIN', 'GRIND_BUYIN')
- For RATED_BUYIN: p_visit_id and p_rating_slip_id required
- For GRIND_BUYIN: p_visit_id and p_rating_slip_id must be NULL

**Deliverables**:
- [ ] Migration file with RPC
- [ ] SECURITY DEFINER with proper grants
- [ ] `npm run db:types` succeeds

---

### WS3: SQL Helper - chipset_total_cents

**Purpose**: Aggregate chipset JSONB to total cents for snapshot totals.

**Signature**:
```sql
chipset_total_cents(p_chipset jsonb) RETURNS bigint
```

**Implementation**:
```sql
-- chipset format: {"1": 10, "5": 20, "25": 15, ...}
-- where key = denomination, value = count
SELECT COALESCE(
  SUM((key::integer) * (value::integer)),
  0
)::bigint
FROM jsonb_each_text(p_chipset);
```

**Deliverables**:
- [ ] Migration file with function
- [ ] Unit test in migration comments
- [ ] `npm run db:types` succeeds

---

### WS4: Shift Table Metrics RPC

**Purpose**: Compute per-table shift metrics with dual-stream win/loss.

**Signature**:
```sql
rpc_shift_table_metrics(
  p_window_start timestamptz,
  p_window_end timestamptz
) RETURNS TABLE (
  table_id uuid,
  pit_id uuid,
  window_start timestamptz,
  window_end timestamptz,
  opening_snapshot_id uuid,
  opening_snapshot_at timestamptz,
  opening_bankroll_total_cents bigint,
  closing_snapshot_id uuid,
  closing_snapshot_at timestamptz,
  closing_bankroll_total_cents bigint,
  fills_total_cents bigint,
  credits_total_cents bigint,
  drop_custody_present boolean,
  estimated_drop_rated_cents bigint,
  estimated_drop_grind_cents bigint,
  estimated_drop_buyins_cents bigint,
  telemetry_quality text,
  telemetry_notes text,
  win_loss_inventory_cents bigint,
  win_loss_estimated_cents bigint,
  metric_grade text,
  missing_opening_snapshot boolean,
  missing_closing_snapshot boolean
)
```

**Computation Rules**:
1. Find opening snapshot: latest snapshot with `created_at <= p_window_start`
2. Find closing snapshot: latest snapshot with `created_at <= p_window_end`
3. Aggregate fills/credits within window
4. Aggregate telemetry by kind within window
5. Compute win/loss if snapshots exist, else NULL

**Deliverables**:
- [ ] Migration file with RPC
- [ ] SECURITY INVOKER (uses set_rls_context_from_staff internally)
- [ ] `npm run db:types` succeeds

---

### WS5: Pit/Casino Rollup RPCs

**Purpose**: Aggregate table metrics to pit and casino levels.

**Signatures**:
```sql
rpc_shift_pit_metrics(p_window_start, p_window_end, p_pit_id)
RETURNS TABLE (...)

rpc_shift_casino_metrics(p_window_start, p_window_end)
RETURNS TABLE (...)
```

**Output includes**:
- `win_loss_inventory_total_cents`
- `win_loss_estimated_total_cents`
- `tables_count`
- `tables_with_telemetry_count`
- `tables_grade_estimate` (always = tables_count for MVP)

**Deliverables**:
- [ ] Migration file with both RPCs
- [ ] `npm run db:types` succeeds

---

### WS6: Integration Tests

**Purpose**: Validate shift metrics RPCs with real database.

**Test Cases**:
1. `rpc_log_table_buyin_telemetry` - RATED_BUYIN happy path
2. `rpc_log_table_buyin_telemetry` - GRIND_BUYIN happy path
3. `rpc_log_table_buyin_telemetry` - validation errors
4. `rpc_shift_table_metrics` - with snapshots and telemetry
5. `rpc_shift_table_metrics` - missing snapshots (returns NULLs)
6. `rpc_shift_table_metrics` - telemetry quality flags
7. `rpc_shift_pit_metrics` - aggregation correctness
8. `rpc_shift_casino_metrics` - aggregation correctness

**Deliverables**:
- [ ] Integration test file
- [ ] All tests pass

---

## Definition of Done

- [ ] All workstreams complete
- [ ] All gates pass (schema-validation, test-pass)
- [ ] Addendum implementation checklist items marked complete
- [ ] No TypeScript errors (`npm run type-check`)
- [ ] No lint errors (`npm run lint`)
