---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline skill (lead-architect scaffold + expert consultation)

prd: GAP-SEEDED-GAME-SETTINGS-ORPHANED
prd_title: "Connect Seeded Game Settings to Gaming Tables via Setup Wizard"
service: TableContextService + CasinoService
mvp_phase: 1

workstreams:
  WS1:
    name: Add game_settings_id FK + fix seed data
    description: |
      Add nullable FK gaming_table.game_settings_id -> game_settings(id).
      Fix RPC seed data: populate rating_edge_for_comp for UTH (2.19) and HCF (2.64).
      Cross-context FK (TableContextService -> CasinoService) is a read reference only.
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/YYYYMMDDHHMMSS_add_gaming_table_game_settings_fk.sql
      - supabase/migrations/YYYYMMDDHHMMSS_fix_seed_rating_edge_for_comp.sql
    gate: schema-validation
    estimated_complexity: low

  WS2:
    name: Update server actions and Zod schemas for game_settings_id
    description: |
      Update createGamingTableSchema to accept optional game_settings_id.
      Update createGamingTableAction upsert payload to include game_settings_id.
      Expand game_settings data fetching in page.tsx
      to return full variant details (house_edge, DPH, seats, variant_name, code).
      Expand GameSettingsSummary type in setup-wizard.tsx.
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - services/table-context/schemas.ts
      - app/(onboarding)/setup/_actions.ts
      - app/(onboarding)/setup/page.tsx
      - app/(onboarding)/setup/setup-wizard.tsx
    gate: type-check
    estimated_complexity: medium

  WS3:
    name: Enhanced Step 2 — game settings review + custom provisioning entrypoint
    description: |
      Enhance StepGameSeed to show full game settings table after seeding.
      Display grouped by game_type: name, variant_name, house_edge%, DPH, seats.
      Use enriched GameSettingsSummary type from WS2.
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - app/(onboarding)/setup/steps/step-game-seed.tsx
    gate: type-check
    estimated_complexity: medium

  WS4:
    name: Enhanced Step 3 — variant selector + bulk-add + bulk-add
    description: |
      Add variant selector dropdown to table-row-form (filtered by game_type).
      Add game_settings_id to TableFormRow type.
      Add missing bulk-add buttons: +2 Baccarat, +1 Pai Gow, +2 Carnival.
      Remove rigid templates; rely on seeded suggestions + custom game provisioning.
      Pass game_settings_id through to createGamingTableAction.
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS1, WS2]
    outputs:
      - app/(onboarding)/setup/components/table-row-form.tsx
      - app/(onboarding)/setup/steps/step-create-tables.tsx
      - app/(onboarding)/setup/setup-wizard.tsx
    gate: type-check
    estimated_complexity: high

  WS5:
    name: Enhanced Step 5 — review with game variant names
    description: |
      Replace gameCount prop with full games array in StepReviewComplete.
      Show game variant names grouped by game_type instead of just count badge.
      Show variant name alongside table entries when game_settings_id is linked.
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS3, WS4]
    outputs:
      - app/(onboarding)/setup/steps/step-review-complete.tsx
      - app/(onboarding)/setup/setup-wizard.tsx
    gate: build
    estimated_complexity: medium

execution_phases:
  - name: Phase 1 - Database Foundation
    parallel: [WS1]
    gates: [schema-validation]

  - name: Phase 2 - Service Layer + Step 2 UI (review + custom entrypoint)
    parallel: [WS2, WS3]
    gates: [type-check]

  - name: Phase 3 - Step 3 Variant Selector (no templates)
    parallel: [WS4]
    gates: [type-check]

  - name: Phase 4 - Step 5 Review Enhancement
    parallel: [WS5]
    gates: [build]

gates:
  schema-validation:
    command: npm run db:types
    success_criteria: "Exit code 0, types regenerated with game_settings_id on GamingTableRow"

  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0, no type errors"

  build:
    command: npm run build
    success_criteria: "Exit code 0, no build errors"

external_dependencies:
  - prd: PRD-029
    service: CasinoService
    required_for: "Seeded game_settings data (rpc_seed_game_settings_defaults)"
  - prd: PRD-030
    service: CasinoService + TableContextService
    required_for: "Existing setup wizard infrastructure (5-step flow)"

risks:
  - risk: "Cross-context FK (TableContextService.gaming_table -> CasinoService.game_settings) introduces coupling"
    mitigation: "FK is nullable, ON DELETE SET NULL. Read reference only — no cross-context writes. Allowed per SRM."
  - risk: "Existing gaming_table rows have no game_settings_id — variant unknown"
    mitigation: "FK is nullable. Existing tables retain NULL. Variant can be assigned retroactively."
  
---

# EXECUTION-SPEC: GAP-SEEDED-GAME-SETTINGS-ORPHANED

## Overview

`game_settings` defaults (PRD-029) seed a **suggestive** list of common variants. The wizard must treat these as a starting point, not a rigid template.

This spec connects the seeded data to the wizard workflow by: adding a `game_settings_id` FK to `gaming_table`, enhancing the wizard UI to display game details and select specific variants when creating tables, and fixing seed data gaps.

## Scope

**In Scope:**
- Add `gaming_table.game_settings_id` nullable FK to `game_settings(id)`
- Fix `rating_edge_for_comp` NULL for UTH and High Card Flush in seed RPC
- Enhance Step 2 (Game Settings) to show available game variants (seeded defaults are *suggestions*) and verify/edit via the Custom Game Settings flow
- Enhance Step 3 (Create Tables) with variant selector and bulk-add buttons (no templates)
- Enhance Step 5 (Review) to show game variant names instead of just count
- Update server actions, Zod schemas, and data fetching for `game_settings_id`

**Out of Scope:**
- Custom game settings creation UI (separate gap: GAP-SETUP-WIZARD-CUSTOM-GAME-SETTINGS)
- Side bet configuration in wizard
- RLS policy changes (existing `gaming_table` policies already casino-scope)
- Template document correction (bj_dd house_edge null -> 1.50) — documentation-only fix

## Architecture Context

**Bounded Context Ownership:**
- `gaming_table` owned by **TableContextService** (SRM v4.12.0 §TableContextService)
- `game_settings` owned by **CasinoService** (SRM v4.12.0 §CasinoService)
- Cross-context FK is a read reference — allowed per SRM contract policy
**SRM Contract Note (required)**:
- This cross-context reference must be explicitly allowed as a *read reference edge* in SRM. If SRM does not already include this edge, this spec requires an SRM patch/exception before shipping.

**Tenant Consistency Rule (must be enforced at DB level)**:
- `gaming_table.game_settings_id` may only reference a `game_settings` row from the **same casino**. FK alone does not guarantee this; WS1 must add a constraint/trigger to enforce `gs.casino_id = gaming_table.casino_id`.


**ADR Compliance:**
- ADR-024: All server actions derive casino_id from RLS context (no change needed)
- ADR-018: RPC retains SECURITY DEFINER + set_rls_context_from_staff()
- ADR-030: Write-path uses session vars — gaming_table writes via existing policies

**Source Document:** `docs/issues/gaps/onboarding-setup-wizard/GAP-SEEDED-GAME-SETTINGS-ORPHANED.md`

## Workstream Details

### WS1: Add game_settings_id FK + fix seed data

**Purpose:** Create the database link between gaming tables and their specific game variant. Fix missing comp-edge data for carnival games.

**Deliverables:**
1. Migration: `ALTER TABLE gaming_table ADD COLUMN game_settings_id uuid REFERENCES game_settings(id) ON DELETE SET NULL`
2. **Tenant-consistency constraint/trigger**: enforce that a referenced `game_settings` row must have the same `casino_id` as the `gaming_table` row.
   - Example approach: `BEFORE INSERT OR UPDATE` trigger that raises an error if `game_settings_id` is not NULL and `game_settings.casino_id != gaming_table.casino_id`.
   - (Alternative: composite key strategy if you already have `(id, casino_id)` uniqueness — use only if it exists today.)
3. Index: `CREATE INDEX idx_gaming_table_game_settings_id ON gaming_table(game_settings_id) WHERE game_settings_id IS NOT NULL`
4. Migration: Update `rpc_seed_game_settings_defaults` — set `rating_edge_for_comp` to 2.190 for UTH, 2.640 for HCF
5. Data fix: `UPDATE game_settings SET rating_edge_for_comp = house_edge WHERE code IN ('uth', 'high_card_flush') AND rating_edge_for_comp IS NULL`
6. Run `npm run db:types`

**Acceptance Criteria:**
- [ ] `gaming_table.game_settings_id` column exists as nullable uuid FK
- [ ] Partial index on `game_settings_id` created
- [ ] Tenant-consistency enforced: cannot link a table to a `game_settings` from another casino
- [ ] `npm run db:types` succeeds — `game_settings_id` appears in `GamingTableRow`
- [ ] RPC seed data updated — UTH and HCF have non-null `rating_edge_for_comp`
- [ ] Existing `gaming_table` rows unaffected (game_settings_id = NULL)

### WS2: Update server actions and Zod schemas

**Purpose:** Thread `game_settings_id` through the wizard's server action layer and expand data fetching for richer UI.

**Deliverables:**
1. Update `createGamingTableSchema` in `services/table-context/schemas.ts` — add `game_settings_id: z.string().uuid().optional()`
2. Update `createGamingTableAction` upsert payload — include `game_settings_id: validated.game_settings_id ?? null`
3. Expand `page.tsx` game_settings query (read-only) — `select('id, code, name, variant_name, game_type, house_edge, decisions_per_hour, seats_available')`
4. Expand `GameSettingsSummary` type in `setup-wizard.tsx` to include `code`, `variant_name`, `house_edge`, `decisions_per_hour`, `seats_available`
5. Remove dependence on `seedGameSettingsAction` for wizard flow. Wizard should read whatever `game_settings` exist for the casino (seeded suggestions and/or custom).
6. If no `game_settings` exist, Step 2 should direct the user to **Add Custom Game** (implemented in GAP-SETUP-WIZARD-CUSTOM-GAME-SETTINGS).

**Acceptance Criteria:**
- [ ] `createGamingTableSchema` accepts optional `game_settings_id`
- [ ] `createGamingTableAction` passes `game_settings_id` to upsert
- [ ] `GameSettingsSummary` type includes all variant detail fields
- [ ] `page.tsx` fetches expanded game_settings columns
- [ ] Wizard does not rely on any a rigid default-seeding button action to proceed (defaults are suggestive, custom provisioning is the path).
- [ ] `npm run type-check` passes

### WS3: Enhanced Step 2 — game settings review + custom provisioning entrypoint

**Purpose:** After seeding, show the user what was seeded — game names, variants, house edges, DPH, and seats — so they can verify before proceeding.

**Deliverables:**
1. Rename copy/labeling: Step 2 is “Game Settings”, not “Game Seed” (keep file name if you want, but UI copy must change).
2. Expand `StepGameSeedProps.games` to use enriched `GameSettingsSummary` type
2. Render grouped game list by `game_type`
3. Show per-game: name, variant_name, house_edge%, decisions_per_hour, seats_available
4. Retain summary badge for quick count overview
5. Add a prominent **“Add Custom Game”** CTA that routes/opens the custom game settings form (GAP-SETUP-WIZARD-CUSTOM-GAME-SETTINGS).

**Acceptance Criteria:**
- [ ] User sees available game variants with key metrics
- [ ] Games grouped by game_type (Blackjack: 4, Baccarat: 3, Pai Gow: 2, Carnival: 2)
- [ ] No new state management — data from props
- [ ] `npm run type-check` passes

### WS4: Enhanced Step 3 — variant selector + bulk-add (no templates)

**Purpose:** Allow users to select specific game variants when creating tables, and provide quick-start bulk-add and template buttons.

**Deliverables:**
1. Add `game_settings_id: string | null` to `TableFormRow`
2. Add variant selector `Select` dropdown to `TableRowForm` — filtered by current `game_type`
3. Add `gameSettings: GameSettingsSummary[]` prop to `TableRowForm` and `StepCreateTables`
4. When `game_type` changes, clear `game_settings_id`; when variant selected, set `game_settings_id`
5. Add bulk-add buttons: `+2 Baccarat`, `+1 Pai Gow`, `+2 Carnival`
6. Update `handleSaveTables` in `setup-wizard.tsx` to pass `game_settings_id` to server action

**Acceptance Criteria:**
- [ ] Variant selector shows variants filtered by game_type
- [ ] Selecting a variant sets `game_settings_id` on the row
- [ ] Bulk-add buttons exist for the currently supported seeded suggestion categories (Blackjack, Baccarat, Pai Gow, Carnival) — no fake “6 categories” claim
- [ ] `npm run type-check` passes

### WS5: Enhanced Step 5 — review with game variant names

**Purpose:** Show meaningful game and table information in the final review, not just counts.

**Deliverables:**
1. Replace `gameCount: number` prop with `games: GameSettingsSummary[]` in `StepReviewComplete`
2. Show game variant summary grouped by `game_type` in Game Settings section
3. When table has `game_settings_id`, show variant name alongside type badge in Gaming Tables section
4. Update `setup-wizard.tsx` to pass `games` instead of `gameCount`

**Acceptance Criteria:**
- [ ] Game Settings section shows variant names (not just count badge)
- [ ] Tables with linked variants show variant name (e.g., "BJ-01 — Blackjack 6-Deck Shoe")
- [ ] Tables without variants still display correctly (just game_type badge)
- [ ] `npm run build` passes

## Definition of Done

- [ ] All 5 workstreams complete
- [ ] All gates pass (schema-validation, type-check, build)
- [ ] `gaming_table.game_settings_id` FK exists and is nullable
- [ ] Wizard Step 2 shows full game settings details and provides an “Add Custom Game” entrypoint
- [ ] Wizard Step 3 supports variant selection and bulk-add
- [ ] Wizard Step 5 shows variant names in review
- [ ] No regressions in existing tests
- [ ] No `as any`, no `console.*` in production code
- [ ] ADR-024 compliance maintained (casino_id from context, never from user input)
