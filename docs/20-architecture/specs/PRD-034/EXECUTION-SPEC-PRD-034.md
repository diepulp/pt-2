---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline (lead-architect scaffold + expert refinement)

prd: PRD-034
prd_title: "RLS Write-Path Remediation & Enforcement"
service: CasinoService
mvp_phase: 0  # Security Remediation

workstreams:
  WS1:
    name: "rpc_create_staff + Route Handler Fix"
    description: "Create SECURITY DEFINER RPC for staff creation, update POST route handler, integration tests"
    executor: rls-expert
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/20260211180000_prd034_rpc_create_staff.sql
      - app/api/v1/casino/staff/route.ts  # Modified POST handler
      - services/casino/__tests__/rpc-create-staff.int.test.ts
      - types/database.types.ts  # Regenerated
    gate: schema-validation
    estimated_complexity: medium

  WS2:
    name: "player_casino Fallback Removal"
    description: "Remove broken PostgREST upsert fallback in enrollPlayer(), replace with RPC call. Cross-context note: minor updates to enroll route handler and SLAD ownership tests."
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/20260211180100_prd034_rpc_casino_enrollment.sql
      - services/casino/crud.ts  # Modified enrollPlayer()
      - types/database.types.ts  # Regenerated
    gate: type-check
    estimated_complexity: medium

  WS3:
    name: "CI Write-Path Lint + Category B Policy-Lint"
    description: "Category A config generator, write-path lint script, Category B policy-lint, CI integration, ESLint rule update"
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - scripts/generate-category-a-config.ts
      - config/rls-category-a-tables.json  # Generated artifact
      - scripts/lint-rls-write-path.sh
      - scripts/lint-rls-category-b-policies.sh
      - .eslint-rules/no-direct-template2b-dml.js  # Modified
      - .github/workflows/ci.yml  # Modified
      - scripts/__tests__/lint-rls-write-path.regression.sh  # Regression test
    gate: lint
    estimated_complexity: high

  WS4:
    name: "Rowcount Assertion Helper"
    description: "assertRowsAffected() utility, RlsWriteDeniedError, apply to affected services. Cross-context note: applies utility to casino and service write paths."
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - lib/supabase/assert-rows-affected.ts
      - lib/errors/rls-write-denied-error.ts
      - lib/supabase/__tests__/assert-rows-affected.test.ts
      - services/casino/crud.ts  # Modified write paths
    gate: type-check
    estimated_complexity: low

  WS5:
    name: "ADR-030 D4 Spec Gap + ADR-034 Ratification"
    description: "Update ADR-030 D4 to remove player from critical list, ratify ADR-034, update SEC-001"
    executor: lead-architect
    executor_type: skill
    depends_on: [WS1, WS3]
    outputs:
      - docs/80-adrs/ADR-030-auth-system-hardening.md  # D4 update
      - docs/80-adrs/ADR-034-RLS-write-path-compatibility-and-enforcement.md  # Status → Accepted
      - docs/30-security/SEC-001-rls-policy-matrix.md  # Category A/B cross-reference
    gate: type-check
    estimated_complexity: low

  WS6:
    name: "Abuse-Case Tests for Privileged RPCs"
    description: "Integration tests for rpc_bootstrap_casino and rpc_accept_staff_invite abuse cases"
    executor: rls-expert
    executor_type: skill
    depends_on: []
    outputs:
      - services/casino/__tests__/rpc-bootstrap-casino-abuse.int.test.ts
      - services/casino/__tests__/rpc-accept-staff-invite-abuse.int.test.ts
    gate: test-pass
    estimated_complexity: medium

execution_phases:
  - name: "Phase 1 — Remediation + Tooling (P0/P1, all parallel)"
    parallel: [WS1, WS2, WS3, WS4]
    gates: [schema-validation, type-check, lint, build]

  - name: "Phase 2 — Governance + Hardening (P2)"
    parallel: [WS5, WS6]
    gates: [type-check, test-pass, build]

gates:
  schema-validation:
    command: "npm run db:types"
    success_criteria: "Exit code 0, types regenerated"
  type-check:
    command: "npm run type-check"
    success_criteria: "Exit code 0"
  lint:
    command: "npm run lint"
    success_criteria: "Exit code 0"
  test-pass:
    command: "npm test"
    success_criteria: "All tests pass"
  build:
    command: "npm run build"
    success_criteria: "Exit code 0"

external_dependencies:
  - prd: ADR-030
    service: Platform
    required_for: "Category A table registry (source of truth)"
  - prd: ADR-034
    service: Platform
    required_for: "Write-path posture taxonomy (ratification gate for WS3 merge)"

risks:
  - risk: "WS3 is the largest workstream (5+ scripts/configs)"
    mitigation: "Phased delivery: lint script first, then generator, then CI integration"
  - risk: "ADR-034 ratification gate could block WS3 merge"
    mitigation: "WS3 can merge while ADR-034 status is 'Proposed' — the lint scripts exist and run but are not considered enforcement-active until WS5 ratifies ADR-034 to 'Accepted'. This is explicit: WS3 CI step runs in warning-only mode (exit 0) until WS5 completes, then switches to blocking (exit non-zero)."
  - risk: "enrollPlayer() removal may affect edge cases"
    mitigation: "Audit confirms rpc_create_player handles primary path; re-enrollment via new rpc_enroll_player"
  - risk: "SLAD ownership tests reference enrollPlayer signature"
    mitigation: "Update tests to match new RPC-based signature"

---

# EXECUTION-SPEC: PRD-034 — RLS Write-Path Remediation & Enforcement

## Overview

PRD-034 remediates 3 confirmed RLS write-path findings (1 active bug, 1 latent risk, 1 spec gap), introduces machine-enforced CI guardrails to prevent recurrence, and gates on ratification of ADR-034 as the canonical decision for RLS write-path compatibility.

## Scope

- **In Scope**: rpc_create_staff RPC, enrollPlayer fallback removal, CI write-path lint, rowcount assertion helper, ADR-030/034 documentation, abuse-case tests
- **Out of Scope**: Migrating all PostgREST DML to RPCs, AST-based ESLint rewrite, service-role client removal, UI changes

## Architecture Context

- **ADR-034**: RLS Write-Path Compatibility & Enforcement (Category A/B taxonomy)
- **ADR-030**: Auth Pipeline Hardening (critical tables, session-var-only writes)
- **ADR-024**: Authoritative Context Derivation (set_rls_context_from_staff)
- **SRM**: CasinoService owns staff, player_casino tables

---

## Workstream Details

### WS1: rpc_create_staff + Route Handler Fix

**Purpose**: Fix the active production bug where `POST /api/v1/casino/staff` does PostgREST DML against the Category A `staff` table.

**RPC Design** (follows `rpc_create_staff_invite` pattern from PRD-025):

```sql
CREATE OR REPLACE FUNCTION public.rpc_create_staff(
  p_first_name text,
  p_last_name text,
  p_role staff_role,
  p_employee_id text DEFAULT NULL
)
RETURNS TABLE (id uuid, first_name text, last_name text, role text, status text, employee_id text, casino_id uuid)
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = pg_catalog, public
AS $$
```

**Key requirements**:
1. Call `set_rls_context_from_staff()` as first operation (ADR-024 INV-7)
2. Validate caller role = `admin` (only admins create staff)
3. Derive `casino_id` from `app.casino_id` session var (ADR-024 INV-8 — NO casino_id parameter)
4. INSERT into `staff` table within same transaction
5. INSERT into `audit_log` (staff_created event)
6. Handle constraint violations: `23514` (role constraint), `23505` (unique violation)
7. GRANT EXECUTE to `authenticated` only (REVOKE from PUBLIC, anon)
8. `ALTER FUNCTION rpc_create_staff OWNER TO postgres` (SECURITY DEFINER must have explicit owner — ADR-018)
9. (Optional) End with `NOTIFY pgrst, 'reload schema'` — only needed if PostgREST schema cache requires invalidation in your deployment. Not required for write-path correctness.

**Route Handler Update** (`app/api/v1/casino/staff/route.ts`):

Replace lines 147-151:
```typescript
// BEFORE (broken — PostgREST DML against Category A table):
const { data, error } = await mwCtx.supabase
  .from('staff')
  .insert(staffData)
  .select(STAFF_SELECT)
  .single();

// AFTER (fixed — RPC call, same transaction):
const { data, error } = await mwCtx.supabase
  .rpc('rpc_create_staff', {
    p_first_name: input.first_name,
    p_last_name: input.last_name,
    p_role: input.role,
    p_employee_id: input.employee_id ?? null,
  })
  .single();
```

**Integration Tests** (`services/casino/__tests__/rpc-create-staff.int.test.ts`):
- Valid admin creates staff → returns staff row with correct casino_id
- Non-admin caller rejected → FORBIDDEN error
- Cross-casino attempt rejected → casino_id mismatch
- Duplicate employee_id → 23505 unique violation
- Audit log entry created

**Acceptance Criteria**:
- [ ] `npm run db:types` succeeds after migration
- [ ] `POST /api/v1/casino/staff` creates staff via RPC under transaction pooling
- [ ] RPC validates admin role, derives casino_id from context
- [ ] Audit log written on every staff creation
- [ ] Integration tests pass (admin, non-admin, cross-casino)

---

### WS2: player_casino Fallback Removal

**Purpose**: Remove the broken PostgREST upsert fallback in `enrollPlayer()` that does DML against the Category A `player_casino` table.

**Analysis**:
- `rpc_create_player` already handles atomic enrollment (player + player_casino) per migration `20251227034101`
- The `enrollPlayer()` fallback in `services/casino/crud.ts:475-510` is only hit for re-enrollment (existing player, new casino)
- This path is broken (PostgREST DML against session-var-only policies) but rarely triggered

**Approach**: Create `rpc_enroll_player` (SECURITY DEFINER) for the re-enrollment case:

```sql
CREATE OR REPLACE FUNCTION public.rpc_enroll_player(
  p_player_id uuid
)
RETURNS TABLE (player_id uuid, casino_id uuid, status text, enrolled_at timestamptz, enrolled_by uuid)
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = pg_catalog, public
```

**Requirements**:
1. Call `set_rls_context_from_staff()` (ADR-024 INV-7)
2. Derive `casino_id` from context (no parameter — INV-8)
3. Validate player exists
4. UPSERT into `player_casino` with explicit column semantics:
   - `ON CONFLICT (player_id, casino_id) DO UPDATE SET`
   - `status = 'active'` (re-activate if previously deactivated)
   - `enrolled_by = <actor_id from context>` (update to current actor)
   - `enrolled_at = now()` (reset enrollment timestamp on re-enroll)
   - Columns that do NOT update on re-enroll: `player_id`, `casino_id` (PK), `created_at`
5. Return enrollment record

**Code changes**:
- `services/casino/crud.ts`: Replace `enrollPlayer()` body with `.rpc('rpc_enroll_player', { p_player_id })` call
- `app/api/v1/players/[playerId]/enroll/route.ts`: May need minor updates if return shape changes
- `__tests__/slad/player-identity-ownership.test.ts`: Update signature assertion (function now takes 2 params: supabase + playerId instead of 4)

**Acceptance Criteria**:
- [ ] `enrollPlayer()` no longer performs PostgREST DML against `player_casino`
- [ ] Re-enrollment works via `rpc_enroll_player`
- [ ] SLAD ownership tests updated and passing
- [ ] Type-check passes

---

### WS3: CI Write-Path Lint + Category B Policy-Lint

**Purpose**: Machine-enforced CI guardrails to prevent future PostgREST DML against Category A tables.

**Deliverable (a): Category A Config Generator**

File: `scripts/generate-category-a-config.ts`
- Reads ADR-030 markdown file, extracts Category A table list
- Emits `config/rls-category-a-tables.json` with generator header
- npm script: `"generate:category-a": "npx tsx scripts/generate-category-a-config.ts"`
- CI validates generated file matches committed file (checksum)

Output format (illustrative — actual list is extracted from ADR-030 at generation time):
```json
{
  "_generated": "DO NOT EDIT. Run: npm run generate:category-a",
  "_source": "docs/80-adrs/ADR-030-auth-system-hardening.md",
  "_extracted_at": "2026-02-11T18:00:00Z",
  "categoryA": ["<extracted from ADR-030 Category A registry block>"]
}
```
> **Single-authority rule**: The generator parses ADR-030's fenced `<!-- CATEGORY-A-REGISTRY -->` block as the sole source of truth. No table name is hard-coded in the generator script or in this spec. If ADR-030 does not contain the registry block, the generator MUST fail with an actionable error.

**Deliverable (b): Write-Path Lint Script**

File: `scripts/lint-rls-write-path.sh`
- Reads table list from `config/rls-category-a-tables.json`
- Scans `app/`, `services/`, `lib/` (excludes `__tests__/`, `*.test.ts`, `*.spec.ts`, `e2e/`, `*.int.test.ts`)
- **Detection rule (deterministic)**: A violation is a chain `<client>.<from>('<TABLE>').<mutation>` where:
  - `<client>` is a request-scoped authenticated client identifier on the **same statement** (same logical expression, typically same line or continuation lines connected by `.`). Authenticated client identifiers (exhaustive): `ctx.supabase`, `mwCtx.supabase`. The bare identifier `supabase` is NOT matched by default (grep cannot infer binding provenance). If bare `supabase` must be used as authenticated in server code, the file must include a marker comment `// rls-lint: authenticated-client` on the preceding line to opt in to scanning.
  - `<TABLE>` is any table listed in `config/rls-category-a-tables.json`.
  - `<mutation>` is one of `.insert(`, `.update(`, `.upsert(`, `.delete(`.
  - Excluded client identifiers (skip entirely): `serviceSupabase`, `adminClient`, `supabaseAdmin`, `createServiceClient`.
  - Matching is grep-based (not AST), operating on chained method call patterns across continuation lines (lines ending with `.` or starting with `.`).
- Exemption: `// rls-break-glass` block with all 5 required fields (table, reason, compensating_controls, expires, ticket)
- Output: `file:line + table + remediation` on violation
- Exit: non-zero on any violation
- Performance: < 10 seconds for full codebase

**Deliverable (c): Category B Policy-Lint Script**

File: `scripts/lint-rls-category-b-policies.sh`
- Queries `pg_policies` view (NOT `pg_policy` catalog) for each Category B table after migrations applied. Uses `qual` (USING expression) and `with_check` (WITH CHECK expression) text columns directly — no `pg_get_expr()` required. Filter: `schemaname = 'public'` and `cmd IN ('INSERT','UPDATE','ALL')`
- **"Wrapped" definition (deterministic)**: A `current_setting('app.` token is considered wrapped if and only if it appears inside a `coalesce(` call — i.e., a case-insensitive `coalesce(` token precedes `current_setting('app.` within the same SQL expression (whitespace-normalized, same `WITH CHECK` or `USING` clause). Any `current_setting('app.` that does NOT have a preceding `coalesce(` in the same clause is a violation.
- Case-insensitive, whitespace-normalized (collapse runs of whitespace to single space before matching)
- Exit: non-zero on any match (outputs table name + policy name + the raw expression)

**Deliverable (d): CI Pipeline Integration**

Update `.github/workflows/ci.yml`:
```yaml
- name: RLS Write-Path Lint
  run: bash scripts/lint-rls-write-path.sh
  # Starts as warning-only (continue-on-error: true) while ADR-034 is "Proposed".
  # After WS5 ratifies ADR-034 to "Accepted", remove continue-on-error to make blocking.
  continue-on-error: true
```

**Deliverable (e): ESLint Rule Update**

Update `.eslint-rules/no-direct-template2b-dml.js`:
- Add `player_casino` to the protected tables set
- Rename internal constant from `TEMPLATE_2B_TABLES` to `CATEGORY_A_TABLES` and update the rule description/message to use "Category A" language (aligning with ADR-034 taxonomy)
- Legacy name mapping: "Template 2B" (SEC-001 write-policy template) = "Category A" (ADR-034 write posture). The ESLint filename may remain `no-direct-template2b-dml.js` for git-blame continuity, but the user-facing error message and rule description MUST reference "Category A"
- `staff` and `staff_pin_attempts` already present

**Deliverable (f): Regression Test**

File: `scripts/__tests__/lint-rls-write-path.regression.sh`
- Creates temporary synthetic violation file
- Runs lint script, verifies non-zero exit
- Cleans up synthetic file

**Acceptance Criteria**:
- [ ] `npm run generate:category-a` produces valid JSON
- [ ] `scripts/lint-rls-write-path.sh` exits 0 on clean codebase
- [ ] Lint correctly fails on synthetic violation (regression test)
- [ ] ESLint rule covers `staff` and `player_casino`
- [ ] CI pipeline includes RLS write-path lint
- [ ] Lint completes in < 10 seconds

---

### WS4: Rowcount Assertion Helper

**Purpose**: Prevent silent RLS-deny failures by asserting affected rows >= 1 on write operations.

**Deliverable: `lib/supabase/assert-rows-affected.ts`**

```typescript
import { RlsWriteDeniedError } from '@/lib/errors/rls-write-denied-error';

interface AssertRowsAffectedOptions {
  table: string;
  operation: 'insert' | 'update' | 'upsert' | 'delete';
  context?: string;
}

/**
 * Validates that a Supabase write operation affected at least one row.
 * Returns the normalized data as T[] (never null, never empty).
 *
 * Callers MUST use `.select('id')` (or similar) on PostgREST writes
 * so `data` is a populated array when RLS allows the write.
 */
export function assertRowsAffected<T>(
  result: { data: T[] | T | null; error: unknown },
  options: AssertRowsAffectedOptions,
): T[] {
  if (result.error) throw result.error;
  const rows: T[] = Array.isArray(result.data)
    ? result.data
    : result.data != null
      ? [result.data]
      : [];
  if (rows.length === 0) {
    throw new RlsWriteDeniedError(options.table, options.operation, options.context);
  }
  return rows;
}
```

> **Design note**: Returns `T[]` instead of using `asserts` because the assertion signature would lie about the narrowed type when `result.data` is a single object (`T | null`). Returning `T[]` gives callers a truthful, normalized array they can destructure (`const [row] = assertRowsAffected(result, opts)`).

**Deliverable: `lib/errors/rls-write-denied-error.ts`**

```typescript
import { DomainError } from './domain-errors';

export class RlsWriteDeniedError extends DomainError {
  constructor(table: string, operation: string, context?: string) {
    super('RLS_WRITE_DENIED', `Write operation ${operation} on ${table} affected 0 rows`, {
      httpStatus: 403,
      details: { table, operation, context },
    });
  }
}
```

**Application to services**:
- `services/casino/crud.ts`: Apply to remaining PostgREST write paths (after WS1/WS2 RPC migrations, only Category B writes remain)
- `services/player/crud.ts`: Apply to `updatePlayer()` — verify it uses `.select('id')` for reliable rowcount

**Unit Tests** (`lib/supabase/__tests__/assert-rows-affected.test.ts`):
- Throws `RlsWriteDeniedError` when data is null
- Throws `RlsWriteDeniedError` when data is empty array
- Passes when data has items
- Error includes table name and operation
- Rethrows original error when result.error is set

**Acceptance Criteria**:
- [ ] `assertRowsAffected()` catches 0-row writes
- [ ] `RlsWriteDeniedError` includes structured details (table, operation)
- [ ] All modified write paths use `.select('id')` for reliable rowcount
- [ ] Unit tests pass
- [ ] Type-check passes

---

### WS5: ADR-030 D4 Spec Gap + ADR-034 Ratification

**Purpose**: Resolve the `player` table spec gap and ratify ADR-034.

**Deliverable (a): ADR-030 D4 Update**
- Remove `player` from the critical table list in D4
- Rationale: `player` write policies use COALESCE (PostgREST-compatible) and `updatePlayer()` uses PostgREST DML. Tightening would break this path without compensating RPC migration.
- Updated critical table list: `staff`, `player_financial_transaction`, `visit`, `rating_slip`, `loyalty_ledger` (remove `player`)
- **MUST ensure ADR-030 contains a fenced `<!-- CATEGORY-A-REGISTRY -->` ... `<!-- /CATEGORY-A-REGISTRY -->` block** listing all Category A tables. This block is the machine-readable source of truth consumed by WS3's `generate-category-a-config.ts`. If the block is missing or malformed after WS5 edits, WS3's generator will fail.

**Deliverable (b): ADR-034 Ratification**
- Update `docs/80-adrs/ADR-034-RLS-write-path-compatibility-and-enforcement.md`
- Change status from `proposed` to `accepted`
- Add acceptance date

**Deliverable (c): SEC-001 Update**
- Add Category A/B posture cross-reference section
- Reference ADR-034 for the taxonomy
- Document which tables are Category A vs Category B

**Acceptance Criteria**:
- [ ] ADR-030 D4 no longer lists `player` as critical
- [ ] ADR-030 contains `<!-- CATEGORY-A-REGISTRY -->` block parseable by WS3 generator
- [ ] `npm run generate:category-a` succeeds against updated ADR-030
- [ ] ADR-034 status is "Accepted"
- [ ] SEC-001 includes Category A/B cross-reference

---

### WS6: Abuse-Case Tests for Privileged RPCs

**Purpose**: Ensure high-trust RPCs (INV-7 exceptions) have security boundary tests.

**Test: `rpc_bootstrap_casino`** (`services/casino/__tests__/rpc-bootstrap-casino-abuse.int.test.ts`):

| Test Case | Expected Behavior |
|-----------|-------------------|
| Unauthenticated caller | UNAUTHORIZED error |
| User already has active staff binding | CONFLICT error (23505) |
| Valid call creates casino + settings + staff + audit_log | Returns casino_id, staff_id, staff_role='admin' |
| Second call by same user | CONFLICT (idempotency/replay) |
| Verify casino.status = 'active' | Confirms created casino is active |

**Test: `rpc_accept_staff_invite`** (`services/casino/__tests__/rpc-accept-staff-invite-abuse.int.test.ts`):

| Test Case | Expected Behavior |
|-----------|-------------------|
| Unauthenticated caller | UNAUTHORIZED error |
| Invalid token format | NOT_FOUND error |
| Non-existent token | NOT_FOUND error |
| Expired token | GONE error |
| Already-accepted token | CONFLICT error |
| User already has active staff binding | CONFLICT error |
| Valid acceptance creates staff + marks invite accepted | Returns staff_id, casino_id, staff_role |
| Cross-casino token abuse: invite token bound to casino A, caller's session context (if any) is casino B | RPC uses token-bound casino_id (not session context); created staff belongs to casino A |
| Role elevation via crafted token: invite role = `pit_boss`, attacker modifies token payload to claim `admin` | RPC derives role from `staff_invite.role` row, not from token payload; created staff role = `pit_boss` |
| Arbitrary casino assignment: attacker crafts token referencing non-existent casino_id | RPC fails with FK violation or NOT_FOUND (casino must exist) |
| Replay: same token accepted twice | CONFLICT on second call |

**Acceptance Criteria**:
- [ ] All abuse-case tests pass
- [ ] Cross-casino isolation verified
- [ ] Role misuse scenarios covered
- [ ] Replay/idempotency tested

---

## Definition of Done

**Functionality**
- [ ] `POST /api/v1/casino/staff` creates staff via `rpc_create_staff` under transaction pooling
- [ ] `enrollPlayer()` no longer performs PostgREST DML against `player_casino`
- [ ] ADR-030 D4 updated to resolve `player` table posture

**Data & Integrity**
- [ ] `rpc_create_staff` writes `audit_log` entry on every staff creation
- [ ] No orphaned staff records from partial creation failures (RPC is atomic)
- [ ] `assertRowsAffected()` catches 0-row writes in all modified services

**Security & Access**
- [ ] `rpc_create_staff` enforces admin role via `set_rls_context_from_staff()`
- [ ] No authenticated PostgREST DML against Category A tables in production code
- [ ] Service-role paths annotated with break-glass justification

**Testing**
- [ ] Integration test: `rpc_create_staff` succeeds with valid admin caller
- [ ] Integration test: `rpc_create_staff` rejects non-admin caller
- [ ] Integration test: `rpc_create_staff` rejects cross-casino attempt
- [ ] Abuse-case tests for `rpc_bootstrap_casino`
- [ ] Abuse-case tests for `rpc_accept_staff_invite`
- [ ] CI lint passes on clean codebase (zero Category A violations)
- [ ] CI lint correctly fails on synthetic violation

**Operational Readiness**
- [ ] CI pipeline includes RLS write-path lint as a required gate
- [ ] `assertRowsAffected()` logs structured error with table name and operation
- [ ] Rollback: RPC can be dropped and route handler reverted (migration is additive)

**ADR-034 Conformance**
- [ ] Category A membership referenced from ADR-030 only
- [ ] CI prevents authenticated PostgREST DML to Category A tables
- [ ] Category B RLS policies conform to COALESCE fallback
- [ ] Rowcount invariant reliable via `.select('id')` on PostgREST writes
- [ ] ADR-034 ratified (status: Accepted)
- [ ] SEC-001 updated with Category A/B posture references
