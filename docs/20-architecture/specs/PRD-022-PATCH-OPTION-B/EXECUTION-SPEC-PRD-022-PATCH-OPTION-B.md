---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline for PRD-022-PATCH-OPTION-B

prd: PRD-022-PATCH-OPTION-B
prd_title: "Player 360 Embedded Search (Option B)"
service: Player360
mvp_phase: 1
scope: frontend-only

# Workstream Definitions
workstreams:
  WS1:
    name: Catch-All Route Page
    description: Create catch-all route handling both /players and /players/[playerId]
    type: route-page
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS2]
    bounded_context: player-360
    outputs:
      - app/(dashboard)/players/[[...playerId]]/page.tsx
      - app/(dashboard)/players/[[...playerId]]/_components/player-360-shell.tsx
    gate: type-check
    estimated_complexity: medium

  WS2:
    name: Player360Sidebar Component
    description: Create collapsible sidebar component for search and recent players
    type: react-components
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    bounded_context: player-360
    outputs:
      - components/player-360/sidebar/player-360-sidebar.tsx
      - components/player-360/sidebar/sidebar-toggle.tsx
      - components/player-360/sidebar/index.ts
    gate: type-check
    estimated_complexity: medium

  WS3:
    name: Search Integration
    description: Integrate PlayerSearchCommand into sidebar with router.replace() navigation
    type: react-components
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS2]
    bounded_context: player-360
    outputs:
      - components/player-360/sidebar/search-section.tsx
      - components/player-360/sidebar/recent-players-list.tsx
    gate: type-check
    estimated_complexity: medium

  WS4:
    name: Profile Edit Migration
    description: Migrate PlayerEditModal trigger to Player360 header
    type: modal-integration
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    bounded_context: player-360
    outputs:
      - components/player-360/header/player-edit-button.tsx
      - components/player-360/header/player-360-header-content.tsx
      - components/player-360/header/index.ts
    gate: type-check
    estimated_complexity: low

  WS5:
    name: Empty State Update
    description: Update empty state for no-player-selected view at /players
    type: react-components
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    bounded_context: player-360
    outputs:
      - components/player-360/empty-states.tsx
    gate: type-check
    estimated_complexity: low

  WS6:
    name: Mobile Drawer
    description: Create mobile drawer variant of sidebar using Sheet component
    type: react-components
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS2, WS3]
    bounded_context: player-360
    outputs:
      - components/player-360/sidebar/mobile-drawer.tsx
    gate: type-check
    estimated_complexity: medium

  WS7:
    name: Keyboard Navigation Hook
    description: Create hook for Ctrl/Cmd+K search focus and Esc behavior
    type: react-query-hooks
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS2, WS3]
    bounded_context: player-360
    outputs:
      - hooks/player-360/use-search-keyboard.ts
      - hooks/player-360/index.ts
    gate: type-check
    estimated_complexity: low

  WS8:
    name: Navigation Cleanup
    description: Simplify navigation utilities, remove returnTo complexity, update dashboard
    type: react-components
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS1]
    bounded_context: navigation
    outputs:
      - lib/navigation/return-to.ts
      - lib/navigation/index.ts
      - components/player-dashboard/player-dashboard.tsx
    gate: type-check
    estimated_complexity: low

  WS9:
    name: Unit Tests
    description: Unit tests for sidebar, header, keyboard hook, and navigation utilities
    type: tests
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS1, WS2, WS3, WS4, WS5, WS6, WS7, WS8]
    bounded_context: testing
    outputs:
      - components/player-360/__tests__/sidebar.test.tsx
      - components/player-360/__tests__/header-content.test.tsx
      - hooks/player-360/__tests__/use-search-keyboard.test.ts
      - lib/navigation/__tests__/return-to.test.ts
    gate: test-pass
    estimated_complexity: medium

  WS10:
    name: E2E Tests
    description: Playwright tests for embedded search flow per DoD
    type: e2e-tests
    executor: e2e-testing
    executor_type: skill
    depends_on: [WS1, WS2, WS3, WS4, WS5, WS6, WS7]
    bounded_context: testing
    outputs:
      - e2e/workflows/player-360-embedded-search.spec.ts
    gate: test-pass
    estimated_complexity: high

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Foundation
    description: Create independent components (sidebar, edit button, empty state)
    parallel: [WS2, WS4, WS5]
    gates: [type-check]

  - name: Phase 2 - Route & Search
    description: Create catch-all route and integrate search
    parallel: [WS1, WS3]
    gates: [type-check]

  - name: Phase 3 - Enhanced UX
    description: Add mobile drawer and keyboard navigation
    parallel: [WS6, WS7]
    gates: [type-check]

  - name: Phase 4 - Cleanup
    description: Simplify navigation utilities and update dashboard
    parallel: [WS8]
    gates: [type-check]

  - name: Phase 5 - Unit Tests
    description: Unit and integration tests for all components
    parallel: [WS9]
    gates: [test-pass]

  - name: Phase 6 - E2E Tests
    description: End-to-end tests for embedded search flow
    parallel: [WS10]
    gates: [test-pass]

# Validation Gates
gates:
  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0"

  lint:
    command: npm run lint
    success_criteria: "Exit code 0, no errors (warnings OK)"

  test-pass:
    command: npm test
    success_criteria: "All tests pass"

  build:
    command: npm run build
    success_criteria: "Exit code 0, no build errors"

# No external dependencies - frontend-only PRD
external_dependencies: []

# Risks and Mitigations
risks:
  - risk: "Catch-all route [[...playerId]] conflicts with existing [playerId] route"
    mitigation: "Delete existing routes before creating catch-all; verify Next.js 15 behavior"

  - risk: "Sidebar consumes horizontal space on narrow screens"
    mitigation: "Default collapsed on screens < 1280px; mobile uses drawer instead"

  - risk: "Rapid player switching causes data churn"
    mitigation: "Use React transitions and suspense boundaries for timeline queries"

  - risk: "PlayerEditModal lifecycle tied to timeline suspense"
    mitigation: "Mount modal at header level, outside suspense boundaries"

  - risk: "Keyboard shortcut conflicts with browser/OS shortcuts"
    mitigation: "Use standard Cmd/Ctrl+K pattern; respect existing input focus"

---

# EXECUTION-SPEC: PRD-022-PATCH-OPTION-B — Player 360 Embedded Search

## Overview

This EXECUTION-SPEC implements **Option B** from the PRD-022 architecture alternatives analysis. It replaces the two-surface navigation pattern (lookup-only `/players` → Player 360) with a **single-surface** architecture where search is embedded directly in Player 360.

**Key Principle:** This is a **frontend-only** patch. No database migrations, service layer changes, or RPC modifications are in scope.

## Scope

### In Scope
- Create catch-all route `[[...playerId]]` handling both `/players` and `/players/[playerId]`
- Create Player360Sidebar with search and recent players
- Implement `router.replace()` navigation for player selection
- Migrate PlayerEditModal to Player360 header
- Create mobile drawer for sidebar on small screens
- Add keyboard navigation (Ctrl/Cmd+K)
- Simplify navigation utilities (remove `returnTo` complexity)

### Out of Scope
- Timeline 308 redirect (unchanged from original PRD-022)
- Database migrations or schema changes
- Service layer modifications
- New bounded contexts

## Architecture Context

### Route Structure (Post-Implementation)

```
app/(dashboard)/players/
├── [[...playerId]]/
│   ├── page.tsx                 # Catch-all: /players and /players/[playerId]
│   └── _components/
│       └── player-360-shell.tsx # Layout wrapper with sidebar
└── [playerId]/
    └── timeline/
        └── route.ts             # 308 redirect (unchanged)
```

### Component Ownership

| Component | Location | Purpose |
|-----------|----------|---------|
| `Player360Sidebar` | `components/player-360/sidebar/` | Search + recent players |
| `Player360HeaderContent` | `components/player-360/header/` | Identity + edit button |
| `MobileDrawer` | `components/player-360/sidebar/` | Sheet variant for mobile |
| `useSearchKeyboard` | `hooks/player-360/` | Keyboard shortcuts |

### URL Patterns

| Route | Surface | Purpose |
|-------|---------|---------|
| `/players` | Player 360 (empty) | Search entry, no player selected |
| `/players/[playerId]` | Player 360 (detail) | Canonical player detail |
| `/players/[playerId]/timeline` | Route Handler | 308 → `/players/[playerId]#timeline` |

## Workstream Details

### WS1: Catch-All Route Page

**Purpose:** Create single route that handles both `/players` and `/players/[playerId]`.

**Key Requirements:**
- Server Component with optional catch-all params
- Render `Player360Shell` wrapper with sidebar
- Conditional content based on playerId presence
- Support `#timeline` anchor scroll

**Implementation Pattern:**

```typescript
// app/(dashboard)/players/[[...playerId]]/page.tsx
import { Suspense } from "react";
import { Player360Shell } from "./_components/player-360-shell";
import { Player360Content } from "@/components/player-360";
import { Player360EmptyState } from "@/components/player-360/empty-states";
import { DashboardSkeleton } from "@/components/player-360/skeletons";

interface PageProps {
  params: Promise<{ playerId?: string[] }>;
}

export default async function Player360Page({ params }: PageProps) {
  const { playerId: playerIdSegments } = await params;
  const playerId = playerIdSegments?.[0] ?? null;

  return (
    <Player360Shell playerId={playerId}>
      {playerId ? (
        <Suspense fallback={<DashboardSkeleton />}>
          <Player360Content playerId={playerId} />
        </Suspense>
      ) : (
        <Player360EmptyState />
      )}
    </Player360Shell>
  );
}
```

**Route Deletion Required:**
- Delete `app/(dashboard)/players/page.tsx`
- Delete `app/(dashboard)/players/[playerId]/page.tsx`
- Keep `app/(dashboard)/players/[playerId]/timeline/route.ts`

**Data-testid attributes:**
- `data-testid="player-360-page"` on main container
- `data-testid="player-360-shell"` on shell wrapper

### WS2: Player360Sidebar Component

**Purpose:** Create collapsible sidebar with search and recent players.

**Key Requirements:**
- Collapsible on desktop (persisted to localStorage)
- Hidden on mobile (use drawer instead)
- Contains search section and recent players
- Highlights currently selected player

**Implementation Pattern:**

```typescript
// components/player-360/sidebar/player-360-sidebar.tsx
"use client";

import { cn } from "@/lib/utils";
import { useSidebarState } from "./use-sidebar-state";
import { SidebarToggle } from "./sidebar-toggle";
import { SearchSection } from "./search-section";
import { RecentPlayersList } from "./recent-players-list";

interface Props {
  playerId: string | null;
  onSelectPlayer: (id: string) => void;
  className?: string;
}

export function Player360Sidebar({ playerId, onSelectPlayer, className }: Props) {
  const { isCollapsed, toggle } = useSidebarState();

  return (
    <aside
      className={cn(
        "hidden lg:flex flex-col shrink-0",
        "border-r border-border/40 bg-card/30",
        "transition-all duration-200",
        isCollapsed ? "w-12" : "w-72 xl:w-80",
        className
      )}
      data-testid="player-360-sidebar"
    >
      <SidebarToggle isCollapsed={isCollapsed} onToggle={toggle} />
      {!isCollapsed && (
        <>
          <SearchSection
            selectedPlayerId={playerId}
            onSelectPlayer={onSelectPlayer}
          />
          <RecentPlayersList
            currentPlayerId={playerId}
            onSelectPlayer={onSelectPlayer}
          />
        </>
      )}
    </aside>
  );
}
```

**Data-testid attributes:**
- `data-testid="player-360-sidebar"` on sidebar container
- `data-testid="sidebar-toggle"` on collapse button
- `data-testid="sidebar-search"` on search section
- `data-testid="recent-players"` on recent list

### WS3: Search Integration

**Purpose:** Wrap PlayerSearchCommand with sidebar-specific behavior.

**Key Requirements:**
- Reuse existing `PlayerSearchCommand` component
- Wire selection to `router.replace()` instead of `router.push()`
- Maintain search query state across selections
- Highlight selected player in results

**Implementation Pattern:**

```typescript
// components/player-360/sidebar/search-section.tsx
"use client";

import { useRouter } from "next/navigation";
import { PlayerSearchCommand } from "@/components/player-dashboard/player-search-command";

interface Props {
  selectedPlayerId: string | null;
  onSelectPlayer: (id: string) => void;
}

export function SearchSection({ selectedPlayerId, onSelectPlayer }: Props) {
  const router = useRouter();

  const handleSelectPlayer = (playerId: string) => {
    // Use replace to avoid building up history
    router.replace(`/players/${playerId}`, { scroll: false });
    onSelectPlayer(playerId);
  };

  return (
    <div className="p-3 border-b border-border/40" data-testid="sidebar-search">
      <PlayerSearchCommand
        onSelectPlayer={handleSelectPlayer}
        highlightedPlayerId={selectedPlayerId}
      />
    </div>
  );
}
```

### WS4: Profile Edit Migration

**Purpose:** Add Edit Profile button to Player360 header.

**Key Requirements:**
- Reuse existing `PlayerEditModal` component
- Mount modal at header level (outside suspense)
- Button visible only when player is selected
- Handle modal open/close state

**Implementation Pattern:**

```typescript
// components/player-360/header/player-360-header-content.tsx
"use client";

import { useState } from "react";
import { Pencil } from "lucide-react";
import { Button } from "@/components/ui/button";
import { PlayerEditModal } from "@/components/player-dashboard/player-edit-modal";
import { usePlayer } from "@/hooks/player/use-player";
import { PlayerIdentityBadge } from "./player-identity-badge";

interface Props {
  playerId: string;
}

export function Player360HeaderContent({ playerId }: Props) {
  const [editModalOpen, setEditModalOpen] = useState(false);
  const { data: player } = usePlayer(playerId);

  return (
    <div className="flex items-center justify-between px-4 py-3">
      <PlayerIdentityBadge player={player} />

      <div className="flex items-center gap-2">
        <Button
          variant="outline"
          size="sm"
          onClick={() => setEditModalOpen(true)}
          data-testid="edit-profile-button"
        >
          <Pencil className="h-4 w-4 mr-1" />
          Edit Profile
        </Button>
      </div>

      <PlayerEditModal
        playerId={playerId}
        open={editModalOpen}
        onOpenChange={setEditModalOpen}
      />
    </div>
  );
}
```

### WS5: Empty State Update

**Purpose:** Create purposeful empty state for `/players` (no selection).

**Key Requirements:**
- Guidance text for using search
- Recent players cards (if available)
- Visual hierarchy guiding to sidebar

**Implementation Pattern:**

```typescript
// Update components/player-360/empty-states.tsx
export function Player360EmptyState() {
  return (
    <div
      className="flex flex-col items-center justify-center h-full p-8"
      data-testid="player-360-empty-state"
    >
      <div className="relative mb-6">
        <div className="w-20 h-20 rounded-full bg-gradient-to-br from-accent/20 to-accent/5
                        border border-accent/30 flex items-center justify-center">
          <User className="h-10 w-10 text-accent/70" />
        </div>
      </div>

      <h2 className="text-xl font-semibold mb-2">Select a Player</h2>
      <p className="text-muted-foreground text-center max-w-md mb-6">
        Use the search in the sidebar to find a player, or select from your recent players.
      </p>

      <div className="flex items-center gap-2 text-sm text-muted-foreground">
        <kbd className="px-2 py-1 rounded bg-muted border text-xs">⌘K</kbd>
        <span>to search</span>
      </div>
    </div>
  );
}
```

### WS6: Mobile Drawer

**Purpose:** Create Sheet-based drawer for sidebar on mobile.

**Key Requirements:**
- Use shadcn/ui Sheet component
- Open via hamburger button in header
- Close on player selection
- Contains same content as desktop sidebar

**Implementation Pattern:**

```typescript
// components/player-360/sidebar/mobile-drawer.tsx
"use client";

import { Menu } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Sheet, SheetContent, SheetTrigger } from "@/components/ui/sheet";
import { SearchSection } from "./search-section";
import { RecentPlayersList } from "./recent-players-list";

interface Props {
  playerId: string | null;
  onSelectPlayer: (id: string) => void;
  open: boolean;
  onOpenChange: (open: boolean) => void;
}

export function MobileDrawer({ playerId, onSelectPlayer, open, onOpenChange }: Props) {
  const handleSelect = (id: string) => {
    onSelectPlayer(id);
    onOpenChange(false); // Close drawer on selection
  };

  return (
    <Sheet open={open} onOpenChange={onOpenChange}>
      <SheetTrigger asChild>
        <Button variant="ghost" size="icon" className="lg:hidden" data-testid="mobile-menu-button">
          <Menu className="h-5 w-5" />
        </Button>
      </SheetTrigger>
      <SheetContent side="left" className="w-80 p-0" data-testid="mobile-drawer">
        <SearchSection selectedPlayerId={playerId} onSelectPlayer={handleSelect} />
        <RecentPlayersList currentPlayerId={playerId} onSelectPlayer={handleSelect} />
      </SheetContent>
    </Sheet>
  );
}
```

### WS7: Keyboard Navigation Hook

**Purpose:** Create hook for search keyboard shortcuts.

**Key Requirements:**
- `Ctrl/Cmd + K` focuses search input
- `Esc` clears search query
- Second `Esc` closes drawer (mobile) / collapses sidebar (desktop)
- Respect existing input focus

**Implementation Pattern:**

```typescript
// hooks/player-360/use-search-keyboard.ts
"use client";

import { useEffect, useCallback } from "react";

interface Options {
  onFocusSearch: () => void;
  onClearSearch: () => void;
  onCollapseSidebar?: () => void;
  searchInputRef: React.RefObject<HTMLInputElement>;
}

export function useSearchKeyboard({
  onFocusSearch,
  onClearSearch,
  onCollapseSidebar,
  searchInputRef,
}: Options) {
  const handleKeyDown = useCallback((event: KeyboardEvent) => {
    // Cmd/Ctrl + K to focus search
    if ((event.metaKey || event.ctrlKey) && event.key === "k") {
      event.preventDefault();
      onFocusSearch();
      return;
    }

    // Esc behavior
    if (event.key === "Escape") {
      const isSearchFocused = document.activeElement === searchInputRef.current;
      const hasSearchValue = searchInputRef.current?.value;

      if (isSearchFocused && hasSearchValue) {
        onClearSearch();
      } else if (isSearchFocused) {
        onCollapseSidebar?.();
        searchInputRef.current?.blur();
      }
    }
  }, [onFocusSearch, onClearSearch, onCollapseSidebar, searchInputRef]);

  useEffect(() => {
    document.addEventListener("keydown", handleKeyDown);
    return () => document.removeEventListener("keydown", handleKeyDown);
  }, [handleKeyDown]);
}
```

### WS8: Navigation Cleanup

**Purpose:** Simplify navigation utilities and update dashboard.

**Key Requirements:**
- Remove `returnTo` encoding/decoding (no longer needed)
- Keep `validateReturnTo` for security (breadcrumb may still use it)
- Update `player-dashboard.tsx` to be minimal or redirect

**Files to Modify:**

1. `lib/navigation/return-to.ts` - Simplify or deprecate returnTo functions
2. `lib/navigation/index.ts` - Update exports
3. `components/player-dashboard/player-dashboard.tsx` - Update to redirect to /players

### WS9: Unit Tests

**Test Files:**

1. `components/player-360/__tests__/sidebar.test.tsx`
   - Sidebar renders collapsed/expanded correctly
   - Toggle persists to localStorage
   - Search section receives correct props

2. `components/player-360/__tests__/header-content.test.tsx`
   - Edit button opens modal
   - Modal receives correct playerId
   - Player identity displays correctly

3. `hooks/player-360/__tests__/use-search-keyboard.test.ts`
   - Cmd+K focuses search
   - Esc clears search value
   - Does not interfere with other inputs

4. `lib/navigation/__tests__/return-to.test.ts`
   - validateReturnTo still works for security

### WS10: E2E Tests

**File:** `e2e/workflows/player-360-embedded-search.spec.ts`

**Test Scenarios:**

```typescript
test.describe('Player 360 Embedded Search', () => {
  test('search and select player without page navigation', async ({ page }) => {
    await page.goto('/players');
    await expect(page.getByTestId('player-360-empty-state')).toBeVisible();

    // Search for player
    await page.getByTestId('sidebar-search').click();
    await page.keyboard.type('smith');

    // Select from results
    await page.getByTestId('player-result-abc-123').click();

    // URL updated, no full navigation
    await expect(page).toHaveURL('/players/abc-123');
    await expect(page.getByTestId('player-360-header')).toBeVisible();
  });

  test('switch players via search updates URL with replace', async ({ page }) => {
    await page.goto('/players/abc-123');

    // Search and select different player
    await page.keyboard.press('Meta+k');
    await page.keyboard.type('jones');
    await page.getByTestId('player-result-def-456').click();

    // URL changed
    await expect(page).toHaveURL('/players/def-456');

    // Back button goes to before /players, not to abc-123
    await page.goBack();
    await expect(page).not.toHaveURL('/players/abc-123');
  });

  test('edit profile from header', async ({ page }) => {
    await page.goto('/players/abc-123');

    await page.getByTestId('edit-profile-button').click();
    await expect(page.getByRole('dialog')).toBeVisible();

    // Edit and save
    await page.getByLabel('First Name').fill('Updated');
    await page.getByRole('button', { name: 'Save' }).click();

    // Modal closes, name updated
    await expect(page.getByRole('dialog')).not.toBeVisible();
  });

  test('mobile drawer behavior', async ({ page }) => {
    await page.setViewportSize({ width: 375, height: 667 });
    await page.goto('/players');

    // Sidebar hidden, drawer button visible
    await expect(page.getByTestId('player-360-sidebar')).not.toBeVisible();
    await expect(page.getByTestId('mobile-menu-button')).toBeVisible();

    // Open drawer
    await page.getByTestId('mobile-menu-button').click();
    await expect(page.getByTestId('mobile-drawer')).toBeVisible();

    // Select player closes drawer
    await page.getByTestId('player-result-abc-123').click();
    await expect(page.getByTestId('mobile-drawer')).not.toBeVisible();
    await expect(page).toHaveURL('/players/abc-123');
  });

  test('keyboard shortcut Cmd+K focuses search', async ({ page }) => {
    await page.goto('/players/abc-123');

    await page.keyboard.press('Meta+k');
    await expect(page.getByTestId('search-input')).toBeFocused();
  });
});
```

## Definition of Done

- [ ] All workstreams complete (WS1-WS10)
- [ ] All gates pass (type-check, lint, test-pass)
- [ ] No regressions in existing tests
- [ ] Catch-all route handles `/players` and `/players/[playerId]`
- [ ] Search sidebar is collapsible on desktop, drawer on mobile
- [ ] Player selection uses `router.replace()` (no history stack buildup)
- [ ] Edit Profile button accessible from Player360 header
- [ ] Keyboard shortcut `Cmd/Ctrl+K` focuses search
- [ ] Empty state displays when no player selected
- [ ] E2E tests pass for all scenarios

---

**Document Version:** 1.0.0
**Generated:** 2026-01-24
**Status:** Pending Approval
