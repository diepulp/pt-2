---
# EXECUTION-SPEC Frontmatter
# Generated by lead-architect skill

prd: PRD-OPS-CASH-OBS-001
prd_title: "Operational Cash-Out Observations (Walk-With / Chips Taken)"
service: RatingSlipService
mvp_phase: 2  # Session management phase (extends rating slip close flow)

# Workstream Definitions
workstreams:
  WS1:
    name: Database Layer
    description: Migration for pit_cash_observation table, RLS policies, type generation
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/20260106021105_prd_ops_cash_obs_001_pit_cash_observation.sql
    gate: schema-validation
    estimated_complexity: medium

  WS2:
    name: Write Path
    description: RPC or insert path that enforces created_by from auth context
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - supabase/migrations/*_prd_ops_cash_obs_001_rpc.sql
    gate: schema-validation
    estimated_complexity: low

  WS3:
    name: Client Integration
    description: Update useCloseWithFinancial to write pit_cash_observation instead of financial txn
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS1, WS2]
    outputs:
      - hooks/rating-slip-modal/use-close-with-financial.ts
    gate: type-check
    estimated_complexity: medium

  WS4:
    name: Shift Dashboard Consumption
    description: Update shift dashboard queries to include pit_cash_observation aggregates
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS1, WS2]
    outputs:
      - app/*/shift-dashboard/*
    gate: type-check
    estimated_complexity: medium

  WS5:
    name: Tests
    description: RLS policy tests, regression test for hook, dashboard aggregate coverage
    executor: e2e-testing
    executor_type: task-agent
    depends_on: [WS1, WS2, WS3, WS4]
    outputs:
      - hooks/rating-slip-modal/__tests__/use-close-with-financial.test.tsx
      - lib/supabase/__tests__/rls-pooling-safety.integration.test.ts
    gate: test-pass
    estimated_complexity: medium

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Foundation
    parallel: [WS1, WS2]
    gates: [schema-validation]

  - name: Phase 2 - Implementation
    parallel: [WS3, WS4]
    gates: [type-check]

  - name: Phase 3 - Integration & Tests
    parallel: [WS5]
    gates: [test-pass, rls-test]

# Validation Gates
gates:
  schema-validation:
    command: npm run db:types
    success_criteria: "Exit code 0, no type errors"

  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0"

  test-pass:
    command: npm test hooks/rating-slip-modal/__tests__/use-close-with-financial
    success_criteria: "All tests pass"
  rls-test:
    command: npm test lib/supabase/__tests__/rls-pooling-safety.integration.test.ts
    success_criteria: "RLS insert/select tests pass for pit_cash_observation"

# Dependencies on other PRDs/Services
external_dependencies:
  - prd: PRD-000
    service: CasinoService
    required_for: "Temporal authority (gaming day computation via compute_gaming_day)"
  - prd: PRD-003
    service: VisitService
    required_for: "visit_id FK relationship"
  - prd: PRD-008
    service: RatingSlipService
    required_for: "rating_slip_id FK relationship (optional)"
  - prd: PRD-009
    service: PlayerFinancialService
    required_for: "Separation of concerns - observations distinct from settlement ledger"

# Risks and Mitigations
risks:
  - risk: "Stakeholders may confuse observations with settlement transactions"
    mitigation: "Explicit table name 'pit_cash_observation', UI labels say 'Walk-with (estimate)'"
  - risk: "Duplicate observations on accidental double-submit"
    mitigation: "UI disables submit on in-flight; RPC supports optional idempotency_key for dedupe"
  - risk: "Silent failure if service call throws"
    mitigation: "Update hook to surface errors via toast notification, not silent catch"

---

# EXECUTION-SPEC: PRD-OPS-CASH-OBS-001 - Operational Cash-Out Observations

## Overview

This PRD introduces a **dedicated operational telemetry artifact** — `pit_cash_observation` — to record what pit bosses observe when players leave tables with chips (walk-with / chips taken). This separates operational observations from the authoritative financial ledger (`player_financial_transaction`), which remains cage-owned.

**Key Problem Solved**: The current "Chips Taken" UI attempts to create a `direction='out'` financial transaction, which pit bosses are blocked from per SEC-005. The error is silently swallowed, causing data loss.

**Solution**: New service writes to `pit_cash_observation` table (pit boss has INSERT permission), eliminating the silent failure.

## Scope

### In Scope
- New `pit_cash_observation` table with appropriate schema
- RLS policies for casino-scoped INSERT/SELECT for pit_boss, cashier, admin
- RPC write path that enforces `created_by_staff_id` from context (RLS remains defense-in-depth)
- Client hook update to write observations
- Shift dashboard aggregates include observations
- Unit and integration tests

### Out of Scope (PRD Non-Goals)
- Granting pit boss `direction='out'` permission on PlayerFinancial ledger
- Full cashier workflow (fills/drops/credits)
- CTR filing workflow expansion
- Cage confirmation/reconciliation workflow (post-MVP)

## Architecture Context

### Bounded Context Placement

**Existing Service**: `RatingSlipService` (Telemetry Context)

Per SRM patterns, telemetry augmentation stays in the RatingSlip bounded context:
- **Data**: `pit_cash_observation` table (add to SRM under RatingSlipService)
- **Business Rules**: Amount validation (> 0), required fields, enum values
- **Write Path**: RPC-only (no new bounded context required)

**Relationship to Existing Services**:
- **PlayerFinancialService**: Separate bounded context. Observations are NOT settlements.
- **VisitService**: `visit_id` is a required FK (observations are visit-scoped)
- **RatingSlipService**: `rating_slip_id` is optional FK (convenience link)
- **MTLService**: May consume observations for sub-threshold telemetry (read-only)

### Schema Design

```sql
-- Enum types
CREATE TYPE observation_amount_kind AS ENUM ('estimate', 'cage_confirmed');
CREATE TYPE observation_source AS ENUM ('walk_with', 'phone_confirmed', 'observed');

-- Core table
CREATE TABLE pit_cash_observation (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  casino_id UUID NOT NULL REFERENCES casino(id),
  gaming_day DATE NOT NULL,  -- Trigger-derived via compute_gaming_day(casino_id, observed_at)
  player_id UUID NOT NULL REFERENCES player(id),
  visit_id UUID NOT NULL REFERENCES visit(id),
  rating_slip_id UUID REFERENCES rating_slip(id),  -- Optional convenience link
  direction TEXT NOT NULL DEFAULT 'out' CHECK (direction = 'out'),
  amount NUMERIC NOT NULL CHECK (amount > 0),
  amount_kind observation_amount_kind NOT NULL DEFAULT 'estimate',
  source observation_source NOT NULL DEFAULT 'walk_with',
  observed_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  created_by_staff_id UUID NOT NULL REFERENCES staff(id),
  note TEXT,
  idempotency_key TEXT,  -- Optional for MVP; used for dedupe when present
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Unique for idempotency
CREATE UNIQUE INDEX pit_cash_obs_idempotency_idx
  ON pit_cash_observation (casino_id, idempotency_key);

-- Read path indexes (shift dashboards + visit history)
CREATE INDEX pit_cash_obs_casino_gaming_day_idx
  ON pit_cash_observation (casino_id, gaming_day);
CREATE INDEX pit_cash_obs_visit_observed_at_idx
  ON pit_cash_observation (visit_id, observed_at DESC);
```

### RLS Policies

Per ADR-015 (Hybrid Pattern C):
Actor binding uses `current_setting('app.actor_id')` with `auth.uid()` fallback per ADR-020 Track A.
Invariant: `current_setting('app.actor_id')` and `auth.uid()` resolve to `staff.id` for insert attribution.

```sql
-- SELECT: Pit Boss, Cashier, Admin can read within casino scope
CREATE POLICY pit_cash_obs_select ON pit_cash_observation
  FOR SELECT USING (
    auth.uid() IS NOT NULL
    AND casino_id = COALESCE(
      NULLIF(current_setting('app.casino_id', true), '')::uuid,
      (auth.jwt() -> 'app_metadata' ->> 'casino_id')::uuid
    )
    AND COALESCE(
      NULLIF(current_setting('app.staff_role', true), ''),
      auth.jwt() -> 'app_metadata' ->> 'staff_role'
    ) IN ('pit_boss', 'cashier', 'admin')
  );

-- INSERT: Pit Boss, Cashier, Admin can create within casino scope
CREATE POLICY pit_cash_obs_insert ON pit_cash_observation
  FOR INSERT WITH CHECK (
    auth.uid() IS NOT NULL
    AND casino_id = COALESCE(
      NULLIF(current_setting('app.casino_id', true), '')::uuid,
      (auth.jwt() -> 'app_metadata' ->> 'casino_id')::uuid
    )
    AND COALESCE(
      NULLIF(current_setting('app.staff_role', true), ''),
      auth.jwt() -> 'app_metadata' ->> 'staff_role'
    ) IN ('pit_boss', 'cashier', 'admin')
    AND created_by_staff_id = COALESCE(
      NULLIF(current_setting('app.actor_id', true), '')::uuid,
      auth.uid()
    )
  );
```

## Workstream Details

### WS1: Database Layer

**Purpose**: Create `pit_cash_observation` table with RLS policies.

**Deliverables**:
1. Migration file: `20260106021105_prd_ops_cash_obs_001_pit_cash_observation.sql`
   - Enum types (`observation_amount_kind`, `observation_source`)
   - Table with constraints and indexes
   - RLS policies per ADR-015 hybrid pattern
   - Gaming day trigger using `compute_gaming_day(casino_id, observed_at)`

**Acceptance Criteria**:
- [ ] `npm run db:types` succeeds
- [ ] RLS policies cover SELECT and INSERT
- [ ] `created_by_staff_id` derived from auth context (not client-provided)
- [ ] `gaming_day` populated by trigger
- [ ] `player_id` derived from `visit_id` or validated to match the visit

### WS2: Write Path

**Purpose**: Ensure inserts derive `created_by_staff_id` from auth context and enforce idempotency when present.

**Deliverables**:
1. SECURITY DEFINER RPC `rpc_create_pit_cash_observation(...)` that:
   - calls `set_rls_context_from_staff()` before any writes (ADR-024)
   - injects RLS context
   - sets `created_by_staff_id := current_setting('app.actor_id')::uuid` (fallback to `auth.uid()` per ADR-020 Track A)
   - ignores client-provided `created_by_staff_id`
   - treats `idempotency_key` as optional; when present, uses it for dedupe
   - derives `casino_id` from context (no client input) and validates `visit_id` belongs to it
   - normalizes `idempotency_key := NULLIF(p_idempotency_key, '')`
   - derives/validates `player_id` from the visit
   - if `rating_slip_id` is provided, validates it matches the same `visit_id`

**Write Policy**:
RPC enforces role/casino/actor checks inside the function (SECURITY DEFINER bypasses RLS), while still keeping RLS policies as defense-in-depth:
- actor context is present and resolves to staff
- `staff_role` in {`pit_boss`, `cashier`, `admin`}
- `casino_id` scope matches the resolved casino context
- `created_by_staff_id` forced from context (client field ignored)

**Acceptance Criteria**:
- [ ] RPC enforces `created_by_staff_id` from auth context (actor → auth.uid fallback)
- [ ] RPC accepts missing `idempotency_key` and only de-dupes when provided
- [ ] Inserts fail with actionable error if context is missing
- [ ] ADR-024 INV-1..INV-8 reviewed for spoofing lanes (no client-controlled actor/casino overrides)
- [ ] Visit/Player/Slip consistency enforced (visit ↔ player; slip ↔ visit if present)

### WS3: Client Integration

**Purpose**: Update `useCloseWithFinancial` hook to write observations.

**Deliverables**:
1. Update `hooks/rating-slip-modal/use-close-with-financial.ts`:
   - Replace `createFinancialTransaction` call with observation creation
   - Surface errors via toast (no silent catch)
   - Allow rating slip close to proceed even if observation write fails (best-effort + visible error)
   - Update JSDoc to reflect new behavior

### WS4: Shift Dashboard Consumption

**Purpose**: Ensure shift dashboard aggregates include pit cash observations.

**Deliverables**:
1. Update dashboard queries/endpoints to include:
   - totals by gaming day
   - last observed walk-with amount per player (if used)

**Acceptance Criteria**:
- [ ] Observations appear in shift dashboard aggregates

### WS5: Tests

**Purpose**: Ensure implementation correctness.

**Deliverables**:
1. Update `hooks/rating-slip-modal/__tests__/use-close-with-financial.test.tsx`:
   - Regression: no longer calls `createFinancialTransaction` with `direction='out'`
   - New: calls observation write with correct payload
   - Error handling: surfaces errors via mock toast
2. Update `lib/supabase/__tests__/rls-pooling-safety.integration.test.ts`:
   - RLS insert/select coverage for `pit_cash_observation` (pit_boss/cashier/admin)

**Acceptance Criteria**:
- [ ] Hook regression test confirms no financial txn out-direction call
- [ ] All tests pass: `npm test hooks/rating-slip-modal/__tests__/use-close-with-financial`
- [ ] RLS test coverage added and passing in `lib/supabase/__tests__/rls-pooling-safety.integration.test.ts`

## Definition of Done

- [ ] All workstreams complete
- [ ] All gates pass:
  - [ ] `npm run db:types` (schema-validation)
  - [ ] `npm run type-check` (type-check)
  - [ ] `npm test hooks/rating-slip-modal/__tests__/use-close-with-financial` (test-pass)
  - [ ] `npm test lib/supabase/__tests__/rls-pooling-safety.integration.test.ts` (rls-test)
- [ ] Pit Boss can submit "Chips Taken" and observe row in `pit_cash_observation`
- [ ] No silent failures - errors surfaced in UI
- [ ] `player_financial_transaction` NOT written for chips-taken action
- [ ] MVP-ROADMAP.md updated (if applicable)
- [ ] PRD status changed from "Draft" to "Implemented"
