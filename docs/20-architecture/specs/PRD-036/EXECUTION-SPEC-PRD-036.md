---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline (lead-architect + backend-service-builder + frontend-design-pt-2)

prd: PRD-036
prd_title: "Shift Win/Loss Opening Baseline — Ranked Fallback & Provenance"
service: TableContextService
mvp_phase: 1
category: BUGFIX
severity: High

workstreams:
  WS1:
    name: "RPC Migration — Ranked Opening Baseline Fallback"
    description: >
      Replace the single opening_snapshots CTE in rpc_shift_table_metrics with a ranked
      baseline cascade (A/B→C→D→E). Sources A and B are collapsed into a single
      'snapshot:prior_count' label because the system cannot yet distinguish a semantic
      opening count from a prior boundary count. Add provenance output columns. Fix win/loss
      sign convention to canonical formula: (closing - opening) - fills + credits.
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/20260219164631_prd036_shift_metrics_opening_baseline.sql
      - types/database.types.ts  # regenerated
    gate: schema-validation
    estimated_complexity: high

  WS2:
    name: "Service Layer — DTO Provenance & Null Aggregation Fix"
    description: >
      Extend ShiftTableMetricsDTO with opening provenance fields. Add OpeningSource type
      to provenance.ts. Fix casino/pit-level aggregation to use null-aware summation instead
      of null-to-zero coalescing. Update toShiftTableMetrics mapper for new RPC columns.
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - services/table-context/shift-metrics/dtos.ts
      - services/table-context/shift-metrics/provenance.ts
      - services/table-context/shift-metrics/service.ts
    gate: type-check
    estimated_complexity: medium

  WS3:
    name: "UI — Null Rendering Pipeline & Provenance Indicators"
    description: >
      Fix formatCents(null) to return em-dash globally. Add opening provenance indicators
      to hero win/loss and metrics table. Add missing baseline CTA. Reuse existing trust/
      component patterns.
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - lib/format.ts
      - components/shift-dashboard-v3/left-rail/hero-win-loss-compact.tsx
      - components/shift-dashboard-v3/center/metrics-table.tsx
      - components/shift-dashboard-v3/trust/opening-source-badge.tsx  # new
    gate: type-check
    estimated_complexity: medium

  WS4:
    name: "Tests — Service, Format, and Component Verification"
    description: >
      Update format.test.ts for null→em-dash. Add shift-metrics aggregation tests for
      null-aware summation. Add provenance mapping tests for opening_source. Add opening
      source badge render tests.
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS2, WS3]
    outputs:
      - lib/__tests__/format.test.ts
      - services/table-context/__tests__/shift-metrics-opening-baseline.test.ts  # new
    gate: test-pass
    estimated_complexity: medium

execution_phases:
  - name: "Phase 1 — RPC Migration"
    parallel: [WS1]
    gates: [schema-validation]

  - name: "Phase 2 — Service Layer"
    parallel: [WS2]
    gates: [type-check]

  - name: "Phase 3 — UI Changes"
    parallel: [WS3]
    gates: [type-check]

  - name: "Phase 4 — Tests & Build Validation"
    parallel: [WS4]
    gates: [test-pass, build]

gates:
  schema-validation:
    command: "npm run db:types-local"
    success_criteria: "Exit code 0, types regenerated with new RPC return columns"

  type-check:
    command: "npm run type-check"
    success_criteria: "Exit code 0, no type errors"

  test-pass:
    command: "npm test -- --testPathPattern='(format|shift-metrics-opening-baseline)' --silent"
    success_criteria: "All tests pass"

  build:
    command: "npm run build"
    success_criteria: "Exit code 0, no build errors"

external_dependencies:
  - prd: ADR-027
    service: TableContextService
    required_for: "gaming_table.par_total_cents column (exists). Canonical 'par-set timestamp' column for opening_at provenance — verify exact field name in current schema (par_updated_at per types, but confirm semantics)."

risks:
  - risk: "Global formatCents(null) change may affect unrelated tests"
    mitigation: "Correct behavior everywhere — null cents should never display as $0. Run full test suite."
  - risk: "Win/loss sign convention change alters existing values"
    mitigation: "This is a bugfix — current formula is inverted. New formula matches casino accounting standard."
  - risk: "par_total_cents is NULL for some tables"
    mitigation: "Source C falls through to D or E. No false data produced."
---

# EXECUTION-SPEC: PRD-036 — Shift Win/Loss Opening Baseline

## Overview

The shift dashboard shows "$0" for win/loss when a new casino performs its first inventory count mid-shift. The root cause: `rpc_shift_table_metrics` requires a pre-window snapshot that can't exist for new casinos, returns NULL, and the service/UI pipeline silently coalesces NULL to 0.

This EXECUTION-SPEC delivers a ranked opening baseline fallback (Sources A/B→C→D→E), provenance transparency so the UI explains where numbers come from, and honest null rendering across the entire format pipeline. Sources A and B are collapsed into a single `snapshot:prior_count` label because the system cannot currently distinguish a true semantic opening count from a prior shift's boundary count; if semantic opening snapshots are added later, the cascade and `opening_source` derivation will need refactoring.

## Scope

**In Scope:**
- RPC ranked baseline fallback with COALESCE/LATERAL cascade
- Provenance output columns (`opening_source`, `opening_bankroll_cents`, `opening_at`, `coverage_type`)
- Win/loss sign convention fix: `(closing - opening) - fills + credits`
- DTO extension with nullable provenance fields
- Null-aware casino/pit aggregation (no more null→0 coalescing)
- `formatCents(null)` → `"—"` globally
- Provenance indicators in hero and metrics table
- Missing baseline CTA

**Out of Scope:**
- New schema columns on `table_inventory_snapshot`
- `rpc_open_table_session` modifications
- `rpc_compute_table_rundown` fixes
- Legacy RPC security remediation
- Audit/compliance report filtering

## Architecture Context

- **Bounded Context:** TableContextService (sole owner — no cross-context writes)
- **ADR-024:** RPC continues to use `set_rls_context_from_staff()` — no new parameters
- **ADR-027:** `gaming_table.par_total_cents` exists. Canonical par-set timestamp column exists as `par_updated_at` in types — verify semantics before using for `opening_at` provenance.
- **No new SECURITY DEFINER functions** — `rpc_shift_table_metrics` remains SECURITY INVOKER
- **No RLS changes** — read-path only modification

---

## Workstream Details

### WS1: RPC Migration — Ranked Opening Baseline Fallback

**Purpose:** Replace the single `opening_snapshots` CTE with a ranked baseline cascade and add provenance columns to the return type.

**Migration:** `supabase/migrations/20260219164631_prd036_shift_metrics_opening_baseline.sql`

**Changes to `rpc_shift_table_metrics`:**

1. **Replace `opening_snapshots` CTE** with `opening_baseline` CTE using LEFT JOIN LATERAL:
   - Source A/B: Latest pre-window count snapshot (prior boundary count). A and B are collapsed — the system cannot yet distinguish a semantic opening count from a prior close. Emitted as `snapshot:prior_count`.
   - Source C: `gaming_table.par_total_cents` (bootstrap from par target)
   - Source D: Earliest snapshot within window (fallback for partial coverage)
   - Source E: NULL (no baseline available)
   - Use `COALESCE(pre.bankroll, gt.par_total_cents, inw.bankroll)` for ranked cascade
   - Use `CASE WHEN` chain for `opening_source` derivation

2. **Add return columns to RETURNS TABLE:**
   - `opening_source text` — one of: `'snapshot:prior_count'`, `'bootstrap:par_target'`, `'fallback:earliest_in_window'`, `'none'`
   - `opening_bankroll_cents bigint` — the resolved opening value (nullable)
   - `opening_at timestamptz` — timestamp of the source used (nullable)
   - `coverage_type text` — `'full'`, `'partial'`, or `'unknown'`

3. **Fix win/loss formula** to canonical sign convention:
   ```
   BEFORE: (closing - opening) + fills - credits  (WRONG)
   AFTER:  (closing - opening) - fills + credits  (CORRECT — casino accounting)
   ```

4. **Win/loss NULL conditions:** NULL when `opening_bankroll_cents IS NULL` OR closing snapshot missing

5. **Legacy opening columns are transitional** — `opening_snapshot_id`, `opening_snapshot_at`, `opening_bankroll_total_cents` are kept for transitional wiring but consumers MUST switch to the new provenance fields (`opening_source`, `opening_bankroll_cents`, `opening_at`, `coverage_type`). Legacy fields may be null or contain synthetic values depending on source. Do NOT treat legacy `opening_*` as authoritative when `opening_source != 'snapshot:prior_count'`.

**SQL Pattern (opening_baseline CTE):**
- Two LEFT JOIN LATERAL subqueries (pre-window + in-window) per table
- Single-pass: no sequential queries (NFR-1 compliance)
- `gaming_table` already in the `tables` CTE — par columns read from there

**Acceptance Criteria:**
- [ ] `npm run db:types-local` succeeds with new return columns in generated types
- [ ] Migration includes header comment with PRD-036 reference
- [ ] Uses CREATE OR REPLACE FUNCTION (idempotent)
- [ ] Ends with `NOTIFY pgrst, 'reload schema'`
- [ ] GRANT/REVOKE matches existing function signature
- [ ] Function name and parameter signature unchanged (`rpc_shift_table_metrics(timestamptz, timestamptz, uuid)`) — PostgREST will ghost the endpoint between deploys if the name or args change

---

### WS2: Service Layer — DTO Provenance & Null Aggregation Fix

**Purpose:** Propagate new RPC provenance columns through the service layer and fix null-to-zero coalescing in aggregation.

**File Changes:**

#### `services/table-context/shift-metrics/dtos.ts`
Add to `ShiftTableMetricsDTO` (all nullable per NFR-3):
```typescript
opening_source: OpeningSource | null;
opening_bankroll_cents: number | null;
opening_at: string | null;
coverage_type: CoverageType | null;
```

Add to `ShiftCasinoMetricsDTO` and `ShiftPitMetricsDTO`:
```typescript
tables_missing_baseline_count: number;
```

Change `win_loss_inventory_total_cents` and `win_loss_estimated_total_cents` from `number` to `number | null` on pit and casino DTOs.

#### `services/table-context/shift-metrics/provenance.ts`
Add new types:
```typescript
export type OpeningSource =
  | 'snapshot:prior_count'
  | 'bootstrap:par_target'
  | 'fallback:earliest_in_window'
  | 'none';

export type CoverageType = 'full' | 'partial' | 'unknown';
```

#### `services/table-context/shift-metrics/service.ts`

1. **`toShiftTableMetrics` mapper** — Map new RPC columns:
   - `opening_source` from `r.opening_source`
   - `opening_bankroll_cents` from `r.opening_bankroll_cents` (nullable Number)
   - `opening_at` from `r.opening_at` (nullable string)
   - `coverage_type` from `r.coverage_type`

2. **Casino/pit aggregation** — Replace null-to-zero pattern:
   ```typescript
   // BEFORE (lossy): table.win_loss_inventory_cents ?? 0
   // AFTER (null-aware):
   const tablesWithInventory = tables.filter(t => t.win_loss_inventory_cents != null);
   win_loss_inventory_total_cents: tablesWithInventory.length > 0
     ? tablesWithInventory.reduce((sum, t) => sum + t.win_loss_inventory_cents!, 0)
     : null,
   tables_missing_baseline_count: tables.length - tablesWithInventory.length,
   ```

3. **Fix in THREE locations:** `getShiftAllPitsMetrics`, `getShiftDashboardSummary` pit aggregation loop, and `getShiftDashboardSummary` casino aggregation block.

**Acceptance Criteria:**
- [ ] `npm run type-check` passes
- [ ] New DTO fields are nullable (NFR-3)
- [ ] No `null ?? 0` patterns remain for win/loss aggregation
- [ ] `tables_missing_baseline_count` exposed at pit and casino level

---

### WS3: UI — Null Rendering Pipeline & Provenance Indicators

**Purpose:** Fix `formatCents(null)` globally and add provenance indicators to the shift dashboard.

**File Changes:**

#### `lib/format.ts` (global fix — FR-7)

**BEFORE:** Null was rendered as a dollar value (`'$0'`) in currency formatters and/or coalesced to 0 upstream. The specific implementation varies per function but the net effect is that null input produces a misleading dollar string.

**AFTER:** Null always renders as em-dash (`'\u2014'`) across ALL currency formatters: `formatCents`, `formatDollars`, `formatCentsDelta`, `formatDollarsDelta`, and their deprecated aliases (`formatCurrency`, `formatCurrencyDelta`). Zero (`0`) continues to render as `'$0'` — zero is not null.

#### `components/shift-dashboard-v3/trust/opening-source-badge.tsx` (NEW)
New trust component for opening source provenance display:
- `opening_source = 'bootstrap:par_target'` → amber badge "Est. from par"
- `opening_source = 'fallback:earliest_in_window'` → amber badge "Partial window"
- `opening_source = 'snapshot:prior_count'` → no badge (normal case)
- `opening_source = 'none'` → red badge "No baseline"
- Follows existing `MetricGradeBadge` pattern (small inline badge)

Export from `trust/index.ts`.

#### `components/shift-dashboard-v3/left-rail/hero-win-loss-compact.tsx`

1. Accept new props: `openingSource`, `coverageType`, `tablesMissingBaselineCount`, `tablesCount` from DTO
2. Replace `const value = winLossCents ?? 0` with null-aware rendering
3. Remove the `?? 0` fallback that masks null

**Casino hero display rules (single source of truth):**

| Condition | Hero Display |
|-----------|-------------|
| `winLossCents != null` and some tables missing | Show formatted total + badge: "{N} of {M} tables missing baseline" |
| `winLossCents != null` and no tables missing | Show formatted total (normal case) |
| `winLossCents === null` (all tables null) | Show "N/A" + `MissingDataWarning` with CTA "Record opening count" |

**Per-table provenance (when hero shows a value):**
| `opening_source` | Badge |
|------------------|-------|
| `'snapshot:prior_count'` | No badge (normal) |
| `'bootstrap:par_target'` | "Est. from par" (amber) |
| `'fallback:earliest_in_window'` | "Partial window" (amber) |
| `'none'` | "No baseline" (red) |

#### `components/shift-dashboard-v3/center/metrics-table.tsx`

1. Update `TableRow` to show `OpeningSourceBadge` next to win/loss value
2. When `win_loss_estimated_cents` is null, show `MissingDataWarning` inline (existing component)
3. No structural table changes — badge appears inline in the win/loss cell

**Acceptance Criteria:**
- [ ] `formatCents(null)` returns `"—"` (em dash)
- [ ] `formatCents(0)` still returns `"$0"`
- [ ] Hero shows "N/A" + CTA when `opening_source = 'none'`
- [ ] Hero shows "Est. from par" badge when `opening_source = 'bootstrap:par_target'`
- [ ] Metrics table shows provenance badge per table row
- [ ] `npm run type-check` passes

---

### WS4: Tests — Service, Format, and Component Verification

**Purpose:** Verify all PRD-036 DoD test requirements.

**File Changes:**

#### `lib/__tests__/format.test.ts` (UPDATE)
Update existing null tests to expect `"—"` instead of `"$0"`:
- `formatCents(null)` → `"—"`
- `formatCents(undefined)` → `"—"`
- `formatDollars(null)` → `"—"`
- `formatDollars(undefined)` → `"—"`
- `formatDollarsDelta(null)` → `"—"`
- `formatCentsDelta(null)` → `"—"`
- `formatCurrency(null)` → `"—"` (deprecated, delegates to formatCents)
- `formatCurrencyDelta(null)` → `"—"` (deprecated, delegates to formatCentsDelta)
- Verify `formatCents(0)` still returns `"$0"` (zero is NOT null)
- Verify `formatCents(1000)` returns `"$10"`

#### `services/table-context/__tests__/shift-metrics-opening-baseline.test.ts` (NEW)

**Test Cases:**

1. **Provenance mapping — Source A (prior count):**
   - RPC row with `opening_source = 'snapshot:prior_count'` → DTO has correct provenance fields

2. **Provenance mapping — Source C (par bootstrap):**
   - RPC row with `opening_source = 'bootstrap:par_target'` → DTO has `opening_bankroll_cents` equal to par value

3. **Provenance mapping — Source D (earliest in-window):**
   - RPC row with `opening_source = 'fallback:earliest_in_window'`, `coverage_type = 'partial'`

4. **Provenance mapping — Source E (none):**
   - RPC row with `opening_source = 'none'`, null win/loss values

5. **Casino aggregation — null-aware summation:**
   - 3 tables: 2 with win/loss, 1 with null → total sums only 2, `tables_missing_baseline_count = 1`

6. **Casino aggregation — all null:**
   - 3 tables all with null win/loss → total is null, `tables_missing_baseline_count = 3`

7. **Pit aggregation — null-aware summation:**
   - Same pattern as casino but at pit level

8. **Win/loss sign convention regression test:**
   - Known fixture: opening=50000, closing=45000, fills=10000, credits=5000
   - Expected: `(45000 - 50000) - 10000 + 5000 = -10000` (casino lost $100)
   - Guards against sign inversion reintroduction

**Test pattern:** Use `makeTable()` factory from existing `shift-provenance-rollup.test.ts` pattern.

**Acceptance Criteria:**
- [ ] All format tests pass with new null behavior
- [ ] Null aggregation tests cover mixed null/non-null scenarios
- [ ] Provenance mapping tests cover all four sources
- [ ] `npm test -- --testPathPattern='(format|shift-metrics-opening-baseline)' --silent` passes

---

## Definition of Done

### Functionality
- [ ] `rpc_shift_table_metrics` returns non-NULL `win_loss_inventory_cents` when `par_total_cents` is set (Source C)
- [ ] RPC returns `opening_source`, `opening_bankroll_cents`, `opening_at`, `coverage_type` in every row
- [ ] `opening_source` correctly reflects which source was used (A/B, C, D, E)
- [ ] Casino-level aggregation excludes tables with NULL win/loss from the sum
- [ ] `formatCents(null)` returns `"—"` in all contexts

### Data & Integrity
- [ ] Provenance fields populated for every non-NULL win/loss row
- [ ] Bootstrap baseline uses `par_total_cents` at query time (not cached)

### Security & Access
- [ ] RPC continues to derive context via `set_rls_context_from_staff()` (ADR-024)
- [ ] No new SECURITY DEFINER functions introduced

### Testing
- [ ] Unit test: `formatCents(null)` → `"—"`, `formatCents(0)` → `"$0"`
- [ ] Service test: casino aggregation with mix of null/non-null → correct total + excluded count
- [ ] Provenance mapping: all four sources produce correct DTO values

### Operational Readiness
- [ ] Migration passes `npm run db:types-local` and `npm run type-check`
- [ ] `npm run build` succeeds
