---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline skill

prd: PRD-MTL-VIEW-MODAL-KILL-REVERSE-BRIDGE
prd_title: "MTL View Modal & Kill Reverse Bridge"
service: MtlService
mvp_phase: 2  # Session/Compliance phase

# Workstream Definitions
workstreams:
  WS1:
    name: Database Constraint for Derived-Only Financial Types
    description: Add CHECK constraint enforcing buy_in/cash_out MTL entries must have idempotency_key LIKE 'fin:%'
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/20260120180000_mtl_derived_only_constraint.sql
    gate: schema-validation
    estimated_complexity: low

  WS2:
    name: MtlEntryViewModal Component
    description: Read-only modal component preserving MtlEntryForm visuals, with Print and Adjust buttons, including print CSS
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - components/mtl/mtl-entry-view-modal.tsx
    gate: type-check
    estimated_complexity: medium

  WS3:
    name: Compliance Dashboard Integration
    description: Replace MtlEntryForm Dialog with MtlEntryViewModal, wire Adjust button to AdjustmentModal
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - components/mtl/compliance-dashboard.tsx
    gate: type-check
    estimated_complexity: medium

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Foundation (Parallel)
    parallel: [WS1, WS2]
    gates: [schema-validation, type-check]

  - name: Phase 2 - Integration
    parallel: [WS3]
    gates: [type-check, build]

# Validation Gates
gates:
  schema-validation:
    command: npm run db:types
    success_criteria: "Exit code 0, types regenerated"

  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0"

  build:
    command: npm run build
    success_criteria: "Exit code 0"

# External Dependencies
external_dependencies:
  - component: AdjustmentModal
    path: components/modals/rating-slip/adjustment-modal.tsx
    required_for: "Financial adjustment workflow from MtlEntryViewModal"
  - trigger: trg_derive_mtl_from_finance
    path: supabase/migrations/20260116111329_finance_to_mtl_derivation.sql
    required_for: "Forward bridge must continue working (finance → MTL)"

# Risks and Mitigations
risks:
  - risk: "Existing MTL entries without 'fin:' prefix for buy_in/cash_out would violate constraint"
    mitigation: "Verify no such entries exist before applying constraint; if found, backfill idempotency_key"
  - risk: "Compliance Dashboard loses create functionality"
    mitigation: "By design - financial types must originate from Rating Slip Modal (finance-first)"

---

# EXECUTION-SPEC: PRD-MTL-VIEW-MODAL-KILL-REVERSE-BRIDGE

## Overview

This PRD eliminates the reverse MTL-Finance bridge (which was designed but never implemented) and enforces that financial-type MTL entries (`buy_in`, `cash_out`) can ONLY be created via the forward bridge from `player_financial_transaction`. The Compliance Dashboard transitions from an editable `MtlEntryForm` to a read-only `MtlEntryViewModal` with Print and Adjust actions.

**Key Decision**: `player_financial_transaction` is the single source of truth for rating slip totals. MTL entries for financial types are strictly **derived** (via forward bridge with `idempotency_key LIKE 'fin:%'`).

## Scope

### In Scope
- Database CHECK constraint preventing manual financial-type MTL inserts
- Read-only `MtlEntryViewModal` component with existing visual design
- Print button with `@media print` styling
- Adjust button wiring to existing `AdjustmentModal`
- Compliance Dashboard integration

### Out of Scope
- Bidirectional editing (deferred post-MVP)
- MTL amendments/audit notes (future enhancement)
- Non-financial MTL types (compliance-only entries unaffected)
- Reverse bridge removal (never existed in codebase)

## Architecture Context

**SRM Ownership**: MtlService owns `mtl_entry` table
**ADR Reference**: Forward bridge per ADR-015 guardrails (fn_derive_mtl_from_finance)
**Financial Authority**: PlayerFinancialService owns `player_financial_transaction`

The forward bridge trigger (`trg_derive_mtl_from_finance`) automatically creates MTL entries when pit transactions are inserted into `player_financial_transaction`. The new constraint ensures this is the ONLY path for financial-type MTL entries.

## Workstream Details

### WS1: Database Constraint for Derived-Only Financial Types

**Purpose**: Enforce that `buy_in` and `cash_out` MTL entries must originate from the forward bridge.

**Deliverables**:
1. Migration file adding CHECK constraint to `mtl_entry` table

**SQL Implementation**:
```sql
ALTER TABLE public.mtl_entry
ADD CONSTRAINT mtl_financial_types_must_be_derived
CHECK (
  txn_type NOT IN ('buy_in', 'cash_out')
  OR (idempotency_key IS NOT NULL AND idempotency_key LIKE 'fin:%')
);
```

**Acceptance Criteria**:
- [ ] Constraint exists on `mtl_entry` table
- [ ] Manual INSERT of `buy_in` with NULL idempotency_key fails
- [ ] Manual INSERT of `buy_in` with `mtl:xxx` idempotency_key fails
- [ ] INSERT via forward bridge (with `fin:xxx` key) succeeds
- [ ] `npm run db:types` completes successfully

### WS2: MtlEntryViewModal Component

**Purpose**: Read-only modal displaying MTL entries for a patron, with Print and Adjust actions.

**Preserve from MtlEntryForm**:
- Patron info section (name, account, DOB)
- Running totals display with threshold indicators ($3k MTL threshold)
- Transaction log table with running totals
- Gaming day display
- All visual styling, animations, and threshold badges

**Remove**:
- `TransactionEntryForm` component (create functionality)
- `PhysicalCharacteristicsSection` inputs (or make display-only)
- `useCreateMtlEntry` mutation
- `useOptimistic` state (use server data only)
- Form submission logic

**Add**:
- Modal wrapper (Dialog from shadcn/ui)
- Print button (calls `window.print()`)
- Adjust button (opens `AdjustmentModal` for selected entry)
- Print-specific CSS (`@media print` or Tailwind `print:` variants)

**Component Props**:
```typescript
interface MtlEntryViewModalProps {
  isOpen: boolean;
  onClose: () => void;
  patron: {
    id: string;
    firstName?: string;
    lastName?: string;
    dateOfBirth?: string;
  };
  casinoId: string;
  gamingDay: string;
  onAdjust?: (entry: MtlEntryDTO) => void;
}
```

**Acceptance Criteria**:
- [ ] Modal displays patron info and transaction log
- [ ] No input fields or create functionality
- [ ] Print button triggers `window.print()`
- [ ] Adjust button available for each entry
- [ ] `@media print` hides modal chrome, shows clean form
- [ ] `npm run type-check` passes

### WS3: Compliance Dashboard Integration

**Purpose**: Replace editable `MtlEntryForm` Dialog with read-only `MtlEntryViewModal`.

**Changes to compliance-dashboard.tsx**:

1. Replace import:
   ```tsx
   // Before
   import { MtlEntryForm } from "./mtl-entry-form";
   // After
   import { MtlEntryViewModal } from "./mtl-entry-view-modal";
   ```

2. Add adjustment state:
   ```tsx
   const [adjustmentTarget, setAdjustmentTarget] = useState<MtlEntryDTO | null>(null);
   ```

3. Replace Dialog content:
   ```tsx
   <MtlEntryViewModal
     isOpen={entryDialogOpen}
     onClose={() => {
       setEntryDialogOpen(false);
       setSelectedPatron(null);
     }}
     patron={{
       id: selectedPatron.uuid,
       firstName: selectedPatron.firstName,
       lastName: selectedPatron.lastName,
       dateOfBirth: selectedPatron.dateOfBirth,
     }}
     casinoId={casinoId}
     gamingDay={gamingDay}
     onAdjust={(entry) => setAdjustmentTarget(entry)}
   />
   ```

4. Add AdjustmentModal:
   ```tsx
   <AdjustmentModal
     isOpen={adjustmentTarget !== null}
     onClose={() => setAdjustmentTarget(null)}
     currentTotal={adjustmentTarget?.amount ?? 0}
     onSubmit={handleAdjustmentSubmit}
   />
   ```

**Acceptance Criteria**:
- [ ] Clicking patron row opens read-only modal (not editable form)
- [ ] "New Entry" button removed or repurposed
- [ ] Adjust button opens `AdjustmentModal`
- [ ] Print button works from modal
- [ ] Forward bridge still creates MTL entries (verified via Rating Slip workflow)
- [ ] `npm run type-check` passes
- [ ] `npm run build` passes

## Definition of Done

- [ ] WS1: Database constraint deployed and verified
- [ ] WS2: MtlEntryViewModal component created with print support
- [ ] WS3: Compliance Dashboard uses view modal, adjust wiring complete
- [ ] All gates pass (schema-validation, type-check, build)
- [ ] Forward bridge continues to work (create buy-in from Rating Slip → appears in Compliance Dashboard)
- [ ] No regressions in existing tests
- [ ] Rating slip totals remain correct (derived from PFT only)

## Testing Verification

### Migration Verification (WS1)
```sql
-- Verify constraint exists
SELECT conname FROM pg_constraint WHERE conname = 'mtl_financial_types_must_be_derived';
-- Expected: 1 row

-- Verify constraint blocks manual insert
INSERT INTO mtl_entry (patron_uuid, casino_id, txn_type, amount, direction, gaming_day, occurred_at)
VALUES (gen_random_uuid(), 'casino-uuid', 'buy_in', 10000, 'in', '2026-01-20', now());
-- Expected: ERROR (constraint violation)
```

### UI Verification (WS2, WS3)
1. Open Compliance Dashboard
2. Select patron with existing MTL entries
3. Verify modal opens in read-only mode (no input fields)
4. Verify Print button generates clean output
5. Verify Adjust button opens AdjustmentModal
6. Create buy-in from Rating Slip Modal
7. Verify new entry appears in Compliance Dashboard (forward bridge works)
