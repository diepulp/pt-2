---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline skill (lead-architect scaffold + domain expert refinements)

prd: PERF-007
prd_title: "Shift Dashboard V3 Comprehensive Audit Remediation"
service: ShiftDashboardV3
mvp_phase: 2

workstreams:
  WS1:
    name: Quick-Win Code Fixes
    description: >
      Fix broken Tailwind classes (P0-1), eliminate useEffect-based timeWindow init (P1-4),
      extract Recharts dot/activeDot constants (P2-7), memoize computed values (P2-2),
      add error destructuring from queries (P1-3), remove redundant lastUpdate state (P3-14).
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - components/shift-dashboard-v3/center/alerts-strip.tsx
      - components/shift-dashboard-v3/shift-dashboard-v3.tsx
      - components/shift-dashboard-v3/charts/win-loss-trend-chart.tsx
      - components/shift-dashboard-v3/center/metrics-table.tsx
      - components/shift-dashboard-v3/right-rail/telemetry-rail-panel.tsx
    gate: type-check
    estimated_complexity: low

  WS2:
    name: React Performance & Structural Refactoring
    description: >
      Add React.memo to heavy child components (P1-1), code-split Recharts via lazy/Suspense (P2-1),
      align staleTime/refetchInterval across 3 query hooks (P2-3), extract PitTable from
      MetricsTable to reduce LOC and enable code reuse (P2-8).
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - components/shift-dashboard-v3/shift-dashboard-v3.tsx
      - components/shift-dashboard-v3/center/metrics-table.tsx
      - components/shift-dashboard-v3/center/pit-table.tsx
      - components/shift-dashboard-v3/charts/win-loss-trend-chart.tsx
      - hooks/shift-dashboard/*.ts
    gate: type-check
    estimated_complexity: medium

  WS3:
    name: Error Boundary Hierarchy
    description: >
      Implement ADR-032 three-tier error boundary hierarchy for shift dashboard route (P1-2).
      PanelErrorBoundary already exists (from PERF-006). Need: create route error.tsx file,
      wrap each panel in orchestrator with PanelErrorBoundary.
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - app/(protected)/shift-dashboard/error.tsx
      - components/shift-dashboard-v3/shift-dashboard-v3.tsx
    gate: type-check
    estimated_complexity: low

  WS4:
    name: RSC Data Prefetching
    description: >
      Convert server component page.tsx from pass-through to data-fetching entry point (P2-4).
      Use TanStack Query v5 dehydrate/HydrationBoundary pattern to prefetch shift dashboard
      data server-side, eliminating client-side loading waterfall on cold mount.
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - app/(protected)/shift-dashboard/page.tsx
    gate: type-check
    estimated_complexity: medium

  WS5:
    name: Security & Auth Hardening
    description: >
      P1-5 RESOLVED: proxy.ts already exists with Next.js 16 convention (middleware.ts.bak is
      historical artifact — delete it). Remaining: add auth enforcement to review route (P1-6),
      clear TanStack Query cache on logout (P2-5), sanitize database error messages in
      visitors-summary route (P2-6), remove as-any type bypass (P3-15).
    executor: api-builder
    executor_type: skill
    depends_on: []
    outputs:
      - app/review/shift-dashboard-v3/page.tsx
      - app/api/v1/shift-dashboards/*/route.ts
      - components/logout-button.tsx
    gate: type-check
    estimated_complexity: medium

  WS6:
    name: Accessibility Remediation
    description: >
      Add aria-live regions for dynamic metric updates (P0-2), add focus-visible indicators (P0-3),
      add role=progressbar with aria-valuenow/min/max to CoverageBar (P1-9), add accessible
      labels to TelemetryQualityIndicator (P1-10), add mobile responsive rail collapse (P1-11),
      table captions and scope=col (P2-15-19), chart focus management (P3-10-12).
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - components/shift-dashboard-v3/shift-dashboard-v3.tsx
      - components/shift-dashboard-v3/trust/coverage-bar.tsx
      - components/shift-dashboard-v3/trust/telemetry-quality-indicator.tsx
      - components/shift-dashboard-v3/center/alerts-strip.tsx
      - components/shift-dashboard-v3/center/metrics-table.tsx
      - components/shift-dashboard-v3/charts/win-loss-trend-chart.tsx
      - components/shift-dashboard-v3/right-rail/telemetry-rail-panel.tsx
    gate: type-check
    estimated_complexity: medium

  WS7:
    name: Component Test Coverage
    description: >
      Add Jest/RTL unit tests for shift-dashboard-v3 orchestrator (P1-7), MetricsTable (P1-8),
      AlertsStrip (P2-9), and TelemetryRailPanel (P2-13). Tests cover rendering, error states,
      loading states, data transformation, and user interactions.
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS2, WS3]
    outputs:
      - components/shift-dashboard-v3/__tests__/shift-dashboard-v3.test.tsx
      - components/shift-dashboard-v3/__tests__/metrics-table.test.tsx
      - components/shift-dashboard-v3/__tests__/alerts-strip.test.tsx
      - components/shift-dashboard-v3/__tests__/telemetry-rail-panel.test.tsx
    gate: test-pass
    estimated_complexity: medium

  WS8:
    name: E2E Test Improvements
    description: >
      Retarget E2E tests from /review/shift-dashboard-v3 to auth-protected /(protected)/shift-dashboard
      route (P2-11). Add data-driven assertions beyond structural layout checks (P2-12).
      Add authenticated test fixtures, error state testing, loading state transitions.
    executor: e2e-testing
    executor_type: skill
    depends_on: [WS5, WS7]
    outputs:
      - e2e/workflows/shift-dashboard-v3-layout.spec.ts
      - e2e/fixtures/shift-dashboard-helpers.ts
    gate: test-pass
    estimated_complexity: medium

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: "Phase 1 - Foundation (Quick Wins + Security)"
    parallel: [WS1, WS5]
    gates: [type-check]

  - name: "Phase 2 - Structural (Perf + Error Boundaries + A11y)"
    parallel: [WS2, WS3, WS6]
    gates: [type-check]

  - name: "Phase 3 - Integration (RSC Prefetch + Component Tests)"
    parallel: [WS4, WS7]
    gates: [type-check, test-pass]

  - name: "Phase 4 - Validation (E2E Tests)"
    parallel: [WS8]
    gates: [test-pass, build]

# Validation Gates
gates:
  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0"

  lint:
    command: npm run lint
    success_criteria: "Exit code 0, max-warnings=0"

  test-pass:
    command: npm test -- --passWithNoTests components/shift-dashboard-v3/
    success_criteria: "All tests pass"

  build:
    command: npm run build
    success_criteria: "Exit code 0"

# No external dependencies — this is a remediation spec for existing code
external_dependencies: []

# Risks and Mitigations
risks:
  - risk: "React.memo additions (WS2) may mask bugs if props are mutated"
    mitigation: "Verify all props are immutable (query data, callbacks); test with React strict mode"

  - risk: "RSC prefetching (WS4) requires server-side Supabase client with auth context"
    mitigation: "Use createClient from @/lib/supabase/server (project standard); verify casino-scoped data loads correctly"

  - risk: "Recharts lazy loading (WS2) may cause layout shift on chart render"
    mitigation: "Use Suspense fallback with skeleton matching chart dimensions"

  - risk: "E2E auth fixtures (WS8) may be flaky in CI without stable test accounts"
    mitigation: "Use service role client for test data setup; pre-authenticate via API, not UI login"

---

# EXECUTION-SPEC: PERF-007 - Shift Dashboard V3 Comprehensive Audit Remediation

## Overview

Remediate 54 findings from the PERF-007 comprehensive audit of shift-dashboard-v3. The audit covers performance (React re-renders, code splitting, query alignment), security (unprotected review routes, DB error leaks, type safety), accessibility (WCAG 2.1 AA gaps), and quality (missing tests, broken Tailwind). Note: P1-5 (middleware disabled) was already resolved — `proxy.ts` (Next.js 16 convention) is active.

**Source**: `docs/issues/perf/PERF-007-SHIFT-DASHBOARD-V3-COMPREHENSIVE-AUDIT.md`

## Scope

- **In Scope**: All 54 findings (3 P0, 11 P1, 19 P2, 15 P3, 6 P4) within shift-dashboard-v3 bounded context
- **Out of Scope**: P2-10 (visitors not scoped to time window) — requires product decision on filter semantics; logged as separate issue

## Architecture Context

- **Bounded Context**: shift-dashboard-v3 is a **cross-context read aggregator** with no owned tables (SRM v4.11.1)
- **Data Sources**: Reads from RatingSlipService (`pit_cash_observation`), VisitService, MTLService
- **Error Boundaries**: ADR-032 defines three-tier hierarchy; `PanelErrorBoundary` already exists from PERF-006
- **Auth**: ADR-030 auth pipeline hardening; `proxy.ts` (Next.js 16 convention) handles session refresh via `updateSession()`
- **Component Tree**: 22 components in `components/shift-dashboard-v3/`, 3 query hooks in `hooks/shift-dashboard/`

## Workstream Details

### WS1: Quick-Win Code Fixes

**Purpose**: Fix critical broken functionality and low-risk code improvements that unblock subsequent workstreams.

**Findings Addressed**: P0-1, P1-3, P1-4, P2-2, P2-7, P3-14

**Deliverables**:

1. **Fix broken Tailwind in AlertItem** (`alerts-strip.tsx:92`)
   - Replace dynamic `hover:${colorConfig.border}/50` with static Tailwind classes
   - Use a colorConfig map that returns complete static class strings
   - Tailwind CSS v4 compiler cannot see dynamic interpolation

2. **Eliminate useEffect-based timeWindow init** (`shift-dashboard-v3.tsx:58-66`)
   - Replace `useState(null) + useEffect` with direct `useState(getDefaultWindow)`
   - Lazy initializer avoids SSR/client Date mismatch while eliminating wasted render

3. **Extract Recharts constants** (`win-loss-trend-chart.tsx:169-170,188,197`)
   - Hoist `dot={{ r: 4 }}` and `activeDot={{ r: 6 }}` to module-level constants
   - Prevents new object allocation every render

4. **Memoize computed values**
   - `computeQualityCounts` in orchestrator (`shift-dashboard-v3.tsx:93`)
   - `filteredTables` in MetricsTable (`metrics-table.tsx:214`)
   - `sortedPits` in TelemetryRailPanel (`telemetry-rail-panel.tsx:135-141`)

5. **Add error destructuring from queries** (`shift-dashboard-v3.tsx:71-82`)
   - Destructure `error` from all 3 query hooks
   - Pass errors to panel components for proper error state rendering

6. **Remove redundant lastUpdate state** (`shift-dashboard-v3.tsx:59,84-88`)
   - Replace with `dataUpdatedAt` from TanStack Query (already available)

**Acceptance Criteria**:
- [ ] No dynamic Tailwind class interpolation in AlertItem
- [ ] `timeWindow` initializes without useEffect
- [ ] Recharts dot/activeDot are module-level constants
- [ ] `useMemo` wraps expensive computations (filteredTables, sortedPits, qualityCounts)
- [ ] All query hooks destructure `error`
- [ ] `lastUpdate` state removed, replaced with `dataUpdatedAt`
- [ ] `npm run type-check` passes

### WS2: React Performance & Structural Refactoring

**Purpose**: Reduce unnecessary re-renders, improve bundle efficiency, and align query caching strategy.

**Findings Addressed**: P1-1, P2-1, P2-3, P2-8

**Deliverables**:

1. **React.memo on heavy child components** (P1-1)
   - Wrap `AlertsStrip`, `MetricsTable`, `WinLossTrendChart`, `TelemetryRailPanel` with `React.memo`
   - Justified: orchestrator has 3 independent query hooks causing 5-9 full tree re-renders on cold mount
   - Each child receives stable subset of props; memo prevents cascade

2. **Code-split Recharts via lazy/Suspense** (P2-1)
   - `const WinLossTrendChart = lazy(() => import('./charts/win-loss-trend-chart'))`
   - Wrap in `<Suspense fallback={<ChartSkeleton />}>` with dimensions matching chart
   - Recharts is ~200KB; defers load until chart panel visible

3. **Align staleTime/refetchInterval** (P2-3)
   - Standardize all 3 hooks: `staleTime: 30_000`, `refetchInterval: 30_000`
   - Remove `'use client'` directive from `use-cash-obs-summary.ts` (unnecessary for hook files)
   - Ensures consistent cache behavior across dashboard panels

4. **Extract PitTable component** (P2-8)
   - Extract duplicated table structure from MetricsTable (lines 270-320 vs 322-373)
   - Create `pit-table.tsx` reusable component
   - Reduces MetricsTable from ~435 LOC

**Acceptance Criteria**:
- [ ] React.memo wraps 4 heavy child components
- [ ] WinLossTrendChart loads via lazy/Suspense
- [ ] All 3 query hooks have identical staleTime/refetchInterval (30s/30s)
- [ ] PitTable extracted as standalone component
- [ ] `npm run type-check` passes

### WS3: Error Boundary Hierarchy

**Purpose**: Implement ADR-032 three-tier error boundary for shift dashboard route.

**Findings Addressed**: P1-2

**Deliverables**:

1. **Create route error.tsx** (`app/(protected)/shift-dashboard/error.tsx`)
   - Tier 1: Next.js error boundary for route-level crashes
   - Display full-page error with retry action
   - Log error to error reporting

2. **Wrap panels with PanelErrorBoundary** (`shift-dashboard-v3.tsx`)
   - Wrap each rail/panel with `<PanelErrorBoundary panelName="...">` from `components/error-boundary/`
   - PanelErrorBoundary already integrates QueryErrorResetBoundary (Tier 3)
   - A single panel crash won't take down the full dashboard

**Acceptance Criteria**:
- [ ] `error.tsx` exists at route level with retry action
- [ ] Each dashboard panel wrapped in PanelErrorBoundary
- [ ] Panel failure shows error fallback, rest of dashboard remains functional
- [ ] `npm run type-check` passes

### WS4: RSC Data Prefetching

**Purpose**: Eliminate client-side loading waterfall by prefetching dashboard data server-side.

**Findings Addressed**: P2-4

**Deliverables**:

1. **Server-side prefetch in page.tsx**
   - Create server-side QueryClient with `defaultOptions: { queries: { staleTime: 30_000 } }`
   - Call `queryClient.prefetchQuery()` for all 3 dashboard queries
   - Use `dehydrate(queryClient)` → `<HydrationBoundary state={dehydratedState}>`
   - Wrap `<ShiftDashboardV3 />` in HydrationBoundary

2. **Query key alignment**
   - Ensure server prefetch uses identical query keys as client hooks
   - Import key factories from `hooks/shift-dashboard/` or `services/*/keys.ts`
   - Keys must include casino_id/time_window parameters for cache match

**Acceptance Criteria**:
- [ ] Server component calls prefetchQuery for 3 dashboard queries
- [ ] HydrationBoundary wraps client component
- [ ] Query keys match between server and client
- [ ] No loading skeleton flash on cold mount (data hydrated from server)
- [ ] `npm run type-check` passes

### WS5: Security & Auth Hardening

**Purpose**: Restore auth pipeline, protect review routes, sanitize error responses, fix type safety.

**Findings Addressed**: ~~P1-5~~, P1-6, P2-5, P2-6, P3-15

**P1-5 Status**: **ALREADY RESOLVED**. The project has already migrated from `middleware.ts` to
`proxy.ts` per the Next.js 16 convention. `proxy.ts` exists at the project root with `export async
function proxy()` calling `updateSession()`. The `middleware.ts.bak` file is a historical artifact
of the pre-Next.js-16 convention and should be deleted as cleanup.

**Deliverables**:

1. **Delete middleware.ts.bak** (P1-5 cleanup)
   - Remove the deprecated `middleware.ts.bak` artifact
   - Auth pipeline is active via `proxy.ts` (Next.js 16 convention)

2. **Add auth to review route** (P1-6)
   - Add auth enforcement to `app/review/shift-dashboard-v3/page.tsx`
   - Option A: Create `app/review/layout.tsx` with auth check
   - Option B: Add inline `redirect()` if no session
   - Note: `proxy.ts` handles session refresh, but review route needs explicit auth guard

3. **Clear query cache on logout** (P2-5)
   - Add `queryClient.clear()` before redirect in logout handler
   - Prevents cross-tenant data exposure in shared-terminal casino environment

4. **Sanitize database errors** (P2-6)
   - Replace `throw new Error(\`Database error: ${error.message}\`)` with generic client message
   - Log detailed error server-side via `logError()`
   - Return `ServiceHttpResult` with generic `INTERNAL_ERROR` code

5. **Remove `as any` type bypass** (P3-15)
   - Fix RPC call typing at `visitors-summary/route.ts:39`
   - Use proper generic type for Supabase RPC call

**Acceptance Criteria**:
- [ ] `middleware.ts.bak` deleted (historical artifact)
- [ ] `proxy.ts` confirmed functional (Next.js 16 convention, already in place)
- [ ] Review route requires authentication
- [ ] Logout clears TanStack Query cache
- [ ] No raw database errors in API responses
- [ ] Zero `as any` casts in visitors-summary route
- [ ] `npm run type-check` passes

### WS6: Accessibility Remediation

**Purpose**: Achieve WCAG 2.1 AA compliance for shift dashboard.

**Findings Addressed**: P0-2, P0-3, P1-9, P1-10, P1-11, P2-15, P2-16, P2-17, P2-18, P2-19, P3-10, P3-11, P3-12

**Deliverables**:

1. **aria-live regions** (P0-2)
   - Add `aria-live="polite"` to metric value containers in orchestrator
   - Announce metric updates to screen readers without interrupting workflow

2. **Focus-visible indicators** (P0-3)
   - Add `focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2` to all interactive elements
   - Series toggle buttons in WinLossTrendChart, alert items in AlertsStrip, tab triggers in MetricsTable

3. **CoverageBar progressbar semantics** (P1-9)
   - Add `role="progressbar"`, `aria-valuenow`, `aria-valuemin="0"`, `aria-valuemax="100"`
   - Add `aria-label` with descriptive text

4. **TelemetryQualityIndicator labels** (P1-10)
   - Add `aria-label` when `showLabel=false` (default)
   - Color-only information violates WCAG 1.4.1

5. **Mobile responsive rail collapse** (P1-11)
   - Add responsive breakpoints for left/right rails
   - Collapse to accordion or tab pattern on small viewports

6. **Table accessibility** (P2-15 to P2-19)
   - Add `<caption>` to all data tables
   - Add `scope="col"` to header cells
   - Ensure proper table semantics

7. **Chart focus management** (P3-10 to P3-12)
   - Add keyboard navigation for chart data points where feasible
   - Add chart summary text for screen readers

**Acceptance Criteria**:
- [ ] `aria-live="polite"` on all dynamic metric containers
- [ ] All interactive elements have visible focus indicators
- [ ] CoverageBar has progressbar ARIA semantics
- [ ] TelemetryQualityIndicator has label regardless of showLabel prop
- [ ] Tables have captions and scoped headers
- [ ] `npm run type-check` passes

### WS7: Component Test Coverage

**Purpose**: Add unit test coverage for critical shift dashboard components.

**Findings Addressed**: P1-7, P1-8, P2-9, P2-13

**Deliverables**:

1. **ShiftDashboardV3 orchestrator tests** (P1-7)
   - Render with mocked query hooks
   - Verify loading states (skeletons shown)
   - Verify error states (PanelErrorBoundary fallback shown)
   - Verify data rendering (metrics passed to children)

2. **MetricsTable tests** (P1-8)
   - Tab switching between casino/pit views
   - Table rendering with mock data
   - Sort functionality
   - Empty state rendering

3. **AlertsStrip tests** (P2-9)
   - Alert rendering with severity colors
   - Sort by severity
   - Filter by type
   - Empty state

4. **TelemetryRailPanel tests** (P2-13)
   - Accordion expansion
   - Pit data display
   - Sort functionality

**Acceptance Criteria**:
- [ ] 4 test files created in `components/shift-dashboard-v3/__tests__/`
- [ ] Tests cover render, loading, error, and data states
- [ ] All tests pass with `npm test`
- [ ] No snapshot tests (prefer behavioral assertions)

### WS8: E2E Test Improvements

**Purpose**: Retarget E2E tests to production route with auth and add data-driven assertions.

**Findings Addressed**: P2-11, P2-12

**Deliverables**:

1. **Retarget to auth-protected route** (P2-11)
   - Change test target from `/review/shift-dashboard-v3` to `/(protected)/shift-dashboard`
   - Add authenticated test fixture (pre-authenticate via Supabase service client)
   - Validate casino-scoped data isolation

2. **Add data-driven assertions** (P2-12)
   - Assert metric values render (not just element presence)
   - Assert alert content displays with correct severity
   - Assert chart data loads (canvas/SVG elements with data)
   - Test error boundary display on API failure
   - Test skeleton → content transition

**Acceptance Criteria**:
- [ ] E2E tests target auth-protected route
- [ ] Tests authenticate before navigation
- [ ] At least 3 data-driven assertions (metrics, alerts, charts)
- [ ] Error state E2E test with mocked API failure
- [ ] All E2E tests pass locally

## Definition of Done

- [ ] All 8 workstreams complete
- [ ] All gates pass (type-check, test-pass, build)
- [ ] Zero P0 findings remaining
- [ ] Zero P1 findings remaining
- [ ] All P2+ findings addressed or explicitly deferred with justification
- [ ] P2-10 logged as separate issue (product decision required)
