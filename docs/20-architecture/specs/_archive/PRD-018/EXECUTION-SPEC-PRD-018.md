---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline skill

prd: PRD-018
prd_title: "Rating Slip Modal BFF RPC Implementation"
service: RatingSlipModalService
mvp_phase: 3  # Phase 3 (Performance Hardening)

# Workstream Definitions
workstreams:
  WS1:
    name: Database Migration - BFF RPC Function
    description: Create PostgreSQL RPC function rpc_get_rating_slip_modal_data with SECURITY INVOKER, casino validation, and complete modal DTO aggregation
    executor: rls-expert
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/YYYYMMDDHHMMSS_prd018_modal_bff_rpc.sql
    gate: schema-validation
    estimated_complexity: high

  WS2:
    name: Service Layer Integration
    description: Add getModalDataViaRPC() function to rating-slip-modal service with feature flag support
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - services/rating-slip-modal/rpc.ts
      - services/rating-slip-modal/index.ts
    gate: type-check
    estimated_complexity: medium

  WS3:
    name: Route Handler Integration
    description: Add feature flag toggle and conditional routing between BFF RPC and legacy multi-query paths
    executor: api-builder
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - app/api/v1/rating-slips/[id]/modal-data/route.ts
    gate: lint
    estimated_complexity: medium

  WS4:
    name: Testing & Validation
    description: RLS security tests, performance benchmarks, DTO contract validation, and cross-casino isolation tests
    executor: typescript-pro
    executor_type: task-agent
    depends_on: [WS2, WS3]
    outputs:
      - services/rating-slip-modal/__tests__/rpc.test.ts
      - services/rating-slip-modal/__tests__/rpc-security.test.ts
      - services/rating-slip-modal/__tests__/rpc-contract.test.ts
    gate: test-pass
    estimated_complexity: high

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Database Layer
    parallel: [WS1]
    gates: [schema-validation]

  - name: Phase 2 - Service Layer
    parallel: [WS2]
    gates: [type-check]

  - name: Phase 3 - Route Handler
    parallel: [WS3]
    gates: [lint]

  - name: Phase 4 - Testing
    parallel: [WS4]
    gates: [test-pass]

# Validation Gates
gates:
  schema-validation:
    command: npm run db:types
    success_criteria: "Exit code 0, RPC function created in database.types.ts"

  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0"

  lint:
    command: npm run lint -- services/rating-slip-modal/ app/api/v1/rating-slips/
    success_criteria: "Exit code 0, no errors (warnings OK)"

  test-pass:
    command: npm test services/rating-slip-modal/
    success_criteria: "All tests pass"

# Dependencies on other PRDs/Services
external_dependencies:
  - prd: PRD-008
    service: RatingSlipModalService
    required_for: "Existing modal-data endpoint and DTOs"
  - prd: PERF-001
    service: RatingSlipService
    required_for: "WS1-WS3 optimizations (batch queries, parallelization)"

# Risks and Mitigations
risks:
  - risk: "Query plan regression in complex JSONB aggregation"
    mitigation: "Run EXPLAIN ANALYZE in staging before production rollout"
  - risk: "Schema drift requires RPC updates"
    mitigation: "Include RPC in migration review checklist"
  - risk: "RLS policy gaps on joined tables"
    mitigation: "SECURITY INVOKER inherits all policies; security tests validate cross-casino isolation"

---

# EXECUTION-SPEC: PRD-018 - Rating Slip Modal BFF RPC Implementation

## Overview

This PRD implements the `rpc_get_rating_slip_modal_data` PostgreSQL function to reduce the rating slip modal endpoint latency from ~600ms to ~150ms. The BFF (Backend-for-Frontend) RPC consolidates 6+ database queries into a single round trip, completing the Phase 3 optimization from PERF-001.

**Key Metrics:**
- Current p95: ~600ms (after WS1-WS3 optimizations)
- Target p95: <200ms (150ms target)
- Improvement: -75%

## Scope

**In Scope:**
- PostgreSQL RPC function with SECURITY INVOKER pattern
- Service layer wrapper with feature flag support
- Route handler conditional routing (RPC vs legacy)
- RLS security tests for cross-casino isolation
- Performance benchmark tests

**Out of Scope:**
- Frontend changes (modal UI unchanged)
- Removing legacy multi-query implementation (kept as fallback)
- Redis caching layer
- Other endpoint optimizations

## Architecture Context

**ADR References:**
- ADR-015: RLS Connection Pooling Strategy (Pattern C hybrid)
- ADR-018: SECURITY DEFINER Function Governance (using INVOKER instead)
- ADR-020: RLS Track A Hybrid Strategy

**Design Document:**
- `docs/20-architecture/specs/PERF-001/BFF-RPC-DESIGN.md`

**Key Design Decisions:**
1. **SECURITY INVOKER** - Inherits caller's RLS context automatically
2. **Defense-in-depth** - Explicit casino_id parameter validation
3. **Feature flag** - `NEXT_PUBLIC_USE_MODAL_BFF_RPC` for staged rollout
4. **Parallel paths** - Both implementations available during rollout

## Workstream Details

### WS1: Database Migration - BFF RPC Function

**Purpose**: Create the PostgreSQL RPC function that aggregates modal data in a single transaction.

**Deliverables**:
1. Migration file with RPC function implementation
2. SECURITY INVOKER with casino scope validation
3. Complete modal DTO structure as JSONB return

**Key Implementation Points**:
- Inline duration calculation (replaces `rpc_get_rating_slip_duration` call)
- Inline loyalty suggestion calculation
- 7 table JOINs: rating_slip, rating_slip_pause, visit, player, player_loyalty, player_financial_transaction, gaming_table
- Active tables with occupied seats batch query

**Acceptance Criteria**:
- [ ] `npm run db:types` succeeds
- [ ] RPC appears in `database.types.ts`
- [ ] GRANT EXECUTE to authenticated role
- [ ] Casino mismatch throws explicit error

### WS2: Service Layer Integration

**Purpose**: Add service wrapper for RPC call with type-safe interface.

**Deliverables**:
1. `getModalDataViaRPC()` function in `services/rating-slip-modal/rpc.ts`
2. Export from service index
3. Type mapping from JSONB to `RatingSlipModalDTO`

**Key Implementation Points**:
- Call `supabase.rpc('rpc_get_rating_slip_modal_data', params)`
- Type assertion from JSONB to DTO
- Error mapping to domain errors

**Acceptance Criteria**:
- [ ] Function exported from service
- [ ] TypeScript types match existing DTO contract
- [ ] Errors mapped to domain error codes

### WS3: Route Handler Integration

**Purpose**: Add feature flag toggle for conditional path selection.

**Deliverables**:
1. Feature flag check: `NEXT_PUBLIC_USE_MODAL_BFF_RPC`
2. Conditional routing to RPC or legacy path
3. X-Query-Timings header for both paths

**Key Implementation Points**:
- Check `process.env.NEXT_PUBLIC_USE_MODAL_BFF_RPC === 'true'`
- RPC path: single call to `getModalDataViaRPC()`
- Legacy path: existing multi-query implementation (preserved)
- Timing instrumentation for comparison

**Acceptance Criteria**:
- [ ] Feature flag controls path selection
- [ ] Both paths produce identical response structure
- [ ] X-Query-Timings header available

### WS4: Testing & Validation

**Purpose**: Comprehensive testing for security, performance, and contract compliance.

**Deliverables**:
1. RPC unit tests
2. RLS security tests (cross-casino isolation)
3. DTO contract tests (identical structure validation)
4. Performance benchmark tests

**Key Tests**:
- `rpc.test.ts` - Basic RPC functionality
- `rpc-security.test.ts` - Cross-casino isolation, casino mismatch errors
- `rpc-contract.test.ts` - DTO shape matches legacy implementation

**Acceptance Criteria**:
- [ ] All tests pass
- [ ] Cross-casino query returns error (not empty data)
- [ ] RPC and legacy paths produce identical field sets
- [ ] p95 benchmark < 200ms (if performance tests available)

## Definition of Done

**Functionality**
- [ ] RPC function returns identical DTO to current implementation
- [ ] Feature flag toggles between implementations without restart
- [ ] Both paths produce identical responses for same input

**Data & Integrity**
- [ ] No data inconsistencies between RPC and multi-query paths
- [ ] JSONB aggregation handles NULL values correctly
- [ ] Duration calculation matches existing RPC output

**Security & Access**
- [ ] SECURITY INVOKER enforces RLS on all 7 joined tables
- [ ] Casino mismatch throws explicit error (not silent filter)
- [ ] Cross-casino test confirms zero data leakage

**Testing**
- [ ] Service layer tests pass
- [ ] RLS security tests pass
- [ ] Contract tests validate DTO schema

**Operational Readiness**
- [ ] X-Query-Timings header available in development
- [ ] Feature flag documented

**Documentation**
- [ ] Migration file includes comprehensive comments
- [ ] PERF-001 checkpoint can be marked complete after validation
