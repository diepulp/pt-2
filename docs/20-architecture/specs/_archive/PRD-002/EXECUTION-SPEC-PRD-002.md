---
# EXECUTION-SPEC Frontmatter
# Generated by lead-architect skill
# Date: 2025-12-07

prd: PRD-002
prd_title: "Rating Slip Service"
service: RatingSlipService
mvp_phase: 2
pattern: B  # Pattern B with mappers.ts (Pattern C per SRM - Hybrid)

# Schema Status (from types/database.types.ts)
schema_status:
  rating_slip: EXISTS
  rating_slip_pause: EXISTS
  rating_slip_status: EXISTS  # enum: open, paused, closed, archived
  rpc_start_rating_slip: EXISTS
  rpc_pause_rating_slip: EXISTS
  rpc_resume_rating_slip: EXISTS
  rpc_close_rating_slip: EXISTS
  rpc_get_rating_slip_duration: EXISTS

# Workstream Definitions
workstreams:
  WS1:
    name: Schema Validation & Type Hardening
    description: Validate existing schema, drop deprecated player_id column, verify RPCs return correct types
    agent: pt2-service-implementer
    depends_on: []
    outputs:
      - supabase/migrations/YYYYMMDDHHMMSS_rating_slip_drop_player_id.sql
      - types/database.types.ts (regenerated)
    gate: schema-validation
    estimated_complexity: low
    context: |
      The rating_slip table and pause tracking already exist via migrations:
      - 20251128221408_rating_slip_pause_tracking.sql
      - 20251205000004_rating_slip_not_null_constraints.sql

      CRITICAL: rating_slip.player_id is deprecated (comment in types). Player identity
      MUST be derived from visit.player_id per SRM v4.0.0 invariant. This workstream:
      1. Creates migration to DROP player_id column (or NULL it with deprecation marker)
      2. Updates rpc_start_rating_slip to NOT accept p_player_id
      3. Regenerates types via npm run db:types

      RPCs already exist and handle state transitions with FOR UPDATE locking.

  WS2:
    name: DTOs & Schemas
    description: Create dtos.ts with Pick/Omit types, schemas.ts with Zod validation
    agent: pt2-service-implementer
    depends_on: [WS1]
    outputs:
      - services/rating-slip/dtos.ts
      - services/rating-slip/schemas.ts
    gate: type-check
    estimated_complexity: low
    context: |
      Pattern B (Canonical) with hybrid elements per SRM:

      DTOs (dtos.ts):
      - RatingSlipDTO: Pick from Row (id, casino_id, visit_id, table_id, seat_number,
        start_time, end_time, status, average_bet, game_settings, policy_snapshot)
      - RatingSlipWithDurationDTO: RatingSlipDTO & { duration_seconds: number }
      - RatingSlipWithPausesDTO: RatingSlipDTO & { pauses: RatingSlipPauseDTO[] }
      - RatingSlipPauseDTO: Pick from rating_slip_pause Row
      - CreateRatingSlipInput: { visit_id, table_id, seat_number?, game_settings? }
      - CloseRatingSlipInput: { average_bet?: number }

      NOTE: NO player_id in DTOs - derived from visit.player_id at query time

      Schemas (schemas.ts) per ADR-013:
      - createRatingSlipSchema: Validates visit_id, table_id, seat_number, game_settings
      - closeRatingSlipSchema: Validates optional average_bet
      - ratingSlipListQuerySchema: table_id, visit_id, status filters

  WS3:
    name: Selects & Mappers
    description: Create selects.ts with column projections, mappers.ts with Row to DTO transformers
    agent: pt2-service-implementer
    depends_on: [WS2]
    outputs:
      - services/rating-slip/selects.ts
      - services/rating-slip/mappers.ts
    gate: type-check
    estimated_complexity: medium
    context: |
      Selects (selects.ts):
      - RATING_SLIP_SELECT: Core columns for list/detail
      - RATING_SLIP_WITH_PAUSES_SELECT: Joins rating_slip_pause
      - RATING_SLIP_PAUSE_SELECT: Pause record columns

      Mappers (mappers.ts) - REQUIRED per SLAD §308-348:
      - toRatingSlipDTO(row): Transform row to DTO
      - toRatingSlipWithDurationDTO(row, duration): Add duration calculation
      - toRatingSlipWithPausesDTO(row, pauses): Include pause history
      - toRatingSlipPauseDTO(row): Pause record transform

      Zero 'as' type assertions - all transformations explicit via mappers.

  WS4:
    name: CRUD Operations
    description: Implement crud.ts with RPC-backed state machine operations
    agent: pt2-service-implementer
    depends_on: [WS3]
    outputs:
      - services/rating-slip/crud.ts
    gate: type-check
    estimated_complexity: high
    context: |
      CRUD operations using existing RPCs:

      - start(input: CreateRatingSlipInput): Calls rpc_start_rating_slip
        Returns RatingSlipDTO, throws RATING_SLIP_DUPLICATE on conflict

      - pause(slipId: string): Calls rpc_pause_rating_slip
        Returns RatingSlipDTO, throws RATING_SLIP_NOT_OPEN if not open

      - resume(slipId: string): Calls rpc_resume_rating_slip
        Returns RatingSlipDTO, throws RATING_SLIP_NOT_PAUSED if not paused

      - close(slipId: string, input?: CloseRatingSlipInput): Calls rpc_close_rating_slip
        Returns RatingSlipWithDurationDTO, throws RATING_SLIP_INVALID_STATE

      - getById(slipId: string): Query with pause join
        Returns RatingSlipWithPausesDTO, throws RATING_SLIP_NOT_FOUND

      - listForTable(tableId: string, filters?): Query by table_id
        Returns RatingSlipDTO[]

      - listForVisit(visitId: string): Query by visit_id
        Returns RatingSlipDTO[]

      - getActiveForTable(tableId: string): Query status IN ('open', 'paused')
        Returns RatingSlipDTO[]

      - getDuration(slipId: string): Calls rpc_get_rating_slip_duration
        Returns number (seconds)

      Error handling via DomainError (ADR-012).
      RLS context via current_setting('app.casino_id').

  WS5:
    name: Published Queries
    description: Create queries.ts with cross-context query for TableContextService
    agent: pt2-service-implementer
    depends_on: [WS4]
    outputs:
      - services/rating-slip/queries.ts
    gate: type-check
    estimated_complexity: low
    context: |
      Published queries for bounded context consumption (SLAD rules):

      - hasOpenSlipsForTable(supabase, tableId, casinoId): Promise<boolean>
        Used by TableContextService to gate table deactivation.
        Returns true if any rating_slip with status IN ('open', 'paused')
        exists for the given table.

      This is the ONLY allowlisted cross-context query per SRM v4.0.0.

  WS6:
    name: Service Factory & Keys
    description: Create index.ts with service factory, keys.ts with React Query key factories
    agent: pt2-service-implementer
    depends_on: [WS4, WS5]
    outputs:
      - services/rating-slip/index.ts
      - services/rating-slip/keys.ts
    gate: type-check
    estimated_complexity: medium
    context: |
      Service Factory (index.ts) per ADR-008:

      ```typescript
      export interface RatingSlipService {
        start(input: CreateRatingSlipInput): Promise<ServiceResult<RatingSlipDTO>>;
        pause(slipId: string): Promise<ServiceResult<RatingSlipDTO>>;
        resume(slipId: string): Promise<ServiceResult<RatingSlipDTO>>;
        close(slipId: string, input?: CloseRatingSlipInput): Promise<ServiceResult<RatingSlipWithDurationDTO>>;
        getById(slipId: string): Promise<ServiceResult<RatingSlipWithPausesDTO>>;
        listForTable(tableId: string, filters?: RatingSlipListFilters): Promise<ServiceResult<RatingSlipDTO[]>>;
        listForVisit(visitId: string): Promise<ServiceResult<RatingSlipDTO[]>>;
        getActiveForTable(tableId: string): Promise<ServiceResult<RatingSlipDTO[]>>;
        getDuration(slipId: string): Promise<ServiceResult<number>>;
      }

      export function createRatingSlipService(supabase: SupabaseClient<Database>): RatingSlipService;
      ```

      Keys Factory (keys.ts):
      - ratingSlipKeys.root: ['rating-slip']
      - ratingSlipKeys.list: (filters) => [...root, 'list', serialize(filters)]
      - ratingSlipKeys.list.scope: [...root, 'list']
      - ratingSlipKeys.detail: (id) => [...root, 'detail', id]
      - ratingSlipKeys.forTable: (tableId) => [...root, 'for-table', tableId]
      - ratingSlipKeys.forVisit: (visitId) => [...root, 'for-visit', visitId]
      - ratingSlipKeys.activeForTable: (tableId) => [...root, 'active', tableId]
      - ratingSlipKeys.duration: (id) => [...root, 'duration', id]

  WS7:
    name: HTTP Fetchers
    description: Create http.ts with client-side fetch wrappers for route handlers
    agent: pt2-service-implementer
    depends_on: [WS6]
    outputs:
      - services/rating-slip/http.ts
    gate: type-check
    estimated_complexity: low
    context: |
      HTTP fetchers (http.ts):

      - startRatingSlip(input): POST /api/v1/rating-slips
      - pauseRatingSlip(slipId): POST /api/v1/rating-slips/{id}/pause
      - resumeRatingSlip(slipId): POST /api/v1/rating-slips/{id}/resume
      - closeRatingSlip(slipId, input?): POST /api/v1/rating-slips/{id}/close
      - getRatingSlip(slipId): GET /api/v1/rating-slips/{id}
      - listRatingSlips(filters): GET /api/v1/rating-slips?table_id=X&status=Y
      - getRatingSlipDuration(slipId): GET /api/v1/rating-slips/{id}/duration

      All return typed DTOs, use fetchJSON helper from lib/http/fetch-json.ts.

  WS8:
    name: Route Handlers
    description: Create API routes with withServerAction middleware
    agent: api-expert
    depends_on: [WS6, WS7]
    outputs:
      - app/api/v1/rating-slips/route.ts
      - app/api/v1/rating-slips/[id]/route.ts
      - app/api/v1/rating-slips/[id]/pause/route.ts
      - app/api/v1/rating-slips/[id]/resume/route.ts
      - app/api/v1/rating-slips/[id]/close/route.ts
      - app/api/v1/rating-slips/[id]/duration/route.ts
    gate: lint
    estimated_complexity: medium
    context: |
      All routes use withServerAction middleware per EDGE_TRANSPORT_POLICY.md.

      Routes:

      POST /api/v1/rating-slips
        Body: { visit_id, table_id, seat_number?, game_settings? }
        Returns: RatingSlipDTO
        Errors: 409 RATING_SLIP_DUPLICATE, 400 VISIT_NOT_OPEN, 400 TABLE_NOT_ACTIVE

      GET /api/v1/rating-slips
        Query: table_id?, visit_id?, status? (open|paused|closed)
        Returns: RatingSlipDTO[]

      GET /api/v1/rating-slips/{id}
        Returns: RatingSlipWithPausesDTO
        Errors: 404 RATING_SLIP_NOT_FOUND

      POST /api/v1/rating-slips/{id}/pause
        Returns: RatingSlipDTO (status=paused)
        Errors: 409 RATING_SLIP_NOT_OPEN

      POST /api/v1/rating-slips/{id}/resume
        Returns: RatingSlipDTO (status=open)
        Errors: 409 RATING_SLIP_NOT_PAUSED

      POST /api/v1/rating-slips/{id}/close
        Body: { average_bet?: number }
        Returns: RatingSlipWithDurationDTO
        Errors: 409 RATING_SLIP_INVALID_STATE

      GET /api/v1/rating-slips/{id}/duration
        Returns: { duration_seconds: number }
        Errors: 404 RATING_SLIP_NOT_FOUND

      Response format: ServiceHttpResult<T> per API_SURFACE_MVP.md

  WS9:
    name: React Query Hooks
    description: Create hooks for client-side state management
    agent: pt2-service-implementer
    depends_on: [WS7, WS8]
    outputs:
      - hooks/rating-slip/index.ts
      - hooks/rating-slip/use-rating-slip.ts
      - hooks/rating-slip/use-rating-slip-mutations.ts
      - hooks/rating-slip/use-rating-slip-list.ts
    gate: type-check
    estimated_complexity: medium
    context: |
      Query Hooks (use-rating-slip.ts):
      - useRatingSlip(id): Query for single slip with pauses
      - useRatingSlipList(filters): Query for list with filters
      - useRatingSlipsForTable(tableId): Scoped list for table
      - useActiveSlipsForTable(tableId): Open/paused only
      - useRatingSlipDuration(id): Duration calculation

      Mutation Hooks (use-rating-slip-mutations.ts):
      - useStartRatingSlip(): Create new slip
      - usePauseRatingSlip(): Pause slip
      - useResumeRatingSlip(): Resume slip
      - useCloseRatingSlip(): Close slip with duration

      All mutations use surgical cache updates:
      - setQueryData for detail after mutation
      - invalidateQueries for list.scope
      - invalidateQueries for activeForTable

      Export barrel (index.ts) with all hooks.

  WS10:
    name: Unit Tests
    description: Create unit tests for service layer per ADR-002
    agent: pt2-service-implementer
    depends_on: [WS4, WS5, WS6]
    outputs:
      - services/rating-slip/__tests__/rating-slip.service.test.ts
      - services/rating-slip/__tests__/mappers.test.ts
      - services/rating-slip/__tests__/queries.test.ts
    gate: test-pass
    estimated_complexity: medium
    context: |
      Tests in __tests__/ subdirectory per ADR-002 v3.0.0.

      Service Tests (rating-slip.service.test.ts):
      - State machine transitions:
        - open → paused (pause)
        - paused → open (resume)
        - open → closed (close)
        - paused → closed (close with auto-end pause)
        - closed → any (invalid, throws)
      - Duration calculation excludes paused time
      - Error handling for invalid states
      - Unique constraint on open slip per player per table

      Mapper Tests (mappers.test.ts):
      - Row → DTO transformations
      - Null handling
      - Pause array mapping

      Query Tests (queries.test.ts):
      - hasOpenSlipsForTable returns true/false correctly

  WS11:
    name: Integration Tests
    description: Create integration tests with real Supabase
    agent: pt2-service-implementer
    depends_on: [WS8, WS9, WS10]
    outputs:
      - services/rating-slip/__tests__/rating-slip.integration.test.ts
    gate: test-pass
    estimated_complexity: high
    context: |
      Integration tests with real Supabase instance.

      Full Lifecycle Test:
      1. Create visit (setup)
      2. Start rating slip
      3. Pause rating slip
      4. Resume rating slip
      5. Pause again
      6. Close with average_bet
      7. Verify duration excludes paused time

      Concurrency Test:
      - Attempt concurrent pause operations
      - Verify FOR UPDATE locking prevents race conditions

      Unique Constraint Test:
      - Start slip for player at table
      - Attempt second slip for same player at same table
      - Verify 409 RATING_SLIP_DUPLICATE

      RLS Test:
      - Verify slip only visible to same casino

  WS12:
    name: Service README
    description: Create service documentation
    agent: pt2-service-implementer
    depends_on: [WS4, WS5, WS6, WS8]
    outputs:
      - services/rating-slip/README.md
    gate: none
    estimated_complexity: low
    context: |
      Service documentation including:
      - Purpose and bounded context
      - Supported operations
      - State machine diagram
      - Duration calculation formula
      - Error codes and meanings
      - Published queries (hasOpenSlipsForTable)
      - Usage examples
      - Cross-context consumers (LoyaltyService, TableContextService)

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Schema Foundation
    description: Validate schema, drop deprecated column, regenerate types
    parallel: [WS1]
    gates: [schema-validation]
    agent_count: 1

  - name: Phase 2 - Type Definitions
    description: DTOs, schemas, selects, mappers (can parallelize after WS1)
    parallel: [WS2, WS3]
    gates: [type-check]
    agent_count: 2

  - name: Phase 3 - Service Core
    description: CRUD, queries, service factory, keys (sequential within, parallel where possible)
    parallel: [WS4, WS5]
    gates: [type-check]
    agent_count: 2

  - name: Phase 4 - Service Assembly
    description: Complete service factory with keys
    parallel: [WS6]
    gates: [type-check]
    agent_count: 1

  - name: Phase 5 - Transport Layer
    description: HTTP fetchers and route handlers (can parallelize)
    parallel: [WS7, WS8]
    gates: [type-check, lint]
    agent_count: 2

  - name: Phase 6 - Client Integration
    description: React Query hooks
    parallel: [WS9]
    gates: [type-check]
    agent_count: 1

  - name: Phase 7 - Testing & Documentation
    description: All tests and documentation (can parallelize)
    parallel: [WS10, WS11, WS12]
    gates: [test-pass]
    agent_count: 3

# Validation Gates
gates:
  schema-validation:
    command: npm run db:types && npm run type-check -- types/database.types.ts
    success_criteria: "Exit code 0, rating_slip table has no player_id column"

  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0, no TypeScript errors"

  lint:
    command: npm run lint -- services/rating-slip/ app/api/v1/rating-slips/
    success_criteria: "Exit code 0, no ESLint errors (warnings OK)"

  test-pass:
    command: npm test -- services/rating-slip/
    success_criteria: "All tests pass, 90%+ coverage for service layer"

# Dependencies on other PRDs/Services
external_dependencies:
  - prd: PRD-000
    service: CasinoService
    required_for: "RLS context (casino_id), audit logging"
    status: COMPLETE

  - prd: PRD-003
    service: VisitService
    required_for: "Visit anchor (visit_id FK), player identity derivation"
    status: COMPLETE

  - prd: PRD-007
    service: TableContextService
    required_for: "Table validation (graceful degradation if not implemented)"
    status: PENDING

# Cross-Context Consumers
consumers:
  - service: LoyaltyService
    prd: PRD-004
    consumes: "RatingSlipDTO, telemetry for mid-session rewards"
    filter: "visit.visit_kind = 'gaming_identified_rated'"

  - service: TableContextService
    prd: PRD-007
    consumes: "hasOpenSlipsForTable published query"
    purpose: "Gate table deactivation if open slips exist"

  - service: PlayerFinancialService
    prd: PRD-001
    consumes: "rating_slip_id FK (optional)"
    purpose: "Associate financial transactions with rating sessions"

  - service: MTLService
    prd: PRD-005
    consumes: "rating_slip_id FK (optional)"
    purpose: "Compliance tracking for gaming activity"

# Risks and Mitigations
risks:
  - risk: "Deprecated player_id column may break existing queries"
    mitigation: "Column drop is Phase 1; all code uses visit.player_id derivation"

  - risk: "RPC modifications may require database restart"
    mitigation: "RPCs are VOLATILE, no restart needed; test on local first"

  - risk: "TableContextService not yet implemented for validation"
    mitigation: "Graceful degradation; log warning if TableContext unavailable"

  - risk: "Concurrent pause/resume may cause state inconsistency"
    mitigation: "Existing RPCs use FOR UPDATE row locking"

# Parallel Execution Summary
parallel_execution:
  max_concurrent_agents: 3
  optimal_agent_count: 3
  recommended_split:
    agent_1: [WS1, WS4, WS6, WS9]  # Schema -> CRUD -> Factory -> Hooks (main path)
    agent_2: [WS2, WS5, WS8, WS10] # DTOs -> Queries -> Routes -> Unit Tests
    agent_3: [WS3, WS7, WS11, WS12] # Mappers -> HTTP -> Integration -> Docs
  serialization_points:
    - after: [WS1]
      reason: "Types must be regenerated before DTO creation"
    - after: [WS4, WS5]
      reason: "Service factory depends on CRUD and queries"
    - after: [WS8]
      reason: "Hooks depend on routes existing"

---

# EXECUTION-SPEC: PRD-002 - Rating Slip Service

## Overview

RatingSlipService manages gameplay telemetry for rated sessions at gaming tables. This service enables pit staff to start, pause, resume, and close rating slips that track player activity (average bet, duration, seat position). This is a **clean rebuild** following Pattern B architecture after the previous implementation was removed (2025-12-02) due to architectural non-compliance.

**Key Differentiator**: Player identity is derived from `visit.player_id`, NOT stored on rating_slip directly. The deprecated `player_id` column will be dropped in this implementation.

## Scope

**In Scope**:
- Start rating slip (tied to visit + table + seat)
- Pause/resume rating slip with interval tracking
- Close rating slip with duration calculation
- Query slips by ID, table, visit, status
- Published query for TableContextService (`hasOpenSlipsForTable`)
- React Query hooks for client integration
- Route handlers with middleware stack

**Out of Scope**:
- Reward/points calculation (LoyaltyService scope)
- Financial transaction recording (PlayerFinancialService scope)
- Table open/close operations (TableContextService scope per PRD-007)
- Real-time subscriptions (PRD-006 Pit Dashboard scope)
- Historical slip analytics/reporting (Post-MVP)

## Architecture Context

### Schema Status

The database schema already exists:
- `rating_slip` table with status enum, visit_id/table_id NOT NULL
- `rating_slip_pause` table for pause interval tracking
- 5 RPCs for lifecycle operations with FOR UPDATE locking
- `player_id` column exists but is DEPRECATED (will be dropped)

### Pattern B Architecture (with mappers.ts)

```
services/rating-slip/
├── __tests__/                    # Per ADR-002
│   ├── rating-slip.service.test.ts
│   ├── mappers.test.ts
│   └── rating-slip.integration.test.ts
├── dtos.ts                       # Pick/Omit from Database types
├── schemas.ts                    # Zod validation (ADR-013)
├── selects.ts                    # Named column projections
├── mappers.ts                    # Row→DTO transformers (REQUIRED)
├── crud.ts                       # RPC-backed database operations
├── queries.ts                    # Published queries for cross-context
├── index.ts                      # Service factory
├── keys.ts                       # React Query key factories
├── http.ts                       # HTTP fetchers
└── README.md
```

### State Machine

```
       ┌─────────┐
       │ (start) │
       └────┬────┘
            │
            ▼
       ┌─────────┐  pause   ┌─────────┐
       │  open   │─────────▶│ paused  │
       │         │◀─────────│         │
       └────┬────┘  resume  └────┬────┘
            │                    │
            │ close              │ close
            │                    │
            ▼                    ▼
       ┌───────────────────────────┐
       │         closed            │
       └───────────────────────────┘
```

### Duration Calculation

```
duration_seconds = (end_time - start_time) - SUM(pause_intervals)
```

Server-authoritative via `rpc_get_rating_slip_duration` and `rpc_close_rating_slip`.

## Workstream Details

### WS1: Schema Validation & Type Hardening

**Purpose**: Prepare database schema for Pattern B implementation.

**Deliverables**:
1. Migration to drop deprecated `player_id` column
2. Update `rpc_start_rating_slip` to remove `p_player_id` parameter
3. Regenerated `types/database.types.ts`

**Acceptance Criteria**:
- [ ] `npm run db:types` succeeds
- [ ] `rating_slip.player_id` no longer exists in types
- [ ] `rpc_start_rating_slip` signature updated
- [ ] Existing RPCs still function correctly

### WS2: DTOs & Schemas

**Purpose**: Define type contracts for service layer.

**Deliverables**:
1. `dtos.ts` with Pick/Omit types (NO player_id)
2. `schemas.ts` with Zod validation for HTTP requests

**Acceptance Criteria**:
- [ ] DTOs follow Pattern B (Pick/Omit from Database types)
- [ ] No manual interface declarations
- [ ] Schemas handle optional fields correctly
- [ ] Type exports use `Input`/`Query` suffix per ADR-013

### WS3: Selects & Mappers

**Purpose**: Type-safe database query projections and transformations.

**Deliverables**:
1. `selects.ts` with named column projections
2. `mappers.ts` with Row→DTO transformers

**Acceptance Criteria**:
- [ ] Zero `as` type assertions
- [ ] All transformations explicit via mapper functions
- [ ] Pause array properly mapped
- [ ] Duration included where needed

### WS4: CRUD Operations

**Purpose**: Implement database operations using existing RPCs.

**Deliverables**:
1. `crud.ts` with all lifecycle operations

**Acceptance Criteria**:
- [ ] Uses existing RPCs for state transitions
- [ ] DomainError thrown for invalid states
- [ ] RLS context properly injected
- [ ] Mappers used for all Row→DTO conversions

### WS5: Published Queries

**Purpose**: Cross-context query for TableContextService.

**Deliverables**:
1. `queries.ts` with `hasOpenSlipsForTable`

**Acceptance Criteria**:
- [ ] Function signature matches SRM specification
- [ ] Returns boolean (not slip data - boundary compliance)
- [ ] Properly scoped by casino_id

### WS6: Service Factory & Keys

**Purpose**: Main service interface and React Query integration.

**Deliverables**:
1. `index.ts` with explicit interface and factory
2. `keys.ts` with query key factories

**Acceptance Criteria**:
- [ ] Explicit interface exported (NOT ReturnType)
- [ ] Functional factory pattern
- [ ] Keys include `.scope` for list invalidation
- [ ] All methods return `ServiceResult<T>`

### WS7: HTTP Fetchers

**Purpose**: Client-side fetch wrappers for route handlers.

**Deliverables**:
1. `http.ts` with typed fetch functions

**Acceptance Criteria**:
- [ ] Uses `fetchJSON` helper
- [ ] Proper error handling
- [ ] Types match DTOs

### WS8: Route Handlers

**Purpose**: Create API routes with middleware stack.

**Deliverables**:
1. CRUD routes using `withServerAction` middleware
2. Action routes (pause/resume/close)
3. Duration query route

**Acceptance Criteria**:
- [ ] All routes use `withServerAction` wrapper
- [ ] Zod validation for request bodies/params
- [ ] Response format matches `ServiceHttpResult<T>`
- [ ] Error codes match PRD specification

### WS9: React Query Hooks

**Purpose**: Client-side state management.

**Deliverables**:
1. Query hooks for read operations
2. Mutation hooks for write operations
3. Export barrel

**Acceptance Criteria**:
- [ ] Hooks use key factories
- [ ] Surgical cache updates on mutation
- [ ] Proper error handling

### WS10: Unit Tests

**Purpose**: Service layer correctness.

**Deliverables**:
1. Service tests for state machine
2. Mapper tests
3. Query tests

**Acceptance Criteria**:
- [ ] Tests in `__tests__/` subdirectory
- [ ] 90%+ coverage for service layer
- [ ] All state transitions tested
- [ ] Error cases covered

### WS11: Integration Tests

**Purpose**: End-to-end validation with real database.

**Deliverables**:
1. Full lifecycle integration test
2. Concurrency test
3. RLS test

**Acceptance Criteria**:
- [ ] Full lifecycle works correctly
- [ ] Duration excludes paused time
- [ ] Concurrent operations handled safely
- [ ] RLS properly enforced

### WS12: Service README

**Purpose**: Developer documentation.

**Deliverables**:
1. `README.md` with service documentation

**Acceptance Criteria**:
- [ ] All operations documented
- [ ] Error codes explained
- [ ] State machine diagram included
- [ ] Usage examples provided

## Definition of Done

- [ ] All 12 workstreams complete
- [ ] All validation gates pass
- [ ] MVP-ROADMAP.md updated with PRD-002 status
- [ ] MVPProgressContext records completion
- [ ] `player_id` column dropped from schema
- [ ] Zero `as` type assertions in codebase
- [ ] Published query available for TableContextService

## Agent Assignment Matrix

| Workstream | Agent Type | Complexity |
|------------|------------|------------|
| WS1 | pt2-service-implementer | Low |
| WS2 | pt2-service-implementer | Low |
| WS3 | pt2-service-implementer | Medium |
| WS4 | pt2-service-implementer | High |
| WS5 | pt2-service-implementer | Low |
| WS6 | pt2-service-implementer | Medium |
| WS7 | pt2-service-implementer | Low |
| WS8 | api-expert | Medium |
| WS9 | pt2-service-implementer | Medium |
| WS10 | pt2-service-implementer | Medium |
| WS11 | pt2-service-implementer | High |
| WS12 | pt2-service-implementer | Low |

## Parallel Execution Strategy

**Optimal Configuration**: 3 concurrent agents

```
Timeline (sequential phases):

Phase 1: [WS1] ─────────────────────────────────────────────────────▶
         Schema validation (1 agent)

Phase 2: [WS2] ────▶ [WS3] ────▶ (parallel after WS1)
         DTOs        Mappers
         (2 agents can split)

Phase 3: [WS4] ────▶ [WS5] ────▶ (parallel, both depend on WS3)
         CRUD        Queries

Phase 4: [WS6] ────▶ (depends on WS4, WS5)
         Factory

Phase 5: [WS7] ────▶ [WS8] ────▶ (parallel after WS6)
         HTTP        Routes

Phase 6: [WS9] ────▶ (depends on WS7, WS8)
         Hooks

Phase 7: [WS10] ──▶ [WS11] ──▶ [WS12] ──▶ (all parallel)
         Unit       Integration  Docs
```

**Critical Path**: WS1 → WS2 → WS3 → WS4 → WS6 → WS8 → WS9

## References

- **PRD**: `docs/10-prd/PRD-002-rating-slip-service.md`
- **SRM**: `docs/20-architecture/SERVICE_RESPONSIBILITY_MATRIX.md` §RatingSlipService
- **SLAD**: `docs/20-architecture/SERVICE_LAYER_ARCHITECTURE_DIAGRAM.md` §308-350
- **ADR-002**: Test location standard (`__tests__/` subdirectory)
- **ADR-012**: Error handling layers (DomainError)
- **ADR-013**: Zod validation schemas
- **ADR-014**: Ghost gaming visits (visit_kind filtering)
- **MVP-ROADMAP**: `docs/20-architecture/MVP-ROADMAP.md` (Phase 2)
