---
# EXECUTION-SPEC Frontmatter
# Generated by lead-architect skill
# PRD-017: Start From Previous Session (Visit Continuation)

prd: PRD-017
prd_title: "Start From Previous Session (Visit Continuation)"
service: VisitService
mvp_phase: 2  # Session phase

# Workstream Definitions
workstreams:
  WS1:
    name: Database Migration - visit_group_id Schema
    description: |
      Add visit_group_id column to visit table:
      - visit_group_id UUID NOT NULL (nullable initially for backfill)
      - Trigger trg_visit_set_group_id for default (= id if NULL)
      - Backfill existing visits (visit_group_id = id)
      - Partial unique index idx_visit_one_open_per_player
      - Index for group queries and recent sessions pagination
    agent: backend-service-builder
    depends_on: []
    outputs:
      - supabase/migrations/20251222015000_prd017_visit_continuation.sql
    gate: schema-validation
    estimated_complexity: medium

  WS2:
    name: Published Contract - TableContext Availability RPC
    description: |
      Create rpc_check_table_seat_availability(p_table_id, p_seat_number).
      Returns jsonb with:
      - available: boolean
      - reason?: 'table_inactive' | 'table_closed' | 'seat_occupied'
      - table_name?: string
      SECURITY INVOKER, respects RLS.
      Add to TableContextService published contracts.
    agent: rls-expert
    depends_on: [WS1]
    outputs:
      - supabase/migrations/20251222015001_prd017_rpc_table_availability.sql
      - services/table-context/index.ts
    gate: schema-validation
    estimated_complexity: low

  WS3:
    name: Published Contract - Loyalty Summary RPC
    description: |
      Create rpc_get_visit_loyalty_summary(p_visit_id).
      Returns jsonb with:
      - points_earned: number (>= 0)
      SECURITY INVOKER, respects RLS.
      Add to LoyaltyService published contracts.
    agent: rls-expert
    depends_on: [WS1]
    outputs:
      - supabase/migrations/20251222015002_prd017_rpc_loyalty_summary.sql
      - services/loyalty/index.ts
    gate: schema-validation
    estimated_complexity: low

  WS4:
    name: Published Contract - Last Segment RPC
    description: |
      Create rpc_get_visit_last_segment(p_visit_id).
      Returns jsonb with last segment context:
      - table_id, table_name, seat_number
      - game_settings (if stored)
      - average_bet (if observed)
      SECURITY INVOKER, respects RLS.
      Add to RatingSlipService published contracts.
    agent: rls-expert
    depends_on: [WS1]
    outputs:
      - supabase/migrations/20251222015003_prd017_rpc_last_segment.sql
      - services/rating-slip/index.ts
    gate: schema-validation
    estimated_complexity: low

  WS5:
    name: Read RPC - Player Recent Sessions
    description: |
      Create rpc_get_player_recent_sessions(p_casino_id, p_player_id, p_limit, p_cursor).
      Returns paginated closed sessions with:
      - sessions array (visit_id, ended_at, last_table/seat, totals)
      - next_cursor (base64 encoded)
      - open_visit (separate from list if exists)
      Composes from VisitService owned tables + published contracts.
      SECURITY INVOKER, respects RLS.
    agent: rls-expert
    depends_on: [WS2, WS3, WS4]
    outputs:
      - supabase/migrations/20251222015004_prd017_rpc_recent_sessions.sql
    gate: schema-validation
    estimated_complexity: high

  WS6:
    name: Read RPC - Last Session Context
    description: |
      Create rpc_get_player_last_session_context(p_casino_id, p_player_id).
      Returns last closed session context:
      - visit_id, visit_group_id, last_table_id/name, last_seat_number
      - last_game_settings (nullable)
      - last_average_bet (nullable)
      SECURITY INVOKER, respects RLS.
    agent: rls-expert
    depends_on: [WS2, WS3, WS4]
    outputs:
      - supabase/migrations/20251222015005_prd017_rpc_last_session_context.sql
    gate: schema-validation
    estimated_complexity: medium

  WS7:
    name: Service Layer - VisitService Extension
    description: |
      Add to VisitService:
      - getPlayerRecentSessions(casinoId, playerId, options) method
      - getPlayerLastSessionContext(casinoId, playerId) method
      - startFromPrevious(request) method
      Update DTOs with visit_group_id and continuation types.
      Add Zod schemas for input validation.
    agent: backend-service-builder
    depends_on: [WS5, WS6]
    outputs:
      - services/visit/crud.ts
      - services/visit/dtos.ts
      - services/visit/schemas.ts
      - services/visit/index.ts
    gate: type-check
    estimated_complexity: high

  WS8:
    name: Route Handler - Start From Previous
    description: |
      Create POST /api/v1/visits/start-from-previous endpoint.
      Request validation:
      - player_id, source_visit_id, destination_table_id, destination_seat_number
      - game_settings_override (optional)
      Server validation sequence per PRD-017 5.4:
      - Role check, source validation, destination validation
      Response: 201 with visit_id, visit_group_id, active_slip_id.
      Error codes: 400, 403, 404, 409, 422 per spec.
      Idempotency-Key header support per ADR-021.
    agent: api-expert
    depends_on: [WS7]
    outputs:
      - app/api/v1/visits/start-from-previous/route.ts
    gate: lint
    estimated_complexity: high

  WS9:
    name: Route Handler - Recent Sessions & Last Context
    description: |
      Create GET routes for recent sessions query:
      - GET /api/v1/players/[playerId]/recent-sessions (or visits scoped)
      Uses withServerAction middleware.
      Validates query params with Zod.
    agent: api-expert
    depends_on: [WS7]
    outputs:
      - app/api/v1/players/[playerId]/recent-sessions/route.ts
    gate: lint
    estimated_complexity: medium

  WS10:
    name: Unit & Integration Tests
    description: |
      Test coverage for:
      - Trigger sets visit_group_id = id when NULL on INSERT
      - Partial unique index rejects second open visit for same player
      - rpc_get_player_recent_sessions pagination with tie-breaking
      - rpc_get_player_recent_sessions excludes open visits from sessions list
      - Start from previous creates visit with correct visit_group_id
      - 409 returned when player has open visit (DB constraint)
      - 400 returned when source.player_id != request.player_id
      - 422 returned when destination table not available
      - RLS prevents cross-casino access
      - Policy v1 -> v2 change -> continuation uses v2 snapshot
    agent: e2e-testing
    depends_on: [WS7, WS8, WS9]
    outputs:
      - services/visit/__tests__/visit-continuation.test.ts
      - services/visit/__tests__/visit-continuation.integration.test.ts
    gate: test-pass
    estimated_complexity: high

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Database Foundation
    parallel: [WS1]
    gates: [schema-validation]

  - name: Phase 2 - Published Contracts
    parallel: [WS2, WS3, WS4]
    gates: [schema-validation]

  - name: Phase 3 - Read RPCs
    parallel: [WS5, WS6]
    gates: [schema-validation]

  - name: Phase 4 - Service Layer
    parallel: [WS7]
    gates: [type-check]

  - name: Phase 5 - Route Handlers
    parallel: [WS8, WS9]
    gates: [lint]

  - name: Phase 6 - Tests
    parallel: [WS10]
    gates: [test-pass]

# Validation Gates
gates:
  schema-validation:
    command: npm run db:types
    success_criteria: "Exit code 0, types regenerated without error"

  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0, no TypeScript errors"

  lint:
    command: npm run lint
    success_criteria: "Exit code 0, no errors"

  test-pass:
    command: npm test -- --testPathPattern="visit-continuation"
    success_criteria: "All tests pass"

# Dependencies on other PRDs/Services
external_dependencies:
  - prd: PRD-016
    service: RatingSlipService
    required_for: "rpc_get_visit_live_view pattern, segment context"
  - prd: PRD-003
    service: VisitService
    required_for: "Existing visit CRUD operations"
  - prd: PRD-009
    service: PlayerFinancialService
    required_for: "visit_financial_summary view (published contract)"
  - prd: ADR-015
    service: RLS
    required_for: "SECURITY INVOKER pattern for RPCs"
  - prd: ADR-021
    service: HTTP
    required_for: "Idempotency-Key header standard"

# Risks and Mitigations
risks:
  - risk: "Two staff click 'Start from previous' simultaneously for same player"
    mitigation: "Partial unique index idx_visit_one_open_per_player enforces at DB level; returns 409"
  - risk: "Table/seat no longer available at destination"
    mitigation: "Validate via TableContext published query rpc_check_table_seat_availability; return 422"
  - risk: "Large visit history slows query"
    mitigation: "Limit to last 7 days + cursor pagination with tie-breaking on (ended_at, visit_id)"
  - risk: "Policy snapshot copied from source (incorrect)"
    mitigation: "Application code uses CURRENT policy snapshot; acceptance test validates"
  - risk: "Cross-context reads violate SRM"
    mitigation: "Explicit published contracts documented; no direct table access; SRM v4.5.0 update"

---

# EXECUTION-SPEC: PRD-017 - Start From Previous Session

## Overview

Enable operators to quickly start a new visit seeded from a recently closed session's context (last table/seat, game settings, average bet). Introduces `visit_group_id` for cross-visit continuity tracking, read models for recent sessions listing, and a write endpoint for continuation.

**Key Value**: Eliminates "start over from scratch" friction when a player returns shortly after leaving. Operator sees recent sessions, picks one, and the new visit is pre-seeded with context.

## Scope

### In Scope
- Add `visit_group_id` column with DB-level trigger default
- Partial unique index enforcing max 1 open visit per identified player per casino
- `rpc_get_player_recent_sessions` for paginated closed sessions with aggregates
- `rpc_get_player_last_session_context` for prefilling continuation form
- `POST /api/v1/visits/start-from-previous` endpoint with validation sequence
- Published contracts: TableContext availability, Loyalty summary, RatingSlip last segment
- Audit log for continuation actions
- Idempotency-Key header support

### Out of Scope
- Re-opening closed visits (immutability preserved)
- Mutating historical rating slips
- Copying financial ledger rows (aggregated via published contracts)
- Automatic continuation (always explicit operator selection)
- UI implementation (separate PRD-018)
- Cross-casino session tracking

## Architecture Context

**Session Identity**: `visit_id` is the canonical operator session key. The new `visit_group_id` links continuation visits for aggregation and audit.

**Semantics**:
- First visit of a group: `visit_group_id = id` (trigger auto-sets if NULL)
- Continuation visit: Application sets `visit_group_id = source.visit_group_id`

**Cross-Context Composition**: VisitService RPCs compose from:
- Owned: `visit` table, `visit_group_id`
- Published: `visit_financial_summary` view (Finance), `rpc_get_visit_loyalty_summary` (Loyalty), `rpc_get_visit_last_segment` (RatingSlip), `rpc_check_table_seat_availability` (TableContext)

**References**:
- SRM v4.4.0: VisitService ownership, cross-context rules
- ADR-015: RLS context injection (SECURITY INVOKER pattern)
- ADR-021: Idempotency-Key header standardization
- PRD-016: Visit Live View RPC pattern (prerequisite)

## Workstream Details

### WS1: Database Migration - visit_group_id Schema

**Purpose**: Add continuity column and DB-level invariant enforcement.

**Schema Changes**:
```sql
-- 1. Add visit_group_id column (nullable initially for backfill)
ALTER TABLE visit ADD COLUMN visit_group_id UUID;

-- 2. Backfill existing visits (each becomes its own group)
UPDATE visit SET visit_group_id = id WHERE visit_group_id IS NULL;

-- 3. Make NOT NULL after backfill
ALTER TABLE visit ALTER COLUMN visit_group_id SET NOT NULL;

-- 4. Trigger to default visit_group_id = id on INSERT
CREATE OR REPLACE FUNCTION trg_visit_set_group_id() ...

-- 5. Partial unique index: max 1 open visit per identified player per casino
CREATE UNIQUE INDEX idx_visit_one_open_per_player
  ON visit (casino_id, player_id)
  WHERE ended_at IS NULL AND player_id IS NOT NULL;

-- 6. Index for group queries
CREATE INDEX idx_visit_group ON visit (casino_id, visit_group_id, started_at DESC);

-- 7. Index for recent sessions pagination
CREATE INDEX idx_visit_player_recent_closed
  ON visit (casino_id, player_id, ended_at DESC, id DESC)
  WHERE player_id IS NOT NULL AND ended_at IS NOT NULL;
```

**Acceptance Criteria**:
- [ ] Migration applies without error
- [ ] `npm run db:types` regenerates with visit_group_id
- [ ] Trigger tested: INSERT without visit_group_id results in self-reference
- [ ] Partial unique index rejects duplicate open visits

### WS2: Published Contract - TableContext Availability RPC

**Purpose**: Enable VisitService to validate destination table/seat.

**Contract**:
```typescript
interface TableAvailabilityResult {
  available: boolean;
  reason?: 'table_inactive' | 'table_closed' | 'seat_occupied';
  table_name?: string;
}
```

**Acceptance Criteria**:
- [ ] RPC uses SECURITY INVOKER
- [ ] Returns correct availability status
- [ ] SRM updated with published contract

### WS3: Published Contract - Loyalty Summary RPC

**Purpose**: Provide visit-scoped loyalty points for session aggregates.

**Contract**:
```typescript
interface LoyaltySummaryResult {
  points_earned: number; // >= 0
}
```

**Acceptance Criteria**:
- [ ] RPC uses SECURITY INVOKER
- [ ] Returns 0 if no accrual records
- [ ] SRM updated with published contract

### WS4: Published Contract - Last Segment RPC

**Purpose**: Provide last segment context for session aggregates.

**Contract**:
```typescript
interface LastSegmentResult {
  table_id: string;
  table_name: string;
  seat_number: number;
  game_settings: Record<string, unknown> | null;
  average_bet: number | null;
}
```

**Acceptance Criteria**:
- [ ] RPC uses SECURITY INVOKER
- [ ] Returns null if visit has no segments
- [ ] SRM updated with published contract

### WS5: Read RPC - Player Recent Sessions

**Purpose**: Paginated list of closed sessions with aggregates.

**Contract** (from PRD-017 5.2.1):
```typescript
interface RecentSessionsResponse {
  sessions: Array<{
    visit_id: string;
    visit_group_id: string;
    started_at: string;
    ended_at: string;
    last_table_id: string;
    last_table_name: string;
    last_seat_number: number;
    total_duration_seconds: number;
    total_buy_in: number;
    total_cash_out: number;
    net: number;
    points_earned: number;
    segment_count: number;
  }>;
  next_cursor: string | null;
  open_visit: {...} | null;  // Separate from sessions list
}
```

**Cursor Encoding**: `base64(ended_at_iso || '|' || visit_id)`

**Acceptance Criteria**:
- [ ] RPC uses SECURITY INVOKER
- [ ] Returns closed sessions only in sessions array
- [ ] Open visit (if any) in separate field
- [ ] Pagination with tie-breaking works correctly
- [ ] Cross-casino query returns empty

### WS6: Read RPC - Last Session Context

**Purpose**: Prefill data for "Start from previous" form.

**Contract** (from PRD-017 5.2.2):
```typescript
interface LastSessionContextResponse {
  visit_id: string;
  visit_group_id: string;
  last_table_id: string;
  last_table_name: string;
  last_seat_number: number;
  last_game_settings: Record<string, unknown> | null;
  last_average_bet: number | null;
  ended_at: string;
} | null  // null if no closed sessions
```

**Acceptance Criteria**:
- [ ] RPC uses SECURITY INVOKER
- [ ] Returns null if player has no closed sessions
- [ ] Respects RLS

### WS7: Service Layer - VisitService Extension

**Purpose**: Add continuation methods to VisitService.

**New Methods**:
```typescript
// Read methods
getPlayerRecentSessions(casinoId, playerId, options?)
getPlayerLastSessionContext(casinoId, playerId)

// Write method
startFromPrevious(request: StartFromPreviousRequest): Promise<StartFromPreviousResponse>
```

**Validation Sequence** (in startFromPrevious):
1. Actor permission: pit_boss or admin
2. Source visit exists
3. Source visit closed
4. Source visit player match
5. Source visit casino match
6. No open visit (DB will enforce)
7. Destination table valid (via published RPC)

**Acceptance Criteria**:
- [ ] All methods follow functional factory pattern
- [ ] DTOs updated with visit_group_id
- [ ] Zod schemas for all inputs
- [ ] No direct reads from non-owned tables

### WS8: Route Handler - Start From Previous

**Purpose**: Write endpoint for visit continuation.

**Route**: `POST /api/v1/visits/start-from-previous`

**Request**:
```typescript
interface StartFromPreviousRequest {
  player_id: string;
  source_visit_id: string;
  destination_table_id: string;
  destination_seat_number: number;
  game_settings_override?: Record<string, unknown>;
}
```

**Response (201)**:
```typescript
interface StartFromPreviousResponse {
  visit_id: string;
  visit_group_id: string;
  active_slip_id: string;
  started_at: string;
}
```

**Error Codes**:
| Code | Error | Description |
|------|-------|-------------|
| 400 | SOURCE_VISIT_NOT_CLOSED | Source visit is still open |
| 400 | PLAYER_MISMATCH | Source visit belongs to different player |
| 403 | FORBIDDEN | Source visit belongs to different casino |
| 404 | SOURCE_VISIT_NOT_FOUND | Source visit_id doesn't exist |
| 409 | VISIT_ALREADY_OPEN | Player has open visit; includes open_visit_id |
| 422 | TABLE_NOT_AVAILABLE | Destination table not active |
| 422 | SEAT_OCCUPIED | Destination seat occupied |

**Acceptance Criteria**:
- [ ] Uses withServerAction middleware
- [ ] Validates with Zod schemas
- [ ] Returns correct error codes
- [ ] Supports Idempotency-Key header
- [ ] Audit log written

### WS9: Route Handler - Recent Sessions

**Purpose**: REST API for recent sessions query.

**Route**: `GET /api/v1/players/[playerId]/recent-sessions`

**Query Params**:
- `limit`: int (default 5, max 20)
- `cursor`: string (opaque cursor for pagination)

**Acceptance Criteria**:
- [ ] Uses withServerAction middleware
- [ ] Validates query params with Zod
- [ ] Returns RecentSessionsResponse

### WS10: Unit & Integration Tests

**Purpose**: Verify correctness, security, and edge cases.

**Test Coverage**:

1. **Trigger Tests**:
   - INSERT without visit_group_id → self-reference
   - INSERT with visit_group_id → preserves value

2. **Constraint Tests**:
   - Second open visit for same player → rejected
   - Open visit for different player → allowed
   - Ghost visits (player_id NULL) → coexist

3. **RPC Tests**:
   - Pagination with cursor encoding/decoding
   - Tie-breaking on (ended_at, visit_id)
   - Open visits excluded from sessions array
   - Cross-casino query blocked

4. **Write Endpoint Tests**:
   - Happy path: creates visit with correct visit_group_id
   - 409: player has open visit
   - 400: source not closed
   - 400: player_id mismatch
   - 403: cross-casino source
   - 422: table not available

5. **Policy Snapshot Test**:
   - Policy v1 → v2 change → continuation uses v2

**Acceptance Criteria**:
- [ ] All unit tests pass
- [ ] Integration tests cover happy path + error cases
- [ ] RLS negative tests included
- [ ] Policy snapshot acceptance test passes

## Definition of Done

From PRD-017 Section 8:

**Functionality**
- [ ] `visit_group_id` column added with trigger-based default
- [ ] Trigger tested: INSERT without visit_group_id results in self-reference
- [ ] `rpc_get_player_recent_sessions` returns paginated closed sessions with totals
- [ ] `rpc_get_player_last_session_context` returns last table/seat/settings
- [ ] `POST /api/v1/visits/start-from-previous` creates visit + first segment
- [ ] Continuation populates `visit_group_id` from source visit

**Data & Integrity**
- [ ] Partial unique index `idx_visit_one_open_per_player` created and enforced
- [ ] DB rejects duplicate open visit INSERT (constraint violation → 409)
- [ ] `visit_group_id` is NOT NULL on all visits (constraint enforced)
- [ ] Source visit validation: closed + player_id match + casino match
- [ ] Destination segment created with CURRENT policy snapshot

**Cross-Context Contracts**
- [ ] TableContextService publishes `rpc_check_table_seat_availability`
- [ ] LoyaltyService publishes `rpc_get_visit_loyalty_summary`
- [ ] RatingSlipService publishes `rpc_get_visit_last_segment`
- [ ] VisitService RPCs use only published contracts

**Security & Access**
- [ ] All RPCs use SECURITY INVOKER
- [ ] RLS enforced: cannot query/continue visits from other casinos
- [ ] Negative test: cross-casino continuation returns 403
- [ ] Role check: pit_boss or admin required for write endpoint

**Testing**
- [ ] Unit test: Trigger sets visit_group_id = id when NULL on INSERT
- [ ] Unit test: Partial unique index rejects second open visit
- [ ] Integration test: Start from previous with correct visit_group_id
- [ ] Integration test: 409 when player has open visit
- [ ] Acceptance test: Policy v1 → v2 change → continuation uses v2 snapshot
