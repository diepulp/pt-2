---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline orchestrator

prd: PRD-MTL-UI-GAPS
prd_title: "MTL UI Implementation Gap Closure"
service: MtlService
mvp_phase: 2  # Session Management
source_document: docs/00-vision/mtl-service-evolution/MTL_UI_IMPLEMENTATION_GAP_ANALYSIS.md

# Workstream Definitions
workstreams:
  WS1:
    name: Finance→MTL Derivation Trigger
    description: Database trigger to auto-derive mtl_entry from eligible player_financial_transaction records
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/YYYYMMDDHHMMSS_finance_to_mtl_derivation.sql
    gate: schema-validation
    estimated_complexity: medium

  WS2:
    name: useThresholdNotifications Hook
    description: Pure logic hook for threshold checking (warning, watchlist, CTR) with toast notifications
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - hooks/mtl/use-threshold-notifications.ts
    gate: type-check
    estimated_complexity: medium

  WS3:
    name: usePatronDailyTotal Hook
    description: React Query hook to fetch patron's current gaming day cash-in total for threshold calculation
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - hooks/mtl/use-patron-daily-total.ts
      - services/mtl/keys.ts
    gate: type-check
    estimated_complexity: low

  WS4:
    name: BuyInThresholdIndicator Component
    description: Visual indicator showing current daily total, new buy-in, and projected total with threshold status
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS2, WS3]
    outputs:
      - components/rating-slip/buy-in-threshold-indicator.tsx
    gate: type-check
    estimated_complexity: medium

  WS5:
    name: CtrBanner Component
    description: Persistent banner displayed when CTR threshold (>$10,000) is exceeded, with FinCEN reference
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - components/mtl/ctr-banner.tsx
    gate: type-check
    estimated_complexity: low

  WS6:
    name: MtlEntryForm Component
    description: Manual MTL entry form replicating official Affinity Gaming MTL paper form with patron identification section, transaction grid, running totals, and transaction type codes (1-12)
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - components/mtl/mtl-entry-form.tsx
      - components/mtl/mtl-txn-type-codes.ts
    gate: type-check
    estimated_complexity: high

  WS7:
    name: Rating Slip Modal Integration
    description: Enhance useSaveWithBuyIn with threshold notifications, integrate BuyInThresholdIndicator and CtrBanner into rating slip modal
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS2, WS3, WS4, WS5]
    outputs:
      - hooks/rating-slip-modal/use-save-with-buyin.ts (update)
      - components/modals/rating-slip/rating-slip-modal.tsx (update)
    gate: type-check
    estimated_complexity: high

  WS8:
    name: Compliance Dashboard Integration
    description: Add "New Entry" button to ComplianceDashboard header with MtlEntryForm modal
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS6]
    outputs:
      - components/mtl/compliance-dashboard.tsx (update)
    gate: type-check
    estimated_complexity: low

  WS9:
    name: Unit Tests
    description: Unit tests for all new hooks and components
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS2, WS3, WS4, WS5, WS6]
    outputs:
      - __tests__/hooks/mtl/use-threshold-notifications.test.ts
      - __tests__/hooks/mtl/use-patron-daily-total.test.ts
      - __tests__/components/rating-slip/buy-in-threshold-indicator.test.tsx
      - __tests__/components/mtl/ctr-banner.test.tsx
      - __tests__/components/mtl/mtl-entry-form.test.tsx
      - __tests__/components/mtl/mtl-txn-type-codes.test.ts
    gate: test-pass
    estimated_complexity: medium

  WS10:
    name: E2E Tests
    description: End-to-end tests for threshold notification workflow and CTR banner display
    executor: e2e-testing
    executor_type: skill
    depends_on: [WS7, WS8]
    outputs:
      - e2e/mtl-threshold-notifications.spec.ts
    gate: test-pass
    estimated_complexity: medium

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Foundation
    parallel: [WS1, WS2]
    gates: [schema-validation, type-check]

  - name: Phase 2 - Core Hooks & Components
    parallel: [WS3, WS5, WS6]
    gates: [type-check]

  - name: Phase 3 - Dependent Components
    parallel: [WS4, WS8]
    gates: [type-check]

  - name: Phase 4 - Integration
    parallel: [WS7]
    gates: [type-check]

  - name: Phase 5 - Testing
    parallel: [WS9, WS10]
    gates: [test-pass, build]

# Validation Gates
gates:
  schema-validation:
    command: npm run db:types
    success_criteria: "Exit code 0, no type errors"

  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0"

  lint:
    command: npm run lint
    success_criteria: "Exit code 0, no errors"

  test-pass:
    command: npm test
    success_criteria: "All tests pass"

  build:
    command: npm run build
    success_criteria: "Exit code 0"

# External Dependencies
external_dependencies:
  - prd: PRD-005
    service: MtlService
    required_for: "Existing MTL infrastructure (service, hooks, mutations)"
  - prd: PRD-008a
    service: RatingSlipModalService
    required_for: "Rating slip modal and buy-in workflow"

# Risks and Mitigations
risks:
  - risk: "Finance→MTL trigger may create duplicate entries"
    mitigation: "Use idempotency_key with 'fin:{txn_id}' format and ON CONFLICT DO NOTHING"

  - risk: "Threshold notifications may fire multiple times"
    mitigation: "Track notification state in component, debounce toast calls"

  - risk: "CTR banner may be dismissed prematurely"
    mitigation: "Store dismissal in session storage with gaming_day scope"

---

# EXECUTION-SPEC: PRD-MTL-UI-GAPS - MTL UI Implementation Gap Closure

## Overview

This execution spec addresses the 6 implementation gaps identified in the MTL UI Implementation Gap Analysis. The MTL service layer is complete, but the UI lacks critical functionality for manual entry, automated derivation, and real-time threshold notifications.

**Gaps Addressed:**
1. No Manual MTL Entry Form → WS6
2. No Automated Derivation from Financial Transactions → WS1
3. No Rating Slip → MTL Integration → WS7
4. No Real-Time Threshold Notifications → WS2, WS4, WS7
5. No CTR Banner Notification → WS5, WS7
6. Cumulative Daily Total Not Surfaced → WS3, WS4

## Scope

**In Scope:**
- Database trigger for auto-derivation of MTL entries from financial transactions
- Threshold notification hooks and UI components
- Manual MTL entry form with validation
- CTR banner component with regulatory reference
- Rating slip modal integration for threshold awareness
- Compliance dashboard "New Entry" button

**Out of Scope:**
- Full CTR workflow (form generation, FinCEN submission) - DEFERRED
- Cage transaction integration (only pit transactions)
- Real-time WebSocket notifications (polling is sufficient for MVP)

## Architecture Context

**Bounded Context Ownership:**
- `MtlService` owns `mtl_entry`, `mtl_audit_note`, `mtl_gaming_day_summary`
- `PlayerFinancialService` owns `player_financial_transaction`
- `RatingSlipModalService` owns the buy-in workflow

**Cross-Context Integration:**
- Finance→MTL bridge uses AFTER INSERT trigger (database-level)
- Threshold notifications consume `mtl_gaming_day_summary` view (read-only)

**Relevant ADRs:**
- ADR-025: MTL Authorization Model
- ADR-015: RLS Patterns (for trigger security context)

## Workstream Details

### WS1: Finance→MTL Derivation Trigger

**Purpose:** Automatically create `mtl_entry` records when eligible financial transactions are recorded.

**Eligibility Filter:**
```sql
channel = 'pit' AND is_currency = true AND txn_type IN ('chip_purchase', 'chip_redemption')
```

**Direction Mapping:**
- `chip_purchase` → `direction: 'in'`, `txn_type: 'buy_in'`
- `chip_redemption` → `direction: 'out'`, `txn_type: 'cash_out'`

**Deliverables:**
1. Migration with trigger function `fn_derive_mtl_from_finance`
2. AFTER INSERT trigger on `player_financial_transaction`
3. Idempotency key format: `fin:{txn_id}`

**Acceptance Criteria:**
- [ ] `npm run db:types` succeeds
- [ ] Eligible transactions auto-create MTL entries
- [ ] Non-eligible transactions do not create entries
- [ ] Duplicate transactions handled via ON CONFLICT DO NOTHING

### WS2: useThresholdNotifications Hook

**Purpose:** Provide threshold evaluation and toast notification logic.

**Threshold Tiers:**
| Level | Condition | Toast Type | Auto-Create MTL |
|-------|-----------|------------|-----------------|
| `none` | < $2,500 | None | No |
| `warning` | ≥ $2,500, < $3,000 | Warning | No |
| `watchlist_met` | ≥ $3,000, ≤ $9,000 | Info | Yes |
| `ctr_near` | > $9,000, ≤ $10,000 | Warning | Yes |
| `ctr_met` | > $10,000 | Error (persistent) | Yes |

**Interface:**
```typescript
interface ThresholdCheckResult {
  level: ThresholdLevel;
  shouldCreateMtl: boolean;
  requiresCtr: boolean;
  message: string | null;
}

function checkThreshold(amount: number, dailyTotal?: number): ThresholdCheckResult;
function notifyThreshold(result: ThresholdCheckResult): void;
```

**Acceptance Criteria:**
- [ ] Evaluates against DEFAULT_THRESHOLDS from mappers.ts
- [ ] CTR uses strictly > (not >=) per 31 CFR § 1021.311
- [ ] Considers cumulative daily total in threshold calculation
- [ ] Toast durations appropriate for severity (10s for CTR)

### WS3: usePatronDailyTotal Hook

**Purpose:** Fetch patron's current gaming day cash-in aggregate.

**Deliverables:**
1. Add `patronDailyTotal` key to `mtlKeys` in `services/mtl/keys.ts`
2. Create `hooks/mtl/use-patron-daily-total.ts`

**Hook Interface:**
```typescript
function usePatronDailyTotal(
  casinoId: string | undefined,
  patronUuid: string | undefined,
  gamingDay?: string
): UseQueryResult<{
  totalIn: number;
  totalOut: number;
  entryCount: number;
}>;
```

**Acceptance Criteria:**
- [ ] Uses existing `use-gaming-day-summary` pattern
- [ ] Handles undefined inputs gracefully (disabled query)
- [ ] 30-second stale time for compliance freshness

### WS4: BuyInThresholdIndicator Component

**Purpose:** Visual feedback showing projected daily total during buy-in entry.

**Props:**
```typescript
interface BuyInThresholdIndicatorProps {
  currentDailyTotal: number;
  newBuyInAmount: number;
  className?: string;
}
```

**Visual States:**
- Default: Muted text, no highlight
- Warning (≥$2,500): Yellow background, "Approaching" label
- Watchlist (≥$3,000): Amber background, "Watchlist" label
- CTR Near (>$9,000): Orange background, "CTR Near" label
- CTR Met (>$10,000): Red background, "CTR REQUIRED" label

**Acceptance Criteria:**
- [ ] Renders nothing when newBuyInAmount ≤ 0
- [ ] Shows current total, new amount, and projected total
- [ ] Color-coded by threshold level
- [ ] Compact design suitable for modal integration

### WS5: CtrBanner Component

**Purpose:** Persistent warning when CTR threshold is exceeded.

**Content:**
- Daily total amount (formatted)
- Patron name (if available)
- Regulatory reference (31 CFR § 1021.311)
- Link to FinCEN filing information
- Dismiss button (with callback)

**Acceptance Criteria:**
- [ ] Uses Alert component with destructive variant
- [ ] External link has proper rel="noopener noreferrer"
- [ ] Dismiss callback allows conditional rendering
- [ ] Accessible (proper ARIA attributes)

### WS6: MtlEntryForm Component

**Purpose:** Manual MTL entry form for compliance staff, replicating the official Affinity Gaming MTL paper form layout.

**Reference:** `docs/00-vision/mtl-service-evolution/MTL-FORM.png`

**Form Layout (Two Sections):**

**Section 1: Patron Identification (auto-populated from player data)**
| Field | Source | Display |
|-------|--------|---------|
| Name | `player.first_name + player.last_name` | Read-only text |
| Account Number | `player.loyalty_card_number` or `player.id` | Read-only text |
| DOB | `player.date_of_birth` | Read-only (age calculated) |
| Sex/Race/Height | `player` profile if available | Read-only or N/A |

**Section 2: Transaction Grid (editable)**
| Column | Field | Type |
|--------|-------|------|
| Time | `occurred_at` | DateTime picker (defaults to now) |
| Location & Table | `area` + `table_id` | Text/Select |
| Trans Type | `txn_type` code | Select (1-14 per legend) |
| Transaction Amount | `amount` | Currency input |
| Total Cash-In | Running total | Computed (read-only) |
| Total Cash-Out | Running total | Computed (read-only) |
| Signature & Employee | `staff_id` | Auto from auth context |
| Comments | `note` | Text input (required) |

**Transaction Type Codes (from official form):**
```typescript
const MTL_TXN_TYPE_CODES = {
  // Cash-In (direction: 'in')
  1: { label: 'Purchase of Chips/Tokens', direction: 'in', mtlType: 'buy_in' },
  2: { label: 'Front Money Deposit', direction: 'in', mtlType: 'front_money' },
  3: { label: 'Safekeeping Deposit', direction: 'in', mtlType: 'front_money' },
  4: { label: 'Marker Payment', direction: 'in', mtlType: 'marker' },
  5: { label: 'Currency Exchange', direction: 'in', mtlType: 'chip_fill' },
  // Cash-Out (direction: 'out')
  6: { label: 'Redemption of Chips/Tokens/Tickets', direction: 'out', mtlType: 'cash_out' },
  7: { label: 'Front Money Withdrawal', direction: 'out', mtlType: 'front_money' },
  8: { label: 'Safekeeping Withdrawal', direction: 'out', mtlType: 'front_money' },
  9: { label: 'Marker Issuance', direction: 'out', mtlType: 'marker' },
  10: { label: 'Cash from Wire Transfer', direction: 'out', mtlType: 'other' },
  11: { label: 'Currency Exchange', direction: 'out', mtlType: 'chip_fill' },
  12: { label: 'Jackpot/Tournament Payout', direction: 'out', mtlType: 'other' },
} as const;
```

**CTR Warning Banner:**
Display when running total approaches $10,000:
> "Before a customer exceeds $10,000 in either cash-in or cash-out transactions, the customer's ID, address, and social security number must be obtained."

**React 19 Form Implementation:**

Use React 19's `useActionState` and `useFormStatus` hooks for form handling:

```typescript
"use client";

import { useActionState } from "react";
import { useFormStatus } from "react-dom";

// Form state type
interface MtlEntryFormState {
  error: string | null;
  success: boolean;
}

// Submit button component (uses useFormStatus for pending state)
function SubmitButton() {
  const { pending } = useFormStatus();
  return (
    <Button type="submit" disabled={pending}>
      {pending ? "Recording..." : "Record Entry"}
    </Button>
  );
}

// Main form component
function MtlEntryForm({ casinoId, staffId, patronUuid, onSuccess }: MtlEntryFormProps) {
  const [state, submitAction, isPending] = useActionState(
    async (prevState: MtlEntryFormState, formData: FormData) => {
      // Extract form fields via formData.get()
      const amount = Number(formData.get("amount"));
      const txnTypeCode = Number(formData.get("txnType"));
      const note = formData.get("note") as string;

      // Validate required fields
      if (!note?.trim()) {
        return { error: "Comments/note is required", success: false };
      }

      // Map txn type code to direction and mtlType
      const txnType = MTL_TXN_TYPE_CODES[txnTypeCode];

      // Call mutation
      const result = await createMtlEntry({
        casino_id: casinoId,
        patron_uuid: formData.get("patronUuid") as string,
        amount,
        direction: txnType.direction,
        txn_type: txnType.mtlType,
        source: "table",
        staff_id: staffId,
        note,
        idempotency_key: crypto.randomUUID(),
      });

      if (result.error) {
        return { error: result.error.message, success: false };
      }

      onSuccess?.();
      return { error: null, success: true };
    },
    { error: null, success: false }
  );

  return (
    <form action={submitAction}>
      {/* Patron identification section (read-only) */}
      {/* Transaction grid with named inputs */}
      <input type="hidden" name="patronUuid" value={patronUuid} />
      <input type="number" name="amount" required min={0} step={0.01} />
      <select name="txnType" required>
        {Object.entries(MTL_TXN_TYPE_CODES).map(([code, { label }]) => (
          <option key={code} value={code}>{code}. {label}</option>
        ))}
      </select>
      <textarea name="note" required placeholder="Required: explain this entry" />

      {state.error && <p className="text-destructive">{state.error}</p>}

      <SubmitButton />
    </form>
  );
}
```

**Key React 19 Patterns:**
1. **useActionState**: Returns `[state, submitAction, isPending]` - manages form state, action function, and pending state
2. **useFormStatus**: Used in child `<SubmitButton>` component to access `pending` state within the form
3. **FormData API**: Access form values via `formData.get("fieldName")` - no useState needed for form fields
4. **Progressive Enhancement**: Form works before JS hydration
5. **Auto-reset**: Form resets automatically on successful submission

**Props Interface:**
```typescript
interface MtlEntryFormProps {
  casinoId: string;
  staffId: string;
  /** Pre-selected patron (optional - can also search) */
  patronUuid?: string;
  /** Pre-link to visit/slip (optional) */
  visitId?: string;
  ratingSlipId?: string;
  onSuccess?: () => void;
  onCancel?: () => void;
}
```

**Acceptance Criteria:**
- [ ] Uses React 19 `useActionState` hook for form state management
- [ ] Uses `useFormStatus` in child SubmitButton component for pending state
- [ ] Form fields use native `name` attributes (no useState for form data)
- [ ] Form layout matches official MTL paper form structure
- [ ] Patron identification auto-populates from player data
- [ ] Transaction type dropdown shows codes 1-12 with descriptions
- [ ] Running totals (cash-in/cash-out) compute automatically
- [ ] CTR warning displays when totals approach $10,000
- [ ] Generates idempotency key client-side (crypto.randomUUID)
- [ ] Comments/note field is required (validation error if empty)
- [ ] Error display from useActionState state
- [ ] Success callback triggers query invalidation

### WS7: Rating Slip Modal Integration

**Purpose:** Wire threshold awareness into the buy-in workflow.

**Changes to `useSaveWithBuyIn`:**
1. Accept optional `playerDailyTotal` parameter
2. Call `checkThreshold()` with projected total
3. Call `notifyThreshold()` to show toast
4. Auto-create MTL entry if `shouldCreateMtl === true`

**Modal Integration:**
1. Fetch `usePlayerDailyTotal` for selected player
2. Display `BuyInThresholdIndicator` when newBuyIn > 0
3. Show `CtrBanner` when `requiresCtr === true`

**Acceptance Criteria:**
- [ ] Threshold check runs before save
- [ ] Toast notification fires for applicable thresholds
- [ ] MTL entry auto-created when threshold ≥ $3,000
- [ ] Indicator shows projected total
- [ ] CTR banner appears when applicable

### WS8: Compliance Dashboard Integration

**Purpose:** Add manual entry capability to compliance dashboard.

**Changes to `compliance-dashboard.tsx`:**
1. Add "New Entry" button to header
2. Open Dialog with `MtlEntryForm`
3. Invalidate queries on success
4. Show success toast

**Acceptance Criteria:**
- [ ] Button visible to authorized users (pit_boss, admin)
- [ ] Form opens in modal/dialog
- [ ] Query invalidation on success
- [ ] Toast confirms entry creation

### WS9: Unit Tests

**Purpose:** Test all new hooks and components in isolation.

**Test Files:**
1. `__tests__/hooks/mtl/use-threshold-notifications.test.ts`
   - Test all threshold levels
   - Test cumulative total calculation
   - Test toast invocation

2. `__tests__/hooks/mtl/use-patron-daily-total.test.ts`
   - Test query key generation
   - Test enabled/disabled states
   - Test data transformation

3. `__tests__/components/rating-slip/buy-in-threshold-indicator.test.tsx`
   - Test all visual states
   - Test no render when amount ≤ 0
   - Test projected total calculation

4. `__tests__/components/mtl/ctr-banner.test.tsx`
   - Test content rendering
   - Test dismiss callback
   - Test external link

5. `__tests__/components/mtl/mtl-entry-form.test.tsx`
   - Test patron identification auto-population
   - Test transaction type dropdown (codes 1-12)
   - Test running total computation
   - Test CTR warning display at $10,000
   - Test required field validation (comments)
   - Test form submission
   - Test error handling

6. `__tests__/components/mtl/mtl-txn-type-codes.test.ts`
   - Test direction mapping (in/out)
   - Test mtlType mapping
   - Test all 12 transaction codes

**Acceptance Criteria:**
- [ ] ≥90% coverage for new code
- [ ] All tests pass with `npm test`

### WS10: E2E Tests

**Purpose:** Validate complete workflow integration.

**Test Scenarios:**
1. Warning toast at $2,500 buy-in
2. MTL created toast at $3,000 buy-in
3. CTR warning toast at $9,000 buy-in
4. CTR banner displayed at >$10,000 daily total
5. Auto-created MTL visible in compliance dashboard
6. Manual entry via dashboard form
7. Threshold indicator shows correct projected total

**Acceptance Criteria:**
- [ ] All scenarios pass
- [ ] No flaky tests
- [ ] Reasonable execution time (<2 minutes)

## Definition of Done

**Gap 1 - Manual Entry Form:**
- [x] MtlEntryForm component created (WS6)
- [x] Note field required (validation)
- [x] Dashboard integration (WS8)
- [x] Unit tests pass (WS9)

**Gap 2 - Automated Derivation:**
- [x] Database trigger created (WS1)
- [x] Eligible filter implemented
- [x] Idempotency key format correct
- [x] `npm run db:types` succeeds

**Gap 3 - Rating Slip Integration:**
- [x] useSaveWithBuyIn enhanced (WS7)
- [x] Auto-creates MTL at threshold
- [x] Linked to visit and rating slip

**Gap 4 - Threshold Notifications:**
- [x] useThresholdNotifications created (WS2)
- [x] Toast notifications fire correctly
- [x] Integrated in buy-in flow (WS7)

**Gap 5 - CTR Banner:**
- [x] CtrBanner component created (WS5)
- [x] Displays when >$10,000
- [x] Integrated in modal (WS7)

**Gap 6 - Daily Aggregate Display:**
- [x] usePlayerDailyTotal hook created (WS3)
- [x] BuyInThresholdIndicator shows projected total (WS4)
- [x] Integrated in modal (WS7)

**Quality Gates:**
- [x] All workstreams complete
- [x] Type-check passes
- [x] Unit tests pass (≥90% coverage)
- [x] E2E tests pass
- [x] Build succeeds
