---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline skill

prd: PRD-023
prd_title: "Player 360 Panels v0 — Action-First Summary, Charts & Timeline"
service: Player360DashboardService
mvp_phase: 1
# NOTE: This is a UI/aggregation service that performs READ-ONLY operations
# across existing bounded contexts. No database table modifications.
bounded_contexts:
  - PlayerContext (read-only)
  - VisitContext (read-only)
  - LoyaltyContext (read-only)

# Workstream Definitions
workstreams:
  WS1:
    name: Service Layer Extensions
    description: Create player360-dashboard service with summary metrics, eligibility status, and weekly series aggregation from existing data (READ-ONLY, no table modifications)
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - services/player360-dashboard/dtos.ts
      - services/player360-dashboard/schemas.ts
      - services/player360-dashboard/keys.ts
      - services/player360-dashboard/mappers.ts
      - services/player360-dashboard/crud.ts
      - services/player360-dashboard/index.ts
    gate: type-check
    estimated_complexity: medium

  WS2:
    name: React Hooks Layer
    description: Create TanStack Query hooks for player summary, eligibility, weekly series, and shared timeline filter state
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - hooks/player-360/use-player-summary.ts
      - hooks/player-360/use-player-eligibility.ts
      - hooks/player-360/use-player-weekly-series.ts
      - hooks/player-360/use-timeline-filter.ts
      - hooks/player-360/index.ts
    gate: type-check
    estimated_complexity: medium

  WS3:
    name: Summary Band Components (Center Panel)
    description: Build SummaryBand container with 4 action tiles (Session Value, Cash Velocity, Engagement, Rewards Eligibility) and TimeLensControl
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - components/player-360/summary/summary-band.tsx
      - components/player-360/summary/summary-tile.tsx
      - components/player-360/summary/time-lens-control.tsx
      - components/player-360/summary/index.ts
    gate: type-check
    estimated_complexity: medium

  WS4:
    name: Left Rail Interactive Components
    description: Build filter tiles, jump-to navigation, rewards eligibility card, and rewards history list for left rail
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - components/player-360/left-rail/filter-tile-stack.tsx
      - components/player-360/left-rail/filter-tile.tsx
      - components/player-360/left-rail/jump-to-nav.tsx
      - components/player-360/left-rail/index.ts
      - components/player-360/rewards/rewards-eligibility-card.tsx
      - components/player-360/rewards/rewards-history-list.tsx
      - components/player-360/rewards/rewards-history-item.tsx
      - components/player-360/rewards/index.ts
    gate: type-check
    estimated_complexity: high

  WS5:
    name: Activity Chart Component
    description: Build consolidated Activity chart showing visits + rewards series (Trend Pattern B)
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - components/player-360/charts/activity-chart.tsx
      - components/player-360/charts/index.ts
    gate: type-check
    estimated_complexity: medium

  WS6:
    name: Layout Integration
    description: Integrate all components into Player 360 layout, add Recent Events Strip, header actions, and coordinate filter state
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS3, WS4, WS5]
    outputs:
      - components/player-360/recent-events-strip.tsx
      - components/player-360/header/add-note-button.tsx
      - components/player-360/header/issue-reward-button.tsx
      - components/player-360/header/index.ts
      - app/(dashboard)/players/[playerId]/timeline/_components/timeline-content.tsx
    gate: type-check
    estimated_complexity: high

  WS7:
    name: Testing & QA
    description: Unit tests for components/hooks, integration tests for data flow, E2E tests for critical paths
    executor: qa-specialist
    executor_type: skill
    depends_on: [WS6]
    outputs:
      - components/player-360/__tests__/summary-band.test.tsx
      - components/player-360/__tests__/filter-tile.test.tsx
      - components/player-360/__tests__/rewards-eligibility-card.test.tsx
      - hooks/player-360/__tests__/use-player-summary.test.ts
      - hooks/player-360/__tests__/use-timeline-filter.test.ts
      - e2e/workflows/player-360-panels.spec.ts
    gate: test-pass
    estimated_complexity: high

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Service Foundation
    parallel: [WS1]
    gates: [type-check]

  - name: Phase 2 - Hooks Layer
    parallel: [WS2]
    gates: [type-check]

  - name: Phase 3 - Core Components (Parallelized)
    parallel: [WS3, WS4, WS5]
    gates: [type-check]

  - name: Phase 4 - Layout Integration
    parallel: [WS6]
    gates: [type-check]

  - name: Phase 5 - Testing & Validation
    parallel: [WS7]
    gates: [test-pass, build]

# Validation Gates
gates:
  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0, no type errors"

  lint:
    command: npm run lint
    success_criteria: "Exit code 0, no errors (warnings OK)"

  test-pass:
    command: npm test -- --passWithNoTests
    success_criteria: "All tests pass"

  build:
    command: npm run build
    success_criteria: "Build succeeds"

# Dependencies on other PRDs/Services
external_dependencies:
  - prd: PRD-022-PATCH-OPTION-B
    service: Player360Search
    required_for: "Embedded search in Player 360 layout (already complete)"

  - prd: ADR-029
    service: PlayerTimeline
    required_for: "Timeline event taxonomy and infinite scroll (already complete)"

# Risks and Mitigations
risks:
  - risk: "Rewards eligibility logic may not exist in loyalty service"
    mitigation: "Ship with explicit 'Unknown' state when rules not configured"

  - risk: "Session boundary logic complexity (gaming day vs rolling window)"
    mitigation: "Define clear fallback: use rolling 90-minute window if session not defined"

  - risk: "Performance of aggregation queries across visits/events"
    mitigation: "Use date-bounded queries with indexes; consider RPC if slow"

  - risk: "Filter state synchronization between Left Rail and Center tiles"
    mitigation: "Single source of truth via Zustand store or URL params"

---

# EXECUTION-SPEC: PRD-023 - Player 360 Panels v0

## Overview

This PRD delivers action-first dashboard enhancements to Player 360 that enable pit staff to quickly assess player value, session momentum, and reward eligibility. The implementation consolidates metric displays, eliminates redundant temporal data, and adds interactive tile-to-timeline coordination.

**Key Outcomes:**
- < 10 second time-to-first-meaningful-answer
- Action-first Summary Band with 4 operational tiles
- Interactive Left Rail with filter controls and navigation
- De-duplicated temporal visualization (Trend Pattern B: single Activity chart)
- Tile clicks filter and scroll timeline

## Scope

**In Scope:**
- Summary Band (4 tiles: Session Value, Cash Velocity, Engagement, Rewards Eligibility)
- Left Rail interactive controls (filter tiles, jump-to nav, rewards card, history)
- Time Lens Control (30d | 90d | 12w)
- Activity Chart (consolidated visits + rewards series)
- Recent Events Strip (3 items: last buy-in, last reward, last note)
- Header actions (Add Note, Issue Reward buttons)
- Tile-to-Timeline filtering coordination
- Empty states for all new components

**Out of Scope:**
- Database migrations (use existing tables)
- New bounded contexts (aggregate from existing PlayerContext, VisitContext, LoyaltyContext)
- Reward issuance workflow (Issue Reward button is stub)
- Cross-player analytics (no leaderboards, rankings, comparisons)
- Mobile-specific layouts

## Architecture Context

**References:**
- SRM v4.11.0: PlayerContext, VisitContext, LoyaltyContext boundaries
- ADR-029: Player 360 Timeline Dashboard (event taxonomy)
- PRD-022-PATCH-OPTION-B: Embedded search in Player 360

**Layout Constraint (CRITICAL):**
The main dashboard surface (`Player360Layout`) MUST NOT scroll. Only content within each rail/panel scrolls independently via `overflow-y-auto`.

**Three-Column Structure:**
| Rail | Width | Visibility | Scroll |
|------|-------|------------|--------|
| Left Rail | w-72 / xl:w-80 | lg+ only | overflow-y-auto |
| Center Panel | flex-1 | Always | overflow-y-auto |
| Right Rail | w-80 (collapsible) | xl+ only | overflow-y-auto |

**Filter State Coordination:**
Left Rail filter tiles and Center Summary Band tiles share filter state via:
- Option A: Zustand store (`store/player-360-filter-store.ts`)
- Option B: URL query params (for shareable state)

Decision: Use Zustand store for internal state, URL params for debugging/deep-linking.

## Workstream Details

### WS1: Service Layer Extensions

**Purpose:** Create Player360Service that aggregates data from existing services to provide summary metrics, eligibility status, and weekly activity series.

**Bounded Context:** PlayerContext (read-only aggregation)

**Data Contracts:**

```typescript
// services/player360-dashboard/dtos.ts

/** Session value metrics for Summary Band */
export interface PlayerSessionValueDTO {
  netWinLoss: number;      // Cash out - cash in (session or rolling window)
  theoEstimate: number;    // Theoretical win/loss
  lastActionAt: string;    // ISO timestamp
  trendPercent: number;    // vs previous period (-100 to +100)
}

/** Cash velocity metrics */
export interface PlayerCashVelocityDTO {
  ratePerHour: number;     // $ per hour
  sessionTotal: number;    // Total cash in for session
  lastBuyInAt: string;     // ISO timestamp
}

/** Engagement status */
export interface PlayerEngagementDTO {
  status: 'active' | 'cooling' | 'dormant';
  durationMinutes: number; // Session duration
  lastSeenAt: string;      // ISO timestamp
  isActive: boolean;       // Derived: last action within 15 min
}

/** Rewards eligibility */
export interface RewardsEligibilityDTO {
  status: 'available' | 'not_available' | 'unknown';
  nextEligibleAt: string | null;  // ISO timestamp if cooldown active
  reasonCodes: ReasonCode[];      // Why not available
  guidance: string | null;        // User-facing guidance text
}

export type ReasonCode =
  | 'AVAILABLE'
  | 'COOLDOWN_ACTIVE'
  | 'MIN_PLAY_NOT_MET'
  | 'DAILY_LIMIT_REACHED'
  | 'RULES_NOT_CONFIGURED';

/** Combined summary for all tiles */
export interface PlayerSummaryDTO {
  playerId: string;
  sessionValue: PlayerSessionValueDTO;
  cashVelocity: PlayerCashVelocityDTO;
  engagement: PlayerEngagementDTO;
  rewardsEligibility: RewardsEligibilityDTO;
  gamingDay: string;  // Current gaming day context
}

/** Weekly series for Activity chart */
export interface WeeklyBucketDTO {
  weekStart: string;  // ISO date (Monday)
  visitCount: number;
  rewardCount: number;
}

export interface WeeklySeriesDTO {
  buckets: WeeklyBucketDTO[];
  periodStart: string;
  periodEnd: string;
}

/** Reward history item */
export interface RewardHistoryItemDTO {
  id: string;
  issuedAt: string;
  rewardType: 'matchplay' | 'freeplay' | 'comp' | 'other';
  amount: number;
  issuedBy: { id: string; name: string };
  visitId: string | null;
}

/** Recent events for strip */
export interface RecentEventsDTO {
  lastBuyIn: { at: string; amount: number } | null;
  lastReward: { at: string; type: string } | null;
  lastNote: { at: string; preview: string } | null;
}
```

**Deliverables:**
1. `services/player360-dashboard/dtos.ts` - DTO definitions above
2. `services/player360-dashboard/schemas.ts` - Zod validation schemas
3. `services/player360-dashboard/keys.ts` - React Query key factory
4. `services/player360-dashboard/mappers.ts` - Transform existing service data to DTOs
5. `services/player360-dashboard/crud.ts` - Aggregation functions calling existing services
6. `services/player360-dashboard/index.ts` - Service factory export

**Aggregation Logic:**
- Session Value: Query visit service for current session, compute net W/L
- Cash Velocity: Query financial events, compute rate over session duration
- Engagement: Query timeline for last event, derive status from timestamp
- Rewards Eligibility: Query loyalty service (or return 'unknown' if not configured)
- Weekly Series: Query visits + rewards, group by week

**Acceptance Criteria:**
- [ ] DTOs derive from Database types where applicable
- [ ] Service follows functional factory pattern
- [ ] No cross-context writes (read-only aggregation)
- [ ] Unknown state handled explicitly for eligibility
- [ ] `npm run type-check` passes

---

### WS2: React Hooks Layer

**Purpose:** Create TanStack Query hooks for data fetching and a Zustand store for filter state coordination.

**Deliverables:**
1. `hooks/player-360/use-player-summary.ts` - Query hook for PlayerSummaryDTO
2. `hooks/player-360/use-player-eligibility.ts` - Query hook for detailed eligibility
3. `hooks/player-360/use-player-weekly-series.ts` - Query hook for chart data
4. `hooks/player-360/use-timeline-filter.ts` - Shared filter state hook
5. `hooks/player-360/index.ts` - Updated exports

**Query Key Registry:**
```typescript
// hooks/player-360/keys.ts (or extend existing)
export const player360Keys = {
  all: ['player-360'] as const,
  summary: (playerId: string) => [...player360Keys.all, 'summary', playerId] as const,
  eligibility: (playerId: string) => [...player360Keys.all, 'eligibility', playerId] as const,
  weeklySeries: (playerId: string, range: TimeLensRange) =>
    [...player360Keys.all, 'weekly-series', playerId, range] as const,
  rewardsHistory: (playerId: string) =>
    [...player360Keys.all, 'rewards-history', playerId] as const,
  recentEvents: (playerId: string) =>
    [...player360Keys.all, 'recent-events', playerId] as const,
};
```

**Filter State Store:**
```typescript
// store/player-360-filter-store.ts (or within hooks)
interface TimelineFilterState {
  activeCategory: SourceCategory | null;  // Session, Gaming, Financial, Loyalty, etc.
  timeLens: '30d' | '90d' | '12w';
  setCategory: (category: SourceCategory | null) => void;
  setTimeLens: (lens: '30d' | '90d' | '12w') => void;
  clearFilter: () => void;
}
```

**Acceptance Criteria:**
- [ ] Hooks use key factories for de-duplication
- [ ] Filter state is single source of truth
- [ ] `usePlayerSummary` returns loading/error/data states
- [ ] `useTimelineFilter` provides setter functions
- [ ] `npm run type-check` passes

---

### WS3: Summary Band Components (Center Panel)

**Purpose:** Build the horizontal 4-tile Summary Band for the center panel with TimeLensControl.

**Components:**

**SummaryBand:**
- Grid layout: `grid-cols-2 lg:grid-cols-4 gap-3`
- Contains 4 SummaryTile components
- Receives PlayerSummaryDTO from parent

**SummaryTile:**
- Props: `title`, `primaryValue`, `secondaryValue`, `microDetail`, `trend?`, `category`, `isActive`, `onClick`
- Design tokens per PRD Section 7.1:
  - Session Value: emerald (bg-emerald-500/10, text-emerald-400)
  - Cash Velocity: blue (bg-blue-500/10, text-blue-400)
  - Engagement: slate (bg-slate-500/10, text-slate-300)
  - Rewards: amber (bg-amber-500/10, text-amber-400)
- Active state: `ring-2 ring-primary`
- Click handler: dispatch filter action + scroll timeline

**TimeLensControl:**
- Toggle buttons: `30d | 90d | 12w`
- Position: Above Summary Band in center panel
- Updates filter state on change

**Deliverables:**
1. `components/player-360/summary/summary-band.tsx`
2. `components/player-360/summary/summary-tile.tsx`
3. `components/player-360/summary/time-lens-control.tsx`
4. `components/player-360/summary/index.ts`

**Acceptance Criteria:**
- [ ] Tiles render correct values from DTO
- [ ] Click dispatches filter action
- [ ] Active tile shows ring indicator
- [ ] Time Lens updates filter state
- [ ] Responsive: 2 cols on mobile, 4 cols on lg+
- [ ] `data-testid` attributes on all interactive elements
- [ ] `npm run type-check` passes

---

### WS4: Left Rail Interactive Components

**Purpose:** Build interactive control surface for Left Rail with filter tiles, navigation, and rewards panels.

**Components:**

**FilterTileStack:**
- Container for 4 stacked filter tiles (~48px each)
- Vertical layout fitting ~200px height budget

**FilterTile:**
- Props: `title`, `value`, `isActive`, `category`, `onFilter`, `onClear`
- Compact: value + optional delta, no labels duplicating Center
- Active state: ring indicator + "×" clear affordance
- Click: applies timeline filter

**JumpToNav:**
- Collapsible section with anchor links
- Links: Summary, Chart, Timeline
- Click: smooth scroll to section (in-page, not routing)
- Keyboard accessible (Enter/Space)

**RewardsEligibilityCard:**
- Compact (~80px): status badge, reason label, countdown
- "Show related events" button: filters to Loyalty + scrolls
- Unknown state: explicit "Unknown" badge when rules not configured

**RewardsHistoryList:**
- 2-3 most recent items above fold
- Click: scroll timeline to corresponding event
- Filter chips: Matchplay, Freeplay, All

**Deliverables:**
1. `components/player-360/left-rail/filter-tile-stack.tsx`
2. `components/player-360/left-rail/filter-tile.tsx`
3. `components/player-360/left-rail/jump-to-nav.tsx`
4. `components/player-360/left-rail/index.ts`
5. `components/player-360/rewards/rewards-eligibility-card.tsx`
6. `components/player-360/rewards/rewards-history-list.tsx`
7. `components/player-360/rewards/rewards-history-item.tsx`
8. `components/player-360/rewards/index.ts`

**Acceptance Criteria:**
- [ ] Every tile is clickable (no read-only decoration)
- [ ] Active filter shows ring + clear affordance
- [ ] Filter state synced with Center Summary Band
- [ ] Jump To performs smooth scroll
- [ ] Rewards card shows status + reason + countdown
- [ ] "Show related events" filters + scrolls timeline
- [ ] History items are clickable
- [ ] Content fits ~340px above fold
- [ ] `npm run type-check` passes

---

### WS5: Activity Chart Component

**Purpose:** Build consolidated Activity chart with visits + rewards series (Trend Pattern B).

**Component:**

**ActivityChart:**
- Single chart with two series: visits (blue), rewards (amber)
- X-axis: weeks (per WeeklySeriesDTO)
- Y-axis: count
- Bucket click: applies date range filter to timeline
- Responsive height: ~200px
- Library: recharts (already in project) or nivo

**Deliverables:**
1. `components/player-360/charts/activity-chart.tsx`
2. `components/player-360/charts/index.ts`

**Acceptance Criteria:**
- [ ] Single chart with combined series (NOT two separate charts)
- [ ] Bucket click applies date filter
- [ ] Renders within 100ms
- [ ] Accessible: aria-label, keyboard navigation
- [ ] `npm run type-check` passes

---

### WS6: Layout Integration

**Purpose:** Wire all components into the Player 360 layout, add Recent Events Strip and header actions.

**Integration Points:**

**timeline-content.tsx Updates:**
- Replace current left rail tiles with FilterTileStack + RewardsEligibilityCard
- Add SummaryBand to center panel (below TimeLensControl)
- Add ActivityChart below Summary Band (optional, collapsible)
- Add RecentEventsStrip above timeline filters
- Coordinate filter state between all components

**Recent Events Strip:**
- 3-item grid: last buy-in, last reward, last note
- Click: scroll timeline to event
- Position: above TimelineFilterBar

**Header Actions:**
- AddNoteButton: Opens note composer (or stub)
- IssueRewardButton: Disabled with tooltip if backend not ready

**Smooth Scroll:**
- Jump To targets need `id` attributes
- Use `scrollIntoView({ behavior: 'smooth' })`

**Deliverables:**
1. `components/player-360/recent-events-strip.tsx`
2. `components/player-360/header/add-note-button.tsx`
3. `components/player-360/header/issue-reward-button.tsx`
4. `components/player-360/header/index.ts` (updated)
5. `app/(dashboard)/players/[playerId]/timeline/_components/timeline-content.tsx` (updated)

**Acceptance Criteria:**
- [ ] All components rendered in correct positions
- [ ] Filter state synchronized across Left Rail and Center
- [ ] Tile click filters timeline and scrolls to first match
- [ ] Jump To smooth scrolls to target sections
- [ ] Header actions present (Issue Reward may be disabled)
- [ ] No layout shift on data load
- [ ] Main dashboard surface does NOT scroll
- [ ] `npm run type-check` and `npm run lint` pass

---

### WS7: Testing & QA

**Purpose:** Validate implementation with unit, integration, and E2E tests.

**Unit Tests:**
- Summary Band renders correct values
- Filter tile click dispatches action
- Rewards eligibility shows all states
- Filter state synchronization

**Integration Tests:**
- Data fetches and displays correctly
- Tile click updates timeline query
- Time Lens change affects summary

**E2E Tests:**
- Navigate to `/players/[playerId]` → Summary Band visible
- Click tile → Timeline filters correctly
- Left Rail visible on desktop
- Click Jump To → Smooth scroll

**Deliverables:**
1. `components/player-360/__tests__/summary-band.test.tsx`
2. `components/player-360/__tests__/filter-tile.test.tsx`
3. `components/player-360/__tests__/rewards-eligibility-card.test.tsx`
4. `hooks/player-360/__tests__/use-player-summary.test.ts`
5. `hooks/player-360/__tests__/use-timeline-filter.test.ts`
6. `e2e/workflows/player-360-panels.spec.ts`

**Acceptance Criteria:**
- [ ] All unit tests pass
- [ ] Integration tests cover data flow
- [ ] E2E tests cover critical paths
- [ ] No regressions in existing timeline tests
- [ ] `npm test` passes
- [ ] `npm run build` passes

---

## Definition of Done

### Center Panel Requirements
- [ ] Summary Band renders with 4 action tiles
- [ ] Tile interactions work (click filters + scrolls)
- [ ] Time Lens control affects summary and timeline
- [ ] De-duplication rule: trend in ONE place only (Activity Chart)
- [ ] Recent Events Strip renders 3 items
- [ ] Header Actions: Edit Profile, Add Note, Issue Reward present

### Left Rail Requirements ("No Static Tiles")
- [ ] Every tile is clickable and changes timeline
- [ ] Active filter shows ring + clear affordance
- [ ] Filter state synchronized with Center
- [ ] Jump To performs smooth scroll
- [ ] Rewards card shows status + reason + countdown
- [ ] "Show related events" works
- [ ] History items scroll timeline to events

### Quality Requirements
- [ ] No cross-player analytics present
- [ ] First meaningful answer < 10 seconds
- [ ] No read-only decoration blocks
- [ ] Summary query < 150ms (p95)
- [ ] No layout shift on data load

### Test Coverage
- [ ] Unit tests for all new components
- [ ] Integration tests for filter synchronization
- [ ] E2E tests for critical user journeys
- [ ] All gates pass (type-check, lint, test-pass, build)

---

## Changelog

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | 2026-01-26 | Initial EXECUTION-SPEC generated from PRD-023 v2.2.0 |
