---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline for GAP-TBL-RUNDOWN (Finance → Telemetry Bridge)

prd: GAP-TBL-RUNDOWN
prd_title: "Gap Analysis: Table Rundown → Shift Dashboards Data Pipeline Bridge"
service: TableContext
mvp_phase: 2
source_doc: "docs/00-vision/table-context-read-model/GAP_ANALYSIS_TABLE_RUNDOWN_INTEGRATION_REWRITE_v0.4.0.md"
version: "v0.4.0"

workstreams:
  WS1:
    name: Add source column to table_buyin_telemetry
    description: Add source dimension ('finance_bridge' | 'manual_ops') to distinguish telemetry provenance
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/*_table_buyin_telemetry_source_column.sql
    gate: schema-validation
    estimated_complexity: low

  WS2:
    name: Finance-to-Telemetry Bridge Function
    description: SECURITY DEFINER function implementing Guardrails G1-G5 for automatic bridging
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - supabase/migrations/*_fn_bridge_finance_to_telemetry.sql
    gate: schema-validation
    estimated_complexity: high

  WS3:
    name: Attach Bridge Trigger to player_financial_transaction
    description: AFTER INSERT trigger on player_financial_transaction for rated buy-ins
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - supabase/migrations/*_trg_bridge_finance_to_telemetry.sql
    gate: schema-validation
    estimated_complexity: medium

  WS4:
    name: Update rpc_log_table_buyin_telemetry with source parameter
    description: Add p_source parameter to manual telemetry RPC with default 'manual_ops'
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - supabase/migrations/*_rpc_log_table_buyin_telemetry_source.sql
    gate: schema-validation
    estimated_complexity: low

  WS5:
    name: Integration Tests for Bridge
    description: Test automatic bridge, idempotency, guardrails, and source dimension
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1, WS2, WS3, WS4]
    outputs:
      - __tests__/services/table-context/finance-telemetry-bridge.int.test.ts
    gate: test-pass
    estimated_complexity: medium

execution_phases:
  - name: Phase 1 - Schema Extension
    parallel: [WS1]
    gates: [schema-validation]

  - name: Phase 2 - Functions
    parallel: [WS2, WS4]
    gates: [schema-validation]

  - name: Phase 3 - Trigger
    parallel: [WS3]
    gates: [schema-validation]

  - name: Phase 4 - Tests
    parallel: [WS5]
    gates: [test-pass]

gates:
  schema-validation:
    command: npm run db:types
    success_criteria: "Exit code 0, no type errors"

  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0"

  test-pass:
    command: npm test __tests__/services/table-context/finance-telemetry-bridge
    success_criteria: "All tests pass"

external_dependencies:
  - table: player_financial_transaction
    service: PlayerFinancialService
    required_for: "Source table for automatic bridge trigger"

  - table: rating_slip
    service: RatingSlipService
    required_for: "Join to derive table_id for telemetry"

  - table: table_buyin_telemetry
    service: TableContext
    required_for: "Target table for bridged telemetry"

  - function: set_rls_context_from_staff
    service: Security
    required_for: "ADR-024 compliant context injection"

  - function: compute_gaming_day
    service: CasinoService
    required_for: "Gaming day calculation for telemetry"

risks:
  - risk: "Trigger performance impact on high-volume finance inserts"
    mitigation: "Trigger is conditional (only for rated buy-ins); benchmark with realistic load"

  - risk: "Context not set for service_role inserts"
    mitigation: "Hybrid approach: derive from row data when context unavailable"

  - risk: "Amount conversion precision loss (dollars to cents)"
    mitigation: "Use ROUND(amount * 100)::bigint with explicit precision handling"

---

# EXECUTION-SPEC: GAP-TBL-RUNDOWN - Finance → Telemetry Bridge

#
## Schema Mapping (MUST align to canonical database.types.ts)

This EXECUTION-SPEC includes **behavioral SQL sketches**. Before shipping migrations, map these identifiers to the canonical PT‑2 schema:

- `table_id` vs `gaming_table_id`
- `occurred_at` vs `observed_at` / `created_at`
- Finance amount units: `amount` (numeric dollars) vs `amount_cents` (bigint)
- Finance actor column: `created_by_staff_id` (or equivalent)
- Rating slip table link: `rating_slip.gaming_table_id` (or equivalent)

**DoD gate**: migrations must compile cleanly against the canonical schema and regenerated `types/database.types.ts`.


# Overview

This EXECUTION-SPEC implements the **automatic bridge from Finance to Telemetry** as defined in the GAP_ANALYSIS v0.4.0 document. The core insight: **Shift Dashboards can only show meaningful buy-in data if telemetry rows exist**, and the primary source of rated buy-ins is `player_financial_transaction`.

## Problem Statement

> "The Shift Dashboards read model can be correct and still report junk if the Table Rundown pipeline fails to emit the operational buy-in/drop signals that the rollups depend on."

Currently:
- `table_buyin_telemetry` table exists ✅
- `rpc_log_table_buyin_telemetry` exists for manual logging ✅
- **Automatic bridging from Finance does NOT exist** ❌

This gap means:
- Rated buy-ins recorded via pit boss buy-in workflow create Finance rows
- But those rows are NOT automatically replicated to telemetry
- Dashboards show zero/incomplete buy-in data

## Solution Architecture

```
┌─────────────────────────────────┐
│ player_financial_transaction    │
│ (PlayerFinancialService)        │
└───────────────┬─────────────────┘
                │ AFTER INSERT
                │ WHERE direction='in' AND rating_slip_id IS NOT NULL
                ▼
┌─────────────────────────────────┐
│ fn_bridge_finance_to_telemetry  │
│ (SECURITY DEFINER w/ Guardrails)│
└───────────────┬─────────────────┘
                │ INSERT (idempotent)
                ▼
┌─────────────────────────────────┐
│ table_buyin_telemetry           │
│ (TableContext)                  │
│ source = 'finance_bridge'       │
└─────────────────────────────────┘
```

## Canonical Decisions (from GAP v0.4.0)

### Q2 Resolution: Schema Mismatch
**Decision**: Always use `RATED_BUYIN` whenever a rating slip exists, regardless of amount.

### Q3 Resolution: When to log RATED_BUYIN
- **Primary path**: Automatic bridge from Finance on insert
- **Secondary path**: Manual telemetry-only for rated sub-threshold buy-ins

### Source Dimension
Add `source` column to distinguish provenance:
- `finance_bridge` - Automatic from Finance insert
- `manual_ops` - Manual telemetry logging (no Finance mutation)

---

## Workstream Details

### WS1: Add source column to table_buyin_telemetry

**Purpose**: Add provenance tracking to distinguish automatic vs manual telemetry entries.

**Migration**:
```sql
-- Add source column with default for existing rows
ALTER TABLE table_buyin_telemetry
ADD COLUMN source text NULL;

-- Backfill existing rows as manual (they were logged via RPC)
UPDATE table_buyin_telemetry SET source = 'manual_ops' WHERE source IS NULL;

-- Add constraint for valid values
ALTER TABLE table_buyin_telemetry
ADD CONSTRAINT chk_source_valid
CHECK (source IS NULL OR source IN ('finance_bridge', 'manual_ops'));

-- Update comment
COMMENT ON COLUMN table_buyin_telemetry.source IS
  'Provenance: finance_bridge (automatic from player_financial_transaction) or manual_ops (direct RPC call)';
-- Idempotency: enforce uniqueness per casino when an idempotency_key is provided
-- NOTE: requires table_buyin_telemetry.idempotency_key to exist (add it if missing).
CREATE UNIQUE INDEX IF NOT EXISTS ux_table_buyin_telemetry_casino_idempotency
  ON table_buyin_telemetry (casino_id, idempotency_key)
  WHERE idempotency_key IS NOT NULL;

```

**Deliverables**:
- [ ] Migration file with ALTER TABLE
- [ ] Backfill existing rows to 'manual_ops'
- [ ] Add partial unique index on (casino_id, idempotency_key) WHERE idempotency_key IS NOT NULL
- [ ] `npm run db:types` succeeds

---

### WS2: Finance-to-Telemetry Bridge Function

**Purpose**: Create the SECURITY DEFINER function that implements Guardrails G1-G5.

**Function Signature**:
```sql
CREATE OR REPLACE FUNCTION fn_bridge_finance_to_telemetry()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = pg_catalog, public
```

**Guardrails Implementation**:

```sql
-- G1: Context validation (FAIL-CLOSED)
v_context_casino_id := NULLIF(current_setting('app.casino_id', true), '')::uuid;
v_context_actor_id  := NULLIF(current_setting('app.actor_id', true), '')::uuid;

IF v_context_casino_id IS NULL OR v_context_actor_id IS NULL THEN
  RAISE EXCEPTION 'MISSING_CONTEXT: app.casino_id/app.actor_id must be set via set_rls_context_from_staff()'
    USING ERRCODE = 'P0001';
END IF;

v_casino_id := v_context_casino_id;
v_actor_id  := v_context_actor_id;

-- G2: Tenant invariant check (ALWAYS)
IF NEW.casino_id <> v_casino_id THEN
  RAISE EXCEPTION 'SECURITY_VIOLATION: Tenant mismatch in finance bridge. Context: %, Row: %',
    v_casino_id, NEW.casino_id
    USING ERRCODE = 'P0001';
END IF;

-- G3: Actor invariant check (if the column exists / is populated in Finance rows)
-- If NEW.created_by_staff_id is available and non-null, enforce it matches context.
IF NEW.created_by_staff_id IS NOT NULL AND NEW.created_by_staff_id <> v_actor_id THEN
  RAISE EXCEPTION 'SECURITY_VIOLATION: Actor mismatch in finance bridge. Context: %, Row: %',
    v_actor_id, NEW.created_by_staff_id
    USING ERRCODE = 'P0001';
END IF;

-- G4: No spoofable parameters (function takes no params, all from NEW/context)

-- G5: Idempotency via unique key (requires partial unique index on (casino_id, idempotency_key) where not null) (requires partial unique index on (casino_id, idempotency_key) where not null)
v_idempotency_key := 'pft:' || NEW.id::text;
```

**Table Resolution** (via rating_slip JOIN):
```sql
-- Get table_id from rating_slip
SELECT rs.gaming_table_id INTO v_gaming_table_id
FROM rating_slip rs
WHERE rs.id = NEW.rating_slip_id;

IF v_gaming_table_id IS NULL THEN
  RAISE WARNING 'Bridge skipped: rating_slip % has no gaming_table_id', NEW.rating_slip_id;
  RETURN NEW;
END IF;

IF v_table_id IS NULL THEN
  -- Rating slip exists but has no table_id (should not happen per SRM)
  RAISE WARNING 'Bridge skipped: rating_slip % has no table_id', NEW.rating_slip_id;
  RETURN NEW;
END IF;
```

**Amount Conversion**:
```sql
-- Amount units must be verified against the canonical schema.
-- Preferred: keep cents end-to-end.
-- If Finance already stores cents (e.g., NEW.amount_cents bigint):
--   v_amount_cents := NEW.amount_cents;
-- Else if Finance stores dollars numeric (NEW.amount numeric):
--   v_amount_cents := ROUND(NEW.amount * 100)::bigint;
```

**Insert with Idempotency**:
```sql
INSERT INTO table_buyin_telemetry (
  casino_id, gaming_day, gaming_table_id, visit_id, rating_slip_id,
  amount_cents, telemetry_kind, tender_type, occurred_at,
  actor_id, source, idempotency_key
)
VALUES (
  v_casino_id,
  COALESCE(NEW.gaming_day, compute_gaming_day(v_casino_id, NEW.created_at)),
  v_table_id,
  NEW.visit_id,
  NEW.rating_slip_id,
  v_amount_cents,
  'RATED_BUYIN',
  NEW.tender_type,
  COALESCE(NEW.created_at, now()),
  v_actor_id,
  'finance_bridge',
  v_idempotency_key
)
ON CONFLICT (casino_id, idempotency_key) WHERE idempotency_key IS NOT NULL
DO NOTHING;
```

**Deliverables**:
- [ ] Migration file with function
- [ ] SECURITY DEFINER with proper grants
- [ ] All 5 guardrails implemented
- [ ] `npm run db:types` succeeds

---

### WS3: Attach Bridge Trigger to player_financial_transaction

**Purpose**: Wire the bridge function to fire on rated buy-in inserts.

**Migration**:
```sql
-- Create trigger for automatic bridging
CREATE TRIGGER trg_bridge_finance_to_telemetry
AFTER INSERT ON player_financial_transaction
FOR EACH ROW
WHEN (NEW.direction = 'in' AND NEW.rating_slip_id IS NOT NULL)
EXECUTE FUNCTION fn_bridge_finance_to_telemetry();

COMMENT ON TRIGGER trg_bridge_finance_to_telemetry ON player_financial_transaction IS
  'GAP-TBL-RUNDOWN: Automatic bridge from Finance to table_buyin_telemetry for rated buy-ins. '
  'Implements Guardrails G1-G5 per GAP_ANALYSIS v0.4.0.';
```

**Trigger Conditions**:
- `direction = 'in'` - Only buy-ins (not cash-outs)
- `rating_slip_id IS NOT NULL` - Only rated buy-ins (grind has no rating slip)

**Deliverables**:
- [ ] Migration file with trigger
- [ ] Trigger fires only for rated buy-ins
- [ ] `npm run db:types` succeeds

---

### WS4: Update rpc_log_table_buyin_telemetry with source parameter

**Purpose**: Allow manual telemetry calls to specify source for provenance tracking.

**ADR-024 Guardrail**: This RPC MUST NOT accept `casino_id` or `actor_id` params. Actor/tenant are derived from injected context (`set_rls_context_from_staff()` → `current_setting('app.*')`).

**Parameter Addition**:
```sql
CREATE OR REPLACE FUNCTION public.rpc_log_table_buyin_telemetry(
  p_table_id uuid,
  p_amount_cents bigint,
  p_telemetry_kind text,
  p_visit_id uuid DEFAULT NULL,
  p_rating_slip_id uuid DEFAULT NULL,
  p_tender_type text DEFAULT NULL,
  p_note text DEFAULT NULL,
  p_idempotency_key text DEFAULT NULL,
  p_source text DEFAULT 'manual_ops'  -- NEW PARAMETER
) RETURNS table_buyin_telemetry
```

**Validation Addition**:
```sql
-- Validate source parameter
IF p_source IS NOT NULL AND p_source NOT IN ('finance_bridge', 'manual_ops') THEN
  RAISE EXCEPTION 'INVALID_INPUT: source must be finance_bridge or manual_ops. Received: %',
    p_source
    USING ERRCODE = 'P0001';
END IF;
```

**Insert Update**:
```sql
INSERT INTO public.table_buyin_telemetry (
  ...,
  source  -- Add source column
) VALUES (
  ...,
  COALESCE(p_source, 'manual_ops')
);
```

**Deliverables**:
- [ ] Migration file with updated RPC
- [ ] Default to 'manual_ops' for backward compatibility
- [ ] Validation for valid source values
- [ ] `npm run db:types` succeeds

---

### WS5: Integration Tests for Bridge

**Purpose**: Validate the bridge works correctly with guardrails.

**Test Cases**:

1. **Happy path: Finance insert creates telemetry**
   ```typescript
   it('creates telemetry row when rated buy-in inserted', async () => {
     // Insert finance row with rating_slip_id
     // Verify table_buyin_telemetry row exists
     // Verify source = 'finance_bridge'
     // Verify amount_cents = amount * 100
   });
   ```

2. **Idempotency: Duplicate finance insert handled**
   ```typescript
   it('does not create duplicate telemetry for same finance row', async () => {
     // Insert finance row
     // Attempt to insert again (should conflict)
     // Verify only one telemetry row exists
   });
   ```

3. **Guardrail G2: Tenant mismatch rejected**
   ```typescript
   it('rejects tenant mismatch when context is set', async () => {
     // Set context to casino A
     // Insert finance row for casino B
     // Expect SECURITY_VIOLATION error
   });
   ```

4. **Non-rated buy-in skipped**
   ```typescript
   it('does not create telemetry for unrated buy-in', async () => {
     // Insert finance row WITHOUT rating_slip_id
     // Verify no telemetry row created
   });
   ```

5. **Cash-out skipped**
   ```typescript
   it('does not create telemetry for cash-out', async () => {
     // Insert finance row with direction='out'
     // Verify no telemetry row created
   });
   ```

6. **Manual RPC with source**
   ```typescript
   it('allows specifying source in manual RPC', async () => {
     // Call rpc_log_table_buyin_telemetry with p_source='manual_ops'
     // Verify source column set correctly
   });
   ```

**Test File Location**: `__tests__/services/table-context/finance-telemetry-bridge.int.test.ts`

**Deliverables**:
- [ ] Integration test file
- [ ] All test cases pass
- [ ] Coverage for guardrails G1-G5

---

## Definition of Done (from GAP v0.4.0)

- [ ] Automatic bridge exists (trigger) and passes Guardrails G1–G5
- [ ] Manual telemetry-only path exists for rated sub-threshold buy-ins
- [ ] `RATED_BUYIN` vs `GRIND_BUYIN` semantics enforced by constraints (existing)
- [ ] Shift dashboards show non-zero buy-in signals in realistic workflows
- [ ] Migration tests prove trigger compiles against canonical schema

## Quality Gates

| Gate | Command | Success Criteria |
|------|---------|------------------|
| schema-validation | `npm run db:types` | Exit 0, no errors |
| type-check | `npm run type-check` | Exit 0 |
| test-pass | `npm test finance-telemetry-bridge` | All tests pass |

## Cross-Context Boundary Notes

This spec creates a cross-context bridge:
- **Source**: `player_financial_transaction` (PlayerFinancialService)
- **Target**: `table_buyin_telemetry` (TableContext)

Per SRM v4.0.0 cross-context consumption rules:
> "MTLService | FinanceService | Reconciliation via triggers"

This pattern is explicitly allowed for reconciliation/replication scenarios.

## References

- **GAP Analysis**: `docs/00-vision/table-context-read-model/GAP_ANALYSIS_TABLE_RUNDOWN_INTEGRATION_REWRITE_v0.4.0.md`
- **Existing Telemetry Table**: `supabase/migrations/20260114003530_table_buyin_telemetry.sql`
- **Existing Telemetry RPC**: `supabase/migrations/20260114004141_rpc_log_table_buyin_telemetry.sql`
- **Finance RPC**: `supabase/migrations/20251231014359_adr024_financial_rpc_remediation.sql`
- **SRM**: `docs/20-architecture/SERVICE_RESPONSIBILITY_MATRIX.md`
- **ADR-024**: Context injection pattern
