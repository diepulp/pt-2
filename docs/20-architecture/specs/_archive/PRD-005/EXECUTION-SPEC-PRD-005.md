---
# EXECUTION-SPEC Frontmatter
# Generated by lead-architect skill
# Date: 2026-01-02

prd: PRD-005
prd_title: "MTL Service - AML/CTR Compliance Tracking"
service: MTLService
mvp_phase: 3  # Phase 3 (Compliance)
pattern: A  # Contract-First (Manual DTOs for compliance contracts)
http_boundary: true

# Workstream Definitions
# Executor Types: "skill" (Skill tool) or "task-agent" (Task tool with subagent_type)
workstreams:
  WS1:
    name: Database Layer
    description: Schema migration for MTL enums, columns, gaming_day_summary view, append-only enforcement (belt+suspenders), and RLS policies
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/20260102164655_prd005_mtl_service.sql
    gate: schema-validation
    estimated_complexity: high

  WS2:
    name: Service Layer DTOs & Schemas
    description: Pattern A manual DTOs, Zod schemas, selects, mappers for two-tier badge system
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - services/mtl/dtos.ts
      - services/mtl/schemas.ts
      - services/mtl/selects.ts
      - services/mtl/mappers.ts
    gate: type-check
    estimated_complexity: medium

  WS3:
    name: Service Layer Core
    description: Service factory, CRUD operations, HTTP fetchers, update view-model with aggregate badge logic
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - services/mtl/crud.ts
      - services/mtl/index.ts
      - services/mtl/http.ts
      - services/mtl/view-model.ts
    gate: type-check
    estimated_complexity: medium

  WS4:
    name: Route Handlers
    description: Wire existing scaffolded routes, add gaming-day-summary endpoint
    executor: api-builder
    executor_type: skill
    depends_on: [WS3]
    outputs:
      - app/api/v1/mtl/entries/route.ts
      - app/api/v1/mtl/entries/[entryId]/route.ts
      - app/api/v1/mtl/entries/[entryId]/audit-notes/route.ts
      - app/api/v1/mtl/gaming-day-summary/route.ts
    gate: lint
    estimated_complexity: medium

  WS5:
    name: React Query Hooks
    description: Query and mutation hooks for MTL entries, gaming-day-summary, and audit notes
    executor: frontend-design-pt-2
    executor_type: task-agent
    depends_on: [WS3, WS4]
    outputs:
      - hooks/mtl/index.ts
      - hooks/mtl/use-mtl-entries.ts
      - hooks/mtl/use-mtl-mutations.ts
      - hooks/mtl/use-gaming-day-summary.ts
    gate: type-check
    estimated_complexity: low

  WS6:
    name: Unit Tests
    description: Unit tests for mappers, entry badge logic, aggregate badge logic
    executor: e2e-testing
    executor_type: task-agent
    depends_on: [WS2, WS3]
    outputs:
      - services/mtl/__tests__/mappers.test.ts
      - services/mtl/__tests__/view-model.test.ts
    gate: test-pass
    estimated_complexity: medium

  WS7:
    name: RLS Policy Tests
    description: Integration tests for RLS policy enforcement, append-only verification
    executor: rls-expert
    executor_type: skill
    depends_on: [WS1, WS3]
    outputs:
      - lib/supabase/__tests__/rls-mtl.integration.test.ts
    gate: test-pass
    estimated_complexity: medium

  WS8:
    name: Route Handler Contract Tests
    description: Contract tests for all MTL API endpoints
    executor: e2e-testing
    executor_type: task-agent
    depends_on: [WS4]
    outputs:
      - app/api/v1/mtl/entries/__tests__/route.test.ts
      - app/api/v1/mtl/entries/[entryId]/__tests__/route.test.ts
      - app/api/v1/mtl/entries/[entryId]/audit-notes/__tests__/route.test.ts
      - app/api/v1/mtl/gaming-day-summary/__tests__/route.test.ts
    gate: test-pass
    estimated_complexity: medium

  WS9:
    name: UI Components - Badges & Entry List
    description: Entry badge, aggregate badge components, entry list table
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS5]
    outputs:
      - components/mtl/entry-badge.tsx
      - components/mtl/agg-badge.tsx
      - components/mtl/entry-list.tsx
    gate: type-check
    estimated_complexity: medium

  WS10:
    name: UI Components - Detail & Forms
    description: Entry detail view with audit trail, audit note creation form
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS9]
    outputs:
      - components/mtl/entry-detail.tsx
      - components/mtl/audit-note-form.tsx
    gate: type-check
    estimated_complexity: medium

  WS11:
    name: UI Components - Gaming Day Summary & Dashboard
    description: Gaming day summary table with aggregate badges, compliance dashboard page
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS9, WS10]
    outputs:
      - components/mtl/gaming-day-summary.tsx
      - app/(dashboard)/compliance/page.tsx
    gate: type-check
    estimated_complexity: high

  WS12:
    name: Quality Validation
    description: Final build validation, E2E smoke test (if applicable)
    executor: qa-specialist
    executor_type: skill
    depends_on: [WS8, WS11]
    outputs: []
    gate: build
    estimated_complexity: low

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Database Foundation
    parallel: [WS1]
    gates: [schema-validation]

  - name: Phase 2 - Service DTOs & Schemas
    parallel: [WS2]
    gates: [type-check]

  - name: Phase 3 - Service Core
    parallel: [WS3]
    gates: [type-check]

  - name: Phase 4 - API Layer
    parallel: [WS4]
    gates: [lint]

  - name: Phase 5 - Hooks & Backend Tests
    parallel: [WS5, WS6, WS7]
    gates: [type-check, test-pass]

  - name: Phase 6 - Route Tests & UI Foundation
    parallel: [WS8, WS9]
    gates: [test-pass, type-check]

  - name: Phase 7 - UI Detail & Forms
    parallel: [WS10]
    gates: [type-check]

  - name: Phase 8 - Dashboard & Final Validation
    parallel: [WS11, WS12]
    gates: [type-check, build]

# Validation Gates
gates:
  schema-validation:
    command: npm run db:types
    success_criteria: "Exit code 0, types regenerated with mtl_entry and mtl_audit_note"

  type-check:
    command: npx tsc --noEmit
    success_criteria: "Exit code 0, no TypeScript errors"

  lint:
    command: npm run lint
    success_criteria: "Exit code 0, no errors (warnings OK)"

  test-pass:
    command: npm test -- --testPathPattern="mtl|rls-mtl"
    success_criteria: "All tests pass"

  build:
    command: npm run build
    success_criteria: "Build completes without errors"

# Dependencies on other PRDs/Services
external_dependencies:
  - prd: PRD-000
    service: CasinoService
    required_for: "casino_settings.watchlist_floor, casino_settings.ctr_threshold, gaming_day computation"

  - prd: PRD-003
    service: PlayerService
    required_for: "patron_uuid FK validation"

  - prd: PRD-009
    service: PlayerFinancialService
    required_for: "Financial context (manual MTL entry creation for MVP)"

  - prd: ADR-015
    service: RLS Context
    required_for: "Pattern C (Hybrid) RLS with JWT claims"

  - prd: ADR-020
    service: Track A Hybrid RLS
    required_for: "MVP RLS architecture"

  - prd: ADR-024
    service: RLS context injection
    required_for: "set_rls_context_from_staff() for SECURITY DEFINER RPCs"

  - prd: ADR-025
    service: MTL Authorization Model
    required_for: "staff_role-based authorization (no service claims)"

# Risks and Mitigations
risks:
  - risk: "Existing view-model.ts uses >= for CTR threshold, PRD requires strictly >"
    mitigation: "WS3 will update deriveThresholdBadge to use strictly > per 31 CFR § 1021.311"

  - risk: "Append-only enforcement must use belt+suspenders approach (RLS + REVOKE + triggers)"
    mitigation: "WS1 migration implements all three layers per Appendix A of PRD-005"

  - risk: "Route handlers are scaffolded with TODOs, need complete rewrite"
    mitigation: "WS4 will wire routes to service layer; existing scaffolding provides validation schemas"

  - risk: "Gaming day boundary edge cases near midnight"
    mitigation: "Gaming day computed via trigger from casino_settings.gaming_day_start_time at insert time"

  - risk: "mtl_entry and mtl_audit_note tables may not exist in database"
    mitigation: "WS1 migration will CREATE OR ALTER tables as needed; check current schema state"
---

# EXECUTION-SPEC: PRD-005 - MTL Service (AML/CTR Compliance Tracking)

## Overview

Implement the MTLService (Monetary Transaction Log) for AML/CTR compliance tracking. This service provides an append-only ledger for cash transactions with two-tier threshold detection:
- **Tier 1 (Entry Badge)**: UX convenience showing per-transaction thresholds
- **Tier 2 (Aggregate Badge)**: Authoritative compliance trigger per 31 CFR § 1021.311

**Key Compliance Insight**: CTR obligation triggers when daily cash-in OR cash-out **exceeds** (strictly >) $10,000 per patron per gaming day. Cash-in and cash-out are tracked separately per FinCEN/IRS guidance.

## Scope

### In Scope (MVP)
- Log cash transactions with amount, direction, txn_type, source, patron, casino, staff
- Idempotent writes via casino-scoped `(casino_id, idempotency_key)` index
- Gaming day auto-computation via database trigger
- Two-tier threshold badge system (entry + aggregate)
- Gaming Day Summary view with per-direction aggregate badges
- Append-only enforcement (belt+suspenders: RLS + REVOKE + triggers)
- Audit notes (append-only, pit_boss/admin creation per ADR-025)
- Cursor-based pagination with `(created_at, id)` keyset
- Compliance dashboard UI

### Out of Scope
- SAR workflow automation (post-MVP)
- CTR form generation (post-MVP)
- Finance-to-MTL automatic streaming (post-MVP per ADR-016)
- Real-time threshold alerts
- Tax ID verification

## Architecture Context

### Pattern Selection
- **Pattern**: A (Contract-First)
- **HTTP Boundary**: Yes
- **Justification**: Compliance domain requires explicit, auditable contracts with precise threshold semantics

### Database Access
- **Strategy**: ADR-015 Pattern C (Hybrid Pooling + RLS context injection)
- **Append-Only**: Enforced via RLS absence + REVOKE privileges + BEFORE triggers

### Security Architecture (ADR-025 + ADR-024)
- **RBAC Source of Truth**: ADR-025 defines MTL authorization; SEC-003 v1.3.0 references it
- **Single Auth Axis**: MTL uses `staff_role` + `casino_id` scoping (no service claims for MVP)
- **RLS Context**: ADR-024 `set_rls_context_from_staff()` for SECURITY DEFINER RPCs
- **Ledger READ**: pit_boss, admin (cashier excluded)
- **Ledger WRITE**: pit_boss, cashier, admin (entry creation)
- **Audit Note WRITE**: pit_boss, admin (operational annotations)

### Current State (Gap Analysis)

| Component | Current State | Required State | Action |
|-----------|---------------|----------------|--------|
| `mtl_entry` table | May exist without txn_type/source | Full schema per Appendix A | ALTER or CREATE |
| `mtl_audit_note` table | May exist | With append-only triggers | ALTER or CREATE |
| `mtl_txn_type` enum | Missing | 5 values per PRD | CREATE TYPE |
| `mtl_source` enum | Missing | 4 values per PRD | CREATE TYPE |
| `mtl_gaming_day_summary` view | Missing | Aggregates per patron/day | CREATE VIEW |
| Idempotency index | May be player-scoped | Casino-scoped | DROP + CREATE |
| Append-only triggers | Missing | BEFORE UPDATE/DELETE | CREATE TRIGGER |
| `services/mtl/` | Partial (view-model, keys) | Full service layer | Complete implementation |
| Route handlers | Scaffolded with TODOs | Wired to service | Wire implementation |
| UI components | Missing | Full dashboard | Create all |

---

## Workstream Details

### WS1: Database Layer

**Purpose**: Create complete database schema for MTL with append-only enforcement.

**Deliverables**:
1. Migration file `20260102164655_prd005_mtl_service.sql`:
   - CREATE TYPE `mtl_txn_type` (buy_in, cash_out, marker, front_money, chip_fill)
   - CREATE TYPE `mtl_source` (table, cage, kiosk, other)
   - ALTER/CREATE TABLE `mtl_entry` with new columns
   - ALTER/CREATE TABLE `mtl_audit_note`
   - CREATE VIEW `mtl_gaming_day_summary`
   - CREATE UNIQUE INDEX for casino-scoped idempotency
   - CREATE indexes for query optimization
   - RLS policies per SEC-001 (SELECT, INSERT only; no UPDATE/DELETE)
   - REVOKE UPDATE, DELETE from authenticated/anon
   - CREATE triggers for append-only enforcement

**RLS Policy Matrix** (ADR-025 + ADR-024, amended for UX):

| Role | mtl_entry SELECT | mtl_entry INSERT | mtl_audit_note SELECT | mtl_audit_note INSERT |
|------|------------------|------------------|----------------------|----------------------|
| admin | casino_id match | casino_id match | via parent | casino_id match |
| pit_boss | casino_id match | casino_id match | via parent | casino_id match |
| cashier | casino_id match | casino_id match | DENY | DENY |
| dealer | DENY | DENY | DENY | DENY |

**ADR-025 Authorization Model** (amended):
- **Single Auth Axis**: MTL uses `staff_role` + `casino_id` (no service claims for MVP)
- **Ledger READ**: pit_boss, cashier, admin (cashier needs form UX visibility)
- **Ledger WRITE**: pit_boss, cashier, admin (entry creation for financial transactions)
- **Compliance Dashboard**: UI-gated to pit_boss, admin (Gaming Day Summary route)
- **Audit Note WRITE**: pit_boss, admin (operational annotations, not enterprise SoD)
- **ADR-024 Enforcement**: RPCs call `set_rls_context_from_staff()` and validate role allowlists

**Acceptance Criteria**:
- [ ] `npm run db:types` succeeds
- [ ] `mtl_entry` and `mtl_audit_note` appear in `database.types.ts`
- [ ] Enums `mtl_txn_type` and `mtl_source` generated
- [ ] `mtl_gaming_day_summary` view accessible
- [ ] UPDATE/DELETE blocked by RLS + privilege + trigger

---

### WS2: Service Layer DTOs & Schemas

**Purpose**: Create Pattern A manual DTOs and Zod validation schemas.

**Deliverables**:
1. `services/mtl/dtos.ts`:
   - Enums: `MtlTxnType`, `MtlSource`, `EntryBadge`, `AggBadge`
   - `MtlEntryDTO`, `MtlEntryWithNotesDTO`, `MtlAuditNoteDTO`
   - `MtlGamingDaySummaryDTO` with agg_badge_in/agg_badge_out
   - Input DTOs: `CreateMtlEntryInput`, `CreateMtlAuditNoteInput`
   - Filter DTOs: `MtlEntryFilters`, `MtlGamingDaySummaryFilters`

2. `services/mtl/schemas.ts`:
   - Zod schemas for all inputs/filters
   - Strict validation per PRD requirements

3. `services/mtl/selects.ts`:
   - Named column projections for queries

4. `services/mtl/mappers.ts`:
   - Row → DTO transformers
   - Badge computation integration

**Acceptance Criteria**:
- [ ] All DTOs match PRD Appendix B contracts (with `occurred_at` addition)
- [ ] `occurred_at` included in MtlEntryDTO (user-entered txn time vs server `created_at`)
- [ ] Zod schemas validate all required fields
- [ ] No `as any` casting
- [ ] TypeScript compiles without errors

---

### WS3: Service Layer Core

**Purpose**: Complete service factory and CRUD operations.

**Deliverables**:
1. `services/mtl/crud.ts`:
   - `createEntry()` - idempotent insert
   - `getEntryById()` - with audit notes
   - `listEntries()` - cursor pagination with filters
   - `createAuditNote()` - append-only
   - `getGamingDaySummary()` - aggregate view query

2. `services/mtl/index.ts`:
   - Service factory export

3. `services/mtl/http.ts`:
   - HTTP fetcher functions for client

4. `services/mtl/view-model.ts` (UPDATE):
   - Fix `deriveThresholdBadge` to use strictly `>` for CTR
   - Add `deriveAggBadge()` function
   - Add `enrichGamingDaySummary()` function

**Acceptance Criteria**:
- [ ] Service follows functional factory pattern
- [ ] No `ReturnType` inference (explicit interface)
- [ ] CTR threshold uses strictly `>` (not `>=`)
- [ ] Aggregate badges computed per direction

---

### WS4: Route Handlers

**Purpose**: Wire scaffolded routes and add gaming-day-summary endpoint.

**Deliverables**:
1. `POST /api/v1/mtl/entries` - Create entry (idempotent)
2. `GET /api/v1/mtl/entries` - List with filters
3. `GET /api/v1/mtl/entries/[entryId]` - Get with notes
4. `POST /api/v1/mtl/entries/[entryId]/audit-notes` - Add note (admin only)
5. `GET /api/v1/mtl/gaming-day-summary` - Gaming day aggregates **[NEW]**

**Role Enforcement** (ADR-025):
- Entry READ: pit_boss, admin (cashier excluded)
- Entry creation: pit_boss, cashier, admin
- Audit note creation: pit_boss, admin
- Gaming Day Summary: pit_boss, admin

**Acceptance Criteria**:
- [ ] All routes use `withServerAction` wrapper
- [ ] Role validation at route level
- [ ] Response format matches `ServiceHttpResult<T>`
- [ ] Idempotency returns existing entry on conflict

---

### WS5: React Query Hooks

**Purpose**: Client-side data fetching hooks.

**Deliverables**:
1. `hooks/mtl/use-mtl-entries.ts`:
   - `useMtlEntries(filters)` - list query
   - `useMtlEntry(id)` - single entry with notes

2. `hooks/mtl/use-mtl-mutations.ts`:
   - `useCreateMtlEntry()` - mutation
   - `useCreateAuditNote()` - mutation

3. `hooks/mtl/use-gaming-day-summary.ts`:
   - `useGamingDaySummary(filters)` - aggregate query

**Acceptance Criteria**:
- [ ] Hooks use key factories from keys.ts
- [ ] Mutations invalidate relevant queries
- [ ] TypeScript types explicit

---

### WS6: Unit Tests

**Purpose**: Test badge logic and mappers.

**Test Scenarios**:
- [ ] Entry badge: amount exactly at CTR threshold → `ctr_near` (not `ctr_met`)
- [ ] Entry badge: amount > CTR threshold → `ctr_met`
- [ ] Aggregate badge: daily total exactly at $10,000 → `agg_ctr_near`
- [ ] Aggregate badge: daily total at $10,001 → `agg_ctr_met`
- [ ] Separate in/out totals for aggregate badges

---

### WS7: RLS Policy Tests

**Purpose**: Verify RLS enforcement and append-only guarantees.

**Test Scenarios**:
- [ ] Pit boss can INSERT mtl_entry
- [ ] Pit boss CANNOT UPDATE mtl_entry
- [ ] Pit boss CANNOT DELETE mtl_entry
- [ ] Admin can INSERT mtl_audit_note
- [ ] Pit boss CANNOT INSERT mtl_audit_note
- [ ] Cross-casino access blocked
- [ ] BEFORE triggers block UPDATE/DELETE via service_role

---

### WS8: Route Handler Contract Tests

**Purpose**: API contract validation.

**Test Scenarios**:
- [ ] POST /entries with valid payload returns 201
- [ ] POST /entries with duplicate idempotency_key returns 200 with existing
- [ ] GET /entries returns paginated results
- [ ] GET /entries/[id] includes audit_notes
- [ ] POST /audit-notes requires compliance claim (SEC-003)
- [ ] GET /gaming-day-summary returns aggregate data

---

### WS9-11: UI Components

**Purpose**: Compliance dashboard UI.

**Component Structure**:
```
components/mtl/
├── entry-badge.tsx       # Tier 1 entry badge (UX)
├── agg-badge.tsx         # Tier 2 aggregate badge (COMPLIANCE)
├── entry-list.tsx        # Entry table with entry badges
├── entry-detail.tsx      # Detail view with audit trail
├── audit-note-form.tsx   # Note creation form
└── gaming-day-summary.tsx # Summary table with agg badges

app/(dashboard)/compliance/
└── page.tsx              # Dashboard with summary + list views
```

**UX Requirements**:
- Entry badges visually distinguish threshold levels
- Aggregate badges emphasize compliance authority
- Gaming Day Summary is primary compliance view
- Drill-down from summary to individual entries

---

## Definition of Done (MVP Ship Gates)

**You're done when ALL of these are true:**

### 1. RLS + Privileges Enforce the Matrix

**mtl_entry:**
- [ ] SELECT: pit_boss, admin ONLY (cashier excluded)
- [ ] INSERT: pit_boss, cashier, admin
- [ ] UPDATE: NOBODY (no policy exists)
- [ ] DELETE: NOBODY (no policy exists)

**mtl_audit_note:**
- [ ] SELECT: pit_boss, admin ONLY
- [ ] INSERT: pit_boss, admin ONLY
- [ ] UPDATE: NOBODY (no policy exists)
- [ ] DELETE: NOBODY (no policy exists)

**Casino Scoping:**
- [ ] Every policy checks `casino_id = app.casino_id` (ADR-024 context)

### 2. Append-Only is Real, Not Vibes

- [ ] No UPDATE/DELETE RLS policies exist on `mtl_entry`
- [ ] No UPDATE/DELETE RLS policies exist on `mtl_audit_note`
- [ ] `REVOKE UPDATE, DELETE ON mtl_entry FROM authenticated, anon`
- [ ] `REVOKE UPDATE, DELETE ON mtl_audit_note FROM authenticated, anon`
- [ ] BEFORE UPDATE/DELETE triggers raise exception (belt+suspenders)

### 3. UI Gating Matches the DB (No Lying UI)

- [ ] MTL read screens visible to: pit_boss, admin ONLY
- [ ] MTL entry creation visible to: pit_boss, cashier, admin
- [ ] Audit note form visible to: pit_boss, admin ONLY
- [ ] Roles without access see no MTL menu/routes

### 4. Tests (Small, Brutal, Effective)

**Minimum required tests:**
- [ ] cashier can INSERT mtl_entry
- [ ] cashier CANNOT SELECT mtl_entry
- [ ] pit_boss can SELECT + INSERT mtl_entry
- [ ] pit_boss can INSERT mtl_audit_note for same-casino entry
- [ ] admin can INSERT mtl_audit_note for same-casino entry
- [ ] ALL roles fail UPDATE mtl_entry
- [ ] ALL roles fail DELETE mtl_entry
- [ ] ALL roles fail UPDATE mtl_audit_note
- [ ] ALL roles fail DELETE mtl_audit_note
- [ ] Cross-casino access fails even for admin

### 5. Docs Stitched (No Drift)

- [ ] ADR-025 status: `Accepted`
- [ ] SEC-003 v1.3.0 includes MTL carve-out → ADR-025
- [ ] EXECUTION-SPEC role matrix matches ADR-025 exactly

### Functionality (Secondary)

- [ ] Entry creation stores all fields (amount, direction, txn_type, source, patron, casino, staff)
- [ ] Gaming day auto-computed via trigger
- [ ] Idempotency prevents duplicate entries
- [ ] Entry badges use strictly `>` for CTR (31 CFR § 1021.311)
- [ ] Aggregate badges computed per direction with strictly `>`
- [ ] Cursor pagination works correctly
- [ ] Gaming Day Summary returns aggregates with agg_badges

---

## Related Documents

| Document | Purpose |
|----------|---------|
| `docs/10-prd/PRD-005-mtl-service.md` | Product requirements |
| `docs/20-architecture/SERVICE_RESPONSIBILITY_MATRIX.md` | SRM v4.9.0 (MTL context) |
| `docs/30-security/SEC-001-rls-policy-matrix.md` | RLS patterns |
| `docs/30-security/SEC-003-rbac-matrix.md` | RBAC matrix (v1.3.0, references ADR-025) |
| `docs/80-adrs/ADR-015-rls-connection-pooling-strategy.md` | Pattern C (Hybrid) |
| `docs/80-adrs/ADR-020-track-a-hybrid-rls.md` | Track A Hybrid RLS |
| `docs/80-adrs/ADR-024_DECISIONS.md` | RLS context injection (`set_rls_context_from_staff()`) |
| `docs/80-adrs/ADR-025-mtl-authorization-model.md` | **AUTHORITATIVE**: MTL uses staff_role, not service claims |

### ADR-025 Authorization (AUTHORITATIVE)

ADR-025 defines MTL authorization using `staff_role` + `casino_id` scoping:

1. **Single Auth Axis**: No service claims for MVP; use `staff_role` enum
2. **Ledger READ**: pit_boss, admin only (cashier excluded)
3. **Ledger WRITE**: pit_boss, cashier, admin
4. **Audit Notes**: pit_boss, admin (operational, not SoD)
5. **Future SoD**: Add `compliance_officer` to `staff_role` enum if needed

### ADR-024 Context Injection

All MTLService RPCs must follow ADR-024:

1. **Context Injection**: SECURITY DEFINER RPCs call `set_rls_context_from_staff()`
2. **Role Allowlists**: Validate `staff_role` in function body
3. **Actor Attribution**: Use derived `app.actor_id`, never client-supplied
