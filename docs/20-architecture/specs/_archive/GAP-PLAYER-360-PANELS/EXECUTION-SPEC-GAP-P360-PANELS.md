---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline skill

prd: GAP-P360-PANELS
prd_title: "Player 360 Panels Backend Data Gaps"
service: Player360Dashboard
mvp_phase: 2  # Session Management

# Workstream Definitions
workstreams:
  WS1:
    name: Fix Engagement Status
    description: Query timeline for last activity timestamp instead of financial txn; update mapToEngagement() call
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - services/player360-dashboard/crud.ts
    gate: type-check
    estimated_complexity: medium

  WS2:
    name: Wire Compliance Panel
    description: Replace CompliancePlaceholder with CompliancePanel, wire useGamingDaySummary hook
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - app/(dashboard)/players/[playerId]/timeline/_components/timeline-content.tsx
    gate: type-check
    estimated_complexity: medium

  WS3:
    name: Fix Reward Cooldown
    description: Add loyalty_ledger query for most recent redemption timestamp
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - services/player360-dashboard/crud.ts
    gate: type-check
    estimated_complexity: low

  WS4:
    name: Create Recent Events Hook
    description: Create useRecentEvents hook wrapping getRecentEvents service, wire to UI
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - hooks/player-360/use-recent-events.ts
      - hooks/player-360/keys.ts
      - hooks/player-360/index.ts
      - app/(dashboard)/players/[playerId]/timeline/_components/timeline-content.tsx
    gate: type-check
    estimated_complexity: low

  WS5:
    name: Add Theo Estimate Calculation
    description: |
      Calculate theo from rating slips using lib/theo.ts. rating_slip has NO theo_win column.
      Must query: average_bet, accumulated_seconds, policy_snapshot.
      house_edge and decisions_per_hour live in policy_snapshot.loyalty (NOT game_settings).
      rpc_start_rating_slip snapshots these from the game_settings TABLE at slip creation.
      Use calculateTheoFromDuration() to compute theo per slip, then sum.
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - services/player360-dashboard/crud.ts
    gate: type-check
    estimated_complexity: high

  WS6:
    name: Unit Tests - Engagement & Cooldown
    description: Add unit tests for engagement status and reward cooldown logic
    executor: qa-specialist
    executor_type: skill
    depends_on: [WS1, WS3]
    outputs:
      - services/player360-dashboard/__tests__/crud.test.ts
    gate: test-pass
    estimated_complexity: medium

  WS7:
    name: Quality Validation
    description: Full validation suite - type-check, lint, test, build
    executor: qa-specialist
    executor_type: skill
    depends_on: [WS1, WS2, WS3, WS4, WS5, WS6]
    outputs: []
    gate: build
    estimated_complexity: low

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Backend Fixes (Parallel)
    parallel: [WS1, WS3, WS5]
    gates: [type-check]

  - name: Phase 2 - Frontend Wiring (Parallel)
    parallel: [WS2, WS4]
    gates: [type-check]

  - name: Phase 3 - Test Coverage
    parallel: [WS6]
    gates: [test-pass]

  - name: Phase 4 - Quality Validation
    parallel: [WS7]
    gates: [build]

# Validation Gates
gates:
  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0"

  test-pass:
    command: npm test -- --passWithNoTests
    success_criteria: "All tests pass"

  build:
    command: npm run build
    success_criteria: "Exit code 0, no build errors"

# External Dependencies
external_dependencies: []

# Deferred Workstreams
deferred:
  - name: Reward History Hook
    reason: Blocked on rewards pipeline implementation
    outputs:
      - hooks/player-360/use-reward-history.ts

# Risks and Mitigations
risks:
  - risk: "Timeline RPC may not return activity timestamps"
    mitigation: "Use existing rpc_get_player_timeline with limit=1, proven to work"
  - risk: "Casino ID context may be missing in Player 360"
    mitigation: "Derive from player record casino_id or session context"
  - risk: "rating_slip has NO theo_win column and NO house_edge/decisions_per_hour"
    mitigation: |
      house_edge and decisions_per_hour are snapshotted by rpc_start_rating_slip
      into rating_slip.policy_snapshot.loyalty (NOT game_settings).
      Query policy_snapshot column, extract .loyalty.house_edge and .loyalty.decisions_per_hour.
      Use calculateTheoFromDuration() from lib/theo.ts.
  - risk: "policy_snapshot may be null on old slips or non-loyalty slips"
    mitigation: "Nested type-guard on policy_snapshot.loyalty, fallback to 0 theo"
---

# EXECUTION-SPEC: GAP-P360-PANELS - Player 360 Panels Backend Data Gaps

## Overview

This spec addresses 7 backend data gaps in the Player 360 dashboard where service functions exist but aren't wired to the UI, or where critical calculations are stubbed with TODO comments.

**User-Reported Symptoms:**
1. Engagement status always shows "dormant" for actively playing players
2. Compliance/MTL panel shows placeholder text
3. Player financial data missing (theo estimate always 0)

**Impact**: Fixes critical UX bugs affecting pit supervisor workflow in Player 360 dashboard.

## Scope

**In Scope**:
- Fix engagement status to use actual player activity (not just financial txns)
- Wire compliance panel to existing `useGamingDaySummary` hook
- Implement reward cooldown detection via `loyalty_ledger` query
- Create `useRecentEvents` hook and wire to timeline strip
- Calculate theo estimate from `rating_slip.theo_win`

**Out of Scope**:
- Reward history hook (deferred - blocked on rewards pipeline)
- Financial trend comparison (low priority)
- New RPC creation (use existing RPCs where possible)

## Architecture Context

**Bounded Contexts Touched**:
- `Player360DashboardContext` - Aggregation layer (services/player360-dashboard/)
- `MtlContext` - Compliance data (hooks/mtl/)
- `LoyaltyContext` - Reward cooldown (loyalty_ledger table)

**Data Flow After Fix**:
```
getPlayerSummary():
├─ Query visit (existing)
├─ Query financial_transaction (existing)
├─ Query player_loyalty (existing)
├─ Query loyalty_ledger.redeem (NEW - cooldown)
├─ Query rating_slip.theo_win (NEW - theo estimate)
└─ Query timeline last_activity (NEW - engagement)

timeline-content.tsx:
├─ usePlayerSummary() → Fixed engagement status
├─ useGamingDaySummary() → Compliance panel (WIRED)
└─ useRecentEvents() → Recent events strip (NEW HOOK)
```

---

## Workstream Details

### WS1: Fix Engagement Status

**Purpose**: Make engagement status reflect actual player activity, not just financial transactions.

**Root Cause Analysis**:
- Current code uses `lastTxn?.created_at` (financial transaction timestamp)
- Financial transactions are sparse during active play (e.g., single buy-in)
- Player with rating activity 5 min ago shows "dormant" because buy-in was 20 min ago

**Implementation**:

1. Add timeline query for last activity in `getPlayerSummary()`:
```typescript
// In Promise.all(), add:
supabase.rpc('rpc_get_player_timeline', {
  p_player_id: playerId,
  p_event_types: null,  // All event types
  p_limit: 1,
}).maybeSingle()
```

2. Extract last activity timestamp:
```typescript
const lastActivityAt = timelineResult.data?.occurred_at ?? lastTxn?.created_at ?? null;
```

3. Pass to mapper:
```typescript
const engagement = mapToEngagement(activeVisit, lastActivityAt);
```

**Acceptance Criteria**:
- [ ] Player with rating event <15 min ago shows "active"
- [ ] Player with rating event 15-60 min ago shows "cooling"
- [ ] Player with no activity >60 min shows "dormant"

---

### WS2: Wire Compliance Panel

**Purpose**: Replace placeholder with functional `CompliancePanel` using existing MTL hooks.

**Implementation**:

1. Add imports:
```typescript
import { useGamingDaySummary } from '@/hooks/mtl';
import { CompliancePanel } from '@/components/player-360/compliance/panel';
```

2. Add hook call (need casinoId from player context):
```typescript
const { data: complianceData, isLoading: isComplianceLoading } = useGamingDaySummary({
  casinoId: playerCasinoId,
  gamingDay: getCurrentGamingDay(),
  patronId: playerId,
});
```

3. Transform DTO to panel props:
```typescript
const ctrStatus = complianceData?.items[0] ? {
  todayTotal: (complianceData.items[0].total_in ?? 0) + (complianceData.items[0].total_out ?? 0),
  threshold: 10000,
  isTriggered: complianceData.items[0].agg_badge_in === 'agg_ctr_met' ||
               complianceData.items[0].agg_badge_out === 'agg_ctr_met',
  isFiled: false, // TODO: Track CTR filing status
  gamingDay: complianceData.items[0].gaming_day,
} : null;
```

4. Replace `<CompliancePlaceholder />` with `<CompliancePanel />`:
```tsx
{activeRightTab === "compliance" && (
  <CompliancePanel
    ctrStatus={ctrStatus}
    mtlEntries={mtlEntries}
    isLoading={isComplianceLoading}
  />
)}
```

**Acceptance Criteria**:
- [ ] Compliance tab shows CTR progress bar
- [ ] CTR threshold badge appears at 80%+
- [ ] MTL entries appear in list (if data exists)

---

### WS3: Fix Reward Cooldown

**Purpose**: Implement reward cooldown detection by querying last redemption.

**Implementation**:

Add query in `getPlayerSummary()`:
```typescript
// Add to Promise.all():
supabase
  .from('loyalty_ledger')
  .select('created_at')
  .eq('player_id', playerId)
  .eq('reason', 'redeem')
  .order('created_at', { ascending: false })
  .limit(1)
  .maybeSingle()
```

Pass to mapper:
```typescript
const rewardsEligibility = mapToRewardsEligibility(
  loyaltyBalance,
  lastRedemption?.created_at ?? null,  // Was: null
);
```

**Acceptance Criteria**:
- [ ] Player with redemption <30 min ago shows "not_available" with cooldown time
- [ ] Player with redemption >30 min ago shows "available"
- [ ] Player with no redemptions shows "available"

---

### WS4: Create Recent Events Hook

**Purpose**: Create hook to fetch real recent events data.

**New File**: `hooks/player-360/use-recent-events.ts`

```typescript
'use client';

import { useQuery } from '@tanstack/react-query';
import { createBrowserClient } from '@/lib/supabase/client';
import { getRecentEvents } from '@/services/player360-dashboard/crud';
import { player360Keys } from './keys';

export function useRecentEvents(playerId: string) {
  const supabase = createBrowserClient();

  return useQuery({
    queryKey: player360Keys.recentEvents(playerId),
    queryFn: () => getRecentEvents(supabase, playerId),
    enabled: !!playerId,
    staleTime: 30_000,
  });
}
```

**Update**: `hooks/player-360/keys.ts`
```typescript
export const player360Keys = {
  // ... existing keys
  recentEvents: (playerId: string) => ['player360', 'recentEvents', playerId] as const,
};
```

**Update**: `timeline-content.tsx`
```typescript
// Replace mockRecentEvents with:
const { data: recentEvents, isLoading: isRecentEventsLoading } = useRecentEvents(playerId);

// Use recentEvents ?? defaultEmptyEvents in RecentEventsStrip
```

**Acceptance Criteria**:
- [ ] Hook fetches from `getRecentEvents()` service
- [ ] Recent events strip shows real last buy-in
- [ ] Loading state handled

---

### WS5: Add Theo Estimate Calculation

**Purpose**: Calculate theo estimate from rating slips for session value tile.

**IMPORTANT**: The `rating_slip` table does NOT have a `theo_win` column. Theo must be calculated at runtime using `lib/theo.ts`.

**Data Flow**:
```
game_settings TABLE (casino-level)
├── house_edge: 1.5
├── decisions_per_hour: 70
└── (snapshotted at slip creation by rpc_start_rating_slip)
        ↓
rating_slip.policy_snapshot (JSON, frozen per slip)
├── loyalty.house_edge: 1.5
├── loyalty.decisions_per_hour: 70
└── _source: { house_edge: "game_settings", ... }

rating_slip.game_settings (JSON) ← INPUT params only
├── min_bet: 25
├── max_bet: 500
└── game_type: "blackjack"
    (does NOT contain house_edge or decisions_per_hour)
```

**Data Requirements**:
- `average_bet` — from `rating_slip.average_bet`
- `accumulated_seconds` — from `rating_slip.accumulated_seconds`
- `house_edge` — from `rating_slip.policy_snapshot.loyalty.house_edge`
- `decisions_per_hour` — from `rating_slip.policy_snapshot.loyalty.decisions_per_hour`

**Implementation**:

1. Add import for theo calculator:
```typescript
import { calculateTheoFromDuration } from '@/lib/theo';
```

2. Add query in `getPlayerSummary()`:
```typescript
supabase
  .from('rating_slip')
  .select('average_bet, accumulated_seconds, policy_snapshot, status')
  .eq('visit_id', activeVisit.id)
  .in('status', ['open', 'paused'])
```

3. Type-guard `policy_snapshot.loyalty`:
```typescript
function extractTheoSettings(policySnapshot: Json) {
  // Navigate: policy_snapshot → .loyalty → { house_edge, decisions_per_hour }
  const ps = policySnapshot as Record<string, unknown>;
  const loyalty = ps?.loyalty as Record<string, unknown>;
  if (typeof loyalty?.house_edge !== 'number' ||
      typeof loyalty?.decisions_per_hour !== 'number') {
    return null;
  }
  return { house_edge: loyalty.house_edge, decisions_per_hour: loyalty.decisions_per_hour };
}
```

4. Calculate and sum:
```typescript
const theoEstimate = ratingSlips.reduce((sum, slip) => {
  const settings = extractTheoSettings(slip.policy_snapshot);
  if (!settings || !slip.average_bet || !slip.accumulated_seconds) return sum;
  return sum + calculateTheoFromDuration(settings, slip.average_bet, slip.accumulated_seconds / 60);
}, 0);
```

**Edge Cases**:
- No active visit → theoEstimate = 0
- Slip with null/missing policy_snapshot → skip slip (add 0)
- Slip with null average_bet → skip slip (add 0)
- Old slips created before policy_snapshot was populated → skip (add 0)

**Acceptance Criteria**:
- [ ] Theo reads from `policy_snapshot.loyalty`, NOT `game_settings`
- [ ] Calculated using `calculateTheoFromDuration()` from `lib/theo.ts`
- [ ] policy_snapshot JSON parsed safely with nested type guards
- [ ] Missing/malformed data handled gracefully (returns 0)
- [ ] Session value tile displays calculated theo value

---

### WS6: Unit Tests - Engagement & Cooldown

**Purpose**: Add test coverage for the new logic.

**Test Scenarios**:

**Engagement Status Tests**:
- Activity <15 min ago → "active"
- Activity 15-60 min ago → "cooling"
- Activity >60 min ago → "dormant"
- No activity, no visit → "dormant"
- Has visit, activity fallback to visit start

**Cooldown Tests**:
- Redemption <30 min ago → "not_available" with correct nextEligibleAt
- Redemption >30 min ago → "available"
- No redemption → "available"
- No loyalty record → "unknown"

**Acceptance Criteria**:
- [ ] All engagement status scenarios covered
- [ ] All cooldown scenarios covered
- [ ] Tests pass with `npm test`

---

### WS7: Quality Validation

**Validation Commands**:
```bash
npm run type-check     # TypeScript compilation
npm run lint           # ESLint validation
npm test               # All tests pass
npm run build          # Production build succeeds
```

**Acceptance Criteria**:
- [ ] All gates pass
- [ ] No regressions in existing tests
- [ ] Build completes successfully

---

## Definition of Done

### Backend Fixes
- [ ] Engagement status uses actual player activity timestamp
- [ ] Reward cooldown queries loyalty_ledger for last redemption
- [ ] Theo estimate calculated from rating_slip.theo_win

### Frontend Wiring
- [ ] Compliance panel wired to useGamingDaySummary
- [ ] Recent events hook created and wired
- [ ] Mock data replaced with real data

### Quality Gates
- [ ] `npm run type-check` passes
- [ ] `npm run lint` passes
- [ ] `npm test` passes
- [ ] `npm run build` passes

### Deferred
- [ ] Reward history hook (blocked on rewards pipeline)
- [ ] Financial trend comparison (low priority)
