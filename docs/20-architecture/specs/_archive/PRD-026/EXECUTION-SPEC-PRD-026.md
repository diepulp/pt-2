---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline skill (lead-architect scaffold + frontend-design-pt-2 expert refinement)

prd: PRD-026
prd_title: "Shift Dashboard v3: Three-Panel Layout & Statistical Model Readiness"
service: ShiftDashboard
mvp_phase: 2

workstreams:
  WS1:
    name: shadcn Chart Foundation
    description: Install shadcn chart component and apply Recharts v3 compatibility patch
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - components/ui/chart.tsx
    gate: type-check
    estimated_complexity: low

  WS2:
    name: Three-Panel Layout Structure
    description: Create ShiftDashboardLayout, ShiftLeftRail, ShiftCenterPanel, ShiftRightRail containers with sticky rails, responsive breakpoints, and expansion slots
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - components/shift-dashboard-v3/layout/shift-dashboard-layout.tsx
      - components/shift-dashboard-v3/layout/shift-left-rail.tsx
      - components/shift-dashboard-v3/layout/shift-center-panel.tsx
      - components/shift-dashboard-v3/layout/shift-right-rail.tsx
      - components/shift-dashboard-v3/layout/shift-dashboard-header.tsx
      - components/shift-dashboard-v3/layout/index.ts
    gate: type-check
    estimated_complexity: medium

  WS3:
    name: Left Rail Components
    description: HeroWinLossCompact, SecondaryKpiStack, QualitySummaryCard compact variants for sticky left rail
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - components/shift-dashboard-v3/left-rail/hero-win-loss-compact.tsx
      - components/shift-dashboard-v3/left-rail/secondary-kpi-stack.tsx
      - components/shift-dashboard-v3/left-rail/quality-summary-card.tsx
      - components/shift-dashboard-v3/left-rail/index.ts
    gate: type-check
    estimated_complexity: medium

  WS4:
    name: Floor Activity Radar Chart
    description: FloorActivityRadar replacing FloorActivityDonut with shadcn RadarChart, per-pit breakdown axes, casino-level fallback
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - components/shift-dashboard-v3/charts/floor-activity-radar.tsx
      - components/shift-dashboard-v3/charts/index.ts
    gate: type-check
    estimated_complexity: medium

  WS5:
    name: Win/Loss Trend Line Chart
    description: WinLossTrendChart using shadcn Line Chart with labeled data points, multi-series toggle for fills/credits
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - components/shift-dashboard-v3/charts/win-loss-trend-chart.tsx
    gate: type-check
    estimated_complexity: medium

  WS6:
    name: Right Rail Components
    description: TelemetryRailPanel, QualityDetailCard, RailCollapseToggle, CollapsedIconStrip for sticky right rail
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - components/shift-dashboard-v3/right-rail/telemetry-rail-panel.tsx
      - components/shift-dashboard-v3/right-rail/quality-detail-card.tsx
      - components/shift-dashboard-v3/right-rail/rail-collapse-toggle.tsx
      - components/shift-dashboard-v3/right-rail/collapsed-icon-strip.tsx
      - components/shift-dashboard-v3/right-rail/index.ts
    gate: type-check
    estimated_complexity: medium

  WS7:
    name: Page Integration & Wiring
    description: Assemble shift-dashboard-v3 page, wire existing BFF hooks to new layout, drill-down navigation, sticky header
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS3, WS4, WS5, WS6]
    outputs:
      - app/review/shift-dashboard-v3/page.tsx
      - app/review/shift-dashboard-v3/shift-dashboard-v3.tsx
      - components/shift-dashboard-v3/index.ts
    gate: build
    estimated_complexity: high

  WS8:
    name: Component Tests & Visual Regression
    description: Jest component tests for layout wrappers and chart components, Playwright visual regression at xl/lg/mobile breakpoints
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS7]
    outputs:
      - components/shift-dashboard-v3/__tests__/shift-dashboard-layout.test.tsx
      - components/shift-dashboard-v3/__tests__/floor-activity-radar.test.tsx
      - components/shift-dashboard-v3/__tests__/win-loss-trend-chart.test.tsx
      - e2e/workflows/shift-dashboard-v3-layout.spec.ts
    gate: test-pass
    estimated_complexity: medium

execution_phases:
  - name: "Phase 1 - Foundation"
    parallel: [WS1, WS2]
    gates: [type-check]

  - name: "Phase 2 - Components"
    parallel: [WS3, WS4, WS5, WS6]
    gates: [type-check]

  - name: "Phase 3 - Integration"
    parallel: [WS7]
    gates: [type-check, lint, build]

  - name: "Phase 4 - Testing & Validation"
    parallel: [WS8]
    gates: [test-pass, build]

gates:
  type-check:
    command: "npm run type-check"
    success_criteria: "Exit code 0"

  lint:
    command: "npm run lint"
    success_criteria: "Exit code 0, max-warnings=0"

  build:
    command: "npm run build"
    success_criteria: "Exit code 0"

  test-pass:
    command: "npm test components/shift-dashboard-v3/ && npx playwright test e2e/workflows/shift-dashboard-v3-layout.spec.ts"
    success_criteria: "All tests pass"

external_dependencies:
  - prd: PRD-Shift-Dashboards-v0.2
    service: ShiftDashboard BFF hooks
    required_for: "Existing hooks reused as-is (useShiftDashboardSummary, useCashObsSummary, useActiveVisitorsSummary)"
  - prd: PRD-023
    service: Player 360 Layout
    required_for: "Three-panel layout pattern reference (components/player-360/layout.tsx)"

risks:
  - risk: "Recharts v3 incompatibility with shadcn chart.tsx"
    mitigation: "Apply community v3 patch immediately after install; verified in production projects"
  - risk: "Left rail content exceeds above-fold budget"
    mitigation: "Compact card variants with strict height constraints; Floor Activity moved to center panel frees ~100px"
  - risk: "Sticky rail scroll jitter"
    mitigation: "Use position: sticky + align-self: flex-start (proven in Player 360 layout)"
---

# EXECUTION-SPEC: PRD-026 - Shift Dashboard v3

## Overview

Redesign the shift dashboard from a flat stacked grid (`app/review/shift-dashboard-v2/`) into a vertically scrollable three-panel surface with sticky side rails. This is a **UI-only** change -- no new data hooks, RPCs, API routes, or backend changes. All existing BFF hooks are reused as-is. Two new chart visualizations (Floor Activity Radar, Win/Loss Trend Line Chart) replace the custom SVG donut and add trend analysis.

## Scope

- **In Scope**: Three-panel layout, sticky rails, Floor Activity Radar, Win/Loss Trend Line Chart, shadcn chart installation, responsive breakpoints, expansion slots, component tests, Playwright visual regression
- **Out of Scope**: New API calls, backend changes, statistical model Phase 2+ computation, mobile-first redesign, print/export

## Architecture Context

- **Bounded Contexts**: Read-only from TableContextService, RatingSlipService, CasinoService
- **Pattern Reference**: Player 360 layout (`components/player-360/layout.tsx`) -- adapted for sticky-rail scrollable variant (NOT viewport-locked)
- **Data Layer**: Existing hooks from `hooks/shift-dashboard/` -- zero modifications
- **Chart Library**: recharts ^3.2.1 (already installed) + shadcn chart component (new)

## Workstream Details

### WS1: shadcn Chart Foundation

**Purpose**: Install the shadcn chart component and patch for Recharts v3 compatibility. This is a prerequisite for both chart workstreams (WS4, WS5).

**Deliverables**:
1. `components/ui/chart.tsx` installed via `npx shadcn@latest add chart`
2. Recharts v3 compatibility patch applied (v2 API references updated)

**Implementation**:
- Run `npx shadcn@latest add chart`
- Verify recharts is NOT duplicated in package.json (already ^3.2.1)
- Apply Recharts v3 patch: ensure ChartContainer works with v3 ResponsiveContainer API, tooltip/legend compatible with v3 payload format
- Reference: noxify/chart.tsx gist or shadcn PR #8486

**Acceptance Criteria**:
- [x] `components/ui/chart.tsx` exports: ChartContainer, ChartTooltip, ChartTooltipContent, ChartLegend, ChartLegendContent, ChartConfig type
- [x] `npm run type-check` passes with recharts v3 types
- [x] No recharts version conflicts in package-lock.json

### WS2: Three-Panel Layout Structure

**Purpose**: Create the structural container components that define the three-panel layout with sticky side rails and scrollable center.

**Deliverables**:
1. `ShiftDashboardLayout` - Root layout with context provider (collapse state)
2. `ShiftDashboardHeader` - Sticky header (position: sticky, top: 0, z-30)
3. `ShiftLeftRail` - Sticky left rail (w-72 xl:w-80, hidden <lg)
4. `ShiftCenterPanel` - Natural-flow center (flex-1, space-y-6)
5. `ShiftRightRail` - Sticky, collapsible right rail (w-80/w-12, hidden <xl)
6. Named expansion slot containers (`data-slot` attributes)

**Key Architectural Decisions**:
- **CRITICAL DIFFERENCE from Player 360**: Player 360 uses `overflow-hidden` on root (viewport-locked). Shift Dashboard v3 uses **native page scroll** -- root is NOT overflow-hidden. Rails use `position: sticky; top: 64px; align-self: flex-start`.
- Rails with content exceeding viewport: `max-h-[calc(100vh-64px)] overflow-y-auto`
- Right rail collapse: CSS `transition-all duration-200 ease-in-out` (proven in Player 360)
- Layout context: `ShiftDashboardLayoutContext` with `{ isRightRailCollapsed, toggleRightRail }`
- Context value memoized with `useMemo` (prevent consumer re-renders)

**Responsive Breakpoints**:

| Breakpoint | Left Rail | Center | Right Rail |
|------------|-----------|--------|------------|
| < lg (<1024px) | Hidden | Full width | Hidden |
| lg (1024-1279px) | Visible (w-72) | Flexible | Hidden |
| xl+ (>=1280px) | Visible (w-80) | Flexible | Visible (w-80, collapsible to w-12) |

**Expansion Slots**:
- `data-slot="utilization-timeline"` -- Center Panel (Phase 2)
- `data-slot="trending-charts"` -- Center Panel (Phase 3)
- `data-slot="theo-kpi"` -- Left Rail (Phase 5)
- `data-slot="theo-sidebar"` -- Right Rail (Phase 5)

**Acceptance Criteria**:
- [x] Three panels render at xl+ breakpoint
- [x] Rails use `position: sticky` (not fixed, not absolute)
- [x] Page scrolls natively -- no overflow-hidden on root container
- [x] Right rail collapses/expands with smooth animation
- [x] `npm run type-check` passes

### WS3: Left Rail Components

**Purpose**: Create compact variants of existing v2 KPI components for the sticky left rail, respecting the ~340px above-fold content budget.

**Deliverables**:
1. `HeroWinLossCompact` - Compact hero variant (~120px): text-3xl value, color accent bar, no trend indicator or secondary metrics row
2. `SecondaryKpiStack` - Vertical stack of 3 KPI cards (~180px): Fills, Credits, Est. Drop
3. `QualitySummaryCard` - Coverage percentage + grade distribution (~80px)

**Implementation**:
- Adapt from existing v2 components (reposition, not rewrite):
  - `HeroWinLossCard` -> stripped-down compact variant
  - `SecondaryKpisRow` -> change grid-cols-3 to grid-cols-1 for vertical layout
  - New `QualitySummaryCard` from quality data in summary hook
- Reuse `formatCurrency`, `getWinLossColor` from existing `lib/format.ts` and `lib/colors.ts`
- Same data props interface as v2 components (subset)
- Loading skeletons must match compact card dimensions exactly (CLS < 0.1)

**Data Sources** (no changes):
- `useShiftDashboardSummary()` -> `summary.casino` for win/loss, fills, credits, drop

**Acceptance Criteria**:
- [x] Left rail content fits within ~340px above fold at 1080p
- [x] All v2 data bindings preserved (same props interface)
- [x] No new API calls or hooks
- [x] `npm run type-check` passes

### WS4: Floor Activity Radar Chart

**Purpose**: Replace the custom SVG donut (`FloorActivityDonut`) with a shadcn Radar Chart that supports per-pit occupancy breakdown.

**Deliverables**:
1. `FloorActivityRadar` component using `ChartContainer` + recharts `RadarChart`, `Radar`, `PolarAngleAxis`, `PolarGrid`

**Data Model**:
```typescript
interface FloorActivityRadarProps {
  ratedCount: number;
  unratedCount: number;
  ratedPercentage?: number;
  isLoading?: boolean;
  pitBreakdown?: Array<{
    pitLabel: string;
    pitId: string;
    ratedCount: number;
    unratedCount: number;
  }>;
}
```

**Dual-Mode Rendering**:
- **With `pitBreakdown`**: Multi-axis radar -- one axis per pit, two overlaid polygons (rated: emerald/0.6 opacity, unrated: slate/0.3 opacity)
- **Without `pitBreakdown`** (fallback): Two-axis radar ["Rated", "Unrated"] single polygon

**Visual Requirements**:
- `PolarGrid gridType="circle"`, `ChartTooltip` with count + percentage, `ChartLegend` below
- `min-h-[200px]` on ChartContainer, Card wrapper (shadcn Card)
- Key insight callout preserved: "X% of floor generating value" (emerald accent box)
- Loading skeleton matching min-h-[200px]

**Data Source** (no changes): `useActiveVisitorsSummary()` -> `{ rated_count, unrated_count, rated_percentage }`

**Acceptance Criteria**:
- [x] Renders radar with pitBreakdown data (multi-axis)
- [x] Falls back to 2-axis radar without pitBreakdown
- [x] ChartTooltip shows on hover
- [x] "X% generating value" callout renders
- [x] No new API calls
- [x] `npm run type-check` passes

### WS5: Win/Loss Trend Line Chart

**Purpose**: Add a labeled line chart showing per-pit win/loss comparison with optional fills/credits series toggle.

**Deliverables**:
1. `WinLossTrendChart` component using `ChartContainer` + recharts `LineChart`, `Line`, `CartesianGrid`, `XAxis`, `LabelList`

**Data Model**:
```typescript
interface WinLossTrendChartProps {
  pitsData: ShiftPitMetricsDTO[] | undefined;
  isLoading?: boolean;
  visibleSeries?: Array<'winLoss' | 'fills' | 'credits'>;
}

type ChartDataPoint = {
  pitLabel: string;
  winLoss: number;  // cents -> dollars
  fills: number;
  credits: number;
};
```

**Visual Requirements**:
- `min-h-[250px]`, `CartesianGrid vertical={false}`, `XAxis` with pit labels
- No YAxis -- Label variant pattern (LabelList on dots provides values)
- Primary Line: `type="natural"`, `strokeWidth={2}`, labeled data points (LabelList position="top" offset={12})
- Series toggle: pill-style buttons in Card header `[Win/Loss active] [Fills] [Credits]`
- Multi-series with ChartLegend when >1 series active
- Dollar formatting via existing `formatCurrency()` from `lib/format.ts`
- Empty state: "Pit data unavailable for trend visualization" when <2 pits
- Loading skeleton: Card with min-h-[250px] and horizontal line placeholders

**Data Source** (no changes): `useShiftDashboardSummary()` -> `summary.pits` (ShiftPitMetricsDTO[])

**Acceptance Criteria**:
- [x] Renders labeled line chart with pitsData
- [x] Series toggle adds/removes Line components dynamically
- [x] LabelList shows formatted dollar values above dots
- [x] Empty state for <2 pits
- [x] formatCurrency reused from existing v2 lib
- [x] No new API calls
- [x] `npm run type-check` passes

### WS6: Right Rail Components

**Purpose**: Refactor the TelemetryDrawer from a collapsible drawer to a rail-native layout that's always visible when the right rail is expanded.

**Deliverables**:
1. `TelemetryRailPanel` - Rail-native refactor: casino totals (always shown), by-pit breakdown (collapsible), top 5 tables by observation count
2. `QualityDetailCard` - Per-quality-tier breakdown (GOOD/LOW/NONE counts)
3. `RailCollapseToggle` - Collapse/expand button
4. `CollapsedIconStrip` - w-12 vertical icon strip when collapsed (EyeIcon + ShieldCheckIcon)

**Implementation**:
- Preserve `TelemetryDrawerProps` data contract: `{ casinoData, pitsData, tablesData, isLoading }`
- Casino totals: 2-column grid (estimate, confirmed, count) -- same layout as v2 but without toggle
- By-pit: Collapsible accordion within rail (local state, not context)
- Top tables: Sorted by observation count, slice(0,5), same row format as v2
- Amber telemetry styling preserved: `border-dashed border-amber-500/30`, TELEMETRY badge
- Collapsed state: icon buttons that each call `toggleRightRail()` from layout context

**Data Source** (no changes): `useCashObsSummary()` -> `cashObs.casino`, `cashObs.pits`, `cashObs.tables`

**Acceptance Criteria**:
- [x] Telemetry panel always visible when rail expanded
- [x] Icon strip shown when rail collapsed (w-12)
- [x] Collapse/expand toggles correctly via context
- [x] Amber TELEMETRY badge and styling preserved
- [x] No new API calls
- [x] `npm run type-check` passes

### WS7: Page Integration & Wiring

**Purpose**: Assemble the shift-dashboard-v3 page, wiring all new layout components to existing BFF hooks with identical query parameters.

**Deliverables**:
1. `app/review/shift-dashboard-v3/page.tsx` - Route entry point
2. `app/review/shift-dashboard-v3/shift-dashboard-v3.tsx` - Main orchestration component
3. `components/shift-dashboard-v3/index.ts` - Top-level barrel export

**Hook Wiring** (identical to v2):
- `useShiftDashboardSummary({ window })` -> `summary.casino`, `summary.pits`, `summary.tables`
- `useCashObsSummary({ window })` -> `cashObs.casino`, `cashObs.pits`, `cashObs.tables`, `cashObs.alerts`
- `useActiveVisitorsSummary()` -> `visitorsSummary.rated_count`, `.unrated_count`, `.rated_percentage`

**Component Wiring**:
- Left Rail: `HeroWinLossCompact(summary.casino)`, `SecondaryKpiStack(summary.casino)`, `QualitySummaryCard(quality)`
- Center: `FloorActivityRadar(visitorsSummary)`, `WinLossTrendChart(summary.pits)`, `MetricsTable(summary)`, `AlertsStrip(cashObs.alerts)`, expansion slots
- Right Rail: `TelemetryRailPanel(cashObs)`, `QualityDetailCard(quality)`, expansion slots
- Header: title, `TimeWindowSelector`, last-updated indicator, loading spinner

**Key Requirements**:
- Drill-down (casino -> pit -> table) updates center panel only; rails remain stable (FR-5)
- Time window initialization via useEffect for SSR/client Date mismatch (same v2 pattern)
- Loading: all three panels show skeletons simultaneously
- CLS < 0.1 during data loading transitions

**Acceptance Criteria**:
- [x] All existing BFF hooks consumed with identical query parameters
- [x] No new API calls introduced
- [x] All v2 component data bindings preserved
- [x] Drill-down works without rail reflow
- [x] `npm run build` passes

### WS8: Component Tests & Visual Regression

**Purpose**: Verify layout structure, chart rendering, and responsive behavior through component tests and Playwright visual regression.

**Deliverables (Jest + RTL)**:
1. `components/shift-dashboard-v3/__tests__/shift-dashboard-layout.test.tsx` - Layout structure tests
2. `components/shift-dashboard-v3/__tests__/floor-activity-radar.test.tsx` - Radar chart tests (with/without pitBreakdown)
3. `components/shift-dashboard-v3/__tests__/win-loss-trend-chart.test.tsx` - Line chart tests (empty state, series toggle)

**Deliverables (Playwright)**:
4. `e2e/workflows/shift-dashboard-v3-layout.spec.ts` - Visual regression at xl/lg/mobile

**Component Test Coverage**:
- ShiftDashboardLayout renders three panels at xl
- ShiftRightRail collapse/expand toggle works
- FloorActivityRadar renders with and without pitBreakdown
- WinLossTrendChart renders with pitsData, handles empty state
- WinLossTrendChart series toggle adds/removes lines

**Playwright Scenarios**:
- Viewports: 1440x900 (xl), 1100x900 (lg), 375x812 (mobile)
- xl: verify three panels visible, sticky header
- lg: verify left rail + center, no right rail
- mobile: verify single column stacked layout
- Scroll: scroll 800px, verify rails stay anchored (getBoundingClientRect)
- Collapse: click toggle, verify width transition to w-12
- CLS: PerformanceObserver measurement < 0.1

**Acceptance Criteria**:
- [x] `npm test components/shift-dashboard-v3/` -- all tests pass
- [x] `npx playwright test e2e/workflows/shift-dashboard-v3-layout.spec.ts` -- all tests pass
- [x] CLS < 0.1 verified at xl breakpoint

## Definition of Done

- [x] All 8 workstreams complete
- [x] All gates pass (type-check, lint, build, test-pass)
- [x] No regressions in existing tests
- [x] No new API calls introduced (UI-only change verified)
- [x] Three-panel layout renders correctly at xl/lg/mobile breakpoints
- [x] Sticky rails anchored during scroll without jitter
- [x] Floor Activity Radar + Win/Loss Trend Chart render with existing hook data
- [x] Right rail collapses/expands with smooth animation
- [x] CLS < 0.1 during loading transitions
- [x] `components/ui/chart.tsx` passes type-check with recharts v3
