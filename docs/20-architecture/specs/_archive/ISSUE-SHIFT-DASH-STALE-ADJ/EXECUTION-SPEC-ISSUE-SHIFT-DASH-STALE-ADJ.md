---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline skill (lead-architect scaffold + expert refinement)

prd: ISSUE-SHIFT-DASH-STALE-ADJ
prd_title: "Shift Dashboard Telemetry Pipeline — Stale Data, 100x Inflation, Adjustment Blackout"
service: TableContextService (shift-metrics) + PlayerFinancialService
mvp_phase: 2

workstreams:
  WS1:
    name: Fix Bridge 100x Inflation
    description: >
      Remove erroneous *100 multiplication from bridge_rated_buyin_to_telemetry(),
      repair existing corrupted telemetry data, add ADR-031 invariant comment.
      P0 critical — all telemetry amounts are 100x inflated.
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/20260202123200_fix_bridge_100x_inflation.sql
    gate: schema-validation
    estimated_complexity: low

  WS2:
    name: Enable Adjustment Telemetry Flow
    description: >
      Relax telemetry constraints for negative amounts and RATED_ADJUSTMENT kind,
      inherit rating_slip_id in adjustment RPC, extend bridge trigger for
      adjustment path, update shift metrics RPC to include adjustments in
      drop aggregation. P1 — adjustments invisible to shift dashboard.
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - supabase/migrations/20260202123300_enable_adjustment_telemetry.sql
    gate: schema-validation
    estimated_complexity: medium

  WS3:
    name: Frontend Cache Invalidation
    description: >
      Add shiftDashboardKeys invalidation to useCreateFinancialAdjustment
      onSuccess callback. P1 — shift dashboard doesn't refresh after adjustments.
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - hooks/player-financial/use-financial-mutations.ts
    gate: type-check
    estimated_complexity: low

  WS4:
    name: Test Data & Documentation Consistency
    description: >
      Fix test mock invariant (buyins = rated + grind) and update contract
      documentation to reflect RATED_ADJUSTMENT inclusion.
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - components/shift-dashboard-v3/__tests__/win-loss-trend-chart.test.tsx
      - docs/25-api-data/SHIFT_METRICS_CONTRACT_v1.md
      - docs/25-api-data/SHIFT_READ_MODEL_AUDIT_v1.md
    gate: test-pass
    estimated_complexity: low

execution_phases:
  - name: "Phase 1 — P0 Critical Fix (100x Inflation)"
    parallel: [WS1]
    gates: [schema-validation]

  - name: "Phase 2 — P1 Adjustment Flow + Frontend"
    parallel: [WS2, WS3]
    gates: [schema-validation, type-check]

  - name: "Phase 3 — Consistency & Validation"
    parallel: [WS4]
    gates: [test-pass, build]

gates:
  schema-validation:
    command: npm run db:types
    success_criteria: "Exit code 0, types regenerated successfully"

  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0, no type errors"

  test-pass:
    command: npm run test -- components/shift-dashboard-v3/__tests__/win-loss-trend-chart.test.tsx
    success_criteria: "All tests pass"

  build:
    command: npm run build
    success_criteria: "Exit code 0, no build errors"

external_dependencies: []

risks:
  - risk: "WS2-C replaces the entire bridge function — must include WS1-A fix (no *100)"
    mitigation: "WS2 depends on WS1; WS2-C CREATE OR REPLACE includes corrected amount logic"
  - risk: "Data repair UPDATE (WS1-B) targets rows by source+idempotency_key prefix"
    mitigation: "Integer division is exact (original values were multiplied by 100)"
  - risk: "rpc_create_financial_adjustment accepts p_casino_id as parameter (ADR-024 gap)"
    mitigation: "Existing pattern — not introduced by this fix, tracked separately"

---

# EXECUTION-SPEC: ISSUE-SHIFT-DASH-STALE-ADJ — Shift Dashboard Telemetry Pipeline Fix

## Overview

Three independent bugs compound in the shift dashboard's telemetry pipeline:
1. **100x amount inflation** — bridge trigger multiplies `pft.amount` by 100, but column already stores cents (ADR-031)
2. **Adjustment blackout** — 5 compounding gaps prevent buy-in adjustments from reaching telemetry
3. **Grind correction gap** — deferred (out of scope, separate feature request)

## Scope

- **In Scope**: Fix 100x inflation, enable adjustment telemetry flow, frontend cache invalidation, test/doc consistency
- **Out of Scope**: Grind buy-in correction RPC, realtime subscriptions, cash-out adjustment telemetry, player timeline adjustment events

## Architecture Context

- **Bounded Contexts**: TableContextService (shift-metrics subdomain) owns `table_buyin_telemetry` and `rpc_shift_table_metrics`. PlayerFinancialService owns `player_financial_transaction` and `rpc_create_financial_adjustment`.
- **Cross-Context Bridge**: `bridge_rated_buyin_to_telemetry()` trigger fires on Finance INSERT, writes to Table Context telemetry. Existing pattern — no new cross-context writes.
- **ADR-031**: All financial amounts in CENTS. The bridge incorrectly assumed dollars.

## Workstream Details

### WS1: Fix Bridge 100x Inflation

**Priority**: P0 — all telemetry data is corrupted while this persists.
**Migration**: `supabase/migrations/20260202123200_fix_bridge_100x_inflation.sql`

**Sub-tasks**:

1. **WS1-A**: `CREATE OR REPLACE bridge_rated_buyin_to_telemetry()` — remove `* 100` from line 64, change to `COALESCE(NEW.amount, 0)::bigint` (amount is already cents per ADR-031)

2. **WS1-B**: Repair existing corrupted data:
   ```sql
   UPDATE table_buyin_telemetry
   SET amount_cents = amount_cents / 100
   WHERE source = 'finance_bridge'
     AND idempotency_key LIKE 'pft:%';
   ```
   Scoped to bridge-created rows only. Manual entries unaffected.

3. **WS1-C**: Add `COMMENT ON FUNCTION` documenting ADR-031 cents convention.

**Edge Cases**:
- Integer division is exact (values were multiplied by 100, no fractional loss)
- If new buy-ins are created between deploy and migration, they use the fixed function and are correct

**Acceptance Criteria**:
- [ ] `npm run db:types` succeeds
- [ ] `SELECT count(*) FROM table_buyin_telemetry WHERE source='finance_bridge' AND amount_cents > 50000000` returns 0
- [ ] Bridge function source no longer contains `* 100`

### WS2: Enable Adjustment Telemetry Flow

**Priority**: P1 — adjustments invisible to shift dashboard.
**Migration**: `supabase/migrations/20260202123300_enable_adjustment_telemetry.sql`
**All sub-tasks in single migration (atomic).**

**Sub-tasks**:

1. **WS2-A**: Relax telemetry constraints:
   - DROP `chk_amount_positive`, ADD `chk_amount_nonzero CHECK (amount_cents <> 0)`
   - DROP `chk_telemetry_kind`, ADD expanded CHECK including `'RATED_ADJUSTMENT'`
   - DROP `chk_rated_requires_linkage`, ADD expanded CHECK including `'RATED_ADJUSTMENT'` (requires visit_id + rating_slip_id)

2. **WS2-B**: `CREATE OR REPLACE rpc_create_financial_adjustment` to:
   - SELECT `rating_slip_id` from original transaction when `p_original_txn_id` is provided
   - Include `v_rating_slip_id` in the INSERT column list

3. **WS2-C**: `CREATE OR REPLACE bridge_rated_buyin_to_telemetry()` to handle adjustments:
   - If `NEW.txn_kind = 'adjustment' AND NEW.rating_slip_id IS NOT NULL` → `v_telemetry_kind := 'RATED_ADJUSTMENT'`
   - Elsif `NEW.direction = 'in' AND NEW.rating_slip_id IS NOT NULL` → `v_telemetry_kind := 'RATED_BUYIN'`
   - Else → RETURN NEW (skip)
   - Amount passes through as-is (already cents, can be negative)
   - **MUST include WS1-A fix** (no `* 100`)

4. **WS2-D**: `CREATE OR REPLACE rpc_shift_table_metrics` to update `telemetry_agg` CTE:
   - `rated_cents` FILTER: `WHERE tbt.telemetry_kind IN ('RATED_BUYIN', 'RATED_ADJUSTMENT')`
   - `total_cents`: unfiltered SUM already includes RATED_ADJUSTMENT
   - Update telemetry quality/notes logic to count RATED_ADJUSTMENT

**Edge Cases**:
- Adjustments without `p_original_txn_id` → no `rating_slip_id` → bridge skips (acceptable)
- `p_casino_id` parameter in RPC is existing ADR-024 gap (not fixed here)
- `chk_source_valid` constraint unchanged — 'finance_bridge' already valid

**Acceptance Criteria**:
- [ ] `npm run db:types` succeeds
- [ ] Insert adjustment via RPC → telemetry row with `kind='RATED_ADJUSTMENT'` exists
- [ ] `rpc_shift_table_metrics` returns reduced `estimated_drop_rated_cents` after negative adjustment
- [ ] Negative `amount_cents` accepted in telemetry

### WS3: Frontend Cache Invalidation

**Priority**: P1 — ensures dashboard refreshes immediately after adjustment.
**File**: `hooks/player-financial/use-financial-mutations.ts`

**Changes**:
```typescript
import { shiftDashboardKeys } from '@/hooks/shift-dashboard/keys';

// In useCreateFinancialAdjustment onSuccess, after existing invalidations:
queryClient.invalidateQueries({ queryKey: shiftDashboardKeys.summary.scope });
queryClient.invalidateQueries({ queryKey: shiftDashboardKeys.allMetrics() });
```

**Scope rationale**: `summary.scope` invalidates the BFF consolidated query. `allMetrics()` invalidates individual table/pit/casino metrics. Cash observation queries NOT invalidated (different data source — `pit_cash_observation` table, unaffected by financial adjustments).

**Acceptance Criteria**:
- [ ] `npm run type-check` passes
- [ ] `npm run lint` passes
- [ ] Import resolves correctly

### WS4: Test Data & Documentation Consistency

**Priority**: P2 — prevents regression.

**Sub-tasks**:

1. **WS4-A**: Fix mock at `win-loss-trend-chart.test.tsx:51`:
   ```typescript
   estimated_drop_buyins_total_cents: 250000, // Must equal rated (200000) + grind (50000)
   ```

2. **WS4-B**: Update `SHIFT_METRICS_CONTRACT_v1.md` §2 — note `estimated_drop_rated_cents` includes `RATED_ADJUSTMENT` rows (negative amounts reduce total)

3. **WS4-C**: Update `SHIFT_READ_MODEL_AUDIT_v1.md` — note superset invariant `buyins = rated + grind` holds because adjustments roll into rated

**Acceptance Criteria**:
- [ ] `npm run test -- components/shift-dashboard-v3/__tests__/win-loss-trend-chart.test.tsx` passes
- [ ] Mock data satisfies invariant: `buyins_total == rated_total + grind_total`

## Definition of Done

- [ ] All workstreams complete
- [ ] All gates pass (schema-validation, type-check, test-pass, build)
- [ ] No regressions in existing tests
- [ ] Bridge function correctly passes through cents without multiplication
- [ ] Existing corrupted telemetry data repaired
- [ ] Adjustments create RATED_ADJUSTMENT telemetry rows
- [ ] Shift dashboard refreshes after adjustment mutation
- [ ] Contract documentation updated
