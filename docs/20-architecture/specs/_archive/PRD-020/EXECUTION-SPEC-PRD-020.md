---
# EXECUTION-SPEC Frontmatter
# Generated by lead-architect skill

prd: PRD-020
prd_title: "Move Player Performance & UX Remediation"
service: RatingSlipModalService
mvp_phase: 3  # Phase 3 - UX Polish

# Workstream Definitions
workstreams:
  WS1:
    name: Modal Closure Fix
    description: Fix handleMovePlayer to close modal and clear state on success
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - components/pit-panels/pit-panels-client.tsx
    gate: type-check
    estimated_complexity: low

  WS2:
    name: Targeted Cache Invalidation
    description: Replace .scope invalidation with targeted activeSlips(tableId) keys
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - hooks/rating-slip-modal/use-move-player.ts
    gate: type-check
    estimated_complexity: medium

  WS3:
    name: Consolidated Move RPC
    description: Create rpc_move_player database function for single-transaction move
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/20251226182426_prd020_move_player_rpc.sql
    gate: schema-validation
    estimated_complexity: high

  WS4:
    name: Status Active Alias
    description: Add status=active to rating-slips endpoint for open+paused filtering
    executor: api-builder
    executor_type: skill
    depends_on: []
    outputs:
      - services/rating-slip/schemas.ts
      - services/rating-slip/crud.ts
      - app/api/v1/rating-slips/route.ts
    gate: type-check
    estimated_complexity: medium

  WS5:
    name: Enhanced Move Response & Service Integration
    description: Wire rpc_move_player response with seat arrays to API and client
    executor: api-builder
    executor_type: skill
    depends_on: [WS3]
    outputs:
      - services/rating-slip-modal/rpc.ts
      - services/rating-slip-modal/dtos.ts
      - services/rating-slip-modal/http.ts
      - app/api/v1/rating-slips/[id]/move/route.ts
    gate: type-check
    estimated_complexity: medium

  WS6:
    name: E2E Test Coverage
    description: Playwright tests for move player modal behavior and performance
    executor: e2e-testing
    executor_type: skill
    depends_on: [WS1, WS2, WS5]
    outputs:
      - e2e/workflows/move-player.spec.ts
    gate: test-pass
    estimated_complexity: medium

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Parallel Foundation (P0 + P1 Independent)
    parallel: [WS1, WS2, WS3, WS4]
    gates: [type-check, schema-validation]

  - name: Phase 2 - API Integration (P1)
    parallel: [WS5]
    gates: [type-check]

  - name: Phase 3 - E2E Validation
    parallel: [WS6]
    gates: [test-pass]

# Validation Gates
gates:
  schema-validation:
    command: npm run db:types
    success_criteria: "Exit code 0, types generate without error"

  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0, no TypeScript errors"

  test-pass:
    command: npx playwright test e2e/workflows/move-player.spec.ts
    success_criteria: "All E2E tests pass"

# Dependencies on other PRDs/Services
external_dependencies:
  - prd: PRD-008
    service: RatingSlipModalService
    required_for: "Base modal hooks and integration"
  - prd: PRD-018
    service: RatingSlipModalService
    required_for: "BFF RPC patterns for rpc_move_player"
  - prd: PRD-006
    service: DashboardService
    required_for: "Dashboard query keys (dashboardKeys)"

# Risks and Mitigations
risks:
  - risk: "Targeted invalidation may miss edge cases with multi-table moves"
    mitigation: "Test extensively with 3+ table scenarios"
  - risk: "rpc_move_player transaction may deadlock under concurrent moves"
    mitigation: "Use SELECT FOR UPDATE SKIP LOCKED pattern"
  - risk: "status=active backward compatibility"
    mitigation: "Additive change only, existing open/paused still work"
---

# EXECUTION-SPEC: PRD-020 - Move Player Performance & UX Remediation

## Overview

This EXECUTION-SPEC addresses critical UX and performance defects in the Move Player workflow identified through ISSUE-2CAC5C0B and validated by a multi-agent architecture audit. The implementation delivers:

1. **Immediate modal closure** after successful move (P0)
2. **Targeted cache invalidation** reducing HTTP requests by 80% (P0)
3. **Consolidated `rpc_move_player` RPC** reducing latency by 75% (P1)
4. **API enhancements** for future dashboard optimization (P1)

## Scope

**In Scope:**
- Modal closure fix in `handleMovePlayer()`
- Targeted query invalidation (source + destination tables only)
- `rpc_move_player` database function with transaction safety
- `status=active` alias for rating-slips endpoint
- Enhanced move response with seat state arrays
- E2E test coverage

**Out of Scope:**
- Dashboard BFF endpoint consolidation (future PRD-021)
- Batch table queries (`table_id=X,Y,Z`)
- Query key namespace unification
- Realtime direct cache updates

## Architecture Context

- **SRM**: RatingSlipModalService owns move operations
- **ADR-015**: RLS context injection pattern (single injection per RPC)
- **PRD-018**: BFF RPC pattern precedent for `rpc_get_rating_slip_modal_data`
- **PRD-008**: Base modal integration hooks

## Workstream Details

### WS1: Modal Closure Fix

**Purpose**: Fix the critical UX bug where modal stays open after successful move.

**Current Code** (`pit-panels-client.tsx:257-274`):
```typescript
const handleMovePlayer = async (formState: FormState) => {
  try {
    const result = await movePlayer.mutateAsync({...});
    setSelectedSlip(result.newSlipId);  // BUG: Should close modal
  } catch (error) {...}
};
```

**Deliverables**:
1. Add `closeModal()` call after successful move
2. Change `setSelectedSlip(result.newSlipId)` to `setSelectedSlip(null)`
3. Add `sourceTableId` parameter for targeted invalidation

**Acceptance Criteria**:
- [ ] Modal unmounts within 100ms of mutation success
- [ ] `selectedSlipId` is `null` after move
- [ ] No "No Data Available" dialog on manual close
- [ ] Error path keeps modal open with error displayed

### WS2: Targeted Cache Invalidation

**Purpose**: Reduce HTTP cascade from 12+ requests to max 4.

**Current Code** (`use-move-player.ts:148-185`):
```typescript
onSuccess: (data, variables) => {
  queryClient.invalidateQueries({ queryKey: ratingSlipModalKeys.scope });     // OVER-BROAD
  queryClient.invalidateQueries({ queryKey: dashboardKeys.tables.scope });    // OVER-BROAD
  queryClient.invalidateQueries({ queryKey: dashboardKeys.slips.scope });     // OVER-BROAD
  // ...
};
```

**Deliverables**:
1. Add `sourceTableId` and `casinoId` to `MovePlayerMutationInput`
2. Replace `.scope` with targeted `activeSlips(tableId)` for source + destination
3. Remove `ratingSlipModalKeys.scope` (modal is closing)
4. Keep `dashboardKeys.stats(casinoId)` for count refresh

**Acceptance Criteria**:
- [ ] Network tab shows max 4-5 requests after move
- [ ] Both source and destination tables update correctly
- [ ] Stats bar refreshes with new counts
- [ ] No stale data in table displays

### WS3: Consolidated Move RPC

**Purpose**: Reduce move latency from 1695ms to <400ms with single-transaction RPC.

**Deliverables**:
1. Migration with `rpc_move_player` function
2. Single RLS context injection (was 3x)
3. FOR UPDATE locking for transaction safety
4. JSONB response with seat state arrays

**Acceptance Criteria**:
- [ ] Move operation completes in <400ms
- [ ] Transaction rollback on any failure
- [ ] Correct seat state arrays returned
- [ ] RLS policies enforced

### WS4: Status Active Alias

**Purpose**: Enable single API call for open+paused slips.

**Deliverables**:
1. Update `ratingSlipListQuerySchema` to accept `active` status
2. Modify `listRatingSlips` to expand `active` → `['open', 'paused']`
3. Backward compatible with existing `status=open` or `status=paused`

**Acceptance Criteria**:
- [ ] `GET /api/v1/rating-slips?status=active` returns open and paused slips
- [ ] Existing `status=open` still works
- [ ] Existing `status=paused` still works

### WS5: Enhanced Move Response & Service Integration

**Purpose**: Wire the new RPC response format through the service layer.

**Deliverables**:
1. Update `MovePlayerResponse` type with seat arrays and newSlip summary
2. Wire `rpc_move_player` call in service layer
3. Update route handler to return enhanced response
4. Update client HTTP function for new response shape

**Acceptance Criteria**:
- [ ] Response includes `sourceTableSeats` array
- [ ] Response includes `destinationTableSeats` array
- [ ] Response includes `newSlip` summary object
- [ ] Client correctly parses enhanced response

### WS6: E2E Test Coverage

**Purpose**: Validate the complete move workflow in browser.

**Deliverables**:
1. Test: Move player closes modal immediately
2. Test: Move player updates table layout within 300ms
3. Test: Move player failure keeps modal open with error
4. Test: Network request count validation

**Acceptance Criteria**:
- [ ] All E2E tests pass
- [ ] Modal close timing verified
- [ ] Network request audit passes
- [ ] Error handling verified

## Definition of Done

- [ ] All 6 workstreams complete
- [ ] All gates pass (type-check, schema-validation, test-pass)
- [ ] Network requests reduced from 12+ to ≤4
- [ ] Move latency reduced from 1695ms to <400ms
- [ ] Modal closes immediately on success
- [ ] No console errors during move workflow
- [ ] MVP-ROADMAP.md updated
- [ ] MVPProgressContext records completion
