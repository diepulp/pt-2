---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline (lead-architect scaffold + expert refinements)
# Date: 2026-02-06

prd: ADR-033
prd_title: "Loyalty Reward Domain Model Scaffolding (MVP)"
service: LoyaltyService (reward sub-module)
mvp_phase: 3  # Rewards phase

# Workstream Definitions
workstreams:
  WS1:
    name: Database Schema, RLS & Seed Data
    description: >
      Create 6 new tables (reward_catalog, reward_price_points,
      reward_entitlement_tier, reward_limits, reward_eligibility,
      loyalty_earn_config), reward_family enum, indexes, unique constraints,
      RLS policies (from WS2), and seed data.
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/20260206005751_adr033_reward_catalog_schema.sql
    gate: schema-validation
    estimated_complexity: medium

  WS2:
    name: RLS Policy Design
    description: >
      Design casino-scoped RLS policies for all 6 new tables.
      Read: authenticated staff in casino. Write: admin/pitboss role-gated.
      ADR-015 Pattern C hybrid. This is a design-only consultation —
      output SQL is consumed by WS1 and written into the same migration file.
    executor: rls-expert
    executor_type: skill
    depends_on: []
    outputs:
      - "(consumed by WS1 — no separate file)"
    gate: schema-validation
    estimated_complexity: medium

  WS3:
    name: Reward Service Layer
    description: >
      Create reward sub-module at services/loyalty/reward/ following
      the existing promo/ sub-module pattern. Pattern A Contract-First DTOs.
      Functional factory. CRUD for catalog + supporting tables.
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - services/loyalty/reward/dtos.ts
      - services/loyalty/reward/schemas.ts
      - services/loyalty/reward/mappers.ts
      - services/loyalty/reward/selects.ts
      - services/loyalty/reward/crud.ts
      - services/loyalty/reward/keys.ts
      - services/loyalty/reward/http.ts
      - services/loyalty/reward/index.ts
    gate: type-check
    estimated_complexity: high

  WS4:
    name: Reward Route Handlers
    description: >
      API routes for reward catalog CRUD, earn config, and player eligibility.
      ServiceHttpResult contract. Casino context from auth.
    executor: api-builder
    executor_type: skill
    depends_on: [WS3]
    outputs:
      - app/api/v1/rewards/route.ts
      - app/api/v1/rewards/[id]/route.ts
      - app/api/v1/rewards/earn-config/route.ts
      - app/api/v1/rewards/eligible/route.ts
    gate: lint
    estimated_complexity: medium

  WS5:
    name: Tests
    description: >
      Unit tests for mappers, schemas, CRUD, and HTTP contract tests
      for the reward sub-module.
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS3, WS4]
    outputs:
      - services/loyalty/reward/__tests__/mappers.test.ts
      - services/loyalty/reward/__tests__/schemas.test.ts
      - services/loyalty/reward/__tests__/crud.test.ts
      - services/loyalty/reward/__tests__/http-contract.test.ts
    gate: test-pass
    estimated_complexity: medium

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: "Phase 1 - Foundation (Schema + RLS)"
    parallel: [WS1, WS2]
    gates: [schema-validation]

  - name: "Phase 2 - Service Layer"
    parallel: [WS3]
    gates: [type-check]

  - name: "Phase 3 - Route Handlers"
    parallel: [WS4]
    gates: [lint]

  - name: "Phase 4 - Tests"
    parallel: [WS5]
    gates: [test-pass]

# Validation Gates
gates:
  schema-validation:
    command: "npm run db:types"
    success_criteria: "Exit code 0, types regenerated successfully"

  type-check:
    command: "npm run type-check"
    success_criteria: "Exit code 0"

  lint:
    command: "npm run lint"
    success_criteria: "Exit code 0"

  test-pass:
    command: "npm test services/loyalty/reward/"
    success_criteria: "All tests pass"

# External Dependencies
external_dependencies:
  - dependency: "loyalty_outbox table recreation"
    status: "P0 - implementation underway separately"
    impact: "Entitlement issuance flow (Flow B) will fail without it, but catalog CRUD is independent"
    resolution: "Not blocking this pipeline - catalog/service/API work proceeds"

# Risks
risks:
  - risk: "Existing loyalty service imports may break with new sub-module"
    mitigation: "Sub-module pattern mirrors promo/ - no changes to parent index.ts exports"
  - risk: "Seed data may conflict with existing casino test data"
    mitigation: "Seed with INSERT ... ON CONFLICT (casino_id, code) DO NOTHING using stable codes. No random UUIDs for seed rows referenced by child table seeds."
  - risk: "benefit JSONB in reward_entitlement_tier is loosely typed"
    mitigation: "Zod runtime validation at service boundary; keep payloads small and documented"
---

# EXECUTION-SPEC: ADR-033 - Loyalty Reward Domain Model Scaffolding (MVP)

## Overview

Implement the reward catalog domain model for PT-2's loyalty system. This scaffolds the "what rewards exist" layer that unblocks operator workflows for issuing points comps and entitlements. Wires into existing issuance plumbing (loyalty ledger + promo coupons) without introducing a marketing engine.

## Scope

- **In Scope**: 6 new database tables, reward_family enum, RLS policies, service layer (CRUD), API routes, unit tests
- **Out of Scope**: Frontend UI surfaces (Issue Reward Drawer, Admin Catalog Manager, Rewards History Panel), loyalty_outbox recreation, campaign engine, per-game multipliers, retroactive recompute

## Architecture Context

- **Bounded Context**: Loyalty Domain (LoyaltyService) per SRM v4.11.0 §401-435
- **Sub-module Pattern**: `services/loyalty/reward/` mirrors existing `services/loyalty/promo/`
- **DTO Pattern**: Pattern A (Contract-First) — consistent with parent loyalty service
- **Security**: ADR-015 Pattern C hybrid + ADR-024 context derivation; NOT critical tables per ADR-030 D4
- **P0 Dependency**: `loyalty_outbox` recreation is underway separately and does not block catalog CRUD

## Workstream Details

### WS1: Database Schema, RLS & Seed Data

**Purpose**: Create the reward domain model schema with RLS policies in a single migration.

**Tables**:

| Table | PK | Key Constraints |
|-------|-----|-----------------|
| `reward_catalog` | `id uuid` | UNIQUE(casino_id, code), FK casino(id) |
| `reward_price_points` | `reward_id uuid` | 1:1 FK reward_catalog(id), points_cost >= 0 (zero = complimentary, no debit) |
| `reward_entitlement_tier` | `id uuid` | UNIQUE(casino_id, reward_id, tier), FK reward_catalog(id) |
| `reward_limits` | `id uuid` | FK reward_catalog(id), max_issues > 0 |
| `reward_eligibility` | `id uuid` | FK reward_catalog(id) |
| `loyalty_earn_config` | `casino_id uuid` | FK casino(id), upsert-friendly |

**New Enum**: `reward_family` ('points_comp' | 'entitlement')

**Indexes**:
- `reward_catalog (casino_id, is_active)`
- `reward_catalog (casino_id, code)` (covered by unique constraint)
- `reward_entitlement_tier (casino_id, reward_id, tier)` (covered by unique constraint)

**RLS Policies** (from WS2 expert consultation):
- All 6 tables: SELECT with Pattern C hybrid (authenticated staff in casino)
- reward_catalog, reward_price_points, reward_entitlement_tier, reward_limits, reward_eligibility: INSERT/UPDATE with pit_boss + admin role gating
- reward_catalog: DELETE with admin-only gating
- loyalty_earn_config: INSERT/UPDATE with admin-only gating, no DELETE policy

**Seed Data** (idempotent via `INSERT ... ON CONFLICT (casino_id, code) DO NOTHING`):
- 3 points comps: COMP_MEAL_25 (meal, 250pts), COMP_BEVERAGE_10 (beverage, 100pts), COMP_MISC_15 (misc, 150pts)
- 2 entitlements: MP_TIER_DAILY (match_play, per_gaming_day), FP_TIER_DAILY (free_play, per_gaming_day)
- Default earn config: points_per_theo=10, multiplier=1.0, rounding='floor' (via `ON CONFLICT (casino_id) DO NOTHING`)
- **Mechanism**: Use stable `code` values as conflict targets. No random UUIDs for seed parent rows. Child table seeds reference parent rows via subquery `(SELECT id FROM reward_catalog WHERE casino_id = X AND code = 'COMP_MEAL_25')`, not hardcoded UUIDs.

**Acceptance Criteria**:
- [ ] `npm run db:types` succeeds
- [ ] All 6 tables appear in `types/remote/database.types.ts`
- [ ] `reward_family` enum appears in `Database['public']['Enums']`
- [ ] All 6 tables have RLS enabled with Pattern C SELECT policies
- [ ] Write policies enforce role gating (pit_boss+admin for rewards, admin-only for earn config)
- [ ] Tables/enums: deterministic CREATE (fail on drift — no IF NOT EXISTS that masks wrong columns)
- [ ] Indexes/policies: idempotent via DROP IF EXISTS + recreate with stable names
- [ ] Seed INSERT statements use `ON CONFLICT ... DO NOTHING` with stable codes (no random UUIDs)
- [ ] Child table seeds reference parent rows via subquery, not hardcoded UUIDs
- [ ] Migration ends with `NOTIFY pgrst, 'reload schema'`

### WS2: RLS Policy Design

**Purpose**: Expert-designed RLS policies merged into WS1 migration.

**Policy Pattern**: ADR-015 Pattern C hybrid with role-gated writes.

**Role Matrix**:

| Table | SELECT | INSERT | UPDATE | DELETE |
|-------|--------|--------|--------|--------|
| reward_catalog | all staff | pit_boss, admin | pit_boss, admin | admin |
| reward_price_points | all staff | pit_boss, admin | pit_boss, admin | pit_boss, admin |
| reward_entitlement_tier | all staff | pit_boss, admin | pit_boss, admin | pit_boss, admin |
| reward_limits | all staff | pit_boss, admin | pit_boss, admin | pit_boss, admin |
| reward_eligibility | all staff | pit_boss, admin | pit_boss, admin | pit_boss, admin |
| loyalty_earn_config | all staff | admin | admin | (none) |

**DELETE Policy Note**: Hard deletion is allowed in MVP for admin hygiene (catalog cleanup during initial setup). Production policy may move to soft-delete (`is_active = false` / `archived_at`) once audit requirements are formalized.

**Naming Convention**: `{table_name}_{operation}` (e.g., `reward_catalog_select`)

**Implementation Tactic**: All policies use `DROP POLICY IF EXISTS {name} ON {table}; CREATE POLICY {name} ...;` so re-running migrations locally doesn't require manual cleanup.

**Security Notes**:
- These tables are NOT in the ADR-030 D4 critical table list, so Pattern C (COALESCE with JWT fallback) is acceptable for write policies
- All policies include `auth.uid() IS NOT NULL` — reward catalog reads and writes are staff-authenticated only; service-role bypass is not used (no admin scripts or background jobs operate on these tables)
- Role check uses session vars (NOT staff table subquery): `COALESCE(NULLIF(current_setting('app.staff_role', true), ''), (auth.jwt() -> 'app_metadata' ->> 'staff_role')) IN ('pit_boss', 'admin')`
- Casino scope: `COALESCE(NULLIF(current_setting('app.casino_id', true), '')::uuid, (auth.jwt() -> 'app_metadata' ->> 'casino_id')::uuid)`
- This matches the established pattern in `20260129193824_auth_hardening_write_rls_tightening.sql`

### WS3: Reward Service Layer

**Purpose**: Create the reward sub-module following `services/loyalty/promo/` patterns.

**Files** (8 total):

| File | Purpose |
|------|---------|
| `dtos.ts` | Pattern A Contract-First DTOs (RewardCatalogDTO, RewardDetailDTO, RewardPricePointsDTO, RewardEntitlementTierDTO, RewardLimitDTO, RewardEligibilityDTO, LoyaltyEarnConfigDTO, EligibleRewardDTO, CreateRewardInput, UpdateRewardInput, UpsertEarnConfigInput, RewardListQuery) |
| `schemas.ts` | Zod validation (createRewardSchema, updateRewardSchema, upsertEarnConfigSchema, rewardListQuerySchema, rewardRouteParamsSchema) |
| `mappers.ts` | Row -> DTO transformations with type guards (toRewardCatalogDTO, toRewardDetailDTO, toEarnConfigDTO, etc.) |
| `selects.ts` | SQL SELECT column sets for each table |
| `crud.ts` | Supabase CRUD operations (direct table queries, no RPCs needed for catalog) |
| `keys.ts` | React Query key factory (extend loyaltyKeys with reward-specific keys) |
| `http.ts` | ServiceHttpResult wrappers using lib/http/service-response.ts |
| `index.ts` | RewardService interface + createRewardService factory |

**Service Interface**:
```typescript
interface RewardService {
  listRewards(query?: RewardListQuery): Promise<RewardCatalogDTO[]>;
  getReward(id: string): Promise<RewardDetailDTO | null>;
  createReward(input: CreateRewardInput): Promise<RewardCatalogDTO>;
  updateReward(input: UpdateRewardInput): Promise<RewardCatalogDTO>;
  toggleRewardActive(id: string, isActive: boolean): Promise<RewardCatalogDTO>;
  getEarnConfig(): Promise<LoyaltyEarnConfigDTO | null>;
  upsertEarnConfig(input: UpsertEarnConfigInput): Promise<LoyaltyEarnConfigDTO>;
  listEligibleRewards(playerId: string): Promise<EligibleRewardDTO[]>; // reads: reward_catalog, reward_eligibility, reward_price_points, reward_entitlement_tier, player_loyalty (all Loyalty-owned per SRM §401-435)
}
```

**Acceptance Criteria**:
- [ ] `npm run type-check` succeeds
- [ ] No `as any` in any file
- [ ] No `console.*` in production code
- [ ] RewardService interface is explicit (not ReturnType)
- [ ] createRewardService is a functional factory
- [ ] All DTOs use camelCase
- [ ] eslint-disable comment for Pattern A manual DTOs

### WS4: Reward Route Handlers

**Purpose**: API routes for reward catalog CRUD and configuration.

**Routes**:

| Method | Path | Description | Auth |
|--------|------|-------------|------|
| GET | `/api/v1/rewards` | List catalog (family, kind, active, search filters) | any staff |
| POST | `/api/v1/rewards` | Create reward + child records | pit_boss/admin |
| GET | `/api/v1/rewards/[id]` | Get reward with full details | any staff |
| PATCH | `/api/v1/rewards/[id]` | Update reward | pit_boss/admin |
| GET | `/api/v1/rewards/earn-config` | Get casino earn config | any staff |
| PUT | `/api/v1/rewards/earn-config` | Upsert casino earn config | admin |
| GET | `/api/v1/rewards/eligible?playerId=X` | Player-eligible rewards (reads reward_catalog, reward_eligibility, reward_price_points, reward_entitlement_tier, player_loyalty — all Loyalty-owned per SRM) | any staff |

**Patterns**:
- `export const dynamic = 'force-dynamic'`
- `createRequestContext(request)` for tracing
- `requireIdempotencyKey(request)` for POST/PATCH/PUT (GET exempt; server requires presence of header, clients generate via `crypto.randomUUID()`)
- `withServerAction()` wrapper for all service calls
- Zod parse before service call
- Dynamic route params are async; follow current App Router contract in repo (`await segmentData.params`)
- Casino context derived via RLS middleware (no manual WHERE)

**Acceptance Criteria**:
- [ ] `npm run lint` succeeds
- [ ] All routes use withServerAction wrapper
- [ ] All write routes (POST/PATCH/PUT) enforce Idempotency-Key; GET routes are exempt
- [ ] All dynamic segment routes await async params per App Router contract
- [ ] No casino_id in request body or headers
- [ ] Response envelope is ServiceHttpResult<T>

### WS5: Tests

**Purpose**: Unit and HTTP contract tests for the reward sub-module.

**Test Files**:

| File | Coverage |
|------|----------|
| `mappers.test.ts` | 100% - all Row -> DTO transformations, null handling, type guards |
| `schemas.test.ts` | All Zod schemas: valid accept, invalid reject, coercion |
| `crud.test.ts` | 90%+ - CRUD operations with Supabase client doubles |
| `http-contract.test.ts` | All routes: success path, validation errors, idempotency |

**Acceptance Criteria**:
- [ ] `npm test services/loyalty/reward/` - all tests pass
- [ ] Coverage >= 90% for service layer
- [ ] Coverage 100% for mappers
- [ ] No test uses `as any`

## Definition of Done

- [ ] All 5 workstreams complete
- [ ] All gates pass (schema-validation, type-check, lint, test-pass)
- [ ] No regressions in existing tests (`npm test` full suite)
- [ ] ADR-024 compliance: no spoofable casino_id parameters
- [ ] ADR-015 compliance: Pattern C hybrid on all policies
- [ ] No `skipAuth` in production source files (ADR-030 INV-030-4)
- [ ] SRM updated with new tables owned by LoyaltyService
