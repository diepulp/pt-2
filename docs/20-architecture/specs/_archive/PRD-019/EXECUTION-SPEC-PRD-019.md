---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline

prd: PRD-019
prd_title: "Rating Slip Modal UX Refinements"
service: RatingSlipModal
mvp_phase: 3  # Phase 3 (UX Polish)

# Workstream Definitions
workstreams:
  WS1:
    name: Optimistic Seat Updates
    description: Implement useOptimistic for immediate seat position rendering on move player action
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - components/dashboard/pit-dashboard-client.tsx
      - store/pit-dashboard-store.ts
    gate: type-check
    estimated_complexity: medium

  WS2:
    name: Move Player No Auto-Open
    description: Remove auto-open of new slip modal on move player success
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - components/dashboard/pit-dashboard-client.tsx
    gate: type-check
    estimated_complexity: low

  WS3:
    name: Modal Close on Save
    description: Add modal close on successful Save Changes mutation
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - components/dashboard/pit-dashboard-client.tsx
      - hooks/rating-slip-modal/use-save-with-buyin.ts
    gate: type-check
    estimated_complexity: low

  WS4:
    name: Points Balance Refresh
    description: Add refresh button for loyalty points balance and wire session reward estimate
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - components/modals/rating-slip/rating-slip-modal.tsx
    gate: type-check
    estimated_complexity: medium

  WS5:
    name: Financial Summary Reactivity
    description: Bind Chips Taken input to Financial Summary card with derived state
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - components/modals/rating-slip/rating-slip-modal.tsx
    gate: type-check
    estimated_complexity: medium

  WS6:
    name: Start Time Controls
    description: Replace broken increment buttons with ad-hoc time picker component
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - components/modals/rating-slip/form-section-start-time.tsx
    gate: type-check
    estimated_complexity: medium

  WS7:
    name: E2E Test Coverage
    description: Add/update E2E tests for all five defect fixes
    executor: e2e-testing
    executor_type: skill
    depends_on: [WS1, WS2, WS3, WS4, WS5, WS6]
    outputs:
      - e2e/workflows/rating-slip-modal.spec.ts
    gate: test-pass
    estimated_complexity: medium

  WS8:
    name: Quality Validation
    description: Final build and type-check validation
    executor: qa-specialist
    executor_type: skill
    depends_on: [WS7]
    outputs: []
    gate: build
    estimated_complexity: low

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Foundation (Optimistic Updates)
    parallel: [WS1]
    gates: [type-check]

  - name: Phase 2 - UX Fixes (Parallelized)
    parallel: [WS2, WS3, WS4, WS5, WS6]
    gates: [type-check]

  - name: Phase 3 - E2E Tests
    parallel: [WS7]
    gates: [test-pass]

  - name: Phase 4 - Final Validation
    parallel: [WS8]
    gates: [build]

# Validation Gates
gates:
  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0, no TypeScript errors"

  test-pass:
    command: npx playwright test e2e/workflows/rating-slip-modal.spec.ts --reporter=list
    success_criteria: "All E2E tests pass"

  build:
    command: npm run build
    success_criteria: "Exit code 0, production build succeeds"

# Dependencies on other PRDs/Services
external_dependencies:
  - prd: PRD-008
    service: RatingSlipModalIntegration
    required_for: "Base modal implementation and BFF endpoint"
  - prd: PRD-004
    service: LoyaltyService
    required_for: "usePlayerLoyalty, useLoyaltySuggestion hooks"
  - prd: PRD-009
    service: PlayerFinancialService
    required_for: "Financial transaction recording"
  - prd: PRD-013
    service: ZustandStateManagement
    required_for: "Modal state management store"

# Risks and Mitigations
risks:
  - risk: "useOptimistic rollback complexity on mutation failure"
    mitigation: "Implement simple revert-on-error pattern, invalidate queries on error"
  - risk: "Time picker component may require new shadcn/ui dependency"
    mitigation: "Use existing date-time input with native datetime-local, or shadcn calendar + time picker"
  - risk: "Session reward RPC may return null for certain slip states"
    mitigation: "Handle gracefully with '--' display, only show for open slips"

---

# EXECUTION-SPEC: PRD-019 - Rating Slip Modal UX Refinements

## Overview

This PRD addresses five UX and functional defects in the rating slip modal discovered during integration testing:

1. **Move Player disrupts workflow** - Auto-opens new slip; needs optimistic seat updates
2. **Modal persistence after save** - Should close on successful save
3. **Static loyalty points** - Need refresh button and real-time session estimate
4. **Broken financial reactivity** - Chips Taken should update Financial Summary
5. **Faulty time controls** - Replace broken +15m buttons with ad-hoc time picker

All defects are frontend-focused. No schema changes or backend modifications required.

## Scope

**In Scope:**
- Optimistic seat updates using React 19 `useOptimistic`
- Remove auto-open of new slip on move player
- Modal close on successful save
- Loyalty points refresh button and session estimate display
- Reactive financial summary bound to Chips Taken form state
- Ad-hoc start time picker replacing broken increment buttons

**Out of Scope:**
- Modifying loyalty accrual calculation logic (LoyaltyService/PRD-004)
- Schema changes to financial tables (PRD-009)
- Full redesign of modal layout
- Performance optimization beyond optimistic updates

## Architecture Context

**Affected Bounded Contexts:**
- Rating Slip Modal (UI state, form handling)
- Pit Dashboard (seat display, table grid)

**Relevant ADRs:**
- ADR-003: Zustand State Management
- ADR-019: Loyalty Points Policy

**Key Files:**
- `components/dashboard/pit-dashboard-client.tsx` - Dashboard controller
- `components/modals/rating-slip/rating-slip-modal.tsx` - Main modal
- `components/modals/rating-slip/form-section-start-time.tsx` - Time controls
- `store/pit-dashboard-store.ts` - Dashboard UI state
- `hooks/rating-slip-modal/` - Modal hooks

## Workstream Details

### WS1: Optimistic Seat Updates

**Purpose:** Implement immediate seat position rendering on move player action using React 19 `useOptimistic`.

**Current State:**
- `handleMovePlayer` in `pit-dashboard-client.tsx` waits for mutation response
- Seat changes not visible until query refetch completes

**Deliverables:**
1. Add optimistic state for seats in `pit-dashboard-client.tsx` using `useOptimistic`
2. Update seat rendering to use optimistic state
3. Revert to previous state on mutation failure
4. Invalidate seat cache in background after success

**Acceptance Criteria:**
- [ ] Seat changes visible within 100ms of move action
- [ ] Optimistic updates revert on mutation failure
- [ ] No flash of stale data after mutation completes

**Files:**
- `components/dashboard/pit-dashboard-client.tsx`
- `store/pit-dashboard-store.ts` (if needed for optimistic actions)

---

### WS2: Move Player No Auto-Open

**Purpose:** Remove auto-open of new slip modal on move player success.

**Current State (Defect):**
```typescript
// pit-dashboard-client.tsx, handleMovePlayer
const result = await movePlayer.mutateAsync({...});
setSelectedSlip(result.newSlipId);  // <-- CAUSES AUTO-OPEN
```

**Deliverables:**
1. Remove `setSelectedSlip(result.newSlipId)` from success path
2. Keep existing modal open or close it (user decides via UI)
3. New slip accessible via clicking occupied seat on destination table

**Acceptance Criteria:**
- [ ] New slip does NOT auto-open on move
- [ ] User can manually click destination seat to open new slip
- [ ] Toast notification confirms move succeeded

**Files:**
- `components/dashboard/pit-dashboard-client.tsx`

---

### WS3: Modal Close on Save

**Purpose:** Close modal automatically on successful "Save Changes" mutation.

**Current State (Defect):**
- `useSaveWithBuyIn.mutate()` success callback only invalidates queries
- Modal remains open after save

**Deliverables:**
1. Add `closeModal()` call in `handleSave` success path
2. Keep modal open on mutation error (display error state)
3. Show success toast before closing

**Acceptance Criteria:**
- [ ] Modal closes on successful save
- [ ] Modal stays open on error with error banner
- [ ] Success toast displayed

**Files:**
- `components/dashboard/pit-dashboard-client.tsx`
- `hooks/rating-slip-modal/use-save-with-buyin.ts` (optional: add onSuccess callback support)

---

### WS4: Points Balance Refresh

**Purpose:** Add refresh button for loyalty points balance and wire session reward estimate.

**Current State (Defect):**
- Points balance displays from initial modal data (stale)
- Session reward estimate may show `+0` or null
- No refresh mechanism

**Deliverables:**
1. Add "Refresh" icon button next to points display in modal
2. Wire button to `refetch()` from `useRatingSlipModalData`
3. Show loading spinner during fetch
4. Verify session reward estimate displays from BFF data
5. Handle null response gracefully (`--` display)

**Acceptance Criteria:**
- [ ] Refresh button visible next to points display
- [ ] Click triggers data refetch with loading indicator
- [ ] Updated balance displays on success
- [ ] Error toast on failure (modal stays functional)
- [ ] Session reward shows actual value or `--` for null

**Files:**
- `components/modals/rating-slip/rating-slip-modal.tsx`

---

### WS5: Financial Summary Reactivity

**Purpose:** Bind Chips Taken input to Financial Summary card with derived state.

**Current State (Defect):**
```typescript
// rating-slip-modal.tsx
const totalChipsOut = modalData.financial.totalChipsOut / 100;  // <-- SERVER DATA ONLY
```

**Deliverables:**
1. Derive `computedChipsOut` from server data + form state:
   ```typescript
   const computedChipsOut = (modalData.financial.totalChipsOut + Number(formState.chipsTaken) * 100) / 100;
   ```
2. Derive `computedNetPosition` using computed chips out:
   ```typescript
   const computedNetPosition = modalData.financial.totalCashIn / 100 - computedChipsOut;
   ```
3. Update Financial Summary display to use computed values
4. No save required for display sync (reactive binding)

**Acceptance Criteria:**
- [ ] Chips Taken input changes immediately update Financial Summary
- [ ] Chips Out shows server value + pending chips taken
- [ ] Net Position recalculates based on computed chips out
- [ ] Values reset correctly when modal reopens

**Files:**
- `components/modals/rating-slip/rating-slip-modal.tsx`

---

### WS6: Start Time Controls

**Purpose:** Replace broken increment buttons with ad-hoc time picker component.

**Current State (Defect):**
- `+15m` button adds 1455 minutes instead of 15
- Time increment logic in Zustand store has date parsing issues

**Deliverables:**
1. Remove broken `+15m/-15m` increment buttons from `form-section-start-time.tsx`
2. Use native `datetime-local` input for direct time entry (already exists)
3. Add validation: time not in future, not before gaming day start
4. Optionally add preset buttons for common adjustments (rounded times)

**Acceptance Criteria:**
- [ ] No increment buttons that can cause calculation errors
- [ ] Direct datetime entry works correctly
- [ ] Validation prevents invalid times
- [ ] Time changes tracked for save mutation

**Files:**
- `components/modals/rating-slip/form-section-start-time.tsx`
- `store/rating-slip-modal-store.ts` (remove or fix adjustStartTime)

---

### WS7: E2E Test Coverage

**Purpose:** Add/update E2E tests for all five defect fixes.

**Test Scenarios:**
1. Move player shows seat update without modal auto-open
2. Save changes closes modal
3. Points refresh fetches current balance
4. Chips taken updates financial summary reactively
5. Start time picker allows ad-hoc adjustment

**Deliverables:**
1. Add/update tests in `e2e/workflows/rating-slip-modal.spec.ts`
2. Cover all five defects with explicit assertions
3. Verify optimistic state management works correctly

**Acceptance Criteria:**
- [ ] All E2E tests pass
- [ ] Tests cover happy path and error cases
- [ ] No flaky tests

**Files:**
- `e2e/workflows/rating-slip-modal.spec.ts`

---

### WS8: Quality Validation

**Purpose:** Final build and type-check validation.

**Deliverables:**
1. Run full type-check
2. Run production build
3. Verify no console errors
4. Check for React warnings

**Acceptance Criteria:**
- [ ] `npm run type-check` passes
- [ ] `npm run build` succeeds
- [ ] No new console errors
- [ ] No React warnings from state management changes

---

## Definition of Done

**Functionality:**
- [ ] Move player updates seats immediately via `useOptimistic`
- [ ] New slip does NOT auto-open on move
- [ ] Modal closes on successful "Save Changes"
- [ ] Points balance displays with working refresh button
- [ ] Session reward estimate displays from RPC (or `--` if null)
- [ ] Chips Taken input reactively updates Financial Summary
- [ ] Start time uses ad-hoc time picker (not broken increment buttons)

**Data & Integrity:**
- [ ] Optimistic updates revert correctly on mutation failure
- [ ] Points balance shows actual `player_loyalty.current_balance`
- [ ] Financial summary matches transaction state

**Testing:**
- [ ] E2E tests pass for all five defects
- [ ] No flaky tests

**Build:**
- [ ] Type-check passes
- [ ] Production build succeeds
