---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline skill
# Date: 2025-11-29

prd: PRD-003
prd_title: "Player & Visit Management"
services:
  - PlayerService
  - VisitService
mvp_phase: 1
priority: P0  # Critical path blocker

# Workstream Definitions
workstreams:
  WS1:
    name: Database Layer
    description: RLS policies and indexes for player, player_casino, visit tables
    agent: backend-service-builder
    depends_on: []
    outputs:
      - supabase/migrations/YYYYMMDDHHMMSS_prd003_player_visit_rls.sql
    gate: schema-validation
    estimated_complexity: medium
    notes: |
      Tables already exist (player, player_casino, visit).
      This workstream adds RLS policies and performance indexes only.

  WS2:
    name: PlayerService DTOs & Schemas
    description: DTO types and Zod schemas for player domain
    agent: backend-service-builder
    depends_on: [WS1]
    outputs:
      - services/player/dtos.ts
      - services/player/schemas.ts
    gate: type-check
    estimated_complexity: low

  WS3:
    name: VisitService DTOs & Schemas
    description: DTO types and Zod schemas for visit domain
    agent: backend-service-builder
    depends_on: [WS1]
    outputs:
      - services/visit/dtos.ts
      - services/visit/schemas.ts
    gate: type-check
    estimated_complexity: low

  WS4:
    name: PlayerService Implementation
    description: Service factory with search, CRUD, enrollment operations
    agent: backend-service-builder
    depends_on: [WS2]
    outputs:
      - services/player/index.ts
      - services/player/http.ts
    gate: type-check
    estimated_complexity: medium

  WS5:
    name: VisitService Implementation
    description: Service factory with check-in, check-out, active visit operations
    agent: backend-service-builder
    depends_on: [WS3]
    outputs:
      - services/visit/index.ts
      - services/visit/http.ts
    gate: type-check
    estimated_complexity: medium

  WS6:
    name: Player Route Handlers
    description: Replace stale stubs with withServerAction-compliant routes
    agent: api-builder
    depends_on: [WS4]
    outputs:
      - app/api/v1/players/route.ts (REPLACE)
      - app/api/v1/players/[playerId]/route.ts (REPLACE)
      - app/api/v1/players/[playerId]/enroll/route.ts (NEW)
      - app/api/v1/players/[playerId]/enrollment/route.ts (NEW)
    gate: lint
    estimated_complexity: medium
    notes: |
      Existing route stubs are STALE - missing withServerAction middleware.
      Must be completely rewritten following CasinoService pattern.

  WS7:
    name: Visit Route Handlers
    description: Replace stale stubs with withServerAction-compliant routes
    agent: api-builder
    depends_on: [WS5]
    outputs:
      - app/api/v1/visits/route.ts (REPLACE)
      - app/api/v1/visits/[visitId]/route.ts (REPLACE)
      - app/api/v1/visits/[visitId]/close/route.ts (NEW - replaces end/)
      - app/api/v1/visits/active/route.ts (NEW)
    gate: lint
    estimated_complexity: medium
    notes: |
      Existing route stubs are STALE - missing withServerAction middleware.
      Rename 'end' to 'close' per PRD-003 spec.
      Remove stale app/api/v1/visits/[visitId]/end/ directory.

  WS8:
    name: React Query Hooks
    description: Query and mutation hooks for player and visit operations
    agent: backend-service-builder
    depends_on: [WS4, WS5]
    outputs:
      - hooks/player/index.ts
      - hooks/player/use-player-search.ts
      - hooks/player/use-player.ts
      - hooks/player/use-player-mutations.ts
      - hooks/visit/index.ts
      - hooks/visit/use-visits.ts
      - hooks/visit/use-active-visit.ts
      - hooks/visit/use-visit-mutations.ts
    gate: type-check
    estimated_complexity: medium
    notes: |
      Keys files already exist (services/player/keys.ts, services/visit/keys.ts).
      Hooks should use existing key factories.

  WS9:
    name: Tests
    description: Unit and integration tests for services and routes
    agent: backend-service-builder
    depends_on: [WS4, WS5, WS6, WS7]
    outputs:
      - services/player/player.service.test.ts
      - services/player/player.integration.test.ts
      - services/visit/visit.service.test.ts
      - services/visit/visit.integration.test.ts
    gate: test-pass
    estimated_complexity: medium
    notes: |
      Existing services/player/player.test.ts tests server actions (STALE).
      New tests should test service factory pattern.

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Database Layer
    parallel: [WS1]
    gates: [schema-validation]

  - name: Phase 2 - DTOs & Schemas
    parallel: [WS2, WS3]
    gates: [type-check]

  - name: Phase 3 - Service Implementation
    parallel: [WS4, WS5]
    gates: [type-check]

  - name: Phase 4 - Route Handlers
    parallel: [WS6, WS7]
    gates: [lint]

  - name: Phase 5 - Hooks & Tests
    parallel: [WS8, WS9]
    gates: [type-check, test-pass]

# Validation Gates
gates:
  schema-validation:
    command: npm run db:types
    success_criteria: "Exit code 0, types regenerated without error"

  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0, no TypeScript errors"

  lint:
    command: npm run lint -- services/player/ services/visit/ app/api/v1/players/ app/api/v1/visits/
    success_criteria: "Exit code 0, no lint errors"

  test-pass:
    command: npm test -- services/player/ services/visit/
    success_criteria: "All tests pass"

# Dependencies on other PRDs/Services
external_dependencies:
  - prd: PRD-HZ-001
    service: withServerAction middleware
    status: COMPLETE
    required_for: "Route handler auth, RLS, audit, idempotency"

  - prd: PRD-000
    service: CasinoService
    status: COMPLETE
    required_for: "Casino context for enrollment and visit scoping"

# Pre-existing Assets
existing_assets:
  tables:
    - player (schema exists)
    - player_casino (schema exists)
    - visit (schema exists)
  keys:
    - services/player/keys.ts (query key factory)
    - services/visit/keys.ts (query key factory)
  stale_routes:
    - app/api/v1/players/route.ts (TO REPLACE)
    - app/api/v1/players/[playerId]/route.ts (TO REPLACE)
    - app/api/v1/visits/route.ts (TO REPLACE)
    - app/api/v1/visits/[visitId]/route.ts (TO REPLACE)
    - app/api/v1/visits/[visitId]/end/route.ts (TO DELETE)
  stale_tests:
    - services/player/player.test.ts (tests old server actions pattern)

# Cleanup Actions
cleanup:
  - action: delete
    path: app/api/v1/visits/[visitId]/end/
    reason: "Renamed to 'close' per PRD-003 spec"
  - action: delete
    path: app/api/v1/visits/[visitId]/rating-slips/
    reason: "Out of scope - belongs to RatingSlipService"

# Risks and Mitigations
risks:
  - risk: "Stale route handlers may have been imported elsewhere"
    mitigation: "Grep for imports before deletion, update any references"

  - risk: "Existing player.test.ts tests old pattern"
    mitigation: "Replace with new service factory tests, don't modify old file"

  - risk: "RLS policies may conflict with existing data"
    mitigation: "Test migration on local DB first with db:reset"

---

# EXECUTION-SPEC: PRD-003 - Player & Visit Management

## Overview

This PRD implements **PlayerService** and **VisitService**, the next critical path items per MVP-ROADMAP. These services provide player identity management and visit session lifecycle (check-in/check-out) required for RatingSlipService, LoyaltyService, and PitDashboard.

**Critical Path Position:**
```
CasinoService (COMPLETE) → PlayerService → VisitService → RatingSlipService E2E → PitDashboard
```

## Scope

### In Scope (MVP)
- Player CRUD with casino enrollment
- Player search (name-based, debounced)
- Visit lifecycle (check-in, check-out)
- Single active visit per player per casino constraint
- Idempotent mutations with proper error handling
- React Query hooks for UI integration

### Out of Scope
- Player photo/document upload
- Player merge/deduplication
- Visit auto-close scheduler
- Player suspension/ban management

## Architecture Context

- **SRM Reference**: §814-888 (Player/Visit bounded contexts)
- **Pattern**: Functional service factories (no classes)
- **DTOs**: Pattern B - Pick/Omit from Database types
- **Routes**: withServerAction middleware (PRD-HZ-001)
- **State**: React Query with key factories

## Workstream Details

### WS1: Database Layer

**Purpose**: Add RLS policies and performance indexes for player/visit tables.

**Deliverables**:
1. Migration file with RLS policies for `player`, `player_casino`, `visit`
2. Trigram index for player name search
3. Partial index for active visits

**Key RLS Policies**:
- `player`: Read only if enrolled in staff's casino
- `player_casino`: Scoped by `casino_id` from RLS context
- `visit`: Scoped by `casino_id` from RLS context

**Acceptance Criteria**:
- [ ] `npm run db:types` succeeds after migration
- [ ] RLS policies prevent cross-casino data access
- [ ] Indexes created for search performance

### WS2: PlayerService DTOs & Schemas

**Purpose**: Define type-safe DTOs and validation schemas.

**Deliverables**:
1. `services/player/dtos.ts` - PlayerDTO, PlayerEnrollmentDTO, PlayerSearchResultDTO
2. `services/player/schemas.ts` - Zod schemas for create, update, search

**Acceptance Criteria**:
- [ ] DTOs use Pattern B (Pick/Omit from Database types)
- [ ] Schemas match PRD-003 API contract
- [ ] No `any` types

### WS3: VisitService DTOs & Schemas

**Purpose**: Define type-safe DTOs and validation schemas.

**Deliverables**:
1. `services/visit/dtos.ts` - VisitDTO, ActiveVisitDTO
2. `services/visit/schemas.ts` - Zod schemas for create, list, close

**Acceptance Criteria**:
- [ ] DTOs use Pattern B (Pick/Omit from Database types)
- [ ] Schemas match PRD-003 API contract
- [ ] No `any` types

### WS4: PlayerService Implementation

**Purpose**: Implement player service factory with full CRUD and enrollment.

**Deliverables**:
1. `services/player/index.ts` - createPlayerService factory
2. `services/player/http.ts` - HTTP fetcher functions

**Operations**:
- `search(query, limit)` - Name-based search with enrollment status
- `getById(playerId)` - Get player details
- `create(data)` - Create new player
- `update(playerId, data)` - Update player profile
- `enroll(playerId)` - Enroll player in casino (from RLS context)
- `getEnrollment(playerId)` - Check enrollment status

**Acceptance Criteria**:
- [ ] Functional factory pattern (no classes)
- [ ] Explicit interface exported (no ReturnType inference)
- [ ] supabase typed as `SupabaseClient<Database>`

### WS5: VisitService Implementation

**Purpose**: Implement visit service factory with check-in/check-out lifecycle.

**Deliverables**:
1. `services/visit/index.ts` - createVisitService factory
2. `services/visit/http.ts` - HTTP fetcher functions

**Operations**:
- `list(filters)` - List visits with pagination
- `getById(visitId)` - Get visit details
- `getActiveForPlayer(playerId)` - Get active visit (if any)
- `startVisit(playerId)` - Check-in (idempotent - returns existing if active)
- `closeVisit(visitId)` - Check-out (sets ended_at)

**Acceptance Criteria**:
- [ ] Single active visit per player per casino enforced
- [ ] startVisit is idempotent (returns existing active visit)
- [ ] closeVisit sets ended_at timestamp

### WS6: Player Route Handlers

**Purpose**: Replace stale route stubs with compliant handlers.

**Routes**:
| Method | Path | Operation |
|--------|------|-----------|
| GET | `/api/v1/players` | List/search players |
| POST | `/api/v1/players` | Create player |
| GET | `/api/v1/players/[playerId]` | Get player detail |
| PATCH | `/api/v1/players/[playerId]` | Update player |
| POST | `/api/v1/players/[playerId]/enroll` | Enroll in casino |
| GET | `/api/v1/players/[playerId]/enrollment` | Check enrollment |

**Acceptance Criteria**:
- [ ] All routes use `withServerAction` wrapper
- [ ] Mutations require `Idempotency-Key` header
- [ ] Responses use `ServiceHttpResult<T>` envelope
- [ ] Domain errors (PLAYER_NOT_FOUND, etc.) properly mapped

### WS7: Visit Route Handlers

**Purpose**: Replace stale route stubs with compliant handlers.

**Routes**:
| Method | Path | Operation |
|--------|------|-----------|
| GET | `/api/v1/visits` | List visits |
| POST | `/api/v1/visits` | Start visit (check-in) |
| GET | `/api/v1/visits/[visitId]` | Get visit detail |
| PATCH | `/api/v1/visits/[visitId]/close` | Close visit (check-out) |
| GET | `/api/v1/visits/active` | Get active visit for player |

**Acceptance Criteria**:
- [ ] All routes use `withServerAction` wrapper
- [ ] Mutations require `Idempotency-Key` header
- [ ] Stale `end/` route deleted, replaced with `close/`
- [ ] Active visit query uses player_id from query param

### WS8: React Query Hooks

**Purpose**: Provide client-side data fetching with proper caching.

**Deliverables**:
1. `hooks/player/use-player-search.ts` - Debounced search hook
2. `hooks/player/use-player.ts` - Player detail query
3. `hooks/player/use-player-mutations.ts` - Create, update, enroll mutations
4. `hooks/visit/use-visits.ts` - Visit list query
5. `hooks/visit/use-active-visit.ts` - Active visit query
6. `hooks/visit/use-visit-mutations.ts` - Start, close mutations

**Acceptance Criteria**:
- [ ] Uses existing key factories from keys.ts
- [ ] Mutations invalidate relevant queries
- [ ] Search hook has 300ms debounce
- [ ] Proper staleTime configuration

### WS9: Tests

**Purpose**: Verify service and route correctness.

**Deliverables**:
1. Unit tests for service validation logic
2. Integration tests with real Supabase
3. RLS policy verification tests

**Acceptance Criteria**:
- [ ] Player search returns only enrolled players
- [ ] Enrollment creates player_casino record
- [ ] Check-in creates visit / returns existing
- [ ] Check-out sets ended_at
- [ ] Cross-casino access blocked by RLS

## Definition of Done

- [ ] All 9 workstreams complete
- [ ] All gates pass (schema-validation, type-check, lint, test-pass)
- [ ] Stale routes replaced, cleanup complete
- [ ] MVP-ROADMAP.md updated with PRD-003 status
- [ ] MVPProgressContext records PlayerService + VisitService completion
