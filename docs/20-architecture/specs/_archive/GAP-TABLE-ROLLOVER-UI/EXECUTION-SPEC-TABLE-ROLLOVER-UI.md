---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline skill

prd: GAP-TABLE-ROLLOVER-UI
prd_title: "Table Rollover UI Components"
service: TableContextService
mvp_phase: 2
bounded_context: TableContextService

# Workstream Definitions
workstreams:
  WS1:
    name: ChipCountCaptureDialog Component
    description: Modal dialog for capturing inventory snapshots with denomination grid
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - components/table/chip-count-capture-dialog.tsx
      - hooks/table-context/use-inventory-snapshots.ts
    gate: type-check
    estimated_complexity: medium

  WS2:
    name: Enhanced CloseSessionDialog
    description: Replace manual UUID entry with artifact pickers (dropdown + create)
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - components/table/close-session-dialog.tsx (update)
      - components/table/artifact-picker.tsx
    gate: type-check
    estimated_complexity: medium

  WS3:
    name: DropEventDialog Component
    description: Modal dialog for logging drop box events with custody chain
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - components/table/drop-event-dialog.tsx
      - hooks/table-context/use-drop-events.ts
    gate: type-check
    estimated_complexity: medium

  WS4:
    name: Live InventoryPanel Integration
    description: Replace mock data with real queries, add chip count action
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS1, WS3]
    outputs:
      - components/pit-panels/inventory-panel.tsx (update)
    gate: type-check
    estimated_complexity: medium

  WS5:
    name: GrindBuyinPanel Component
    description: Quick-tap interface for anonymous buy-in telemetry logging
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - components/table/grind-buyin-panel.tsx
      - hooks/table-context/use-buyin-telemetry.ts
    gate: type-check
    estimated_complexity: medium

  WS6:
    name: RundownSummaryPanel Component
    description: Win/loss display with computed totals from metrics RPC
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - components/table/rundown-summary-panel.tsx
    gate: type-check
    estimated_complexity: low

  WS7:
    name: Automatic Telemetry Bridge
    description: DB trigger to bridge rated buy-ins to telemetry table
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/YYYYMMDDHHMMSS_telemetry_bridge_trigger.sql
    gate: schema-validation
    estimated_complexity: low

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Enable Session Close (CRITICAL)
    parallel: [WS1, WS3]
    gates: [type-check]
    priority: critical

  - name: Phase 2 - Complete Session Close
    parallel: [WS2, WS4]
    gates: [type-check]
    priority: high

  - name: Phase 3 - Operational Completeness
    parallel: [WS5, WS6]
    gates: [type-check]
    priority: high

  - name: Phase 4 - Backend Pipeline
    parallel: [WS7]
    gates: [schema-validation]
    priority: critical

# Validation Gates
gates:
  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0"

  schema-validation:
    command: npm run db:types
    success_criteria: "Exit code 0, no type errors"

  lint:
    command: npm run lint -- --max-warnings=0
    success_criteria: "Exit code 0, no errors, no warnings"

  build:
    command: npm run build
    success_criteria: "Exit code 0"

# External Dependencies
external_dependencies:
  - prd: PRD-TABLE-SESSION-LIFECYCLE-MVP
    service: TableContextService
    required_for: "Session state machine, close-session RPC"
  - prd: PRD-007
    service: TableContextService
    required_for: "chip-custody RPCs (logInventorySnapshot, logDropEvent)"

# Risks and Mitigations
risks:
  - risk: "Casino chip denomination configuration not defined"
    mitigation: "Use standard denominations ($1, $5, $25, $100, $500) as defaults; make configurable later"
  - risk: "Telemetry bridge trigger may cause double-counting"
    mitigation: "Use idempotency key pattern (pft:{transaction_id}) to prevent duplicates"
---

# EXECUTION-SPEC: GAP-TABLE-ROLLOVER-UI - Table Rollover UI Components

## Overview

This EXECUTION-SPEC implements the missing operational UI components required for pit bosses to perform table rollover workflows. The Table Session Lifecycle MVP (PRD-TABLE-SESSION-LIFECYCLE-MVP) implemented the backend state machine, but the **operational UI** for capturing inventory, logging drops, and managing session close artifacts is incomplete.

**Key Deliverable**: Pit boss can capture chip counts, log drop events, and close sessions using proper artifact pickers instead of manual UUID entry.

## Scope

**In Scope:**
- ChipCountCaptureDialog for opening/closing/mid-shift inventory snapshots
- Enhanced CloseSessionDialog with artifact pickers (select existing or create new)
- DropEventDialog for logging drop box custody events
- Live InventoryPanel connected to real data (not mock data)
- GrindBuyinPanel for manual anonymous buy-in telemetry
- RundownSummaryPanel for win/loss display
- Automatic telemetry bridge trigger for rated buy-ins

**Out of Scope:**
- Fill/credit request workflows (requires CageContext - deferred)
- Soft count integration
- Exception tracking
- Multi-denomination denomination configuration UI (use defaults)

## Architecture Context

**Bounded Context:** TableContextService (SRM v4.0.0)
- Answers: "What is the operational state and chip custody posture of this gaming table?"
- All components interact with existing chip-custody RPCs

**Key ADR References:**
- ADR-024: RLS context self-injection via `set_rls_context_from_staff()`
- ADR-015: Pattern C (Hybrid) RLS with JWT fallback

---

## Workstream Details

### WS1: ChipCountCaptureDialog Component

**Purpose:** Modal for capturing chip inventory with denomination breakdown.

**Files:**
- `components/table/chip-count-capture-dialog.tsx` (NEW)
- `hooks/table-context/use-inventory-snapshots.ts` (NEW)

**Component Structure:**

```tsx
// ChipCountCaptureDialog
// ├── Snapshot type selector: OPENING | CLOSING | RUNDOWN | AD_HOC
// ├── Denomination grid (standard US denominations)
// │   ├── $1 chips: [quantity input]
// │   ├── $5 chips: [quantity input]
// │   ├── $25 chips: [quantity input]
// │   ├── $100 chips: [quantity input]
// │   └── $500 chips: [quantity input]
// ├── Auto-computed total (read-only)
// ├── Verified by (optional staff picker)
// ├── Notes field
// └── Submit → calls logInventorySnapshot RPC
```

**Existing Service Layer:** `services/table-context/chip-custody.ts::logInventorySnapshot()`

**Hook API:**
```typescript
// use-inventory-snapshots.ts
export function useInventorySnapshots(tableId: string, casinoId: string) {
  // Query: getInventoryHistory()
  // Mutations: logInventorySnapshot()
}

export function useLogInventorySnapshot(tableId: string) {
  // Mutation hook for creating new snapshots
}
```

**Acceptance Criteria:**
- [ ] Denomination grid uses standard values ($1, $5, $25, $100, $500)
- [ ] Total auto-computes from quantity × denomination
- [ ] Snapshot type matches DTO: 'open' | 'close' | 'rundown'
- [ ] Mutation calls existing RPC via chip-custody service
- [ ] Returns created snapshot ID for use in CloseSessionDialog

---

### WS2: Enhanced CloseSessionDialog

**Purpose:** Replace manual UUID entry with artifact pickers.

**Files:**
- `components/table/close-session-dialog.tsx` (UPDATE)
- `components/table/artifact-picker.tsx` (NEW)

**Current State Issues:**
- Lines 190-207: Manual text input for drop_event_id UUID
- Lines 248-265: Manual text input for closing_inventory_snapshot_id UUID

**Required Changes:**

```tsx
// CloseSessionDialog (enhanced)
// ├── Closing Inventory Snapshot
// │   ├── Dropdown: Select from recent snapshots for this table (getInventoryHistory)
// │   ├── OR: "Take New Snapshot" → opens ChipCountCaptureDialog
// │   └── Display: timestamp, total, counted_by
// ├── Drop Event
// │   ├── Dropdown: Select from today's drop events for this table
// │   ├── OR: "Log Drop Event" → opens DropEventDialog
// │   └── Display: timestamp, seal_no, removed_by
// ├── Notes field
// └── Submit (enabled only when at least one artifact selected)
```

**ArtifactPicker Component:**
```tsx
interface ArtifactPickerProps<T> {
  label: string;
  items: T[];
  isLoading: boolean;
  selectedId: string | null;
  onSelect: (id: string | null) => void;
  onCreate: () => void;
  createLabel: string;
  renderItem: (item: T) => React.ReactNode;
}
```

**Acceptance Criteria:**
- [ ] Replace text inputs with Select components
- [ ] Show recent snapshots/drops for this table
- [ ] "Create New" button opens respective dialog
- [ ] After creation, new item auto-selected
- [ ] No manual UUID entry required

---

### WS3: DropEventDialog Component

**Purpose:** Modal for logging drop box custody events.

**Files:**
- `components/table/drop-event-dialog.tsx` (NEW)
- `hooks/table-context/use-drop-events.ts` (NEW)

**Component Structure:**

```tsx
// DropEventDialog
// ├── Drop box ID (optional text input)
// ├── Seal number (required text input)
// ├── Removed by (current user, auto-filled)
// ├── Witnessed by (staff picker)
// ├── Gaming day (auto-derived, read-only)
// ├── Sequence number (auto-increment, read-only)
// ├── Notes field
// └── Submit → calls logDropEvent RPC
```

**Existing Service Layer:** `services/table-context/chip-custody.ts::logDropEvent()`

**Hook API:**
```typescript
// use-drop-events.ts
export function useDropEvents(tableId: string, casinoId: string, gamingDay?: string) {
  // Query: fetch drop events for table/day
}

export function useLogDropEvent(tableId: string) {
  // Mutation hook for creating new drop events
}
```

**Acceptance Criteria:**
- [ ] Seal number is required
- [ ] Current user auto-filled as removed_by
- [ ] Witnessed by uses existing staff picker pattern
- [ ] Gaming day derived from casino settings
- [ ] Returns created drop event ID for use in CloseSessionDialog

---

### WS4: Live InventoryPanel Integration

**Purpose:** Replace mock data with real queries.

**Files:**
- `components/pit-panels/inventory-panel.tsx` (UPDATE)

**Current State Issues:**
- Lines 19-82: Hardcoded MOCK_CHIP_COUNTS, MOCK_DROP_EVENTS, MOCK_FILL_SLIPS
- No connection to real data queries

**Required Changes:**

```tsx
// InventoryPanel (live data)
// ├── Connect to useInventorySnapshots() for real chip counts
// ├── Connect to useDropEvents() for real drop events
// ├── Session-scoped filtering (show only current session's artifacts)
// ├── "Count Chips" button → opens ChipCountCaptureDialog
// └── Real-time updates via React Query refetch
```

**Acceptance Criteria:**
- [ ] Remove all MOCK_* constants
- [ ] Use hooks from WS1/WS3
- [ ] Filter by current session if provided
- [ ] "Count Chips" button opens ChipCountCaptureDialog
- [ ] Refresh button triggers query invalidation

---

### WS5: GrindBuyinPanel Component

**Purpose:** Quick-tap interface for anonymous buy-in telemetry.

**Files:**
- `components/table/grind-buyin-panel.tsx` (NEW)
- `hooks/table-context/use-buyin-telemetry.ts` (NEW)

**Component Structure:**

```tsx
// GrindBuyinPanel
// ├── Quick-tap buttons (matching US cash denominations):
// │   ├── +$5
// │   ├── +$10
// │   ├── +$20
// │   ├── +$50
// │   └── +$100
// ├── Custom amount input (for larger/odd amounts)
// ├── Current shift grind total (running count from telemetry)
// ├── "Undo last" button (for mistakes - uses idempotency)
// └── Submit → calls rpc_log_table_buyin_telemetry(kind='GRIND_BUYIN')
```

**Existing RPC:** `rpc_log_table_buyin_telemetry` with `kind='GRIND_BUYIN'`

**Hook API:**
```typescript
// use-buyin-telemetry.ts
export function useBuyinTelemetry(tableId: string, shiftWindow: { start: string; end: string }) {
  // Query: get grind total for shift window
}

export function useLogGrindBuyin(tableId: string) {
  // Mutation: log grind buy-in
}
```

**Acceptance Criteria:**
- [ ] Quick-tap buttons for common cash amounts
- [ ] Shows running total for current shift
- [ ] Undo functionality with idempotency key reversal
- [ ] Uses existing telemetry RPC with kind='GRIND_BUYIN'

---

### WS6: RundownSummaryPanel Component

**Purpose:** Display computed win/loss for session.

**Files:**
- `components/table/rundown-summary-panel.tsx` (NEW)

**Component Structure:**

```tsx
// RundownSummaryPanel
// ├── Opening bankroll (from opening snapshot)
// ├── Closing bankroll (from closing snapshot)
// ├── Total fills (sum of verified fills)
// ├── Total credits (sum of verified credits)
// ├── Computed win/loss (closing - opening + fills - credits)
// └── Data source: rpc_shift_table_metrics
```

**Existing RPC:** `rpc_shift_table_metrics` from shift-metrics service

**Acceptance Criteria:**
- [ ] Shows inventory-based win/loss computation
- [ ] Handles missing data gracefully (opening/closing not yet captured)
- [ ] Clear labels distinguishing fills from credits
- [ ] Uses shift-metrics service layer

---

### WS7: Automatic Telemetry Bridge

**Purpose:** DB trigger to bridge rated buy-ins to telemetry.

**Files:**
- `supabase/migrations/YYYYMMDDHHMMSS_telemetry_bridge_trigger.sql` (NEW)

**SQL Implementation:**

```sql
-- Bridge rated buy-ins from player_financial_transaction to table_buyin_telemetry
-- Guardrails G1-G5 from GAP_ANALYSIS_TABLE_RUNDOWN_INTEGRATION_REWRITE_v0.4.0.md

CREATE OR REPLACE FUNCTION bridge_rated_buyin_to_telemetry()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  v_table_id uuid;
  v_idempotency_key text;
BEGIN
  -- G1: Only process BUY-IN transactions (direction = 'in')
  IF NEW.direction != 'in' THEN
    RETURN NEW;
  END IF;

  -- G2: Must have rating_slip_id to be a "rated" buy-in
  IF NEW.rating_slip_id IS NULL THEN
    RETURN NEW;
  END IF;

  -- Get table_id from rating slip
  SELECT rs.table_id INTO v_table_id
  FROM rating_slip rs
  WHERE rs.id = NEW.rating_slip_id;

  IF v_table_id IS NULL THEN
    RETURN NEW;
  END IF;

  -- G3: Idempotency key prevents duplicates
  v_idempotency_key := 'pft:' || NEW.id::text;

  -- G4: Insert into telemetry (idempotent - ON CONFLICT DO NOTHING)
  INSERT INTO table_buyin_telemetry (
    casino_id,
    table_id,
    kind,
    amount_cents,
    source,
    rating_slip_id,
    actor_id,
    idempotency_key,
    created_at
  ) VALUES (
    NEW.casino_id,
    v_table_id,
    'RATED_BUYIN',
    NEW.amount_cents,
    'finance_bridge',
    NEW.rating_slip_id,
    NEW.recorded_by_staff_id,
    v_idempotency_key,
    COALESCE(NEW.created_at, now())
  )
  ON CONFLICT (idempotency_key) DO NOTHING;

  RETURN NEW;
END;
$$;

-- G5: Trigger fires AFTER INSERT to not block financial transaction
CREATE TRIGGER trg_bridge_rated_buyin_telemetry
  AFTER INSERT ON player_financial_transaction
  FOR EACH ROW
  EXECUTE FUNCTION bridge_rated_buyin_to_telemetry();

COMMENT ON FUNCTION bridge_rated_buyin_to_telemetry() IS
  'Bridges rated buy-ins from player_financial_transaction to table_buyin_telemetry for shift dashboard accuracy. See GAP-TABLE-ROLLOVER-UI WS7.';
```

**Acceptance Criteria:**
- [ ] Trigger only fires for BUY-IN (direction='in')
- [ ] Only processes rated transactions (rating_slip_id NOT NULL)
- [ ] Uses idempotency key to prevent duplicates
- [ ] ON CONFLICT DO NOTHING for safe replay
- [ ] SECURITY DEFINER with search_path = public

---

## Definition of Done

### Phase 1: Enable Session Close (DoD-A)
- [ ] Pit boss can capture chip inventory (opening/closing/mid-shift) via ChipCountCaptureDialog
- [ ] Pit boss can log drop events via DropEventDialog
- [ ] All mutations use existing chip-custody service layer

### Phase 2: Complete Session Close (DoD-B)
- [ ] CloseSessionDialog uses artifact pickers (not manual UUID entry)
- [ ] "Create New" buttons open respective dialogs
- [ ] InventoryPanel shows live data

### Phase 3: Operational Completeness (DoD-C)
- [ ] Pit boss can log grind buy-ins with quick-tap buttons
- [ ] Rundown summary shows computed win/loss

### Phase 4: Backend Pipeline (DoD-D)
- [ ] Rated buy-ins automatically flow to telemetry table
- [ ] Shift dashboard estimated_drop_rated_cents reflects rated buy-ins

### Quality Gates (DoD-E)
- [ ] `npm run type-check` passes
- [ ] `npm run lint` passes
- [ ] `npm run build` passes
- [ ] `npm run db:types` succeeds (after migration)

---

## File Inventory

| File | Action | Workstream |
|------|--------|------------|
| `components/table/chip-count-capture-dialog.tsx` | CREATE | WS1 |
| `hooks/table-context/use-inventory-snapshots.ts` | CREATE | WS1 |
| `components/table/close-session-dialog.tsx` | UPDATE | WS2 |
| `components/table/artifact-picker.tsx` | CREATE | WS2 |
| `components/table/drop-event-dialog.tsx` | CREATE | WS3 |
| `hooks/table-context/use-drop-events.ts` | CREATE | WS3 |
| `components/pit-panels/inventory-panel.tsx` | UPDATE | WS4 |
| `components/table/grind-buyin-panel.tsx` | CREATE | WS5 |
| `hooks/table-context/use-buyin-telemetry.ts` | CREATE | WS5 |
| `components/table/rundown-summary-panel.tsx` | CREATE | WS6 |
| `supabase/migrations/YYYYMMDDHHMMSS_telemetry_bridge_trigger.sql` | CREATE | WS7 |
