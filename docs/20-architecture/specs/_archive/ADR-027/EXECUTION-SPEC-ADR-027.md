---
# EXECUTION-SPEC: ADR-027 Table Bank Mode (Visibility Slice, MVP)
# Generated by prd-pipeline skill
# Date: 2026-01-17

prd: ADR-027
prd_title: "Table Bank Mode (Visibility Slice, MVP)"
service: TableContextService
mvp_phase: 2  # Session phase

# Dependencies
dependencies:
  - id: ADR-028
    name: "Table Status Standardization"
    status: COMPLETED
  - id: GAP-TBL-RUNDOWN
    name: "Finance-to-Telemetry Bridge"
    status: COMPLETED

# Cross-context touches (ADR-027 D1 explicitly authorizes this)
# Note: table_bank_mode is a TableContext-specific policy that happens to live
# in casino_settings for simplicity. CasinoService will consume via DTO updates.
cross_context_coordination:
  - service: CasinoService
    interaction: "Adds table_bank_mode column to casino_settings"
    pattern: "DTO consumption - CasinoService exposes read-only access via CasinoSettingsDTO"
    authorization: "ADR-027 D1 - Casino-level mode as informational labeling"

# Workstream Definitions
workstreams:
  WS1:
    name: "Database Schema - Table Bank Mode"
    description: "Create table_bank_mode enum, add columns to casino_settings, gaming_table, table_session"
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/YYYYMMDDHHMMSS_adr027_table_bank_mode.sql
    gate: schema-validation
    estimated_complexity: low

  WS2:
    name: "RPC - Open Session Mode Binding"
    description: "Modify rpc_open_table_session to bind mode + par at session creation"
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - supabase/migrations/YYYYMMDDHHMMSS_adr027_rpc_session_mode_binding.sql
    gate: schema-validation
    estimated_complexity: low

  WS3:
    name: "RPC - Table Rundown Computation"
    description: "New rpc_compute_table_rundown and rpc_post_table_drop_total"
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - supabase/migrations/YYYYMMDDHHMMSS_adr027_rpc_rundown.sql
    gate: schema-validation
    estimated_complexity: medium

  WS4:
    name: "Service Layer - DTOs & Rundown"
    description: "Add TableRundownDTO, update TableSessionDTO, create rundown.ts module"
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1, WS3]
    outputs:
      - services/table-context/dtos.ts (modify)
      - services/table-context/rundown.ts (new)
      - services/table-context/mappers.ts (modify)
      - services/table-context/labels.ts (modify)
    gate: type-check
    estimated_complexity: medium

  WS5:
    name: "React Query Hooks"
    description: "useTableRundown hook and usePostDropTotal mutation"
    executor: typescript-pro
    executor_type: task-agent
    depends_on: [WS4]
    outputs:
      - hooks/table-context/use-table-rundown.ts (new)
      - hooks/table-context/index.ts (modify)
    gate: type-check
    estimated_complexity: low

  WS6:
    name: "UI - Rundown Summary Panel"
    description: "RundownSummaryPanel component for shift dashboard"
    executor: typescript-pro
    executor_type: task-agent
    depends_on: [WS5]
    outputs:
      - components/table/rundown-summary-panel.tsx (new)
    gate: build
    estimated_complexity: medium

  WS7:
    name: "Unit Tests"
    description: "Mapper tests and rundown service tests"
    executor: typescript-pro
    executor_type: task-agent
    depends_on: [WS4]
    outputs:
      - services/table-context/__tests__/rundown.test.ts (new)
    gate: test-pass
    estimated_complexity: low

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: "Phase 1 - Schema Foundation"
    parallel: [WS1]
    gates: [schema-validation]

  - name: "Phase 2 - RPC Layer"
    parallel: [WS2, WS3]
    gates: [schema-validation]

  - name: "Phase 3 - Service Layer"
    parallel: [WS4, WS7]
    gates: [type-check, test-pass]

  - name: "Phase 4 - Frontend"
    parallel: [WS5, WS6]
    gates: [type-check, build]

# Validation Gates
gates:
  schema-validation:
    command: "npm run db:types"
    success_criteria: "Exit code 0, types regenerated"

  type-check:
    command: "npm run type-check"
    success_criteria: "Exit code 0, no type errors"

  test-pass:
    command: "npm test services/table-context/"
    success_criteria: "All tests pass"

  build:
    command: "npm run build"
    success_criteria: "Exit code 0, no build errors"

# Risks and Mitigations
risks:
  - risk: "Casino-scoped table_bank_mode may cause existing sessions to have NULL mode"
    mitigation: "Migration sets default INVENTORY_COUNT; existing sessions remain NULL (acceptable for MVP)"
  - risk: "rpc_compute_table_rundown depends on GAP-TBL-RUNDOWN telemetry"
    mitigation: "GAP-TBL-RUNDOWN already implemented; verify table_buyin_telemetry exists"

---

# EXECUTION-SPEC: ADR-027 - Table Bank Mode (Visibility Slice, MVP)

## Overview

Implements **operational visibility** for table bank lifecycle in PT-2 shift dashboards. This ADR adds informational labeling for casino bank modes (Inventory Count vs Imprest-to-Par) and computes table win/loss using the regulatory identity:

```
table_win = closing_bankroll + credits + drop − opening_bankroll − fills
```

**MVP Scope**: Pure visibility slice. No enforcement, no blocking, no tolerance policies.

## Scope

**In Scope (MVP)**:
- `table_bank_mode` enum and casino-level setting
- Per-table `par_total_cents` advisory value
- Session binding of mode + par at open time
- `rpc_compute_table_rundown` for win/loss computation
- `rpc_post_table_drop_total` to mark drop as posted
- RundownSummaryPanel UI component
- "Count Pending" vs "Count Posted" display via `drop_posted_at`

**Out of Scope (MVP)**:
- Variance tolerance enforcement
- Blocking close workflows
- Par history/approval system
- Replace accounting/soft-count master records

## Architecture Context

- **Bounded Context**: TableContextService (SRM v4.10.0)
- **Dependencies**: ADR-028 (status standardization), GAP-TBL-RUNDOWN (telemetry bridge)
- **RLS Pattern**: Existing Pattern C hybrid policies remain sufficient
- **Security**: All RPCs use SECURITY DEFINER with `set_rls_context_from_staff()` per ADR-024

---

## Workstream Details

### WS1: Database Schema - Table Bank Mode

**Purpose**: Create enum and add columns for table bank mode support.

**Migration**: `YYYYMMDDHHMMSS_adr027_table_bank_mode.sql`

```sql
-- ============================================================================
-- ADR-027: Table Bank Mode Schema
-- Bounded Context: TableContextService
-- ============================================================================

-- 1. Create table_bank_mode enum
CREATE TYPE table_bank_mode AS ENUM ('INVENTORY_COUNT', 'IMPREST_TO_PAR');

COMMENT ON TYPE table_bank_mode IS
  'Casino bank close model: INVENTORY_COUNT (count as-is) or IMPREST_TO_PAR (restore to par).';

-- 2. Add to casino_settings (casino-wide policy)
ALTER TABLE casino_settings
ADD COLUMN table_bank_mode table_bank_mode NOT NULL DEFAULT 'INVENTORY_COUNT';

COMMENT ON COLUMN casino_settings.table_bank_mode IS
  'Default table bank close model for this casino. Informational in MVP.';

-- 3. Add par columns to gaming_table
ALTER TABLE gaming_table
ADD COLUMN par_total_cents INTEGER,
ADD COLUMN par_updated_at TIMESTAMPTZ,
ADD COLUMN par_updated_by UUID REFERENCES staff(id);

COMMENT ON COLUMN gaming_table.par_total_cents IS
  'Target bankroll (need/par) in cents. Advisory only in MVP.';

-- 4. Add mode binding + operational totals to table_session
-- NOTE: drop_posted_at already exists from ADR-028
ALTER TABLE table_session
ADD COLUMN table_bank_mode table_bank_mode,
ADD COLUMN need_total_cents INTEGER,
ADD COLUMN fills_total_cents INTEGER NOT NULL DEFAULT 0,
ADD COLUMN credits_total_cents INTEGER NOT NULL DEFAULT 0,
ADD COLUMN drop_total_cents INTEGER;

COMMENT ON COLUMN table_session.table_bank_mode IS
  'Snapshot of casino bank mode at session open. Informational in MVP.';
COMMENT ON COLUMN table_session.need_total_cents IS
  'Snapshot of table par at session open (nullable). Informational in MVP.';
COMMENT ON COLUMN table_session.fills_total_cents IS
  'Operational total fills for the session. Informational in MVP.';
COMMENT ON COLUMN table_session.credits_total_cents IS
  'Operational total credits for the session. Informational in MVP.';
COMMENT ON COLUMN table_session.drop_total_cents IS
  'Drop total for the session (posted by accounting/soft-count entry/import).';

-- 5. Add total_cents to inventory snapshot (avoid fragile JSON math)
ALTER TABLE table_inventory_snapshot
ADD COLUMN total_cents INTEGER;

COMMENT ON COLUMN table_inventory_snapshot.total_cents IS
  'Total tray value in cents. Stored to avoid denom casting pitfalls.';

NOTIFY pgrst, 'reload schema';
```

**Acceptance Criteria**:
- [ ] `npm run db:types` succeeds
- [ ] `table_bank_mode` enum available in database.types.ts
- [ ] `table_session` has operational columns: `fills_total_cents`, `credits_total_cents`, `drop_total_cents`
- [ ] `table_inventory_snapshot.total_cents` column added (avoids JSON math)
- [ ] All columns nullable or have sensible defaults

---

### WS2: RPC - Open Session Mode Binding

**Purpose**: Modify `rpc_open_table_session` to snapshot mode + par at session creation.

**Migration**: `YYYYMMDDHHMMSS_adr027_rpc_session_mode_binding.sql`

**Key Implementation**:
```sql
-- Inside rpc_open_table_session, after context injection:

-- Resolve bank mode from casino settings
SELECT table_bank_mode INTO v_bank_mode
FROM casino_settings
WHERE casino_id = v_casino_id;

-- Resolve par from gaming_table
SELECT par_total_cents INTO v_par_total
FROM gaming_table
WHERE id = p_gaming_table_id AND casino_id = v_casino_id;

-- Update INSERT to include mode binding
INSERT INTO table_session (
  casino_id,
  gaming_table_id,
  status,
  opened_by_staff_id,
  table_bank_mode,      -- ADD
  need_total_cents      -- ADD
) VALUES (
  v_casino_id,
  p_gaming_table_id,
  'ACTIVE',
  v_actor_id,
  COALESCE(v_bank_mode, 'INVENTORY_COUNT'),
  v_par_total
)
RETURNING * INTO v_result;
```

**Acceptance Criteria**:
- [ ] New sessions have `table_bank_mode` set from casino_settings
- [ ] New sessions have `need_total_cents` set from gaming_table.par_total_cents
- [ ] Existing RPC tests still pass

---

### WS3: RPC - Table Rundown Computation

**Purpose**: Compute table win/loss using the regulatory identity formula.

**Migration**: `YYYYMMDDHHMMSS_adr027_rpc_rundown.sql`

**RPC 1: `rpc_compute_table_rundown`**
```sql
CREATE OR REPLACE FUNCTION rpc_compute_table_rundown(p_session_id uuid)
RETURNS TABLE(
  session_id uuid,
  opening_total_cents bigint,
  closing_total_cents bigint,
  fills_total_cents bigint,
  credits_total_cents bigint,
  drop_total_cents bigint,
  buyin_total_cents bigint,
  table_win_cents bigint,
  need_total_cents integer,
  variance_from_par_cents bigint,
  drop_posted boolean
)
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  v_casino_id uuid;
  v_session table_session%ROWTYPE;
  v_opening bigint := 0;
  v_closing bigint := 0;
  v_fills bigint := 0;
  v_credits bigint := 0;
  v_drop bigint := 0;
  v_buyin bigint := 0;
BEGIN
  -- ADR-024: Context injection
  PERFORM set_rls_context_from_staff();
  v_casino_id := current_setting('app.casino_id')::uuid;

  -- Get session with casino scope validation
  SELECT * INTO v_session
  FROM table_session
  WHERE id = p_session_id AND casino_id = v_casino_id;

  IF NOT FOUND THEN
    RAISE EXCEPTION 'session_not_found'
      USING ERRCODE = 'P0002',
            HINT = 'Session does not exist or belongs to different casino';
  END IF;

  -- Opening snapshot total (from chipset JSONB)
  SELECT COALESCE(SUM((value->>'count')::int * key::int), 0)
  INTO v_opening
  FROM table_inventory_snapshot s, jsonb_each(s.chipset)
  WHERE s.id = v_session.opening_inventory_snapshot_id;

  -- Closing snapshot total
  SELECT COALESCE(SUM((value->>'count')::int * key::int), 0)
  INTO v_closing
  FROM table_inventory_snapshot s, jsonb_each(s.chipset)
  WHERE s.id = v_session.closing_inventory_snapshot_id;

  -- Fills total (within session window)
  SELECT COALESCE(SUM(amount_cents), 0)
  INTO v_fills
  FROM table_fill
  WHERE table_id = v_session.gaming_table_id
    AND casino_id = v_casino_id
    AND created_at >= v_session.opened_at
    AND created_at <= COALESCE(v_session.closed_at, now());

  -- Credits total (within session window)
  SELECT COALESCE(SUM(amount_cents), 0)
  INTO v_credits
  FROM table_credit
  WHERE table_id = v_session.gaming_table_id
    AND casino_id = v_casino_id
    AND created_at >= v_session.opened_at
    AND created_at <= COALESCE(v_session.closed_at, now());

  -- Buy-in total from telemetry (GAP-TBL-RUNDOWN bridge)
  SELECT COALESCE(SUM(amount_cents), 0)
  INTO v_buyin
  FROM table_buyin_telemetry
  WHERE gaming_table_id = v_session.gaming_table_id
    AND gaming_day = v_session.gaming_day
    AND telemetry_kind = 'RATED_BUYIN';

  -- Drop total (from drop event if exists)
  -- Note: drop_total stored directly on session or via event
  v_drop := 0; -- MVP: soft count integration deferred

  RETURN QUERY SELECT
    p_session_id,
    v_opening,
    v_closing,
    v_fills,
    v_credits,
    v_drop,
    v_buyin,
    (v_closing + v_credits + v_drop - v_opening - v_fills)::bigint,
    v_session.need_total_cents,
    CASE WHEN v_session.need_total_cents IS NOT NULL
         THEN (v_closing - v_session.need_total_cents)::bigint
         ELSE NULL END,
    v_session.drop_posted_at IS NOT NULL;
END;
$$;

COMMENT ON FUNCTION rpc_compute_table_rundown(uuid) IS
  'Compute table rundown using identity: win = closing + credits + drop - opening - fills. ADR-027.';

GRANT EXECUTE ON FUNCTION rpc_compute_table_rundown(uuid) TO authenticated;
```

**RPC 2: `rpc_post_table_drop_total`**
```sql
CREATE OR REPLACE FUNCTION rpc_post_table_drop_total(
  p_session_id uuid,
  p_drop_total_cents integer
)
RETURNS table_session
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  v_casino_id uuid;
  v_actor_id uuid;
  v_role text;
  v_result table_session;
BEGIN
  -- ADR-024: Context injection
  PERFORM set_rls_context_from_staff();
  v_casino_id := current_setting('app.casino_id')::uuid;
  v_actor_id := current_setting('app.actor_id')::uuid;

  -- Authorization: pit_boss/admin only
  v_role := COALESCE(
    NULLIF(current_setting('app.staff_role', true), ''),
    (auth.jwt() -> 'app_metadata' ->> 'staff_role')::text
  );

  IF v_role NOT IN ('pit_boss', 'admin') THEN
    RAISE EXCEPTION 'forbidden'
      USING ERRCODE = 'P0001',
            HINT = 'Only pit_boss or admin roles can post drop total';
  END IF;

  -- Update session with drop total and mark as posted
  UPDATE table_session SET
    drop_posted_at = now()
    -- Note: drop_total_cents column not in MVP schema;
    -- actual drop stored in accounting system
  WHERE id = p_session_id AND casino_id = v_casino_id
  RETURNING * INTO v_result;

  IF NOT FOUND THEN
    RAISE EXCEPTION 'session_not_found'
      USING ERRCODE = 'P0002',
            HINT = 'Session does not exist or belongs to different casino';
  END IF;

  RETURN v_result;
END;
$$;

COMMENT ON FUNCTION rpc_post_table_drop_total(uuid, integer) IS
  'Mark session drop as posted. Sets drop_posted_at timestamp. ADR-027.';

GRANT EXECUTE ON FUNCTION rpc_post_table_drop_total(uuid, integer) TO authenticated;
```

**Acceptance Criteria**:
- [ ] `rpc_compute_table_rundown` returns all formula components
- [ ] Formula computes correctly: `win = closing + credits + drop - opening - fills`
- [ ] `buyin_total_cents` reads from `table_buyin_telemetry` (GAP-TBL-RUNDOWN)
- [ ] `rpc_post_table_drop_total` sets `drop_posted_at`
- [ ] Both RPCs enforce casino scope via ADR-024

---

### WS4: Service Layer - DTOs & Rundown

**Purpose**: TypeScript types and service module for rundown computation.

**Files to Modify/Create**:

1. **`services/table-context/dtos.ts`** (modify):
```typescript
// Add type alias for table_bank_mode enum
export type TableBankMode = Database["public"]["Enums"]["table_bank_mode"];
// Values: 'INVENTORY_COUNT' | 'IMPREST_TO_PAR'

// Update TableSessionDTO to include mode binding fields
export interface TableSessionDTO {
  // ... existing fields ...
  table_bank_mode: TableBankMode | null;
  need_total_cents: number | null;
  drop_posted_at: string | null;  // already exists from ADR-028
}

// New: Table rundown DTO
// eslint-disable-next-line custom-rules/no-manual-dto-interfaces -- Pattern A: RPC aggregate response
export interface TableRundownDTO {
  session_id: string;
  opening_total_cents: number;
  closing_total_cents: number;
  fills_total_cents: number;
  credits_total_cents: number;
  drop_total_cents: number;
  buyin_total_cents: number;
  table_win_cents: number;
  need_total_cents: number | null;
  variance_from_par_cents: number | null;
  drop_posted: boolean;
}
```

2. **`services/table-context/rundown.ts`** (new):
```typescript
import type { SupabaseClient } from "@supabase/supabase-js";
import type { Database } from "@/types/database.types";
import type { TableRundownDTO } from "./dtos";
import { mapRpcRundownToDTO } from "./mappers";
import { mapSupabaseError } from "@/lib/errors";

export async function computeTableRundown(
  supabase: SupabaseClient<Database>,
  sessionId: string
): Promise<TableRundownDTO> {
  const { data, error } = await supabase
    .rpc("rpc_compute_table_rundown", { p_session_id: sessionId })
    .single();

  if (error) throw mapSupabaseError(error);
  if (!data) throw new Error("Rundown computation returned no data");

  return mapRpcRundownToDTO(data);
}

export async function postTableDropTotal(
  supabase: SupabaseClient<Database>,
  sessionId: string,
  dropTotalCents: number
): Promise<void> {
  const { error } = await supabase.rpc("rpc_post_table_drop_total", {
    p_session_id: sessionId,
    p_drop_total_cents: dropTotalCents,
  });

  if (error) throw mapSupabaseError(error);
}
```

3. **`services/table-context/mappers.ts`** (modify):
```typescript
import type { TableRundownDTO } from "./dtos";

type RpcRundownRow = Database["public"]["Functions"]["rpc_compute_table_rundown"]["Returns"][0];

export function mapRpcRundownToDTO(row: RpcRundownRow): TableRundownDTO {
  return {
    session_id: row.session_id,
    opening_total_cents: Number(row.opening_total_cents),
    closing_total_cents: Number(row.closing_total_cents),
    fills_total_cents: Number(row.fills_total_cents),
    credits_total_cents: Number(row.credits_total_cents),
    drop_total_cents: Number(row.drop_total_cents),
    buyin_total_cents: Number(row.buyin_total_cents),
    table_win_cents: Number(row.table_win_cents),
    need_total_cents: row.need_total_cents,
    variance_from_par_cents: row.variance_from_par_cents != null
      ? Number(row.variance_from_par_cents)
      : null,
    drop_posted: row.drop_posted,
  };
}
```

4. **`services/table-context/labels.ts`** (modify):
```typescript
import type { TableBankMode } from "./dtos";

// Add table bank mode labels
export const TABLE_BANK_MODE_LABELS: Record<TableBankMode, string> = {
  INVENTORY_COUNT: "Inventory Count",
  IMPREST_TO_PAR: "Imprest to Par",
};

export const TABLE_BANK_MODE_DESCRIPTIONS: Record<TableBankMode, string> = {
  INVENTORY_COUNT: "Count and record tray as-is at shift close",
  IMPREST_TO_PAR: "Restore tray to par via final fill/credit before close",
};
```

**Acceptance Criteria**:
- [ ] `TableBankMode` type alias exports correctly
- [ ] `TableSessionDTO` includes new fields
- [ ] `TableRundownDTO` matches RPC return shape
- [ ] Mapper handles bigint → number conversion
- [ ] `npm run type-check` passes

---

### WS5: React Query Hooks

**Purpose**: Client-side hooks for rundown data fetching.

**File**: `hooks/table-context/use-table-rundown.ts` (new)

```typescript
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { useSupabase } from "@/lib/supabase/client";
import { computeTableRundown, postTableDropTotal } from "@/services/table-context/rundown";
import type { TableRundownDTO } from "@/services/table-context/dtos";

// Query key factory
export const tableRundownKeys = {
  all: ["table-rundown"] as const,
  detail: (sessionId: string) => [...tableRundownKeys.all, sessionId] as const,
};

export function useTableRundown(sessionId: string | null) {
  const supabase = useSupabase();

  return useQuery<TableRundownDTO>({
    queryKey: tableRundownKeys.detail(sessionId ?? ""),
    queryFn: () => computeTableRundown(supabase, sessionId!),
    enabled: !!sessionId,
    staleTime: 30_000, // 30 seconds
  });
}

export function usePostDropTotal() {
  const supabase = useSupabase();
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({ sessionId, dropTotalCents }: {
      sessionId: string;
      dropTotalCents: number
    }) => postTableDropTotal(supabase, sessionId, dropTotalCents),
    onSuccess: (_, variables) => {
      // Invalidate rundown query for this session
      queryClient.invalidateQueries({
        queryKey: tableRundownKeys.detail(variables.sessionId),
      });
    },
  });
}
```

**Acceptance Criteria**:
- [ ] `useTableRundown` returns typed `TableRundownDTO`
- [ ] Query disabled when `sessionId` is null
- [ ] Mutation invalidates rundown query on success
- [ ] `npm run type-check` passes

---

### WS6: UI - Rundown Summary Panel

**Purpose**: Dashboard component displaying table win/loss with formula breakdown.

**File**: `components/table/rundown-summary-panel.tsx` (new)

```typescript
"use client";

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { cn } from "@/lib/utils";
import { useTableRundown } from "@/hooks/table-context/use-table-rundown";
import { formatCurrency } from "@/lib/format";
import { TABLE_BANK_MODE_LABELS } from "@/services/table-context/labels";
import type { TableBankMode } from "@/services/table-context/dtos";

interface RundownSummaryPanelProps {
  sessionId: string;
  tableBankMode?: TableBankMode | null;
  className?: string;
}

export function RundownSummaryPanel({
  sessionId,
  tableBankMode,
  className,
}: RundownSummaryPanelProps) {
  const { data: rundown, isLoading, error } = useTableRundown(sessionId);

  if (isLoading) {
    return (
      <Card className={cn("animate-pulse", className)}>
        <CardHeader>
          <CardTitle className="text-sm font-medium">Session Rundown</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="h-32 bg-muted rounded" />
        </CardContent>
      </Card>
    );
  }

  if (error || !rundown) {
    return null;
  }

  return (
    <Card className={className}>
      <CardHeader className="flex flex-row items-center justify-between pb-2">
        <CardTitle className="text-sm font-medium">Session Rundown</CardTitle>
        <div className="flex gap-2">
          {tableBankMode && (
            <Badge variant="outline" className="text-xs">
              {TABLE_BANK_MODE_LABELS[tableBankMode]}
            </Badge>
          )}
          <Badge
            variant={rundown.drop_posted ? "default" : "secondary"}
            className="text-xs"
          >
            {rundown.drop_posted ? "Count Posted" : "Count Pending"}
          </Badge>
        </div>
      </CardHeader>
      <CardContent>
        <dl className="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
          {/* Opening */}
          <dt className="text-muted-foreground">Opening</dt>
          <dd className="text-right font-mono">
            {formatCurrency(rundown.opening_total_cents / 100)}
          </dd>

          {/* Fills (subtractive - reduces win) */}
          <dt className="text-muted-foreground">Fills</dt>
          <dd className="text-right font-mono text-red-600">
            −{formatCurrency(rundown.fills_total_cents / 100)}
          </dd>

          {/* Buy-ins */}
          <dt className="text-muted-foreground">Buy-ins</dt>
          <dd className="text-right font-mono">
            {formatCurrency(rundown.buyin_total_cents / 100)}
          </dd>

          {/* Closing */}
          <dt className="text-muted-foreground">Closing</dt>
          <dd className="text-right font-mono">
            {formatCurrency(rundown.closing_total_cents / 100)}
          </dd>

          {/* Credits (additive - increases win) */}
          <dt className="text-muted-foreground">Credits</dt>
          <dd className="text-right font-mono text-green-600">
            +{formatCurrency(rundown.credits_total_cents / 100)}
          </dd>

          {/* Drop */}
          <dt className="text-muted-foreground">Drop</dt>
          <dd className="text-right font-mono">
            {rundown.drop_posted
              ? formatCurrency(rundown.drop_total_cents / 100)
              : "—"}
          </dd>

          {/* Divider */}
          <div className="col-span-2 border-t my-2" />

          {/* Table Win/Loss */}
          <dt className="font-medium">Table Win/Loss</dt>
          <dd className={cn(
            "text-right font-mono font-bold text-lg",
            rundown.table_win_cents >= 0 ? "text-green-600" : "text-red-600"
          )}>
            {rundown.table_win_cents >= 0 ? "+" : ""}
            {formatCurrency(rundown.table_win_cents / 100)}
          </dd>

          {/* Variance from Par (if configured) */}
          {rundown.variance_from_par_cents !== null && (
            <>
              <dt className="text-muted-foreground text-xs">Variance from Par</dt>
              <dd className={cn(
                "text-right font-mono text-xs",
                rundown.variance_from_par_cents !== 0 && "text-amber-600"
              )}>
                {rundown.variance_from_par_cents >= 0 ? "+" : ""}
                {formatCurrency(rundown.variance_from_par_cents / 100)}
              </dd>
            </>
          )}
        </dl>

        {/* Formula reference */}
        <p className="mt-4 text-xs text-muted-foreground text-center">
          Win = Closing + Credits + Drop − Opening − Fills
        </p>
      </CardContent>
    </Card>
  );
}
```

**Acceptance Criteria**:
- [ ] Displays all formula components
- [ ] Correct sign semantics (fills red/subtractive, credits green/additive)
- [ ] Shows "Count Pending" or "Count Posted" badge
- [ ] Shows variance from par if configured
- [ ] Loading and error states handled
- [ ] `npm run build` passes

---

### WS7: Unit Tests

**Purpose**: Test coverage for rundown mapper and service.

**File**: `services/table-context/__tests__/rundown.test.ts` (new)

```typescript
import { describe, it, expect } from "@jest/globals";
import { mapRpcRundownToDTO } from "../mappers";

describe("mapRpcRundownToDTO", () => {
  it("maps all fields correctly", () => {
    const rpcRow = {
      session_id: "session-123",
      opening_total_cents: BigInt(100000),
      closing_total_cents: BigInt(120000),
      fills_total_cents: BigInt(50000),
      credits_total_cents: BigInt(30000),
      drop_total_cents: BigInt(0),
      buyin_total_cents: BigInt(75000),
      table_win_cents: BigInt(0), // computed: 120000 + 30000 + 0 - 100000 - 50000
      need_total_cents: 100000,
      variance_from_par_cents: BigInt(20000),
      drop_posted: false,
    };

    const dto = mapRpcRundownToDTO(rpcRow);

    expect(dto.session_id).toBe("session-123");
    expect(dto.opening_total_cents).toBe(100000);
    expect(dto.closing_total_cents).toBe(120000);
    expect(dto.fills_total_cents).toBe(50000);
    expect(dto.credits_total_cents).toBe(30000);
    expect(dto.drop_total_cents).toBe(0);
    expect(dto.buyin_total_cents).toBe(75000);
    expect(dto.need_total_cents).toBe(100000);
    expect(dto.variance_from_par_cents).toBe(20000);
    expect(dto.drop_posted).toBe(false);
  });

  it("handles null variance_from_par_cents", () => {
    const rpcRow = {
      session_id: "session-456",
      opening_total_cents: BigInt(0),
      closing_total_cents: BigInt(0),
      fills_total_cents: BigInt(0),
      credits_total_cents: BigInt(0),
      drop_total_cents: BigInt(0),
      buyin_total_cents: BigInt(0),
      table_win_cents: BigInt(0),
      need_total_cents: null,
      variance_from_par_cents: null,
      drop_posted: true,
    };

    const dto = mapRpcRundownToDTO(rpcRow);

    expect(dto.need_total_cents).toBeNull();
    expect(dto.variance_from_par_cents).toBeNull();
    expect(dto.drop_posted).toBe(true);
  });

  it("computes table_win using identity formula", () => {
    // Win = Closing + Credits + Drop - Opening - Fills
    // Win = 150000 + 25000 + 80000 - 100000 - 40000 = 115000
    const rpcRow = {
      session_id: "session-789",
      opening_total_cents: BigInt(100000),
      closing_total_cents: BigInt(150000),
      fills_total_cents: BigInt(40000),
      credits_total_cents: BigInt(25000),
      drop_total_cents: BigInt(80000),
      buyin_total_cents: BigInt(60000),
      table_win_cents: BigInt(115000),
      need_total_cents: null,
      variance_from_par_cents: null,
      drop_posted: true,
    };

    const dto = mapRpcRundownToDTO(rpcRow);

    expect(dto.table_win_cents).toBe(115000);
  });
});
```

**Acceptance Criteria**:
- [ ] Mapper tests cover all fields
- [ ] Null handling tested
- [ ] Formula computation verified
- [ ] `npm test services/table-context/` passes

---

## Definition of Done

- [ ] **WS1**: Migration applied, `table_bank_mode` enum available
- [ ] **WS2**: `rpc_open_table_session` binds mode + par at session creation
- [ ] **WS3**: `rpc_compute_table_rundown` returns win/loss using identity formula
- [ ] **WS3**: `rpc_post_table_drop_total` sets `drop_posted_at`
- [ ] **WS4**: `TableRundownDTO` and mappers implemented
- [ ] **WS5**: `useTableRundown` hook fetches rundown data
- [ ] **WS6**: `RundownSummaryPanel` displays formula with correct signs
- [ ] **WS7**: Unit tests pass
- [ ] All gates pass: `npm run db:types`, `npm run type-check`, `npm test`, `npm run build`
- [ ] No regressions in existing table session tests
