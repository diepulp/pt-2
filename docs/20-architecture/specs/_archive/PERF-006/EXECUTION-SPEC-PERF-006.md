---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline skill (lead-architect scaffolding + expert refinement)

prd: PERF-006
prd_title: "Player 360 Render Cascade — Comprehensive Performance, QA & Accessibility Audit"
service: PlayerService
mvp_phase: 2

workstreams:
  WS1:
    name: "Quick Wins — Performance & Accessibility"
    description: >
      Phase 1 atomic fixes: guard addRecent with early return (P1-3),
      remove refetchOnWindowFocus/refetchInterval from useGamingDaySummary (P1-4),
      conditionally render PlayerEditModal (P3-4), add aria-label to 7 buttons
      + 2 inputs (P0-4), add motion-safe: prefixes to 15+ animations (P2-2),
      add tabular-nums to monetary displays (P2-3). Also includes minor fixes:
      handleShare try/catch + toast (P3-1), transition-all replacement (P4-4),
      useRecentPlayers double-write guard (P4-5), deprecated barrel export cleanup (P4-6).
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - components/player-360/empty-states.tsx
      - hooks/mtl/use-gaming-day-summary.ts
      - components/player-360/header/player-360-header-content.tsx
      - components/player-360/header/add-note-button.tsx
      - components/player-360/header/issue-reward-button.tsx
      - components/player-360/summary/summary-tile.tsx
      - components/player-360/compliance/panel.tsx
      - components/player-360/snapshot/card.tsx
      - components/player-360/skeletons.tsx
      - components/player-360/layout.tsx
      - components/player-360/index.ts
      - components/player-360/sidebar/player-360-sidebar.tsx
    gate: type-check
    estimated_complexity: low

  WS2:
    name: "Error Boundaries & Route Resilience"
    description: >
      Create error.tsx at app/(dashboard)/players/[[...playerId]]/ route segment (P0-1).
      CREATE ErrorState component (does NOT exist — audit assumed it did).
      Create per-panel ErrorBoundary wrapper for LeftRail, Center, RightRail.
      Must align with ADR-012 error flow: error boundaries catch exceptions that
      escape the ServiceResult<T> transport envelope (render errors, null dereferences,
      malformed data). Wire into existing error utilities:
      - lib/errors/error-utils.ts: getErrorMessage(), isRetryableError(), serializeError()
      - lib/errors/domain-errors.ts: isDomainError(), DomainErrorCode
      - docs/70-governance/ERROR_HANDLING_STANDARD.md: logError() for structured logging
      - docs/70-governance/ERROR_TAXONOMY_AND_RESILIENCE.md: domain error catalog
      Consider TanStack Query's QueryErrorResetBoundary for query-related errors.
      Reference forthcoming ADR on frontend error boundary architecture.
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - app/(dashboard)/players/[[...playerId]]/error.tsx
      - components/error-boundary/error-state.tsx
      - components/error-boundary/panel-error-boundary.tsx
      - components/error-boundary/index.ts
    gate: type-check
    estimated_complexity: medium

  WS3:
    name: "State Isolation & Input Validation"
    description: >
      Reset Zustand filter store on playerId change via useEffect in
      Player360ContentWrapper (P0-2). Add UUID format validation for playerId
      in page.tsx before enabling queries — show "Invalid player ID" for
      malformed URLs (P1-5). Depends on WS1 because WS1 modifies
      content-wrapper (addRecent guard) and header (conditional modal).
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - app/(dashboard)/players/[[...playerId]]/_components/player-360-content-wrapper.tsx
      - app/(dashboard)/players/[[...playerId]]/page.tsx
      - lib/validation/uuid.ts
    gate: type-check
    estimated_complexity: low

  WS4:
    name: "Component Architecture Refactor"
    description: >
      Major structural changes to eliminate render cascade (P0-3, P1-2):
      1. Lift usePlayer() to single location in Player360ContentWrapper,
         pass result as prop to header and edit modal (3 files, eliminates
         triple subscription).
      2. Split TimelinePageContent (440 LOC, 7 hooks) into isolated panel
         components: TimelinePanel, SummaryPanel, ChartPanel, CompliancePanel,
         FilterPanel — each with own hook subscriptions.
      3. Add React.memo to GroupedTimeline, ActivityChart, SummaryBand,
         FilterTileStack, CompliancePanel (5 components).
      Depends on WS1 (touches same files) and WS3 (state isolation must
      be in place before refactor).
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS1, WS3]
    outputs:
      - app/(dashboard)/players/[[...playerId]]/_components/player-360-content-wrapper.tsx
      - app/(dashboard)/players/[playerId]/timeline/_components/timeline-content.tsx
      - app/(dashboard)/players/[playerId]/timeline/_components/timeline-panel.tsx
      - app/(dashboard)/players/[playerId]/timeline/_components/summary-panel.tsx
      - app/(dashboard)/players/[playerId]/timeline/_components/chart-panel.tsx
      - app/(dashboard)/players/[playerId]/timeline/_components/compliance-panel.tsx
      - app/(dashboard)/players/[playerId]/timeline/_components/filter-panel.tsx
      - components/player-360/header/player-360-header-content.tsx
      - components/player-dashboard/player-edit-modal.tsx
      - components/player-360/timeline/grouped-timeline.tsx
      - components/player-360/charts/activity-chart.tsx
    gate: type-check
    estimated_complexity: high

  WS5:
    name: "Data Flow & Bundle Optimization"
    description: >
      Optimize data flow and reduce bundle size (P1-1, P3-2, P3-3, P4-1):
      1. Compute gamingDay server-side in page.tsx RSC, pass as prop —
         eliminates useGamingDay() hook and 3-step waterfall cascade.
      2. Convert useAuth to context provider at layout level or TanStack
         Query hook for dedup/caching (eliminates per-mount subscription).
      3. Use Zustand selectors per consumer instead of full-store
         subscription: useTimelineFilterStore(s => s.activeCategory).
      4. Lazy-load ActivityChart with next/dynamic({ ssr: false }) —
         saves ~480KB from initial bundle.
      Depends on WS4 because the refactored component structure determines
      where gamingDay prop flows and selector consumption points.
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS4]
    outputs:
      - app/(dashboard)/players/[[...playerId]]/page.tsx
      - app/(dashboard)/players/[playerId]/timeline/_components/timeline-content.tsx
      - hooks/use-auth.ts
      - hooks/player-360/use-timeline-filter.ts
      - components/player-360/charts/activity-chart.tsx
    gate: type-check
    estimated_complexity: medium

  WS6:
    name: "ARIA Combobox & Advanced Accessibility"
    description: >
      Implement combobox/listbox ARIA pattern for search dropdowns (P2-1):
      role="listbox" on container, role="option" on items, aria-activedescendant,
      ArrowUp/ArrowDown/Enter/Escape keyboard handling. Also:
      - Add aria-live="polite" regions for search results, timeline loading,
        filter changes, error messages (P2-6).
      - Add role="status" + aria-label="Loading" to skeleton/spinner (P2-8).
      - Fix nested <main> landmarks: change Player360Center to
        <div role="region"> (P2-7).
      - Add min-h-[44px] min-w-[44px] to touch targets (P2-5).
      - Fix hydration mismatches from browser API in render (P4-7).
      Depends on WS1 which adds aria-labels to the same header file.
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - components/player-360/header/player-360-header-content.tsx
      - components/player-360/empty-states.tsx
      - components/player-360/skeletons.tsx
      - components/player-360/layout.tsx
      - components/player-360/sidebar/player-360-sidebar.tsx
    gate: type-check
    estimated_complexity: medium

  WS7:
    name: "Integration & E2E Tests"
    description: >
      Validate all prior workstreams with tests (P1-6, P3-5):
      1. Error boundary integration tests — verify error.tsx renders
         recovery UI, per-panel boundaries isolate failures.
      2. Cross-player filter reset tests — verify Zustand store clears
         on playerId navigation.
      3. TimelinePageContent orchestration tests — mock hooks, verify
         render count stays under threshold after refactor.
      4. Fix E2E tautological assertions in player-360-navigation.spec.ts
         and player-360-panels.spec.ts — fail fast when auth unavailable,
         add authenticated test fixtures.
      5. isFavorite persistence test (P4-2) or removal validation.
      Depends on all prior workstreams as tests validate their outputs.
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS2, WS3, WS4, WS5, WS6]
    outputs:
      - components/error-boundary/__tests__/error-boundary.test.tsx
      - components/player-360/__tests__/player-360-content-wrapper.test.tsx
      - components/player-360/__tests__/timeline-content.test.tsx
      - e2e/workflows/player-360-navigation.spec.ts
      - e2e/workflows/player-360-panels.spec.ts
    gate: test-pass
    estimated_complexity: medium

execution_phases:
  - name: "Phase 1 — Quick Wins + Error Boundaries"
    parallel: [WS1, WS2]
    gates: [type-check, lint]

  - name: "Phase 2 — State Isolation + ARIA Combobox"
    parallel: [WS3, WS6]
    gates: [type-check]

  - name: "Phase 3 — Component Architecture Refactor"
    parallel: [WS4]
    gates: [type-check, lint]

  - name: "Phase 4 — Data Flow & Bundle"
    parallel: [WS5]
    gates: [type-check]

  - name: "Phase 5 — Testing"
    parallel: [WS7]
    gates: [test-pass, build]

gates:
  type-check:
    command: "npm run type-check"
    success_criteria: "Exit code 0"
  lint:
    command: "npm run lint"
    success_criteria: "Exit code 0"
  test-pass:
    command: "npm test -- --passWithNoTests"
    success_criteria: "All tests pass"
  build:
    command: "npm run build"
    success_criteria: "Exit code 0"

external_dependencies: []

risks:
  - risk: "WS4 TimelinePageContent split is a major refactor of the most complex file (440 LOC, 7 hooks)"
    mitigation: "WS1 quick wins reduce re-render pressure first; WS3 isolates state before refactor"
  - risk: "WS5 server-side gamingDay requires RSC prop drilling across component boundary"
    mitigation: "WS4 restructures the component tree first, making prop flow cleaner"
  - risk: "WS6 ARIA combobox is complex and may interact with existing search event handlers"
    mitigation: "Runs in Phase 2 before WS4 refactors header; isolated a11y concern"
  - risk: "ErrorState component does not exist despite audit assuming it does"
    mitigation: "WS2 explicitly creates it; aligns with ADR-012 error flow and forthcoming error boundary ADR"
  - risk: "Multiple workstreams modify player-360-header-content.tsx across phases"
    mitigation: "Phase ordering ensures sequential access: WS1 (Phase 1) → WS6 (Phase 2) → WS4 (Phase 3)"

---

# EXECUTION-SPEC: PERF-006 — Player 360 Render Cascade Remediation

## Overview

Remediate 28 findings from the comprehensive Player 360 performance, QA, and accessibility audit. The Player 360 dashboard (`/players/[[...playerId]]`) is the primary player investigation surface. Currently suffers from 10-12 re-renders on cold mount, zero error boundaries, cross-player state leaks, WCAG 2.1 AA violations, and ~480KB eager Recharts import.

## Scope

**In Scope:**
- All 28 audit findings (P0-P4) from PERF-006
- React component refactoring, hook optimization, Zustand store fixes
- Error boundary creation (route-level + per-panel)
- WCAG 2.1 AA accessibility compliance
- Bundle optimization (lazy loading)
- Integration and E2E test coverage for orchestration layer

**Out of Scope:**
- Database migrations (no schema changes)
- RLS policy changes (no security changes)
- New RPCs or API endpoints
- Backend service layer changes
- Changes outside the Player 360 bounded context

## Architecture Context

- **Bounded Context:** Player 360 frontend (components, hooks, stores)
- **Error Handling:** ADR-012 (DomainError at service layer, ServiceResult at transport, error boundaries at client)
- **State Management:** Zustand (ADR-003) + TanStack Query v5
- **Existing Error Utilities:** `lib/errors/error-utils.ts`, `lib/errors/domain-errors.ts`
- **No existing error boundaries** — error.tsx, ErrorState, ErrorBoundary all need creation

## Workstream Details

### WS1: Quick Wins — Performance & Accessibility

**Purpose:** Low-risk, high-impact fixes that reduce noise before major refactors.

**Deliverables:**
1. Guard `addRecent` with `if (prev[0]?.id === id) return prev` (1 line)
2. Remove `refetchOnWindowFocus: true` and `refetchInterval: 60_000` from `useGamingDaySummary`
3. Conditionally render `PlayerEditModal`: `{editModalOpen && <PlayerEditModal />}`
4. Add `aria-label` to 7 icon-only buttons + 2 search inputs
5. Replace `animate-pulse` with `motion-safe:animate-pulse` (~15 instances)
6. Add `tabular-nums` class to monetary display elements
7. Wrap `handleShare` in try/catch with toast feedback
8. Replace `transition-all` with specific property transitions
9. Guard `useRecentPlayers` double-write with ref
10. Remove deprecated exports from barrel file

**Acceptance Criteria:**
- [ ] No unnecessary re-renders from `addRecent` when player is already first
- [ ] `useGamingDaySummary` no longer polls or refetches on window focus
- [ ] `PlayerEditModal` unmounted when closed (0 subscriptions)
- [ ] All 7 buttons + 2 inputs have `aria-label` attributes
- [ ] All animations respect `prefers-reduced-motion`
- [ ] Monetary values use tabular numerals

### WS2: Error Boundaries & Route Resilience

**Purpose:** Prevent white-screen crashes. Provide graceful degradation per panel.

**Deliverables:**
1. `error.tsx` at `app/(dashboard)/players/[[...playerId]]/` with retry capability
2. `ErrorState` component (`components/error-boundary/error-state.tsx`) with:
   - Error message display via `getErrorMessage()`
   - Retry button for retryable errors via `isRetryableError()`
   - Correlation ID display for support escalation
   - Structured logging via `logError()`
3. `PanelErrorBoundary` wrapper for LeftRail, Center, RightRail isolation
4. Integration with `QueryErrorResetBoundary` for TanStack Query errors

**Acceptance Criteria:**
- [ ] Route-level error.tsx catches uncaught exceptions with recovery UI
- [ ] Per-panel error boundaries isolate failures (one panel crash doesn't take down page)
- [ ] Error UI displays user-friendly messages via `getErrorMessage()`
- [ ] Retryable errors show retry button
- [ ] Aligns with ADR-012 error flow architecture

### WS3: State Isolation & Input Validation

**Purpose:** Fix cross-player state leak and prevent malformed API calls.

**Deliverables:**
1. `useEffect` in `Player360ContentWrapper` that calls `clearFilter()` on `playerId` change
2. UUID format validation for `playerId` in `page.tsx` before enabling queries
3. "Invalid player ID" UI for malformed URLs

**Acceptance Criteria:**
- [ ] Navigating between players resets timeline filters
- [ ] Non-UUID playerId values show error, no API calls made
- [ ] Path traversal attempts (`../../admin`) blocked

### WS4: Component Architecture Refactor

**Purpose:** Eliminate render cascade by isolating subscription boundaries.

**Deliverables:**
1. Single `usePlayer()` call in `Player360ContentWrapper`, result passed as prop
2. `TimelinePageContent` split into 5 panel components with isolated subscriptions
3. `React.memo` on 5 key leaf components

**Acceptance Criteria:**
- [ ] Only 1 `usePlayer()` subscription in the entire tree
- [ ] Each panel component has independent hook subscriptions
- [ ] Cold mount re-renders reduced from 10-12 to ~4-5
- [ ] `React.memo` prevents cascade propagation to leaf components

### WS5: Data Flow & Bundle Optimization

**Purpose:** Eliminate gaming-day waterfall, deduplicate auth, optimize bundle.

**Deliverables:**
1. Server-side `gamingDay` computation in RSC, passed as prop
2. `useAuth` converted to context provider or TanStack Query hook
3. Zustand selectors per consumer (granular subscriptions)
4. `ActivityChart` lazy-loaded via `next/dynamic`

**Acceptance Criteria:**
- [ ] `useGamingDay()` hook removed from client — gamingDay arrives as prop
- [ ] Auth state shared via single context/query, not per-mount subscription
- [ ] Zustand consumers subscribe to individual fields only
- [ ] ActivityChart loaded on demand (~480KB saved from initial bundle)

### WS6: ARIA Combobox & Advanced Accessibility

**Purpose:** Full WCAG 2.1 AA compliance for search and dynamic content.

**Deliverables:**
1. Combobox/listbox ARIA pattern for both search dropdowns
2. `aria-live="polite"` regions for dynamic content updates
3. `role="status"` + `aria-label="Loading"` on skeletons/spinners
4. Fix nested `<main>` → `<div role="region">`
5. Touch targets minimum 44x44px
6. Fix hydration mismatches from browser API in render path

**Acceptance Criteria:**
- [ ] Search dropdowns navigable via ArrowUp/Down/Enter/Escape
- [ ] Screen readers announce search results, loading states, filter changes
- [ ] No nested `<main>` landmarks
- [ ] All interactive elements meet 44x44px minimum
- [ ] No hydration mismatches in production build

### WS7: Integration & E2E Tests

**Purpose:** Regression safety net for the most complex code paths.

**Deliverables:**
1. Error boundary integration tests (error.tsx + per-panel)
2. Cross-player filter reset tests
3. `TimelinePageContent` orchestration test with render count verification
4. Fixed E2E tests with real assertions (no tautological if/expect patterns)

**Acceptance Criteria:**
- [ ] Error boundary tests verify recovery UI renders on thrown error
- [ ] Filter reset test verifies store clears on navigation
- [ ] Orchestration test verifies render count < threshold
- [ ] E2E tests fail when auth is unavailable (no vacuous pass)
- [ ] All tests pass in CI

## Definition of Done

- [ ] All 7 workstreams complete
- [ ] All gates pass (type-check, lint, test-pass, build)
- [ ] No regressions in existing tests
- [ ] Cold mount re-renders reduced from 10-12 to ~4-5
- [ ] Zero WCAG 2.1 AA violations in Player 360 route
- [ ] Error boundaries prevent white-screen crashes
- [ ] Cross-player state leak eliminated
- [ ] ~480KB bundle reduction from lazy-loaded Recharts
- [ ] Orchestration layer has test coverage
