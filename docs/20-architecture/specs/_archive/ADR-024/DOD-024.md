# DOD-024: RLS Context Self-Injection Remediation - Definition of Done

**EXEC-SPEC:** [EXEC-SPEC-024.md](./EXEC-SPEC-024.md)
**ADR:** [ADR-024_DECISIONS.md](../../../80-adrs/ADR-024_DECISIONS.md)
**Created:** 2025-12-29

---

## Gates

### Pilot Boundary (Frozen)

Pilot is **not acceptable** if:
- `set_rls_context(...)` is callable by `authenticated` or `PUBLIC`
- staff identity is not bound to `auth.uid()`

Explicitly out of scope for pilot:
- Enterprise multi-tenant model / multi-casino staff
- Must-match RLS everywhere
- CI scanners to detect future `app.*` setters
- Perfect ops lane with auditing

### A) Functional Gates

| ID | Assertion | Test File | CI Command | Status |
|----|-----------|-----------|------------|--------|
| A1 | `set_rls_context_from_staff()` function exists and is callable by authenticated | `services/security/__tests__/rls-context.integration.test.ts` | `npm test -- -t "rls-context-from-staff"` | Pending |
| A2 | Active staff with valid JWT derives context correctly | `services/security/__tests__/rls-context.integration.test.ts` | `npm test -- -t "derives context"` | Pending |
| A3 | Staff lookup falls back to auth.uid() when staff_id claim missing | `services/security/__tests__/rls-context.integration.test.ts` | `npm test -- -t "fallback lookup"` | Pending |
| A4 | All 16 affected RPCs call `set_rls_context_from_staff()` | `services/security/__tests__/rpc-audit.test.ts` | `npm test -- -t "rpc calls new setter"` | Pending |
| A5 | `set_rls_context_internal()` is callable only by service_role | `services/security/__tests__/rls-context.integration.test.ts` | `npm test -- -t "internal setter"` | Pending |
| A6 | Correlation ID is sanitized (special chars stripped, length capped at 64) | `services/security/__tests__/rls-context.test.ts` | `npm test -- -t "correlation sanitized"` | Pending |

### B) Security Gates

| ID | Assertion | Test File | CI Command | Critical |
|----|-----------|-----------|------------|----------|
| B1 | `set_rls_context(uuid,uuid,text,text)` is NOT executable by authenticated | `services/security/__tests__/rls-revoke.integration.test.ts` | `npm test -- -t "deprecated revoked"` | **Yes** |
| B1b | `set_rls_context(uuid,uuid,text,text)` is NOT executable by PUBLIC | `services/security/__tests__/rls-revoke.integration.test.ts` | `npm test -- -t "deprecated revoked public"` | **Yes** |
| B2 | Poisoned session vars are overwritten by authoritative derivation | `services/security/__tests__/rls-spoofing.integration.test.ts` | `npm test -- -t "spoofed context rejected"` | **Yes** |
| B3 | Cross-tenant access is blocked (casino A user cannot access casino B data) | `services/security/__tests__/rls-tenant-isolation.integration.test.ts` | `npm test -- -t "cross-tenant blocked"` | **Yes** |
| B4 | Staff with mismatched `staff_id` claim vs `auth.uid()` is blocked | `services/security/__tests__/rls-context.integration.test.ts` | `npm test -- -t "mismatched claim"` | **Yes** |
| B5 | Inactive staff cannot derive context | `services/security/__tests__/rls-context.integration.test.ts` | `npm test -- -t "inactive staff blocked"` | **Yes** |
| B6 | No client-callable RPC accepts casino_id/actor_id as user input | Code audit | `grep -r "p_casino_id\|p_actor_id" supabase/migrations/ --include="*.sql"` | **Yes** |

### C) Data Integrity Gates

| ID | Assertion | Test File | CI Command | Status |
|----|-----------|-----------|------------|--------|
| C1 | `staff.user_id` has unique constraint | Migration check | `npm run db:types` | Pending |
| C2 | Staff lookup is deterministic (no LIMIT 1 ambiguity) | Code review | Grep for `LIMIT 1` in staff lookups | Pending |
| C3 | Context vars set correctly match staff table values | `services/security/__tests__/rls-context.integration.test.ts` | `npm test -- -t "context matches staff"` | Pending |
| C4 | No duplicate `staff.user_id` rows before constraint | Preflight query | SQL verification | Pending |

### D) Operability Gates

| ID | Assertion | Test File | CI Command | Status |
|----|-----------|-----------|------------|--------|
| D1 | Transaction pooling does not leak context across calls | `services/security/__tests__/rls-pooling.integration.test.ts` | `npm test -- -t "pooling safe"` | Pending |
| D2 | UNAUTHORIZED/FORBIDDEN exceptions are logged with correlation_id | Log inspection | `grep "UNAUTHORIZED\|FORBIDDEN" logs/` | Pending |
| D3 | Performance: staff lookup uses indexed path (no seq scan) | `EXPLAIN ANALYZE` | Manual verification | Pending |
| D4 | Rollback does not re-grant `set_rls_context` to authenticated | Rollback review | Manual verification | Pending |

---

## SQL Verification Queries

### B1: Verify deprecated function is revoked

```sql
-- MUST return false
SELECT has_function_privilege(
  'authenticated',
  'public.set_rls_context(uuid,uuid,text,text)',
  'execute'
);

-- MUST return false
SELECT has_function_privilege(
  'public',
  'public.set_rls_context(uuid,uuid,text,text)',
  'execute'
);
```

### C4: Preflight staff.user_id duplicates

```sql
select user_id, count(*)
from public.staff
where user_id is not null
group by user_id
having count(*) > 1;
```

### B1c: Audit all set_rls_context overloads

```sql
select p.oid::regprocedure as signature,
       r.rolname as role,
       has_function_privilege(r.rolname, p.oid, 'execute') as can_execute
from pg_proc p
join pg_namespace n on n.oid = p.pronamespace
join pg_roles r on r.rolname in ('authenticated', 'public')
where n.nspname = 'public'
  and p.proname = 'set_rls_context';
```

### A1: Verify new function is granted

```sql
-- MUST return true
SELECT has_function_privilege(
  'authenticated',
  'public.set_rls_context_from_staff(text)',
  'execute'
);
```

### A5: Verify internal function is restricted

```sql
-- MUST return false for authenticated
SELECT has_function_privilege(
  'authenticated',
  'public.set_rls_context_internal(uuid,uuid,text,text)',
  'execute'
);

-- MUST return true for service_role
SELECT has_function_privilege(
  'service_role',
  'public.set_rls_context_internal(uuid,uuid,text,text)',
  'execute'
);
```

### C1: Verify unique constraint on staff.user_id

```sql
-- MUST return constraint
SELECT constraint_name
FROM information_schema.table_constraints
WHERE table_name = 'staff'
  AND constraint_type = 'UNIQUE'
  AND constraint_name LIKE '%user_id%';
```

---

## Attack Simulation Test

### B2: Verify context spoofing is blocked

```sql
-- Step 1: Attacker attempts to poison session variables
-- (This should fail after B1 is complete)
SELECT set_rls_context('attacker-id'::uuid, 'target-casino'::uuid, 'admin', NULL);

-- Step 2: Call any affected RPC
SELECT rpc_get_visit_loyalty_summary('some-visit-id'::uuid);

-- Expected: RPC derives context from JWT, ignores poisoned session vars
-- The attack MUST fail with UNAUTHORIZED or return only data for caller's actual casino
```

---

## CI Integration

```bash
# Run all ADR-024 DoD gates
npm test -- -t "ADR-024"

# Run security-critical gates only
npm test -- -t "deprecated revoked|spoofed context|cross-tenant|mismatched claim|inactive staff"

# Run SQL verification
psql -c "SELECT has_function_privilege('authenticated', 'public.set_rls_context(uuid,uuid,text,text)', 'execute');"
# Expected: f (false)
psql -c "SELECT has_function_privilege('public', 'public.set_rls_context(uuid,uuid,text,text)', 'execute');"
# Expected: f (false)
psql -c "select user_id, count(*) from public.staff where user_id is not null group by user_id having count(*) > 1;"
# Expected: no rows
psql -c \"select p.oid::regprocedure as signature, r.rolname as role, has_function_privilege(r.rolname, p.oid, 'execute') as can_execute from pg_proc p join pg_namespace n on n.oid = p.pronamespace join pg_roles r on r.rolname in ('authenticated', 'public') where n.nspname = 'public' and p.proname = 'set_rls_context';\"
# Expected: can_execute = false for all rows
```

---

## Pilot Explicitly Out of Scope

These items are documented as future work and NOT required for ADR-024 closure:

- Enterprise multi-tenant model / multi-casino staff
- Must-match RLS everywhere (Track B migration)
- CI scanners to detect future `app.*` setters
- Perfect ops lane with full auditing

---

## Sign-off Checklist

| Gate Category | All Passing | Reviewer | Date |
|---------------|-------------|----------|------|
| A) Functional | [ ] | | |
| B) Security | [ ] | | |
| C) Data Integrity | [ ] | | |
| D) Operability | [ ] | | |

**Security Review:** Required before merge
**Reviewer:** _________________
**Approved Date:** _________________

---

## References

- EXEC-SPEC: [EXEC-SPEC-024.md](./EXEC-SPEC-024.md)
- ADR: [ADR-024_DECISIONS.md](../../../80-adrs/ADR-024_DECISIONS.md)
