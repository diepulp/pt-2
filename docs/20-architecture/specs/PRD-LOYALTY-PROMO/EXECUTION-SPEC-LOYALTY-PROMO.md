---
# EXECUTION-SPEC Frontmatter
# Generated by lead-architect skill
# Stage 1: Architectural Scaffold (workstream details to be refined by domain experts)

prd: PRD-LOYALTY-PROMO
prd_title: "LoyaltyService Extension - Promotional Instruments (Match Play)"
prd_location: docs/00-vision/loyalty-service-extension/LOYALTY_PROMO_INSTRUMENTS_EXTENSION_v0.1_REDACTED.md
service: LoyaltyService
mvp_phase: 3 # Rewards phase

# SRM Ownership Validation
srm_ownership:
  service: LoyaltyService
  current_tables: [player_loyalty, loyalty_ledger, loyalty_outbox]
  new_tables: [promo_program, promo_coupon]
  bounded_context: "What is this gameplay worth in rewards, and what promotional instruments have been issued?"
  compliance: SRM_UPDATED # SRM v4.9.0 already includes promo_program, promo_coupon in LoyaltyService ownership

# Workstream Definitions
workstreams:
  WS1:
    name: Database Layer (Schema + RLS)
    description: Migration with promo tables, enums, RPCs, and RLS policies
    type: database
    bounded_context: LoyaltyService
    executor: backend-service-builder # Schema design
    executor_type: skill
    rls_expert_consultation: required # RLS policies in same migration
    depends_on: []
    outputs:
      # Details to be refined by backend-service-builder + rls-expert
      - supabase/migrations/YYYYMMDDHHMMSS_loyalty_promo_instruments.sql
    gate: schema-validation
    estimated_complexity: high
    notes: |
      RLS policies MUST be in SAME migration per governance rule.
      Tables: promo_program, promo_coupon
      Enums: promo_type_enum, promo_coupon_status
      RPCs: rpc_issue_promo_coupon, rpc_void_promo_coupon, rpc_replace_promo_coupon, rpc_promo_coupon_inventory
      Promo settings live in casino_settings (CasinoService-owned); coordinate schema changes in CasinoService.
      ADR-024 SECURITY REQUIREMENTS (supersedes ADR-015 self-injection):
        - All RPCs MUST call set_rls_context_from_staff() as first statement (INV-7)
        - RPCs MUST NOT accept casino_id/actor_id as input parameters (INV-8)
        - Context derived authoritatively from JWT + staff table lookup
        - Correlation ID is the ONLY optional parameter allowed
        - RLS policies continue to use current_setting() but are safe because only set_rls_context_from_staff() can set app.* vars

  WS2:
    name: Service Layer Extension
    description: DTOs, mappers, selects, crud extensions for promo instruments
    type: service-layer
    bounded_context: LoyaltyService
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1]
    outputs:
      # Details to be refined by backend-service-builder
      - services/loyalty/dtos.ts
      - services/loyalty/mappers.ts
      - services/loyalty/selects.ts
      - services/loyalty/crud.ts
      - services/loyalty/index.ts

    gate: type-check
    estimated_complexity: medium
    notes: |
      Pattern A DTOs (contract-first with mappers) required.
      Extend existing LoyaltyService factory.
      Use loyalty_outbox for event emission (promo_coupon_issued, etc.)
      IDEMPOTENCY (database-enforced pattern per services/loyalty implementation):
        - Input DTOs: `idempotencyKey: string` required for issueCoupon, voidCoupon, replaceCoupon
        - RPCs: pass as `p_idempotency_key` parameter
        - Database: unique index on `(casino_id, idempotency_key) WHERE idempotency_key IS NOT NULL`
        - Response: return `isExisting: true` for duplicate, route returns HTTP 200 vs 201
        - Key derivation: `${operation}:${validation_number}` (e.g., "issue:ABC123")
      NOTE: backend.instructions.md mentions withIdempotentRetry() but actual codebase uses database-enforced pattern

  WS3:
    name: Route Handlers
    description: API endpoints for promo program and coupon operations
    type: route-handlers
    bounded_context: LoyaltyService
    executor: api-builder
    executor_type: skill
    depends_on: [WS2]
    outputs:
      # Details to be refined by api-builder
      - app/api/v1/promo-programs/route.ts
      - app/api/v1/promo-programs/[id]/route.ts
      - app/api/v1/promo-coupons/route.ts
      - app/api/v1/promo-coupons/[id]/route.ts
      - app/api/v1/promo-coupons/[id]/void/route.ts
      - app/api/v1/promo-coupons/[id]/replace/route.ts
    gate: lint
    estimated_complexity: medium
    notes: |
      ServiceHttpResult contracts required.
      withServerAction middleware.
      Idempotency headers for mutations must use IDEMPOTENCY_HEADER from lib/http/headers.ts (ADR-021).

  WS4:
    name: React Query Hooks
    description: Client-side hooks for promo operations
    type: react-query-hooks
    bounded_context: LoyaltyService
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS2, WS3]
    outputs:
      # Details to be refined by frontend-design-pt-2
      - hooks/loyalty/promo-instruments/index.ts
      - hooks/loyalty/promo-instruments/use-promo-programs.ts
      - hooks/loyalty/promo-instruments/use-promo-coupons.ts
      - hooks/loyalty/promo-instruments/use-promo-mutations.ts
    gate: type-check
    estimated_complexity: low
    notes: |
      Use key factories from services/loyalty/keys.ts
      Cache invalidation on mutations.

  WS5:
    name: Tests
    description: Unit tests, mapper tests, RLS integration tests
    type: unit-tests
    bounded_context: LoyaltyService
    executor: backend-service-builder # Unit tests
    executor_type: skill
    qa_specialist_consultation: recommended # Integration/RLS tests
    depends_on: [WS1, WS2, WS3]
    outputs:
      # Details to be refined by backend-service-builder + qa-specialist
      # ADR-002 test location standard: __tests__/services/
      - __tests__/services/loyalty/promo-instruments.test.ts
      - __tests__/services/loyalty/promo-instruments-mappers.test.ts
      - __tests__/services/loyalty/promo-instruments.int.test.ts

    gate: test-pass
    estimated_complexity: medium
    notes: |
      Coverage target: >=90% for service modules.
      Test naming: *.int.test.ts for integration tests.
      Test location: Root __tests__/services/ (ADR-002).
      RLS tests: Multi-tenant isolation verification.

  WS6:
    name: Alert Thresholds Configuration
    description: Casino-scoped alert thresholds for promo exposure and operational metrics
    type: database
    bounded_context: CasinoService # Settings owned by CasinoService; consumed by LoyaltyService/Dashboards
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1]
    spec_reference: docs/00-vision/loyalty-service-extension/SHIFT_DASHBOARDS_V0_ALERT_THRESHOLDS_BASELINES_PATCH.md
    outputs:
      - supabase/migrations/YYYYMMDDHHMMSS_alert_thresholds_settings.sql # Adds alert_thresholds JSONB to casino_settings
      - services/casino/dtos.ts # Extend CasinoSettingsDTO with AlertThresholdsDTO
      - services/casino/schemas.ts # Zod schema for alert_thresholds validation
    gate: schema-validation
    estimated_complexity: low
    notes: |
      Adds `casino_settings.alert_thresholds` JSONB column (CasinoService-owned).
      v0 alert set per patch doc:
        - Table idle alerts (20m warn, 45m critical)
        - Slip duration alerts (4h warn, 8h critical)
        - Drop anomaly (±3×MAD)
        - Promo issuance spike (+3×MAD)
        - Promo void rate (>5% warn)
        - Outstanding aging (>24h, >$2k or >25 coupons)
      These are operational/presentation controls, NOT accounting policy.
      Baseline method: 7-day median with MAD dispersion.
      Dashboards and LoyaltyService consume read-only.

  WS7:
    name: Promo Exposure Rollup Queries
    description: SQL views/RPCs for shift dashboard promo exposure metrics
    type: database
    bounded_context: LoyaltyService # Owns promo_coupon; provides rollup queries consumed by dashboards
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - supabase/migrations/YYYYMMDDHHMMSS_promo_exposure_rollups.sql # Views or RPC for promo rollups
      - services/loyalty/rollups.ts # TypeScript wrappers for rollup queries
      - services/loyalty/dtos.ts # PromoExposureRollupDTO
    gate: schema-validation
    estimated_complexity: medium
    notes: |
      Provides promo exposure lens for shift dashboards (DoD requirement).
      Rollup metrics (per shift/gaming_day, casino-scoped):
        - total_issued_face_value: SUM(face_value_amount) WHERE status='issued'
        - total_issued_patron_risk: SUM(required_match_wager_amount) WHERE status='issued'
        - outstanding_count: COUNT(*) WHERE status='issued' (uncleared)
        - outstanding_face_value: SUM(face_value_amount) WHERE status='issued'
        - voided_count: COUNT(*) WHERE status='voided'
        - replaced_count: COUNT(*) WHERE status='replaced'
        - expiring_soon_count: COUNT(*) WHERE expires_at < NOW() + interval '24 hours'
      Implementation: Live aggregation queries (SQL view or RPC).
      Materialized views deferred until profiling justifies.
      Separation from cash KPIs: These metrics surface in a dedicated "Promo Lens" section.

  WS8:
    name: Dashboard Promo Lens UI
    description: Frontend components for promo exposure summaries in shift dashboard
    type: react-components
    bounded_context: Dashboard # Consumes LoyaltyService rollups; surfaces in pit dashboard
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS4, WS7]
    outputs:
      - components/dashboard/promo-exposure-panel.tsx # Promo lens summary panel
      - hooks/dashboard/use-promo-exposure.ts # React Query hook for promo rollups
      - hooks/dashboard/keys.ts # Extend key factory with promo rollup keys
    gate: type-check
    estimated_complexity: medium
    notes: |
      Surfaces promo summaries SEPARATELY from cash KPIs (DoD requirement).
      UI requirements:
        - Dedicated "Promo Exposure" panel/section in shift dashboard
        - Metrics displayed: issued face value, patron at-risk, outstanding count/value
        - Alert badges for: expiring soon, high void rate, issuance spike
        - Clear visual separation from Drop/Win/Hold cash metrics
      Consumes: /api/v1/promo-rollups or LoyaltyService rollup queries via WS7
      Location: components/dashboard/promo-exposure-panel.tsx
      Integration point: components/dashboard/pit-dashboard-client.tsx

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Foundation
    parallel: [WS1, WS6]
    gates: [schema-validation]
    description: Database schema, enums, RPCs, RLS policies, alert thresholds config

  - name: Phase 2 - Service Layer + Rollups
    parallel: [WS2, WS7]
    gates: [type-check, schema-validation]
    description: DTOs, mappers, service extensions, promo rollup queries

  - name: Phase 3 - Transport
    parallel: [WS3, WS4]
    gates: [lint, type-check]
    description: Route handlers and React Query hooks (parallel)

  - name: Phase 4 - Dashboard Integration
    parallel: [WS8]
    gates: [type-check]
    description: Promo lens UI components for shift dashboard

  - name: Phase 5 - Testing
    parallel: [WS5]
    gates: [test-pass]
    description: Unit, mapper, and integration tests (includes rollup + UI tests)

# Validation Gates
gates:
  schema-validation:
    command: npm run db:types
    success_criteria: "Exit code 0, no type errors"
    follow_up: npm test schema-verification

  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0"

  lint:
    command: npm run lint:check -- services/loyalty/ app/api/v1/promo-*/
    success_criteria: "Exit code 0, no warnings"

  test-pass:
    command: npm test __tests__/services/loyalty/promo-instruments
    success_criteria: "All tests pass, coverage >=90%"

# External Dependencies
external_dependencies:
  - service: CasinoService
    consumed_via: casino_id FK, casino_settings (promo policy controls), gaming_day computation (if rollups need it)
    required_for: "Casino scoping, promo policy controls, temporal authority"

  - service: VisitService
    consumed_via: visit_id FK (optional)
    required_for: "Visit-tied coupon issuance"

  - service: PlayerService
    consumed_via: player_id FK (optional)
    required_for: "Player-tied coupon issuance"

  - service: CasinoService
    consumed_via: issued_by_staff_id FK (staff table)
    required_for: "Audit trail for issuance"

# Risks and Mitigations
risks:
  - risk: "RLS policy complexity with nullable player_id/visit_id"
    mitigation: "Consult rls-expert for ADR-015 Pattern C (hybrid) implementation with ADR-024 context derivation"

  - risk: "Schema migration conflicts with existing loyalty tables"
    mitigation: "Isolated tables with explicit FKs, test with db:reset"

  - risk: "Shift rollup performance with large coupon volumes"
    mitigation: "Use materialized views or efficient aggregation queries"

# Definition of Done (from PRD)
definition_of_done:
  - "New tables added and RLS-scoped (casino_id)"
  - "Issuance, void, replacement flows implemented with auditability"
  - "Shift rollups updated to include promo exposure + outstanding (uncleared)"
  - "Integration tests: expiry/voiding/replacement, match validation, rollup correctness"
  - "Dashboard/report surfaces promo summaries separately from cash KPIs"
---

# EXECUTION-SPEC: PRD-LOYALTY-PROMO - LoyaltyService Promo Instruments Extension

## Overview

This EXECUTION-SPEC defines the implementation plan for extending LoyaltyService with promotional instrument capabilities (match play coupons). This is NOT a new bounded context but an extension of the existing LoyaltyService domain.

**Key Value:** Enable pit supervisors to issue, track, and manage promotional coupons (match play) with full auditability, while maintaining clear separation between promo exposure metrics and cash KPIs in shift dashboards.

## Scope

### In Scope (v0)

- **Tables**: `promo_program`, `promo_coupon`
- **Enums**: `promo_type_enum`, `promo_coupon_status`
- **Settings**: `casino_settings.promo_require_exact_match`, `casino_settings.promo_allow_anonymous_issuance` (CasinoService-owned, casino-scoped controls)
- **RPCs**: Issuance, void, replacement, inventory query
- **RLS**: Casino-scoped policies with nullable player/visit support
- **Rollups**: Promo exposure lens for shift dashboards via live aggregation queries (optionally via SQL views); materialized views or incremental rollups deferred until profiling justifies.
- **Events**: `loyalty_outbox` integration for `promo_coupon_issued`, etc.
- **Alerts**: Rule-based alerts for issuance spikes, excessive replacements/voids, and approaching expiry volume

### Out of Scope (v0)

- `promo_clearance_event` table (Phase 2+ - external reconciliation)
- `reward_issuance` table (post-v0 reporting convenience only, not required for issuance)
- Settlement/redemption workflows
- Accounting/AGR/tax policy toggles
- Table-attributed redemption tracking

## Architecture Context

### SRM Alignment

| Service        | Current Ownership                              | Extended Ownership             |
| -------------- | ---------------------------------------------- | ------------------------------ |
| LoyaltyService | player_loyalty, loyalty_ledger, loyalty_outbox | + promo_program, promo_coupon |

**Bounded Context Question (extended):** "What is this gameplay worth in rewards, and what promotional instruments have been issued?"
**Issuance Ownership**: LoyaltyService owns promo instrument issuance via `promo_coupon` and related operations.

### Cross-Context Dependencies

```
CasinoService ──[casino_id]──> promo_program, promo_coupon
CasinoService ──[casino_settings]──> promo policy controls (promo_require_exact_match, promo_allow_anonymous_issuance)
PlayerService ──[player_id]──> promo_coupon (optional)
VisitService ──[visit_id]───> promo_coupon (optional)
CasinoService ──[staff_id]──> promo_coupon.issued_by_staff_id (staff table)
```

## Workstream Details

### WS1: Database Layer (Schema + RLS)

**Purpose**: Create database foundation with tables, enums, RPCs, and casino-scoped RLS policies.

**Key Decisions**:

- RLS policies in SAME migration (governance rule)
- RLS policies use `current_setting('app.casino_id')` pattern (no OR trees)
- **ADR-024 Security** (supersedes ADR-015 self-injection):
  - All RPCs MUST call `set_rls_context_from_staff()` as first statement
  - RPCs MUST NOT accept `casino_id`/`actor_id` as input parameters (spoofable)
  - Context derived authoritatively from JWT + `staff` table lookup
  - Only `correlation_id` allowed as optional input parameter
- `validation_number` UNIQUE constraint for coupon identification
- `promo_coupon.status` enum for lifecycle states
- Model promo exposure semantics: `face_value_amount` and `required_match_wager_amount`
- Promo settings live in `casino_settings` (CasinoService-owned); no LoyaltyService settings table in v0

**Domain Expert**: `backend-service-builder` + `rls-expert`

### WS2: Service Layer Extension

**Purpose**: Extend LoyaltyService with promo instrument business logic.

**Key Decisions**:

- Pattern A DTOs (contract-first with mappers)
- Extend existing service factory (not new service)
- Use `loyalty_outbox` for event emission
- Consume CasinoService settings for promo policy enforcement (no local settings table)
- **Idempotency** (database-enforced pattern per `services/loyalty` implementation):
  - Input DTOs require `idempotencyKey: string` for `issueCoupon`, `voidCoupon`, `replaceCoupon`
  - RPCs pass key as `p_idempotency_key` parameter
  - Database enforces uniqueness via partial index on `(casino_id, idempotency_key)`
  - Service returns `isExisting: true` for duplicates; route handler maps to HTTP 200 vs 201
  - Key derivation: `${operation}:${validation_number}` (e.g., `"issue:ABC123"`)

**Domain Expert**: `backend-service-builder`

### WS3: Route Handlers

**Purpose**: API surface for promo operations.

**Key Decisions**:

- RESTful endpoints under /api/v1/promo-\*
- ServiceHttpResult contract
- Idempotency support for mutations
- Audit mutations to `audit_log` with correlation IDs
- Document RBAC roles impacted per SEC-003 and reference SEC-001 policy row

**Domain Expert**: `api-builder`

### WS4: React Query Hooks

**Purpose**: Client-side data fetching for promo UI.

**Key Decisions**:

- Extend existing loyalty key factories
- Proper cache invalidation on mutations

**Domain Expert**: `frontend-design-pt-2`

### WS5: Tests

**Purpose**: Validate implementation correctness.

**Key Decisions**:

- Follow ADR-002 test location standard (**tests**/services/)
- Integration tests for RLS multi-tenant isolation
- Coverage target: >=90%

**Domain Expert**: `backend-service-builder` + `qa-specialist`

### WS6: Alert Thresholds Configuration

**Purpose**: Configure casino-scoped alert thresholds for promo exposure and operational metrics.

**Spec Reference**: `docs/00-vision/loyalty-service-extension/SHIFT_DASHBOARDS_V0_ALERT_THRESHOLDS_BASELINES_PATCH.md`

**Key Decisions**:

- Alert thresholds stored in `casino_settings.alert_thresholds` (JSONB)
- CasinoService owns the schema; Dashboards and LoyaltyService consume read-only
- Operational/presentation controls only — no accounting/AGR/tax policy
- v0 alert categories: table idle, slip lifecycle, drop anomalies, promo exposure (issuance spike, void rate, outstanding aging)
- Baseline method: 7-day median with MAD dispersion; static fallback defaults when insufficient history

**Domain Expert**: `backend-service-builder`

### WS7: Promo Exposure Rollup Queries

**Purpose**: Provide SQL views/RPCs for shift dashboard promo exposure metrics (DoD requirement: "Shift rollups updated to include promo exposure + outstanding").

**Key Decisions**:

- Live aggregation queries (SQL view or RPC) over `promo_coupon` table
- Metrics: issued face value, patron at-risk, outstanding count/value, void/replace counts, expiring soon
- Parameterized by `casino_id`, `gaming_day`, optional `shift_id`
- Materialized views deferred until profiling justifies
- Separation from cash metrics: These are exposed via dedicated "promo lens" queries

**Domain Expert**: `backend-service-builder`

### WS8: Dashboard Promo Lens UI

**Purpose**: Surface promo summaries separately from cash KPIs in shift dashboard (DoD requirement: "Dashboard/report surfaces promo summaries separately from cash KPIs").

**Key Decisions**:

- Dedicated `PromoExposurePanel` component in `components/dashboard/`
- React Query hook for promo rollup data (`use-promo-exposure.ts`)
- Clear visual separation from Drop/Win/Hold cash metrics
- Alert badges for operational thresholds (expiring soon, high void rate, issuance spike)
- Integration point: `pit-dashboard-client.tsx`

**Domain Expert**: `frontend-design-pt-2`

## SRM Status

✅ **SRM v4.9.0 already updated** per ADR-000 (matrix-first flow):

- LoyaltyService owns: `player_loyalty`, `loyalty_ledger`, `loyalty_outbox`, `promo_program`, `promo_coupon`
- Bounded context extended: "What is this gameplay worth in rewards, and what promotional instruments have been issued?"
- See `docs/20-architecture/SERVICE_RESPONSIBILITY_MATRIX.md` lines 102, 342

**Generated by**: lead-architect skill
**Date**: 2026-01-06
**Status**: SCAFFOLD - Pending domain expert refinement
