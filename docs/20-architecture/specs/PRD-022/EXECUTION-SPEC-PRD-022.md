---
# EXECUTION-SPEC Frontmatter
# Generated by lead-architect skill for prd-pipeline

prd: PRD-022
prd_title: "Player 360 Navigation Consolidation"
service: PlayerDashboard
mvp_phase: 1  # Core MVP phase
scope: frontend-only  # No backend, no database, no services

# Workstream Definitions
# All workstreams are frontend-focused (routing, components, navigation)
workstreams:
  WS1:
    name: Player 360 Canonical Route
    description: Create /players/[playerId]/page.tsx as canonical Player 360 entry point
    type: route-page
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    bounded_context: player-360
    outputs:
      - app/(dashboard)/players/[playerId]/page.tsx
      - app/(dashboard)/players/[playerId]/_components/player-360-content.tsx  # Client Component for anchor scroll
    gate: type-check
    estimated_complexity: medium

  WS2:
    name: Timeline Route Handler (308 Redirect)
    description: Replace /players/[playerId]/timeline/page.tsx with route handler for 308 permanent redirect
    type: route-handler
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS1]
    bounded_context: player-360
    outputs:
      - app/(dashboard)/players/[playerId]/timeline/route.ts
    gate: type-check
    estimated_complexity: low

  WS3:
    name: Navigation Utilities
    description: Create returnTo param utilities, breadcrumb component, explicit back-to-search control, and anchor scroll behavior
    type: navigation-utilities
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    bounded_context: navigation
    outputs:
      - lib/navigation/return-to.ts
      - lib/navigation/index.ts  # Barrel export
      - components/player-360/breadcrumb.tsx
    gate: type-check
    estimated_complexity: medium

  WS4:
    name: Dashboard Demotion
    description: Convert /players to lookup-only surface, remove detail panel rendering
    type: react-components
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS1, WS3]
    bounded_context: player-dashboard
    outputs:
      - components/player-dashboard/player-dashboard.tsx
      - components/player-dashboard/player-list-row.tsx
    gate: type-check
    estimated_complexity: high

  WS5:
    name: Zustand Store Modification
    description: Modify player-dashboard-store to remove detail panel state, keep only row highlight
    type: zustand-stores
    executor: typescript-pro
    executor_type: task-agent
    depends_on: [WS4]
    bounded_context: state-management
    outputs:
      - store/player-dashboard-store.ts
      - hooks/ui/use-player-dashboard.ts
    gate: type-check
    estimated_complexity: low

  WS6:
    name: Query Key Registry
    description: Create shared player-360 query key registry for de-duplication per DoD
    type: react-query-hooks
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    bounded_context: data-fetching
    outputs:
      - hooks/player-360/keys.ts
      - hooks/player-360/index.ts
    gate: type-check
    estimated_complexity: low

  WS7:
    name: ESLint Configuration
    description: Add no-restricted-imports rule to prevent detail panel imports from player-dashboard
    type: eslint-config
    executor: typescript-pro
    executor_type: task-agent
    depends_on: [WS4]
    bounded_context: governance
    outputs:
      - eslint.config.mjs
    gate: lint
    estimated_complexity: low

  WS8:
    name: Component Consolidation
    description: Move/align detail panels into player-360 ownership before cleanup
    type: react-components
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS1]
    bounded_context: player-360
    outputs:
      - components/player-360/**  # Consolidated panel components
    gate: type-check
    estimated_complexity: medium

  WS9:
    name: Component Cleanup
    description: Remove deprecated detail panels from player-dashboard, update index exports
    type: react-components
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS4, WS7, WS8]
    bounded_context: player-dashboard
    outputs:
      - components/player-dashboard/index.ts
    gate: type-check
    estimated_complexity: medium

  WS10:
    name: Unit + Integration Tests
    description: Unit tests for utilities/components and integration tests for navigation flow
    type: tests
    executor: typescript-pro
    executor_type: task-agent
    depends_on: [WS1, WS2, WS3, WS4, WS5]
    bounded_context: testing
    outputs:
      - lib/navigation/__tests__/return-to.test.ts
      - components/player-360/__tests__/breadcrumb.test.tsx
      - hooks/ui/__tests__/use-player-dashboard.test.ts
      - __tests__/player-360-navigation.int.test.ts
    gate: test-pass
    estimated_complexity: high

  WS11:
    name: E2E Navigation Tests
    description: Playwright tests for navigation flow per DoD checklist
    type: e2e-tests
    executor: e2e-testing
    executor_type: skill
    depends_on: [WS1, WS2, WS3, WS4, WS5]
    bounded_context: testing
    outputs:
      - e2e/workflows/player-360-navigation.spec.ts
    gate: test-pass
    estimated_complexity: high

  WS12:
    name: CODEOWNERS Update
    description: Enforce Player 360 ownership for player-360 components
    type: governance
    executor: typescript-pro
    executor_type: task-agent
    depends_on: [WS8]
    bounded_context: governance
    outputs:
      - .github/CODEOWNERS
    gate: lint
    estimated_complexity: low

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Foundation
    description: Create canonical route, navigation utilities, and query key registry
    parallel: [WS1, WS3, WS6]
    gates: [type-check]

  - name: Phase 2 - Route Consolidation
    description: Add redirect handler and demote dashboard
    parallel: [WS2, WS4]
    gates: [type-check]

  - name: Phase 3 - State & Config
    description: Modify Zustand store and configure ESLint
    parallel: [WS5, WS7, WS12]
    gates: [type-check, lint]

  - name: Phase 4 - Consolidation & Cleanup
    description: Consolidate panels into player-360 and remove deprecated dashboard panels
    parallel: [WS8, WS9]
    gates: [type-check]

  - name: Phase 5 - Tests
    description: Unit and integration tests for navigation and state
    parallel: [WS10]
    gates: [test-pass]

  - name: Phase 6 - E2E Validation
    description: End-to-end navigation flow tests
    parallel: [WS11]
    gates: [test-pass]

# Validation Gates
gates:
  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0"

  lint:
    command: npm run lint
    success_criteria: "Exit code 0, no errors (warnings OK)"

  test-pass:
    command: npm test
    success_criteria: "All tests pass"

  build:
    command: npm run build
    success_criteria: "Exit code 0, no build errors"

# No external dependencies - frontend-only PRD
external_dependencies: []

# Risks and Mitigations
risks:
  - risk: "Breaking existing bookmarks to /players/[playerId]/timeline"
    mitigation: "HTTP 308 permanent redirect preserves intent and anchor contract"

  - risk: "Component imports may break after cleanup"
    mitigation: "ESLint rule prevents drift; phased execution ensures no orphan imports"

  - risk: "Zustand state access in components may cause runtime errors"
    mitigation: "Unit tests validate store interface compatibility"

  - risk: "Panels removed before being consolidated into player-360"
    mitigation: "WS8 consolidates panels before WS9 cleanup; verify Player 360 renders all panels"

  - risk: "returnTo drops query params during navigation"
    mitigation: "Use pathname + search when encoding returnTo; integration tests validate round-trip"

---

# EXECUTION-SPEC: PRD-022 - Player 360 Navigation Consolidation

## Overview

This EXECUTION-SPEC orchestrates the consolidation of player navigation surfaces in PT-2. The goal is to establish `/players/[playerId]` as the single canonical player detail surface, converting `/players` to a lookup-only surface.

**Key Principle:** This is a **frontend-only** PRD. No database migrations, service layer changes, or RPC modifications are in scope.

## Scope

### In Scope
- Create `/players/[playerId]/page.tsx` as Player 360 canonical entry
- Convert `/players` to lookup-only (search, filter, list, recents)
- Replace Zustand `selectedPlayerId` → detail rendering with `router.push()`
- Consolidate detail panels into `components/player-360/**` ownership
- Add 308 redirect: `/players/[playerId]/timeline` → `/players/[playerId]#timeline`
- Implement breadcrumbs and explicit "Back to search" control with `returnTo` param
- Configure ESLint `no-restricted-imports` rule
- Create shared query key registry for Player 360

### Out of Scope
- Database migrations or schema changes
- Service layer modifications
- RPC or API changes
- New bounded contexts
- Player 360 panel enhancements (covered by ADR-029)

## Architecture Context

**Context alignment:** PRD-022 lists `PlayerService` as the bounded context for data consumption. This execution spec is frontend-only and limits changes to `player-360`, `player-dashboard`, `navigation`, and `state-management` surfaces with **no** service layer changes.

### Bounded Contexts Affected

| Context | Role | Changes |
|---------|------|---------|
| `player-360` | Canonical detail surface | New canonical route, breadcrumb |
| `player-dashboard` | Lookup surface | Demoted to search-only |
| `state-management` | Zustand stores | Remove detail panel state |
| `navigation` | URL-based routing | returnTo param utilities |

### Component Ownership Transfer

**FROM `components/player-dashboard/`:**
- `PlayerProfilePanel` → Deprecated (use player-360 SnapshotCard)
- `NotesPanel` → Deprecated (use player-360 CollaborationPanel)
- `MetricsPanel` → Deprecated
- `CompliancePanel` → Deprecated (use player-360 CompliancePanel)
- `ActivityVisualizationPanel` → Deprecated (use timeline)
- `LoyaltyPanel` → Deprecated
- `SessionControlPanel` → Deprecated

**KEPT in `components/player-dashboard/`:**
- `PlayerSearchCommand` → Kept (lookup surface)
- `PlayerDashboard` → Modified to lookup-only

**Consolidation rule:** Any panel still owned by `player-dashboard` must be moved into `player-360` **before** deletion to avoid data loss or missing panels.

### URL Patterns (Post-Implementation)

| Route | Surface | Purpose |
|-------|---------|---------|
| `/players` | Lookup | Search, filter, list |
| `/players?query=smith` | Lookup | Filtered search |
| `/players/[playerId]` | Player 360 | Canonical detail |
| `/players/[playerId]?returnTo=...` | Player 360 | With return context |
| `/players/[playerId]#timeline` | Player 360 | With anchor scroll |
| `/players/[playerId]/timeline` | Route Handler | 308 → `/players/[playerId]#timeline` |

## Workstream Details

### WS1: Player 360 Canonical Route

**Purpose:** Create the canonical Player 360 entry point at `/players/[playerId]/page.tsx`.

**Key Requirements:**
- Server Component with async params (Next.js 15 pattern)
- Wrap with `Player360LayoutProvider`
- Render existing Player360Layout with timeline content
- Support `#timeline` anchor scroll on mount
- Support `returnTo` query param for "Back to search"

**Implementation Pattern (Expert Refinement):**

1. **Server Component** (`page.tsx`): Handles params, wraps layout
```typescript
// app/(dashboard)/players/[playerId]/page.tsx
import { Suspense } from "react";
import { Player360Layout, Player360LayoutProvider, DashboardSkeleton } from "@/components/player-360";
import { Player360Content } from "./_components/player-360-content";

interface PageProps {
  params: Promise<{ playerId: string }>;
  searchParams: Promise<{ returnTo?: string }>;
}

export default async function Player360Page({ params, searchParams }: PageProps) {
  const { playerId } = await params;
  const { returnTo } = await searchParams;

  return (
    <Player360LayoutProvider playerId={playerId}>
      <Player360Layout className="h-[calc(100vh-4rem-3rem)]">
        <Suspense fallback={<DashboardSkeleton />}>
          <Player360Content playerId={playerId} returnTo={returnTo} />
        </Suspense>
      </Player360Layout>
    </Player360LayoutProvider>
  );
}
```

2. **Client Component** (`_components/player-360-content.tsx`): Handles anchor scroll
```typescript
"use client";
import { useEffect } from "react";
import { TimelinePageContent } from "../timeline/_components/timeline-content"; // Reuse existing

interface Props {
  playerId: string;
  returnTo?: string;
}

export function Player360Content({ playerId, returnTo }: Props) {
  // Anchor scroll on mount
  useEffect(() => {
    if (typeof window !== "undefined" && window.location.hash === "#timeline") {
      const el = document.getElementById("timeline");
      el?.scrollIntoView({ behavior: "smooth" });
    }
  }, []);

  return <TimelinePageContent playerId={playerId} />;
}
```

**Data-testid attributes:**
- `data-testid="player-360-page"` on main container
- `data-testid="timeline-section"` on timeline panel (for anchor scroll target)

**Acceptance Criteria:**
- [ ] `/players/[playerId]` renders Player 360 with all panels
- [ ] `#timeline` anchor scrolls to timeline section on load
- [ ] Route params use Next.js 15 Promise pattern
- [ ] Reuses existing `TimelinePageContent` component

### WS2: Timeline Route Handler (308 Redirect)

**Purpose:** Replace the existing timeline page with a route handler that issues HTTP 308 permanent redirect.

**Key Requirements:**
- Use `route.ts` (NOT `page.tsx` with `redirect()`)
- Return `NextResponse.redirect(url, 308)`
- Include `#timeline` anchor in redirect target
- **Preserve query params** in redirect (e.g., `?returnTo=...`)
- Delete existing `page.tsx` and `_components/`

**Implementation (Expert Refinement):**
```typescript
// app/(dashboard)/players/[playerId]/timeline/route.ts
import { NextRequest, NextResponse } from 'next/server';

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ playerId: string }> }
) {
  const { playerId } = await params;
  const url = new URL(`/players/${playerId}`, request.url);

  // Preserve query params from original request
  request.nextUrl.searchParams.forEach((value, key) => {
    url.searchParams.set(key, value);
  });

  url.hash = 'timeline';
  return NextResponse.redirect(url, 308);
}
```

**Files to Delete:**
- `app/(dashboard)/players/[playerId]/timeline/page.tsx`
- `app/(dashboard)/players/[playerId]/timeline/_components/` (entire directory)

**Acceptance Criteria:**
- [ ] GET `/players/[playerId]/timeline` returns HTTP 308
- [ ] `Location` header points to `/players/[playerId]#timeline`
- [ ] Query params preserved in redirect (e.g., `?returnTo=...`)
- [ ] Existing page.tsx and _components/ deleted

### WS3: Navigation Utilities

**Purpose:** Create utilities for returnTo param handling and breadcrumb component.

**Key Deliverables:**

1. **returnTo utilities** (`lib/navigation/return-to.ts`):
   - `encodeReturnTo(path: string): string` - URL-encode the return path
   - `decodeReturnTo(encoded: string | null): string` - Decode and validate
   - `validateReturnTo(path: string): boolean` - Security-first validation

2. **Barrel export** (`lib/navigation/index.ts`):
   - Re-export all utilities for clean imports

3. **Breadcrumb component** (`components/player-360/breadcrumb.tsx`):
   - Display: `Players → {Player Name}`
   - Click "Players" → navigate to returnTo or `/players`
   - Includes explicit **"Back to search"** control (text button/link) adjacent to breadcrumb
   - Both breadcrumb and back control resolve to the same validated returnTo target
   - Client component for `useSearchParams()` access

**Implementation Pattern (Expert Refinement):**

```typescript
// lib/navigation/return-to.ts
const VALID_PREFIX = '/players';
const DEFAULT_RETURN = '/players';

/**
 * Encode a return path for use in URL query params.
 * Only encodes paths that pass validation.
 */
export function encodeReturnTo(path: string): string {
  if (!validateReturnTo(path)) return encodeURIComponent(DEFAULT_RETURN);
  return encodeURIComponent(path);
}

/**
 * Decode and validate a returnTo param.
 * Returns DEFAULT_RETURN if invalid or missing.
 */
export function decodeReturnTo(encoded: string | null | undefined): string {
  if (!encoded) return DEFAULT_RETURN;
  try {
    const decoded = decodeURIComponent(encoded);
    return validateReturnTo(decoded) ? decoded : DEFAULT_RETURN;
  } catch {
    return DEFAULT_RETURN;
  }
}

/**
 * Security-first validation for returnTo paths.
 * Rejects open redirect attempts and path traversal.
 */
export function validateReturnTo(path: string): boolean {
  // Must start with valid prefix
  if (!path.startsWith(VALID_PREFIX)) return false;
  // Reject protocol-relative URLs (open redirect)
  if (path.startsWith('//')) return false;
  // Reject path traversal attempts
  if (path.includes('..')) return false;
  // Reject URLs with protocols
  if (/^[a-z]+:/i.test(path)) return false;
  return true;
}

/**
 * Build Player 360 URL with returnTo param.
 */
export function buildPlayerDetailUrl(playerId: string, returnTo?: string): string {
  const base = `/players/${playerId}`;
  if (!returnTo) return base;
  return `${base}?returnTo=${encodeReturnTo(returnTo)}`;
}
```

**Data-testid attributes:**
- `data-testid="player-breadcrumb"` on breadcrumb container
- `data-testid="breadcrumb-players-link"` on "Players" link
- `data-testid="back-to-search"` on explicit "Back to search" control

**Acceptance Criteria:**
- [ ] `validateReturnTo` rejects paths not starting with `/players`
- [ ] `validateReturnTo` rejects `//evil.com` (open redirect)
- [ ] `validateReturnTo` rejects `../etc/passwd` (path traversal)
- [ ] Invalid `returnTo` falls back to `/players`
- [ ] Breadcrumb renders player name dynamically
- [ ] "Back to search" control is visible and navigates to returnTo or `/players`

### WS4: Dashboard Demotion

**Purpose:** Convert `/players` from detail surface to lookup-only surface.

**Key Changes to `PlayerDashboard`:**
1. Remove conditional detail panel rendering
2. Keep `PlayerSearchCommand` for search functionality
3. Add `PlayerListRow` component with click → `router.push()`
4. Pass `returnTo` in navigation URL using `pathname + search` to preserve filters

**Lookup-Only Rule Enforcement:**
- MUST NOT render any component that fetches data using `playerId` as query key
- MAY only render data from search/list response

**Implementation Pattern (Expert Refinement):**

```typescript
// components/player-dashboard/player-list-row.tsx
"use client";
import { useRouter, usePathname, useSearchParams } from "next/navigation";
import { buildPlayerDetailUrl } from "@/lib/navigation";
import type { PlayerSearchResultDTO } from "@/services/player";

interface Props {
  player: PlayerSearchResultDTO;
  isSelected?: boolean;
}

export function PlayerListRow({ player, isSelected }: Props) {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();

  const handleClick = () => {
    // Capture current location as returnTo
    const currentUrl = pathname + (searchParams.toString() ? `?${searchParams}` : '');
    router.push(buildPlayerDetailUrl(player.id, currentUrl));
  };

  return (
    <tr
      onClick={handleClick}
      data-testid={`player-row-${player.id}`}
      data-selected={isSelected}
      className={cn(
        "cursor-pointer hover:bg-muted/50",
        isSelected && "bg-muted"
      )}
    >
      {/* Row content */}
    </tr>
  );
}
```

**Data-testid attributes:**
- `data-testid="player-list"` on list container
- `data-testid="player-row-{playerId}"` on each row

**Acceptance Criteria:**
- [ ] No detail panels render in `/players` when player selected
- [ ] Row click navigates to `/players/[playerId]?returnTo=...`
- [ ] Search functionality preserved
- [ ] `returnTo` includes current query params (e.g., `?query=smith`)

### WS5: Zustand Store Modification

**Purpose:** Simplify Zustand store to remove detail panel state.

**Current State:**
```typescript
interface PlayerDashboardStore {
  selectedPlayerId: string | null;
  setSelectedPlayer: (id: string | null) => void;
  clearSelection: () => void;
}
```

**Target State (Expert Refinement):**
- Store interface already compatible for row highlight ONLY
- Add JSDoc clarification that `selectedPlayerId` is for highlight, not detail rendering
- No code changes required beyond documentation

```typescript
// store/player-dashboard-store.ts
/**
 * Player Dashboard Store
 *
 * IMPORTANT: selectedPlayerId is for ROW HIGHLIGHT only.
 * Detail panel rendering is handled by route-based navigation.
 * See PRD-022 for navigation consolidation.
 */
export interface PlayerDashboardStore {
  /** Selected player ID for row highlight in list view (NOT for detail panel) */
  selectedPlayerId: string | null;
  setSelectedPlayer: (id: string | null) => void;
  clearSelection: () => void;
}
```

**Acceptance Criteria:**
- [ ] Store interface unchanged (backward compatible for highlight)
- [ ] JSDoc clarifies row-highlight-only purpose
- [ ] No state drives detail panel rendering
- [ ] DevTools shows clean state transitions

### WS6: Query Key Registry

**Purpose:** Create shared query key registry for Player 360 panels per DoD requirement.

**Files:**
- `hooks/player-360/keys.ts` - Key factory
- `hooks/player-360/index.ts` - Barrel export

**Implementation (Expert Refinement):**

```typescript
// hooks/player-360/keys.ts
/**
 * Player 360 Query Key Factory
 *
 * Follows pattern from services/player/keys.ts.
 * Enables React Query deduplication across panels.
 *
 * @see PRD-022 Definition of Done - shared query key registry
 */

const ROOT = ['player-360'] as const;

export const player360Keys = {
  /** Root key for all player-360 queries */
  root: ROOT,

  /** All queries for a specific player */
  all: (playerId: string) => [...ROOT, playerId] as const,

  /** Player profile/snapshot data */
  profile: (playerId: string) => [...ROOT, playerId, 'profile'] as const,

  /** Interaction timeline */
  timeline: (playerId: string) => [...ROOT, playerId, 'timeline'] as const,

  /** Collaboration notes */
  notes: (playerId: string) => [...ROOT, playerId, 'notes'] as const,

  /** Player tags */
  tags: (playerId: string) => [...ROOT, playerId, 'tags'] as const,

  /** Metrics/KPIs */
  metrics: (playerId: string) => [...ROOT, playerId, 'metrics'] as const,

  /** Compliance (CTR/MTL) */
  compliance: (playerId: string) => [...ROOT, playerId, 'compliance'] as const,

  /** Loyalty rewards */
  loyalty: (playerId: string) => [...ROOT, playerId, 'loyalty'] as const,
} as const;
```

```typescript
// hooks/player-360/index.ts
export { player360Keys } from './keys';
```

**Acceptance Criteria:**
- [ ] All Player 360 panels use keys from registry
- [ ] React Query deduplicates fetches across panels
- [ ] Verified via React Query DevTools
- [ ] Pattern matches existing `services/player/keys.ts`

### WS7: ESLint Configuration

**Purpose:** Add `no-restricted-imports` rule to prevent drift.

**Configuration (Expert Refinement):**

Insert in `eslint.config.mjs` **before test overrides** (to avoid affecting test files):

```javascript
// eslint.config.mjs - insert in base config block
{
  files: ['**/*.ts', '**/*.tsx'],
  // ... existing rules
  rules: {
    // ... existing rules
    'no-restricted-imports': ['error', {
      patterns: [
        {
          group: [
            '@/components/player-dashboard/*Panel*',
            '@/components/player-dashboard/*Notes*',
            '@/components/player-dashboard/*Metrics*',
            '@/components/player-dashboard/*Compliance*',
            '@/components/player-dashboard/*Activity*',
            '@/components/player-dashboard/*Timeline*',
            '@/components/player-dashboard/*Profile*',
            '@/components/player-dashboard/*Loyalty*',
            '@/components/player-dashboard/*Session*'
          ],
          message: 'Detail panels must be imported from components/player-360/. See PRD-022.'
        }
      ]
    }]
  }
}
```

**Insertion Location:** After base TypeScript config, before test file overrides.

**Acceptance Criteria:**
- [ ] `npm run lint` fails if panel imported from player-dashboard
- [ ] Error message references PRD-022
- [ ] Rule does not affect test files (scoped to production code)

### WS8: Component Consolidation

**Purpose:** Ensure all canonical detail panels are owned by `components/player-360/` before removal from dashboard.

**Expert Analysis - Minimal Work Required:**

Existing `components/player-360/` already provides:
- `SnapshotCard` / `CompactSnapshot` → Profile functionality
- `CollaborationPanel` → Notes and tags
- `CompliancePanel` → CTR/MTL status
- `TimelineCard` / `TimelineList` → Activity timeline
- `MetricsGrid` → Metrics display

The `player-dashboard` panels are **duplicates** or **legacy** implementations that are no longer needed. The Player 360 route (WS1) uses `TimelinePageContent` which already renders the canonical layout.

**Key Requirements:**
- Verify `components/player-360/index.ts` exports all needed components
- Verify `/players/[playerId]` renders correctly with existing components
- No component moves required if Player 360 already has equivalent functionality

**Panel Mapping:**
| Legacy (player-dashboard) | Canonical (player-360) | Action |
|---------------------------|------------------------|--------|
| `PlayerProfilePanel` | `SnapshotCard` | No move needed |
| `NotesPanel` | `CollaborationPanel` | No move needed |
| `MetricsPanel` | `MetricsGrid` | No move needed |
| `CompliancePanel` | `CompliancePanel` | No move needed |
| `ActivityVisualizationPanel` | `TimelineList` | No move needed |
| `LoyaltyPanel` | (in CollaborationPanel) | No move needed |
| `SessionControlPanel` | (in layout) | No move needed |

**Acceptance Criteria:**
- [ ] All detail panels render from `components/player-360/**`
- [ ] No `player-dashboard` panel is required for `/players/[playerId]`
- [ ] Player 360 layout renders canonical panels without missing sections
- [ ] Verified by visual inspection and E2E tests

### WS9: Component Cleanup

**Purpose:** Remove deprecated components from player-dashboard after consolidation.

**Files to Delete (Expert Refinement):**
- `components/player-dashboard/player-profile-panel.tsx`
- `components/player-dashboard/notes-panel.tsx`
- `components/player-dashboard/metrics-panel.tsx`
- `components/player-dashboard/compliance-panel.tsx`
- `components/player-dashboard/activity-visualization-panel.tsx`
- `components/player-dashboard/loyalty-panel.tsx`
- `components/player-dashboard/session-control-panel.tsx`

**Update `index.ts` to export only:**
- `PlayerDashboard` - Modified lookup-only dashboard
- `PlayerSearchCommand` - Search functionality
- `PlayerListRow` - New row component (from WS4)

```typescript
// components/player-dashboard/index.ts
export { PlayerDashboard } from './player-dashboard';
export { PlayerSearchCommand } from './player-search-command';
export { PlayerListRow } from './player-list-row';
```

**Pre-Cleanup Verification:**
1. Run `grep -r "player-dashboard.*Panel" --include="*.tsx" --include="*.ts"` to find orphan imports
2. Fix any remaining imports before deleting files

**Acceptance Criteria:**
- [ ] No `*Panel` exports from player-dashboard/index.ts
- [ ] CI grep tripwire passes
- [ ] No orphan imports in codebase
- [ ] `PlayerListRow` exported from index

### WS10: Unit + Integration Tests

**Purpose:** Test utilities/components and core navigation flows in Jest.

**Test Files (Expert Refinement):**

1. **`lib/navigation/__tests__/return-to.test.ts`** - Security-focused:
   ```typescript
   describe('validateReturnTo', () => {
     it('accepts valid /players paths', () => {
       expect(validateReturnTo('/players')).toBe(true);
       expect(validateReturnTo('/players?query=smith')).toBe(true);
       expect(validateReturnTo('/players/abc-123')).toBe(true);
     });

     it('rejects open redirect attempts', () => {
       expect(validateReturnTo('//evil.com')).toBe(false);
       expect(validateReturnTo('//evil.com/players')).toBe(false);
     });

     it('rejects path traversal', () => {
       expect(validateReturnTo('/players/../etc/passwd')).toBe(false);
       expect(validateReturnTo('/players/..%2F..%2Fetc')).toBe(false);
     });

     it('rejects protocol URLs', () => {
       expect(validateReturnTo('https://evil.com/players')).toBe(false);
       expect(validateReturnTo('javascript:alert(1)')).toBe(false);
     });

     it('rejects non-players paths', () => {
       expect(validateReturnTo('/admin')).toBe(false);
       expect(validateReturnTo('/settings')).toBe(false);
     });
   });
   ```

2. **`components/player-360/__tests__/breadcrumb.test.tsx`**:
   - Renders player name
   - Click navigates correctly
   - Handles missing returnTo
   - "Back to search" control visible and functional
   - Validates returnTo before navigation

3. **`hooks/ui/__tests__/use-player-dashboard.test.ts`**:
   - Selection drives row highlight only
   - No detail panel state dependencies

4. **`__tests__/player-360-navigation.int.test.ts`** (note: `.int.test.ts` per naming convention):
   - Search → click row → returnTo encoded in URL
   - Back to search uses returnTo or falls back to `/players`
   - `/players/[playerId]/timeline` responds with 308 and `Location` header to `#timeline`
   - Invalid returnTo (e.g., `//evil.com`) falls back to `/players`
   - Query params survive round-trip

**Acceptance Criteria:**
- [ ] return-to utilities fully covered with security scenarios
- [ ] Breadcrumb/back control renders and navigates correctly
- [ ] usePlayerDashboard no longer drives detail panel rendering
- [ ] Navigation integration tests pass
- [ ] Security validation tests for open redirect and path traversal

### WS11: E2E Navigation Tests

**Purpose:** Validate full navigation flow per DoD checklist.

**File:** `e2e/workflows/player-360-navigation.spec.ts`

**Test Structure (Expert Refinement):**

```typescript
import { test, expect } from '@playwright/test';

test.describe('Player 360 Navigation', () => {
  test.describe('Search to Detail Flow', () => {
    test('row click navigates with returnTo param', async ({ page }) => {
      await page.goto('/players?query=smith');
      await page.click('[data-testid="player-row-abc-123"]');
      await expect(page).toHaveURL(/\/players\/abc-123\?returnTo=/);
    });

    test('returnTo preserves query params', async ({ page }) => {
      await page.goto('/players?query=smith&filter=active');
      await page.click('[data-testid="player-row-abc-123"]');
      // returnTo should include original query params
      const url = new URL(page.url());
      const returnTo = decodeURIComponent(url.searchParams.get('returnTo') || '');
      expect(returnTo).toContain('query=smith');
    });
  });

  test.describe('Timeline Redirect (308)', () => {
    test('returns HTTP 308 with correct Location', async ({ request }) => {
      const response = await request.get('/players/abc-123/timeline', {
        redirect: 'manual'
      });
      expect(response.status()).toBe(308);
      expect(response.headers()['location']).toContain('/players/abc-123#timeline');
    });

    test('preserves query params in redirect', async ({ request }) => {
      const response = await request.get('/players/abc-123/timeline?returnTo=...', {
        redirect: 'manual'
      });
      expect(response.headers()['location']).toContain('returnTo=');
    });
  });

  test.describe('Back to Search', () => {
    test('decodes returnTo and navigates to origin', async ({ page }) => {
      const returnTo = encodeURIComponent('/players?query=smith');
      await page.goto(`/players/abc-123?returnTo=${returnTo}`);
      await page.click('[data-testid="back-to-search"]');
      await expect(page).toHaveURL('/players?query=smith');
    });

    test('falls back to /players for invalid returnTo', async ({ page }) => {
      await page.goto('/players/abc-123?returnTo=//evil.com');
      await page.click('[data-testid="back-to-search"]');
      await expect(page).toHaveURL('/players');
    });
  });

  test.describe('Browser History', () => {
    test('back/forward navigation works correctly', async ({ page }) => {
      await page.goto('/players');
      await page.click('[data-testid="player-row-abc-123"]');
      await expect(page).toHaveURL(/\/players\/abc-123/);
      await page.goBack();
      await expect(page).toHaveURL('/players');
      await page.goForward();
      await expect(page).toHaveURL(/\/players\/abc-123/);
    });
  });
});
```

**Required data-testid attributes (from WS3, WS4):**
- `data-testid="player-row-{playerId}"` - Player list rows
- `data-testid="back-to-search"` - Back navigation control
- `data-testid="player-breadcrumb"` - Breadcrumb container

**Acceptance Criteria:**
- [ ] All E2E scenarios pass
- [ ] HTTP 308 verified with `redirect: 'manual'`
- [ ] Security validation for returnTo
- [ ] Browser history navigation works
- [ ] Query params survive round-trip

### WS12: CODEOWNERS Update

**Purpose:** Enforce Player 360 ownership for canonical detail components.

**Expert Analysis:**
`.github/CODEOWNERS` already has a placeholder entry for `components/player-360/**`. Task is to verify and update the owner if needed.

**Key Requirements:**
- Verify `.github/CODEOWNERS` entry for `components/player-360/**`
- Update owner to appropriate team/individual
- Add entry for `lib/navigation/**` (new navigation utilities)

**Example Entry:**
```
# Player 360 components - PRD-022
/components/player-360/**  @pt2-frontend-team
/lib/navigation/**         @pt2-frontend-team
```

**Acceptance Criteria:**
- [ ] `.github/CODEOWNERS` includes `components/player-360/**`
- [ ] `.github/CODEOWNERS` includes `lib/navigation/**`
- [ ] Ownership aligns with PRD-022 governance requirements

## Definition of Done

- [ ] All workstreams complete (WS1-WS12)
- [ ] All gates pass (type-check, lint, test-pass, build)
- [ ] No regressions in existing tests
- [ ] ESLint rule prevents detail panel imports from player-dashboard
- [ ] Query key registry shared across Player 360 panels
- [ ] `components/player-dashboard/README.md` updated
- [ ] `PLAYER-360-NAV-OVERLAP-RESOLUTION.md` status → "Implemented"
- [ ] Back to search control is present and uses validated returnTo
- [ ] `.github/CODEOWNERS` enforces `components/player-360/**` ownership
- [ ] Integration tests cover returnTo encoding, timeline redirect, and invalid returnTo fallback
