---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline skill
# Date: 2025-12-11

prd: PRD-009
prd_title: "Player Financial Service"
service: PlayerFinancialService
mvp_phase: 3  # Phase 3 (Rewards & Compliance)
pattern: A  # Contract-First
http_boundary: true

# Workstream Definitions
workstreams:
  WS1:
    name: Database Layer
    description: Schema migration to add missing columns (direction, source, created_by_staff_id, related_transaction_id), make visit_id NOT NULL, create RLS policies, update RPC
    agent: backend-service-builder
    depends_on: []
    outputs:
      - supabase/migrations/YYYYMMDDHHMMSS_prd009_player_financial_service.sql
      - services/player-financial/dtos.ts
      - services/player-financial/schemas.ts
      - services/player-financial/mappers.ts
    gate: schema-validation
    estimated_complexity: high

  WS2:
    name: Service Layer
    description: Service factory, query keys, HTTP fetchers for client consumption
    agent: backend-service-builder
    depends_on: [WS1]
    outputs:
      - services/player-financial/index.ts
      - services/player-financial/keys.ts
      - services/player-financial/http.ts
    gate: type-check
    estimated_complexity: medium

  WS3:
    name: Route Handlers
    description: API routes for financial transactions with role-based validation
    agent: api-builder
    depends_on: [WS2]
    outputs:
      - app/api/v1/financial-transactions/route.ts
      - app/api/v1/financial-transactions/[id]/route.ts
      - app/api/v1/visits/[visitId]/financial-summary/route.ts
    gate: lint
    estimated_complexity: medium

  WS4:
    name: React Query Hooks
    description: Query and mutation hooks for financial transaction operations
    agent: backend-service-builder
    depends_on: [WS2, WS3]
    outputs:
      - hooks/player-financial/index.ts
      - hooks/player-financial/keys.ts
      - hooks/player-financial/use-financial-transactions.ts
      - hooks/player-financial/use-financial-mutations.ts
    gate: type-check
    estimated_complexity: low

  WS5:
    name: Tests
    description: Unit tests, integration tests, and RLS policy validation
    agent: backend-service-builder
    depends_on: [WS1, WS2, WS3, WS4]
    outputs:
      - services/player-financial/__tests__/mappers.test.ts
      - services/player-financial/__tests__/service.test.ts
      - lib/supabase/__tests__/rls-financial.integration.test.ts
    gate: test-pass
    estimated_complexity: medium

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Foundation
    parallel: [WS1]
    gates: [schema-validation]

  - name: Phase 2 - Service Implementation
    parallel: [WS2]
    gates: [type-check]

  - name: Phase 3 - API Layer
    parallel: [WS3]
    gates: [lint]

  - name: Phase 4 - Client Hooks
    parallel: [WS4]
    gates: [type-check]

  - name: Phase 5 - Testing
    parallel: [WS5]
    gates: [test-pass]

# Validation Gates
gates:
  schema-validation:
    command: npm run db:types
    success_criteria: "Exit code 0, types regenerated without error"

  type-check:
    command: npx tsc --noEmit
    success_criteria: "Exit code 0, no TypeScript errors"

  lint:
    command: npm run lint
    success_criteria: "Exit code 0, no errors (warnings OK)"

  test-pass:
    command: npm test -- --testPathPattern="player-financial|rls-financial"
    success_criteria: "All tests pass"

# Dependencies on other PRDs/Services
external_dependencies:
  - prd: PRD-000
    service: CasinoService
    required_for: "Gaming day computation via casino_settings"

  - prd: PRD-003
    service: VisitService
    required_for: "visit_id FK constraint validation"

  - prd: ADR-015
    service: RLS Context
    required_for: "Pattern C (Hybrid) RLS with JWT claims"

  - prd: ADR-017
    service: Staff Role
    required_for: "cashier role in staff_role enum"

# Risks and Mitigations
risks:
  - risk: "Schema migration may affect existing data in player_financial_transaction"
    mitigation: "Use ALTER TABLE ADD COLUMN with defaults; backfill existing rows with 'pit' source and 'in' direction"

  - risk: "visit_id NOT NULL constraint may fail on existing rows with NULL visit_id"
    mitigation: "Migration creates backfill step; alternatively delete orphan rows or link to placeholder visit"

  - risk: "RLS policies may be complex with role-based write constraints"
    mitigation: "Follow ADR-015 Pattern C; test each role in isolation"

  - risk: "Idempotency edge cases with concurrent duplicate submissions"
    mitigation: "Integration tests for concurrent requests; rely on database unique index"
---

# EXECUTION-SPEC: PRD-009 - Player Financial Service

## Overview

Implement the PlayerFinancialService to manage monetary transactions during player sessions. This service owns the `player_financial_transaction` ledger and provides idempotent transaction creation for buy-ins, cash-outs, and marker operations.

**Key Deliverables:**
- Idempotent transaction creation via RPC
- Gaming day auto-assignment (trigger-based)
- Visit-linked audit trail
- Role-based write constraints (pit boss vs cashier)
- PRD-008 cash-in form unblock

## Scope

### In Scope (MVP)
- Create financial transaction (idempotent via RPC)
- List transactions with pagination (by casino, player, gaming_day, source)
- Get transaction by ID
- Calculate session total (sum by visit_id with direction breakdown)
- Gaming day trigger (auto-populate from casino_settings)
- Pit boss workflows: table-side buy-in recording
- Cashier workflows: cash-out, marker issuance, marker settlement
- Source tracking: 'pit' vs 'cage' vs 'system'

### Out of Scope
- Payment gateway integration (future ADR-016)
- Marker credit limit management
- Multi-currency support
- `finance_outbox` implementation (post-MVP)
- Non-gaming cash flows (hotel, F&B)
- Cage buy-ins (not standard casino workflow)

## Architecture Context

### Pattern Selection
- **Pattern**: A (Contract-First)
- **HTTP Boundary**: Yes (RPC via Route Handlers)
- **Justification**: Finance domain has complex business logic (idempotency, direction constraints, role-based validation) requiring explicit domain contracts

### Schema Changes Required

Current schema is missing:
- `direction` column ('in' | 'out')
- `source` column ('pit' | 'cage' | 'system')
- `created_by_staff_id` column (FK to staff)
- `related_transaction_id` column (for marker settlements)
- `visit_id` needs to be NOT NULL (currently nullable)

### Cross-Context Dependencies

| Direction | Service | DTO | Purpose |
|-----------|---------|-----|---------|
| Consumes | VisitService | VisitDTO | Validate visit exists and belongs to player |
| Consumes | CasinoService | CasinoSettingsDTO | Gaming day calculation |
| Publishes | PlayerFinancialService | FinancialTransactionDTO | For Loyalty points calculation |
| Publishes | PlayerFinancialService | VisitFinancialSummaryDTO | For MTL threshold evaluation |

---

## Workstream Details

### WS1: Database Layer

**Purpose**: Create database schema changes and policies for PlayerFinancialService.

**Gap Analysis (Current vs Required):**

| Column | Current State | Required State | Action |
|--------|---------------|----------------|--------|
| `direction` | Missing | `'in' \| 'out'` NOT NULL | ADD COLUMN |
| `source` | Missing | `'pit' \| 'cage' \| 'system'` NOT NULL | ADD COLUMN |
| `created_by_staff_id` | Missing | FK to staff, NOT NULL | ADD COLUMN |
| `related_transaction_id` | Missing | FK to self, NULLABLE | ADD COLUMN |
| `visit_id` | NULLABLE | NOT NULL | ALTER COLUMN (with backfill) |

**Deliverables**:
1. Migration file with:
   - New enum types: `financial_direction`, `financial_source`
   - ALTER TABLE to add columns with defaults
   - Backfill script for existing data
   - Update `rpc_create_financial_txn` with new parameters and role validation
   - RLS policies per SEC-001 Pattern C
2. DTO type definitions (`FinancialTransactionDTO`, `CreateFinancialTxnInput`, `VisitFinancialSummaryDTO`)
3. Zod schemas for validation

**RLS Policy Requirements:**

| Role | SELECT | INSERT | UPDATE | DELETE |
|------|--------|--------|--------|--------|
| admin | casino_id match | casino_id match | DENY | DENY |
| cashier | casino_id match | casino_id match + cage constraints | DENY | DENY |
| pit_boss | casino_id match | casino_id match + pit constraints | DENY | DENY |
| compliance | casino_id match | DENY | DENY | DENY |
| dealer | DENY | DENY | DENY | DENY |

**Pit Boss Constraints**: `direction = 'in'`, `source = 'pit'`, `tender_type IN ('cash', 'chips')`
**Cashier Constraints**: `source = 'cage'`, (`direction = 'out'` OR `tender_type = 'marker'`)

**Acceptance Criteria**:
- [ ] `npm run db:types` succeeds
- [ ] New columns appear in `database.types.ts`
- [ ] RLS policies enforce role-based access
- [ ] Idempotency index remains functional
- [ ] Gaming day trigger populates correctly

---

### WS2: Service Layer

**Purpose**: Implement service factory and supporting modules.

**Deliverables**:
1. `services/player-financial/index.ts` - Service factory with:
   - `createFinancialTransaction()` - calls RPC with idempotency
   - `getTransactionById()` - single record fetch
   - `listTransactions()` - paginated list with filters
   - `getVisitFinancialSummary()` - aggregated totals for a visit
2. `services/player-financial/keys.ts` - React Query key factories
3. `services/player-financial/http.ts` - HTTP fetcher functions

**Interface Contract**:
```typescript
interface PlayerFinancialService {
  createTransaction(input: CreateFinancialTxnInput): Promise<FinancialTransactionDTO>;
  getById(id: string): Promise<FinancialTransactionDTO | null>;
  list(query: FinancialTxnListQuery): Promise<PaginatedResult<FinancialTransactionDTO>>;
  getVisitSummary(visitId: string): Promise<VisitFinancialSummaryDTO>;
}
```

**Acceptance Criteria**:
- [ ] Service follows functional factory pattern
- [ ] No `ReturnType` inference (explicit interface)
- [ ] Proper error handling with domain errors
- [ ] Keys follow established pattern from other services

---

### WS3: Route Handlers

**Purpose**: Create API routes with middleware stack.

**Deliverables**:
1. `POST /api/v1/financial-transactions` - Create transaction (idempotent)
2. `GET /api/v1/financial-transactions` - List transactions with filters
3. `GET /api/v1/financial-transactions/[id]` - Get single transaction
4. `GET /api/v1/visits/[visitId]/financial-summary` - Visit financial summary

**Route Implementation Pattern**:
```typescript
// app/api/v1/financial-transactions/route.ts
export const POST = withServerAction(
  async (request: Request) => {
    // 1. Parse and validate body with Zod schema
    // 2. Extract staff context from auth middleware
    // 3. Validate role-based constraints
    // 4. Call service.createTransaction()
    // 5. Return ServiceHttpResult
  },
  { requireAuth: true }
);
```

**Role Validation in Route**:
- Extract `staff_role` from auth context
- Validate request body against role constraints BEFORE calling RPC
- Return 403 if role violation detected

**Acceptance Criteria**:
- [ ] All routes use `withServerAction` wrapper
- [ ] Request validation with Zod schemas
- [ ] Role-based constraints enforced at API layer
- [ ] Response format matches `ServiceHttpResult<T>`
- [ ] Idempotency key handled correctly (return existing on conflict)

---

### WS4: React Query Hooks

**Purpose**: Provide client-side data fetching hooks.

**Deliverables**:
1. `useFinancialTransaction(id)` - Single transaction query
2. `useFinancialTransactions(query)` - List query with filters
3. `useVisitFinancialSummary(visitId)` - Summary aggregation
4. `useCreateFinancialTransaction()` - Mutation hook

**Mutation Pattern**:
```typescript
export function useCreateFinancialTransaction() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (input: CreateFinancialTxnInput) =>
      http.createTransaction(input),
    onSuccess: (data) => {
      // Invalidate list queries
      queryClient.invalidateQueries({
        queryKey: financialKeys.lists()
      });
      // Invalidate visit summary
      if (data.visit_id) {
        queryClient.invalidateQueries({
          queryKey: financialKeys.visitSummary(data.visit_id)
        });
      }
    },
  });
}
```

**Acceptance Criteria**:
- [ ] Hooks use key factories from keys.ts
- [ ] Mutations invalidate relevant queries
- [ ] Error handling follows pattern
- [ ] TypeScript types are explicit (no inference)

---

### WS5: Tests

**Purpose**: Ensure implementation correctness and security.

**Deliverables**:
1. **Unit Tests** (`services/player-financial/__tests__/`):
   - `mappers.test.ts` - DTO transformation tests
   - `service.test.ts` - Service logic tests (mocked DB)

2. **Integration Tests** (`lib/supabase/__tests__/`):
   - `rls-financial.integration.test.ts` - RLS policy enforcement
   - Idempotency behavior validation
   - Role-based write constraint validation

**Test Scenarios**:
- [ ] Pit boss can create buy-in (direction=in, source=pit)
- [ ] Pit boss CANNOT create cash-out (direction=out)
- [ ] Cashier can create cash-out (direction=out, source=cage)
- [ ] Cashier can create marker issuance (direction=in, tender_type=marker)
- [ ] Cashier CANNOT create buy-in with source=pit
- [ ] Compliance can read but not write
- [ ] Dealer has no access
- [ ] Duplicate idempotency_key returns existing record
- [ ] Gaming day is auto-populated by trigger
- [ ] visit_id is required (NULL rejected)
- [ ] Cross-casino access is blocked

**Acceptance Criteria**:
- [ ] All unit tests pass
- [ ] All integration tests pass
- [ ] RLS tests verify role isolation
- [ ] No cross-casino data leakage

---

## Definition of Done

### Functionality
- [ ] Create transaction via RPC works end-to-end with idempotency
- [ ] Gaming day auto-populated by trigger (never client-set)
- [ ] List transactions returns paginated results filtered by casino
- [ ] Visit total calculation returns correct breakdown
- [ ] Pit boss constraint validation enforced at RPC level
- [ ] Cashier constraint validation enforced at RPC level

### Data & Integrity
- [ ] No duplicate transactions for same `casino_id + idempotency_key`
- [ ] All transactions have valid `visit_id` (no orphans)
- [ ] Amount is always positive with direction indicating cash flow
- [ ] Append-only enforced (UPDATE/DELETE blocked by RLS)

### Security & Access
- [ ] RLS policies enforce casino-scoped isolation (Pattern C)
- [ ] Pit boss can only create buy-ins
- [ ] Cashier can only create cash-outs or marker operations
- [ ] Compliance officer has read-only access
- [ ] No cross-casino data leakage in tests

### Testing
- [ ] Unit tests for mappers and DTOs
- [ ] Integration tests for RPC idempotency behavior
- [ ] RLS policy enforcement tests
- [ ] Constraint violation tests

### Operational
- [ ] Migration rollback script tested
- [ ] Error responses include actionable messages
- [ ] Types regenerated and committed

---

## Rollback Plan

If issues are discovered post-deployment:

1. **Migration Rollback**: `supabase migration down` or manual DROP COLUMN
2. **Service Rollback**: Revert to previous service version (no breaking changes to existing API)
3. **Data Preservation**: New columns have defaults; existing data unaffected by rollback

---

## Related Documents

| Document | Purpose |
|----------|---------|
| `docs/10-prd/PRD-009-player-financial-service.md` | Product requirements |
| `docs/10-prd/PRD-009-cashier-workflows-addendum.md` | Cashier workflow details |
| `docs/20-architecture/SERVICE_RESPONSIBILITY_MATRIX.md` | SRM v4.2.1 (Finance context) |
| `docs/30-security/SEC-001-rls-policy-matrix.md` | RLS patterns |
| `docs/80-adrs/ADR-015-rls-connection-pooling-strategy.md` | Pattern C (Hybrid) |
| `docs/80-adrs/ADR-017-cashier-role-implementation.md` | Cashier role |
