---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline skill

prd: PLAYER-PROFILE-EDIT
prd_title: "Player Profile Edit Feature"
service: PlayerService
mvp_phase: 1

# Workstream Definitions
workstreams:
  WS1:
    name: Service Layer DTO Extension
    description: Extend UpdatePlayerDTO and updatePlayerSchema with middle_name, email, phone_number fields
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - services/player/dtos.ts
      - services/player/schemas.ts
    gate: type-check
    estimated_complexity: low

  WS2:
    name: Identity Mutation Hook
    description: Create useUpdatePlayerIdentity() mutation hook for player_identity upsert
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - hooks/player/use-player-identity-mutation.ts
      - hooks/player/index.ts
    gate: type-check
    estimated_complexity: low

  WS3:
    name: Edit Form Component
    description: Create player-edit-form with react-hook-form + Zod, Personal/Contact/Address sections
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - components/player-dashboard/player-edit-form.tsx
    gate: type-check
    estimated_complexity: medium

  WS4:
    name: Edit Modal + Panel Integration
    description: Create modal wrapper with shadcn Dialog, add edit button to profile panel, wire mutations
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS2, WS3]
    outputs:
      - components/player-dashboard/player-edit-modal.tsx
      - components/player-dashboard/player-profile-panel.tsx
    gate: type-check
    estimated_complexity: medium

  WS5:
    name: Unit Tests
    description: Unit tests for extended schemas and identity mutation hook
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1, WS2]
    outputs:
      - __tests__/services/player/schemas.test.ts
      - __tests__/hooks/player/use-player-identity-mutation.test.ts
    gate: test-pass
    estimated_complexity: medium

  WS6:
    name: Quality Validation
    description: Final validation gates (build, type-check, lint)
    executor: qa-specialist
    executor_type: skill
    depends_on: [WS4, WS5]
    outputs: []
    gate: build
    estimated_complexity: low

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Service Layer
    parallel: [WS1]
    gates: [type-check]

  - name: Phase 2 - Hooks & Form
    parallel: [WS2, WS3]
    gates: [type-check]

  - name: Phase 3 - Modal Integration
    parallel: [WS4]
    gates: [type-check]

  - name: Phase 4 - Tests
    parallel: [WS5]
    gates: [test-pass]

  - name: Phase 5 - Quality Validation
    parallel: [WS6]
    gates: [build]

# Validation Gates
gates:
  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0"

  lint:
    command: npm run lint
    success_criteria: "Exit code 0"

  test-pass:
    command: npm test services/player/ hooks/player/
    success_criteria: "All tests pass"

  build:
    command: npm run build
    success_criteria: "Exit code 0"

# Dependencies on other PRDs/Services
external_dependencies:
  - prd: PRD-003
    service: PlayerService
    required_for: "Existing player CRUD operations and identity schema"

# Risks and Mitigations
risks:
  - risk: "Identity upsert may fail if player not enrolled in casino"
    mitigation: "Use existing POST /api/v1/players/[playerId]/identity which handles RLS context"
  - risk: "Form validation mismatch between frontend and backend"
    mitigation: "Share Zod schemas between form and route handler validation"

---

# EXECUTION-SPEC: PLAYER-PROFILE-EDIT - Player Profile Edit Feature

## Overview

Extend the player dashboard with editable player profile information. Allows pit staff to update player address, contact info, and personal details directly from the dashboard via a modal dialog.

## Scope

**In Scope**:
- Extend UpdatePlayerDTO with middle_name, email, phone_number
- Create edit form with Personal Info, Contact Info, and Address sections
- Add edit button to PlayerProfilePanel
- Create modal dialog for editing
- Handle both player table update and player_identity upsert
- Cache invalidation on successful save

**Out of Scope**:
- SSN/sensitive PII fields (deferred per PRD)
- Document verification status changes
- Photo/avatar upload
- Batch updates

## Architecture Context

- **SRM Ownership**: PlayerService owns `player` and `player_identity` tables
- **Existing Endpoints**: `PATCH /api/v1/players/[playerId]` and `POST /api/v1/players/[playerId]/identity` already exist
- **RLS**: Uses `set_rls_context_from_staff()` for casino-scoped access
- **ADR-024**: Context derived from JWT, not parameters

## Workstream Details

### WS1: Service Layer DTO Extension

**Purpose**: Extend the UpdatePlayerDTO and validation schema to support new editable fields.

**Current State**:
```typescript
// dtos.ts - CURRENT
export type UpdatePlayerDTO = Partial<
  Pick<PlayerInsert, "first_name" | "last_name" | "birth_date">
>;

// schemas.ts - CURRENT
export const updatePlayerSchema = z.object({
  first_name: z.string().min(1).max(100).optional(),
  last_name: z.string().min(1).max(100).optional(),
  birth_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).nullable().optional(),
});
```

**Target State**:
```typescript
// dtos.ts - TARGET
export type UpdatePlayerDTO = Partial<
  Pick<PlayerInsert,
    "first_name" | "last_name" | "birth_date" |
    "middle_name" | "email" | "phone_number"
  >
>;

// schemas.ts - TARGET
export const updatePlayerSchema = z.object({
  first_name: z.string().min(1).max(100).optional(),
  last_name: z.string().min(1).max(100).optional(),
  birth_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).nullable().optional(),
  middle_name: z.string().max(100).nullable().optional(),
  email: z.string().email().nullable().optional(),
  phone_number: z.string().max(20).nullable().optional(),
});
```

**Acceptance Criteria**:
- [ ] UpdatePlayerDTO includes middle_name, email, phone_number
- [ ] updatePlayerSchema validates new fields
- [ ] Types pass `npm run type-check`

### WS2: Identity Mutation Hook

**Purpose**: Create a TanStack Query mutation hook for upserting player identity data.

**Existing Infrastructure**:
- `useUpdatePlayer()` exists in `hooks/player/use-player-mutations.ts`
- Identity HTTP endpoint exists via `POST /api/v1/players/[playerId]/identity`
- `PlayerIdentityInput` type exists in `services/player/dtos.ts`

**Deliverables**:
1. `useUpdatePlayerIdentity()` mutation hook
2. Combined invalidation of player detail and identity queries
3. Export from `hooks/player/index.ts`

**Acceptance Criteria**:
- [ ] Hook follows existing mutation patterns
- [ ] Invalidates `playerKeys.detail(playerId)` on success
- [ ] Proper error handling with typed errors

### WS3: Edit Form Component

**Purpose**: Create a form component for editing player profile data.

**Technical Approach**:
- Use `react-hook-form` with Zod resolver
- Three form sections: Personal Info, Contact Info, Address
- Controlled inputs with field-level validation
- Only submit changed fields (partial update)

**Form Structure**:
```
┌─────────────────────────────────────────┐
│ Personal Information                    │
│ ┌───────────┐ ┌───────────┐ ┌─────────┐│
│ │First Name │ │Middle Name│ │Last Name││
│ └───────────┘ └───────────┘ └─────────┘│
│ ┌───────────┐                          │
│ │Birth Date │                          │
│ └───────────┘                          │
├─────────────────────────────────────────┤
│ Contact Information                     │
│ ┌───────────────────┐ ┌───────────────┐│
│ │ Email             │ │ Phone Number  ││
│ └───────────────────┘ └───────────────┘│
├─────────────────────────────────────────┤
│ Address                                 │
│ ┌───────────────────────────────────┐  │
│ │ Street                            │  │
│ └───────────────────────────────────┘  │
│ ┌───────────┐ ┌──────┐ ┌────────────┐  │
│ │ City      │ │ State│ │ Postal Code│  │
│ └───────────┘ └──────┘ └────────────┘  │
└─────────────────────────────────────────┘
```

**Acceptance Criteria**:
- [ ] Form uses react-hook-form + Zod resolver
- [ ] All field validation displays inline errors
- [ ] Form pre-populates with current player data
- [ ] Dirty field tracking for partial updates

### WS4: Edit Modal + Panel Integration

**Purpose**: Create modal wrapper and integrate with PlayerProfilePanel.

**Deliverables**:
1. `player-edit-modal.tsx` - Dialog wrapper using shadcn/ui Dialog
2. Modify `player-profile-panel.tsx` - Add "Edit" button to header

**Modal Behavior**:
- Opens on Edit button click
- Contains PlayerEditForm
- Handles submission with both useUpdatePlayer and useUpdatePlayerIdentity
- Shows loading state during save
- Toast notification on success/error
- Closes on successful save

**Acceptance Criteria**:
- [ ] Modal opens from profile panel edit button
- [ ] Form submits to correct endpoints
- [ ] Success toast displays on save
- [ ] Error state shows validation messages
- [ ] Cache invalidated on success

### WS5: Unit Tests

**Purpose**: Test coverage for new/modified code.

**Test Coverage**:

1. **Schema Tests** (`services/player/__tests__/schemas.test.ts`):
   - Validate middle_name accepts string and null
   - Validate email format
   - Validate phone_number format
   - Reject invalid inputs

2. **Hook Tests** (`hooks/player/__tests__/use-player-identity-mutation.test.ts`):
   - Mock identity update endpoint
   - Verify cache invalidation
   - Test error handling

**Acceptance Criteria**:
- [ ] Schema tests cover new fields
- [ ] Hook tests verify mutation behavior
- [ ] All tests pass with `npm test`

### WS6: Quality Validation

**Purpose**: Final quality gates before completion.

**Gates**:
- [ ] `npm run type-check` - Exit 0
- [ ] `npm run lint` - Exit 0
- [ ] `npm run build` - Exit 0
- [ ] Manual verification: Edit modal opens, saves, displays toast

## Definition of Done

- [ ] UpdatePlayerDTO includes middle_name, email, phone_number
- [ ] Zod schemas validate new fields
- [ ] Edit form component renders all editable fields
- [ ] Modal opens from PlayerProfilePanel edit button
- [ ] Player update mutation works with new fields
- [ ] Identity upsert handles address changes
- [ ] Cache invalidation updates UI after save
- [ ] Error states display validation messages
- [ ] Success toast confirms save
- [ ] All quality gates pass
