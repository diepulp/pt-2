---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline (lead-architect scaffold + frontend-design-pt-2 expert refinement)
# v2 — incorporates audit recommendations from AUDIT-EXECUTION-SPEC-GAP-SETUP-WIZARD-v1.md

prd: GAP-SETUP-WIZARD
prd_title: "Setup Wizard Hardening — Table Creation Overhaul & Validation Gates"
service: OnboardingWizard
mvp_phase: 1

workstreams:
  WS1:
    name: Table Creation Overhaul
    description: >
      OPEN-2 (remove bulk-add buttons, add Generate from games),
      OPEN-8 (remove roulette from wizard type lists),
      OPEN-4 (phantom buttons eliminated by OPEN-2),
      OPEN-3 (null game_settings_id hardening),
      OPEN-1 (configured games summary banner)
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - app/(onboarding)/setup/steps/step-create-tables.tsx
      - app/(onboarding)/setup/components/table-row-form.tsx
      - app/(onboarding)/setup/components/game-settings-form.tsx
      - app/(onboarding)/setup/steps/step-game-seed.tsx
      - app/(onboarding)/setup/steps/step-review-complete.tsx
    gate: type-check
    estimated_complexity: high

  WS2:
    name: Step-Level Validation Gates & Error UX
    description: >
      OPEN-10 (validateStep function with per-step rules per Validation Contract),
      OPEN-12 (derived error state, inline feedback, auto-clear)
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - app/(onboarding)/setup/setup-wizard.tsx
      - app/(onboarding)/setup/lib/wizard-validation.ts
    gate: type-check
    estimated_complexity: medium

  WS3:
    name: Review Step Audit Transformation
    description: >
      OPEN-11 (transform review from static summary to validation audit
      with blocker/warning/complete categories and step deep-links)
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - app/(onboarding)/setup/steps/step-review-complete.tsx
    gate: type-check
    estimated_complexity: medium

  WS4:
    name: Component Polish — Variant UX
    description: >
      OPEN-5 (variant selector clearable with consequence hint),
      OPEN-6 (par targets step shows variant context)
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - app/(onboarding)/setup/components/table-row-form.tsx
      - app/(onboarding)/setup/steps/step-par-targets.tsx
      - app/(onboarding)/setup/components/par-entry-row.tsx
      - app/(onboarding)/setup/setup-wizard.tsx
    gate: type-check
    estimated_complexity: low

  WS5:
    name: Step-Jump Navigation
    description: >
      OPEN-7 (clickable completed steps, forward-jump gating,
      Step 3 Optional label)
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - app/(onboarding)/setup/components/wizard-stepper.tsx
      - app/(onboarding)/setup/setup-wizard.tsx
    gate: type-check
    estimated_complexity: medium

  WS6:
    name: Validation Unit Tests
    description: >
      Unit tests for wizard-validation.ts (validateStep, validateAllSteps).
      Covers all rules in the Validation Contract table.
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - app/(onboarding)/setup/lib/__tests__/wizard-validation.test.ts
    gate: test-pass
    estimated_complexity: low

execution_phases:
  - name: Phase 1 — Table Creation Overhaul
    parallel: [WS1]
    gates: [type-check, lint]

  - name: Phase 2 — Validation & Polish
    parallel: [WS2, WS4]
    gates: [type-check, lint]

  - name: Phase 3 — Audit, Navigation & Tests
    parallel: [WS3, WS5, WS6]
    gates: [type-check, lint, test-pass, build]

gates:
  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0"
  lint:
    command: npm run lint
    success_criteria: "Exit code 0"
  test-pass:
    command: npx jest app/(onboarding)/setup/lib/__tests__/ --silent
    success_criteria: "All tests pass"
  build:
    command: npm run build
    success_criteria: "Exit code 0"

risks:
  - risk: "WS1 modifies step-create-tables.tsx extensively — merge risk with WS4 (table-row-form.tsx)"
    mitigation: "WS1 and WS4 touch different files. table-row-form.tsx OPEN-8 changes (WS1) are minimal removal; WS4 adds clearable variant — no overlap."
  - risk: "WS2 and WS5 both modify setup-wizard.tsx"
    mitigation: "WS5 depends on WS2 — runs sequentially. No parallel conflict."
  - risk: "WS3 modifies step-review-complete.tsx which WS1 also touches (roulette removal)"
    mitigation: "WS1 only removes roulette from GAME_TYPE_ORDER/LABELS (trivial). WS3 restructures the component. Sequential dependency prevents conflict."

---

# EXECUTION-SPEC: GAP-SETUP-WIZARD — Setup Wizard Hardening

## Overview

Overhaul the onboarding setup wizard's table creation step (Step 2), add step-level validation gates, transform the review step into an audit, and polish variant UX. Addresses 11 open gaps from GAP-SETUP-WIZARD-CONSOLIDATED-v2 (OPEN-9 poker fee-model deferred to future PRD).

## OPEN Item Reference

| ID | Summary | Priority | Workstream |
|----|---------|----------|------------|
| OPEN-1 | Game-to-table mapping guidance banner | P1 | WS1 |
| OPEN-2 | Replace bulk-add with `+ Add Table` + `Generate from games` | P1 | WS1 |
| OPEN-3 | Null `game_settings_id` hardening | P1 | WS1 |
| OPEN-4 | Remove phantom bulk buttons (poker, roulette) | P2 | WS1 (side effect of OPEN-2) |
| OPEN-5 | Variant selector clearable + consequence hint | P2 | WS4 |
| OPEN-6 | Par targets variant context | P3 | WS4 |
| OPEN-7 | Step-jump navigation + Optional labeling | P3 | WS5 |
| OPEN-8 | Remove roulette from wizard catalog and buttons | P2 | WS1 |
| OPEN-9 | Poker fee-model schema gap | P2 | **Deferred** (future PRD) |
| OPEN-10 | Step-level validation gates | P1 | WS2 |
| OPEN-11 | Review step as audit, not recap | P2 | WS3 |
| OPEN-12 | Error UX standardization | P2 | WS2 |

## Scope vs Guarantees

This spec is **primarily frontend**, but leverages existing server infrastructure for key guarantees:

| Guarantee | Enforcement Layer | Mechanism |
|-----------|-------------------|-----------|
| **Table creation idempotency** | Server (existing) | `createGamingTableAction` (`_actions.ts:400`) uses `.upsert({...}, { onConflict: 'casino_id,label_normalized' })` — verified at `_actions.ts:419-428`. Deterministic labels produce true idempotency |
| **Resume on earliest blocker** | Server (existing) | `page.tsx:computeInitialStep()` derives step from server-fetched state on every page load |
| **No duplicate generation (single session)** | Client | `generateFromGames()` checks existing rows by `game_settings_id` before adding — prevents duplicates within loaded state |
| **No duplicate generation (cross-session)** | Server (existing) | Upsert on `label_normalized` handles re-entry; deterministic labels (`BJ-01`, `BC-01`) map to same normalized key |
| **Step validation before Next** | Client | `validateStep()` runs during render; `goNext()` checks before advancing |
| **Poker table gating** | Client | Poker is **never seeded** by templates — it is only available if a user manually created a poker `game_settings` row in Step 1. The type dropdown in `TableRowForm` (`table-row-form.tsx`) derives its options from configured game types: `games.map(g => g.type)` deduplicated. If no poker game_settings exist, `poker` does not appear in the dropdown. Roulette is always excluded (hardcoded filter). |

**What is NOT guaranteed without additional server work** (out of scope):
- Server-side validation of step completeness before `completeSetupAction` (existing RPC `rpc_complete_casino_setup` has its own checks)
- Cross-tab consistency for in-progress wizard state

## Resume Algorithm

### SSR Baseline (existing — `page.tsx:computeInitialStep()`)

```
resumeStep =
  if (!settings.timezone || !settings.table_bank_mode) → 0
  else if (gameCount === 0) → 1
  else if (tableCount === 0) → 2
  else → 3
```

This runs on every SSR page load using server-fetched counts. It is a **coarse heuristic** — it only checks data presence (row counts), not Validation Contract rules like S2-LINK-MULTI or S2-LABEL.

### Client-side resume (WS2 enhancement)

Once the wizard shell mounts with full state (settings, games, tables), the client refines the resume step:

```
clientResumeStep =
  first step where validateStep(step, state).valid === false (has blockers)
  else → max(SSR resumeStep, 3)   // land on par targets or review
```

This catches cases where `tableCount > 0` but Step 2 still has blockers (e.g., unlinked variants, duplicate labels). The SSR heuristic is kept as the initial render target to avoid hydration mismatch — the client adjustment happens as a one-time step initialization after mount.

### Known mismatch

The SSR heuristic can land the user on Step 3 when Step 2 has S2-LINK-MULTI blockers (tables exist but some lack variant links). The client-side refinement corrects this on mount. Fixing `computeInitialStep()` to check variant linkage server-side would require a new RPC — out of scope for this spec.

## Roulette Legacy Behavior

- `roulette` **stays in DB** `game_type` enum — no schema change
- `GAME_TYPE_PREFIXES['roulette']` **kept** in `step-create-tables.tsx` for label generation compatibility
- Roulette is **hidden from creation UI only**: removed from type dropdowns, game settings form, and catalog
- Existing roulette tables (if any) **render normally** in Step 2 (table list), Step 3 (par targets), and Step 4 (review)
- The `GAME_TYPE_LABELS` fallback in `step-review-complete.tsx` uses `t.type.replace('_', ' ')` which handles any type not in the labels map — roulette renders as "roulette"

**Review step audit treatment (WS3)**: Existing roulette tables are treated as **neutral** — they show in the tables summary with their game type badge but do not trigger any validation rule (no blocker, no warning). They are valid data from a previous configuration. The audit does not flag them as "legacy" or "unknown" — they simply appear alongside other table types. This prevents future developers from adding a "cleanup" warning that would confuse users who intentionally created roulette tables.

## Validation Contract

Canonical rules for `wizard-validation.ts`. Each rule maps to a specific `ValidationIssue`.

### Step 0 — Casino Basics

| Rule ID | Severity | Condition | Message |
|---------|----------|-----------|---------|
| S0-TZ | blocker | `!settings?.timezone` | "Timezone is required" |
| S0-GDS | blocker | `!settings?.gaming_day_start_time` | "Gaming day start time is required" |
| S0-BM | blocker | `!settings?.table_bank_mode` | "Bank mode is required" |

### Step 1 — Game Settings

| Rule ID | Severity | Condition | Message |
|---------|----------|-----------|---------|
| S1-MIN | blocker | `games.length === 0` | "At least one game must be configured" |

### Step 2 — Create Tables

| Rule ID | Severity | Condition | Message |
|---------|----------|-----------|---------|
| S2-MIN | blocker | `tables.length === 0` | "At least one table is required" |
| S2-LINK-MULTI | blocker | Table has `game_settings_id === null` AND its `game_type` has >1 configured variant | "{label}: variant link required (multiple {gameType} variants configured)" |
| S2-LINK-SINGLE | warning | Table has `game_settings_id === null` AND its `game_type` has exactly 1 configured variant | "{label}: no variant linked — theo will use type-level defaults" |
| S2-LABEL | blocker | Two or more tables share the same `label` (case-insensitive) | "Duplicate table label: {label}" |

### Step 3 — Par Targets

| Rule ID | Severity | Condition | Message |
|---------|----------|-----------|---------|
| S3-SKIP | warning | No par values set for any table | "Par targets not configured — you can set them later" |

Step 3 is **always valid** (skippable). The S3-SKIP warning is a **review-only suggestion** — it appears in the Step 4 review audit (WS3) to inform the user, but never blocks navigation or completion. There is no "explicitly skipped" state to persist; the absence of par values is the only signal. If par values are later needed, they can be set post-setup via the table management UI.

### Step 4 — Review & Complete

Step 4 itself has no rules. It aggregates issues from Steps 0-3 via `validateAllSteps()`.

## Shared Utility: wizard-validation.ts

A new shared validation module extracted for reuse across WS2 (goNext gating), WS3 (review audit), and WS5 (forward-jump gating).

**Location**: `app/(onboarding)/setup/lib/wizard-validation.ts`

```typescript
import type { GameSettingsDTO } from '@/services/casino/game-settings-dtos';
import type { Database } from '@/types/database.types';

type CasinoSettingsRow = Database['public']['Tables']['casino_settings']['Row'];
type GamingTableRow = Database['public']['Tables']['gaming_table']['Row'];

export interface ValidationIssue {
  step: number;
  ruleId: string;          // e.g. 'S2-LINK-MULTI'
  severity: 'blocker' | 'warning';
  message: string;
  field?: string;          // For inline field-level errors
}

export interface StepValidationResult {
  valid: boolean;          // true if no blockers (warnings are non-blocking)
  issues: ValidationIssue[];
}

export interface WizardState {
  settings: CasinoSettingsRow | null;
  games: GameSettingsDTO[];
  tables: GamingTableRow[];
}

// Pure function — no side effects, no hooks, no state
export function validateStep(step: number, state: WizardState): StepValidationResult;

// Aggregate steps 0-3 for review audit
export function validateAllSteps(state: WizardState): ValidationIssue[];
```

**Critical implementation detail — derived state, not stored state**:
- Do NOT store `ValidationIssue[]` as React state
- Derive issues during render: `const stepIssues = validateStep(currentStep, { settings, games, tables })`
- Issues auto-clear as the underlying state changes (settings, games, tables are already in state)
- Only store a `showValidation: boolean` flag (set to `true` on failed navigation attempt, reset on step change)

## Workstream Details

### WS1: Table Creation Overhaul

**Purpose**: Replace arbitrary bulk-add buttons with intelligent table generation from configured games, remove roulette from wizard scope, harden game_settings_id linkage.

**Changes by OPEN item**:

**OPEN-2 — Remove bulk buttons, add Generate from games** (`StepCreateTables` component in `step-create-tables.tsx`):
- Remove all 6 `addBulk()` calls and their Button elements
- Keep only the `+ Add Table` button
- Add `Generate from games` button that:
  - Reads `gameSettings` prop to enumerate configured variants
  - Creates one `TableFormRow` per variant with deterministic label (`BJ-01`, `BC-01`, etc.) and auto-linked `game_settings_id`
  - Checks existing rows by `game_settings_id` before creating — no duplicates within loaded state
  - Skips variants that already have a linked table row
  - Server-side upsert on `label_normalized` handles cross-session idempotency
- Remove the `addBulk()` function entirely

**OPEN-8 — Remove roulette from wizard + derive type dropdown from games** (4 files):
- `TableRowForm` in `table-row-form.tsx`: Replace static `GAME_TYPES` array with game-type options derived from configured games (`games.map(g => g.type)`, deduplicated). This means: (a) roulette never appears (not configurable in Step 1), (b) poker only appears if the user added a custom poker game_settings, (c) only types the user actually configured are shown. Keep a `GAME_TYPE_LABELS` map for display names, but the available options list is dynamic.
- `GameSettingsForm` in `game-settings-form.tsx`: Remove `{ value: 'roulette', label: 'Roulette' }` from `GAME_TYPES`
- `StepGameSeed` in `step-game-seed.tsx`: Remove `'roulette'` from `GAME_TYPE_ORDER` and `GAME_TYPE_LABELS`
- `StepReviewComplete` in `step-review-complete.tsx`: Remove `'roulette'` from `GAME_TYPE_ORDER` and `GAME_TYPE_LABELS`
- Keep `GAME_TYPE_PREFIXES['roulette']` in `step-create-tables.tsx` for backward compat

**OPEN-3 — game_settings_id hardening** (`StepCreateTables`):
- In `handleNext()`: Block submission per Validation Contract rule S2-LINK-MULTI
- Auto-link: When a table's game type has exactly one variant, auto-set `game_settings_id` on the row
- Inline warning: When `game_settings_id === null` and multiple variants exist, show amber Badge on the row in `TableRowForm`

**OPEN-1 — Configured Games Summary banner** (`StepCreateTables`):
- Add banner above table rows showing: `You configured: 4 Blackjack · 3 Baccarat · 2 Pai Gow`
- Show warning count: `N variants have no tables yet`
- Use shadcn Alert component with `variant="default"` for summary, amber for warnings

**Implementation Guidelines**:
- No `useMemo` for simple derivations (React 19 compiler handles)
- No `useEffect` sync — derive variant counts during render
- Keep existing `useTransition` pattern from parent wizard for `isPending`
- Type filter lists as `GameType[]` excluding `'roulette'` — use `satisfies` for type safety

**Acceptance Criteria**:
- [ ] All 6 bulk-add buttons removed
- [ ] `Generate from games` creates one table per configured variant with linked `game_settings_id`
- [ ] Re-running `Generate from games` does not create duplicates within current session state
- [ ] Server-side upsert prevents duplicates across sessions (via deterministic labels)
- [ ] `roulette` does not appear in any wizard dropdown or button
- [ ] Existing roulette tables render normally in review (not hidden, not errored)
- [ ] Step 2 Next blocked per Validation Contract rule S2-LINK-MULTI
- [ ] Auto-link works for single-variant game types
- [ ] Games summary banner displays correct counts
- [ ] `npm run type-check` passes

---

### WS2: Step-Level Validation Gates & Error UX

**Purpose**: Add client-side validation before step navigation and standardize error display with derived state and auto-clear.

**Changes**:

**wizard-validation.ts** (new file):
- Implement `validateStep(step, state)` per the Validation Contract table above
- Implement `validateAllSteps(state)` — calls `validateStep` for steps 0-3 and aggregates
- Pure functions — no React imports, no hooks, no side effects
- Each rule returns a `ValidationIssue` with `ruleId` for testability

**setup-wizard.tsx** changes:
- Add `showValidation: boolean` state (initially `false`)
- Derive issues during render: `const stepIssues = showValidation ? validateStep(currentStep, { settings, games, tables }).issues : []`
- Modify `goNext()`: run `validateStep(currentStep, ...)`. If blockers exist, set `showValidation = true` and return. If valid, advance step and reset `showValidation = false`
- **Client-side resume refinement**: On mount (one-time), run `validateAllSteps()` against fetched state. If any step has blockers at an index lower than the SSR-derived `initialStep`, adjust `currentStep` down to that step. This catches cases like `tableCount > 0` but Step 2 has S2-LINK-MULTI blockers. Implementation: compute in the initial `useState` callback (not useEffect) by passing `initialStep` and the initial fetched state.
- Server action errors: keep `serverError: string | null` state for errors from async operations (these are NOT validation issues — they are infrastructure errors)
- Issues auto-clear because: (1) `showValidation` resets on step change, and (2) even when `showValidation` is true, derived issues recalculate from current state
- Step-level error summary: Show issue count when `showValidation && stepIssues.length > 0`

**Error display pattern**:
```tsx
// Derived — not stored
const stepResult = showValidation
  ? validateStep(currentStep, { settings, games, tables })
  : { valid: true, issues: [] };

{stepResult.issues.length > 0 && (
  <Alert variant="destructive">
    <AlertDescription>
      {stepResult.issues.length} issue{stepResult.issues.length !== 1 ? 's' : ''} to fix
      <ul className="mt-1 list-disc pl-4 text-sm">
        {stepResult.issues.map((issue) => (
          <li key={issue.ruleId}>{issue.message}</li>
        ))}
      </ul>
    </AlertDescription>
  </Alert>
)}
```

**Acceptance Criteria**:
- [ ] `goNext()` blocked when step has validation blockers
- [ ] Validation rules match the Validation Contract table exactly
- [ ] Error messages display inline with issue list
- [ ] Errors auto-clear when user fixes the underlying data
- [ ] `showValidation` resets on step change (no stale errors from previous step)
- [ ] Server action errors still display correctly (separate from validation)
- [ ] `npm run type-check` passes

---

### WS3: Review Step Audit Transformation

**Purpose**: Transform Step 4 from a static summary into a validation audit with blocker/warning/complete categorization and deep-links to fix locations.

**Changes to `StepReviewComplete` in step-review-complete.tsx**:

**New props**:
```typescript
interface StepReviewCompleteProps {
  settings: CasinoSettingsRow | null;
  games: GameSettingsDTO[];
  tables: GamingTableRow[];
  isPending: boolean;
  onComplete: () => void;
  onBack: () => void;
  onJumpToStep: (step: number) => void; // NEW — deep-link navigation
}
```

**Audit logic** (uses `validateAllSteps` from `wizard-validation.ts`):
- Import and call `validateAllSteps({ settings, games, tables })` — derived during render
- Group issues by step
- For each step section, show status indicator:
  - Green checkmark + "Complete" when no issues for that step
  - Amber warning icon + warning messages when only warnings
  - Red X + blocker messages when blockers exist
- Each issue row has a "Fix" button that calls `onJumpToStep(issue.step)`

**Complete Setup button**: `disabled={isPending || hasBlockers}`

Where `hasBlockers = issues.some(i => i.severity === 'blocker')`

**Layout**:
- Keep existing summary sections (Casino Settings, Game Settings, Tables)
- Add audit status banner at top: "Ready to complete" or "N issues to resolve"
- Each section gets a status badge (Complete / Warning / Blocker)

**Step 2 edge cases** (handled by Validation Contract rules):
- No game settings but user navigates to Step 2: review shows S1-MIN blocker with Fix link to Step 1
- User clears variant link to None after linking: S2-LINK-MULTI or S2-LINK-SINGLE appears in review
- Duplicate labels: S2-LABEL blocker appears in review
- Existing roulette tables: render with `t.type.replace('_', ' ')` fallback — no special warning

**Acceptance Criteria**:
- [ ] Review step shows blocker/warning/complete status per section
- [ ] "Complete Setup" disabled when blockers exist
- [ ] "Fix" buttons navigate to the correct step
- [ ] Warnings show but don't block completion
- [ ] All existing summary information preserved
- [ ] `npm run type-check` passes

---

### WS4: Component Polish — Variant UX

**Purpose**: Make variant selector clearable with consequence hints, and add variant context to par targets step.

**OPEN-5 — Clearable variant selector** (`TableRowForm` in `table-row-form.tsx`):
- Add `<SelectItem value="__none__">None</SelectItem>` as first option in variant Select
- In `onValueChange`: map `"__none__"` back to `null` for `game_settings_id`
- When `game_settings_id === null` and `variants.length > 1`, show inline hint text below the select: `"Variant link recommended for theo calculations"`
- Use `text-amber-600 text-xs` for the hint

**OPEN-6 — Par targets variant context**:

`setup-wizard.tsx` (`SetupWizard`):
- Pass `gameSettings={games}` to `StepParTargets` component (currently only passes `tables` and `bankMode`)

`StepParTargets` in `step-par-targets.tsx`:
- Add `gameSettings: GameSettingsDTO[]` to props
- Build `gameSettingsMap` from gameSettings (same pattern as `StepReviewComplete`)
- Pass `variantName` to `ParEntryRow`

`ParEntryRow` in `par-entry-row.tsx`:
- Add optional `variantName?: string` prop
- Display as: `BJ-01 — Blackjack (Double Deck)` instead of `BJ-01 — Blackjack`
- Format: `{tableLabel} — {gameTypeLabel}{variantName ? ` (${variantName})` : ''}`

**Acceptance Criteria**:
- [ ] Variant selector has "None" option to clear selection
- [ ] Clearing variant shows inline hint when multiple variants exist
- [ ] Par targets step shows variant name in parentheses
- [ ] Tables with no variant show just game type (no empty parens)
- [ ] `npm run type-check` passes

---

### WS5: Step-Jump Navigation

**Purpose**: Make completed wizard steps clickable for direct navigation, with forward-jump gating and Step 3 "Optional" labeling.

**`WizardStepper` in wizard-stepper.tsx**:

New props:
```typescript
interface WizardStepperProps {
  steps: readonly string[];
  currentStep: number;
  onStepClick?: (step: number) => void; // NEW
  optionalSteps?: number[]; // NEW — steps to label as "(Optional)"
}
```

Behavior:
- Completed steps (`idx < currentStep`): clickable with `cursor-pointer`, hover state, call `onStepClick?.(idx)`
- Current step (`idx === currentStep`): not clickable (already here)
- Future steps (`idx > currentStep`): not clickable (greyed out, no cursor)
- Optional steps: append "(Optional)" text or show small Badge next to label

Accessibility:
- Clickable steps rendered as `<button>` elements (not div with onClick)
- `aria-label="Go to step {label}"` on clickable steps
- `aria-current="step"` on current step
- `role="navigation"` on the stepper container
- Keyboard navigable via tab order

**`SetupWizard` in setup-wizard.tsx**:

Add `handleStepClick(targetStep: number)`:
- If `targetStep < currentStep`: allow unconditionally (backward jump)
- If `targetStep > currentStep`: validate all intermediate steps using `validateStep` — only allow if all pass
- Set `currentStep` to `targetStep`
- Reset `showValidation` to `false`

**Acceptance Criteria**:
- [ ] Completed steps are clickable and navigate backward
- [ ] Future steps are not clickable
- [ ] Forward jump validates intermediate steps
- [ ] Step 3 shows "Optional" label/badge
- [ ] Keyboard navigation works (tab + enter)
- [ ] `aria-current="step"` on active step
- [ ] `npm run type-check` passes

---

### WS6: Validation Unit Tests

**Purpose**: Unit tests for `wizard-validation.ts` covering all Validation Contract rules. This is cheap insurance against regression as the wizard evolves.

**Location**: `app/(onboarding)/setup/lib/__tests__/wizard-validation.test.ts`

**Test cases** (one per Validation Contract rule):

```typescript
describe('validateStep', () => {
  describe('Step 0 — Casino Basics', () => {
    it('S0-TZ: blocks when timezone missing');
    it('S0-GDS: blocks when gaming_day_start_time missing');
    it('S0-BM: blocks when table_bank_mode missing');
    it('passes when all three fields present');
  });

  describe('Step 1 — Game Settings', () => {
    it('S1-MIN: blocks when no games configured');
    it('passes when at least one game exists');
  });

  describe('Step 2 — Create Tables', () => {
    it('S2-MIN: blocks when no tables exist');
    it('S2-LINK-MULTI: blocks when table unlinked and multi-variant type');
    it('S2-LINK-SINGLE: warns when table unlinked and single-variant type');
    it('S2-LABEL: blocks on duplicate table labels');
    it('passes when tables exist, all multi-variant linked, no duplicates');
  });

  describe('Step 3 — Par Targets', () => {
    it('S3-SKIP: warns when no par values set (review-only suggestion)');
    it('always returns valid regardless of par values (skippable)');
  });
});

describe('validateAllSteps', () => {
  it('aggregates issues across all steps');
  it('returns empty array when all steps valid');
  it('separates blockers from warnings');
});
```

**Implementation Guidelines**:
- Use minimal test fixtures — only the fields needed for each rule
- Test pure functions directly — no React rendering needed
- Follow existing test naming convention (`*.test.ts`)

**Acceptance Criteria**:
- [ ] All Validation Contract rules have corresponding test cases
- [ ] Tests pass via `npx jest app/(onboarding)/setup/lib/__tests__/ --silent`
- [ ] Edge cases covered: empty state, partial state, roulette-type tables

---

## Definition of Done

- [ ] All 6 workstreams complete
- [ ] All gates pass (type-check, lint, test-pass, build)
- [ ] No regressions in existing functionality
- [ ] Roulette does not appear in wizard creation UI (existing roulette tables render normally)
- [ ] Poker tables creatable only when custom poker game_settings exists — type dropdown derives from configured games, not a static list
- [ ] "Generate from games" produces no duplicates within session state; server upsert prevents cross-session duplicates
- [ ] Page reload lands on earliest incomplete step (existing `computeInitialStep` in `page.tsx`)
- [ ] Review step enumerates blockers with deep-links to fix locations
- [ ] Validation errors are derived state — auto-clear when underlying data changes
- [ ] No `as any`, no `console.*` in production code
- [ ] Validation Contract rules fully tested in WS6
