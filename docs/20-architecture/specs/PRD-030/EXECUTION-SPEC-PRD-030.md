---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline (lead-architect scaffold + domain expert refinement)

prd: PRD-030
prd_title: "Setup Wizard — Casino Configuration, Table Provisioning & Bankroll/Par Bootstrap"
service: CasinoService
secondary_context: TableContextService
mvp_phase: 1

workstreams:
  WS1:
    name: Setup Completion RPC Migration
    description: >
      SECURITY DEFINER RPC rpc_complete_casino_setup(p_skip boolean DEFAULT false).
      Derives context via set_rls_context_from_staff(), validates role = 'admin',
      optionally validates at least 1 gaming_table exists, idempotently sets
      setup_status='ready', setup_completed_at=now(), setup_completed_by=actor_id
      on casino_settings. Returns success if already completed (idempotent).
    executor: rls-expert
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/20260211020000_prd030_rpc_complete_casino_setup.sql
      - "Includes: label_normalized generated column + unique index on gaming_table(casino_id, label_normalized) for case/whitespace-safe uniqueness"
    gate: schema-validation
    estimated_complexity: medium

    patterns:
      - "ADR-024: Authoritative context derivation (set_rls_context_from_staff)"
      - "ADR-018: SECURITY DEFINER with SET search_path = pg_catalog, public"
      - "ADR-015: SET LOCAL for pooler-safe context vars"
      - "ADR-030: Write-path session-var enforcement (casino_settings not on critical table list, but follows best practice)"

    implementation_details:
      rpc_signature: "rpc_complete_casino_setup(p_skip boolean DEFAULT false) RETURNS jsonb"
      security: SECURITY DEFINER
      search_path: "SET search_path = pg_catalog, public"
      context_injection: "PERFORM set_rls_context_from_staff()"
      role_allowlist: ["admin"]
      authorization_note: >
        Canonical Enums.staff_role values: dealer, pit_boss, cashier, admin.
        Only 'admin' may complete casino setup. No 'manager' role exists in the schema.
      steps:
        - "1. Call set_rls_context_from_staff() — derives casino_id, actor_id, staff_role"
        - "2. Read v_casino_id from current_setting('app.casino_id', true)"
        - "3. Read v_actor_id from current_setting('app.actor_id', true)"
        - "4. Read v_staff_role from current_setting('app.staff_role', true)"
        - "5. Validate v_staff_role = 'admin' — RAISE 'FORBIDDEN' if not"
        - "6. If NOT p_skip: validate EXISTS(SELECT 1 FROM gaming_table WHERE casino_id = v_casino_id)"
        - "7. SELECT setup_status, setup_completed_at, setup_completed_by INTO v_status, v_at, v_by FROM casino_settings WHERE casino_id = v_casino_id"
        - "8. If NOT FOUND: RAISE 'NOT_FOUND: casino_settings row missing'"
        - "9. If v_status = 'ready': return jsonb_build_object('ok', true, 'casino_id', v_casino_id, 'setup_status', v_status, 'setup_completed_at', v_at, 'setup_completed_by', v_by) — idempotent success using stored values"
        - "10. UPDATE casino_settings SET setup_status = 'ready', setup_completed_at = now(), setup_completed_by = v_actor_id WHERE casino_id = v_casino_id AND setup_status != 'ready' RETURNING setup_status, setup_completed_at, setup_completed_by INTO v_status, v_at, v_by"
        - "11. Return jsonb_build_object('ok', true, 'casino_id', v_casino_id, 'setup_status', v_status, 'setup_completed_at', v_at, 'setup_completed_by', v_by) — uses RETURNING values, no now() drift"
      error_handling:
        - "RAISE EXCEPTION 'UNAUTHORIZED: casino context not set' when v_casino_id IS NULL"
        - "RAISE EXCEPTION 'FORBIDDEN: role not allowed' when v_staff_role != 'admin'"
        - "RAISE EXCEPTION 'PRECONDITION_FAILED: no gaming tables' when !p_skip and no tables"
        - "RAISE EXCEPTION 'NOT_FOUND: casino_settings row missing' when no row for casino_id"
        - "Transition guard is future-proof: transitions from any non-ready state (not just 'not_started'), so future intermediate statuses do not break completion"
      grant: "GRANT EXECUTE ON FUNCTION rpc_complete_casino_setup TO authenticated"

    migration_duplicate_label_handling: >
      Before adding the unique index on (casino_id, label_normalized), the migration MUST check
      for pre-existing duplicate labels. If duplicates exist, the migration MUST fail fast with an
      actionable error listing the offending (casino_id, label) groups. Deterministic dedup is NOT
      performed automatically — operator intervention is required. This ensures no "surprise index
      creation failure" in prod.

    validation:
      - "npm run db:types exits 0"
      - "RPC callable by authenticated role"
      - "RPC rejects dealer, pit_boss, cashier roles (only admin allowed)"
      - "RPC derives casino_id from context (ADR-024 INV-8)"
      - "No p_casino_id or p_actor_id parameters (ADR-024 compliant)"
      - "RPC returns success (idempotent) when setup_status already 'ready'"
      - "RPC stamps setup_completed_by with actor_id"

  WS2:
    name: Setup Wizard Server Actions
    description: >
      Five server actions co-located with the setup route at
      app/(onboarding)/setup/_actions.ts. Each action uses withServerAction()
      middleware, Zod validation, and returns ServiceResult<T>.
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - app/(onboarding)/setup/_actions.ts
      - services/casino/schemas.ts (additions)
      - services/table-context/schemas.ts (additions)
    gate: type-check
    estimated_complexity: medium

    persistence_model: >
      FR-9 Wizard Step Persistence: Each step persists on "Next" (server write), not only
      at final completion. Persistence is idempotent and safe under refresh/back/re-entry.
      Step 1 (Casino Basics): updates casino_settings on Next.
      Step 2 (Game Seed): inserts/upserts game_settings (no duplicates on re-run).
      Step 3 (Tables): upserts gaming_table rows with (casino_id, label_normalized) uniqueness (case/whitespace-safe). Conflict target: casino_id,label_normalized.
      Step 4 (Par Targets): updates existing gaming_table rows with par_total_cents + audit stamps.
      Step 5 (Complete): only flips setup_status and stamps setup_completed_at/by.

    actions:
      completeSetupAction:
        description: "Wraps rpc_complete_casino_setup via withServerAction(). Idempotent — returns success if already ready."
        input: "{ skip?: boolean }"
        schema: "completeSetupSchema (z.object({ skip: z.boolean().optional() }))"
        rpc: "supabase.rpc('rpc_complete_casino_setup', { p_skip: input.skip ?? false })"
        returns: "ServiceResult<{ ok: boolean; casino_id: string; setup_status: string; setup_completed_at: string; setup_completed_by: string }>"
        middleware_options:
          domain: casino
          action: complete-setup
        notes: "Maps Postgres exceptions to ServiceResult error codes: FORBIDDEN, NOT_FOUND, PRECONDITION_FAILED."

      updateCasinoSettingsAction:
        description: "Updates casino_settings fields for current casino"
        input: "FormData with timezone, gaming_day_start_time, table_bank_mode"
        schema: "setupCasinoSettingsSchema (extends updateCasinoSettingsSchema + table_bank_mode)"
        operation: "supabase.from('casino_settings').update({...}).eq('casino_id', ctx.rlsContext.casino_id)"
        returns: "ServiceResult<CasinoSettingsDTO>"
        middleware_options:
          domain: casino
          action: update-settings
        notes: "table_bank_mode added to existing updateCasinoSettingsSchema"

      seedGameSettingsAction:
        description: "Wraps rpc_seed_game_settings_defaults. Idempotent — re-run does not create duplicates."
        input: "{ template: string }"
        schema: "seedGameSettingsSchema (z.object({ template: z.string().min(1) }))"
        rpc: "supabase.rpc('rpc_seed_game_settings_defaults', { p_template: input.template })"
        returns: "ServiceResult<{ seeded_count: number }>"
        middleware_options:
          domain: casino
          action: seed-game-settings
        notes: >
          Seeding provides default metadata per game_type (house edge, decisions/hr, seats, etc.).
          Variant selection (e.g., 'BJ 6D Lucky Ladies') is out of scope for v0 —
          would require gaming_table.game_settings_id FK.

      createGamingTableAction:
        description: "Upserts a gaming_table row. casino_id from session context. Idempotent on (casino_id, label_normalized)."
        input: "FormData with label, type (game_type enum), pit (optional)"
        schema: "createGamingTableSchema (z.object({ label: z.string().min(1).max(50), type: gameTypeSchema, pit: z.string().max(50).optional() })) — gameTypeSchema derived from Enums['game_type'] in database.types.ts (no hard-coded list)"
        operation: "supabase.from('gaming_table').upsert({ casino_id: ctx.rlsContext.casino_id, label, type, pit, status: 'active' }, { onConflict: 'casino_id,label_normalized' })"
        returns: "ServiceResult<GamingTableDTO>"
        middleware_options:
          domain: table-context
          action: create-table
        uniqueness: >
          gaming_table(casino_id, label_normalized) must be unique (case/whitespace safe).
          label_normalized is a generated column: lower(trim(regexp_replace(label, '\s+', ' ', 'g'))).
          On conflict (casino_id, label_normalized): update mutable fields (type, pit, status). Never create duplicates.
          "BJ-01" and "bj-01" conflict, not duplicate. "BJ  01" and "BJ 01" conflict, not duplicate.
          Requires DB generated column + unique index — added in WS1 migration.
        notes: >
          casino_id derived from middleware context, never from user input (ADR-024).
          Type dropdown populated from Enums.game_type (canonical enum), NOT from
          seeded game_settings variants. On Next, tables are saved (upserted) to the
          database. Refresh/re-entry does not create duplicates.

      updateTableParAction:
        description: "Updates gaming_table.par_total_cents with timestamps"
        input: "{ tableId: string, parTotalCents: number | null }"
        schema: "updateTableParSchema (z.object({ tableId: uuidSchema, parTotalCents: z.number().int().min(0).nullable() }))"
        operation: "supabase.from('gaming_table').update({ par_total_cents, par_updated_at: new Date().toISOString(), par_updated_by: ctx.rlsContext.actor_id }).eq('id', tableId).eq('casino_id', ctx.rlsContext.casino_id)"
        returns: "ServiceResult<{ id: string; par_total_cents: number | null }>"
        middleware_options:
          domain: table-context
          action: update-par
        notes: >
          Casino-scoped update with actor stamping. On Next, par targets are persisted
          to the database for the selected tables. par_updated_at and par_updated_by
          columns confirmed present in canonical schema (gaming_table).

    authorization_enforcement: >
      Each server action MUST assert staff_role === 'admin' (exact enum value) prior to DB calls.
      Enforcement is in the app middleware layer (withServerAction role gate), not RLS-only.
      This removes ambiguity about whether app code or RLS enforces admin-only access.

    validation:
      - "npm run type-check exits 0"
      - "All actions use withServerAction() middleware"
      - "All actions assert staff_role === 'admin' in middleware before DB calls"
      - "No casino_id from user input (ADR-024 INV-8)"
      - "Zod schemas validate all inputs"
      - "ServiceResult<T> return type on all actions"
      - "Wizard must not duplicate enum catalogs in code. All enum constraints must be sourced from types/database.types.ts to prevent drift."
      - "No hard-coded game_type string arrays — gameTypeSchema derived from Enums['game_type']"

  WS3:
    name: Setup Wizard UI (5-Step Flow)
    description: >
      Multi-step wizard component replacing /setup placeholder. 5 linear steps
      with progress stepper, back/next navigation, skip option. React 19 patterns
      (useTransition, useActionState), shadcn/ui components, Tailwind v4.
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - app/(onboarding)/setup/page.tsx (rewrite — server component, data prefetch)
      - app/(onboarding)/setup/setup-wizard.tsx (client component — wizard orchestrator)
      - app/(onboarding)/setup/steps/step-casino-basics.tsx
      - app/(onboarding)/setup/steps/step-game-seed.tsx
      - app/(onboarding)/setup/steps/step-create-tables.tsx
      - app/(onboarding)/setup/steps/step-par-targets.tsx
      - app/(onboarding)/setup/steps/step-review-complete.tsx
      - app/(onboarding)/setup/components/wizard-stepper.tsx
      - app/(onboarding)/setup/components/bank-mode-selector.tsx
      - app/(onboarding)/setup/components/table-row-form.tsx
      - app/(onboarding)/setup/components/par-entry-row.tsx
      - app/(onboarding)/layout.tsx (widen max-w for wizard)
    gate: type-check
    estimated_complexity: high

    architecture:
      page_component:
        type: server-component
        responsibilities:
          - "Fetch casino_settings, existing game_settings, existing gaming_tables via supabase"
          - "Pass pre-filled data as props to client wizard component"
          - "Redirect to /start (gateway) which routes to /pit if setup_status = 'ready'"
      wizard_component:
        type: client-component
        state_management: "useState for currentStep (0-4), React 19 useTransition for async actions"
        responsibilities:
          - "Step navigation (linear, back/next)"
          - "Progress indicator via WizardStepper"
          - "Skip Setup link calling completeSetupAction({ skip: true })"
          - "Re-entry: detect existing data from server-fetched props"
      step_components:
        - name: StepCasinoBasics
          react_19_patterns: ["useTransition for Next button save"]
          shadcn_components: ["Select (timezone)", "Input (time)", "RadioGroup (bank mode)", "Card", "Label"]
        - name: StepGameSeed
          react_19_patterns: ["useTransition for Seed button"]
          shadcn_components: ["Button", "Card", "Badge (seeded game list)"]
          notes: >
            Seeding provides default metadata per game_type (house edge, decisions/hr, seats).
            Variant selection is out of scope for v0. After seed, query game_settings to
            verify rows exist and display count (mitigates void-return RPC risk).
        - name: StepCreateTables
          react_19_patterns: ["useTransition for table creation"]
          shadcn_components: ["Input (label)", "Select (game type from Enums.game_type)", "Input (pit)", "Button (add/remove)"]
          notes: >
            Dynamic form rows with add/remove. Bulk-add generates auto-labels.
            Type dropdown populated from Enums.game_type (derived from database.types.ts,
            NOT hard-coded) — NOT from seeded game_settings variants.
            On Next, tables are saved (upserted) to the database.
            Refresh/re-entry does not create duplicates (casino_id + label_normalized uniqueness).
        - name: StepParTargets
          react_19_patterns: ["useTransition for par save"]
          shadcn_components: ["Input (dollar amount)", "Tooltip (bank mode aware)", "Button (skip)"]
          notes: >
            Primary label: 'Target Bankroll (Par)' — NOT 'Target Need (Par)' or just 'Par'.
            Helper/tooltip: 'Sometimes called the table's need baseline (not live fill need).
            Used for variance + fill-pressure heuristics in Inventory Count.'
            Tooltip varies by table_bank_mode. On Next, par targets are persisted to the database.
            Note: 'need' is allowed in helper/tooltip text for ops vernacular, but NOT in the primary label.
        - name: StepReviewComplete
          react_19_patterns: ["useTransition for complete action"]
          shadcn_components: ["Card (summary)", "Badge", "Button", "Separator"]
          notes: "Read-only summary. On success: router.push('/start') (gateway routes to /pit)"

    reentry_resume_rules:
      description: >
        Deterministic algorithm for computing the initial wizard step on page load/re-entry.
        Uses server-fetched state as the single source of truth.
      algorithm:
        - "If casino_settings.setup_status = 'ready': redirect to /start (app home/pit dashboard)"
        - "Else if casino basics incomplete (casino_settings missing timezone or table_bank_mode): Step 1"
        - "Else if game_settings count = 0 (not seeded): Step 2"
        - "Else if gaming_table count = 0: Step 3"
        - "Else: Step 4 (par targets)"
        - "Step 5 (Review/Complete) becomes available when steps 1–3 are satisfied. Step 4 (Par Targets) is recommended but optional."
      tiebreakers:
        - "If Step 3 has tables but Step 2 not seeded: route to Step 2 (seed first)"
        - "If Step 4 par values are missing, do not block progress; par is optional but recommended"
      acceptance:
        - "Refresh mid-wizard lands user on correct step without duplicates"
        - "Re-entry behavior is consistent across environments"

    data_fetching:
      server_prefetch:
        - "casino_settings (timezone, gaming_day_start_time, table_bank_mode, setup_status)"
        - "game_settings (list — to detect if already seeded)"
        - "gaming_table (list — to detect existing tables for re-entry)"
      client_mutations: "Server actions from WS2 via useTransition wrapping"

    ux_requirements:
      - "Linear stepper — no forward step jumping within the stepper"
      - "Back/Next buttons on each step"
      - "Skip Setup gated by NEXT_PUBLIC_ENABLE_SKIP_SETUP=true feature flag (Option A from delta patch §4)"
      - "When skip is enabled: link visible on all steps, calls completeSetupAction({ skip: true }). Skip Setup exits the wizard early by marking setup ready and redirecting to the app — it is NOT 'jump to Step 5'"
      - "Progress indicator showing current step out of 5"
      - "Idempotent re-entry — detect existing state from server prefetch"
      - "No console.* in production components"
      - "Bank mode radio with explanatory copy from dual-policy doc"
      - "Par tooltip varies by bank mode selection"
      - "Each step persists on Next (server write) — no draft-only steps"

    validation:
      - "npm run type-check exits 0"
      - "No useEffect sync anti-patterns (key-based reset if needed)"
      - "All async operations use useTransition"
      - "No manual loading state booleans"
      - "No console.* calls"
      - "shadcn/ui components for all UI primitives"

  WS4:
    name: Backend Integration Tests
    description: >
      RPC contract tests for rpc_complete_casino_setup and server action validation.
      Co-located with casino service tests.
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1, WS2]
    outputs:
      - services/casino/__tests__/setup-wizard-rpc.int.test.ts
    gate: test-pass
    estimated_complexity: medium

    test_cases:
      rpc_contract:
        - name: "completes setup successfully for admin"
          preconditions: ["bootstrapped casino with setup_status='not_started'", "at least 1 gaming_table"]
          action: "call rpc_complete_casino_setup(p_skip := false)"
          assertions: ["setup_status = 'ready'", "setup_completed_at IS NOT NULL", "returns jsonb with casino_id"]

        - name: "rejects pit_boss role"
          preconditions: ["authenticated as pit_boss"]
          action: "call rpc_complete_casino_setup"
          assertions: ["raises FORBIDDEN error"]

        - name: "rejects cashier role"
          preconditions: ["authenticated as cashier"]
          action: "call rpc_complete_casino_setup"
          assertions: ["raises FORBIDDEN error"]

        - name: "rejects dealer role"
          preconditions: ["authenticated as dealer"]
          action: "call rpc_complete_casino_setup"
          assertions: ["raises FORBIDDEN error"]

        - name: "rejects when no gaming tables exist (non-skip)"
          preconditions: ["no gaming_table rows for casino"]
          action: "call rpc_complete_casino_setup(p_skip := false)"
          assertions: ["raises PRECONDITION_FAILED error"]

        - name: "allows skip without tables"
          preconditions: ["no gaming_table rows for casino"]
          action: "call rpc_complete_casino_setup(p_skip := true)"
          assertions: ["setup_status = 'ready'"]

        - name: "idempotent — already completed returns success"
          preconditions: ["setup_status already 'ready'"]
          action: "call rpc_complete_casino_setup"
          assertions: ["returns ok=true", "returns existing setup_completed_at", "returns existing setup_completed_by", "no error raised"]

        - name: "RLS isolation — casino A staff cannot mutate casino B setup or tables"
          preconditions: ["staff of casino A", "casino B with setup_status='not_started'", "casino B has gaming_table rows"]
          action: "call rpc_complete_casino_setup as casino A staff; attempt createGamingTableAction targeting casino B"
          assertions: ["only affects casino A", "casino B setup_status unchanged", "casino B tables unchanged"]
          notes: "Covers delta patch §9 — RLS cross-casino mutation test (setup + tables)"

        - name: "table upsert no-duplication on re-run"
          preconditions: ["casino with existing gaming_table 'BJ-01'"]
          action: "call createGamingTableAction with label='BJ-01' twice"
          assertions: ["only 1 row exists for (casino_id, 'BJ-01')", "second call updates, not inserts"]
          notes: "Covers delta patch §5 — table uniqueness"

        - name: "wizard re-entry loads existing state without duplication"
          preconditions: ["casino with partially completed setup (Step 3 done, tables exist)"]
          action: "re-enter wizard, verify tables load from server prefetch"
          assertions: ["existing tables displayed", "no duplicate rows created on refresh"]
          notes: "Covers delta patch §9 — re-entry/refresh test"

        - name: "completes setup from any non-ready state (future-proof transition)"
          preconditions: ["bootstrapped casino with setup_status='not_started'", "at least 1 gaming_table"]
          action: "call rpc_complete_casino_setup(p_skip := false)"
          assertions: ["setup_status = 'ready'", "calling Complete a second time returns ok=true (idempotent)", "future intermediate statuses do not break completion"]
          notes: "Covers delta patch v1 §1 — future-proof transition guard"

        - name: "case-insensitive label uniqueness prevents duplicate tables"
          preconditions: ["casino with existing gaming_table 'BJ-01'"]
          action: "call createGamingTableAction with label='bj-01' (lowercase)"
          assertions: ["only 1 row exists for casino (no duplicate created)", "second call updates existing row via label_normalized conflict", "'BJ  01' and 'BJ 01' also conflict (whitespace normalization)"]
          notes: "Covers delta patch v1 §2 — case/whitespace-safe uniqueness"

        - name: "enum drift: no hard-coded game_type lists in Zod schemas"
          preconditions: ["types/database.types.ts regenerated with current game_type enum"]
          action: "run npm run type-check"
          assertions: ["gameTypeSchema is derived from Enums['game_type'] in database.types.ts", "no hard-coded game_type string arrays exist in wizard code", "adding a new game_type in DB does not require code changes in wizard"]
          notes: "Covers delta patch v1 §3 — enum drift prevention"

        - name: "resume-step determinism: wizard lands on correct step for each partial state"
          preconditions: ["various partial setup states (basics done, seed done, tables done, etc.)"]
          action: "simulate re-entry at each partial state"
          assertions: ["missing basics → Step 1", "no game_settings → Step 2", "no gaming_tables → Step 3", "tables exist → Step 4", "all steps satisfied → Step 5 available", "tables exist but no seed → routes to Step 2 (seed first)"]
          notes: "Covers delta patch v1 §4 — resume-step algorithm"

    validation:
      - "npm test services/casino/__tests__/setup-wizard-rpc.int.test.ts passes"
      - "All test cases cover happy path + error cases"
      - "Casino isolation verified (RLS cross-casino mutation blocked)"
      - "Table upsert idempotency verified (no duplicates)"
      - "Re-entry/refresh verified (no row duplication)"

  WS5:
    name: E2E Tests
    description: >
      Playwright E2E test for the full setup wizard flow:
      bootstrap → setup wizard (5 steps) → dashboard reachable.
      Includes skip flow and re-entry scenarios.
    executor: e2e-testing
    executor_type: skill
    depends_on: [WS3]
    outputs:
      - e2e/workflows/setup-wizard.spec.ts
      - e2e/fixtures/setup-wizard-fixtures.ts
    gate: test-pass
    estimated_complexity: high

    test_scenarios:
      - name: "Full wizard flow — bootstrap to dashboard"
        steps:
          - "1. Bootstrap casino via rpc_bootstrap_casino (fixture)"
          - "2. Authenticate as admin"
          - "3. Navigate to /start → redirects to /setup"
          - "4. Step 1: Verify timezone pre-filled, select INVENTORY_COUNT bank mode, click Next"
          - "5. Step 2: Click 'Seed Games', verify game list appears, click Next"
          - "6. Step 3: Add table 'BJ-01' with Blackjack type, click Next"
          - "7. Step 4: Enter par target $5000 for BJ-01, click Next"
          - "8. Step 5: Verify summary shows settings, games, tables, par. Click 'Complete Setup'"
          - "9. Verify redirect to /pit (dashboard)"

      - name: "Skip Setup flow — empty-state safety"
        steps:
          - "1. Bootstrap casino (fixture)"
          - "2. Authenticate as admin"
          - "3. Navigate to /setup"
          - "4. Click 'Skip Setup'"
          - "5. Verify redirect to /pit"
          - "6. Verify dashboard renders without runtime errors"
          - "7. Verify empty-state UI appears (e.g., 'No tables yet' + 'Continue Setup' CTA)"
          - "8. Verify 'Continue Setup' action navigates back into wizard per resume-step rules"

      - name: "Wizard re-entry after completion redirects to dashboard"
        preconditions: ["Casino with setup_status='ready'"]
        steps:
          - "1. Navigate to /setup"
          - "2. Verify redirect to /start → /pit (not the wizard)"

      - name: "Wizard mid-flow refresh does not duplicate data"
        steps:
          - "1. Bootstrap casino (fixture)"
          - "2. Authenticate as admin"
          - "3. Navigate to /setup, complete Step 1 (Casino Basics)"
          - "4. Complete Step 2 (Seed Games), complete Step 3 (add table 'BJ-01')"
          - "5. Refresh the page (F5)"
          - "6. Verify wizard resumes at correct step with existing data loaded"
          - "7. Verify no duplicate gaming_table rows for 'BJ-01'"
          - "8. Complete remaining steps, verify redirect to /pit"

    fixtures:
      setup_wizard_fixtures:
        - "createSetupWizardScenario(): bootstraps casino, returns { casinoId, authToken, testEmail, testPassword, cleanup }"
        - "cleanupSetupWizardScenario(): deletes gaming_tables, resets casino_settings, deletes casino"

    playwright_patterns:
      - "Use page.getByRole() and page.getByText() for selectors (accessibility-first)"
      - "Use page.waitForURL() for redirect assertions"
      - "Use test.describe() for grouping related scenarios"
      - "Use beforeAll/afterAll for fixture setup/cleanup"
      - "No hard waits — use Playwright auto-waiting"

    validation:
      - "npx playwright test e2e/workflows/setup-wizard.spec.ts passes"
      - "All 4 scenarios pass"
      - "No flaky tests (auto-waiting, proper fixtures)"

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: "Phase 1 — Foundation"
    parallel: [WS1]
    gates: [schema-validation]
    description: "Create rpc_complete_casino_setup migration, run npm run db:types"

  - name: "Phase 2 — Server Actions"
    parallel: [WS2]
    gates: [type-check]
    description: "Create 5 server actions + Zod schemas"

  - name: "Phase 3 — UI + Backend Tests"
    parallel: [WS3, WS4]
    gates: [type-check, test-pass]
    description: "Setup wizard UI (WS3) and RPC integration tests (WS4) in parallel"

  - name: "Phase 4 — E2E Validation"
    parallel: [WS5]
    gates: [test-pass, build]
    description: "Playwright E2E tests + full build validation"

# Validation Gates
gates:
  schema-validation:
    command: "npm run db:types"
    success_criteria: "Exit code 0, types regenerated with rpc_complete_casino_setup"

  type-check:
    command: "npm run type-check"
    success_criteria: "Exit code 0"

  lint:
    command: "npm run lint"
    success_criteria: "Exit code 0"

  test-pass:
    command: "npm test services/casino/__tests__/setup-wizard-rpc.int.test.ts"
    success_criteria: "All tests pass"

  build:
    command: "npm run build"
    success_criteria: "Exit code 0, no build errors"

# External Dependencies
external_dependencies:
  - prd: PRD-025
    service: CasinoService
    required_for: "rpc_bootstrap_casino, casino_settings with setup_status"
    status: deployed

  - prd: PRD-029
    service: CasinoService
    required_for: "rpc_seed_game_settings_defaults, extended game_type enum"
    status: deployed

  - prd: PRD-024
    service: CasinoService
    required_for: "/start gateway, setup_status + setup_completed_at columns"
    status: deployed

  - adr: ADR-027
    required_for: "table_bank_mode enum, par_total_cents column, session binding"
    status: deployed

# Risks
risks:
  - risk: "Cross-context server actions touch CasinoService + TableContextService tables"
    mitigation: "Each action targets one owned table; no cross-context writes in single action"

  - risk: "Skip flag bypass in completion RPC"
    mitigation: "Skip only bypasses table minimum check, not auth/role validation"

  - risk: "Onboarding layout max-w-lg too narrow for wizard"
    mitigation: "Widen to max-w-2xl or max-w-3xl for wizard steps with table forms"

  - risk: "Game seed RPC returns void — hard to confirm success"
    mitigation: "After seed, query game_settings to verify rows exist; display count"

  - risk: "No manager role in Enums.staff_role — original spec referenced non-existent role"
    mitigation: "Corrected to admin-only. Canonical enum: dealer, pit_boss, cashier, admin"

  - risk: "Table label uniqueness constraint may conflict with existing data (case/whitespace variants)"
    mitigation: "label_normalized generated column with case/whitespace normalization; migration fails fast with actionable error listing offending (casino_id, label) groups if pre-existing duplicates found — no automatic dedup, operator intervention required"

  - risk: "Skip Setup allows empty-tenant state to reach dashboards"
    mitigation: "Feature-flagged (NEXT_PUBLIC_ENABLE_SKIP_SETUP); empty-state UX required in DoD"

---

# EXECUTION-SPEC: PRD-030 — Setup Wizard

## Overview

PRD-030 implements the Setup Wizard (Wizard B) — a 5-step guided onboarding flow that takes a freshly bootstrapped casino from `setup_status='not_started'` to `setup_status='ready'`. This is a P0 blocker: without it, no new tenant can reach the operational dashboard.

**All schema and RPC dependencies are already deployed** (PRD-025, PRD-029, PRD-024, ADR-027). This PRD adds: 1 new RPC, 5 server actions, 1 multi-step wizard UI.

## Authorization

**Allowed roles** (canonical `Enums.staff_role` values from `database.types.ts`):
- Setup wizard completion RPC: **`admin`** only
- Server actions (settings, seed, tables, par): **`admin`** (enforced via RLS + middleware context)
- All other roles (`dealer`, `pit_boss`, `cashier`) are rejected

## Scope

**In Scope:**
- `rpc_complete_casino_setup` SECURITY DEFINER RPC (migration) — idempotent
- 5 server actions (complete, settings, seed, create-table via upsert, update-par)
- 5-step wizard UI at `/setup` replacing placeholder
- Table uniqueness via `label_normalized` generated column + unique index on `gaming_table(casino_id, label_normalized)`
- Skip Setup feature-flagged via `NEXT_PUBLIC_ENABLE_SKIP_SETUP`
- Backend integration tests for RPC (including RLS isolation + re-entry)
- E2E test for full wizard flow (including mid-flow refresh)

**Out of Scope:**
- No new database tables. Schema alteration to `gaming_table` (generated `label_normalized` column + unique index) is **in scope** to guarantee idempotent table creation.
- No `table_par_policy` append-only table (P2)
- No IMPREST_TO_PAR specific bootstrap path
- No par import from spreadsheet (Strategy A)
- No post-setup settings editing (planned: shift dashboard workflows will expose settings editing)
- No floor layout / spatial placement
- No game_settings variant selection (type-only for v0; would require `gaming_table.game_settings_id` FK)

## Architecture Context

- **CasinoService** (SRM v4.12.0) owns: `casino_settings`, `game_settings`
- **TableContextService** (SRM v4.12.0) owns: `gaming_table`
- **ADR-024**: All RPCs derive context from `set_rls_context_from_staff()` — no spoofable params
- **ADR-018**: SECURITY DEFINER governance for completion RPC
- **ADR-027**: `table_bank_mode` enum, `par_total_cents` column, session binding

## Workstream Details

### WS1: Setup Completion RPC Migration

**Purpose**: Create the `rpc_complete_casino_setup` function that idempotently transitions `setup_status` from any non-ready state to `'ready'`.

**Deliverables**:
1. Migration: `supabase/migrations/20260211020000_prd030_rpc_complete_casino_setup.sql`
2. `label_normalized` generated column on `gaming_table`: `lower(trim(regexp_replace(label, '\s+', ' ', 'g')))`
3. Unique index on `gaming_table(casino_id, label_normalized)` for case/whitespace-safe uniqueness
4. Types regenerated via `npm run db:types`

**Acceptance Criteria**:
- [ ] RPC is SECURITY DEFINER with `SET search_path = pg_catalog, public`
- [ ] Calls `set_rls_context_from_staff()` as first operation
- [ ] Derives `casino_id` from `current_setting('app.casino_id')` — no parameter
- [ ] Validates role = `'admin'` (canonical `Enums.staff_role`; no `manager` exists)
- [ ] Validates at least 1 `gaming_table` exists (unless `p_skip = true`)
- [ ] Transitions from any non-ready state (not just `'not_started'`) — future-proof for intermediate statuses
- [ ] Atomically sets `setup_status = 'ready'`, `setup_completed_at = now()`, `setup_completed_by = actor_id`
- [ ] Returns stored values via `RETURNING` (update path) or direct `SELECT` (idempotent path) — no `now()` drift
- [ ] Returns success (idempotent) if `setup_status` already `'ready'` — no error
- [ ] Returns `NOT_FOUND` error if `casino_settings` row missing
- [ ] Migration fails fast with actionable error if pre-existing duplicate labels found before creating unique index
- [ ] `GRANT EXECUTE` to `authenticated` role
- [ ] `NOTIFY pgrst, 'reload schema'` at end of migration
- [ ] `npm run db:types` succeeds

### WS2: Setup Wizard Server Actions

**Purpose**: Five server actions providing the backend glue between wizard UI and database. Each step persists on "Next" (FR-9 persistence model).

**Deliverables**:
1. `app/(onboarding)/setup/_actions.ts` — 5 server actions
2. Schema additions to `services/casino/schemas.ts` (setup-specific schemas)

**Acceptance Criteria**:
- [ ] All actions use `withServerAction()` middleware
- [ ] All actions assert `staff_role === 'admin'` in middleware prior to DB calls (explicit admin-only enforcement)
- [ ] All actions return `ServiceResult<T>`
- [ ] All inputs validated with Zod schemas
- [ ] `casino_id` derived from middleware context, never from user input
- [ ] `createGamingTableAction` upserts on `(casino_id, label_normalized)` — no duplicates on re-run (case/whitespace safe)
- [ ] `createGamingTableAction` type field validated against `Enums['game_type']` derived from `database.types.ts` (no hard-coded list)
- [ ] `createGamingTableAction` sets `status: 'active'` on created tables
- [ ] `updateTableParAction` stamps `par_updated_at` and `par_updated_by` (confirmed in schema)
- [ ] `completeSetupAction` returns idempotent success when already ready
- [ ] `npm run type-check` passes

### WS3: Setup Wizard UI (5-Step Flow)

**Purpose**: Multi-step wizard replacing the placeholder at `/setup`.

**Deliverables**:
1. Server component page with data prefetch
2. Client wizard orchestrator with step navigation
3. 5 step components + supporting UI components
4. Widened onboarding layout for wizard

**Acceptance Criteria**:
- [ ] All 5 steps render and navigate correctly
- [ ] Each step persists data on "Next" (server write, not draft-only)
- [ ] Bank mode selector has explanatory copy per dual-policy doc
- [ ] Par targets labeled "Target Bankroll (Par)" with bank-mode-aware tooltips; helper text: "Sometimes called the table's need baseline (not live fill need). Used for variance + fill-pressure heuristics in Inventory Count." ('need' allowed in helper/tooltip, not primary label)
- [ ] Step 3 type dropdown populated from `Enums.game_type`, not seeded game_settings
- [ ] Skip Setup gated by `NEXT_PUBLIC_ENABLE_SKIP_SETUP` feature flag
- [ ] Re-entry detects existing state (idempotent, no row duplication) via deterministic resume-step algorithm
- [ ] All async operations use `useTransition` (no manual loading states)
- [ ] No `console.*` calls in production
- [ ] No `useEffect` sync anti-patterns
- [ ] `npm run type-check` passes

### WS4: Backend Integration Tests

**Purpose**: RPC contract tests verifying security, role enforcement, and business logic.

**Deliverables**:
1. `services/casino/__tests__/setup-wizard-rpc.int.test.ts`

**Acceptance Criteria**:
- [ ] Tests: admin success, pit_boss/cashier/dealer rejection, no-tables rejection, skip bypass, idempotent success on re-call, casino isolation (RLS)
- [ ] Table upsert no-duplication test (re-run Step 3 multiple times)
- [ ] Wizard re-entry/refresh test (previously saved state loads, no duplicate rows)
- [ ] All tests pass via `npm test`

### WS5: E2E Tests

**Purpose**: Playwright E2E covering the full onboarding → setup → dashboard flow.

**Deliverables**:
1. `e2e/workflows/setup-wizard.spec.ts`
2. `e2e/fixtures/setup-wizard-fixtures.ts`

**Acceptance Criteria**:
- [ ] Full wizard flow (5 steps) passes
- [ ] Skip flow passes (when feature flag enabled) — dashboard renders, empty-state UI appears, "Continue Setup" CTA works
- [ ] Re-entry after completion redirects to dashboard
- [ ] Mid-flow refresh does not duplicate data
- [ ] No hard waits — Playwright auto-waiting only
- [ ] `npx playwright test e2e/workflows/setup-wizard.spec.ts` passes

## Definition of Done

- [ ] All 5 workstreams complete
- [ ] All gates pass (schema-validation, type-check, lint, test-pass, build)
- [ ] No regressions in existing tests
- [ ] Security: ADR-024 compliance (no spoofable params)
- [ ] Security: ADR-018 compliance (SECURITY DEFINER governance)
- [ ] Authorization: only `admin` role allowed (canonical `Enums.staff_role`; no `manager` exists)
- [ ] Idempotency: `rpc_complete_casino_setup` returns success when already ready
- [ ] Uniqueness: `gaming_table(casino_id, label_normalized)` constraint enforced (case/whitespace safe); no duplicates on wizard re-entry
- [ ] Schema verified: `gaming_table.par_updated_at` and `gaming_table.par_updated_by` exist (confirmed)
- [ ] Skip Setup gated by `NEXT_PUBLIC_ENABLE_SKIP_SETUP` feature flag
- [ ] Dashboards render correctly with zero tables and `setup_status != 'ready'` (empty-state UX)
- [ ] UI terminology: "Target Bankroll (Par)" as primary label — 'need' allowed in helper/tooltip only
- [ ] Step 3 type dropdown uses `Enums.game_type`, not seeded game_settings variants
- [ ] RLS isolation test: cross-casino mutation blocked
- [ ] No `console.*` in production code
- [ ] No `as any` casts; no type-casts to force enum values — derive from `database.types.ts`
- [ ] Types from `database.types.ts` only
- [ ] No hard-coded `game_type` string arrays — all enum constraints sourced from `database.types.ts`
- [ ] Resume-step algorithm implemented: deterministic step routing on re-entry/refresh
- [ ] Completion RPC transitions from any non-ready state (future-proof transition guard)
- [ ] Completion RPC returns stored timestamps via RETURNING/SELECT (no now() drift)
- [ ] Admin-only enforcement is explicit: all server actions assert staff_role === 'admin' in middleware
- [ ] Migration fails fast on pre-existing duplicate labels (no surprise index creation failure)
- [ ] Skip Setup E2E asserts empty-state safety: dashboard renders, empty-state UI, "Continue Setup" CTA
- [ ] Step 5 available when steps 1–3 satisfied; Step 4 (Par Targets) is recommended but optional

## Delta Patches Applied

### Delta Patch v0 (`PRD-030-setup-wizard-v0.delta-patch.md`)

This spec incorporates all 9 sections from the v0 delta patch:
1. Step persistence model (FR-9) — each step writes on Next
2. `game_type` enum vs `game_settings` variant mismatch resolved (type-only for v0)
3. `rpc_complete_casino_setup` made idempotent (returns success when already ready)
4. Skip Setup gated via feature flag (Option A)
5. Table uniqueness constraint `(casino_id, label)` with upsert semantics
6. `par_updated_at/by` schema verified (columns confirmed present)
7. Role prose replaced with canonical `Enums.staff_role` values (`admin` only; no `manager` in enum)
8. UI terminology: "Target Bankroll (Par)" replaces "Target Need (Par)"
9. Two high-value tests added (RLS isolation + wizard re-entry/refresh)

### Delta Patch v1 (`EXECUTION-SPEC-PRD-030.delta-patch.v1.md` — Audit Pass 2)

This spec incorporates all 7 sections from the v1 delta patch:
1. **Future-proof transition guard**: RPC transitions from any non-ready state (not just `'not_started'`), removing the `CONFLICT` error for unexpected statuses
2. **Case/whitespace-safe label uniqueness**: `label_normalized` generated column (`lower(trim(regexp_replace(...)))`) + unique index on `(casino_id, label_normalized)` — "BJ-01" and "bj-01" conflict, not duplicate
3. **Enum drift prevention**: `game_type` Zod schema derived from `Enums['game_type']` in `database.types.ts` — no hard-coded string arrays
4. **Deterministic resume-step algorithm**: server-fetched state drives step routing on re-entry (basics → seed → tables → par → review)
5. **Linear stepper vs Skip clarified**: "No forward step jumping"; Skip exits wizard early, not "jump to Step 5"
6. **Ops vernacular in helper text**: 'need' allowed in helper/tooltip ("need baseline"), but NOT in primary label ("Target Bankroll (Par)")
7. **Acceptance tests added**: case-insensitive uniqueness, enum drift, resume-step determinism

### Delta Patch v2 (`EXECUTION-SPEC-PRD-030.delta-patch.v2.md` — Audit Pass 3)

This spec incorporates all 7 sections from the v2 delta patch (cleanup pass):
1. **Stale uniqueness wording fixed**: All references to `(casino_id, label)` updated to `(casino_id, label_normalized)`
2. **"No new tables" clarified**: Schema alteration to `gaming_table` (generated column + unique index) is explicitly in scope
3. **Stored timestamps via RETURNING**: RPC returns stored values from `RETURNING`/`SELECT` — no `now()` drift between calls
4. **Skip Setup E2E hardened**: Asserts empty-state safety (dashboard renders, "No tables yet", "Continue Setup" CTA works)
5. **Admin-only enforcement explicit**: All server actions assert `staff_role === 'admin'` in middleware prior to DB calls (not RLS-only)
6. **Duplicate-label migration behavior**: Migration fails fast with actionable error listing offending `(casino_id, label)` groups if pre-existing duplicates found
7. **Step 4 optionality resolved**: Step 5 available when steps 1–3 satisfied; Step 4 (Par Targets) is recommended but optional

**Additional note**: Post-setup settings editing is a planned feature — will be delivered via shift dashboard workflows (not deferred indefinitely).
