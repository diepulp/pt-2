---
# EXECUTION-SPEC: SEC-REMEDIATION-2026-02-19
# Generated by prd-pipeline (lead-architect scaffold + rls-expert refinement)

prd: SEC-REMEDIATION-2026-02-19
prd_title: "Comprehensive Security Posture Fix Plan"
service: SecurityCrossCutting
mvp_phase: 2

# Pre-existing artifacts (already shipped)
pre_existing:
  - id: P1-MIG-3
    name: "P1 Migration 3: REVOKE/GRANT + M-4 + L-3"
    file: "supabase/migrations/20260220004200_adr018_revoke_public_security_remediation.sql"
    findings: [M-1, M-2, M-3, M-4, L-3]
    status: shipped

workstreams:
  WS1:
    name: "TG-1: Fix bypass-lockdown.test.ts"
    description: >
      Replace fail() (undefined in Jest 30) with proper assertion pattern.
      Add onboarding exemption to glob ignore list (ADR-030 D6).
      Update test description to document exemption.
    executor: rls-expert
    executor_type: skill
    depends_on: []
    outputs:
      - lib/supabase/__tests__/bypass-lockdown.test.ts
    gate: test-pass
    estimated_complexity: low
    findings: [TG-1]

  WS2:
    name: "P0 Migration: C-1/C-2 DROP+CREATE, H-4 Role Gate"
    description: >
      CRITICAL severity remediation. DROP old signatures with p_actor_id for
      rpc_create_pit_cash_observation (9-param → 8-param) and
      rpc_log_table_buyin_telemetry (9-param → 8-param). Must use DROP+CREATE
      (not CREATE OR REPLACE) per Decision 2 — param count change creates
      second overload. Also: rpc_enroll_player CREATE OR REPLACE to add
      role gate (pit_boss, admin). C-2 relaxes amount_cents to <> 0 and
      expands telemetry_kind to include RATED_ADJUSTMENT.
    executor: rls-expert
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - supabase/migrations/YYYYMMDDHHMMSS_sec_audit_p0_actor_id_bypass_remediation.sql
    gate: schema-validation
    estimated_complexity: high
    findings: [C-1, C-2, H-4]

  WS3:
    name: "P0 Post-Migration Validation & Integration Test Refactor"
    description: >
      After P0 migration: (1) run db:types-local to regenerate types,
      (2) run catalog assertion SQL to verify no p_actor_id overloads survive,
      (3) run repo-wide grep confirming no prod callers pass removed params,
      (4) refactor 3 integration test files to use authenticated users
      instead of p_actor_id. Files:
        - lib/supabase/__tests__/rls-pooling-safety.integration.test.ts (3 tests)
        - __tests__/services/table-context/shift-metrics.int.test.ts (~12 calls)
        - __tests__/services/table-context/finance-telemetry-bridge.int.test.ts (4 calls)
    executor: rls-expert
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - __tests__/services/table-context/shift-metrics.int.test.ts
      - __tests__/services/table-context/finance-telemetry-bridge.int.test.ts
    # Pre-existing file edited in-place (exempt from location/naming governance)
    modifies:
      - lib/supabase/__tests__/rls-pooling-safety.integration.test.ts
    gate: type-check
    estimated_complexity: high
    findings: [C-1, C-2]

  WS4:
    name: "P1 Migration 2: Shift Metrics Service-Role Gate + Grant Lockdown"
    description: >
      Option 2: Single function (service_role-only) + authenticated wrappers.
      For each of 3 RPCs (H-1/H-2/H-3): (1) CREATE OR REPLACE renaming
      p_actor_id → p_internal_actor_id, add current_user gate + casino scope
      validation, (2) REVOKE EXECUTE FROM authenticated on 3-param versions,
      (3) CREATE 2-param wrapper functions for authenticated callers that
      delegate to 3-param version with NULL. Each function enforces its own
      gate independently. Delegation chain preserved.
    executor: rls-expert
    executor_type: skill
    depends_on: [WS3]
    outputs:
      - supabase/migrations/YYYYMMDDHHMMSS_sec_h1_h2_h3_shift_metrics_service_role_gate.sql
    gate: type-check
    estimated_complexity: high
    findings: [H-1, H-2, H-3]
    merge_gate: >
      BLOCKING: INV-8 PASS requires authenticated role has NO EXECUTE
      on RPCs accepting p_internal_actor_id. Without this, PR cannot merge.

  WS5:
    name: "TG-2: Fix lint-rls-write-path.regression.sh"
    description: >
      Fix synthetic violation in regression test. Current synthetic violation
      spans multiple lines (heredoc creates .from() and .insert() on separate
      lines); grep pattern requires single-line .from('TABLE').insert(.
      Fix: change heredoc to emit single-line chained call matching real
      code patterns.
    executor: rls-expert
    executor_type: skill
    depends_on: [WS3]
    outputs:
      - scripts/__tests__/lint-rls-write-path.regression.sh
    gate: test-pass
    estimated_complexity: low
    findings: [TG-2]

  WS6:
    name: "P2 Migration: NULLIF + search_path Standardization"
    description: >
      L-1 + L-5: Replace game_settings_side_bet RLS policies — add NULLIF()
      wrappers to current_setting calls (empty string → NULL for COALESCE),
      remove dead 'manager' role reference (change to 'admin' only).
      L-2: Dynamic search_path standardization — ALTER FUNCTION SET
      search_path = pg_catalog, public for all rpc_% SECURITY DEFINER
      functions in public schema missing the setting. Restricted to
      project RPCs only, transaction-wrapped.
    executor: rls-expert
    executor_type: skill
    depends_on: [WS4]
    outputs:
      - supabase/migrations/YYYYMMDDHHMMSS_fix_game_settings_side_bet_nullif_and_search_path.sql
    gate: schema-validation
    estimated_complexity: medium
    findings: [L-1, L-2, L-5]

  WS7:
    name: "TG-3: Catalog Audit Script"
    description: >
      One-time pg_proc audit script that queries all rpc_* functions and
      checks whether their source contains set_rls_context. More reliable
      than scanning migration files — validates current function definitions.
      Output as shell script that can be run against local Supabase.
    executor: rls-expert
    executor_type: skill
    depends_on: [WS4]
    outputs:
      - scripts/audit-rpc-context-injection.sh
    gate: lint
    estimated_complexity: low
    findings: [TG-3]

  WS8:
    name: "TG-4: Category B Policy Lint Documentation"
    description: >
      Document Category B policy lint (scripts/lint-rls-category-b-policies.sh)
      as local-only check in CI pipeline spec. Already has graceful degradation
      (exits 0 with WARNING when no DB available). Add optional CI step that
      runs when DATABASE_URL is provided.
    executor: rls-expert
    executor_type: skill
    depends_on: []
    outputs:
      - docs/deployments/CICD-PIPELINE-SPEC.md
    gate: lint
    estimated_complexity: low
    findings: [TG-4]

execution_phases:
  - name: "Phase 1 - Test Infrastructure Fix"
    parallel: [WS1]
    gates: [test-pass]

  - name: "Phase 2 - P0 Critical Security Migration"
    parallel: [WS2]
    gates: [schema-validation]

  - name: "Phase 3 - P0 Post-Migration Validation"
    parallel: [WS3]
    gates: [type-check]

  - name: "Phase 4 - P1 Defense-in-Depth"
    parallel: [WS4, WS5]
    gates: [type-check, test-pass]

  - name: "Phase 5 - P2 Hardening"
    parallel: [WS6, WS7, WS8]
    gates: [schema-validation, lint]

gates:
  schema-validation:
    command: "npm run db:types-local"
    success_criteria: "Exit code 0, types regenerated successfully"

  type-check:
    command: "npm run type-check"
    success_criteria: "Exit code 0, no type errors"

  test-pass:
    command: "npm test (affected files)"
    success_criteria: "All tests pass"

  lint:
    command: "npm run lint --max-warnings=0"
    success_criteria: "Exit code 0, max-warnings=0"

  build:
    command: "npm run build"
    success_criteria: "Exit code 0"

  catalog-assertion:
    command: "SQL: SELECT proname FROM pg_proc WHERE proname IN (...) AND identity_args ILIKE '%p_actor_id%'"
    success_criteria: "0 rows returned (no surviving vulnerable overloads)"

risks:
  - risk: "C-1/C-2 DROP changes function signature — integration tests break"
    mitigation: "WS3 refactors tests immediately after migration. Type-check catches any remaining callers."
  - risk: "P1 Migration 2 grant lockdown may break authenticated callers"
    mitigation: "Public wrapper functions maintain authenticated access. Verify via type-check + integration tests."
  - risk: "P2 search_path DO block may fail on edge cases"
    mitigation: "Restricted to public.rpc_% only. Transaction-wrapped — full rollback on failure."
---

# EXECUTION-SPEC: SEC-REMEDIATION-2026-02-19

## Overview

Comprehensive security posture remediation implementing 4 SQL migrations + 3 code fixes across 3 priority tiers (P0/P1/P2). Addresses CRITICAL (C-1, C-2), HIGH (H-1 through H-4), MEDIUM (M-1 through M-4), and LOW (L-1 through L-5) findings from the SEC-AUDIT-2026-02-19 RLS Violations Matrix.

**P1 Migration 3 already shipped** (`20260220004200_adr018_revoke_public_security_remediation.sql`) covering M-1/M-2/M-3/M-4/L-3.

**Zero production TypeScript changes required.** All production callers already use the secure code path. Verified by:
- **CI grep gate** (Audit Fix #5): Scan `app/`, `lib/`, `services/`, `hooks/` (excluding `__tests__/`, `*.test.*`, `test-utils/`) for `.rpc('rpc_create_pit_cash_observation'` and `.rpc('rpc_log_table_buyin_telemetry'` calls passing `p_actor_id` in arg objects. Fail condition: any match found.
- **typegen + type-check**: `npm run db:types-local && npm run type-check` — the definitive backstop. Removed params surface as TS errors in any caller.

## Scope

- **In Scope**: P0 migration (C-1, C-2, H-4), P1 Migration 2 (H-1, H-2, H-3), P2 migration (L-1, L-2, L-5), test fixes (TG-1, TG-2), catalog audit script (TG-3), CI documentation (TG-4)
- **Out of Scope**: M-4 Phase 2 (remove p_actor_id from rpc_start_rating_slip signature — requires TS changes), P0.5 operational bug (p_source: 'pit_manual')

## Architecture Context

- **ADR-024** (Frozen): Authoritative context derivation. INV-7: mandatory self-injection. INV-8: no spoofable identity params.
- **ADR-030**: Auth pipeline hardening. Write-path session-var enforcement on critical tables.
- **ADR-018**: SECURITY DEFINER governance. Explicit grant lists, REVOKE ALL FROM PUBLIC.
- **Decision 1**: Service-role gated bypass for shift metrics RPCs (H-1/H-2/H-3). Path B with public wrappers.
- **Decision 2**: DROP + CREATE (not CREATE OR REPLACE) for C-1/C-2 — param count change creates second overload.

## Workstream Details

### WS1: TG-1 — Fix bypass-lockdown.test.ts

**Purpose**: Fix test infrastructure before P0 migration to prevent silent test failures.

**File**: `lib/supabase/__tests__/bypass-lockdown.test.ts`

**Changes**:
1. **Line 153**: Replace `fail(...)` (undefined in Jest 30) with throw-only pattern:
   ```typescript
   // Throw-only: single deterministic assertion with detailed message
   if (violations.length > 0) {
     throw new Error(
       `skipAuth: true found in production source files (AUTH-HARDENING v0.1 WS4):\n` +
       violations.map((v) => `  - ${v}`).join('\n') +
       '\n\nMove skipAuth usage to __tests__/ or test-utils/ directories.'
     );
   }
   ```
   **NOTE (Audit Fix #1):** Use exactly ONE assertion pattern. Do NOT combine
   `expect().toEqual([])` with a throw — the expect already fails before the
   throw is reached, making it dead code.
2. **Line 131 ignore list**: Add `'**/app/(onboarding)/**'` (ADR-030 D6 exemption)
3. Update test description to document onboarding exemption

**Acceptance Criteria**:
- [ ] `npm test lib/supabase/__tests__/bypass-lockdown.test.ts` passes
- [ ] No `fail()` calls remain in test file
- [ ] Exactly one assertion pattern used (throw-only, no mixed expect+throw)
- [ ] Onboarding routes exempted with documented reason

---

### WS2: P0 Migration — C-1/C-2 DROP+CREATE, H-4 Role Gate

**Purpose**: Remove CRITICAL p_actor_id bypass from 2 RPCs, add role gate to rpc_enroll_player.

**Migration**: `supabase/migrations/YYYYMMDDHHMMSS_sec_audit_p0_actor_id_bypass_remediation.sql`

**C-1: rpc_create_pit_cash_observation**
```sql
-- DROP old 9-param signature (includes p_actor_id)
DROP FUNCTION IF EXISTS public.rpc_create_pit_cash_observation(
  uuid, numeric, uuid, observation_amount_kind, observation_source, timestamptz, text, text, uuid
);

-- CREATE new 8-param signature (p_actor_id removed)
CREATE FUNCTION public.rpc_create_pit_cash_observation(
  p_visit_id uuid,
  p_amount numeric,
  p_rating_slip_id uuid DEFAULT NULL,
  p_amount_kind observation_amount_kind DEFAULT 'estimate',
  p_source observation_source DEFAULT 'walk_with',
  p_observed_at timestamptz DEFAULT NULL,
  p_note text DEFAULT NULL,
  p_idempotency_key text DEFAULT NULL
) RETURNS pit_cash_observation ...
-- Body: unconditional set_rls_context_from_staff(), no p_actor_id bypass branch
-- GRANT: authenticated only (service_role removed — no server-side callers confirmed)
```

**C-2: rpc_log_table_buyin_telemetry**
```sql
-- DROP old signature (includes p_actor_id)
DROP FUNCTION IF EXISTS public.rpc_log_table_buyin_telemetry(
  uuid, bigint, text, uuid, uuid, text, text, text, uuid
);

-- CREATE new signature (p_actor_id removed)
-- Updated: amount_cents validation <> 0 (supports negative RATED_ADJUSTMENT)
-- Updated: telemetry_kind includes 'RATED_ADJUSTMENT'
-- GRANT: authenticated only (service_role removed)
```

**H-4: rpc_enroll_player**
```sql
-- CREATE OR REPLACE (body-only change — no signature change)
-- Add role gate after context injection:
--   v_staff_role := NULLIF(current_setting('app.staff_role', true), '');
--   IF v_staff_role IS NULL OR v_staff_role NOT IN ('pit_boss', 'admin') THEN
--     RAISE EXCEPTION 'FORBIDDEN: Role not authorized for player enrollment';
--   END IF;
-- Role derived from context/JWT only — never from parameter
```

**Post-Migration Catalog Assertion**:
```sql
SELECT p.proname, pg_get_function_identity_arguments(p.oid) AS identity_args
FROM pg_proc p JOIN pg_namespace n ON p.pronamespace = n.oid
WHERE n.nspname = 'public'
  AND p.proname IN ('rpc_create_pit_cash_observation', 'rpc_log_table_buyin_telemetry')
  AND pg_get_function_identity_arguments(p.oid) ILIKE '%p_actor_id%';
-- Must return 0 rows
```

**Pre-Migration Verification** (Audit Fix #5 optional):
- Grep `app/`, `lib/`, `services/` for `.rpc('rpc_create_pit_cash_observation'` and `.rpc('rpc_log_table_buyin_telemetry'` to confirm no server-side callers use `service_role` before removing that grant.

**Acceptance Criteria**:
- [ ] `npm run db:types-local` succeeds
- [ ] Catalog assertion returns 0 rows
- [ ] `npm run type-check` passes (TypeScript surfaces any callers of removed param)
- [ ] No `service_role` GRANT on C-1/C-2 RPCs (verified by grep)
- [ ] CI grep gate: `grep -r "p_actor_id" app/ lib/ services/ hooks/ --include='*.ts' --include='*.tsx' --exclude-dir='__tests__'` returns 0 matches for C-1/C-2 RPCs

---

### WS3: P0 Post-Migration Validation & Integration Test Refactor

**Purpose**: Validate P0 migration applied correctly and refactor integration tests.

**Validation Steps**:
1. `npm run db:types-local` — regenerate `types/database.types.ts`
2. Run catalog assertion SQL (WS2 acceptance)
3. Repo-wide grep: no production calls pass `p_actor_id` to remediated RPCs
4. `npm run type-check` — compiler catches any remaining old-signature callers

**Test Refactoring**:

| File | Current Pattern | New Pattern |
|------|----------------|-------------|
| `rls-pooling-safety.integration.test.ts` | Passes `p_actor_id` to RPCs | Use authenticated test user with JWT |
| `shift-metrics.int.test.ts` | ~12 calls with `p_actor_id` | Use service_role client (these RPCs still accept p_actor_id until WS4) |
| `finance-telemetry-bridge.int.test.ts` | 4 calls with `p_actor_id` | Use authenticated test user with JWT |

**Post-WS4 Follow-Up (Audit Fix #6):** After WS4 completes, update shift-metrics tests to use the authenticated 2-param wrapper overloads. Tests exercising the service_role path should explicitly use service_role client; all other tests should use authenticated wrappers to match the new API boundary.

**Acceptance Criteria**:
- [ ] `npm run type-check` passes with zero suppressions
- [ ] `npm test` passes for all 3 refactored test files
- [ ] Grep confirms no production files reference `p_actor_id` for C-1/C-2 RPCs

---

### WS4: P1 Migration 2 — Shift Metrics Service-Role Gate + Grant Lockdown

**Purpose**: Gate p_actor_id bypass to service_role only. Satisfy INV-8 with grant lockdown.

**Migration**: `supabase/migrations/YYYYMMDDHHMMSS_sec_h1_h2_h3_shift_metrics_service_role_gate.sql`

**Approach: Option 2 (Single Function + Authenticated Wrappers)**

**(Audit Fix #2/#3): One coherent approach, consistent naming, correct privilege syntax.**

For each of the 3 RPCs (`rpc_shift_table_metrics`, `rpc_shift_pit_metrics`, `rpc_shift_casino_metrics`):

**Step 1: CREATE OR REPLACE** the 3-param version with service_role gate:
```sql
-- Rename p_actor_id → p_internal_actor_id for clarity
CREATE OR REPLACE FUNCTION public.rpc_shift_table_metrics(
  p_window_start timestamptz,
  p_window_end timestamptz,
  p_internal_actor_id uuid DEFAULT NULL
) RETURNS TABLE (...) AS $$
BEGIN
  -- Gate: p_internal_actor_id is service_role-only
  IF p_internal_actor_id IS NOT NULL THEN
    IF current_user <> 'service_role' THEN
      RAISE EXCEPTION 'FORBIDDEN: p_internal_actor_id bypass is restricted to service_role'
        USING ERRCODE = 'P0001';
    END IF;
    -- Also validate actor belongs to resolved casino scope (Audit Fix #4)
    IF NOT EXISTS (
      SELECT 1 FROM staff
      WHERE id = p_internal_actor_id
        AND casino_id = NULLIF(current_setting('app.casino_id', true), '')::uuid
    ) THEN
      RAISE EXCEPTION 'FORBIDDEN: actor does not belong to resolved casino scope';
    END IF;
  END IF;
  -- ... rest of function body using p_internal_actor_id ...
END;
$$;
```

**Step 2: Revoke authenticated, grant service_role** on the 3-param version:
```sql
-- Correct Postgres privilege syntax (Audit Fix #2)
REVOKE EXECUTE ON FUNCTION public.rpc_shift_table_metrics(timestamptz, timestamptz, uuid) FROM authenticated;
GRANT EXECUTE ON FUNCTION public.rpc_shift_table_metrics(timestamptz, timestamptz, uuid) TO service_role;
```

**Step 3: Create authenticated wrappers** (2-param, no actor param):
```sql
CREATE OR REPLACE FUNCTION public.rpc_shift_table_metrics(
  p_window_start timestamptz,
  p_window_end timestamptz
) RETURNS TABLE (...same columns...)
LANGUAGE plpgsql SECURITY INVOKER SET search_path = pg_catalog, public AS $$
BEGIN
  RETURN QUERY SELECT * FROM public.rpc_shift_table_metrics(p_window_start, p_window_end, NULL::uuid);
END;
$$;
GRANT EXECUTE ON FUNCTION public.rpc_shift_table_metrics(timestamptz, timestamptz) TO authenticated;
```

**Step 4: Verify privileges** via catalog query:
```sql
-- Must show: 3-param → service_role only; 2-param → authenticated
SELECT p.proname, pg_get_function_identity_arguments(p.oid) AS args,
  array_agg(g.grantee) AS grantees
FROM information_schema.routine_privileges g
JOIN pg_proc p ON p.proname = g.routine_name
WHERE p.proname LIKE 'rpc_shift_%'
GROUP BY p.proname, args;
```

**Delegation chain**: `rpc_shift_casino_metrics(ts, ts)` wrapper → `rpc_shift_casino_metrics(ts, ts, NULL)` (service_role-only) → calls `rpc_shift_table_metrics(ts, ts, NULL)`. Each function enforces its own gate independently.

**Acceptance Criteria**:
- [ ] authenticated role CANNOT call 3-param RPCs (verified via privilege catalog query)
- [ ] authenticated role CAN call 2-param wrapper RPCs
- [ ] service_role can pass p_internal_actor_id, but ONLY for actors in resolved casino scope (Audit Fix #4)
- [ ] Migration dry-run passes without syntax errors
- [ ] `npm run type-check` passes (TypeScript picks up new overloads)
- [ ] `npm test __tests__/services/table-context/shift-metrics.int.test.ts` passes
- [ ] INV-8 verification: no authenticated-callable RPC accepts actor_id param
- [ ] Naming is consistent: `p_internal_actor_id` everywhere (no `p_actor_id` remnants)

---

### WS5: TG-2 — Fix lint-rls-write-path.regression.sh

**Purpose**: Fix synthetic violation detection in regression test.

**File**: `scripts/__tests__/lint-rls-write-path.regression.sh`

**Root Cause**: Lines 47-58 create a heredoc with `.from()` and `.insert()` on separate lines. The lint script's grep pattern requires single-line `.from('TABLE').insert(`.

**Fix**: Replace the heredoc (lines 47-58) to emit a single-line chained call.
Use unquoted heredoc `EOF` (not `'EOF'`) so shell expands `$FIRST_TABLE` inline:
```bash
cat > "$VIOLATION_FILE" << EOF
// Synthetic violation for regression testing
export async function syntheticViolation(ctx: { supabase: any }) {
  const { data } = await ctx.supabase.from('${FIRST_TABLE}').insert({ first_name: 'test' }).select().single();
  return data;
}
EOF
```
This is the prescribed approach — no `sed` post-processing needed.

**Acceptance Criteria**:
- [ ] `bash scripts/__tests__/lint-rls-write-path.regression.sh` exits 0 (PASS)
- [ ] Lint correctly detects the single-line synthetic violation

---

### WS6: P2 Migration — NULLIF + search_path Standardization

**Purpose**: Consistency fixes for RLS policies and SECURITY DEFINER functions.

**Migration**: `supabase/migrations/YYYYMMDDHHMMSS_fix_game_settings_side_bet_nullif_and_search_path.sql`

**L-1 + L-5: game_settings_side_bet RLS policies**

Replace 3 policies (SELECT, INSERT, UPDATE) with NULLIF-wrapped versions:
```sql
-- Before (broken: empty string not handled)
casino_id = COALESCE(
  current_setting('app.casino_id', true)::uuid,
  ...
)

-- After (correct: NULLIF handles empty string)
casino_id = COALESCE(
  NULLIF(current_setting('app.casino_id', true), '')::uuid,
  ((auth.jwt()->'app_metadata')::jsonb->>'casino_id')::uuid
)
```

Remove dead `'manager'` role reference — change to `'admin'` only:
```sql
-- Before
) IN ('admin', 'manager')

-- After
= 'admin'
```

**L-2: search_path standardization**

**Transaction Requirement (Audit Fix #7):** Migration MUST run within a transaction. Abort on first failure; no partial apply. If any ALTER FUNCTION fails, the entire migration rolls back — no partial search_path changes. Supabase migration runner wraps each file in a transaction by default, but the DO block must also use RAISE to propagate errors.

```sql
DO $$
DECLARE rec RECORD; alter_sql text;
BEGIN
  FOR rec IN
    SELECT p.proname, pg_get_function_identity_arguments(p.oid) AS args
    FROM pg_proc p JOIN pg_namespace n ON p.pronamespace = n.oid
    WHERE n.nspname = 'public' AND p.prosecdef = true
      AND p.proname LIKE 'rpc_%'
      AND NOT EXISTS (
        SELECT 1 FROM pg_options_to_table(p.proconfig)
        WHERE option_name = 'search_path' AND option_value LIKE '%pg_catalog%'
      )
  LOOP
    alter_sql := format('ALTER FUNCTION public.%I(%s) SET search_path = pg_catalog, public',
      rec.proname, rec.args);
    EXECUTE alter_sql;
  END LOOP;
END $$;
```

**Acceptance Criteria**:
- [ ] `npm run db:types-local` succeeds
- [ ] All game_settings_side_bet policies use NULLIF pattern
- [ ] No `'manager'` role references in game_settings_side_bet policies
- [ ] All `rpc_%` SECURITY DEFINER functions have `search_path = pg_catalog, public`
- [ ] Migration runs within a transaction; failure yields full rollback (no partial search_path changes)

---

### WS7: TG-3 — Catalog Audit Script

**Purpose**: One-time audit of all rpc_* functions for context injection compliance.

**Output**: `scripts/audit-rpc-context-injection.sh`

**Script queries pg_proc** for:
- All `rpc_*` functions in `public` schema
- Whether function source contains `set_rls_context`
- Whether function is SECURITY DEFINER
- Whether function has explicit search_path setting

**Acceptance Criteria**:
- [ ] Script runs without errors against local Supabase
- [ ] Output clearly identifies compliant vs non-compliant RPCs
- [ ] All SECURITY DEFINER RPCs show set_rls_context in source

---

### WS8: TG-4 — Category B Policy Lint Documentation

**Purpose**: Document local-only lint check in CI pipeline spec.

**File**: `docs/deployments/CICD-PIPELINE-SPEC.md`

**Changes**: Add section documenting `scripts/lint-rls-category-b-policies.sh`:
- Local-only check (requires DATABASE_URL)
- Exits 0 with WARNING when no DB available (graceful degradation)
- Optional CI step conditioned on `DATABASE_URL` secret

**Acceptance Criteria**:
- [ ] CICD-PIPELINE-SPEC.md documents the optional gate
- [ ] No CI pipeline changes required (documentation only)

---

## Definition of Done

- [ ] All 8 workstreams complete
- [ ] All gates pass (type-check, lint, test, build)
- [ ] No regressions in existing tests
- [ ] ADR-024 INV-7 restored to PASS (mandatory self-injection)
- [ ] ADR-024 INV-8 restored to PASS (no spoofable identity params — requires WS4 grant lockdown)
- [ ] ADR-030 INV-030-4 restored to PASS (write-path session-var)
- [ ] ADR-018 compliance restored (REVOKE ALL FROM PUBLIC — via pre-existing P1 Migration 3)
- [ ] SEC-001 Pattern C compliance restored (NULLIF — via WS6)
- [ ] Catalog assertion: 0 vulnerable overloads survive
- [ ] CI grep gate: no production calls pass removed params (scope: `app/`, `lib/`, `services/`, `hooks/`, excluding `__tests__/`)

## Audit Corrections Applied

Per `EXECUTION-SPEC-SEC-REMEDIATION-2026-02-19-AUDIT-FOLDED.md`:

- [x] **Fix #1**: WS1 uses single deterministic assertion pattern (throw-only, no mixed expect+throw)
- [x] **Fix #2**: WS4 uses correct Postgres privilege syntax (`REVOKE EXECUTE ON FUNCTION ... FROM ...`)
- [x] **Fix #3**: WS4 Path B made coherent (Option 2: single function service_role-only + authenticated wrappers)
- [x] **Fix #4**: WS4 service_role impersonation hardened (casino scope validation on p_internal_actor_id)
- [x] **Fix #5**: CI grep gate scope defined (directories, RPC names, fail condition) + typegen backstop
- [x] **Fix #6**: WS3 post-WS4 follow-up note added (update shift-metrics tests to use authenticated wrappers)
- [x] **Fix #7**: WS6 search_path migration requires transaction semantics (abort on first failure)

## Invariant Restoration Forecast

| Invariant | Current | After Phase 2 (P0) | After Phase 4 (P1) | After Phase 5 (P2) |
|-----------|---------|---------------------|---------------------|---------------------|
| ADR-024 INV-7 | PARTIAL | **PASS** | PASS | PASS |
| ADR-024 INV-8 | PARTIAL | PARTIAL | **PASS** | PASS |
| ADR-030 INV-030-4 | PARTIAL | **PASS** | PASS | PASS |
| ADR-018 (REVOKE) | **PASS** (shipped) | PASS | PASS | PASS |
| SEC-001 Pattern C | PARTIAL | PARTIAL | PARTIAL | **PASS** |
