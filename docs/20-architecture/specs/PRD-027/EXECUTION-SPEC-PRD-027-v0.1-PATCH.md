---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline skill (lead-architect scaffold + expert refinement)

prd: PRD-027
prd_title: "System Time & Gaming Day Standardization"
version: "v0.1-PATCH"
date: "2026-02-03"
supersedes: "EXECUTION-SPEC-PRD-027.md (unversioned)"
mvp_phase: 0  # Phase 0 (Foundation Hardening)
# Cross-cutting: CasinoService (temporal authority) + Player360DashboardService (migration)

workstreams:
  WS1:
    name: Database RPCs + MTL Trigger Fix
    description: >
      Create compute_gaming_day_for_casino() Layer 2 wrapper, rpc_current_gaming_day(),
      rpc_gaming_day_range() RPCs, and fix MTL trigger to call canonical function.
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/YYYYMMDDHHMMSS_prd027_temporal_rpcs.sql
    gate: schema-validation
    estimated_complexity: medium

  WS2:
    name: Server Helper + Player 360 Migration
    description: >
      Create lib/gaming-day/server.ts canonical helper, migrate Player 360 RSC page
      and crud.ts from JS date math to RPC calls, delete deprecated temporal functions.
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - lib/gaming-day/server.ts
      - app/(dashboard)/players/[[...playerId]]/page.tsx
      - services/player360-dashboard/crud.ts
      - services/player360-dashboard/mappers.ts
      - services/player360-dashboard/index.ts
    gate: type-check
    estimated_complexity: medium

  WS3:
    name: Import Path Cleanup
    description: >
      Migrate pit-panels-client.tsx and pit-dashboard-client.tsx from deprecated
      hooks/use-casino to canonical hooks/casino/use-gaming-day import path.
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - components/pit-panels/pit-panels-client.tsx
      - components/dashboard/pit-dashboard-client.tsx
    gate: type-check
    estimated_complexity: low

  WS4:
    name: ESLint Temporal Bypass Rule (Verification)
    description: >
      Verify existing no-temporal-bypass ESLint rule catches violations before WS2 cleanup
      and passes clean after. Rule already exists at .eslint-rules/no-temporal-bypass.js.
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs: []
    gate: lint
    estimated_complexity: low

  WS5:
    name: Boundary & DST Tests
    description: >
      Integration tests for gaming day RPC boundary conditions: pre-boundary, post-boundary,
      UTC-midnight, DST spring-forward, DST fall-back, settings change, fail-closed.
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1, WS2]
    outputs:
      - services/casino/__tests__/gaming-day-boundary.int.test.ts
    gate: test-pass
    estimated_complexity: medium

  WS6:
    name: Observability Tripwire
    description: >
      Dev/staging invariant comparing getServerGamingDay() result against direct RPC call.
      Environment-gated, no production impact. Priority: Could (FR-9).
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS1, WS2]
    outputs:
      - lib/gaming-day/server.ts
    gate: type-check
    estimated_complexity: low

execution_phases:
  - name: "Phase 1 - Database Foundation"
    parallel: [WS1]
    gates: [schema-validation]

  - name: "Phase 2 - Service Migration + Tooling"
    parallel: [WS2, WS3, WS4]
    gates: [type-check, lint]

  - name: "Phase 3 - Testing & Observability"
    parallel: [WS5, WS6]
    gates: [test-pass, type-check]

gates:
  schema-validation:
    command: "npm run db:types"
    success_criteria: "Exit 0, types regenerated with rpc_current_gaming_day and rpc_gaming_day_range"

  type-check:
    command: "npm run type-check"
    success_criteria: "Exit 0, no type errors"

  lint:
    command: "npm run lint"
    success_criteria: "Exit 0, no errors"

  test-pass:
    command: "npm test services/casino/__tests__/gaming-day-boundary.int.test.ts && npm test services/player360-dashboard/"
    success_criteria: "All tests pass including 66 existing mapper tests"

external_dependencies:
  - prd: PRD-000
    service: CasinoService
    required_for: "compute_gaming_day() Layer 1 + Layer 2, casino_settings table"
  - prd: PRD-005
    service: MTLService
    required_for: "trg_mtl_entry_set_gaming_day() trigger to fix"

risks:
  - risk: "Mapper test suite needs updates after removing getCurrentGamingDay()"
    mitigation: "Tests will need to mock rpc_current_gaming_day() instead; verify all 66 pass"
  - risk: "MTL trigger migration alters behavior for edge-case timestamps"
    mitigation: "Run regression test against existing mtl_entry data before/after"
  - risk: "Hook signature difference between deprecated and canonical useGamingDay"
    mitigation: "pit-panels-client already handles both formats; pit-dashboard-client needs .gaming_day extraction"
---

> **Patch v0.1 (2026-02-03):** Fixes canonical signature ambiguity, removes context-setting from DB wrapper, hardens legacy function exposure, and tightens DST + test-only timestamp usage.

> **DST test implementation note:** Use **UTC timestamptz instants** that map into the target casino-local times. Avoid constructing ambiguous local timestamps (e.g., "1:30" on fall-back day).

# EXECUTION-SPEC: PRD-027 - System Time & Gaming Day Standardization

## Overview

PRD-027 eliminates all JavaScript gaming day derivations and standardizes temporal resolution through the database. A P0 incident revealed that Player 360 bypassed the canonical `compute_gaming_day` DB authority path, computing gaming day with UTC date math in JS. After UTC midnight the UI showed $0 across all financial panels.

This spec delivers: database RPCs for gaming day resolution, server helper for RSC pages, Player 360 migration from JS to RPC, MTL trigger fix, boundary/DST tests, and ESLint enforcement verification.

## Scope

- **In Scope**: Database RPCs, server helper, Player 360 migration, import cleanup, boundary tests, observability tripwire, ESLint verification
- **Out of Scope**: Admin UI for timezone changes (PRD-021), multi-casino timezone support, `useGamingDay` hook internals, gaming day RPC performance optimization

## Architecture Context

- **Temporal Authority**: CasinoService owns `gaming_day` via `casino_settings` + `compute_gaming_day()` (TEMP-001/002)
- **Three-Layer Contract**: Layer 1 (IMMUTABLE pure math) -> Layer 2 (casino-scoped wrapper) -> Layer 3 (RLS-context RPCs)
- **Security**: ADR-024 INV-8 (no casino_id parameter), ADR-018 SECURITY DEFINER governance, ADR-030 auth hardening
- **Enforcement**: TEMP-003 banned patterns, ESLint `no-temporal-bypass` rule (already deployed)

## Workstream Details

### WS1: Database RPCs + MTL Trigger Fix


#### Canonical Signatures (MUST MATCH DB)

To prevent spec drift, the implementation **must** standardize on these signatures:

- **Layer 1 (pure math, IMMUTABLE):**
  - `compute_gaming_day(p_ts timestamptz, p_gaming_day_start interval) -> date`

- **Layer 2 (casino-scoped derivation, STABLE, SECURITY DEFINER):**
  - `compute_gaming_day_for_casino(p_ts timestamptz default now()) -> date`

- **Layer 3 (RLS-context RPCs, SECURITY DEFINER):**
  - `rpc_current_gaming_day(p_timestamp timestamptz default now()) -> date`
  - `rpc_gaming_day_range(p_weeks int, p_end_timestamp timestamptz default now()) -> (start_gd date, end_gd date)`

> If your existing Layer 1 currently uses `time` instead of `interval`, **migrate it to interval** as part of WS1. Do not keep two signatures.


**Purpose**: Create the RLS-context-scoped temporal RPCs and fix the MTL trigger.

**Single migration** creates:

1. **Migrate Layer 1 `compute_gaming_day` from `time` to `interval`** — replace the existing `compute_gaming_day(ts timestamptz, gstart time)` with `compute_gaming_day(p_ts timestamptz, p_gaming_day_start interval)`. The math is identical; only the parameter type changes. Use `CREATE OR REPLACE` (same name, new signature drops the old overload). All downstream callers (Layer 2, triggers) must pass `interval` from this point.

2. **`compute_gaming_day_for_casino(p_ts timestamptz DEFAULT now()) -> date`**
   - STABLE, SECURITY DEFINER, `SET search_path TO 'public'`
   - Derives `casino_id` from `current_setting('app.casino_id', true)` — fails closed if NULL
   - Reads `public.casino_settings.timezone` and `public.casino_settings.gaming_day_start_time` (schema-qualified)
   - Converts `p_ts` to casino-local time, delegates to Layer 1 `compute_gaming_day(ts, gstart interval)`

3. **`rpc_current_gaming_day(p_timestamp timestamptz DEFAULT now()) -> date`**
   - STABLE, SECURITY DEFINER — thin wrapper calling `compute_gaming_day_for_casino(p_timestamp)`
   - `REVOKE ALL FROM PUBLIC; GRANT EXECUTE TO authenticated`

4. **`rpc_gaming_day_range(p_weeks int DEFAULT 4, p_end_timestamp timestamptz DEFAULT now()) -> TABLE(start_gd date, end_gd date)`**
   - STABLE, SECURITY DEFINER
   - `end_gd := compute_gaming_day_for_casino(p_end_timestamp)`; `start_gd := end_gd - (p_weeks * 7)`

5. **Fix `trg_mtl_entry_set_gaming_day()`** — replace inline boundary logic with:
   ```sql
   SELECT gaming_day_start_time::interval INTO gstart FROM public.casino_settings WHERE casino_id = NEW.casino_id;
   NEW.gaming_day := compute_gaming_day(COALESCE(NEW.created_at, now()), COALESCE(gstart, interval '06:00'));
   ```
   Uses Layer 1 (IMMUTABLE) since trigger has `casino_id` from `NEW` row.

6. **Lock down legacy `compute_gaming_day(p_casino_id uuid, p_timestamp timestamptz)`** — this Layer 2 overload accepts a spoofable `casino_id` parameter and must not be client-callable:
   ```sql
   REVOKE EXECUTE ON FUNCTION compute_gaming_day(uuid, timestamptz) FROM anon, authenticated;
   COMMENT ON FUNCTION compute_gaming_day(uuid, timestamptz)
     IS 'INTERNAL ONLY — Layer 2 legacy overload. Not client-callable. Use rpc_current_gaming_day() instead.';
   ```
   This ensures the function remains available for internal triggers/functions but is invisible to PostgREST's API schema (PostgREST only exposes functions granted to the requesting role).

**Function state after WS1 migration completes**:
- `compute_gaming_day(p_ts timestamptz, p_gaming_day_start interval)` — Layer 1 IMMUTABLE. **Migrated** from `(ts, gstart time)` to `(p_ts, p_gaming_day_start interval)` in step 1. The old `time` overload is dropped; `interval` is the sole Layer 1 signature.
- `compute_gaming_day(p_casino_id uuid, p_timestamp timestamptz)` — Layer 2 legacy overload. Kept for internal callers only; `REVOKE`d from `anon`/`authenticated` in step 6. Not client-callable.
- `compute_gaming_day_for_casino(p_ts timestamptz)` — Layer 2 canonical wrapper. **New** in step 2. Reads RLS context, delegates to Layer 1.
- `rpc_current_gaming_day`, `rpc_gaming_day_range` — Layer 3 RPCs. **New** in steps 3-4. Client-callable.

**Caller contract** (which layer to use where):
- **Triggers** (have `NEW.casino_id`): call Layer 1 directly with a `public.casino_settings` lookup for `gaming_day_start_time` — no wrapper needed.
- **RPCs / server helpers** (no explicit casino_id): call Layer 2 `compute_gaming_day_for_casino()` which derives scope from RLS context.

**Acceptance Criteria**:
- [ ] `npm run db:types` succeeds with new RPC types
- [ ] Migration is idempotent (`CREATE OR REPLACE`)
- [ ] Migration ends with `NOTIFY pgrst, 'reload schema'`
- [ ] No `casino_id` parameter on `rpc_current_gaming_day` or `rpc_gaming_day_range`
- [ ] `compute_gaming_day_for_casino` raises exception when `app.casino_id` is missing
- [ ] `REVOKE EXECUTE` applied on `compute_gaming_day(uuid, timestamptz)` for `anon` and `authenticated`
- [ ] Legacy overload not visible in PostgREST API schema (verified via `npm run db:types` — function absent from generated client types)
- [ ] Migration includes `COMMENT ON FUNCTION` documenting internal-only status
- [ ] All SECURITY DEFINER function bodies use schema-qualified table references (`public.casino_settings`, not bare `casino_settings`)
- [ ] Layer 1 `compute_gaming_day` uses `interval` parameter (no `time` overload remains)

### WS2: Server Helper + Player 360 Migration

**Purpose**: Create canonical RSC helper and migrate Player 360 from JS temporal functions to DB RPCs.

**Deliverables**:

1. **`lib/gaming-day/server.ts`** — two exports, split by intent:
   - `getServerGamingDay(supabase: SupabaseClient<Database>): Promise<string>` — production API, no timestamp parameter. Calls `supabase.rpc('rpc_current_gaming_day')`. Throws structured error on failure.
   - `getServerGamingDayAt(supabase: SupabaseClient<Database>, ts: string): Promise<string>` — **test-only** export. Calls `supabase.rpc('rpc_current_gaming_day', { p_timestamp: ts })`. Production code must never import this; the ESLint `no-temporal-bypass` rule should flag `getServerGamingDayAt` in `app/` and `services/` paths.

2. **`app/(dashboard)/players/[[...playerId]]/page.tsx`** modifications:
   - Remove `getCurrentGamingDay` import from `@/services/player360-dashboard/mappers`
   - Add `getServerGamingDay` import from `@/lib/gaming-day/server`
   - Create Supabase client via `createServerSupabaseClient()`
   - Replace `const gamingDay = getCurrentGamingDay()` with `const gamingDay = await getServerGamingDay(supabase)`

3. **`services/player360-dashboard/crud.ts`** modifications:
   - `getPlayerSummary`: Make `gamingDay` parameter **required** (remove `?` and `getCurrentGamingDay()` fallback)
   - `getWeeklySeries`: Replace `getWeeksAgoDate(weeks)` with `supabase.rpc('rpc_gaming_day_range', { p_weeks: weeks })`
   - Remove imports of deleted functions

4. **`services/player360-dashboard/mappers.ts`** — Delete `getCurrentGamingDay()` (lines 143-177) and `getWeeksAgoDate()` (lines 182-186). Update `mapToWeeklySeries()` to accept date range parameters.

5. **`services/player360-dashboard/index.ts`** — Remove `getCurrentGamingDay` and `getWeeksAgoDate` from re-exports.

**Acceptance Criteria**:
- [ ] `npm run type-check` passes
- [ ] Zero references to `getCurrentGamingDay` in `services/`, `app/` (grep verification)
- [ ] Zero references to `getWeeksAgoDate` in `services/`, `app/` (grep verification)
- [ ] `getPlayerSummary` `gamingDay` parameter is required
- [ ] All 66 existing mapper tests pass
- [ ] `getServerGamingDay` has no timestamp parameter (enforced by signature, not policy)
- [ ] `getServerGamingDayAt` exists as separate test-only export
- [ ] Zero imports of `getServerGamingDayAt` in `app/` or `services/` (grep verification)

### WS3: Import Path Cleanup

**Purpose**: Migrate pit components from deprecated to canonical hook import path.

**Signature difference**:
- Deprecated (`hooks/use-casino`): `useGamingDay(casinoId: string)` returns `{ data: string }`
- Canonical (`hooks/casino/use-gaming-day`): `useGamingDay(timestamp?, options?)` returns `{ data: GamingDayDTO }`

**File changes**:

1. **`components/pit-panels/pit-panels-client.tsx`**:
   - Import: `@/hooks/use-casino` -> `@/hooks/casino/use-gaming-day`
   - Call: `useGamingDay(casinoId)` -> `useGamingDay(undefined, { enabled: authReady === true })`
   - Return handling: Already defensive (handles both string and object formats)

2. **`components/dashboard/pit-dashboard-client.tsx`**:
   - Import: `@/hooks/use-casino` -> `@/hooks/casino/use-gaming-day`
   - Call: `useGamingDay(casinoId)` -> `useGamingDay(undefined, { enabled: authReady === true })`
   - Return handling: Extract `.gaming_day` from `GamingDayDTO` response

**Acceptance Criteria**:
- [ ] `npm run type-check` passes
- [ ] No imports from `hooks/use-casino` in pit-panels or pit-dashboard components

### WS4: ESLint Temporal Bypass Rule (Verification)

**Purpose**: Verify the existing `no-temporal-bypass` ESLint rule is operational.

**Status**: **ALREADY IMPLEMENTED** — `.eslint-rules/no-temporal-bypass.js` (217 lines) is wired into `eslint.config.mjs` (lines 154-185) at `error` severity covering `services/**`, `app/**`, `hooks/**`.

**Amendments** (WS4 now includes a minor rule update):
- Add `getServerGamingDayAt` to the `BANNED_FUNCTIONS` array in `.eslint-rules/no-temporal-bypass.js`. This prevents the test-only timestamped helper from leaking into production code paths.

**Verification steps**:
1. Run lint to confirm rule fires on existing `getCurrentGamingDay`/`getWeeksAgoDate` violations in `mappers.ts`
2. After WS2 removes violations, confirm clean lint pass
3. Verify `getServerGamingDayAt` import in `app/` or `services/` triggers lint error

**Acceptance Criteria**:
- [ ] `npm run lint` exits 0 after WS2 cleanup
- [ ] `getServerGamingDayAt` is in the ESLint banned-function list

### WS5: Boundary & DST Tests

**Purpose**: Integration tests proving the temporal contract holds across all edge cases.

**Test file**: `services/casino/__tests__/gaming-day-boundary.int.test.ts`

**Scenarios**:

| # | Scenario | Input | Expected |
|---|----------|-------|----------|
| 1 | Pre-boundary | 05:50 local, start=06:00 | Previous calendar date |
| 2 | Post-boundary | 06:10 local, start=06:00 | Current calendar date |
| 3 | UTC-midnight | 00:10 UTC (16:10 Pacific) | Reflects casino timezone |
| 4 | DST spring-forward | Clock 1:59->3:00 AM | Boundary computed correctly |
| 5 | DST fall-back | Clock 1:00 AM repeats | Handles ambiguous local time |
| 6 | Settings change | Change start_time, re-call | New boundary reflected immediately |
| 7 | Range query | p_weeks=4 | start_gd = end_gd - 28 |
| 8 | Fail closed | No RLS context | UNAUTHORIZED error |

Also verify: all 66 existing `services/player360-dashboard/__tests__/mappers.test.ts` tests pass.

**Acceptance Criteria**:
- [ ] All 8 boundary scenarios pass
- [ ] All 66 mapper tests pass
- [ ] Coverage >= 90% for boundary test file

### WS6: Observability Tripwire

**Purpose**: Dev/staging diagnostic comparing `getServerGamingDay()` against direct RPC.

**Implementation**: Add environment-gated comparison inside `lib/gaming-day/server.ts`:
- `if (process.env.NODE_ENV !== 'production')`: call both paths, log mismatch with structured logger
- ~5ms overhead in dev only, zero production impact

**Priority**: Could (FR-9) — implement if time permits within Phase 3.

**Acceptance Criteria**:
- [ ] `npm run type-check` passes
- [ ] No `console.*` calls
- [ ] Tripwire unreachable in production (env guard)

## Definition of Done

- [ ] `compute_gaming_day_for_casino()` has **no side effects** (does not call context setters) and **fails closed** when `app.casino_id` is missing
- [ ] Any legacy `compute_gaming_day(casino_id, ts)` helper is **internal-only** (not exposed; revoked from `authenticated`/`anon`)

**Functionality**:
- [ ] `compute_gaming_day_for_casino()` exists and fails closed without context
- **No side effects:** `compute_gaming_day_for_casino()` must **not** call any context-setting functions. It only **reads** context (e.g., `current_setting('app.casino_id', true)`).
- **Fail closed:** if `app.casino_id` is missing/empty, raise an exception (do not fallback silently).

- [ ] `rpc_current_gaming_day()` returns correct gaming day via RLS-derived scope
- [ ] `rpc_gaming_day_range()` returns correct `{start_gd, end_gd}`
- [ ] Player 360 `page.tsx` uses `getServerGamingDay()` — no JS derivation
- [ ] Player 360 `crud.ts` uses `rpc_gaming_day_range()` for weekly trends
- [ ] `getCurrentGamingDay()` and `getWeeksAgoDate()` deleted from production code
- [ ] `pit-panels-client.tsx` and `pit-dashboard-client.tsx` import from `hooks/casino/use-gaming-day`

**Data & Integrity**:
- [ ] `trg_mtl_entry_set_gaming_day()` calls Layer 1 `compute_gaming_day(p_ts, p_gaming_day_start interval)` with `gaming_day_start_time` looked up from `public.casino_settings` — no inline boundary logic, no wrapper (trigger has `NEW.casino_id`)
- [ ] Gaming day values match canonical function for all test scenarios

**Security**:
- [ ] RPCs are SECURITY DEFINER, derive scope from RLS context, reject missing scope
- [ ] No new routes or client-exposed surfaces

**Testing**:
- [ ] Boundary tests pass (8 scenarios)
- [ ] All 66 existing mapper tests pass
- [ ] `npm run db:types` regenerated

**Operational**:
- [ ] ESLint `no-temporal-bypass` passes clean after migration
- [ ] TEMP-003 remediation checklist items marked complete