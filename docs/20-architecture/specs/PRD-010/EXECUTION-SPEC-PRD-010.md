---
# EXECUTION-SPEC: PRD-010 RLS MVP Hardening
# Generated by prd-pipeline skill
# Date: 2025-12-16

prd: PRD-010
prd_title: "RLS MVP Hardening - ADR-020 Track A Completion"
service: SecurityHardening
mvp_phase: 1  # Phase MVP (Security Hardening)

# Workstream Definitions
workstreams:
  WS1:
    name: Casino Table RLS (P0)
    description: Enable RLS on casino table with Pattern C hybrid policy
    agent: rls-security-specialist
    depends_on: []
    outputs:
      - supabase/migrations/*_prd010_casino_rls.sql
    gate: schema-validation
    estimated_complexity: low
    priority: P0

  WS2:
    name: MTL Audit Note Denial Policies (P1)
    description: Add explicit no_updates and no_deletes policies to mtl_audit_note
    agent: rls-security-specialist
    depends_on: []
    outputs:
      - supabase/migrations/*_prd010_mtl_audit_note_denial.sql
    gate: schema-validation
    estimated_complexity: low
    priority: P1

  WS3:
    name: Cross-Casino Denial Tests (P0)
    description: Extend rls-pooling-safety.integration.test.ts with cross-tenant denial tests
    agent: backend-developer
    depends_on: [WS1]
    outputs:
      - lib/supabase/__tests__/rls-pooling-safety.integration.test.ts (extended)
    gate: test-pass
    estimated_complexity: medium
    priority: P0

  WS4:
    name: JWT Claims Verification Tests (P1)
    description: Create integration tests for JWT claims sync trigger
    agent: backend-developer
    depends_on: [WS1]
    outputs:
      - lib/supabase/__tests__/jwt-claims-sync.integration.test.ts
    gate: test-pass
    estimated_complexity: medium
    priority: P1

  WS5:
    name: Documentation Updates (P2)
    description: Update SEC-001, ADR-020, close related issues
    agent: backend-developer
    depends_on: [WS1, WS2, WS3, WS4, WS6, WS7]
    outputs:
      - docs/30-security/SEC-001-rls-policy-matrix.md (updated)
      - docs/80-adrs/ADR-020-rls-track-a-mvp-strategy.md (updated)
    gate: lint
    estimated_complexity: low
    priority: P2

  WS6:
    name: RPC Self-Injection Verification (P0)
    description: Verify ADR-015 scanner confirms 0 issues for SECURITY DEFINER RPCs (SEC-006/SEC-007 already implemented)
    agent: backend-developer
    depends_on: []
    outputs:
      - docs/issues/adr015-compliance-report.md (verified current)
    gate: scanner-pass
    estimated_complexity: trivial
    priority: P0

  WS7:
    name: Role Boundary Tests (P1)
    description: Verify role-based access control (dealer vs pit_boss vs admin permissions) per ADR-020
    agent: backend-developer
    depends_on: [WS1]
    outputs:
      - lib/supabase/__tests__/role-boundary.integration.test.ts
    gate: test-pass
    estimated_complexity: medium
    priority: P1

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Database Policies + RPC Verification
    description: Enable RLS on casino table, add MTL denial policies, verify RPC compliance
    parallel: [WS1, WS2, WS6]
    gates: [schema-validation, scanner-pass]

  - name: Phase 2 - Security Tests
    description: Cross-casino denial tests, JWT claims verification, role boundary tests
    parallel: [WS3, WS4, WS7]
    gates: [test-pass]

  - name: Phase 3 - Documentation
    description: Update security docs and close issues
    parallel: [WS5]
    gates: [lint]

# Validation Gates
gates:
  schema-validation:
    command: npm run db:types
    success_criteria: "Exit code 0, no type errors"

  scanner-pass:
    command: ./scripts/adr015-rls-scanner.sh
    success_criteria: "Total issues: 0"

  test-pass:
    command: npm test lib/supabase/__tests__/
    success_criteria: "All RLS tests pass"

  lint:
    command: npm run lint -- docs/30-security/ docs/80-adrs/
    success_criteria: "Exit code 0, no errors"

# Dependencies on other PRDs/Services
external_dependencies:
  - prd: PRD-000
    service: CasinoService
    required_for: "Casino table schema exists"
  - adr: ADR-015
    required_for: "set_rls_context() RPC exists"
  - adr: ADR-020
    required_for: "Track A hybrid pattern definition"

# Risks and Mitigations
risks:
  - risk: "Casino RLS policy may break existing queries"
    mitigation: "Test all casino-related queries after migration"
  - risk: "RPC self-injection may introduce subtle behavior changes"
    mitigation: "Run full test suite after RPC modifications"
  - risk: "Supavisor pooling may behave differently than direct connection"
    mitigation: "Run dedicated pooling sanity tests"

---

# EXECUTION-SPEC: PRD-010 - RLS MVP Hardening

## Overview

Complete ADR-020 Track A (Hybrid RLS) requirements for MVP readiness. This PRD addresses:
- **P0**: `casino` table has no RLS (cross-tenant data leakage risk)
- **P1**: `mtl_audit_note` missing denial policies (append-only violation)
- **P0**: SECURITY DEFINER RPC compliance verification (SEC-006/SEC-007 implemented)
- **P1**: JWT claims sync requires verification tests
- **P1**: Role boundary tests required per ADR-020

## Scope

### In Scope (MVP)
- Enable RLS on `casino` table with hybrid read policy
- Add `no_updates` and `no_deletes` policies to `mtl_audit_note`
- Verify SECURITY DEFINER RPC compliance (SEC-006/SEC-007 already implemented)
- Cross-casino denial tests
- Role boundary tests (dealer vs pit_boss vs admin)
- JWT claims sync integration tests
- Documentation updates (SEC-001, ADR-020)

### Out of Scope
- Track B migration (116 policy rewrites)
- New RBAC permissions system
- RLS policy performance benchmarking
- Frontend authorization changes

## Architecture Context

This PRD implements ADR-020 Phase 1 requirements:
- Track A hybrid pattern: `COALESCE(current_setting('app.casino_id'), jwt.app_metadata.casino_id)`
- All policies include `auth.uid() IS NOT NULL`
- SECURITY DEFINER RPCs self-inject context per ADR-015 Phase 1A

Reference documents:
- [ADR-020 RLS Track A MVP Strategy](../../../80-adrs/ADR-020-rls-track-a-mvp-strategy.md)
- [ADR-015 RLS Connection Pooling Strategy](../../../80-adrs/ADR-015-rls-connection-pooling-strategy.md)
- [SEC-001 RLS Policy Matrix](../../../30-security/SEC-001-rls-policy-matrix.md)

## Workstream Details

### WS1: Casino Table RLS (P0)

**Purpose**: Enable RLS on `casino` table to prevent cross-tenant data leakage.

**Deliverables**:
1. Migration file enabling RLS on `casino` table
2. Read-only hybrid policy using Pattern C
3. Implicit deny for INSERT/UPDATE/DELETE

**SQL Template**:
```sql
-- Enable RLS on casino table
ALTER TABLE casino ENABLE ROW LEVEL SECURITY;

-- Read-only policy for authenticated staff (Pattern C Hybrid - ADR-015/ADR-020)
CREATE POLICY casino_read_own_casino ON casino
  FOR SELECT USING (
    auth.uid() IS NOT NULL
    AND id = COALESCE(
      NULLIF(current_setting('app.casino_id', true), '')::uuid,
      (auth.jwt() -> 'app_metadata' ->> 'casino_id')::uuid
    )
  );
```

**Acceptance Criteria**:
- [ ] `npm run db:types` succeeds
- [ ] Authenticated staff can only read their own casino
- [ ] No INSERT/UPDATE/DELETE policies (implicit deny)

### WS2: MTL Audit Note Denial Policies (P1)

**Purpose**: Ensure `mtl_audit_note` is append-only per SEC-001 Template 3.

**Deliverables**:
1. `no_updates` policy rejecting UPDATE operations
2. `no_deletes` policy rejecting DELETE operations

**SQL Template**:
```sql
-- Explicit denial for updates (append-only ledger)
CREATE POLICY mtl_audit_note_no_updates ON mtl_audit_note
  FOR UPDATE USING (false);

-- Explicit denial for deletes (append-only ledger)
CREATE POLICY mtl_audit_note_no_deletes ON mtl_audit_note
  FOR DELETE USING (false);
```

**Acceptance Criteria**:
- [ ] UPDATE operations return RLS violation error
- [ ] DELETE operations return RLS violation error
- [ ] INSERT operations still work for authorized users

### WS3: Cross-Casino Denial Tests (P0)

**Purpose**: Verify no cross-tenant data leakage.

**Deliverables**:
1. Extend `rls-pooling-safety.integration.test.ts` with:
   - Staff A cannot see Casino B visit records
   - Staff A cannot see Casino B player records
   - Staff A cannot see Casino B casino record
   - Staff A cannot insert into Casino B tables

**Test Template**:
```typescript
describe('Cross-Casino Denial (ADR-020)', () => {
  it('should deny read access to other casino visits', async () => {
    // Setup: Two casinos, two staff members
    // Act: Staff A queries visits
    // Assert: Only Casino A visits returned
  });

  it('should deny read access to other casino record', async () => {
    // Setup: Staff A authenticated
    // Act: Query casino table
    // Assert: Only Casino A record visible
  });

  it('should deny insert to other casino tables', async () => {
    // Setup: Staff A context
    // Act: INSERT into visit with Casino B id
    // Assert: RLS violation error
  });
});
```

**Acceptance Criteria**:
- [ ] All cross-casino denial tests pass
- [ ] Tests run under Supavisor pooling mode
- [ ] No cross-tenant data leakage detected

### WS4: JWT Claims Verification Tests (P1)

**Purpose**: Verify JWT claims sync trigger works correctly.

**Deliverables**:
1. New test file `jwt-claims-sync.integration.test.ts`
2. Tests for:
   - Staff creation syncs JWT claims
   - Staff role update syncs JWT claims
   - Staff user_id removal clears JWT claims
   - JWT fallback works when set_rls_context not called

**Test Template**:
```typescript
describe('JWT Claims Sync (ADR-020)', () => {
  it('should sync JWT claims on staff creation', async () => {
    // Setup: Create staff record with user_id
    // Assert: auth.users.raw_app_meta_data contains casino_id, staff_role, staff_id
  });

  it('should update JWT claims on role change', async () => {
    // Setup: Staff exists
    // Act: Update staff.role
    // Assert: JWT claims updated
  });

  it('should clear JWT claims on user_id removal', async () => {
    // Setup: Staff exists with JWT claims
    // Act: Clear staff.user_id
    // Assert: JWT claims cleared
  });
});
```

**Acceptance Criteria**:
- [ ] All JWT sync tests pass
- [ ] Trigger fires on INSERT, UPDATE, DELETE
- [ ] Claims cleared when staff unlinked from user

### WS5: Documentation Updates (P2)

**Purpose**: Update security documentation to reflect new policies.

**Deliverables**:
1. Update SEC-001 with:
   - `casino` table policies
   - `mtl_audit_note` denial policies
2. Update ADR-020:
   - Mark Phase 1 checklist items complete
3. Close related issues in Memori

**Acceptance Criteria**:
- [ ] SEC-001 reflects current policy state
- [ ] ADR-020 MVP checklist updated
- [ ] No stale documentation

### WS6: RPC Self-Injection Verification (P0)

**Purpose**: Verify all SECURITY DEFINER RPCs self-inject RLS context (work already completed by SEC-006/SEC-007).

**Background**:
SEC-006 (`20251212080915_sec006_rls_hardening.sql`) and SEC-007 (`20251212081000_sec007_rating_slip_rpc_hardening.sql`) already hardened all 14 SECURITY DEFINER RPCs with Template 5 context validation. This workstream verifies compliance rather than implementing fixes.

**Deliverables**:
1. Run ADR-015 scanner and confirm 0 issues
2. Document verification in compliance report

**Acceptance Criteria**:
- [x] ADR-015 scanner reports 0 issues (verified 2025-12-16)
- [x] All RPCs self-inject context (SEC-006/SEC-007)
- [ ] Compliance report updated

### WS7: Role Boundary Tests (P1)

**Purpose**: Verify role-based access control per ADR-020 MVP requirements.

**Deliverables**:
1. New test file `role-boundary.integration.test.ts`
2. Tests for:
   - Dealers cannot access any data (user_id = NULL)
   - Pit boss has limited finance access (buy-ins only)
   - Admin has full read/write access
   - Cashier has full finance transaction access

**Test Template**:
```typescript
describe('Role Boundary Tests (ADR-020)', () => {
  it('should deny all access to dealers (no user_id)', async () => {
    // Setup: Dealer record with user_id = NULL
    // Assert: Cannot authenticate, no RLS context possible
  });

  it('should allow pit_boss limited finance access', async () => {
    // Setup: Pit boss context
    // Act: Attempt various finance operations
    // Assert: Only buy-ins (direction='in', tender_type in ['cash','chips'])
  });

  it('should allow admin full access', async () => {
    // Setup: Admin context
    // Act: CRUD operations on all tables
    // Assert: All operations succeed within casino scope
  });

  it('should allow cashier full finance access', async () => {
    // Setup: Cashier context
    // Act: All finance transaction types
    // Assert: All finance operations succeed
  });
});
```

**Acceptance Criteria**:
- [ ] All role boundary tests pass
- [ ] Dealer exclusion verified
- [ ] Pit boss finance constraints verified
- [ ] Admin/cashier full access verified

## Definition of Done

**Functionality**:
- [ ] `casino` table has RLS enabled with hybrid read policy
- [ ] `mtl_audit_note` has `no_updates` and `no_deletes` policies
- [x] All SECURITY DEFINER RPCs self-inject context (SEC-006/SEC-007)

**Testing**:
- [ ] Cross-casino denial tests passing
- [ ] Role boundary tests passing (dealer, pit_boss, admin, cashier)
- [ ] JWT claims sync tests passing
- [ ] All tests pass under Supavisor pooling mode

**Documentation**:
- [ ] SEC-001 updated with new policies
- [ ] ADR-020 MVP checklist updated

**Operational**:
- [ ] Migration deploys cleanly on staging
- [x] ADR-015 scanner reports 0 issues (verified 2025-12-16)
