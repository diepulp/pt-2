---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline skill

prd: PRD-Shift-Dashboards-v0.2
prd_title: "Shift Dashboards Implementation (Telemetry + Core Metrics)"
service: TableContextService
mvp_phase: 2

workstreams:
  WS1:
    name: Service Layer - Shift Metrics DTOs & Service
    description: DTOs, Zod schemas, and service functions for shift table/pit/casino metrics RPCs
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - services/table-context/shift-metrics/dtos.ts
      - services/table-context/shift-metrics/schemas.ts
      - services/table-context/shift-metrics/service.ts
      - services/table-context/shift-metrics/index.ts
    gate: type-check
    estimated_complexity: medium

  WS2:
    name: API Routes - Shift Metrics
    description: Route handlers for shift metrics endpoints (table/pit/casino)
    executor: api-builder
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - app/api/v1/shift-dashboards/metrics/tables/route.ts
      - app/api/v1/shift-dashboards/metrics/pits/route.ts
      - app/api/v1/shift-dashboards/metrics/casino/route.ts
    gate: type-check
    estimated_complexity: medium

  WS3:
    name: API Routes - Cash Observations & Alerts
    description: Route handlers for cash observation rollups and alerts (uses existing service)
    executor: api-builder
    executor_type: skill
    depends_on: []
    outputs:
      - app/api/v1/shift-dashboards/cash-observations/tables/route.ts
      - app/api/v1/shift-dashboards/cash-observations/pits/route.ts
      - app/api/v1/shift-dashboards/cash-observations/casino/route.ts
      - app/api/v1/shift-dashboards/cash-observations/alerts/route.ts
    gate: type-check
    estimated_complexity: medium

  WS4:
    name: React Query Hooks - Shift Dashboard
    description: TanStack Query v5 hooks for shift metrics and cash observation data fetching
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS2, WS3]
    outputs:
      - hooks/shift-dashboard/use-shift-table-metrics.ts
      - hooks/shift-dashboard/use-shift-pit-metrics.ts
      - hooks/shift-dashboard/use-shift-casino-metrics.ts
      - hooks/shift-dashboard/use-cash-observations.ts
      - hooks/shift-dashboard/use-shift-alerts.ts
      - hooks/shift-dashboard/keys.ts
      - hooks/shift-dashboard/index.ts
    gate: type-check
    estimated_complexity: low

  WS5:
    name: UI Components - Shift Dashboard
    description: Dashboard page with casino/pit/table lenses, alerts panel, and time window selector
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS4]
    outputs:
      - components/shift-dashboard/shift-dashboard-page.tsx
      - components/shift-dashboard/time-window-selector.tsx
      - components/shift-dashboard/casino-summary-card.tsx
      - components/shift-dashboard/pit-metrics-table.tsx
      - components/shift-dashboard/table-metrics-table.tsx
      - components/shift-dashboard/cash-observations-panel.tsx
      - components/shift-dashboard/alerts-panel.tsx
      - components/shift-dashboard/index.ts
      - app/(protected)/shift-dashboard/page.tsx
    gate: build
    estimated_complexity: high

  WS6:
    name: API Tests - Shift Dashboard Endpoints
    description: API integration tests for shift dashboard endpoints
    executor: qa-specialist
    executor_type: skill
    depends_on: [WS2, WS3]
    outputs:
      - __tests__/api/shift-dashboards/metrics.test.ts
      - __tests__/api/shift-dashboards/cash-observations.test.ts
    gate: test-pass
    estimated_complexity: medium

execution_phases:
  - name: Phase 1 - Service Layer Foundation
    parallel: [WS1]
    gates: [type-check]

  - name: Phase 2 - API Routes
    parallel: [WS2, WS3]
    gates: [type-check]

  - name: Phase 3 - React Hooks
    parallel: [WS4]
    gates: [type-check]

  - name: Phase 4 - UI Components
    parallel: [WS5]
    gates: [build]

  - name: Phase 5 - Quality Validation
    parallel: [WS6]
    gates: [test-pass]

gates:
  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0, no type errors"

  build:
    command: npm run build
    success_criteria: "Exit code 0, production build succeeds"

  test-pass:
    command: npm test __tests__/api/shift-dashboards
    success_criteria: "All tests pass"

external_dependencies:
  - service: CashObsService
    location: services/table-context/shift-cash-obs.ts
    status: COMPLETE
    required_for: "WS3 route handlers consume existing cash observation functions"

  - service: ShiftMetricsRPCs
    location: supabase/migrations/
    status: COMPLETE
    required_for: "rpc_shift_table_metrics, rpc_shift_pit_metrics, rpc_shift_casino_metrics"

risks:
  - risk: "RPC return types may not be in database.types.ts"
    mitigation: "Run npm run db:types before starting WS1; use type assertions with eslint-disable until regeneration"

  - risk: "Missing shift metrics data for empty time windows"
    mitigation: "Service layer returns empty arrays/default objects; UI handles gracefully"

---

# EXECUTION-SPEC: PRD-Shift-Dashboards-v0.2 - Shift Dashboards Implementation

## Overview

This PRD delivers the HTTP route handlers and React UI components for the Shift Dashboard feature. The backend database layer (RPCs, tables, RLS policies) and integration tests are already complete. This execution focuses on:

1. **Service Layer**: DTOs and service functions for shift metrics RPCs
2. **API Routes**: REST endpoints for shift metrics and cash observations
3. **React Hooks**: TanStack Query v5 hooks for data fetching
4. **UI Components**: Dashboard page with casino/pit/table lenses

## Scope

**In Scope**:
- Shift metrics service layer (DTOs, Zod schemas, RPC wrappers)
- Route handlers for `/api/v1/shift-dashboards/*`
- React Query hooks for shift dashboard data fetching
- Dashboard UI with time window selector and lens navigation
- API integration tests

**Out of Scope** (Already Complete):
- Database migrations and RPC implementations
- RLS policies
- Integration tests for RPCs (`__tests__/services/table-context/shift-metrics.int.test.ts`)
- Cash observation service (`services/table-context/shift-cash-obs.ts`)

## Architecture Context

**Bounded Context**: TableContextService (operational telemetry)
**SRM Reference**: `docs/20-architecture/SERVICE_RESPONSIBILITY_MATRIX.md` §TableContextService

**Key Patterns**:
- Pattern A (Contract-First) DTOs per `docs/25-api-data/DTO_CANONICAL_STANDARD.md`
- Functional factory services per `docs/20-architecture/SERVICE_LAYER_ARCHITECTURE_DIAGRAM.md`
- ServiceHttpResult response format per `docs/20-architecture/EDGE_TRANSPORT_POLICY.md`

---

## Workstream Details

### WS1: Service Layer - Shift Metrics DTOs & Service

**Purpose**: Create typed DTOs and service functions for shift metrics RPCs.

**Deliverables**:
1. `services/table-context/shift-metrics/dtos.ts` - Response DTOs for table/pit/casino metrics
2. `services/table-context/shift-metrics/schemas.ts` - Zod validation schemas for request params
3. `services/table-context/shift-metrics/service.ts` - RPC calling functions following shift-cash-obs.ts pattern
4. `services/table-context/shift-metrics/index.ts` - Barrel export

**RPC Signatures** (from database):
```sql
rpc_shift_table_metrics(p_window_start timestamptz, p_window_end timestamptz)
rpc_shift_pit_metrics(p_window_start timestamptz, p_window_end timestamptz, p_pit_id uuid?)
rpc_shift_casino_metrics(p_window_start timestamptz, p_window_end timestamptz)
```

**Acceptance Criteria**:
- [ ] DTOs follow Pattern A (Contract-First) with eslint-disable for manual interfaces
- [ ] Service functions match shift-cash-obs.ts patterns
- [ ] Zod schemas validate ISO timestamp strings
- [ ] `npm run type-check` passes

### WS2: API Routes - Shift Metrics

**Purpose**: Create REST endpoints for shift metrics.

**Deliverables**:
1. `app/api/v1/shift-dashboards/metrics/tables/route.ts` - GET per-table metrics
2. `app/api/v1/shift-dashboards/metrics/pits/route.ts` - GET pit-level rollups
3. `app/api/v1/shift-dashboards/metrics/casino/route.ts` - GET casino summary

**Endpoint Contracts**:
```
GET /api/v1/shift-dashboards/metrics/tables?start=ISO&end=ISO
GET /api/v1/shift-dashboards/metrics/pits?start=ISO&end=ISO&pit_id=uuid?
GET /api/v1/shift-dashboards/metrics/casino?start=ISO&end=ISO
```

**Acceptance Criteria**:
- [ ] All routes use `withServerAction` middleware
- [ ] Request validation with Zod schemas
- [ ] Response format: `ServiceHttpResult<DTO>`
- [ ] Casino context derived from auth (not headers)

### WS3: API Routes - Cash Observations & Alerts

**Purpose**: Create REST endpoints for cash observation rollups (uses existing service).

**Deliverables**:
1. `app/api/v1/shift-dashboards/cash-observations/tables/route.ts`
2. `app/api/v1/shift-dashboards/cash-observations/pits/route.ts`
3. `app/api/v1/shift-dashboards/cash-observations/casino/route.ts`
4. `app/api/v1/shift-dashboards/cash-observations/alerts/route.ts`

**Acceptance Criteria**:
- [ ] Consume existing `getShiftCashObs*` functions from `shift-cash-obs.ts`
- [ ] Telemetry labeling preserved in response (is_telemetry: true)
- [ ] `npm run type-check` passes

### WS4: React Query Hooks - Shift Dashboard

**Purpose**: Create TanStack Query v5 hooks for data fetching.

**Deliverables**:
1. `hooks/shift-dashboard/keys.ts` - Query key factories
2. `hooks/shift-dashboard/use-shift-table-metrics.ts`
3. `hooks/shift-dashboard/use-shift-pit-metrics.ts`
4. `hooks/shift-dashboard/use-shift-casino-metrics.ts`
5. `hooks/shift-dashboard/use-cash-observations.ts` - Combined hook for all cash obs queries
6. `hooks/shift-dashboard/use-shift-alerts.ts`
7. `hooks/shift-dashboard/index.ts` - Barrel export

**Acceptance Criteria**:
- [ ] Hooks use query key factories for cache management
- [ ] Proper staleTime/gcTime configuration
- [ ] Error handling follows project patterns
- [ ] `npm run type-check` passes

### WS5: UI Components - Shift Dashboard

**Purpose**: Build the dashboard page with multiple lenses.

**Deliverables**:
1. `components/shift-dashboard/time-window-selector.tsx` - Date/time range picker
2. `components/shift-dashboard/casino-summary-card.tsx` - Casino-level KPIs
3. `components/shift-dashboard/pit-metrics-table.tsx` - Pit-level rollup table
4. `components/shift-dashboard/table-metrics-table.tsx` - Per-table metrics table
5. `components/shift-dashboard/cash-observations-panel.tsx` - Telemetry rollups (labeled)
6. `components/shift-dashboard/alerts-panel.tsx` - Spike alerts display
7. `components/shift-dashboard/shift-dashboard-page.tsx` - Main page composition
8. `app/(protected)/shift-dashboard/page.tsx` - Route page

**UX Reference**: `docs/00-vision/shift-dashboards/ADMIN_DASHBOARD_STYLISTIC_DIRECTION.md`
**UI Reference**: `docs/00-vision/shift-dashboards/dash-1.png`, `docs/00-vision/shift-dashboards/dash-2.png`, `docs/00-vision/shift-dashboards/dash-3.png`

**Acceptance Criteria**:
- [ ] Telemetry sections clearly labeled as observational
- [ ] Time window selector controls all queries
- [ ] Lens navigation: Casino → Pit → Table
- [ ] Accessible (keyboard nav, ARIA labels for alerts)
- [ ] `npm run build` succeeds

### WS6: API Tests - Shift Dashboard Endpoints

**Purpose**: Ensure API endpoints work correctly.

**Deliverables**:
1. `__tests__/api/shift-dashboards/metrics.test.ts` - Tests for metrics endpoints
2. `__tests__/api/shift-dashboards/cash-observations.test.ts` - Tests for cash obs endpoints

**Acceptance Criteria**:
- [ ] Happy path tests for all endpoints
- [ ] Error case tests (invalid params, missing auth)
- [ ] All tests pass

---

## Definition of Done

- [ ] All workstreams complete
- [ ] All gates pass (type-check, build, test-pass)
- [ ] Dashboard renders with time window selector
- [ ] Casino/pit/table lenses navigate correctly
- [ ] Telemetry sections labeled as observational
- [ ] Alerts panel displays spike alerts
- [ ] API tests cover happy paths

---

## Related Documents

- PRD: `docs/10-prd/PRD-Shift-Dashboards-Implementation-v0.2.md`
- SRM: `docs/20-architecture/SERVICE_RESPONSIBILITY_MATRIX.md`
- Metrics Catalog: `docs/00-vision/shift-dashboards/SHIFT_METRICS_CATALOG_v0_PATH_B_PATCH_cash-observations.md`
- Existing Service: `services/table-context/shift-cash-obs.ts`
- Existing DTOs: `services/table-context/dtos.ts`
- Integration Tests: `__tests__/services/table-context/shift-metrics.int.test.ts`
