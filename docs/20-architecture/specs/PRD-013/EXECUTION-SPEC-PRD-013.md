---
# EXECUTION-SPEC Frontmatter
# Generated by lead-architect skill

prd: PRD-013
prd_title: "Zustand State Management Implementation"
service: UIStore
mvp_phase: 0  # Horizontal infrastructure

# Workstream Definitions
workstreams:
  WS1:
    name: Store Infrastructure
    description: Create Zustand stores for modal and dashboard UI state
    agent: pt2-frontend-implementer
    depends_on: []
    outputs:
      - store/ui-store.ts
      - store/pit-dashboard-store.ts
      - store/index.ts
    gate: type-check
    estimated_complexity: low

  WS2:
    name: Selector Hooks
    description: Create typed selector hooks in hooks/ui/ directory
    agent: pt2-frontend-implementer
    depends_on: [WS1]
    outputs:
      - hooks/ui/use-modal.ts
      - hooks/ui/use-pit-dashboard-ui.ts
      - hooks/ui/index.ts
    gate: type-check
    estimated_complexity: low

  WS3:
    name: Component Refactoring
    description: Refactor dashboard components to consume Zustand stores
    agent: pt2-frontend-implementer
    depends_on: [WS2]
    outputs:
      - components/dashboard/pit-dashboard-client.tsx
      - components/pit-panels/pit-panels-client.tsx
      - components/pit-panels/panel-container.tsx
    gate: type-check
    estimated_complexity: medium

  WS4:
    name: Documentation & Validation
    description: Update ADR-003 and HOOKS_STANDARD with implementation evidence
    agent: backend-developer
    depends_on: [WS3]
    outputs:
      - docs/80-adrs/ADR-003-state-management-strategy.md
      - docs/70-governance/HOOKS_STANDARD.md
    gate: build
    estimated_complexity: low

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Store Infrastructure
    parallel: [WS1]
    gates: [type-check]

  - name: Phase 2 - Selector Hooks
    parallel: [WS2]
    gates: [type-check]

  - name: Phase 3 - Component Refactoring
    parallel: [WS3]
    gates: [type-check]

  - name: Phase 4 - Documentation & Validation
    parallel: [WS4]
    gates: [build]

# Validation Gates
gates:
  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0"

  build:
    command: npm run build
    success_criteria: "Exit code 0, no type errors"

# Dependencies on other PRDs/Services
external_dependencies:
  - prd: ADR-003
    service: State Management Strategy
    required_for: "Store patterns and Zustand configuration"

# Risks and Mitigations
risks:
  - risk: "SSR hydration mismatch with Zustand"
    mitigation: "Use 'use client' directive on all store files; avoid server-side store access"
  - risk: "Breaking existing component behavior"
    mitigation: "Incremental refactor; run existing E2E tests after each phase"
  - risk: "Scope creep into server state"
    mitigation: "React Query remains sole owner of fetched data; Zustand only for UI state"

---

# EXECUTION-SPEC: PRD-013 - Zustand State Management

## Overview

Implement Zustand stores for ephemeral UI state as specified in ADR-003 §8. The system currently relies entirely on local `useState` and prop drilling for UI state (modals, table selection, panel navigation). This PRD addresses the gap by creating the `store/` infrastructure and refactoring key dashboard components to consume centralized state.

## Scope

**In Scope:**
- Create `store/ui-store.ts` with modal state slice
- Create `store/pit-dashboard-store.ts` with table/slip selection state
- Create `hooks/ui/` directory with typed selector hooks
- Refactor `PitDashboardClient` to consume stores (eliminate 5 `useState` calls)
- Refactor `PitPanelsClient` to consume stores (eliminate 5 `useState` calls)
- Refactor `PanelContainer` to reduce prop count from 18 to <10
- Add Redux DevTools integration for debugging

**Out of Scope:**
- Server state in Zustand (React Query remains sole owner)
- URL state for filters (deferred to future PRD)
- Persistence middleware
- `store/player-store.ts` (deferred - no concrete use case yet)

## Architecture Context

**ADR-003 §8 Requirements:**
- Zustand for ephemeral UI state only (modals, navigation, filters)
- Slices pattern with combined middleware (devtools)
- Selectors with `useShallow` for fine-grained updates
- RSC hygiene: `'use client'` directive on all store files

**Current State Analysis:**

| Component | Local useState Count | Prop Drilling Depth |
|-----------|---------------------|---------------------|
| `PitDashboardClient` | 5 | 2 levels |
| `PitPanelsClient` | 5 | 3 levels (via PanelContainer) |
| `PanelContainer` | 2 | Receives 18 props |

**Target State:**
- Shared modal state across all dashboard variants
- Table/slip selection preserved when switching views
- `PanelContainer` props reduced to <10

## Workstream Details

### WS1: Store Infrastructure

**Purpose**: Create Zustand stores per ADR-003 §8 specification.

**Deliverables**:
1. `store/ui-store.ts` - Modal state (type, isOpen, data) + sidebar collapse
2. `store/pit-dashboard-store.ts` - Table selection, slip selection, active panel
3. `store/index.ts` - Combined exports

**Store Interfaces (from PRD-013 FR-1, FR-2)**:

```typescript
// ui-store.ts
type ModalType = 'rating-slip' | 'new-slip' | 'player-search' | null;

interface UIStore {
  modal: { type: ModalType; isOpen: boolean; data?: unknown };
  openModal: (type: ModalType, data?: unknown) => void;
  closeModal: () => void;
  sidebarCollapsed: boolean;
  toggleSidebar: () => void;
}

// pit-dashboard-store.ts
interface DashboardStore {
  selectedTableId: string | null;
  selectedSlipId: string | null;
  activePanel: 'tables' | 'activity' | 'inventory' | 'analytics';
  newSlipSeatNumber: string | undefined;
  setSelectedTable: (id: string | null) => void;
  setSelectedSlip: (id: string | null) => void;
  setActivePanel: (panel: DashboardStore['activePanel']) => void;
  setNewSlipSeatNumber: (seat: string | undefined) => void;
  clearSelection: () => void;
}
```

**Acceptance Criteria**:
- [ ] Stores use `devtools` middleware with action naming
- [ ] Stores marked with `'use client'` directive
- [ ] No `any` casts; strict TypeScript compliance
- [ ] `npm run type-check` passes

### WS2: Selector Hooks

**Purpose**: Create typed selector hooks for consuming store state.

**Deliverables**:
1. `hooks/ui/use-modal.ts` - Modal state selector
2. `hooks/ui/use-pit-dashboard-ui.ts` - Pit dashboard UI state selector
3. `hooks/ui/index.ts` - Barrel export

**Hook Signatures (from PRD-013 FR-3)**:

```typescript
// use-modal.ts
function useModal(): {
  isOpen: boolean;
  type: ModalType;
  data: unknown;
  open: (type: ModalType, data?: unknown) => void;
  close: () => void;
}

// use-pit-dashboard-ui.ts
function usePitDashboardUI(): {
  selectedTableId: string | null;
  selectedSlipId: string | null;
  activePanel: 'tables' | 'activity' | 'inventory' | 'analytics';
  newSlipSeatNumber: string | undefined;
  setSelectedTable: (id: string | null) => void;
  setSelectedSlip: (id: string | null) => void;
  setActivePanel: (panel: string) => void;
  setNewSlipSeatNumber: (seat: string | undefined) => void;
  clearSelection: () => void;
}
```

**Acceptance Criteria**:
- [ ] Hooks use `useShallow` for object selectors (Zustand v5 pattern)
- [ ] Hooks marked with `'use client'` directive
- [ ] Full TypeScript inference; no explicit return type needed
- [ ] `npm run type-check` passes

### WS3: Component Refactoring

**Purpose**: Refactor dashboard components to consume centralized state.

**Target Components**:

1. **`PitDashboardClient`** (components/dashboard/pit-dashboard-client.tsx)
   - Remove: `selectedTableId`, `newSlipModalOpen`, `newSlipSeatNumber`, `selectedSlipId`, `isModalOpen` useState
   - Replace with: `usePitDashboardUI()`, `useModal()`
   - Keep: React Query hooks, mutations, memoized derived state

2. **`PitPanelsClient`** (components/pit-panels/pit-panels-client.tsx)
   - Remove: Same 5 useState calls
   - Replace with: `usePitDashboardUI()`, `useModal()`
   - Keep: React Query hooks, mutations

3. **`PanelContainer`** (components/pit-panels/panel-container.tsx)
   - Remove local `activePanel` state (use store)
   - Reduce props by consuming shared state
   - Target: <10 props (currently 18)

**Props to Remove from PanelContainer**:
- `selectedTableId` → from store
- `activePanel` → from store (remove local useState)
- `onTableSelect` → use store action
- `realtimeConnected`, `realtimeError` → consumed directly via realtime hook
- `gamingDay`, `stats` → consumed directly via query hooks

**Acceptance Criteria**:
- [ ] `PitDashboardClient` has 0 local useState for UI state
- [ ] `PitPanelsClient` has 0 local useState for UI state
- [ ] `PanelContainer` prop count < 10
- [ ] Modal open/close state consistent across dashboard variants
- [ ] Table selection preserved when switching views
- [ ] Existing functionality unchanged (manual smoke test)
- [ ] `npm run type-check` passes

### WS4: Documentation & Validation

**Purpose**: Update canonical docs with implementation evidence.

**Deliverables**:
1. Update ADR-003 Implementation Evidence section with actual file paths
2. Update HOOKS_STANDARD with `hooks/ui/` examples

**ADR-003 Updates**:
```markdown
## Implementation Evidence

- Query Client: `lib/query-client.ts`
- Hook templates: `hooks/shared/use-service-query.ts`, `use-service-mutation.ts`
- Domain key factories: `services/*/keys.ts`
- **UI Stores**: `store/ui-store.ts`, `store/pit-dashboard-store.ts` ✅ Implemented
- **UI Hooks**: `hooks/ui/use-modal.ts`, `hooks/ui/use-pit-dashboard-ui.ts` ✅ Implemented
```

**Acceptance Criteria**:
- [ ] ADR-003 updated with implementation evidence
- [ ] HOOKS_STANDARD includes `hooks/ui/` section
- [ ] `npm run build` succeeds
- [ ] Existing Playwright E2E tests pass

## Definition of Done

**Functionality**:
- [ ] `store/ui-store.ts` exists with modal state per FR-1
- [ ] `store/pit-dashboard-store.ts` exists with selection state per FR-2
- [ ] `hooks/ui/use-modal.ts` provides typed selector hook
- [ ] `hooks/ui/use-pit-dashboard-ui.ts` provides typed selector hook
- [ ] `PitDashboardClient` uses stores instead of 5 local `useState`
- [ ] `PitPanelsClient` uses stores instead of 5 local `useState`
- [ ] `PanelContainer` prop count reduced from 18 to <10

**Data & Integrity**:
- [ ] Modal open/close state consistent across dashboard variants
- [ ] Table selection preserved when switching between views

**Testing**:
- [ ] Existing Playwright E2E tests pass (no regression)
- [ ] Manual smoke test: open/close modals, select tables, switch panels

**Documentation**:
- [ ] ADR-003 Implementation Evidence section updated
- [ ] HOOKS_STANDARD `hooks/ui/` examples added

## File Structure

```
store/
├── index.ts                     # Combined store export
├── ui-store.ts                  # Modal, sidebar state
└── pit-dashboard-store.ts       # Pit table/slip selection, panel nav

hooks/
├── ui/                          # NEW directory
│   ├── index.ts                 # Barrel export
│   ├── use-modal.ts             # Modal state selector
│   └── use-pit-dashboard-ui.ts  # Pit dashboard UI state selector
└── ...existing domain hooks...
```
