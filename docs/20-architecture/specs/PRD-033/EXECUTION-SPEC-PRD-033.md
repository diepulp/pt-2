---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline + lead-architect + domain experts

prd: PRD-033
prd_title: "Cashier Workflow MVP: Operational Telemetry Attestations"
service: TableContextService
secondary_service: PlayerFinancialService
mvp_phase: 2  # Session phase — cashier attestation layer

workstreams:
  WS1:
    name: Database Schema Extensions
    description: >
      Add confirmation columns to table_fill, table_credit (status lifecycle),
      cage-received columns to table_drop_event, and external_ref to
      player_financial_transaction. Backward compatible — existing rows default
      to 'confirmed' status.
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/20260216232800_prd033_fill_credit_confirmation_columns.sql
      - supabase/migrations/20260216232801_prd033_drop_event_cage_received_columns.sql
      - supabase/migrations/20260216232802_prd033_financial_txn_external_ref.sql
    gate: schema-validation
    estimated_complexity: medium

  WS2:
    name: ADR-024 Compliant RPCs
    description: >
      Create three new SECURITY DEFINER RPCs for cashier confirmation operations:
      rpc_confirm_table_fill, rpc_confirm_table_credit, rpc_acknowledge_drop_received.
      All follow ADR-024 authoritative context injection pattern. Update existing
      rpc_request_table_fill/rpc_request_table_credit to set status='requested'.
    executor: rls-expert
    executor_type: skill
    depends_on: [WS1]
    outputs:
      - supabase/migrations/20260216232900_prd033_cashier_confirmation_rpcs.sql
      - supabase/migrations/20260216232901_prd033_update_request_rpcs_status.sql
      - supabase/migrations/20260216232902_prd033_immutability_rls_enforcement.sql
    gate: schema-validation
    estimated_complexity: high

  WS3:
    name: Service Layer Extension
    description: >
      Extend TableContextService with cashier confirmation operations:
      DTOs, mappers, Zod schemas, crud functions, cache keys, selects.
    executor: backend-service-builder
    executor_type: skill
    bounded_context: TableContextService
    depends_on: [WS1, WS2]
    outputs:
      - services/table-context/dtos.ts (update)
      - services/table-context/mappers.ts (update)
      - services/table-context/schemas.ts (update)
      - services/table-context/chip-custody.ts (update)
      - services/table-context/keys.ts (update)
      - services/table-context/selects.ts (update)
      - services/table-context/index.ts (update)
      - services/table-context/http.ts (update)
    gate: type-check
    estimated_complexity: medium

  WS3b:
    name: PlayerFinancialService DTO Update (external_ref)
    description: >
      Add external_ref field to PlayerFinancialService DTOs, mappers, and
      selects. Minimal cross-context update — single nullable text column.
    executor: backend-service-builder
    executor_type: skill
    bounded_context: PlayerFinancialService
    depends_on: [WS1]
    outputs:
      - services/financial/dtos.ts (update — external_ref field)
      - services/financial/mappers.ts (update — external_ref field)
      - services/financial/selects.ts (update — external_ref field)
    gate: type-check
    estimated_complexity: low

  WS4:
    name: API Transport (Route Handlers)
    description: >
      Create cashier confirmation route handlers and pending queue query
      endpoints. Add to existing table-context route structure.
    executor: api-builder
    executor_type: skill
    depends_on: [WS3]
    outputs:
      - app/api/v1/table-context/fills/[id]/confirm/route.ts
      - app/api/v1/table-context/credits/[id]/confirm/route.ts
      - app/api/v1/table-context/drop-events/[id]/acknowledge/route.ts
      - app/api/v1/table-context/fills/route.ts (update — GET with status filter)
      - app/api/v1/table-context/credits/route.ts (update — GET with status filter)
      - app/api/v1/table-context/drop-events/route.ts (update — GET with cage_received filter)
    gate: type-check
    estimated_complexity: medium

  WS5:
    name: Cashier Console UI
    description: >
      Create Cashier Console with 3 tab screens: Patron Transactions (cash-out
      confirmation), Operational Confirmations (fill/credit fulfillment), Drop
      Acknowledgements. Add sidebar navigation entry. Reuse existing player search.
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS3, WS4]
    outputs:
      - app/(dashboard)/cashier/layout.tsx
      - app/(dashboard)/cashier/page.tsx
      - app/(dashboard)/cashier/patron-transactions/page.tsx
      - app/(dashboard)/cashier/operational-confirmations/page.tsx
      - app/(dashboard)/cashier/drop-acknowledgements/page.tsx
      - components/cashier/cash-out-form.tsx
      - components/cashier/pending-fill-credit-queue.tsx
      - components/cashier/drop-acknowledgement-list.tsx
      - components/cashier/recent-confirmations-list.tsx
      - components/cashier/void-confirmation-dialog.tsx
      - components/cashier/cashier-tab-nav.tsx
      - hooks/cashier/use-cashier-operations.ts
      - components/layout/app-sidebar.tsx (update — add Cashier nav entry)
    gate: type-check
    estimated_complexity: high

  WS6:
    name: Testing & Validation
    description: >
      Unit tests for service layer extensions, RPC contract tests for cashier
      confirmation RPCs, route handler tests, and E2E happy path tests.
    executor: qa-specialist
    executor_type: skill
    depends_on: [WS4, WS5]
    outputs:
      - services/table-context/__tests__/chip-custody-confirmation.test.ts
      - services/table-context/__tests__/mappers-confirmation.test.ts
      - app/api/v1/table-context/fills/[id]/confirm/__tests__/route.test.ts
      - app/api/v1/table-context/credits/[id]/confirm/__tests__/route.test.ts
      - app/api/v1/table-context/drop-events/[id]/acknowledge/__tests__/route.test.ts
      - e2e/workflows/cashier-workflow.spec.ts
      - docs/20-architecture/SERVICE_RESPONSIBILITY_MATRIX.md (update)
    gate: test-pass
    estimated_complexity: high

execution_phases:
  - name: Phase 1 - Schema
    parallel: [WS1]
    gates: [schema-validation]

  - name: Phase 2 - RPCs
    parallel: [WS2]
    gates: [schema-validation]

  - name: Phase 3 - Service Layer
    parallel: [WS3, WS3b]
    gates: [type-check]

  - name: Phase 4 - Transport + UI
    parallel: [WS4, WS5]
    gates: [type-check, lint]

  - name: Phase 5 - Testing
    parallel: [WS6]
    gates: [test-pass, build]

gates:
  schema-validation:
    command: npm run db:types-local
    success_criteria: "Exit code 0, types regenerated successfully"

  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0, no type errors"

  lint:
    command: npm run lint --max-warnings=0
    success_criteria: "Exit code 0, no errors, no warnings"

  test-pass:
    command: npm test -- --passWithNoTests
    success_criteria: "All tests pass"

  build:
    command: npm run build
    success_criteria: "Exit code 0, no build errors"

external_dependencies:
  - prd: PRD-009
    service: PlayerFinancialService
    required_for: "Cash-out transactions via rpc_create_financial_txn"
  - prd: ADR-024
    service: AuthContext
    required_for: "Authoritative context derivation for all new RPCs"
  - prd: ADR-017
    service: StaffRole
    required_for: "Cashier role in staff_role enum"
  - prd: ADR-031
    service: FinancialConvention
    required_for: "Cents storage, dollars at UI boundary"

risks:
  - risk: "Fill/credit status column migration needs backward compatibility"
    mitigation: "DEFAULT 'confirmed' for existing rows. New pit requests start as 'requested'."
  - risk: "Cashier RLS for fill/credit/drop — current policies allow pit roles, not cashier"
    mitigation: "SELECT policies have no role gate (cashier can read). Writes via SECURITY DEFINER RPCs with cashier/admin role gate. WS2 Migration 6 tightens UPDATE policies: table_fill UPDATE dropped entirely, table_credit UPDATE restricted to status='requested'."
  - risk: "Existing RPCs (rpc_request_table_fill/credit) need status='requested' update"
    mitigation: "Separate migration updates existing RPCs. Backward compatible — no breaking changes."
  - risk: "PRD-009 dependency must provide void+replacement support (Audit Patch §A)"
    mitigation: "Existing schema already supports via related_transaction_id + txn_kind='reversal'. Verify PRD-009 RPC contract before WS5 void UI."
---

# EXECUTION-SPEC: PRD-033 - Cashier Workflow MVP

## Overview

This PRD delivers the **Cashier Console MVP** — a purpose-built UI and backend completion layer enabling cashiers to confirm three categories of operational events that currently lack cage-side attestation:

1. **Patron cash-outs** — chips-to-cash conversion at the cage
2. **Fill/credit fulfillment** — cage confirms chip movement requested by pit
3. **Drop received** — cage stamps receipt of drop box

PT-2 records these as **attestations of operational events** — not financial accounting. Corrections follow void+replacement semantics.

## PRD-009 Dependency Contract: `rpc_create_financial_txn`

PRD-033 assumes PRD-009 provides a stable API for cashier-confirmed patron transactions.

**Must be true in PRD-009 for PRD-033 to ship:**
- Role gate: only `cashier`/`admin` can create `CASH_OUT_CONFIRMED` (and optional `CAGE_CHIP_PURCHASE_CONFIRMED` if later enabled).
- Context derivation: `casino_id` and `gaming_day` are derived from `set_rls_context_from_staff()` (no client-supplied casino_id).
- `external_ref` (receipt/ticket) is supported (nullable).
- Idempotency is enforced (header or payload key maps to stored constraint; duplicates return the original txn).
- Corrections are supported via void + replacement using existing `related_transaction_id` + `txn_kind='reversal'` + `reason_code`.

**If any of the above are not true:** PRD-033 must **not** claim cash-out void/correction as DoD.

**Existing schema support for void/replacement:**
The `player_financial_transaction` table already has `related_transaction_id`, `txn_kind` (with `'reversal'` value), `reason_code`, and `note` — sufficient for audit-traceable void + replacement without new columns (neither Audit Patch Option B1 nor B2 required).

## Anonymous / Walk-in Policy (MVP Decision)

**Decision: Disallow Anonymous for MVP.**

Cashier must select an existing player and visit; `visit_id NOT NULL` is enforced by `rpc_create_financial_txn`. Walk-in and refused-ID patrons cannot have cash-outs recorded in PT-2. This is a trade-off: **shift telemetry will be incomplete by design** for unregistered patrons, prioritizing audit purity (every cash-out linked to a known player) over operational completeness.

**Phase 1.5 note (post-MVP):** Allow anonymous cash-outs with required `external_ref` + `notes` fields, `player_id = NULL`. This restores telemetry completeness for walk-in patrons while maintaining audit trail via receipt reference.

## Gaming Day Function Reference (Audit Patch v0.3 §A)

**Resolved:** `rpc_current_gaming_day(p_timestamp timestamptz DEFAULT now()) RETURNS date` is already deployed via PRD-027 migration `20260203005841_prd027_temporal_rpcs.sql`. It is a SECURITY DEFINER function that calls `set_rls_context_from_staff()` then delegates to `compute_gaming_day_for_casino()` (Layer 2). No dangling references — this is the canonical function used by WS4 GET endpoints for default gaming_day filtering.

## Cashier Pending Queue Reads (RLS Verification)

**Verified:** Existing RLS SELECT policies on `table_fill`, `table_credit`, and `table_drop_event` have **no role gate** — they scope by casino only (via `gaming_table.casino_id` join). Cashier role CAN read pending rows through normal queries with `withServerAction` middleware. No additional SECURITY DEFINER list RPCs are needed.

**Policy source:** `20251220164609_rls_performance_optimization.sql` — `table_fill_select`, `table_credit_select`, `table_drop_event_select` all use `auth.uid() IS NOT NULL AND EXISTS (gaming_table.casino_id = COALESCE(...))` without staff_role restriction.

**Safety valve (Audit Patch v0.3 §D):** If RLS policies later introduce `staff_role` gating that prevents cashier reads, replace direct SELECT-based GET endpoints with SECURITY DEFINER list RPCs (`rpc_list_pending_fills`, `rpc_list_pending_credits`, `rpc_list_unacknowledged_drops`).

## Idempotency Enforcement (Audit Patch v0.3 §C — Honest Language)

**Cash-out creation** (PRD-009): DB-level idempotency via `UNIQUE(casino_id, idempotency_key)` constraint. Duplicate submits return the original transaction. This is real enforcement.

**Fill/credit/drop confirmations**: Naturally idempotent via **resource-id + state transition**:
- Confirm RPC checks `status`; if already `'confirmed'`, returns existing row (no re-update, no error).
- Repeat PATCH is a no-op after confirmation succeeds.
- This is NOT DB-constraint idempotency — it relies on the RPC's status-check logic.

**`Idempotency-Key` header**: Required on PATCH endpoints per ADR-021 transport convention. The header value is **logged for traceability but not enforced** (no idempotency store or DB constraint for confirmation operations). The RPC's natural idempotency provides the safety guarantee.

## Immutability Enforcement

**Mechanism:** Privilege + RLS enforcement (Option 3A from Audit Patch v0.2).

No direct UPDATE/DELETE is permitted by application roles on confirmed rows. State transitions occur only via SECURITY DEFINER RPCs. Enforcement:

- **table_fill**: Replace permissive UPDATE policy with `WHERE status = 'requested'` + pit_boss/admin role gate. Pit can edit requested fills (e.g., correct chipset before cashier confirms). Confirmed rows are immutable via RLS. Only SECURITY DEFINER `rpc_confirm_table_fill` performs the `requested → confirmed` transition.
- **table_credit**: Restrict existing UPDATE policy to `WHERE status = 'requested'` + pit_boss/admin role gate (same pattern as table_fill). Only SECURITY DEFINER `rpc_confirm_table_credit` performs the transition.
- **table_drop_event**: Already safe — no UPDATE policy exists. Only SECURITY DEFINER `rpc_acknowledge_drop_received` can set `cage_received_at`.

## Scope

**In Scope:**
- Schema extensions for confirmation lifecycle (fill/credit status, drop receipt)
- 3 new ADR-024 compliant RPCs for cashier confirmations
- Service layer extension with DTOs, mappers, Zod schemas
- 6 new API endpoints (3 confirmation + 3 pending queue queries)
- Cashier Console UI with 3 tab screens
- Sidebar navigation entry
- Void/correction workflow for cash-outs
- Unit, integration, and E2E tests

**Out of Scope:**
- Drawer balancing, till counts, denomination breakdowns
- GL codes, journal entries, reconciliation
- Bank deposits, cash logistics
- Cage chip purchase (PRD-032)
- Marker credit management
- End-of-day cage close workflow

## Architecture Context

- **Bounded Contexts**: TableContextService (fills, credits, drops), PlayerFinancialService (cash-outs)
- **SRM**: v4.12.0 — no new contexts, extends existing two
- **Security**: ADR-024 (authoritative context), ADR-030 (write-path hardening), ADR-017 (cashier role)
- **Financial**: ADR-031 (cents convention)

---

## Workstream Details

### WS1: Database Schema Extensions

**Purpose**: Add confirmation lifecycle columns to support the two-step request-to-confirmation pattern.

**Migration 1**: `20260216232800_prd033_fill_credit_confirmation_columns.sql`

```sql
-- table_fill confirmation columns
ALTER TABLE table_fill
  ADD COLUMN IF NOT EXISTS status text NOT NULL DEFAULT 'confirmed'
    CHECK (status IN ('requested', 'confirmed')),
  ADD COLUMN IF NOT EXISTS confirmed_at timestamptz,
  ADD COLUMN IF NOT EXISTS confirmed_by uuid REFERENCES staff(id),
  ADD COLUMN IF NOT EXISTS confirmed_amount_cents int,
  ADD COLUMN IF NOT EXISTS discrepancy_note text;

-- table_credit confirmation columns (identical pattern)
ALTER TABLE table_credit
  ADD COLUMN IF NOT EXISTS status text NOT NULL DEFAULT 'confirmed'
    CHECK (status IN ('requested', 'confirmed')),
  ADD COLUMN IF NOT EXISTS confirmed_at timestamptz,
  ADD COLUMN IF NOT EXISTS confirmed_by uuid REFERENCES staff(id),
  ADD COLUMN IF NOT EXISTS confirmed_amount_cents int,
  ADD COLUMN IF NOT EXISTS discrepancy_note text;

-- Indexes for pending queue queries
CREATE INDEX IF NOT EXISTS idx_table_fill_status_casino
  ON table_fill (casino_id, status) WHERE status = 'requested';
CREATE INDEX IF NOT EXISTS idx_table_credit_status_casino
  ON table_credit (casino_id, status) WHERE status = 'requested';
```

**Migration 2**: `20260216232801_prd033_drop_event_cage_received_columns.sql`

```sql
ALTER TABLE table_drop_event
  ADD COLUMN IF NOT EXISTS cage_received_at timestamptz,
  ADD COLUMN IF NOT EXISTS cage_received_by uuid REFERENCES staff(id);

-- Partial index includes gaming_day to avoid infinite backlog scan (Audit Patch §D)
CREATE INDEX IF NOT EXISTS idx_drop_event_pending
  ON table_drop_event (casino_id, gaming_day) WHERE cage_received_at IS NULL;
```

**Migration 3**: `20260216232802_prd033_financial_txn_external_ref.sql`

```sql
ALTER TABLE player_financial_transaction
  ADD COLUMN IF NOT EXISTS external_ref text;

COMMENT ON COLUMN player_financial_transaction.external_ref IS
  'Receipt/ticket reference for cage transactions (PRD-033)';
```

**Schema Assertion (Audit Patch v0.3 §B):** `table_fill` and `table_credit` are casino-scoped tables and include a stored `casino_id uuid NOT NULL` column (confirmed in `database.types.ts`). The `(casino_id, status)` partial indexes in Migration 1 are valid. `table_drop_event` also has `casino_id` — the `(casino_id, gaming_day)` partial index in Migration 2 is valid.

**Future index note:** Fill/credit pending indexes use `(casino_id, status)` and rely on gaming_day filtering at query time. If volume grows, consider upgrading to `(casino_id, gaming_day, status)` partial indexes to match the default query shape. Not needed for MVP.

**Backward Compatibility**: DEFAULT 'confirmed' ensures existing fill/credit rows (created before this migration) are treated as already confirmed (they were fulfilled at insert time). New rows from pit requests will be created with status='requested' after WS2 updates existing RPCs.

**Acceptance Criteria**:
- [ ] All three migrations apply cleanly
- [ ] `npm run db:types-local` succeeds
- [ ] Existing fill/credit rows have status='confirmed'
- [ ] CHECK constraint prevents invalid status values
- [ ] Partial indexes created for pending queue queries (drop index includes gaming_day)

---

### WS2: ADR-024 Compliant RPCs

**Purpose**: Create three new SECURITY DEFINER RPCs for cashier confirmation and update existing request RPCs.

**Migration 4**: `20260216232900_prd033_cashier_confirmation_rpcs.sql`

**RPC 1: `rpc_confirm_table_fill`**
- Parameters: `p_fill_id uuid, p_confirmed_amount_cents int, p_discrepancy_note text DEFAULT NULL`
- Security: SECURITY DEFINER + SET search_path TO 'public'
- Context: Calls `set_rls_context_from_staff()` — derives actor, casino, role
- Role gate: `v_staff_role IN ('cashier', 'admin')`
- Validation: Fill must exist, belong to caller's casino
- Logic (explicit):
  1. If `status = 'confirmed'` → return existing row (idempotent no-op)
  2. If `status = 'requested'` → transition to confirmed
- Discrepancy: If `p_confirmed_amount_cents != fill.amount_cents`, requires `p_discrepancy_note IS NOT NULL`
- Validation (Audit Patch §G):
  - `p_confirmed_amount_cents > 0` (fat-finger guard)
  - `p_discrepancy_note` length <= 500 chars if provided
  - Fill's `casino_id` must match `v_casino_id` from context (cross-casino guard)
- Immutability: Once confirmed, row is never updated again; corrections occur via void + replacement only
- Returns: Updated `table_fill` row

**RPC 2: `rpc_confirm_table_credit`**
- Identical pattern to `rpc_confirm_table_fill` but operates on `table_credit`
- Same logic: if confirmed → return existing (idempotent); if requested → transition to confirmed
- Same validation, immutability rules apply

**RPC 3: `rpc_acknowledge_drop_received`**
- Parameters: `p_drop_event_id uuid`
- Security: Same SECURITY DEFINER + ADR-024 pattern
- Role gate: `v_staff_role IN ('cashier', 'admin')`
- Validation: Drop event must exist, belong to caller's casino
- Validation (Audit Patch §G): Drop event's `casino_id` must match `v_casino_id` from context
- Logic (explicit):
  1. If `cage_received_at IS NOT NULL` → return existing row (idempotent no-op)
  2. If `cage_received_at IS NULL` → stamp as received
- Immutability: Once acknowledged, cage_received_at/cage_received_by cannot be changed
- Sets: `cage_received_at = now()`, `cage_received_by = v_actor_id`
- Returns: Updated `table_drop_event` row

**Migration 5**: `20260216232901_prd033_update_request_rpcs_status.sql`

Update `rpc_request_table_fill` and `rpc_request_table_credit` to set `status = 'requested'` on newly inserted rows (instead of relying on DEFAULT 'confirmed').

**Migration 6**: `20260216232902_prd033_immutability_rls_enforcement.sql`

Enforce immutability via RLS policy changes (Audit Patch v0.2 §3, Option 3A):

```sql
-- table_fill: Replace permissive UPDATE policy with status-gated version
-- Pit can still edit requested fills (e.g., correct chipset before cashier confirms)
-- Confirmed rows are immutable via RLS — only SECURITY DEFINER RPCs transition status
DROP POLICY IF EXISTS table_fill_update ON table_fill;
CREATE POLICY table_fill_update ON table_fill
  FOR UPDATE USING (
    (select auth.uid()) IS NOT NULL
    AND status = 'requested'
    AND EXISTS (
      SELECT 1 FROM staff s
      WHERE s.user_id = (select auth.uid())
      AND s.casino_id = COALESCE(
        NULLIF((select current_setting('app.casino_id', true)), '')::uuid,
        ((select auth.jwt()) -> 'app_metadata' ->> 'casino_id')::uuid
      )
    )
    AND COALESCE(
      NULLIF((select current_setting('app.staff_role', true)), ''),
      ((select auth.jwt()) -> 'app_metadata' ->> 'staff_role')
    ) IN ('pit_boss', 'admin')
  );

-- table_credit: Restrict UPDATE to requested rows only
-- Confirmed rows become immutable via RLS
DROP POLICY IF EXISTS table_credit_update ON table_credit;
CREATE POLICY table_credit_update ON table_credit
  FOR UPDATE USING (
    (select auth.uid()) IS NOT NULL
    AND status = 'requested'
    AND EXISTS (
      SELECT 1 FROM gaming_table gt
      WHERE gt.id = table_credit.table_id
      AND gt.casino_id = COALESCE(
        NULLIF((select current_setting('app.casino_id', true)), '')::uuid,
        ((select auth.jwt()) -> 'app_metadata' ->> 'casino_id')::uuid
      )
    )
    AND COALESCE(
      NULLIF((select current_setting('app.staff_role', true)), ''),
      ((select auth.jwt()) -> 'app_metadata' ->> 'staff_role')
    ) IN ('pit_boss', 'admin')
  );

-- table_drop_event: Already safe — no UPDATE policy exists

NOTIFY pgrst, 'reload schema';
```

**Acceptance Criteria**:
- [ ] All RPCs call `set_rls_context_from_staff()` as first operation
- [ ] No `p_casino_id` or `p_actor_id` parameters (ADR-024 INV-8)
- [ ] Role gate enforces cashier/admin only
- [ ] Idempotent — re-confirmation is safe (no duplicate, no error)
- [ ] Discrepancy note required when amounts differ
- [ ] Status transition: requested -> confirmed only (confirmed is immutable — Audit Patch §C)
- [ ] Confirmed events are immutable; corrections occur via void + replacement only
- [ ] Immutability enforced via RLS: table_fill and table_credit UPDATE restricted to `status='requested'` + pit_boss/admin (Audit Patch v0.2 §3). Confirmed rows cannot be updated via RLS.
- [ ] Server-side validation: amount > 0, discrepancy_note <= 500 chars, casino_id match (Audit Patch §G)
- [ ] `npm run db:types-local` succeeds after migration

---

### WS3: Service Layer Extension

**Purpose**: Extend `services/table-context/` with cashier confirmation operations.

**DTO Updates** (`dtos.ts`):

```typescript
// Add to TableFillDTO:
status: 'requested' | 'confirmed';
confirmed_at: string | null;
confirmed_by: string | null;
confirmed_amount_cents: number | null;
discrepancy_note: string | null;

// Add to TableCreditDTO: (same 5 fields)

// Add to TableDropEventDTO:
cage_received_at: string | null;
cage_received_by: string | null;

// New input DTOs:
export interface ConfirmTableFillInput {
  fillId: string;
  confirmedAmountCents: number;
  discrepancyNote?: string;
}

export interface ConfirmTableCreditInput {
  creditId: string;
  confirmedAmountCents: number;
  discrepancyNote?: string;
}

export interface AcknowledgeDropInput {
  dropEventId: string;
}

// New filter types:
export type FillListFilters = { status?: 'requested' | 'confirmed' };
export type CreditListFilters = { status?: 'requested' | 'confirmed' };
export type DropListFilters = { cageReceived?: boolean };
```

**Mapper Updates** (`mappers.ts`):
- `toTableFillDTO` — map 5 new confirmation fields
- `toTableCreditDTO` — map 5 new confirmation fields
- `toTableDropEventDTO` — map 2 new cage-received fields
- Add row-based mappers for direct queries (pending queue GET endpoints)

**Schema Updates** (`schemas.ts`):
```typescript
export const confirmTableFillSchema = z.object({
  confirmed_amount_cents: z.number().int().positive('Amount must be positive'), // Audit Patch §G
  discrepancy_note: z.string().min(1).max(500).optional(), // Length bounded (Audit Patch §G)
});

export const confirmTableCreditSchema = z.object({
  confirmed_amount_cents: z.number().int().positive('Amount must be positive'),
  discrepancy_note: z.string().min(1).max(500).optional(),
});

// No body needed for drop acknowledgement (just URL param)

export const fillListQuerySchema = z.object({
  status: z.enum(['requested', 'confirmed']).optional(),
  gaming_day: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional(), // defaults to current via RPC
});

export const creditListQuerySchema = z.object({
  status: z.enum(['requested', 'confirmed']).optional(),
  gaming_day: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional(),
});

export const dropListQuerySchema = z.object({
  cage_received: z.enum(['true', 'false']).optional(),
  gaming_day: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional(),
});
```

**CRUD Updates** (`chip-custody.ts`):
```typescript
export async function confirmTableFill(supabase, input: ConfirmTableFillInput): Promise<TableFillDTO>
export async function confirmTableCredit(supabase, input: ConfirmTableCreditInput): Promise<TableCreditDTO>
export async function acknowledgeDropReceived(supabase, input: AcknowledgeDropInput): Promise<TableDropEventDTO>
export async function listPendingFills(supabase): Promise<TableFillDTO[]>
export async function listPendingCredits(supabase): Promise<TableCreditDTO[]>
export async function listUnacknowledgedDrops(supabase): Promise<TableDropEventDTO[]>
```

**Key Updates** (`keys.ts`):
```typescript
// Add to tableContextKeys:
pendingFills: () => [...ROOT, 'pending-fills'] as const,
pendingCredits: () => [...ROOT, 'pending-credits'] as const,
unacknowledgedDrops: () => [...ROOT, 'unacknowledged-drops'] as const,
```

**Select Updates** (`selects.ts`):
- Update `TABLE_FILL_SELECT` to include 5 new columns
- Update `TABLE_CREDIT_SELECT` to include 5 new columns
- Update `TABLE_DROP_EVENT_SELECT` to include 2 new columns

**Interface Updates** (`index.ts`):
Add to `TableContextServiceInterface`:
```typescript
confirmFill(input: ConfirmTableFillInput): Promise<TableFillDTO>;
confirmCredit(input: ConfirmTableCreditInput): Promise<TableCreditDTO>;
acknowledgeDropReceived(input: AcknowledgeDropInput): Promise<TableDropEventDTO>;
listPendingFills(): Promise<TableFillDTO[]>;
listPendingCredits(): Promise<TableCreditDTO[]>;
listUnacknowledgedDrops(): Promise<TableDropEventDTO[]>;
```

**HTTP Fetcher Updates** (`http.ts`):
```typescript
export async function confirmTableFill(fillId: string, input, idempotencyKey?): Promise<TableFillDTO>
export async function confirmTableCredit(creditId: string, input, idempotencyKey?): Promise<TableCreditDTO>
export async function acknowledgeDropReceived(dropEventId: string, idempotencyKey?): Promise<TableDropEventDTO>
export async function fetchPendingFills(): Promise<TableFillDTO[]>
export async function fetchPendingCredits(): Promise<TableCreditDTO[]>
export async function fetchUnacknowledgedDrops(): Promise<TableDropEventDTO[]>
```

**PlayerFinancialService Updates**:
- Add `external_ref: string | null` to `FinancialTransactionDTO`
- Update mapper and select to include `external_ref`

**Acceptance Criteria**:
- [ ] DTOs include all new columns
- [ ] Mappers handle nullable confirmation fields
- [ ] Zod schemas validate confirmation inputs
- [ ] CRUD functions call RPCs correctly
- [ ] Key factories cover pending queues
- [ ] Select projections include new columns
- [ ] Service interface exports new operations
- [ ] HTTP fetchers use correct endpoints
- [ ] `npm run type-check` passes

---

### WS4: API Transport (Route Handlers)

**Purpose**: Create REST endpoints for cashier confirmations and pending queues.

**New Routes** (following existing `table-context` prefix):

| Method | Path | Purpose |
|--------|------|---------|
| PATCH | `/api/v1/table-context/fills/[id]/confirm` | Confirm fill fulfillment |
| PATCH | `/api/v1/table-context/credits/[id]/confirm` | Confirm credit receipt |
| PATCH | `/api/v1/table-context/drop-events/[id]/acknowledge` | Stamp drop received |

**Updated Routes** (add GET support):

| Method | Path | Purpose |
|--------|------|---------|
| GET | `/api/v1/table-context/fills?status=requested` | Pending fill queue (default: current gaming_day) |
| GET | `/api/v1/table-context/credits?status=requested` | Pending credit queue (default: current gaming_day) |
| GET | `/api/v1/table-context/drop-events?cage_received=false` | Unacknowledged drops (default: current gaming_day) |

**Route Handler Pattern** (follows existing fills/route.ts):
```typescript
// app/api/v1/table-context/fills/[id]/confirm/route.ts
export async function PATCH(request: NextRequest, segmentData: { params: Promise<{ id: string }> }) {
  const ctx = createRequestContext(request);
  const { id } = await segmentData.params;
  const idempotencyKey = requireIdempotencyKey(request);
  const supabase = await createClient();
  const body = await readJsonBody(request);
  const input = confirmTableFillSchema.parse(body);

  const result = await withServerAction(supabase, async (mwCtx) => {
    const fill = await confirmTableFill(mwCtx.supabase, {
      fillId: id,
      confirmedAmountCents: input.confirmed_amount_cents,
      discrepancyNote: input.discrepancy_note,
    });
    return { ok: true, code: 'OK', data: fill, ... };
  }, { domain: 'table-context', action: 'confirm-table-fill', ... });

  return result.ok ? successResponse(ctx, result.data) : errorResponse(ctx, result);
}
```

**Acceptance Criteria**:
- [ ] All routes use `withServerAction` middleware
- [ ] Confirmation routes require `Idempotency-Key` header
- [ ] GET routes support query parameter filtering (status, cage_received, gaming_day)
- [ ] GET routes default to current gaming_day via `rpc_current_gaming_day()` (Audit Patch §D, TEMP-003)
- [ ] **RLS safety valve**: If future RLS changes add role gates to SELECT, replace direct reads with SECURITY DEFINER list RPCs (`rpc_list_pending_*`)
- [ ] Next.js 16 `await segmentData.params` for dynamic routes
- [ ] Response format matches `ServiceHttpResult<T>`
- [ ] No `casino_id` in request body (derived from auth context)
- [ ] `npm run type-check` passes

---

### WS5: Cashier Console UI

**Purpose**: Create Cashier Console with 3 tab screens accessible from sidebar.

**Scope Constraint (Audit Patch v0.2 §5):**
- WS5 Patron Transactions tab supports **only** `CASH_OUT_CONFIRMED` create/list/void (per PRD-009).
- No other transaction kinds (buy-in, marker, deposit) are in scope for PRD-033.
- Non-goal: WS5 will not become a generalized financial transaction console.

**Route Structure**:
```
app/(dashboard)/cashier/
  layout.tsx                    # Tab navigation layout
  page.tsx                      # Redirects to patron-transactions
  patron-transactions/
    page.tsx                    # Screen 1: Cash-out confirmation
  operational-confirmations/
    page.tsx                    # Screen 2: Fill/credit fulfillment
  drop-acknowledgements/
    page.tsx                    # Screen 3: Drop received stamps
```

**Component Hierarchy**:
```
components/cashier/
  cashier-tab-nav.tsx           # Tab navigation (3 screens)
  cash-out-form.tsx             # Cash-out confirmation form
  pending-fill-credit-queue.tsx # Pending fill/credit list with confirm action
  drop-acknowledgement-list.tsx # Unacknowledged drops with stamp action
  recent-confirmations-list.tsx # Today's confirmations by this cashier
  void-confirmation-dialog.tsx  # Void + replacement modal
  player-visit-search.tsx       # Player/visit search (reuse existing patterns)
  amount-display.tsx            # Cents-to-dollars display (ADR-031)
```

**React Query Hooks** (`hooks/cashier/use-cashier-operations.ts`):
- `usePendingFills()` — query pending fills
- `usePendingCredits()` — query pending credits
- `useUnacknowledgedDrops()` — query drops
- `useConfirmFill()` — mutation with optimistic update
- `useConfirmCredit()` — mutation with optimistic update
- `useAcknowledgeDrop()` — mutation with optimistic update

**Sidebar Update** (`components/layout/app-sidebar.tsx`):
- Add "Cashier" entry to Operational group (after "Pit")
- Icon: `Banknote` from lucide-react
- URL: `/cashier`

**Gaming Day Filtering (Audit Patch §D)**:
- All pending queues default to **current gaming_day only**
- "Show older pending" available as an opt-in filter toggle, not default
- Prevents infinite backlog accumulation in queue views

**State Management**:
- TanStack Query for server data (pending queues, recent confirmations)
- URL params for active tab navigation
- `useTransition` for all async button operations (React 19 compliance)
- Optimistic updates on confirmation mutations

**ADR-031 Compliance**:
- All amounts stored in cents in DB
- Display as dollars at UI boundary: `(amountCents / 100).toFixed(2)`
- Input fields accept dollar amounts, convert to cents before submission

**Acceptance Criteria**:
- [ ] 3 tab screens accessible from sidebar
- [ ] Player/visit search works for cash-out flow
- [ ] Fill/credit confirmation removes item from pending queue
- [ ] Drop acknowledgement stamps cage receipt
- [ ] Void workflow creates reversal linked to original (using existing related_transaction_id + txn_kind)
- [ ] Pending queues default to current gaming_day (Audit Patch §D)
- [ ] All async operations use `useTransition` (no manual loading states)
- [ ] Amounts display as dollars, submit as cents (ADR-031)
- [ ] No `useEffect` sync patterns
- [ ] `npm run type-check` passes

---

### WS6: Testing & Validation

**Purpose**: Validate all PRD-033 functionality with unit, integration, and E2E tests.

**Unit Tests** (`services/table-context/__tests__/`):

| File | Tests |
|------|-------|
| `chip-custody-confirmation.test.ts` | confirmTableFill, confirmTableCredit, acknowledgeDropReceived |
| `mappers-confirmation.test.ts` | Mapper tests for new confirmation fields |

Test scenarios:
- Fill status transition: requested -> confirmed
- Credit status transition: requested -> confirmed
- Idempotency: re-confirming already-confirmed is safe (returns existing)
- Discrepancy note validation: required when amounts differ
- DTO mapping with all new confirmation columns
- Null handling for optional fields

**Route Handler Tests**:

| File | Tests |
|------|-------|
| `fills/[id]/confirm/__tests__/route.test.ts` | PATCH confirm happy path, validation errors, 404 |
| `credits/[id]/confirm/__tests__/route.test.ts` | Same pattern as fills |
| `drop-events/[id]/acknowledge/__tests__/route.test.ts` | PATCH acknowledge happy path, already-ack'd |

**E2E Tests** (`e2e/workflows/cashier-workflow.spec.ts`):

| Scenario | Steps |
|----------|-------|
| Cash-out confirmation | Login as cashier -> Search player -> Select visit -> Enter amount -> Confirm -> Verify in list |
| Fill fulfillment | Login as cashier -> View pending fills -> Select fill -> Confirm fulfilled -> Verify removed from queue |
| Drop received | Login as cashier -> View drops -> Mark received -> Verify status update |
| Void cash-out | Login as cashier -> View recent -> Void entry -> Enter reason -> Verify reversal created |

**Acceptance Criteria**:
- [ ] Unit tests: 80%+ coverage for new chip-custody functions
- [ ] Unit tests: 100% coverage for new mappers
- [ ] Route handler tests: happy path + error cases for all 3 confirmation endpoints
- [ ] E2E: cashier confirms cash-out end-to-end
- [ ] E2E: cashier confirms fill fulfillment end-to-end
- [ ] E2E: cashier acknowledges drop received end-to-end
- [ ] All existing tests still pass (no regressions)
- [ ] `npm run build` succeeds
- [ ] SRM updated: `docs/20-architecture/SERVICE_RESPONSIBILITY_MATRIX.md` — document new confirmation RPCs, cashier operations, and confirmation columns under TableContextService ownership (Audit Patch v0.3 §E)

---

## Definition of Done

**Must ship:**
- [ ] All 7 workstreams complete (WS1-WS6 including WS3b)
- [ ] All gates pass (schema-validation, type-check, lint, test-pass, build)
- [ ] Cashier can confirm cash-out (create + void/replacement correction path)
- [ ] Cashier can confirm fill/credit requests with discrepancy note
- [ ] Cashier can acknowledge drop received
- [ ] UI defaults filter by current gaming_day; pending queues don't surface entire history (Audit Patch §D)
- [ ] Confirmed records are immutable — enforced by RLS policy removal/restriction + SECURITY DEFINER RPCs (Audit Patch v0.1 §C, v0.2 §3)
- [ ] Cash-out idempotency enforced by PRD-009 DB constraints; confirmations are naturally idempotent via state transitions (Audit Patch v0.3 §C)
- [ ] Cashier can read pending queues via existing RLS SELECT policies (verified: no role gate) (Audit Patch v0.2 §1)
- [ ] Server-side validation: amount > 0, note length caps, casino_id context match (Audit Patch §G)
- [ ] PRD-009 dependency contract verified (Audit Patch §A)
- [ ] Anonymous/walk-in: disallowed for MVP (visit_id NOT NULL) (Audit Patch §E)
- [ ] All events stamped with created_by, casino_id, gaming_day, created_at
- [ ] No regressions in existing tests
- [ ] ADR-024 compliance: all new RPCs use set_rls_context_from_staff()
- [ ] ADR-030 compliance: write-path policies use session vars only
- [ ] ADR-031 compliance: amounts in cents, display in dollars
- [ ] SRM updated with confirmation columns and new operations (WS6 deliverable)

**Must NOT ship:**
- Drawer balancing, cage close, reconciliation, GL posting, denomination breakdowns
- Generalized "transaction console" beyond cash-outs for PRD-033 (Audit Patch v0.2 §5)
