---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline skill

prd: ZUSTAND-RSM
prd_title: "Rating Slip Modal Zustand Integration"
service: RatingSlipModalStore
mvp_phase: 2  # Session Management phase

# Workstream Definitions
# Agent Registry: Task agents (typescript-pro, general-purpose, Explore, Plan)
#                 Skills (frontend-design:frontend-design, qa-specialist, e2e-testing)
workstreams:
  WS1:
    name: Zustand Store & Exports
    description: Create rating-slip-modal-store.ts with devtools middleware and export from store/index.ts
    executor: frontend-design-pt-2  # Task agent - type-safe Zustand store with devtools
    executor_type: task-agent
    depends_on: []
    outputs:
      - store/rating-slip-modal-store.ts
      - store/index.ts
    gate: type-check
    estimated_complexity: medium

  WS2:
    name: Selector Hooks
    description: Create field-specific selector hooks with useShallow in hooks/ui/
    executor: typescript-pro  # Task agent - useShallow optimization, TypeScript generics
    executor_type: task-agent
    depends_on: [WS1]
    outputs:
      - hooks/ui/use-rating-slip-modal.ts
      - hooks/ui/index.ts
    gate: type-check
    estimated_complexity: medium

  WS3:
    name: Store Unit Tests
    description: Add comprehensive unit tests for store actions mirroring player-dashboard-store.test.ts
    executor: typescript-pro  # Task agent - Jest tests with Zustand patterns
    executor_type: task-agent
    depends_on: [WS1]
    outputs:
      - store/__tests__/rating-slip-modal-store.test.ts
    gate: test-pass
    estimated_complexity: medium

  # WS4 decomposed into 5 parallel workstreams (WS4a-WS4e) for form sections
  WS4a:
    name: Refactor FormSectionAverageBet
    description: Replace prop drilling with useAverageBetField() hook, simplify component interface
    executor: frontend-design-pt-2 # Skill - React component refactoring
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - components/modals/rating-slip/form-section-average-bet.tsx
    gate: type-check
    estimated_complexity: medium

  WS4b:
    name: Refactor FormSectionCashIn
    description: Replace prop drilling with useNewBuyInField() hook, simplify component interface
    executor: frontend-design-pt-2 # Skill - React component refactoring
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - components/modals/rating-slip/form-section-cash-in.tsx
    gate: type-check
    estimated_complexity: medium

  WS4c:
    name: Refactor FormSectionStartTime
    description: Replace prop drilling with useStartTimeField() hook, simplify component interface
    executor: frontend-design-pt-2  # Skill - React component refactoring
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - components/modals/rating-slip/form-section-start-time.tsx
    gate: type-check
    estimated_complexity: medium

  WS4d:
    name: Refactor FormSectionMovePlayer
    description: Replace prop drilling with useMovePlayerFields() hook, simplify component interface
    executor: frontend-design-pt-2  # Skill - React component refactoring
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - components/modals/rating-slip/form-section-move-player.tsx
    gate: type-check
    estimated_complexity: medium

  WS4e:
    name: Refactor FormSectionChipsTaken
    description: Replace prop drilling with useChipsTakenField() hook, simplify component interface
    executor: frontend-design-pt-2 # Skill - React component refactoring
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - components/modals/rating-slip/form-section-chips-taken.tsx
    gate: type-check
    estimated_complexity: medium

  WS5:
    name: Modal Integration & Cleanup
    description: Update RatingSlipModal to use store, remove loading state props, delete use-modal-form-state.ts
    executor: frontend-design-pt-2  # Task agent - complex TypeScript/React integration
    executor_type: task-agent
    depends_on: [WS4a, WS4b, WS4c, WS4d, WS4e]
    outputs:
      - components/modals/rating-slip/rating-slip-modal.tsx
    gate: type-check
    estimated_complexity: high

  WS6:
    name: Hook Integration Tests
    description: Add integration tests for form section hooks and store interaction
    executor: e2e-testing  # Task agent - Jest/React Testing Library
    executor_type: task-agent
    depends_on: [WS5]
    outputs:
      - hooks/ui/__tests__/use-rating-slip-modal.test.ts
    gate: test-pass
    estimated_complexity: medium

  WS7:
    name: Quality Validation
    description: Final validation - type-check, lint, build, and verify DevTools integration
    executor: qa-specialist  # Skill - final validation gates
    executor_type: skill
    depends_on: [WS5, WS6]
    outputs: []
    gate: build
    estimated_complexity: low

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Store Foundation
    parallel: [WS1]
    gates: [type-check]

  - name: Phase 2 - Hooks & Store Tests
    parallel: [WS2, WS3]
    gates: [type-check, test-pass]

  - name: Phase 3 - Form Section Refactors (Parallelized)
    parallel: [WS4a, WS4b, WS4c, WS4d, WS4e]  # All 5 form sections can run concurrently
    gates: [type-check]

  - name: Phase 4 - Modal Integration
    parallel: [WS5]
    gates: [type-check]

  - name: Phase 5 - Final Tests & Validation
    parallel: [WS6, WS7]
    gates: [test-pass, build]

# Validation Gates
gates:
  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0"

  test-pass:
    command: npm test store/__tests__/rating-slip-modal-store.test.ts hooks/ui/__tests__/use-rating-slip-modal.test.ts
    success_criteria: "All tests pass"

  lint:
    command: npm run lint -- store/ hooks/ui/ components/modals/rating-slip/
    success_criteria: "Exit code 0, no errors"

  build:
    command: npm run build
    success_criteria: "Production build successful"

# Dependencies on other PRDs/Services
external_dependencies:
  - prd: ADR-003
    service: StateManagement
    required_for: "Zustand patterns and best practices"

# Risks and Mitigations
risks:
  - risk: "Breaking existing consumers of RatingSlipModal props"
    mitigation: "Keep legacy props during migration, deprecate after full integration"
  - risk: "Form state sync issues during partial migration"
    mitigation: "All form sections (WS4a-WS4e) execute in Phase 3 before modal integration (WS5); hooks must complete (WS2) first"
  - risk: "Skill execution coordination across WS4a-WS4e"
    mitigation: "Each skill invocation is independent and shares same hook API contract from WS2"
---

# EXECUTION-SPEC: ZUSTAND-RSM - Rating Slip Modal Zustand Integration

## Overview

Integrate Zustand store pattern into the Rating Slip Modal to eliminate prop drilling through 5 form section components. This aligns the modal with the Player Dashboard Zustand pattern (ADR-003) and removes the anti-pattern of passing loading states as props.

## Scope

### In Scope
- Create RatingSlipModalStore with devtools middleware
- Create field-specific selector hooks (useShallow)
- Refactor all 5 form section components
- Delete use-modal-form-state.ts hook
- Remove isSaving/isClosing/isMoving props
- Add unit tests for store actions
- Add integration tests for hook consumption

### Out of Scope
- Changes to RatingSlipModalData hook (TanStack Query layer)
- Changes to service layer
- E2E tests (covered by existing test suite)
- Migration of other modals

## Architecture Context

References:
- **ADR-003**: State Management Strategy (Zustand for ephemeral UI state)
- **Player Dashboard Store**: `store/player-dashboard-store.ts` (reference implementation)
- **ZUSTAND_INTEGRATION.md**: Gap analysis and detailed implementation spec

## Executor Assignments

| Workstream | Executor | Type | Rationale |
|------------|----------|------|-----------|
| WS1: Zustand Store & Exports | `typescript-pro` | Task Agent | Type-safe Zustand store with devtools |
| WS2: Selector Hooks | `typescript-pro` | Task Agent | useShallow optimization, TypeScript generics |
| WS3: Store Unit Tests | `typescript-pro` | Task Agent | Jest tests with Zustand patterns |
| WS4a: FormSectionAverageBet | `frontend-design:frontend-design` | Skill | React component refactoring |
| WS4b: FormSectionCashIn | `frontend-design:frontend-design` | Skill | React component refactoring |
| WS4c: FormSectionStartTime | `frontend-design:frontend-design` | Skill | React component refactoring |
| WS4d: FormSectionMovePlayer | `frontend-design:frontend-design` | Skill | React component refactoring |
| WS4e: FormSectionChipsTaken | `frontend-design:frontend-design` | Skill | React component refactoring |
| WS5: Modal Integration | `typescript-pro` | Task Agent | Complex TypeScript/React integration |
| WS6: Hook Integration Tests | `typescript-pro` | Task Agent | Jest/React Testing Library |
| WS7: Quality Validation | `qa-specialist` | Skill | Final validation gates |

## Workstream Details

### WS1: Zustand Store & Exports

**Purpose**: Create the core Zustand store with all form state and actions.

**Executor**: `typescript-pro` (Task Agent)

**Deliverables**:
1. `store/rating-slip-modal-store.ts` with devtools middleware
2. Typed interface matching ModalFormState shape
3. Actions: updateField, resetField, incrementField, decrementField, adjustStartTime
4. Export from `store/index.ts`

**Acceptance Criteria**:
- [ ] Store uses devtools middleware with named actions
- [ ] All actions include action type strings for Redux DevTools
- [ ] Store follows player-dashboard-store.ts patterns
- [ ] Exported from store/index.ts

### WS2: Selector Hooks

**Purpose**: Create optimized selector hooks using useShallow.

**Executor**: `typescript-pro` (Task Agent)

**Deliverables**:
1. `hooks/ui/use-rating-slip-modal.ts` with field-specific selectors
2. Hooks: useRatingSlipModal, useAverageBetField, useNewBuyInField, useStartTimeField, useMovePlayerFields, useChipsTakenField
3. Export from `hooks/ui/index.ts`

**Acceptance Criteria**:
- [ ] All hooks use useShallow for optimized re-renders
- [ ] Selectors only subscribe to required fields
- [ ] Actions are stable references (no recreation on re-render)

### WS3: Store Unit Tests

**Purpose**: Ensure store actions work correctly with comprehensive tests.

**Executor**: `typescript-pro` (Task Agent)

**Deliverables**:
1. `store/__tests__/rating-slip-modal-store.test.ts` - All store actions tested
2. Test patterns matching `player-dashboard-store.test.ts`

**Acceptance Criteria**:
- [ ] 100% action coverage for store
- [ ] Test initializeForm, updateField, resetField, incrementField, decrementField, adjustStartTime
- [ ] Verify devtools integration works

### WS4a-WS4e: Form Section Refactors (Parallelized)

**Purpose**: Replace prop drilling with direct store access via hooks across all 5 form sections. Each workstream can execute in parallel after WS2 completes.

**Executor**: `frontend-design:frontend-design` (Skill)

**Pattern for each section**:
```tsx
// Before: Props drilling
function FormSectionX({ value, onChange, onReset, incrementHandlers, ... }) {
  // Use props
}

// After: Hook consumption
function FormSectionX() {
  const { value, updateField, resetField, incrementField, decrementField } = useXField();
  // Use store directly
}
```

#### WS4a: FormSectionAverageBet
- **Output**: `components/modals/rating-slip/form-section-average-bet.tsx`
- **Hook**: `useAverageBetField()`
- **Gate**: type-check

#### WS4b: FormSectionCashIn
- **Output**: `components/modals/rating-slip/form-section-cash-in.tsx`
- **Hook**: `useNewBuyInField()`
- **Gate**: type-check

#### WS4c: FormSectionStartTime
- **Output**: `components/modals/rating-slip/form-section-start-time.tsx`
- **Hook**: `useStartTimeField()`
- **Gate**: type-check

#### WS4d: FormSectionMovePlayer
- **Output**: `components/modals/rating-slip/form-section-move-player.tsx`
- **Hook**: `useMovePlayerFields()`
- **Gate**: type-check

#### WS4e: FormSectionChipsTaken
- **Output**: `components/modals/rating-slip/form-section-chips-taken.tsx`
- **Hook**: `useChipsTakenField()`
- **Gate**: type-check

**Acceptance Criteria** (all WS4x):
- [ ] Each form section imports and uses its specific field hook
- [ ] No form-related props passed from parent
- [ ] Component signatures simplified
- [ ] Component compiles without type errors

### WS5: Modal Integration & Cleanup

**Purpose**: Update RatingSlipModal to initialize store, remove loading state props, and clean up deprecated code.

**Executor**: `typescript-pro` (Task Agent)

**Deliverables**:
1. Remove useModalFormState import and usage
2. Add store initialization effect (keyed by slipId)
3. Remove form-related props from FormSection component calls
4. Remove isSaving, isClosing, isMoving from RatingSlipModalProps
5. Each action button manages its own transition state via useTransition
6. Delete `use-modal-form-state.ts` file

**Acceptance Criteria**:
- [ ] Store initialized when modal opens with data
- [ ] Store reset when slipId changes (key-based reset pattern)
- [ ] No more prop drilling to form sections
- [ ] No loading state props in interface
- [ ] useTransition used at action invocation sites
- [ ] React 19 compliance achieved
- [ ] use-modal-form-state.ts deleted

### WS6: Hook Integration Tests

**Purpose**: Verify hooks work correctly with components.

**Executor**: `typescript-pro` (Task Agent)

**Deliverables**:
1. `hooks/ui/__tests__/use-rating-slip-modal.test.ts` - Hook integration tests

**Acceptance Criteria**:
- [ ] Selector optimization verified
- [ ] Form section → store → render cycle tested
- [ ] Re-render count tests for useShallow efficiency

### WS7: Quality Validation

**Purpose**: Final quality gate validation.

**Executor**: `qa-specialist` (Skill)

**Deliverables**:
1. Run all validation gates
2. Verify DevTools shows named actions
3. Confirm prop drilling eliminated

**Acceptance Criteria**:
- [ ] `npm run type-check` passes (0 errors)
- [ ] `npm run lint` passes
- [ ] `npm run build` succeeds
- [ ] DevTools shows named actions (e.g., `ratingSlipModal/updateField:averageBet`)

## Definition of Done

- [x] All 11 workstreams complete (WS1-WS3, WS4a-WS4e, WS5-WS7)
- [x] `npm run type-check` passes (0 errors)
- [x] `npm test` passes for new test files (80 tests: 50 store + 30 hook)
- [x] `npm run build` succeeds
- [x] Prop drilling eliminated (35+ props → 0)
- [x] use-modal-form-state.ts deleted
- [x] isSaving/isClosing/isMoving props removed
- [x] DevTools shows named actions

---

## Completion Summary

**Status**: ✅ COMPLETE (2025-12-26)

### Artifacts Created

| Workstream | Files |
|------------|-------|
| WS1 | `store/rating-slip-modal-store.ts`, `store/index.ts` |
| WS2 | `hooks/ui/use-rating-slip-modal.ts`, `hooks/ui/index.ts` |
| WS3 | `store/__tests__/rating-slip-modal-store.test.ts` |
| WS4a-WS4e | 5 form section components refactored |
| WS5 | `components/modals/rating-slip/rating-slip-modal.tsx` |
| WS6 | `hooks/ui/__tests__/use-rating-slip-modal.test.ts` |

### Quality Gates Passed

| Gate | Result |
|------|--------|
| Type Check | ✅ 0 errors |
| Unit Tests | ✅ 80/80 passed |
| Lint | ✅ No errors in ZUSTAND-RSM files |
| Build | ✅ Production build successful |

### Key Improvements

- **Prop drilling eliminated**: 35+ props removed from form section interfaces
- **React 19 compliance**: useTransition pattern for async operations
- **DevTools integration**: Named actions for debugging (e.g., `ratingSlipModal/updateField:averageBet`)
- **Optimized re-renders**: Field-specific selector hooks with useShallow
