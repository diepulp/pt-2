---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline skill

prd: PERF-003
prd_title: "Casino-Wide Activity Panel Redundant Query Fix"
service: PitDashboard
mvp_phase: 2  # Session Management

# Workstream Definitions
workstreams:
  WS1:
    name: Performance Fix - Remove Redundant Query
    description: Remove useCasinoActivePlayers() from PanelContainer, use stats.openSlipsCount for badge
    executor: frontend-design:frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - components/pit-panels/panel-container.tsx
    gate: type-check
    estimated_complexity: low

  WS2:
    name: ActivityPanel Component Tests
    description: Comprehensive unit tests for ActivityPanel (loading, error, empty, search, sort, click)
    executor: frontend-design:frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - components/pit-panels/__tests__/activity-panel.test.tsx
    gate: test-pass
    estimated_complexity: medium

  WS3:
    name: useCasinoActivePlayers Hook Tests
    description: Unit tests for the casino active players hook (fetch, error, params, keys)
    executor: frontend-design:frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - hooks/dashboard/__tests__/use-casino-active-players.test.ts
    gate: test-pass
    estimated_complexity: medium

  WS4:
    name: Mapper Tests
    description: Add tests for toActivePlayerForDashboardDTO mapper
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - services/rating-slip/__tests__/mappers.test.ts
    gate: test-pass
    estimated_complexity: low

  WS5:
    name: Quality Validation
    description: Full validation suite - type-check, lint, test, build
    executor: qa-specialist
    executor_type: skill
    depends_on: [WS1, WS2, WS3, WS4]
    outputs: []
    gate: build
    estimated_complexity: low

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Performance Fix
    parallel: [WS1]
    gates: [type-check]

  - name: Phase 2 - Test Coverage
    parallel: [WS2, WS3, WS4]
    gates: [test-pass]

  - name: Phase 3 - Quality Validation
    parallel: [WS5]
    gates: [build]

# Validation Gates
gates:
  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0"

  test-pass:
    command: npm test -- --passWithNoTests
    success_criteria: "All tests pass"

  build:
    command: npm run build
    success_criteria: "Exit code 0, no build errors"

# External Dependencies
external_dependencies: []

# Risks and Mitigations
risks:
  - risk: "Badge count may show slightly different number than full list"
    mitigation: "openSlipsCount from stats is semantically correct for badge display"
---

# EXECUTION-SPEC: PERF-003 - Casino-Wide Activity Panel Redundant Query Fix

## Overview

This spec addresses a performance issue where the pit dashboard makes redundant API calls to `/api/v1/rating-slips/active-players`. The `PanelContainer` fetches the full active players list just to display a badge count, while the same data is fetched again by `ActivityPanel` when rendered.

**Impact**: 2 API calls reduced to 0-1 calls, eliminating ~874ms wasted time and cache fragmentation.

## Scope

**In Scope**:
- Remove redundant `useCasinoActivePlayers()` call from `PanelContainer`
- Use existing `stats.openSlipsCount` for activity badge
- Add comprehensive test coverage for ActivityPanel component
- Add unit tests for `useCasinoActivePlayers` hook
- Add mapper tests for `toActivePlayerForDashboardDTO`

**Out of Scope**:
- RPC optimization (analysis shows RPC is already well-optimized)
- Query key normalization (Option B from investigation - deferred)
- E2E tests (not critical for this performance fix)

## Architecture Context

**Related Components**:
- `components/pit-panels/panel-container.tsx` - Tab navigation container
- `components/pit-panels/activity-panel.tsx` - Casino-wide active players table
- `hooks/dashboard/use-casino-active-players.ts` - TanStack Query hook

**Data Flow After Fix**:
```
PitPanelsClient:
├─ useDashboardStats(casinoId) → stats.openSlipsCount (used for badge)
└─ No useCasinoActivePlayers() call (removed)

ActivityPanel (when opened):
└─ useCasinoActivePlayers({limit: 200}) → Full player list
```

## Workstream Details

### WS1: Performance Fix - Remove Redundant Query

**Purpose**: Eliminate the redundant API call by using already-fetched stats data.

**Deliverables**:
1. Remove `useCasinoActivePlayers()` import and call from `panel-container.tsx`
2. Update `notifications.activity` to use `stats?.openSlipsCount ?? 0`
3. Remove unused import `useCasinoActivePlayers` from hooks import

**Code Changes**:

```diff
// components/pit-panels/panel-container.tsx

-import {
-  RealtimeStatusIndicator,
-  useCasinoActivePlayers,
-} from "@/hooks/dashboard";
+import { RealtimeStatusIndicator } from "@/hooks/dashboard";

// Inside PanelContainer function:
-  // Casino-wide active players for notification count
-  const { data: casinoActivePlayers } = useCasinoActivePlayers();

// In notifications useMemo:
  const notifications = React.useMemo(
    () => ({
      tables: activeSlips.length,
-      activity: casinoActivePlayers?.count ?? 0,
+      activity: stats?.openSlipsCount ?? 0,
      inventory: 0,
      analytics: 0,
    }),
-    [activeSlips.length, casinoActivePlayers?.count],
+    [activeSlips.length, stats?.openSlipsCount],
  );
```

**Acceptance Criteria**:
- [ ] `npm run type-check` passes
- [ ] Network tab shows 0 `/active-players` calls on page load
- [ ] Activity badge displays correct count from stats
- [ ] Activity panel still fetches data when tab is opened

---

### WS2: ActivityPanel Component Tests

**Purpose**: Add comprehensive test coverage for the ActivityPanel component.

**Deliverables**:
1. Test file at `components/pit-panels/__tests__/activity-panel.test.tsx`

**Test Scenarios**:
- Loading state renders skeleton
- Error state renders error message
- Empty state renders "No active players" message
- Search filters players by name
- Sort modes (recent, alpha-asc, alpha-desc) work correctly
- Row click calls `onSlipClick` with correct slipId
- Summary footer shows correct counts

**Acceptance Criteria**:
- [ ] All test scenarios pass
- [ ] Mocks TanStack Query properly
- [ ] Uses React Testing Library patterns

---

### WS3: useCasinoActivePlayers Hook Tests

**Purpose**: Add unit tests for the casino active players hook.

**Deliverables**:
1. Test file at `hooks/dashboard/__tests__/use-casino-active-players.test.ts`

**Test Scenarios**:
- Returns data on successful fetch
- Handles API errors gracefully
- Passes search parameter to API
- Passes limit parameter to API
- Generates correct query keys
- Respects enabled option

**Acceptance Criteria**:
- [ ] All test scenarios pass
- [ ] Uses msw or fetch mocking
- [ ] Tests query key factory

---

### WS4: Mapper Tests

**Purpose**: Add tests for the `toActivePlayerForDashboardDTO` mapper.

**Deliverables**:
1. Add test cases to `services/rating-slip/__tests__/mappers.test.ts`

**Test Scenarios**:
- Maps all fields correctly from RPC response
- Handles null player data
- Handles null optional fields (pit_name, seat_number, etc.)

**Acceptance Criteria**:
- [ ] Tests added to existing mappers.test.ts
- [ ] Full coverage of mapper function

---

### WS5: Quality Validation

**Purpose**: Final validation that all changes are correct and complete.

**Validation Commands**:
```bash
npm run type-check     # TypeScript compilation
npm run lint           # ESLint validation
npm test               # All tests pass
npm run build          # Production build succeeds
```

**Acceptance Criteria**:
- [ ] All gates pass
- [ ] No regressions in existing tests
- [ ] Build completes successfully

---

## Definition of Done

### Performance Fix
- [ ] Remove `useCasinoActivePlayers()` from `panel-container.tsx`
- [ ] Update notification badge to use `stats.openSlipsCount`
- [ ] Verify Activity panel still loads data when opened
- [ ] Network tab shows 0 `/active-players` calls on initial page load
- [ ] Network tab shows 1 `/active-players` call when Activity panel opened

### Test Coverage
- [ ] Unit tests for ActivityPanel (loading, error, empty, search, sort)
- [ ] Unit tests for useCasinoActivePlayers hook
- [ ] Mapper tests for `toActivePlayerForDashboardDTO`
- [ ] All tests passing

### Quality Gates
- [ ] `npm run type-check` passes
- [ ] `npm run lint` passes
- [ ] `npm test` passes
- [ ] `npm run build` passes
