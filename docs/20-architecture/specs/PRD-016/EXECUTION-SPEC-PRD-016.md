---
# EXECUTION-SPEC Frontmatter
# Generated by lead-architect skill
# PRD-016: Rating Slip Session Continuity

prd: PRD-016
prd_title: "Rating Slip Session Continuity"
service: RatingSlipService
mvp_phase: 2  # Session phase

# Workstream Definitions
workstreams:
  WS1:
    name: Database Migration - Schema & Constraints
    description: |
      Add continuity columns to rating_slip table:
      - previous_slip_id (FK for segment chaining)
      - move_group_id (segment chain identifier)
      - accumulated_seconds (prior segments total)
      - final_duration_seconds (computed on close)
      Add partial unique index for max 1 open/paused slip per visit.
      Enforce visit_id NOT NULL + FK on player_financial_transaction.
    agent: backend-service-builder
    depends_on: []
    outputs:
      - supabase/migrations/20251222002622_prd016_rating_slip_continuity.sql
    gate: schema-validation
    estimated_complexity: medium

  WS2:
    name: Duration Computation Function
    description: |
      Create compute_slip_final_seconds(slip_id) SQL function.
      Handles pause edge cases:
      - Paused -> moved (open pause auto-closed)
      - Paused -> closed
      - Multiple pauses
      - Missing pause end_time (fail-safe)
    agent: backend-service-builder
    depends_on: [WS1]
    outputs:
      - supabase/migrations/20251222002623_prd016_compute_slip_final_seconds.sql
    gate: schema-validation
    estimated_complexity: medium

  WS3:
    name: Visit Live View RPC
    description: |
      Create rpc_get_visit_live_view(visit_id, include_segments, segments_limit).
      Returns session aggregate with:
      - visit_id, player info, visit status
      - current_segment (if any active slip)
      - session_totals (duration, buy-in, cash-out, points, segment count)
      - Optional segments array (most recent first)
      SECURITY INVOKER, respects RLS.
    agent: backend-service-builder
    depends_on: [WS1, WS2]
    outputs:
      - supabase/migrations/20251222002624_prd016_rpc_get_visit_live_view.sql
    gate: schema-validation
    estimated_complexity: high

  WS4:
    name: Service Layer - Move Enhancement
    description: |
      Update RatingSlipService to:
      - Populate continuity metadata on move (previous_slip_id, move_group_id, accumulated_seconds)
      - Use compute_slip_final_seconds on close
      - Add visit row locking during move transaction
      - Add getVisitLiveView method calling new RPC
    agent: backend-service-builder
    depends_on: [WS1, WS2, WS3]
    outputs:
      - services/rating-slip/crud.ts
      - services/rating-slip/dtos.ts
      - services/rating-slip/index.ts
      - services/visit/dtos.ts
    gate: type-check
    estimated_complexity: high

  WS5:
    name: Move Route Enhancement
    description: |
      Update POST /api/v1/rating-slips/[id]/move to:
      - Lock visit row before close/start
      - Pass continuity data to service
      - Return updated response with new slip metadata
      Handle 409 for concurrent move attempts.
    agent: api-expert
    depends_on: [WS4]
    outputs:
      - app/api/v1/rating-slips/[id]/move/route.ts
    gate: lint
    estimated_complexity: medium

  WS6:
    name: Visit Live View Route
    description: |
      Create GET /api/v1/visits/[id]/live-view route.
      Calls rpc_get_visit_live_view RPC.
      Query params: include_segments (boolean), segments_limit (int).
    agent: api-expert
    depends_on: [WS4]
    outputs:
      - app/api/v1/visits/[id]/live-view/route.ts
    gate: lint
    estimated_complexity: low

  WS7:
    name: Unit & Integration Tests
    description: |
      Test coverage for:
      - compute_slip_final_seconds edge cases (pause scenarios)
      - Move operation continuity field population
      - rpc_get_visit_live_view aggregation accuracy
      - RLS enforcement (cross-casino blocked)
      - Concurrent move handling (409)
    agent: backend-service-builder
    depends_on: [WS4, WS5, WS6]
    outputs:
      - services/rating-slip/__tests__/rating-slip-continuity.test.ts
      - services/rating-slip/__tests__/rating-slip-continuity.integration.test.ts
    gate: test-pass
    estimated_complexity: high

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Database Foundation
    parallel: [WS1]
    gates: [schema-validation]

  - name: Phase 2 - Database Functions
    parallel: [WS2, WS3]
    gates: [schema-validation]

  - name: Phase 3 - Service Layer
    parallel: [WS4]
    gates: [type-check]

  - name: Phase 4 - Route Handlers
    parallel: [WS5, WS6]
    gates: [lint]

  - name: Phase 5 - Tests
    parallel: [WS7]
    gates: [test-pass]

# Validation Gates
gates:
  schema-validation:
    command: npm run db:types
    success_criteria: "Exit code 0, types regenerated without error"

  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0, no TypeScript errors"

  lint:
    command: npm run lint
    success_criteria: "Exit code 0, no errors"

  test-pass:
    command: npm test -- --testPathPattern="rating-slip-continuity"
    success_criteria: "All tests pass"

# Dependencies on other PRDs/Services
external_dependencies:
  - prd: PRD-002
    service: RatingSlipService
    required_for: "Existing slip operations (start, close, pause, resume)"
  - prd: PRD-003
    service: VisitService
    required_for: "Visit anchor for session identity"
  - prd: PRD-009
    service: PlayerFinancialService
    required_for: "Financial transaction aggregation"

# Risks and Mitigations
risks:
  - risk: "Existing code creates financial txns without visit_id"
    mitigation: "Run diagnostic query before migration; fix write paths"
  - risk: "Two pit bosses move same player simultaneously"
    mitigation: "Partial unique index + visit row locking prevents race"
  - risk: "RPC performance with many segments"
    mitigation: "Default p_include_segments=false; limit to 10"
  - risk: "RLS bypass under connection pooling"
    mitigation: "SECURITY INVOKER + negative cross-casino test"

---

# EXECUTION-SPEC: PRD-016 - Rating Slip Session Continuity

## Overview

Enable session continuity across player table/seat moves without violating rating slip immutability invariants. Introduces slip chaining metadata, enforces visit-anchored financial transactions, and provides a Visit Live View RPC that presents operators with a stable "session slip" while preserving immutable segment telemetry for audit.

**Key Insight**: Rating slips are immutable segment telemetry records ("what happened where"). The session anchor is `visit_id`, not the individual slip. This PRD preserves that invariant while solving the "data loss on move" perception.

## Scope

### In Scope
- Slip chaining via `previous_slip_id` and `move_group_id`
- Duration continuity via `accumulated_seconds` and `final_duration_seconds`
- Visit-anchored financial transactions (NOT NULL + FK)
- Max 1 open/paused slip per visit constraint
- `rpc_get_visit_live_view` RPC for session aggregates
- `compute_slip_final_seconds` authoritative duration function
- Move endpoint enhancement with locking

### Out of Scope
- Mutating table_id/seat_number on existing slips (violates SRM immutability)
- Backfilling historical data (dev environment, clean re-seed)
- UI implementation (separate follow-up after RPC ships)
- Cross-casino session tracking
- `visit_group_id` for cross-visit continuations (future PRD)

## Architecture Context

**Session Identity**: `visit_id` is the canonical operator session key. All session-scoped data (financial transactions, loyalty accrual, MTL thresholds, duration totals) anchors to `visit_id`.

**`move_group_id` is NOT the session key**. It's segment-chain metadata for:
- Traversing the slip chain
- Presentation (grouping segments in UI)
- Audit trail

**References**:
- SRM v4.4.0: Rating slip immutability invariant
- ADR-015: RLS context injection (SECURITY INVOKER pattern)
- PRD-002: Rating Slip Service (existing implementation)
- PRD-003: Visit Service (session anchor)

## Workstream Details

### WS1: Database Migration - Schema & Constraints

**Purpose**: Add continuity columns to rating_slip and enforce visit_id on financial transactions.

**Schema Changes**:
```sql
-- rating_slip additions
previous_slip_id      UUID NULL REFERENCES rating_slip(id)
move_group_id         UUID NULL  -- First segment: NULL or self-ref; moves: carry forward
accumulated_seconds   INT NOT NULL DEFAULT 0  -- Prior segments total
final_duration_seconds INT NULL  -- Set on close, authoritative

-- Partial unique index: max 1 open/paused slip per visit
CREATE UNIQUE INDEX idx_rating_slip_one_active_per_visit
ON rating_slip (visit_id)
WHERE status IN ('open', 'paused');

-- Indexes for chain traversal
CREATE INDEX idx_rating_slip_previous_slip_id ON rating_slip(previous_slip_id);
CREATE INDEX idx_rating_slip_move_group_id ON rating_slip(move_group_id);

-- player_financial_transaction: enforce visit_id NOT NULL + FK
ALTER TABLE player_financial_transaction
  ALTER COLUMN visit_id SET NOT NULL;
```

**Acceptance Criteria**:
- [ ] Migration applies without error
- [ ] `npm run db:types` regenerates types with new columns
- [ ] Partial unique index prevents duplicate open slips

### WS2: Duration Computation Function

**Purpose**: Single source of truth for slip duration calculation.

**SQL Function** (`compute_slip_final_seconds`):
- Takes slip_id, returns duration in seconds (or NULL if still open)
- Calculates: `end_time - start_time - SUM(pause_intervals)`
- Handles edge cases:
  - Open pause auto-closed at slip end_time
  - Multiple pauses summed
  - Missing pause end_time treated as slip end_time

**Acceptance Criteria**:
- [ ] Function created with SECURITY INVOKER
- [ ] Returns NULL for open slips
- [ ] Correctly excludes all pause time

### WS3: Visit Live View RPC

**Purpose**: Single published query for session aggregates.

**Contract**:
```typescript
interface VisitLiveView {
  visit_id: string;
  player_id: string;
  player_name: string;
  visit_status: 'open' | 'closed';
  started_at: string;
  current_segment: {
    slip_id: string;
    table_id: string;
    table_name: string;
    seat_number: number;
    status: 'open' | 'paused';
    segment_started_at: string;
    average_bet: number | null;
  } | null;
  session_totals: {
    total_duration_seconds: number;
    total_buy_in: number;
    total_cash_out: number;
    net: number;
    points_earned: number;
    segment_count: number;
  };
  segments?: Array<{...}>;  // if p_include_segments = true
}
```

**Acceptance Criteria**:
- [ ] RPC uses SECURITY INVOKER
- [ ] Respects RLS under Supavisor pooling
- [ ] Cross-casino query returns empty/fails

### WS4: Service Layer - Move Enhancement

**Purpose**: Populate continuity metadata during move operations.

**Changes to RatingSlipService**:
1. Update `close()` to compute and store `final_duration_seconds`
2. Update move logic to populate:
   - `new.previous_slip_id = old.id`
   - `new.move_group_id = old.move_group_id ?? old.id`
   - `new.accumulated_seconds = old.accumulated_seconds + old.final_duration_seconds`
3. Add `getVisitLiveView(visitId, options?)` method

**Acceptance Criteria**:
- [ ] Move populates all continuity fields correctly
- [ ] `final_duration_seconds` set on every close
- [ ] TypeScript types updated in DTOs

### WS5: Move Route Enhancement

**Purpose**: Update move endpoint with locking and continuity.

**Changes**:
1. Lock visit row with `SELECT ... FOR UPDATE` before close
2. Pass continuity data through service layer
3. Handle 409 for concurrent move attempts

**Acceptance Criteria**:
- [ ] Visit locked during move transaction
- [ ] Concurrent moves return 409
- [ ] Response includes new slip metadata

### WS6: Visit Live View Route

**Purpose**: Expose Visit Live View RPC via REST API.

**Route**: `GET /api/v1/visits/[id]/live-view`

**Query Params**:
- `include_segments`: boolean (default false)
- `segments_limit`: int (default 10)

**Acceptance Criteria**:
- [ ] Uses withServerAction middleware
- [ ] Validates query params with Zod
- [ ] Returns VisitLiveView DTO

### WS7: Unit & Integration Tests

**Purpose**: Verify correctness and security.

**Test Coverage**:
1. `compute_slip_final_seconds`:
   - Paused → moved (open pause auto-closed)
   - Paused → closed
   - Multiple pauses
   - Missing pause end_time
2. Move operation:
   - Continuity fields populated correctly
   - Chain traversable via previous_slip_id
   - accumulated_seconds accumulates across moves
3. `rpc_get_visit_live_view`:
   - Correct aggregate calculation
   - Respects RLS (cross-casino blocked)
   - Segments pagination works
4. Concurrent move handling:
   - Partial unique index prevents duplicate open slips
   - Concurrent attempts get 409

**Acceptance Criteria**:
- [ ] All unit tests pass
- [ ] Integration tests cover happy path + error cases
- [ ] RLS negative test included

## Definition of Done

From PRD-016 Section 8:

**Functionality**
- [ ] Move operation populates `previous_slip_id`, `move_group_id`, `accumulated_seconds`
- [ ] `move_group_id` is self-referential on first segment, carried forward on moves
- [ ] `final_duration_seconds` computed and stored on slip close
- [ ] `rpc_get_visit_live_view` returns complete session aggregate
- [ ] Financial transactions require `visit_id` (NOT NULL + FK enforced)

**Data & Integrity**
- [ ] Slip chain traversable via `previous_slip_id`
- [ ] Max 1 open/paused slip per visit (unique index enforced)
- [ ] Duration calculation correct via `compute_slip_final_seconds`
- [ ] No orphaned financial transactions

**Security & Access**
- [ ] RPC uses SECURITY INVOKER
- [ ] RPC respects RLS under Supavisor pooling
- [ ] Negative test: cross-casino visit query returns empty/fails

**Concurrency**
- [ ] Partial unique index prevents duplicate open slips per visit
- [ ] Move endpoint locks visit row during transaction
- [ ] Concurrent move attempts handled gracefully (409)

**Testing**
- [ ] Unit test: compute_slip_final_seconds handles pause edge cases
- [ ] Unit test: move populates continuity fields correctly
- [ ] Integration test: multi-move session preserves chain and totals
- [ ] Integration test: rpc_get_visit_live_view returns correct aggregate
- [ ] Integration test: rpc_get_visit_live_view respects RLS
