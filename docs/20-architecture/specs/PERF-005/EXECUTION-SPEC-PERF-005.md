---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline (two-stage expert routing)
# Source: docs/issues/perf/PERF-005-RATING-SLIP-COMPREHENSIVE-PERFORMANCE-AUDIT.md

prd: PERF-005
prd_title: "Rating Slip Comprehensive Performance Remediation"
service: RatingSlipService
mvp_phase: 2
scope: performance-remediation

workstreams:
  WS1:
    name: Render Performance Quick Fixes
    description: >
      Extract EMPTY_SEATS as module-level constant in table-grid.tsx to stop
      creating a new array reference on every render (defeats React.memo on 20+
      TableLayoutTerminal instances). Scope realtime table invalidation from
      dashboardKeys.tables.scope (all casinos) to dashboardKeys.tables(casinoId).
    type: react-components
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    bounded_context: pit-dashboard
    outputs:
      - components/dashboard/table-grid.tsx
      - hooks/dashboard/use-dashboard-realtime.tsx
    gate: type-check
    estimated_complexity: low
    findings: [P1-5, P3-5]

  WS2:
    name: Cache Invalidation Fixes
    description: >
      (1) Remove ratingSlipKeys.list.scope and ratingSlipKeys.forTable.scope from
      all 4 core mutation hooks — these are redundant because activeForTable(tableId)
      is already present and more targeted. (2) Fix loyaltyKeys.ledger() invalidation
      to use 4-element prefix ['loyalty','ledger',casinoId,playerId] instead of
      5-element key that misses filtered queries due to TanStack Query prefix matching.
      (3) Add patronDailyTotal key to services/mtl/keys.ts and replace hardcoded
      ['mtl','patron-daily-total',casinoId,playerId] in use-save-with-buyin.ts.
    type: react-query-hooks
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    bounded_context: rating-slip
    outputs:
      - hooks/rating-slip/use-rating-slip-mutations.ts
      - hooks/rating-slip-modal/use-close-with-financial.ts
      - hooks/rating-slip-modal/use-save-with-buyin.ts
      - hooks/rating-slip-modal (movement hooks + modal mutation utils)
      - services/mtl/keys.ts
    gate: type-check
    estimated_complexity: medium
    findings: [P1-3, P0-4, P3-2]

  WS3:
    name: Dead Code & Lint Cleanup
    description: >
      Delete legacy 6-roundtrip crud.move() at services/rating-slip/crud.ts:672-719
      (superseded by rpc_move_player). Delete unused useDashboardSlips from
      hooks/dashboard/use-dashboard-slips.ts IF no imports exist (verify first;
      useActiveSlipsForDashboard in same file IS used). Delete unused
      useActiveSlipsForTable from hooks/rating-slip/use-rating-slip.ts:77-91.
      Remove console.warn at use-close-with-financial.ts:142-145 and
      use-move-player.ts:297-300 (CLAUDE.md guardrail violation).
      IMPORTANT: Grep all imports before deleting.
    type: code-cleanup
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    bounded_context: rating-slip
    outputs:
      - services/rating-slip/crud.ts
      - hooks/dashboard/use-dashboard-slips.ts
      - hooks/rating-slip/use-rating-slip.ts
      - hooks/rating-slip-modal (close + move hooks lint cleanup)
    gate: type-check
    estimated_complexity: low
    findings: [P3-1, P3-7]

  WS4:
    name: Fix gaming_day Serialization Bug
    description: >
      P0-3 correctness bug: 3 wasted 400 responses per modal open because
      gaming_day parameter serializes as [object Object] instead of date string.
      Root cause: GamingDay object ({gaming_day: string,...}) passed where a plain
      string is expected. Investigate the call chain from useMtlGamingDaySummary /
      usePatronDailyTotal through to the query parameter. Fix at the source where
      the object is passed instead of extracting .gaming_day.
    type: bug-fix
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    bounded_context: mtl
    outputs:
      - hooks/mtl/**
      - hooks/rating-slip-modal/**
      - services/mtl/**
    gate: type-check
    estimated_complexity: medium
    findings: [P0-3]

  WS5:
    name: Inline final_duration_seconds in Close RPC
    description: >
      After rpc_close_rating_slip returns duration_seconds, crud.ts:334-341 issues
      a SEPARATE UPDATE to persist final_duration_seconds. The RPC already performs
      an UPDATE but omits this field. Fix: add final_duration_seconds = v_duration
      to the RPC UPDATE statement. Remove redundant TypeScript UPDATE. Saves
      ~50-100ms per close operation.
    type: database-layer
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    bounded_context: rating-slip
    outputs:
      - supabase/migrations/*_perf005_close_rpc_inline_duration.sql
      - services/rating-slip/crud.ts
    gate: type-check
    estimated_complexity: low
    findings: [P1-1]

  WS6:
    name: Remove start() Redundant Pre-Validation
    description: >
      crud.ts:172-199 issues a SELECT to validate the visit exists, is active, and
      belongs to the casino BEFORE calling rpc_start_rating_slip. The RPC performs
      identical validation internally. Remove the pre-validation SELECT. Verify the
      RPC returns distinguishable error codes for each failure case (visit not found,
      visit not active, wrong casino).
    type: service-layer
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    bounded_context: rating-slip
    outputs:
      - services/rating-slip/crud.ts
    gate: type-check
    estimated_complexity: low
    findings: [P1-2]

  WS7:
    name: Composite Save-with-BuyIn RPC
    description: >
      P0-1 — the most impactful fix. Current save flow executes two sequential HTTP
      calls totaling 4,935ms (PATCH average-bet + POST financial-transaction).
      Create rpc_save_rating_slip_with_buyin() that atomically performs both operations
      in a single database transaction. Add route handler POST
      /api/v1/rating-slips/[id]/save-with-buyin. Refactor useSaveWithBuyIn hook to
      single HTTP call. MUST self-inject RLS context per ADR-024. Cross-context
      justification: atomic composite prevents double-entry bugs that caused the
      sequential pattern in the first place.
    type: database-layer
    executor: backend-service-builder
    executor_type: skill
    depends_on: [WS5, WS6]
    bounded_context: rating-slip
    outputs:
      - supabase/migrations/*_perf005_save_with_buyin_rpc.sql
      - services/rating-slip/crud.ts
      - services/rating-slip/http.ts
      - services/rating-slip/dtos.ts
      - app/api/v1/rating-slips/[id]/save-with-buyin/route.ts
      - hooks/rating-slip-modal/use-save-with-buyin.ts
    gate: type-check
    estimated_complexity: high
    findings: [P0-1]

  WS8:
    name: Consolidate Duplicate Mutations
    description: >
      P0-2 — fixes loyalty accrual gap + eliminates inconsistent cache invalidation.
      Same operations (start/pause/resume/close) have 2-3 separate mutation
      implementations: (A) hooks/rating-slip/use-rating-slip-mutations.ts,
      (B) components/dashboard/active-slips-panel.tsx inline useMutation, (C)
      components/dashboard/new-slip-modal.tsx. Close from Path B does NOT trigger
      accrueOnClose() — loyalty bug. Consolidate to canonical hooks with both
      ratingSlipKeys AND dashboardKeys invalidation. Migrate component inline
      mutations to shared hooks.
    type: react-query-hooks
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS2]
    bounded_context: rating-slip
    outputs:
      - hooks/rating-slip/use-rating-slip-mutations.ts
      - components/dashboard/active-slips-panel.tsx
      - components/dashboard/new-slip-modal.tsx
    gate: type-check
    estimated_complexity: high
    findings: [P0-2, P1-4]

  WS9:
    name: Dashboard Render Optimization
    description: >
      Wrap ActiveSlipsPanel and TableGrid in React.memo with stable prop contracts.
      Wrap handleSeatClick, onSlipClick, handleNewSlip with useCallback in
      PitDashboardClient. Stabilize all callback props passed to memoized children.
      Verify no stale render issues.
    type: react-components
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS8]
    bounded_context: pit-dashboard
    outputs:
      - components/dashboard/pit-dashboard-client.tsx
      - components/dashboard/active-slips-panel.tsx
      - components/dashboard/table-grid.tsx
    gate: type-check
    estimated_complexity: medium
    findings: [P1-5]

  WS10:
    name: Unit & Integration Tests
    description: >
      Tests for cache invalidation changes (WS2), gaming_day fix (WS4),
      consolidated mutation hooks (WS8), composite save RPC mapper (WS7).
      Verify loyalty accrual fires from all close paths. Verify targeted
      invalidation scoping. Verify gaming_day serializes as string.
    type: tests
    executor: qa-specialist
    executor_type: skill
    depends_on: [WS2, WS4, WS7, WS8]
    bounded_context: testing
    outputs:
      - __tests__/services/rating-slip/crud.test.ts
      - __tests__/hooks/rating-slip/use-rating-slip-mutations.test.ts
    gate: test-pass
    estimated_complexity: medium
    findings: []

  WS11:
    name: Build Validation & Regression Check
    description: >
      Full build validation. Verify no regressions in existing rating slip
      mapper tests. Type-check entire project. Lint all modified files.
    type: validation
    executor: qa-specialist
    executor_type: skill
    depends_on: [WS1, WS2, WS3, WS4, WS5, WS6, WS7, WS8, WS9, WS10]
    bounded_context: testing
    outputs: []
    gate: build
    estimated_complexity: low
    findings: []

execution_phases:
  - name: "Phase 1 - Quick Wins & Foundation"
    description: >
      All independent fixes run in parallel: render constants, cache
      invalidation scoping, dead code removal, gaming_day bug fix,
      close RPC inlining, start pre-validation removal.
    parallel: [WS1, WS2, WS3, WS4, WS5, WS6]
    gates: [schema-verification, type-check, lint]

  - name: "Phase 2 - Composite Operations"
    description: >
      Build composite save RPC (depends on stable service layer from WS5/WS6).
      Consolidate duplicate mutations (depends on cache patterns from WS2).
    parallel: [WS7, WS8]
    gates: [schema-verification, type-check]

  - name: "Phase 3 - React Performance"
    description: >
      Apply React.memo and useCallback optimizations after mutation
      consolidation stabilizes component props.
    parallel: [WS9]
    gates: [type-check]

  - name: "Phase 4 - Tests & Validation"
    description: >
      Unit tests for all changes, followed by full build validation.
    parallel: [WS10]
    gates: [test-pass]

  - name: "Phase 5 - Final Build Gate"
    description: Full project build validation and regression check.
    parallel: [WS11]
    gates: [build]

gates:
  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0"
  lint:
    command: npm run lint
    success_criteria: "Exit code 0, no warnings"
  schema-verification:
    command: npm test schema-verification
    success_criteria: "Schema verification suite passes with exit code 0"
  test-pass:
    command: npm test -- --passWithNoTests
    success_criteria: "All tests pass"
  build:
    command: npm run build
    success_criteria: "Exit code 0, no build errors"

external_dependencies: []

risks:
  - risk: "Composite save RPC changes atomicity guarantees"
    mitigation: "RPC wraps both operations in single BEGIN/COMMIT; rollback on any failure"
  - risk: "Mutation consolidation breaks ActiveSlipsPanel or NewSlipModal behavior"
    mitigation: "WS8 preserves all existing onSuccess side effects; test loyalty accrual from every close path"
  - risk: "Removing start() pre-validation exposes unclear RPC error messages"
    mitigation: "Verify rpc_start_rating_slip returns distinguishable error codes for missing/inactive visit"
  - risk: "gaming_day fix may affect other MTL consumers"
    mitigation: "Trace all callers of the affected hook; regression test MTL compliance thresholds"
  - risk: "React.memo on dashboard components causes stale renders"
    mitigation: "Only memo components with stable prop contracts; verify with React DevTools profiler"

---

# EXECUTION-SPEC: PERF-005 — Rating Slip Performance Remediation

## Overview

This EXECUTION-SPEC implements the P0 and P1 findings from the [PERF-005 Comprehensive Performance Audit](../../../issues/perf/PERF-005-RATING-SLIP-COMPREHENSIVE-PERFORMANCE-AUDIT.md), which identified **28 unique issues** across 7 independent investigation streams including live browser instrumentation.

The rating slip surface is the most critical daily casino workflow. This remediation targets **4,935ms measured save-flow latency**, **3 functional correctness bugs**, and **225% HTTP overhead** from cache over-invalidation.

**Key targets:**
- Save flow: 4,935ms → ~2,500ms (composite RPC)
- Cache invalidation: ~8 extra fetches/mutation → 1-2 targeted fetches
- Correctness: Fix loyalty accrual gap, gaming_day serialization, ledger cache staleness

## Scope

### In Scope (P0 + P1 + select P3)

| Priority | Finding | Workstream |
|----------|---------|------------|
| **P0-1** | Sequential save waterfall (4,935ms) | WS7 |
| **P0-2** | Duplicate mutations + loyalty bug | WS8 |
| **P0-3** | `gaming_day=[object Object]` | WS4 |
| **P0-4** | loyaltyKeys.ledger() mismatch | WS2 |
| **P1-1** | close() redundant UPDATE | WS5 |
| **P1-2** | start() redundant pre-validation | WS6 |
| **P1-3** | Broad `.list.scope` invalidation | WS2 |
| **P1-4** | Missing dashboard invalidation | WS8 |
| **P1-5** | PitDashboardClient re-render hub | WS1, WS9 |
| **P3-1** | Dead code | WS3 |
| **P3-2** | Hardcoded MTL key | WS2 |
| **P3-5** | dashboardKeys.tables.scope | WS1 |
| **P3-7** | console.warn in production | WS3 |

### Deferred to PERF-005b (P2 items)

| Priority | Finding | Reason |
|----------|---------|--------|
| P2-1 | Triple auth/context overhead | Requires middleware architecture review; ADR-024 security invariant |
| P2-2 | getPlayerSummary() 5+1 waterfall | New RPC; independent scope |
| P2-3 | Start slip 2-3 HTTP calls | New BFF endpoint; independent scope |
| P2-4 | RATING_SLIP_SELECT over-fetch | Requires select refactor with downstream verification |
| P2-5 | Missing optimistic updates | Enhancement, not regression |
| P2-6 | Split key factories | Requires cross-context key unification design |
| P2-7 | Financial adjustment 13 requests | Independent bounded context |
| P3-3 | useRatingSlipList no enabled guard | Low impact |
| P3-4 | Realtime double-tap | TanStack Query deduplicates within staleTime |
| P3-6 | Missing database index | Low priority; active-slip partial indexes cover common path |

## Architecture Context

**Bounded Contexts Affected:**

| Context | Role | Changes |
|---------|------|---------|
| `rating-slip` | Core lifecycle mutations | RPC consolidation, mutation hook unification |
| `pit-dashboard` | Real-time dashboard | Render optimization, scoped invalidation |
| `mtl` | Compliance tracking | gaming_day serialization fix |
| `loyalty` | Reward accrual | Cache key prefix fix, accrual gap closure |
| `financial-transactions` | Buy-in tracking | Absorbed into composite save RPC |

**Expert Skills Consulted:**

| Domain | Expert Skill | Workstreams |
|--------|-------------|-------------|
| Frontend (hooks, components, React perf) | `frontend-design-pt-2` | WS1, WS2, WS4, WS8, WS9 |
| Backend (service layer, RPCs, migrations) | `backend-service-builder` | WS3, WS5, WS6, WS7 |
| Quality (tests, build validation) | `qa-specialist` | WS10, WS11 |

## Workstream Details

### WS1: Render Performance Quick Fixes

**Expert:** frontend-design-pt-2
**Purpose:** Eliminate unnecessary re-renders from unstable references and over-broad invalidation.

**Deliverables:**

1. **Extract `EMPTY_SEATS` constant** (`components/dashboard/table-grid.tsx:111`):
   ```typescript
   // Module-level constant (outside component)
   const EMPTY_SEATS = Array(7).fill(null);
   ```
   Replace `seats={Array(7).fill(null)}` with `seats={EMPTY_SEATS}`. Eliminates new array reference on every render that defeats `React.memo` on 20+ `TableLayoutTerminal` instances.

2. **Scope realtime invalidation** (`hooks/dashboard/use-dashboard-realtime.tsx:132-134`):
   ```typescript
   // Before: dashboardKeys.tables.scope (all casinos)
   // After:  dashboardKeys.tables(casinoId)
   ```
   The `casinoId` is already available as a parameter in the hook.

**Acceptance Criteria:**
- [ ] `EMPTY_SEATS` is a module-level `const`, not inline
- [ ] `handleTableChange` uses `dashboardKeys.tables(casinoId)` (not `.scope`)
- [ ] `npm run type-check` passes

---

### WS2: Cache Invalidation Fixes

**Expert:** frontend-design-pt-2
**Purpose:** Replace shotgun cache invalidation with targeted scoping.

**Deliverables:**

1. **Remove broad invalidation from core mutations** (`hooks/rating-slip/use-rating-slip-mutations.ts`):
   - Line 48: Remove `ratingSlipKeys.list.scope` — `activeForTable(data.table_id)` at line 54 already covers the targeted case
   - Line 51-52: Remove `ratingSlipKeys.forTable.scope` — redundant with `activeForTable`
   - Line 84: Remove `ratingSlipKeys.list.scope` — `activeForTable(data.table_id)` at line 87 covers it
   - Line 117: Remove `ratingSlipKeys.list.scope` — `activeForTable(data.table_id)` at line 119 covers it
   - Line 152: Remove `ratingSlipKeys.list.scope` — `activeForTable(data.table_id)` at line 155 covers it

2. **Fix loyaltyKeys.ledger() prefix** (`use-close-with-financial.ts:220-224`, `use-move-player.ts:307-309`):
   Current: `loyaltyKeys.ledger(playerId, casinoId)` → generates `['loyalty', 'ledger', casinoId, playerId, '[]']`
   Filtered queries generate: `['loyalty', 'ledger', casinoId, playerId, '[["reason","base_accrual"]]']`
   The 5th element differs → TanStack Query prefix matching fails.
   Fix: Use `queryKey: ['loyalty', 'ledger', casinoId, playerId]` (4-element prefix) to match all variants.

3. **Add patronDailyTotal to mtlKeys** (`services/mtl/keys.ts`):
   ```typescript
   patronDailyTotal: (casinoId: string, playerId: string) =>
     [...ROOT, 'patron-daily-total', casinoId, playerId] as const,
   ```
   Then in `use-save-with-buyin.ts:221-223`, replace:
   ```typescript
   queryKey: ['mtl', 'patron-daily-total', casinoId, playerId]
   ```
   with:
   ```typescript
   queryKey: mtlKeys.patronDailyTotal(casinoId, playerId)
   ```

**Acceptance Criteria:**
- [ ] No `ratingSlipKeys.list.scope` in mutation `onSuccess` handlers
- [ ] No `ratingSlipKeys.forTable.scope` in mutation `onSuccess` handlers
- [ ] Loyalty ledger invalidation uses 4-element prefix (no serialized filter element)
- [ ] MTL invalidation uses `mtlKeys.patronDailyTotal()`, not hardcoded array
- [ ] `npm run type-check` passes

---

### WS3: Dead Code & Lint Cleanup

**Expert:** backend-service-builder
**Purpose:** Remove dead code and production lint violations.

**Pre-deletion Protocol:** Grep for all import references before deleting any export.

**Deliverables:**

1. **Delete legacy `crud.move()`** — `services/rating-slip/crud.ts:672-719` (superseded by `rpc_move_player`)
2. **Delete unused `useDashboardSlips`** — `hooks/dashboard/use-dashboard-slips.ts` (verify imports first; `useActiveSlipsForDashboard` in same file IS used from PERF-002 — do NOT delete the entire file if both exports exist)
3. **Delete unused `useActiveSlipsForTable`** — `hooks/rating-slip/use-rating-slip.ts:77-91` (verify no imports)
4. **Remove `console.warn`** — `use-close-with-financial.ts:142-145`, `use-move-player.ts:297-300` (replace with nothing — fire-and-forget pattern should silently swallow errors)

**Acceptance Criteria:**
- [ ] No remaining imports of deleted functions/hooks
- [ ] No `console.warn` in production catch handlers in modified files
- [ ] `npm run type-check` passes
- [ ] `npm run lint` passes

---

### WS4: Fix gaming_day Serialization Bug

**Expert:** frontend-design-pt-2
**Purpose:** Fix P0-3 correctness bug — 3 wasted 400 responses per modal open.

**Investigation Steps:**
1. Trace `gaming_day` parameter from `useMtlGamingDaySummary` or `usePatronDailyTotal` hook
2. Identify where a `GamingDay` object (`{ gaming_day: string }`) is passed instead of `string`
3. Check if two `useGamingDay` hooks exist with incompatible return types sharing the same query key
4. Fix at the call site to extract `.gaming_day` or pass the string directly

**Acceptance Criteria:**
- [ ] `GET /api/v1/mtl/gaming-day-summary` receives a valid date string, not `[object Object]`
- [ ] No 400 responses from gaming-day-summary endpoint during modal open
- [ ] `npm run type-check` passes

---

### WS5: Inline final_duration_seconds in Close RPC

**Expert:** backend-service-builder
**Purpose:** Eliminate redundant UPDATE after `rpc_close_rating_slip`.

**Deliverables:**

1. **SQL Migration** (`YYYYMMDDHHMMSS_perf005_close_rpc_inline_duration.sql`):
   - Find `rpc_close_rating_slip` function definition
   - Add `final_duration_seconds = v_duration` to the RPC's existing UPDATE statement
   - Follow ADR-024 compliance (self-inject context)
   - Include migration header with purpose and ADR reference
   - End with `NOTIFY pgrst, 'reload schema';`

2. **Service layer** (`services/rating-slip/crud.ts:334-341`):
   - Remove the separate UPDATE call for `final_duration_seconds`

**Acceptance Criteria:**
- [ ] `rpc_close_rating_slip` sets `final_duration_seconds` in its UPDATE
- [ ] No separate UPDATE for `final_duration_seconds` in `crud.ts`
- [ ] Close operation completes with correct `final_duration_seconds` value
- [ ] `npm run db:types` succeeds after migration

---

### WS6: Remove start() Redundant Pre-Validation

**Expert:** backend-service-builder
**Purpose:** Eliminate duplicate visit validation before `rpc_start_rating_slip`.

**Deliverables:**

1. Remove `crud.ts:172-199` (the SELECT to validate visit exists/active/casino)
2. Verify `rpc_start_rating_slip` returns distinguishable errors for:
   - Visit not found
   - Visit not active
   - Visit belongs to different casino

**Acceptance Criteria:**
- [ ] No pre-validation SELECT before `rpc_start_rating_slip` call
- [ ] RPC error messages are actionable (not generic 500)
- [ ] `npm run type-check` passes

---

### WS7: Composite Save-with-BuyIn RPC

**Expert:** backend-service-builder
**Purpose:** Eliminate P0-1 sequential save waterfall (4,935ms → ~2,500ms).

**Deliverables:**

1. **SQL Migration** (`YYYYMMDDHHMMSS_perf005_save_with_buyin_rpc.sql`):
   - Create `rpc_save_rating_slip_with_buyin(p_slip_id uuid, p_average_bet numeric, p_buyin_amount numeric, p_buyin_type text)`
   - SECURITY DEFINER with `set_rls_context_from_staff()` (ADR-024)
   - Atomically: UPDATE `rating_slip.average_bet` + INSERT `financial_transaction`
   - Return composite JSONB result (updated slip fields + transaction id)
   - DO NOT accept `p_casino_id` or `p_actor_id` (INV-8 violation)
   - Derive `casino_id` and `actor_id` from context variables

2. **Service layer additions:**
   - `services/rating-slip/crud.ts`: Add `saveWithBuyIn()` function
   - `services/rating-slip/http.ts`: Add HTTP fetcher
   - `services/rating-slip/dtos.ts`: Add `SaveWithBuyInInput` and `SaveWithBuyInResult` DTOs

3. **Route handler:** `app/api/v1/rating-slips/[id]/save-with-buyin/route.ts`
   - POST endpoint using withServerAction middleware
   - Zod schema validation for input

4. **Hook refactor:** `hooks/rating-slip-modal/use-save-with-buyin.ts`
   - Single HTTP call instead of sequential PATCH → POST
   - Preserve existing optimistic update + rollback pattern

**Cross-context justification:** This RPC writes to both `rating_slip` (RatingSlipService) and `financial_transaction` (FinancialTransactionService). The atomic composite operation prevents double-entry bugs — the original sequential pattern was introduced for this exact reason (see comment at use-save-with-buyin.ts:103-105).

**Acceptance Criteria:**
- [ ] Single HTTP roundtrip for save-with-buyin operation
- [ ] Transaction atomicity (both succeed or both fail)
- [ ] RLS context self-injected per ADR-024
- [ ] No `p_casino_id`/`p_actor_id` parameters (INV-8)
- [ ] Existing optimistic UI behavior preserved
- [ ] `npm run db:types` succeeds after migration
- [ ] `npm run type-check` passes

---

### WS8: Consolidate Duplicate Mutations

**Expert:** frontend-design-pt-2
**Purpose:** Fix P0-2 — eliminate 2-3 parallel mutation implementations per operation.

**Deliverables:**

1. **Canonical hooks** in `hooks/rating-slip/use-rating-slip-mutations.ts`:
   - Each operation (start/pause/resume/close) has exactly ONE mutation hook
   - All hooks include both `ratingSlipKeys` AND `dashboardKeys` invalidation
   - Close hook triggers `accrueOnClose()` for loyalty accrual
   - Hooks accept `tableId`, `casinoId` as mutation variables for targeted invalidation

2. **Migrate consumers:**
   - `components/dashboard/active-slips-panel.tsx:87-133` → replace inline `useMutation()` with shared hooks
   - `components/dashboard/new-slip-modal.tsx:111-128` → use shared start hook (or keep inline if visit orchestration is component-specific, but align invalidation keys)

3. **Fix loyalty bug:** Close from ActiveSlipsPanel (Path B) must trigger loyalty accrual via the shared close hook.

**Acceptance Criteria:**
- [ ] One canonical mutation hook per operation (no inline `useMutation()` in components for core lifecycle)
- [ ] All close paths trigger `accrueOnClose()` for loyalty accrual
- [ ] Dashboard keys invalidated from all mutation hooks
- [ ] `npm run type-check` passes

---

### WS9: Dashboard Render Optimization

**Expert:** frontend-design-pt-2
**Purpose:** Reduce PitDashboardClient render cascade (P1-5).

**Deliverables:**

1. **React.memo wrappers:**
   - `ActiveSlipsPanel` — memoize with stable props
   - `TableGrid` — memoize with stable props

2. **useCallback wrappers** in `PitDashboardClient`:
   - `handleSeatClick`
   - `onSlipClick`
   - `handleNewSlip`

3. **Prop stabilization:** Verify all props passed to memoized children are either primitive, memoized, or callback-wrapped.

**Acceptance Criteria:**
- [ ] `ActiveSlipsPanel` and `TableGrid` wrapped in `React.memo`
- [ ] Handler functions stabilized with `useCallback`
- [ ] No stale render issues
- [ ] `npm run type-check` passes

---

### WS10: Unit & Integration Tests

**Expert:** qa-specialist
**Purpose:** Validate all changes with automated tests.

**Test coverage:**
- Cache invalidation: Verify targeted keys match expected patterns
- gaming_day: Verify string serialization, not object
- Mutation consolidation: Verify loyalty accrual from all close paths
- Composite save RPC: Verify mapper handles composite result

**Acceptance Criteria:**
- [ ] All new/modified code has test coverage
- [ ] Existing rating slip mapper tests still pass
- [ ] `npm test` passes

---

### WS11: Build Validation & Regression Check

**Expert:** qa-specialist
**Purpose:** Full project validation gate.

**Acceptance Criteria:**
- [ ] `npm run type-check` — zero errors
- [ ] `npm run lint` — zero errors
- [ ] `npm test` — all pass
- [ ] `npm run build` — zero errors

## Definition of Done

- [ ] All 11 workstreams complete (WS1-WS11)
- [ ] All gates pass (type-check, lint, test-pass, build)
- [ ] Save-with-buyin operation uses single HTTP roundtrip
- [ ] No duplicate mutation implementations for start/pause/resume/close
- [ ] Loyalty accrual fires from every close path (including ActiveSlipsPanel)
- [ ] gaming_day parameter serializes as date string
- [ ] No `.list.scope` shotgun invalidation in mutation hooks
- [ ] No dead code (legacy move, unused hooks)
- [ ] No `console.warn` in production code
- [ ] PERF-005 status updated to "Resolved"
