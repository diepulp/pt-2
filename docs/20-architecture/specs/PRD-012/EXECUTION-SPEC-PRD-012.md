---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline skill

prd: PRD-012
prd_title: "Table Betting Limits Management"
service: TableContextService
mvp_phase: 2  # Phase 2: Table Operations

# Workstream Definitions
workstreams:
  WS1:
    name: Backend Service Layer
    description: DTOs, Zod schemas, CRUD functions, service interface extension
    agent: backend-developer
    depends_on: []
    outputs:
      - services/table-context/dtos.ts (extend)
      - services/table-context/schemas.ts (extend)
      - services/table-context/crud.ts (extend)
      - services/table-context/keys.ts (extend)
      - services/table-context/http.ts (extend)
      - services/table-context/index.ts (extend)
    gate: type-check
    estimated_complexity: medium

  WS2:
    name: API Route Handler
    description: GET/PATCH settings routes with RLS and idempotency
    agent: api-expert
    depends_on: [WS1]
    outputs:
      - app/api/v1/tables/[tableId]/settings/route.ts
    gate: lint
    estimated_complexity: medium

  WS3:
    name: React Query Hooks
    description: Query and mutation hooks for table settings
    agent: backend-developer
    depends_on: [WS1]
    outputs:
      - hooks/table-context/use-table-settings.ts
    gate: type-check
    estimated_complexity: low

  WS4:
    name: UI Components
    description: Limits display in header, edit dialog component
    agent: frontend-design-pt-2
    depends_on: [WS3]
    outputs:
      - components/table/table-limits-dialog.tsx
      - components/table/table-layout-terminal.tsx (extend)
    gate: type-check
    estimated_complexity: medium

  WS5:
    name: Tests
    description: Unit tests for schema validation, integration tests for API
    agent: qa-specialist
    depends_on: [WS1, WS2, WS3]
    outputs:
      - services/table-context/__tests__/table-settings.test.ts
      - app/api/v1/tables/[tableId]/settings/__tests__/route.test.ts
    gate: test-pass
    estimated_complexity: medium

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Backend Foundation
    parallel: [WS1]
    gates: [type-check]

  - name: Phase 2 - API & Hooks
    parallel: [WS2, WS3]
    gates: [lint, type-check]

  - name: Phase 3 - UI Components
    parallel: [WS4]
    gates: [type-check]

  - name: Phase 4 - Tests
    parallel: [WS5]
    gates: [test-pass]

# Validation Gates
gates:
  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0"

  lint:
    command: npm run lint -- app/api/v1/tables/
    success_criteria: "Exit code 0, no errors (warnings OK)"

  test-pass:
    command: npm test -- --testPathPattern="table-settings|tables.*settings"
    success_criteria: "All tests pass"

# Dependencies on other PRDs/Services
external_dependencies:
  - prd: PRD-007
    service: TableContextService
    required_for: "Base service exists with table lifecycle operations"
    status: complete

# Risks and Mitigations
risks:
  - risk: "game_settings table may not have defaults for all casinos/game types"
    mitigation: "Use system fallback (min=10, max=500) when game_settings missing"
  - risk: "RLS policy on gaming_table_settings may not exist"
    mitigation: "Verify RLS exists; create if missing during WS1"
---

# EXECUTION-SPEC: PRD-012 - Table Betting Limits Management

## Overview

Enable pit bosses to view and modify table betting limits (min_bet/max_bet) directly from the TableLayoutTerminal component. The `gaming_table_settings` table already exists, so this PRD extends the existing TableContextService with settings management capabilities.

## Scope

**In Scope**:
- Display min/max bet in TableLayoutTerminal header (full variant only)
- Edit dialog with validation (min ≤ max, non-negative, non-null)
- Auto-create settings from `game_settings` defaults when missing
- GET/PATCH API endpoints with idempotency

**Out of Scope**:
- Limit history/audit trail
- Scheduled limit changes
- Approval workflow
- Compact variant display

## Architecture Context

- **SRM Reference**: SERVICE_RESPONSIBILITY_MATRIX.md §307-342 (TableContextService)
- **Pattern**: B (Extend existing service)
- **HTTP Boundary**: Yes (new route handlers)
- **Existing Service**: `services/table-context/` (PRD-007)

## Workstream Details

### WS1: Backend Service Layer

**Purpose**: Extend TableContextService with table settings DTOs, schemas, and CRUD operations.

**Deliverables**:
1. `TableSettingsDTO` - Pick from database types (id, casino_id, table_id, min_bet, max_bet)
2. `UpdateTableLimitsDTO` - Input type for PATCH (min_bet, max_bet required)
3. `updateTableLimitsSchema` - Zod schema with `.refine()` for min ≤ max validation
4. `getTableSettings` - CRUD function with auto-create from game_settings defaults
5. `updateTableLimits` - CRUD function with upsert logic
6. Query key factory extension (`tableContextKeys.settings()`)
7. HTTP fetcher functions (`fetchTableSettings`, `patchTableLimits`)

**Key Implementation Details**:
```typescript
// DTOs (dtos.ts)
export interface TableSettingsDTO {
  id: string;
  casino_id: string;
  table_id: string;
  min_bet: number;
  max_bet: number;
  active_from: string;
}

export interface UpdateTableLimitsDTO {
  min_bet: number;  // Required, not optional
  max_bet: number;  // Required, not optional
}

// Schema with validation (schemas.ts)
export const updateTableLimitsSchema = z.object({
  min_bet: z.number().nonnegative(),
  max_bet: z.number().nonnegative(),
}).refine(data => data.min_bet <= data.max_bet, {
  message: "min_bet must be less than or equal to max_bet",
  path: ["min_bet"],
});

// CRUD (crud.ts)
// getTableSettings: Fetch settings, auto-create from game_settings if missing
// updateTableLimits: Upsert with validation
```

**Acceptance Criteria**:
- [ ] DTOs follow Pattern B (Pick/Omit from Database types)
- [ ] Zod schema validates min ≤ max
- [ ] Auto-create uses game_settings defaults (or system fallback 25/10000)
- [ ] `npm run type-check` passes

### WS2: API Route Handler

**Purpose**: Create REST endpoint for table settings with RLS enforcement.

**Deliverables**:
1. `GET /api/v1/tables/[tableId]/settings` - Retrieve current limits
2. `PATCH /api/v1/tables/[tableId]/settings` - Update limits with idempotency

**Key Implementation Details**:
```typescript
// app/api/v1/tables/[tableId]/settings/route.ts

export async function GET(request: NextRequest, segmentData: RouteParams) {
  // Uses withServerAction middleware
  // Auto-creates settings if missing (via getTableSettings)
  // Returns ServiceHttpResult<TableSettingsDTO>
}

export async function PATCH(request: NextRequest, segmentData: RouteParams) {
  // Uses withServerAction middleware
  // Validates with updateTableLimitsSchema
  // Requires X-Idempotency-Key header
  // Returns ServiceHttpResult<TableSettingsDTO>
}
```

**Acceptance Criteria**:
- [ ] Uses `withServerAction` wrapper
- [ ] Casino context from RLS (not headers)
- [ ] Idempotency key required for PATCH
- [ ] Response format matches ServiceHttpResult
- [ ] `npm run lint -- app/api/v1/tables/` passes

### WS3: React Query Hooks

**Purpose**: Provide client-side data fetching for table settings.

**Deliverables**:
1. `useTableSettings(tableId)` - Query hook for GET settings
2. `useUpdateTableLimits(tableId)` - Mutation hook for PATCH limits

**Key Implementation Details**:
```typescript
// hooks/table-context/use-table-settings.ts

export function useTableSettings(tableId: string) {
  return useQuery({
    queryKey: tableContextKeys.settings(tableId),
    queryFn: () => fetchTableSettings(tableId),
    enabled: !!tableId,
  });
}

export function useUpdateTableLimits(tableId: string) {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: (data: UpdateTableLimitsDTO) => patchTableLimits(tableId, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: tableContextKeys.settings(tableId) });
    },
  });
}
```

**Acceptance Criteria**:
- [ ] Hooks use key factories from keys.ts
- [ ] Mutations invalidate relevant queries
- [ ] Error handling follows pattern
- [ ] `npm run type-check` passes

### WS4: UI Components

**Purpose**: Display limits in TableLayoutTerminal and provide edit dialog.

**Deliverables**:
1. Extend `TableLayoutTerminal` with limits display in header
2. Create `TableLimitsDialog` component with form inputs

**Key Implementation Details**:
```typescript
// TableLayoutTerminal props extension
interface TableLayoutTerminalProps {
  // ... existing props
  minBet?: number;
  maxBet?: number;
  onEditLimits?: () => void;
}

// TableLimitsDialog
interface TableLimitsDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  currentMinBet: number;
  currentMaxBet: number;
  onSave: (minBet: number, maxBet: number) => Promise<void>;
  isLoading?: boolean;
}
```

**UI Requirements**:
- Limits badge in header: "$25 – $500"
- Pencil icon button to open dialog
- Two numeric inputs for min/max
- Quick increment buttons (+25, +100, +500)
- Client-side validation (min ≤ max)
- Toast on success/error

**Acceptance Criteria**:
- [ ] Limits display in full variant header only
- [ ] Dialog validates min ≤ max before save
- [ ] Loading state during mutation
- [ ] Toast notifications work
- [ ] `npm run type-check` passes

### WS5: Tests

**Purpose**: Ensure implementation correctness.

**Deliverables**:
1. Unit tests for `updateTableLimitsSchema` validation
2. Integration tests for GET/PATCH settings endpoints
3. Hook tests (optional: use testing-library)

**Test Coverage Requirements**:
```typescript
// Schema tests
- Valid limits (min < max) passes
- min > max fails with correct error
- Negative values fail
- Zero values allowed

// API tests
- GET returns existing settings
- GET auto-creates settings when missing
- PATCH updates limits successfully
- PATCH rejects min > max
- PATCH requires idempotency key
```

**Acceptance Criteria**:
- [ ] Schema validation tests pass
- [ ] API integration tests pass
- [ ] `npm test -- --testPathPattern="table-settings"` passes

## Definition of Done

- [ ] All workstreams complete
- [ ] All gates pass (type-check, lint, test-pass)
- [ ] Limits visible in TableLayoutTerminal header
- [ ] Edit dialog functional
- [ ] API routes working with RLS
- [ ] Error codes follow ERROR_TAXONOMY
- [ ] MVP-ROADMAP.md updated (if applicable)
