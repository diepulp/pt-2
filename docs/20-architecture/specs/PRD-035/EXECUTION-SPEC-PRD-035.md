---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline with lead-architect scaffolding + expert refinement

prd: PRD-035
prd_title: 'Onboarding Bootstrap Auth Fixes — Dev Bypass Guard + JWT Claims Refresh Barrier'
service: AuthPipeline / CasinoService (Onboarding)
mvp_phase: 1
category: BUGFIX/SECURITY

workstreams:
  WS1:
    name: Dev Bypass Guard
    description: Add early-return guard in withRLS() to skip RPC when dev bypass is active and ctx.rlsContext is already set
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - lib/server-actions/middleware/rls.ts
    gate: type-check
    estimated_complexity: low

  WS2:
    name: Claims Refresh Verification Helper
    description: Create shared refreshAndVerifyClaims() utility for client-side JWT refresh with claims verification
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: []
    outputs:
      - lib/supabase/refresh-claims.ts
    gate: type-check
    estimated_complexity: low

  WS3:
    name: Bootstrap Claims Refresh
    description: Replace setTimeout redirect with refreshAndVerifyClaims() + retry UI in bootstrap-form.tsx
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - components/onboarding/bootstrap-form.tsx
    gate: type-check
    estimated_complexity: medium

  WS4:
    name: Invite Accept Claims Refresh
    description: Add refreshAndVerifyClaims() to onSuccess callback + retry UI in accept-invite-handler.tsx
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - components/onboarding/accept-invite-handler.tsx
    gate: type-check
    estimated_complexity: low

execution_phases:
  - name: 'Phase 1 — Foundation (Independent Fixes)'
    parallel: [WS1, WS2]
    gates: [type-check, lint]

  - name: 'Phase 2 — Component Integration + Final Validation'
    parallel: [WS3, WS4]
    gates: [type-check, lint, build]

gates:
  type-check:
    command: 'npm run type-check'
    success_criteria: 'Exit code 0'

  lint:
    command: 'npm run lint'
    success_criteria: 'Exit code 0'

  build:
    command: 'npm run build'
    success_criteria: 'Exit code 0'

external_dependencies:
  - prd: PRD-025
    service: CasinoService
    required_for: 'Bootstrap RPC and bootstrapAction (deployed)'
  - prd: PRD-030
    service: CasinoService
    required_for: 'Setup wizard (in progress)'

risks:
  - risk: 'refreshSession() network failure during onboarding'
    mitigation: 'FR-7 claims verification catches failure; auto-retry (1s) + manual retry UI'
  - risk: 'Dev bypass guard false-positive in production'
    mitigation: 'Double gate: isDevAuthBypassEnabled() always returns false when NODE_ENV !== development'
  - risk: 'Claims missing after successful refresh (eventual consistency)'
    mitigation: 'Auto-retry with 1s delay handles propagation lag; manual retry button as fallback'
---

# EXECUTION-SPEC: PRD-035 — Onboarding Bootstrap Auth Fixes

## Overview

PRD-035 fixes two P1 blockers in the onboarding flow: (1) `withRLS()` unconditionally calling the RPC even when dev bypass has already set context, and (2) `bootstrap-form.tsx` and `accept-invite-handler.tsx` navigating with stale JWT cookies instead of refreshing the session first.

Four targeted fixes, zero schema changes, zero RPC modifications.

## Scope

- **In Scope**: Dev bypass guard in `withRLS()`, `refreshAndVerifyClaims()` helper, bootstrap form claims refresh, invite accept claims refresh
- **Out of Scope**: RPC modifications, middleware mode flags, `withAuth()` changes, new type fields, audit logging, rate limiting

## Architecture Context

- **ADR-030 D6**: Onboarding Bootstrap Mode amendment (accepted)
- **ADR-030 INV-030-8**: Dev bypass guard requirement
- **ADR-030 Appendix A**: Execution policy (`docs/80-adrs/ADR-030_APPENDIX-A_onboarding-bootstrap-mode.md`). If file path shifts, use ADR-030 §D6 + the "Onboarding Bootstrap Mode" checklist section.
- **ADR-024**: Authoritative context derivation (RPC is correct; middleware is at fault)
- **FR-8 Invariant**: Any workflow mutating RLS claims must refresh + verify before routing to RLS-gated pages
- **NFR-2 JWT Fallback**: RLS policies use `COALESCE(current_setting('app.casino_id', true), (auth.jwt()->'app_metadata'->>'casino_id'))` — canonical reference: `docs/30-security/SEC-001-rls-policy-matrix.md` §Pattern C; concrete example: `supabase/migrations/20251211170030_adr015_finance_rls_hybrid.sql`

## Workstream Details

### WS1: Dev Bypass Guard

**Purpose**: Fix the dev bypass failure where `withRLS()` unconditionally calls `set_rls_context_from_staff()` even when the service-role client (which has no `auth.uid()`) is in use.

**File**: `lib/server-actions/middleware/rls.ts`

**Implementation**:

1. Add import: `isDevAuthBypassEnabled` from `@/lib/supabase/dev-context`
2. Add early-return guard before the try block:
   ```typescript
   // INV-030-8: Dev bypass — context already set by withAuth() from DEV_RLS_CONTEXT.
   // Service-role client has no auth.uid(), so the RPC would always fail.
   // Invariant: only dev bypass sets ctx.rlsContext before withRLS() in the current
   // middleware chain. If future refactors change this, revisit this guard.
   if (ctx.rlsContext && isDevAuthBypassEnabled()) {
     return next();
   }
   ```

**Patterns**: ADR-030 INV-030-8, dual gate (INV-030-3)

**Acceptance Criteria**:

- [ ] Guard added with invariant comment
- [ ] `isDevAuthBypassEnabled` import added
- [ ] Non-bypass path unchanged (RPC still called for real auth)
- [ ] No new types on `MiddlewareContext` or `RLSContext`
- [ ] **Tripwire (FR-2 proof)**: In non-bypass mode, `withRLS()` MUST call the RPC even if `ctx.rlsContext` happens to be pre-populated. Verify by code inspection that the guard requires BOTH conditions (`ctx.rlsContext` truthy AND `isDevAuthBypassEnabled()` true). A future refactor that sets `ctx.rlsContext` for non-bypass reasons will NOT trigger the skip because `isDevAuthBypassEnabled()` returns false in production.
- [ ] `npm run type-check` passes

---

### WS2: Claims Refresh Verification Helper

**Purpose**: Create shared utility for client-side JWT refresh with claims verification, consumed by WS3 and WS4.

**File**: `lib/supabase/refresh-claims.ts` (NEW)

**Implementation**:

1. Export `refreshAndVerifyClaims(): Promise<RefreshResult>`
2. Uses `createBrowserComponentClient()` from `@/lib/supabase/client`
3. Calls `supabase.auth.refreshSession()` to mint fresh JWT
4. Verifies `casino_id`, `staff_id`, `staff_role` in `session.user.app_metadata`
5. One automatic retry (1s delay) for stale-metadata edge case
6. Returns typed `{ ok: boolean; error?: string }` — no thrown exceptions

**Reference implementation** (retry loop is mandatory):

```typescript
import { createBrowserComponentClient } from '@/lib/supabase/client';

export interface RefreshResult {
  ok: boolean;
  error?: string;
}

const REQUIRED_CLAIMS = ['casino_id', 'staff_id', 'staff_role'] as const;
const AUTO_RETRY_DELAY_MS = 1000;

export async function refreshAndVerifyClaims(): Promise<RefreshResult> {
  const supabase = createBrowserComponentClient();

  // Two attempts: first refresh, then 1s wait + second refresh for stale-metadata edge case.
  for (let attempt = 0; attempt < 2; attempt++) {
    const { data, error } = await supabase.auth.refreshSession();

    if (error || !data.session) {
      return { ok: false, error: error?.message ?? 'Session refresh failed' };
    }

    const metadata = data.session.user.app_metadata;
    const missing = REQUIRED_CLAIMS.filter((key) => !metadata[key]);

    if (missing.length === 0) {
      return { ok: true };
    }

    // First attempt had stale metadata — wait briefly, then retry once.
    if (attempt === 0) {
      await new Promise((r) => setTimeout(r, AUTO_RETRY_DELAY_MS));
    }
  }

  // Both attempts failed — surface to UI for manual retry.
  return { ok: false, error: 'Claims not yet available. Please retry.' };
}
```

**Patterns**: Typed result pattern, Supabase browser client singleton, two-attempt retry with 1s backoff

> **Cross-reference**: PRD-035 Appendix A §WS2 (lines 290-327) contains the same retry-loop implementation. This EXECUTION-SPEC reference implementation is authoritative for pipeline execution.

**Acceptance Criteria**:

- [ ] File created at `lib/supabase/refresh-claims.ts`
- [ ] `RefreshResult` interface exported
- [ ] Required claims: `casino_id`, `staff_id`, `staff_role`
- [ ] **Two-attempt retry**: refresh → check claims → if missing, wait 1s → refresh again → check → fail with error
- [ ] Returns error result (not thrown) on final failure
- [ ] `npm run type-check` passes

---

### WS3: Bootstrap Claims Refresh

**Purpose**: Replace `setTimeout` redirect with proper `refreshAndVerifyClaims()` call in the bootstrap form, ensuring the JWT has fresh claims before navigating to RLS-gated pages.

**File**: `components/onboarding/bootstrap-form.tsx`

**Implementation**:

1. Add import: `refreshAndVerifyClaims` from `@/lib/supabase/refresh-claims`
2. Add `refreshError` state: `useState<string | null>(null)`
3. Replace `useEffect` auto-redirect:
   - Remove `setTimeout(() => router.push('/start'), 1500)`
   - Replace with async IIFE calling `refreshAndVerifyClaims()` + navigate on success
4. Update success card (note: bootstrap succeeded server-side; refresh is client-side session finalization):
   - On `refreshError`: show "Finalizing your session..." + retry button (casino is created, JWT not yet refreshed)
   - On success (no error): show "Your workspace is ready. Redirecting..."
5. Update "Go to Dashboard" button to async handler with verification

**Patterns**: React 19 useEffect async IIFE, useTransition for retry button, retry UI

**Acceptance Criteria**:

- [ ] `setTimeout` removed
- [ ] Auto-redirect calls `refreshAndVerifyClaims()` before navigation
- [ ] "Go to Dashboard" button calls `refreshAndVerifyClaims()` before navigation
- [ ] Retry UI shows on claims verification failure
- [ ] No `eslint-disable exhaustive-deps`
- [ ] No state updates after unmount (use cancel flag or ignore pattern in async IIFE if component unmounts during refresh)
- [ ] `npm run type-check` passes

---

### WS4: Invite Accept Claims Refresh

**Purpose**: Add claims refresh barrier to the invite acceptance flow, preventing navigation with stale JWT.

**File**: `components/onboarding/accept-invite-handler.tsx`

**Implementation**:

1. Add import: `refreshAndVerifyClaims` from `@/lib/supabase/refresh-claims`
2. Add `refreshError` state: `useState<string | null>(null)`
3. Update `onSuccess` callback to async (note: invite is accepted server-side; refresh is client-side session finalization):
   - Call `refreshAndVerifyClaims()` before `router.push('/start')`
   - On failure: set `refreshError` state (user stays on page; invite is accepted, JWT not yet refreshed)
4. Update success card render to show retry button when `refreshError` is set, with copy clarifying invite was accepted but session finalization is pending

**Patterns**: useMutation async onSuccess, retry UI in success state

**Acceptance Criteria**:

- [ ] `onSuccess` calls `refreshAndVerifyClaims()` before navigation
- [ ] On verification failure: user stays on page with retry option
- [ ] Success card shows retry button when `refreshError` is set, with copy clarifying invite accepted / session finalization pending
- [ ] No state updates after unmount (safe async handling in onSuccess)
- [ ] `npm run type-check` passes

---

## Definition of Done

- [ ] All 4 workstreams complete (WS1-WS4)
- [ ] `npm run type-check` passes
- [ ] `npm run lint` passes
- [ ] `npm run build` passes
- [ ] Dev bypass: setup wizard Step 1 "Next" succeeds with `ENABLE_DEV_AUTH=true`
- [ ] No regressions: existing server actions with real auth still call RPC
- [ ] **FR-2 tripwire**: Verified that `withRLS()` guard requires BOTH `ctx.rlsContext` AND `isDevAuthBypassEnabled()` — non-bypass path always calls RPC regardless of pre-existing context
- [ ] **WS2 retry**: `refreshAndVerifyClaims()` implements two-attempt retry (refresh → check → wait 1s → refresh → check → fail)
- [ ] ADR-030 Appendix A (`docs/80-adrs/ADR-030_APPENDIX-A_onboarding-bootstrap-mode.md`) implementation checklist items addressed
