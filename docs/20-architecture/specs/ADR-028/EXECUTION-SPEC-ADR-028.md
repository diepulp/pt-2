---
# EXECUTION-SPEC Frontmatter
# Generated by prd-pipeline skill

prd: ADR-028
prd_title: "Table Status Standardization"
service: TableContextService
mvp_phase: 2

# Workstream Definitions
workstreams:
  WS1:
    name: Database Layer - Availability Gate & Count Status
    description: |
      Add drop_posted_at column to table_session, update rpc_open_table_session
      with table availability check (gaming_table.status = 'active'), add enum comments.
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - supabase/migrations/YYYYMMDDHHMMSS_adr028_table_status_standardization.sql
    gate: schema-validation
    estimated_complexity: medium

  WS2:
    name: Type Aliases and Label Constants
    description: |
      Add TableAvailability/SessionPhase type aliases to dtos.ts, create labels.ts
      with centralized UI labels and color constants per ADR-028 D5/D6.
    executor: backend-service-builder
    executor_type: skill
    depends_on: []
    outputs:
      - services/table-context/dtos.ts
      - services/table-context/labels.ts
    gate: type-check
    estimated_complexity: low

  WS3:
    name: Component Label Standardization
    description: |
      Update pit-map-selector, session-status-banner, and use-table-session hook
      to use centralized labels from labels.ts per ADR-028 D6.
    executor: frontend-design-pt-2
    executor_type: skill
    depends_on: [WS2]
    outputs:
      - components/table/pit-map-selector.tsx
      - components/table/session-status-banner.tsx
      - hooks/table-context/use-table-session.ts
    gate: type-check
    estimated_complexity: medium

  WS4:
    name: Quality Validation
    description: Run full build, lint, and type-check validation gates.
    executor: qa-specialist
    executor_type: skill
    depends_on: [WS1, WS2, WS3]
    outputs: []
    gate: build
    estimated_complexity: low

# Execution Phases (topologically sorted, parallelized where possible)
execution_phases:
  - name: Phase 1 - Foundation
    parallel: [WS1, WS2]
    gates: [schema-validation, type-check]

  - name: Phase 2 - UI Updates
    parallel: [WS3]
    gates: [type-check]

  - name: Phase 3 - Validation
    parallel: [WS4]
    gates: [build]

# Validation Gates
gates:
  schema-validation:
    command: npm run db:types
    success_criteria: "Exit code 0, no type errors"

  type-check:
    command: npm run type-check
    success_criteria: "Exit code 0"

  build:
    command: npm run build
    success_criteria: "Exit code 0"

# External Dependencies
external_dependencies: []

# Risks and Mitigations
risks:
  - risk: "RPC modification may cause test failures in table session tests"
    mitigation: "Run integration tests after migration and fix any failures"
  - risk: "Label changes may affect visual consistency"
    mitigation: "Use centralized constants to ensure consistency across components"
---

# EXECUTION-SPEC: ADR-028 - Table Status Standardization

## Overview

ADR-028 standardizes the two table status systems in PT-2:
1. **`table_status`** (gaming_table.status) - Physical table availability
2. **`table_session_status`** (table_session.status) - Session lifecycle phase

This spec implements the canonical meaning contract, type aliases, UI labels, and availability gate.

## Scope

### In Scope
- Add `drop_posted_at` column to track count posting status
- Add availability gate to `rpc_open_table_session` (require `gaming_table.status = 'active'`)
- Add TypeScript type aliases (`TableAvailability`, `SessionPhase`)
- Create centralized label constants (`labels.ts`)
- Update UI components to use standardized labels
- Document enum semantics via SQL comments

### Out of Scope
- Changing enum values (no migration of existing data)
- OPEN state workflow implementation (reserved for future)
- Full count posting workflow (just adds the timestamp field)

## Architecture Context

**References:**
- `docs/80-adrs/ADR-028-table-status-standardization.md` - Source ADR
- `docs/80-adrs/ADR-027-table-bank-mode-dual-policy.md` - Related ADR (depends on this)
- `docs/20-architecture/SERVICE_RESPONSIBILITY_MATRIX.md` - TableContext ownership

**Bounded Context:** TableContextService (SRM v4.0.0)

## Workstream Details

### WS1: Database Layer - Availability Gate & Count Status

**Purpose:** Add database-level constraints and tracking per ADR-028 D3 and D7.

**Deliverables:**

1. **Migration file** with:
   - `drop_posted_at` column on `table_session`
   - Enum comments documenting canonical meanings
   - Update to `rpc_open_table_session` with availability gate

2. **RPC Availability Gate** (D3):
   ```sql
   -- Inside rpc_open_table_session, BEFORE creating session:
   SELECT status INTO v_table_status
   FROM gaming_table
   WHERE id = p_gaming_table_id AND casino_id = v_casino_id;

   IF v_table_status IS NULL THEN
     RAISE EXCEPTION 'TBLSESS_TABLE_NOT_FOUND: Table % not found', p_gaming_table_id;
   ELSIF v_table_status <> 'active' THEN
     RAISE EXCEPTION 'TBLSESS_TABLE_NOT_AVAILABLE: Cannot open session, table status is % (expected active)', v_table_status;
   END IF;
   ```

**Acceptance Criteria:**
- [ ] `drop_posted_at` column exists on `table_session`
- [ ] `rpc_open_table_session` rejects when `gaming_table.status != 'active'`
- [ ] Enum comments document canonical meanings
- [ ] `npm run db:types` succeeds

### WS2: Type Aliases and Label Constants

**Purpose:** Add semantic type aliases and centralized UI labels per ADR-028 D5 and D6.

**Deliverables:**

1. **Type aliases in `services/table-context/dtos.ts`:**
   ```typescript
   /** Physical table availability (gaming_table.status) */
   export type TableAvailability = Database["public"]["Enums"]["table_status"];

   /** Session lifecycle phase (table_session.status) */
   export type SessionPhase = Database["public"]["Enums"]["table_session_status"];
   ```

2. **New file `services/table-context/labels.ts`:**
   ```typescript
   export const TABLE_AVAILABILITY_LABELS: Record<TableAvailability, string> = {
     inactive: "Idle",
     active: "Available",
     closed: "Decommissioned",
   };

   export const SESSION_PHASE_LABELS: Record<SessionPhase, string> = {
     OPEN: "Opening",
     ACTIVE: "In Play",
     RUNDOWN: "Rundown",
     CLOSED: "Closed",
   };
   ```

**Acceptance Criteria:**
- [ ] `TableAvailability` and `SessionPhase` type aliases exist
- [ ] `labels.ts` exports label and color constants
- [ ] `npm run type-check` succeeds

### WS3: Component Label Standardization

**Purpose:** Update UI components to use centralized labels from ADR-028 D6.

**Deliverables:**

1. **`pit-map-selector.tsx`** updates:
   - Change `STATUS_CONFIG.active.label` from "Open" to "Available"
   - Keep `STATUS_CONFIG.inactive.label` as "Idle" (already correct)
   - Change `STATUS_CONFIG.closed.label` from "Closed" to "Decommissioned"

2. **`session-status-banner.tsx`** updates:
   - Import `SESSION_PHASE_LABELS` from `labels.ts`
   - Replace `getSessionStatusLabel` usage with centralized labels

3. **`use-table-session.ts`** updates:
   - Update `getSessionStatusLabel` to return ADR-028 labels:
     - OPEN: "Opening"
     - ACTIVE: "In Play"
     - RUNDOWN: "Rundown"
     - CLOSED: "Closed"

**Acceptance Criteria:**
- [ ] UI displays "Idle/Available/Decommissioned" for table availability
- [ ] UI displays "Opening/In Play/Rundown/Closed" for session phase
- [ ] `npm run type-check` succeeds

### WS4: Quality Validation

**Purpose:** Ensure all changes pass quality gates.

**Acceptance Criteria:**
- [ ] `npm run type-check` passes
- [ ] `npm run lint` passes
- [ ] `npm run build` passes

## Definition of Done

- [ ] All workstreams complete
- [ ] All gates pass (schema-validation, type-check, build)
- [ ] `rpc_open_table_session` rejects when table not `active`
- [ ] UI labels match ADR-028 D6 specification
- [ ] Type aliases documented with JSDoc comments
