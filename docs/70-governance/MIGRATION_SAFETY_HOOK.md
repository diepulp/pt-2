# Migration Safety Pre-commit Hook

**Status**: Active
**Version**: 1.0.0
**Created**: 2025-12-09
**References**: ISSUE-002, ADR-015

## Overview

The migration safety pre-commit hook (`/.husky/pre-commit-migration-safety.sh`) prevents RLS policy regressions by detecting risky migration patterns before they are committed. This hook was created in response to ISSUE-002, where a `sync_remote_changes.sql` file overwrote ADR-015 hybrid RLS policies.

## What It Checks

### 1. Blocks `sync_remote_changes.sql` Files (BLOCKING)

**Pattern**: Any migration file named `*sync_remote_changes*.sql`

**Why**: These files are auto-generated by `supabase db pull` and often contain simplified versions of custom RLS policies that lack the ADR-015 hybrid pattern.

**Resolution**:
1. Review the migration content carefully
2. Compare against existing policies in previous migrations
3. Ensure ADR-015 hybrid pattern is preserved
4. Rename file to describe the actual change (e.g., `20251209_update_player_policies.sql`)
5. Add proper migration header with ADR references

### 2. Detects Unmarked RLS Policy Changes (WARNING)

**Pattern**: Migrations containing `DROP POLICY` or `CREATE POLICY` without review markers

**Why**: RLS policy changes are security-critical and must be explicitly reviewed.

**Required Elements**:
- Migration header with Description and Reference
- One of these review markers:
  - `ADR-015` (for hybrid RLS pattern compliance)
  - `VERIFIED_SAFE` (for verified non-breaking changes)
  - `RLS_REVIEW_COMPLETE` (for manual review completion)

**Example Header**:
```sql
-- Migration: Update player table RLS policies
-- Description: Add ADR-015 hybrid pattern to player_select policy
-- Reference: ADR-015, ISSUE-002
-- VERIFIED_SAFE: Reviewed and verified compliant with ADR-015
```

### 3. Validates ADR-015 Hybrid Pattern (WARNING)

**Pattern**: Policies using `current_setting('app.casino_id')` without JWT fallback

**Why**: Simple `current_setting()` calls fail with Supabase connection pooling (transaction mode).

**Required Pattern**:
```sql
casino_id = COALESCE(
  NULLIF(current_setting('app.casino_id', true), '')::uuid,
  (auth.jwt() -> 'app_metadata' ->> 'casino_id')::uuid
)
```

**Reference**: `/supabase/migrations/20251209183401_adr015_hybrid_rls_policies.sql`

### 4. Ensures Authentication Guards (WARNING)

**Pattern**: RLS policies missing `auth.uid() IS NOT NULL`

**Why**: All RLS policies must verify authentication to prevent anonymous access.

**Required Pattern**:
```sql
CREATE POLICY policy_name ON table_name
  FOR SELECT USING (
    auth.uid() IS NOT NULL
    AND [other conditions]
  );
```

## How to Use

### Normal Workflow

The hook runs automatically on `git commit`. If it detects issues:

1. **Blocking violations** (like `sync_remote_changes.sql`): Commit is prevented
2. **Warnings**: Commit proceeds but issues should be fixed before merge

### Creating Safe Migrations

1. **Use descriptive filenames**: `20251209_feature_description.sql`
2. **Add proper headers**:
   ```sql
   -- Migration: Brief description
   -- Description: Detailed explanation of changes
   -- Reference: ADR-015, related issues/docs
   ```
3. **Use ADR-015 hybrid pattern** for all casino-scoped policies
4. **Include auth.uid() guards** on all policies
5. **Add review markers** for policy changes

### Bypassing the Hook

**Only use when absolutely certain the migration is safe:**

```bash
git commit --no-verify
```

**Warning**: Bypassing the hook should be rare and requires careful manual review. Document your reasoning in the commit message.

## Testing the Hook

### Test with Risky Migration

```bash
# Create a test migration with unsafe patterns
cat > supabase/migrations/test_sync_remote_changes.sql << 'EOF'
DROP POLICY IF EXISTS test_policy ON test_table;
CREATE POLICY test_policy ON test_table
  FOR SELECT USING (casino_id = current_setting('app.casino_id')::uuid);
EOF

# Stage and run the hook
git add supabase/migrations/test_sync_remote_changes.sql
.husky/pre-commit-migration-safety.sh
# Expected: Exit code 1 with detailed error messages

# Clean up
rm supabase/migrations/test_sync_remote_changes.sql
git reset
```

### Test with Safe Migration

```bash
# Create a test migration with proper patterns
cat > supabase/migrations/test_good_migration.sql << 'EOF'
-- Migration: Update test policies
-- Description: Add ADR-015 hybrid pattern
-- Reference: ADR-015

DROP POLICY IF EXISTS test_policy ON test_table;
CREATE POLICY test_policy ON test_table
  FOR SELECT USING (
    auth.uid() IS NOT NULL
    AND casino_id = COALESCE(
      NULLIF(current_setting('app.casino_id', true), '')::uuid,
      (auth.jwt() -> 'app_metadata' ->> 'casino_id')::uuid
    )
  );
EOF

# Stage and run the hook
git add supabase/migrations/test_good_migration.sql
.husky/pre-commit-migration-safety.sh
# Expected: Exit code 0 with success message

# Clean up
rm supabase/migrations/test_good_migration.sql
git reset
```

## Hook Architecture

### File Structure

```
.husky/
├── pre-commit                          # Main hook orchestrator
├── pre-commit-migration-safety.sh     # Migration safety checks (this hook)
├── pre-commit-api-sanity.sh           # API route validation
└── pre-commit-service-check.sh        # Service layer anti-patterns
```

### Integration

The hook is called first in the pre-commit chain (before API and service checks) to catch migration issues as early as possible:

```bash
#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Migration safety checks - prevent RLS policy regressions
.husky/pre-commit-migration-safety.sh || exit 1

# API route sanity checks
.husky/pre-commit-api-sanity.sh || exit 1

# Service layer anti-pattern detection
.husky/pre-commit-service-check.sh || exit 1

# Run lint-staged
npm run lint-staged
```

## Related Documentation

- **ADR-015**: `docs/80-adrs/ADR-015-rls-connection-pooling-strategy.md`
- **ISSUE-002**: Incident where sync_remote_changes overwrote RLS policies
- **Example Migration**: `supabase/migrations/20251209183401_adr015_hybrid_rls_policies.sql`
- **RLS Guardrails**: `docs/30-security/rls-guardrails.md` (if exists)

## Maintenance

### Updating the Hook

1. Edit `/home/diepulp/projects/pt-2/.husky/pre-commit-migration-safety.sh`
2. Test with both risky and safe migrations (see Testing section)
3. Update version number and changelog in hook header
4. Update this documentation

### Known Limitations

1. **Pattern detection is heuristic**: May produce false positives for complex SQL
2. **Line-based analysis**: Cannot parse SQL AST, relies on pattern matching
3. **Context-limited**: Checks 20 lines after CREATE POLICY (may miss long policies)

### Future Enhancements

- Parse SQL AST for more accurate policy structure detection
- Check for proper indexing on casino_id columns
- Validate policy names follow naming conventions
- Detect policies that may have performance implications

## FAQ

### Q: Why does my commit fail even though my migration is safe?

The hook uses pattern matching and may produce false positives. Review the error messages, add proper review markers, or use `--no-verify` if you're certain the migration is safe.

### Q: Should I always use `--no-verify` for `supabase db pull`?

No. Review the generated migration carefully. If it contains policy changes, manually verify they preserve ADR-015 patterns, then rename the file and add proper headers.

### Q: What if I need to temporarily disable RLS for testing?

Create a separate migration for testing purposes, clearly marked as `-- TESTING ONLY` and never commit it to main. Use feature branches for experimental changes.

### Q: Can I disable specific checks?

The hook doesn't support per-check disabling. Use `--no-verify` to skip all checks, but document why in your commit message.

## Change Log

### 1.0.0 (2025-12-09)

- Initial implementation
- Added sync_remote_changes.sql blocking
- Added RLS policy review marker detection
- Added ADR-015 hybrid pattern validation
- Added auth.uid() guard detection
- Integrated into husky pre-commit chain
