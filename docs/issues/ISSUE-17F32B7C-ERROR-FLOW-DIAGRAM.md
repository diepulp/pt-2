# ISSUE-17F32B7C: Error Flow Diagram - Current vs. Proposed

## Current State (Missing `retryable` field)

```
┌─────────────────────────────────────────────────────────────────┐
│ 1. SERVICE LAYER                                                │
│    services/player/crud.ts                                      │
│                                                                 │
│    throw new DomainError('PLAYER_NOT_FOUND', 'message', {      │
│      httpStatus: 404,                                           │
│      retryable: false,  ← Generated by DomainError class       │
│      details: {...}                                             │
│    });                                                          │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│ 2. MIDDLEWARE LAYER (withServerAction)                          │
│    lib/server-actions/with-server-action-wrapper.ts             │
│                                                                 │
│    catch (error) {                                              │
│      const mapped = mapDatabaseError(error);                    │
│      // mapped = {                                              │
│      //   code: 'PLAYER_NOT_FOUND',                             │
│      //   message: 'message',                                   │
│      //   httpStatus: 404,                                      │
│      //   retryable: false,  ← Present in MappedError          │
│      //   details: {...}                                        │
│      // }                                                       │
│                                                                 │
│      return {                                                   │
│        ok: false,                                               │
│        code: mapped.code,                                       │
│        error: mapped.message,                                   │
│        details: mapped.details,                                 │
│        // ❌ MISSING: retryable field NOT copied!               │
│        requestId: '...',                                        │
│        durationMs: 45,                                          │
│        timestamp: '...'                                         │
│      };                                                         │
│    }                                                            │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│ 3. TRANSPORT LAYER (API Route Handler)                         │
│    app/api/v1/players/route.ts                                 │
│                                                                 │
│    try {                                                        │
│      const result = await withServerAction(                     │
│        supabase, async (ctx) => {                               │
│          const service = createPlayerService(ctx.supabase);     │
│          return service.getById(id);  ← May throw DomainError   │
│        },                                                       │
│        { domain: 'player', action: 'get' }                      │
│      );                                                         │
│                                                                 │
│      if (!result.ok) {                                          │
│        return errorResponse(ctx, result);                       │
│      }                                                          │
│    } catch (error) {                                            │
│      return errorResponse(ctx, error);                          │
│    }                                                            │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│ 4. ERROR RESPONSE BUILDER                                       │
│    lib/http/service-response.ts::errorResponse()               │
│                                                                 │
│    if (error instanceof DomainError) {                          │
│      const result = baseResult<never>(ctx, {                    │
│        ok: false,                                               │
│        code: error.code,           ← 'PLAYER_NOT_FOUND'        │
│        status: error.httpStatus,   ← 404                       │
│        error: error.message,                                    │
│        details: error.details,                                  │
│        // ❌ MISSING: retryable NOT included!                   │
│      });                                                        │
│      return NextResponse.json(result, { status: 404 });         │
│    }                                                            │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│ 5. HTTP RESPONSE (to Client)                                    │
│                                                                 │
│    HTTP/1.1 404 Not Found                                       │
│    Content-Type: application/json                               │
│                                                                 │
│    {                                                            │
│      "ok": false,                                               │
│      "code": "PLAYER_NOT_FOUND",                                │
│      "error": "Player not found",                               │
│      "status": 404,                                             │
│      "requestId": "uuid-...",                                   │
│      "durationMs": 45,                                          │
│      "timestamp": "2025-12-20T10:30:00Z"                        │
│      // ❌ MISSING: "retryable" field                           │
│    }                                                            │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│ 6. CLIENT (React Query)                                         │
│    hooks/player/use-player.ts                                   │
│                                                                 │
│    useMutation({                                                │
│      mutationFn: createPlayerAction,                            │
│      retry: (failureCount, error) => {                          │
│        // ❌ PROBLEM: Can't check retryable flag!               │
│        // Always retries up to 3 times, even for               │
│        // validation errors that will never succeed            │
│        return failureCount < 3;                                 │
│      }                                                          │
│    });                                                          │
└─────────────────────────────────────────────────────────────────┘
```

---

## Proposed State (With `retryable` field)

```
┌─────────────────────────────────────────────────────────────────┐
│ 1. SERVICE LAYER                                                │
│    services/player/crud.ts                                      │
│                                                                 │
│    throw new DomainError('PLAYER_NOT_FOUND', 'message', {      │
│      httpStatus: 404,                                           │
│      retryable: false,  ← Generated by DomainError class       │
│      details: {...}                                             │
│    });                                                          │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│ 2. MIDDLEWARE LAYER (withServerAction)                          │
│    lib/server-actions/with-server-action-wrapper.ts             │
│                                                                 │
│    catch (error) {                                              │
│      const mapped = mapDatabaseError(error);                    │
│      // mapped = {                                              │
│      //   code: 'PLAYER_NOT_FOUND',                             │
│      //   message: 'message',                                   │
│      //   httpStatus: 404,                                      │
│      //   retryable: false,  ← Present in MappedError          │
│      //   details: {...}                                        │
│      // }                                                       │
│                                                                 │
│      return {                                                   │
│        ok: false,                                               │
│        code: mapped.code,                                       │
│        error: mapped.message,                                   │
│        details: mapped.details,                                 │
│        retryable: mapped.retryable,  ← ✅ NOW COPIED!          │
│        requestId: '...',                                        │
│        durationMs: 45,                                          │
│        timestamp: '...'                                         │
│      };                                                         │
│    }                                                            │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│ 3. TRANSPORT LAYER (API Route Handler)                         │
│    app/api/v1/players/route.ts                                 │
│                                                                 │
│    try {                                                        │
│      const result = await withServerAction(                     │
│        supabase, async (ctx) => {                               │
│          const service = createPlayerService(ctx.supabase);     │
│          return service.getById(id);  ← May throw DomainError   │
│        },                                                       │
│        { domain: 'player', action: 'get' }                      │
│      );                                                         │
│                                                                 │
│      if (!result.ok) {                                          │
│        return errorResponse(ctx, result);                       │
│        // ✅ result now includes retryable field                │
│      }                                                          │
│    } catch (error) {                                            │
│      return errorResponse(ctx, error);                          │
│    }                                                            │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│ 4. ERROR RESPONSE BUILDER                                       │
│    lib/http/service-response.ts::errorResponse()               │
│                                                                 │
│    if (error instanceof DomainError) {                          │
│      const result = baseResult<never>(ctx, {                    │
│        ok: false,                                               │
│        code: error.code,           ← 'PLAYER_NOT_FOUND'        │
│        status: error.httpStatus,   ← 404                       │
│        error: error.message,                                    │
│        details: error.details,                                  │
│        retryable: error.retryable, ← ✅ NOW INCLUDED!          │
│      });                                                        │
│      return NextResponse.json(result, { status: 404 });         │
│    }                                                            │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│ 5. HTTP RESPONSE (to Client)                                    │
│                                                                 │
│    HTTP/1.1 404 Not Found                                       │
│    Content-Type: application/json                               │
│                                                                 │
│    {                                                            │
│      "ok": false,                                               │
│      "code": "PLAYER_NOT_FOUND",                                │
│      "error": "Player not found",                               │
│      "status": 404,                                             │
│      "retryable": false,  ← ✅ NOW PRESENT!                     │
│      "requestId": "uuid-...",                                   │
│      "durationMs": 45,                                          │
│      "timestamp": "2025-12-20T10:30:00Z"                        │
│    }                                                            │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│ 6. CLIENT (React Query)                                         │
│    hooks/player/use-player.ts                                   │
│                                                                 │
│    useMutation({                                                │
│      mutationFn: createPlayerAction,                            │
│      retry: (failureCount, error) => {                          │
│        // ✅ FIXED: Check retryable flag                        │
│        if (error?.retryable === false) {                        │
│          return false; // Don't retry validation errors         │
│        }                                                        │
│        return failureCount < 3;                                 │
│      }                                                          │
│    });                                                          │
└─────────────────────────────────────────────────────────────────┘
```

---

## Error Scenarios Comparison

### Scenario 1: Concurrent Modification (Retryable)

**Current Behavior:**
```json
{
  "ok": false,
  "code": "VISIT_CONCURRENT_MODIFICATION",
  "error": "Visit was modified by another process",
  "status": 409
  // ❌ Client doesn't know this is retryable
}
```

**Client retries blindly** → May waste retries on non-retryable errors

**Proposed Behavior:**
```json
{
  "ok": false,
  "code": "VISIT_CONCURRENT_MODIFICATION",
  "error": "Visit was modified by another process",
  "status": 409,
  "retryable": true  // ✅ Client knows to retry with backoff
}
```

**Client retries intelligently** → Only retries errors marked as retryable

---

### Scenario 2: Validation Error (Non-retryable)

**Current Behavior:**
```json
{
  "ok": false,
  "code": "VALIDATION_ERROR",
  "error": "Invalid email format",
  "status": 400,
  "details": { "field": "email", "value": "invalid" }
  // ❌ Client doesn't know this is permanent
}
```

**Client may retry 3 times** → Wastes resources, delays user feedback

**Proposed Behavior:**
```json
{
  "ok": false,
  "code": "VALIDATION_ERROR",
  "error": "Invalid email format",
  "status": 400,
  "details": { "field": "email", "value": "invalid" },
  "retryable": false  // ✅ Client knows NOT to retry
}
```

**Client fails fast** → Immediate user feedback, no wasted retries

---

### Scenario 3: Internal Server Error (Retryable)

**Current Behavior:**
```json
{
  "ok": false,
  "code": "INTERNAL_ERROR",
  "error": "Database connection timeout",
  "status": 500
  // ❌ Client doesn't know if retry will help
}
```

**Client behavior unpredictable**

**Proposed Behavior:**
```json
{
  "ok": false,
  "code": "INTERNAL_ERROR",
  "error": "Database connection timeout",
  "status": 500,
  "retryable": true  // ✅ Client knows retry may succeed
}
```

**Client retries with exponential backoff** → Better resilience

---

## Implementation Diff

### File 1: `lib/http/service-response.ts`

```diff
export interface ServiceResult<T> {
  ok: boolean;
  code: ResultCode | string;
  data?: T;
  error?: string;
  details?: unknown;
  requestId: string;
  durationMs: number;
  timestamp: string;
+ retryable?: boolean;
}

export function errorResponse(
  ctx: RequestContext,
  error: unknown,
  fallbackMessage = "Unexpected error",
) {
  // ... existing ServiceResult pass-through ...

  if (error instanceof DomainError) {
    const result = baseResult<never>(ctx, {
      ok: false,
      code: error.code,
      status: error.httpStatus,
      error: error.message,
      details: error.details,
+     retryable: error.retryable,
    });
    return NextResponse.json(result, { status: result.status });
  }

  // ... RouteError handling ...

  // ... ZodError handling ...

  const result = baseResult<never>(ctx, {
    ok: false,
    code: "INTERNAL_ERROR",
    status: 500,
    error: error instanceof Error ? error.message : fallbackMessage,
+   retryable: false, // Unknown errors default to non-retryable
  });
  return NextResponse.json(result, { status: result.status });
}
```

### File 2: `lib/server-actions/with-server-action-wrapper.ts`

```diff
catch (error) {
  const mapped = mapDatabaseError(error);
  const failure: ServiceResult<T> = {
    data: undefined,
    ok: false,
    code: mapped.code as DomainErrorCode,
    error: mapped.message,
    details: mapped.details,
+   retryable: mapped.retryable,
    requestId,
    durationMs: Date.now() - startedAt,
    timestamp: new Date().toISOString(),
  };

  // ... audit log ...

  return failure;
}
```

---

## Benefits of Proposed Change

1. **Better Client UX**: No wasted retries on validation errors
2. **Reduced Server Load**: Fewer unnecessary retry requests
3. **Faster Failure Feedback**: Users see validation errors immediately
4. **Resilience for Transient Errors**: Concurrent modifications get automatic retry
5. **Compliance**: Aligns with ERROR_TAXONOMY_AND_RESILIENCE.md spec
6. **Type Safety**: TypeScript enforces `retryable` field throughout stack

---

**Document Version**: 1.0
**Date**: 2025-12-20
**Related**: ISSUE-17F32B7C-ERROR-MASKING-INVESTIGATION-REPORT.md
