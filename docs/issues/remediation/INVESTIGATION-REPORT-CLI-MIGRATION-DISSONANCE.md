# Investigation Report: CLI Migration Dissonance

**Date:** 2025-12-10
**Investigator:** RLS Security Specialist (Claude Code)
**Issue:** ISSUE-002 - RLS Context RPC Failure
**Focus:** Why CLI showed migrations as "applied" when database had old schema

## Executive Summary

The Supabase CLI correctly showed migrations as "applied" - they were. The problem was a **migration conflict** where a later auto-generated migration (`sync_remote_changes.sql`) overwrote ADR-015 hybrid policies with old, vulnerable patterns. This created a scenario where:

- CLI state was correct (migrations applied)
- Database state was incorrect (old policies restored)
- No obvious error in CLI output

This is a **remote schema drift** issue, not a CLI bug.

## Investigation Timeline

### Phase 1: Initial Observation

**Symptom:** `/api/v1/visits` endpoint returning 500 errors despite migration showing as applied

**CLI Output:**
```bash
$ supabase migration list
...
20251209183033_adr015_rls_context_rpc.sql         applied
20251209183401_adr015_hybrid_rls_policies.sql     applied
20251209215834_sync_remote_changes.sql            applied
```

**Database Reality:**
```sql
-- Old policy WITHOUT JWT fallback:
CREATE POLICY player_select_enrolled ON player
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM player_casino pc
      WHERE pc.player_id = player.id
      AND pc.casino_id = (current_setting('app.casino_id', true))::uuid
    )
  );
```

### Phase 2: Migration File Analysis

**Discovery:** Migration `20251209215834_sync_remote_changes.sql` contains OLD patterns

**Evidence (Lines 24-29):**
```sql
create policy "staff_read"
on "public"."staff"
as permissive
for select
to public
using ((casino_id = (current_setting('app.casino_id'::text, true))::uuid));
```

**Comparison with ADR-015 Pattern C:**
```sql
-- Expected (from 20251209183401_adr015_hybrid_rls_policies.sql):
CREATE POLICY staff_read_hybrid ON staff
  FOR SELECT USING (
    auth.uid() IS NOT NULL                        -- MISSING in sync file
    AND casino_id = COALESCE(                      -- MISSING in sync file
      NULLIF(current_setting('app.casino_id', true), '')::uuid,
      (auth.jwt() -> 'app_metadata' ->> 'casino_id')::uuid
    )
  );
```

### Phase 3: Timeline Reconstruction

| Time | Migration | Action | Database State |
|------|-----------|--------|----------------|
| 18:34:01 | `adr015_hybrid_rls_policies.sql` | Applied | Hybrid policies with JWT fallback (CORRECT) |
| 21:58:34 | `sync_remote_changes.sql` | Applied | **OVERWROTE** with old policies (INCORRECT) |
| Current | - | - | Old policies active, vulnerable to pooling issues |

**Key Insight:** Both migrations were applied successfully. The later one reversed the earlier one.

### Phase 4: Root Cause Analysis

**Migration Generation Event:**

The `sync_remote_changes.sql` file was likely generated by one of:
```bash
supabase db pull                    # Pull remote schema changes
supabase db diff --linked          # Generate diff against remote
supabase migration new --create-only  # Manual migration after remote change
```

**What Happened:**

1. Local development created ADR-015 migrations (18:34:01)
2. Remote Supabase database still had old schema (not yet updated)
3. Someone ran a sync command, pulling remote schema
4. Generated migration restored old patterns (21:58:34)
5. Migration was committed without reviewing the conflict
6. `supabase db reset` or `supabase migration apply` ran, applying all migrations sequentially
7. Final state: old policies (last migration wins)

## Why CLI Showed No Error

The Supabase CLI behavior was **correct**:

| CLI Component | Behavior | Reason |
|---------------|----------|--------|
| `migration list` | Shows "applied" | All migrations executed successfully |
| `migration apply` | No errors | SQL is valid, executes cleanly |
| `db reset` | No warnings | Not designed to detect policy conflicts |

**The CLI tracks:**
- Which migration files have been executed
- SQL execution success/failure
- Schema version progression

**The CLI does NOT track:**
- Policy content conflicts
- Schema semantic changes
- Logical conflicts between migrations

This is expected behavior - the CLI is a deployment tool, not a semantic validator.

## Files Involved

### Conflicting Migration
**File:** `/home/diepulp/projects/pt-2/supabase/migrations/20251209215834_sync_remote_changes.sql`
**MD5:** `451267f723c7b58c17c626e1b2d24d11`
**Size:** 1.3K
**Lines:** 33

**Conflicting Content:**
- Line 3: Drops `staff_read` policy (removes hybrid version)
- Lines 24-29: Recreates `staff_read` with old pattern
- Line 15: Re-adds `rating_slip.player_id` column (already added by prior migration)

### Correct Migration
**File:** `/home/diepulp/projects/pt-2/supabase/migrations/20251209183401_adr015_hybrid_rls_policies.sql`
**Size:** 12K
**Lines:** 330

**Correct Implementation:**
- All policies have `auth.uid() IS NOT NULL` guard
- All casino_id comparisons use `COALESCE(NULLIF(...), jwt_fallback)`
- All staff_role comparisons use `COALESCE(NULLIF(...), jwt_fallback)`
- Comprehensive comments and documentation

## Impact Assessment

### Security Impact

| Risk | Severity | Description |
|------|----------|-------------|
| Connection pooling failure | **HIGH** | SET LOCAL context lost between queries |
| Cross-tenant data leakage | **HIGH** | Missing casino_id checks in pooled connections |
| Unauthorized access | **MEDIUM** | Missing `auth.uid()` guards on some policies |

### Operational Impact

| Area | Impact | Status |
|------|--------|--------|
| `/api/v1/visits` | 500 errors | BROKEN |
| `/api/v1/tables` | Likely working (no RLS) | OK |
| `/api/v1/rating-slips` | Likely working (no RLS) | OK |
| Dev dashboard | ERROR LOADING | BROKEN |

### Developer Experience Impact

| Issue | Severity | Description |
|-------|----------|-------------|
| CLI confusion | MEDIUM | "Applied" but not working - confusing debugging |
| Migration trust | HIGH | Developers may lose trust in migration system |
| Remote sync risk | HIGH | Fear of running `db pull` or similar commands |

## Recommendations

### Immediate Actions

1. **Delete conflicting migration**
   ```bash
   rm /home/diepulp/projects/pt-2/supabase/migrations/20251209215834_sync_remote_changes.sql
   ```

2. **Reset database**
   ```bash
   npx supabase db reset
   ```

3. **Verify hybrid policies applied**
   ```bash
   docker exec supabase_db_pt-2 psql -U postgres -c "
     SELECT policyname, pg_get_expr(qual, polrelid)
     FROM pg_policies
     WHERE tablename = 'player';
   "
   ```

### Preventive Measures

#### 1. Pre-commit Hook for Migration Validation

**File:** `.git/hooks/pre-commit`
```bash
#!/bin/bash
# Prevent committing migrations with raw current_setting() calls

MIGRATIONS_DIR="supabase/migrations"

if git diff --cached --name-only | grep -q "$MIGRATIONS_DIR"; then
  echo "Validating migration ADR-015 compliance..."

  # Check for raw current_setting without COALESCE
  if git diff --cached "$MIGRATIONS_DIR" | grep -E "current_setting\('app\." | grep -v "COALESCE"; then
    echo "ERROR: Migration contains raw current_setting() without JWT fallback"
    echo "Required pattern: COALESCE(NULLIF(current_setting(...), '')::uuid, jwt_fallback)"
    echo "See: docs/80-adrs/ADR-015-rls-connection-pooling-strategy.md"
    exit 1
  fi

  # Check for policies without auth.uid() guard
  if git diff --cached "$MIGRATIONS_DIR" | grep -E "CREATE POLICY" -A 5 | grep -v "auth.uid()"; then
    echo "WARNING: Policy may be missing auth.uid() guard"
    echo "All policies MUST include: auth.uid() IS NOT NULL"
  fi
fi
```

#### 2. CI/CD Migration Validation

**GitHub Action:** `.github/workflows/validate-migrations.yml`
```yaml
name: Validate Migrations

on:
  pull_request:
    paths:
      - 'supabase/migrations/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Check for ADR-015 compliance
        run: |
          # Check for raw current_setting without COALESCE
          if grep -r "current_setting('app\." supabase/migrations/ | grep -v "COALESCE"; then
            echo "ERROR: Non-compliant RLS policies found"
            exit 1
          fi

      - name: Check for auth.uid() guards
        run: |
          # Extract all CREATE POLICY statements and check for auth.uid()
          grep -r "CREATE POLICY" supabase/migrations/ || exit 0
          # TODO: Parse and validate each policy
```

#### 3. Migration Review Checklist

**Add to:** `.github/PULL_REQUEST_TEMPLATE.md`
```markdown
## Migration Checklist (if applicable)

- [ ] No auto-generated `sync_remote_changes` or `db pull` migrations
- [ ] All RLS policies include `auth.uid() IS NOT NULL` guard
- [ ] All casino_id checks use `COALESCE(NULLIF(...), jwt_fallback)` pattern
- [ ] Tested with `supabase db reset` locally
- [ ] No conflicts with existing ADR-015 policies
- [ ] Migration reviewed for remote schema drift issues
```

#### 4. Remote Sync Runbook

**Document:** `docs/50-ops/RUNBOOK-remote-schema-sync.md`
```markdown
# Remote Schema Sync Runbook

## When NOT to Run db pull

NEVER run `supabase db pull` if:
- Local migrations are newer than remote
- ADR-015 compliance work is in progress
- You haven't reviewed remote changes first

## Safe Sync Procedure

1. Check migration status:
   \`\`\`bash
   supabase migration list --local
   supabase migration list --linked
   \`\`\`

2. If remote is ahead, review changes in Supabase dashboard first

3. Pull changes:
   \`\`\`bash
   supabase db pull
   \`\`\`

4. Review generated migration:
   \`\`\`bash
   git diff supabase/migrations/
   \`\`\`

5. Validate ADR-015 compliance:
   \`\`\`bash
   grep -r "current_setting('app\." supabase/migrations/ | grep -v "COALESCE"
   \`\`\`

6. If conflicts found, manually resolve before committing
```

### Long-term Improvements

1. **Complete WS6 Integration Tests** - Would catch policy regressions
2. **Automated Policy Auditing** - Daily scan of database vs ADR-015 patterns
3. **Migration Linting** - `eslint` equivalent for SQL migrations
4. **Schema Version Pinning** - Lock remote schema version during active development

## Lessons Learned

### What Worked Well

1. Migration version control - enabled forensic analysis
2. Comprehensive ADR-015 documentation - clear patterns to validate against
3. Diagnostic SQL queries - quickly identified policy discrepancies
4. Destructive command hook - prevented accidental data loss during investigation

### What Needs Improvement

1. **No migration validation** - Conflicting migration committed without review
2. **No ADR-015 compliance checks** - Old patterns slipped through
3. **No integration tests** - Policy regression not caught before deployment
4. **No remote sync procedures** - Developers unaware of drift risks

### Process Improvements

| Current State | Desired State | Action |
|---------------|---------------|--------|
| Manual migration review | Automated validation | Implement pre-commit hooks |
| No policy testing | Automated policy audit | Complete WS6 integration tests |
| Ad-hoc remote sync | Documented procedure | Create runbook |
| Reactive debugging | Proactive detection | Add CI/CD checks |

## Technical Deep Dive: Why This Is Hard to Detect

### The Perfect Storm

1. **Valid SQL** - Both migrations execute without errors
2. **No Foreign Key Violations** - Schema changes are compatible
3. **Silent Overwrites** - `DROP POLICY IF EXISTS` succeeds quietly
4. **Timestamp Ordering** - Later migration naturally overrides earlier one
5. **CLI Correctness** - All migrations ARE applied, no false reporting

### What a Linter Would Need to Catch

```python
# Pseudo-code for migration linter

def validate_migration(migration_file):
    # Parse SQL AST
    policies = extract_policies(migration_file)

    for policy in policies:
        # Check for auth.uid() guard
        if 'auth.uid()' not in policy.using_clause:
            raise ValidationError("Missing auth.uid() guard")

        # Check for casino_id pattern
        if 'current_setting' in policy.using_clause:
            if 'COALESCE' not in policy.using_clause:
                raise ValidationError("Missing JWT fallback")

            if 'auth.jwt()' not in policy.using_clause:
                raise ValidationError("Missing JWT source")

    return True
```

## Conclusion

The CLI/database dissonance was NOT a bug, but a **migration conflict** caused by remote schema drift. The sync_remote_changes migration was auto-generated from old remote schema and overwrote local ADR-015 improvements.

**Resolution Path:**
1. Delete conflicting migration
2. Reset database
3. Implement preventive measures
4. Complete WS6 integration tests

**Key Takeaway:** Auto-generated migrations from remote sources are DANGEROUS during active schema refactoring. Always review generated migrations for conflicts with in-progress work.

## Sign-off

**Investigator:** RLS Security Specialist (Claude Code)
**Date:** 2025-12-10
**Status:** Investigation complete, remediation plan ready
**Next Steps:** Manual execution of database reset (blocked by destructive hook)

## Appendix A: Full Migration Sequence

```
00000000000000_baseline_srm.sql                   # Foundation schema
...
20251209183033_adr015_rls_context_rpc.sql        # WS1: RPC function (CORRECT)
20251209183401_adr015_hybrid_rls_policies.sql    # WS4: Hybrid policies (CORRECT, then overwritten)
20251209215834_sync_remote_changes.sql           # CONFLICT: Old schema (TO BE DELETED)
```

## Appendix B: Policy Comparison

### Old Pattern (Vulnerable)
```sql
CREATE POLICY player_select_enrolled ON player
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM player_casino pc
      WHERE pc.player_id = player.id
      AND pc.casino_id = (current_setting('app.casino_id', true))::uuid
    )
  );
```

### ADR-015 Pattern C (Correct)
```sql
CREATE POLICY player_select_enrolled ON player
  FOR SELECT USING (
    auth.uid() IS NOT NULL
    AND EXISTS (
      SELECT 1 FROM player_casino pc
      WHERE pc.player_id = player.id
      AND pc.casino_id = COALESCE(
        NULLIF(current_setting('app.casino_id', true), '')::uuid,
        (auth.jwt() -> 'app_metadata' ->> 'casino_id')::uuid
      )
    )
  );
```

### Key Differences

| Aspect | Old Pattern | ADR-015 Pattern C |
|--------|-------------|-------------------|
| Auth guard | Missing | `auth.uid() IS NOT NULL` |
| Context source | `current_setting()` only | `COALESCE(current_setting, jwt)` |
| Pooling safe | NO | YES |
| Cross-tenant leak risk | HIGH | LOW |
| Connection pooling mode | Session mode only | Transaction mode compatible |
